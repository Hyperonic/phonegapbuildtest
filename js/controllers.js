angular.module("starter.controllers",[]).controller("AppCtrl",["toastr","$ionicHistory","$timeout","$ionicScrollDelegate","$translate","$localStorage","$ionicSideMenuDelegate","AuthService","$rootScope","$scope","$ionicModal","$ionicPopup","$interval","EmployeeService","$state",function(e,t,o,i,n,a,r,l,s,c,d,p,u,m,g){if(c.rightMenu||(c.rightMenu={}),s.showMenuIcon=!0,!s.name){null==t.backView()||"app.employee-dispatcher"!=t.backView().stateName&&"app.employee-index"!=t.backView().stateName||m.emptyEmployeesCateg(),null==s.itemBooked&&(s.itemBooked=0,s.itemNotBooked=0),c.ionic=ionic,c.openMaps=function(){"app.maps-detail"!=g.current.name&&g.transitionTo("app.maps-detail")},s.loggedIn=l.isAuthenticated()?!0:!1,s.name=a.name,s.onQuotePage=g.current.quotepage,s.updateRating=function(){m.myRatings()},s.profileItems=function(){n(["UPLOAD_PIC","CHANGE_PASSWORD","DRIVER_LICENSE","CITY_PERMITS","VEHICLE_INFO","POI"]).then(function(e){s.groups=[{icon:"ion-camera",title:e.UPLOAD_PIC,link:"app.uploadpic"},{icon:"ion-key",title:e.CHANGE_PASSWORD,link:"app.changepwd"},{icon:"ion-location",title:e.POI,link:"app.poi"}],s.isNotCustomer&&(s.myPermits&&s.myPermits.length>0&&(s.groups.push({icon:"ion-information-circled",title:e.DRIVER_LICENSE,link:"app.driving"}),s.groups.push({icon:"ion-card",title:e.CITY_PERMITS,link:"app.permit"})),s.myVehicles&&s.myVehicles.length>0&&s.groups.push({icon:"ion-model-s",title:e.VEHICLE_INFO,link:"app.vehicle"}))})},s.profileItems(),null==s.shownGroup&&(s.shownGroup=!1),s.toggleGroup=function(){s.shownGroup?(s.shownGroup=!1,o(function(){i.scrollTo(0,2,!0)},0)):(i.scrollBottom(!0),o(function(){i.scrollBottom(!0)},200),s.shownGroup=!0)},s.isGroupShown=function(){return s.shownGroup};var f,v,h,_,E=c.$watch(function(){return r.getOpenRatio()},function(e){1===e&&i.resize()}),S=function(){_=c.$on("autologin",function(e,t){s.profileItems()}),f=c.$on("user:updated",function(e,t){s.showQuoteForm=t,s.isNotCustomer=t,s.profileItems()}),v=c.$on("canbookin:updated",function(e,t){s.canbookin=t}),h=c.$on("quotepagewithbookedin",function(e,t){n(["SORRY","BOOKOUT_FIRST"]).then(function(e){p.alert({cssClass:"bookoutFirst",title:e.SORRY,template:e.BOOKOUT_FIRST})})})};S(),s.canbookin=m.canBookin();var D=function(){s.$broadcast("loading:show",{text:"LOGGING_OUT"}),m.logOut().success(function(e){g.transitionTo("app.login"),s.$broadcast("loading:hide")})};s.orders=function(){g.transitionTo("app.orders",{apikey:window.localStorage.getItem("apikeypublic")})},s.isNotCustomer=a.isDriver,s.showLogOut=function(){n(["OK","CANCEL","LOGOUT","CONFIRM_LOGOUT"]).then(function(e){p.confirm({title:e.LOGOUT,template:e.CONFIRM_LOGOUT,cssClass:"logoutAlert",buttons:[{text:e.CANCEL},{text:e.OK,type:"button-positive",onTap:function(e){D()}}]})})},s.book=function(e){m.toggleBook(e,"all").then(function(e){})},s.bookAll=function(t,o){var i="2"==t?!0:!1,a=0,r=0,l=0,c=0,d=0,p=!0,u=m.getGroupItems();if(i){var g=[],f=[],v=[],h=[];for(var _ in u)u[_].can_bookin&&!u[_].booked&&(m.getEmployees()[u[_].groupPosition].require_upload||(p=!1),_==u[_].category_id&&(u[_].booked||a++,m.isDispatcherAdmin(u[_].category_id)||((services=m.getTagsRatePlan(_,u[_].tags))&&services.length>0&&g.push(services.join(", ")+" : <b>"+m.getEmployees()[u[_].groupPosition].name+"</b>"),1==m.withinZone(u[_].category_id)?(c++,g.join(",").indexOf(m.getEmployees()[u[_].groupPosition].name)<0&&f.push("<b>"+m.getEmployees()[u[_].groupPosition].name+"</b>")):m.hasServType(u[_].tags)?m.withinZone(u[_].category_id)?m.hasRatePlanServ(_,u[_].tags)||l++:(r++,f.join(",").indexOf(m.getEmployees()[u[_].groupPosition].name)<0&&v.push("<b>"+m.getEmployees()[u[_].groupPosition].name+"</b>")):(d++,h.join(",").indexOf(m.getEmployees()[u[_].groupPosition].name)<0&&h.push("<b>"+m.getEmployees()[u[_].groupPosition].name+"</b>")))));if(o||(f.length>0&&n("NO_ZONE").then(function(t){e.info(f.join("<br>"),t,{allowHtml:!0,timeOut:3e3,positionClass:"toast-bottom-center"})}),v.length>0&&n("NOT_IN_ZONE").then(function(t){e.info(v.join("<br>"),t,{allowHtml:!0,timeOut:3e3,positionClass:"toast-bottom-center"})}),h.length>0&&n("NO_SERVICE_TYPE").then(function(t){e.info(h.join("<br>"),t,{allowHtml:!0,timeOut:3e3,positionClass:"toast-bottom-center"})}),g.length>0&&n("NO_RATE_PLAN").then(function(t){e.info(g.join("<br>"),t,{allowHtml:!0,timeOut:3e3,positionClass:"toast-bottom-center"})})),c+r+l+d>=a)return;p?m.getVehiclesPermits().then(function(){return m.checkForms(void 0,[i,"all"])?void s.book(i):void s.$broadcast("loading:hide")}):s.book(i)}else s.book(i)},c.$on("$destroy",function(){f(),h(),v(),E()})}}]).controller("SignUpCtrl",["$cordovaInAppBrowser","$ionicScrollDelegate","$state","$rootScope","$translate","$scope","$ionicPopup","$ionicModal","$timeout","EmployeeService",function(e,t,o,i,n,a,r,l,s,c){var d,p,u,m,g=this;g.signupForm=null,a.$on("$ionicView.afterEnter",function(l,f){s(function(){var e=$("ion-view .scroll").offset();if(e){var t=e.top;0>t&&$("ion-view .scroll").css("top",44-t)}}),a.view_loaded=!0,a.termsClicked=function(t){if("SPAN"==t.target.tagName)if(ionic.Platform.isWebView()){var o={location:"no",clearcache:"yes",toolbar:"yes"};e.open(t.target.attributes.link.nodeValue,"_blank",o).then(function(e){})["catch"](function(e){}),d||(d=i.$on("$cordovaInAppBrowser:loadstart",function(e,t){i.$broadcast("loading:show",{text:"WAIT"})}),p=i.$on("$cordovaInAppBrowser:loadstop",function(e,t){i.$broadcast("loading:hide")}),u=i.$on("$cordovaInAppBrowser:exit",function(e,t){i.$broadcast("loading:hide")}),m=i.$on("$cordovaInAppBrowser:loaderror",function(e,t){i.$broadcast("loading:hide")}))}else{var n=window.open(t.target.attributes.link.nodeValue,"_blank");n.focus()}else a.signUpData.disclaimer=+!a.signUpData.disclaimer},a.signUpData={},a.doSignUp=function(){t.resize(),g.signupForm.$submitted=!0,g.signupForm.$valid&&(i.$broadcast("loading:show",{text:"SIGNING_UP"}),c.signUp(a.signUpData).success(function(e){i.$broadcast("loading:hide"),"Success"==e.status?n(["SUCCESS"]).then(function(t){a.alertPopup=r.alert({title:t.SUCCESS,template:e.description}),a.alertPopup.then(function(e){void 0!=e&&(a.alertPopup.close(),a.alertPopup=null,i.signupEmail=a.signUpData.email,o.transitionTo("app.login"))})}):n(["FAILED"]).then(function(t){r.alert({title:t.FAILED,template:e.description})})}).error(function(e){n(["SOMETHING_WRONG","FAILED"]).then(function(e){i.$broadcast("loading:hide"),r.alert({title:e.FAILED,template:e.SOMETHING_WRONG})})}))}}),a.$on("$destroy",function(){d&&(d(),p(),m(),u())})}]).controller("LoginCtrl",["$cordovaOauth","Auth","$http","fireRef","$q","LanguagesService","$translate","$rootScope","$localStorage","$stateParams","$scope","$ionicPopup","$timeout","EmployeeService","$state",function(e,t,o,i,n,a,r,l,s,c,d,p,u,m,g){d.$on("$ionicView.afterEnter",function(e,o){d.view_loaded=!0,d.loginData={},l.signupEmail&&(d.loginData.email=l.signupEmail,l.signupEmail=null),null!=window.localStorage.getItem("apikeypublic")&&void 0!=window.localStorage.getItem("apikeypublic")&&g.transitionTo("app.employee-index"),d.getLanguages=function(e,t){var o=n.defer();return a.get().then(function(t){var i=t.data.filter(function(t){return 0==t.name.toLowerCase().indexOf(e.toLowerCase())});o.resolve(i)}),o.promise},d.setLanguage=function(e){d.language=e.item?e.item.code:e.code,d.loginData.language=e.name,d.showList=!1},d.languages=[{code:"en",name:"English"}],d.showList=!1,d.sclogin=function(e){t.authenticate(e).then(function(e){c(e)},function(e){l.$broadcast("loading:hide")})};var c=function(e){r.use(d.language),s.picData||""==e.user.pic?s.picData&&e.user.pic!=s.picData&&m.saveDriverPic(s.picData,"personal"):s.picData=e.user.pic,s.name=e.user.name,s.email=e.user.email,s.user_id=e.user.id,l.name=e.user.name,l.loggedIn=!0,s.stripe=e.user.stripe,m.checkPrice(),m.findAllEmployees().then(function(e){m.getVehiclesPermits(!0,!0),m.authenticateToken().then(function(){d.employees=m.getEmployees(),l.$broadcast("loading:hide");for(var e in m.getzoneIDs())i.child(e+"/queue").orderByChild("timestamp").once("value",function(t){m.setEmpl(t,e)});l.detail?g.transitionTo("app.trip-detail"):m.isDriver()&&!m.isViewingOrder()?g.transitionTo("app.employee-index"):g.transitionTo("app.quoteform"),l.$broadcast("loading:hide",!0),m.processFirebase(),m.checkMessages(),m.setGroups()})})},u=function(){r(["SOMETHING_WRONG","FAILED"]).then(function(e){l.$broadcast("loading:hide"),p.alert({title:e.FAILED,template:e.SOMETHING_WRONG})})};d.doLogin=function(e){e.$submitted=!0,e.$valid&&(l.$broadcast("loading:show",{text:"SIGNING_IN"}),m.login(d.loginData).success(function(e){"Success"==e.status?c(e):(l.$broadcast("loading:hide"),r(["FAILED","LOGIN_CHECK"]).then(function(t){var o="";"Please check your email address and or password."==e.description&&(o=t.LOGIN_CHECK),p.alert({title:t.FAILED,template:o})}))}).error(function(e){l.$broadcast("loading:hide"),u()}))}})}]).controller("ForgotPasswordCtrl",["$state","$rootScope","$translate","$scope","$ionicModal","$ionicPopup","$timeout","EmployeeService","$state",function(e,t,o,i,n,a,r,l,e){i.forgotData={},i.getPassword=function(n){n.$submitted=!0,n.$valid&&(t.$broadcast("loading:show"),l.forgotPassword(i.forgotData).success(function(i){t.$broadcast("loading:hide"),o(["SUCCESS","FAILED","PLEASE_CHECK_EMAIL"]).then(function(t){if("Success"==i.status){var o=t.SUCCESS;e.transitionTo("app.login")}else var o=t.FAILED;a.alert({title:o,template:t.PLEASE_CHECK_EMAIL})})}).error(function(e){o(["SOMETHING_WRONG","FAILED"]).then(function(e){t.$broadcast("loading:hide"),a.alert({title:e.FAILED,template:e.SOMETHING_WRONG})})}))}}]).controller("EmployeeIndexCtrl",["toastr","$ionicListDelegate","fireRef","$filter","$ionicFilterBar","$ionicScrollDelegate","$translate","$localStorage","$ionicPopup","$ionicPopover","$ionicModal","$timeout","GpsDetectService","$scope","EmployeeService","$rootScope","$state","$firebase","$ionicPlatform","$cordovaGeolocation",function(e,t,o,i,n,a,r,l,s,c,d,p,u,m,g,f,v,h,_,E){m.$on("$ionicView.afterEnter",function(o,a){m.filteredArray=[];var c=m.$watchCollection("employees",function(e){m.filteredArray=i("filter")(e,function(e,t,o){return(e.dispatcher>0||e.apikeypublic==m.apikeypublic&&e.hasOwnProperty("can_bookin"))&&"My A2Bers"!=e.name&&!e.iscustomer})});m.user_id=l.user_id;var u=f.$watch("partnersQMode",function(e,t){e!=t&&(l.partnersQMode=f.partnersQMode,g.setGroupBidMode(e))});m.closeOption=function(){t.closeOptionButtons()},m.setBidMode=function(e){var t="quote"==e.mode?"offer":"quote";(e.biddable||"quote"!=t)&&(e.mode=t,g.setFbBidMode(e.category_id,t))};var h;m.showFilterBar=function(){h=n.show({items:m.employees,update:function(e,t){m.employees=e}})},m.initializing=g.isInitializingFB(),m.apikeypublic=window.localStorage.getItem("apikeypublic"),m.myrating=5,m.mypic=l.picData,m.searchKey="",g.setAllBookedStatus(),m.bookingChanged=function(e,t){g.toggleBook(t,e).then(function(e){})},m.clearSearch=function(){m.searchKey=""},m.startsWith=function(e,t){var o=(e+"").toLowerCase();return 0===o.indexOf(t.toLowerCase())},m.search=function(){g.findByName(m.searchKey).then(function(e){m.employees=e})};var _,E=function(){f.$broadcast("loading:show"),g.findAllEmployees().then(function(e){m.employees=g.getEmployees(),f.$broadcast("loading:hide")})},S=m.$on("internet:online",function(){null==g.getEmployees()&&E()}),D=m.$on("items:loaded",function(){m.employees=g.getEmployees(),f.$broadcast("loading:hide")});null!=g.getEmployees()?m.employees=g.getEmployees():f.$broadcast("loading:show");var y=m.$on("firebase:updated",function(e,t){m.employees=g.getEmployees()});m.showLargImage=function(e){m.allImages=[{src:e}],m.activeSlide=0,m.showModal("popovers/image-popover.html")},m.showModal=function(e){d.fromTemplateUrl(e,{scope:m,animation:"slide-in-up"}).then(function(e){m.fullSizeImageModal=e,m.fullSizeImageModal.show()})},m.closeModal=function(){m.fullSizeImageModal.hide(),m.fullSizeImageModal.remove()},m.isDriver=function(e){return e.my_tags&&e.my_tags.indexOf("Driver")>-1},m.getNoRatePlan=function(t){(services=g.getTagsRatePlan(t.category_id,t.my_tags))&&services.length>0&&r("NO_RATE_PLAN").then(function(o){e.info(services.join(", ")+" : <b>"+t.managerName+"</b>",o,{allowHtml:!0})})},m.isDisabled=!0,m.reportEvent=function(t){var o=$(this).find(".grouplist").data("id"),i=g.getEmployees()[o];if(t.target.className.indexOf("toggler")>-1){var n=i.booked,a=n?"-2":"2";return i.status=a,void(n?g.toggleBook(!n,i):i.allow_queue?g.hasServType(i.my_tags)?g.hasRatePlanServ(i.category_id,i.my_tags)?1==g.withinZone(i.category_id)?r(["SORRY","NO_ZONE"]).then(function(t){e.info(t.NO_ZONE,t.SORRY,{timeOut:3e3,positionClass:"toast-bottom-center"})}):g.isDispatcherAdmin(i.category_id)||g.withinZone(i.category_id)?!g.isDispatcherAdmin(i.category_id)&&m.isDriver(i)&&i.require_upload?g.getVehiclesPermits().then(function(){return g.checkForms(void 0,[!n,i])?(m.getNoRatePlan(i),void g.toggleBook(!n,i)):void f.$broadcast("loading:hide")}):(m.getNoRatePlan(i),g.toggleBook(!n,i)):r(["SORRY","NOT_IN_ZONE"]).then(function(t){e.info(t.NOT_IN_ZONE,t.SORRY,{timeOut:3e3,positionClass:"toast-bottom-center"})}):m.getNoRatePlan(i):r(["SORRY","NO_SERVICE_TYPE"]).then(function(t){e.info(t.NO_SERVICE_TYPE,t.SORRY,{timeOut:3e3,positionClass:"toast-bottom-center"})}):r(["SORRY","QUEUE_NOT_ALLOWED"]).then(function(t){e.info(t.QUEUE_NOT_ALLOWED,t.SORRY,{timeOut:3e3,positionClass:"toast-bottom-center"})}))}},m.dispatcherPage=function(e,t){var o=g.getEmployees()[t.id];if(e.offsetX<75&&$(e.target).find("img").length>0)m.showLargImage($(e.target).find("img")[0].src);else if("ION-OPTION-BUTTON"!=e.target.tagName&&(g.isDispatcherAdmin(t.category_id)||o&&o.my_tags.indexOf("Driver")>-1&&o.booked)&&null!=$(e.target).parent().data("link").match(/\d+/))if(!g.isDispatcherAdmin(t.category_id)&&t.booked){var i=g.getEmployees(),n=g.getGroupItems();f.tappedGroup=i[n[t.category_id].position],v.transitionTo("app.driver-home")}else v.transitionTo("app.employee-dispatcher",{employeeId:$(e.target).parent().data("link").match(/\d+/)[0]})},m.isOwner=function(e){return e==l.user_id},m.removeGroup=function(e){if(e.booked)return void r(["SORRY","BOOKOUT_FIRST"]).then(function(e){s.alert({cssClass:"bookoutFirst",title:e.SORRY,template:e.BOOKOUT_FIRST})});f.$broadcast("loading:show");var t={};g.getEmployees().forEach(function(o){o.category_id==e.category_id&&o.apikeypublic==window.localStorage.getItem("apikeypublic")&&(t=o)}),t.items=t.tags,void 0==t.items&&(t.items=[]),t.item="",t.itemType="",t.items.length>0&&(t.item=t.items.join(", "),t.itemType=t.items.join("&itemType[]=")),t.active=0,g.editDispatcherItem(t).then(function(e){g.findAllEmployees().then(function(e){g.autologin().then(function(e){f.$broadcast("items:loaded"),f.$broadcast("loading:hide")})})},function(){r(["SOMETHING_WRONG","FAILED"]).then(function(e){f.$broadcast("loading:hide"),s.alert({title:e.FAILED,template:e.SOMETHING_WRONG})})})},m.$on("$ionicView.beforeLeave",function(){h&&(h(),h=null),S(),y(),D(),_&&p.cancel(_),u&&u(),c&&c(),g.removeModalPopup(m,"fullSizeImageModal")})})}]).controller("FormsCtrl",["$stateParams","Initializer","$q","$ionicSlideBoxDelegate","$q","$ionicPopup","$ionicPopover","$cordovaCamera","CityState","$stateParams","$localStorage","$translate","$ionicPopup","$ionicPopover","$ionicModal","$timeout","$scope","EmployeeService","$rootScope","$state",function(e,t,o,i,o,n,a,r,l,e,s,c,n,a,d,p,u,m,g,f){u.allFormsFilled=!1,u.openForm=function(e){u[e]?u[e].show():d.fromTemplateUrl("modals/"+e+".html",{scope:u,animation:"slide-in-up"}).then(function(t){u[e]=t,"vin"!=e&&u[e].show(),"vehicle"==e&&u.openForm("vin")})},u.defaultDob=moment().subtract(18,"years").format("MM-DD-YYYY"),u.allFilled=!1;var v;t.mapsInitialized().then(function(){v=new google.maps.places.AutocompleteService}),u.showVehicle=e.vehicle,u.showPermit=e.permit,u.numberOfForms=(0|u.showVehicle)+(u.showPermit?2:0)+(null==g.picData?1:0);var h=void 0;u.getTestItems=function(e){var t=o.defer();return h=p(function(){u.nottyped=!1;var o={};o.input=e,o.types=["(cities)"],o.componentRestrictions={country:g.countryCode},v.getPlacePredictions(o,function(e,o){if(o==google.maps.places.PlacesServiceStatus.OK){for(var i=[],n=0;n<e.length;n++)i.push(e[n]);t.resolve(i)}})},350),t.promise},u.driverData={},u.vehicleData={};var _=function(){u.items=u.cities,u.driverData.cities=[],u.driverData.city="",u.driverData.permit_cities=""},h=void 0;u.getStates=function(e){var t=o.defer();return h=p(function(){l.findStates(e).then(function(e){t.resolve(e)})},350),t.promise},0==l.getCities().length?l.setCities().then(function(e){u.cities=l.getCities(),_()}):(u.cities=l.getCities(),_()),u.state_text_single="",u.stateval={single:null,multiple:null},u.city_text_single="",u.cityval={single:null,multiple:null},u.citySelected=function(e){if(u.driverData.cities.indexOf(e)>-1){if(1==u.driverData.cities.length)return u.setCityCheckMark(!1),void u.driverData.cities.splice(u.driverData.cities.indexOf(e),1);u.driverData.cities.splice(u.driverData.cities.indexOf(e),1)}else u.driverData.cities.push(e);1==u.driverData.cities.length?u.driverData.permit_cities=u.driverData.city=u.driverData.cities[0]:(u.driverData.city=u.driverData.cities.join(", "),u.driverData.permit_cities=u.driverData.cities.join('&driver["permit_cities"]=')),u.setCityCheckMark(!0)},u.setCityCheckMark=function(e){u.items.forEach(function(t){u.driverData.cities.indexOf(t.id)>-1?t.checked=e?!0:!t.checked:t.checked=!1})},u.showCity=function(e){g.showFancy(e)},a.fromTemplateUrl("popovers/pic-options.html",{scope:u}).then(function(e){u.popoverPic=e}),u.driverFormImages={},u.permitFormImages={},u.vehicleFormImages={},u.showLargeImage=function(e,t){if(u.allImages=[],u.activeSlide=t,"picForm"==e)u.allImages.push({src:u.picData});else for(var o in u[e])u.allImages.push({src:u[e][o]});u.showModal("popovers/image-popover.html")},u.showModal=function(e){d.fromTemplateUrl(e,{scope:u,animation:"slide-in-up"}).then(function(e){u.fullSizeImageModal=e,u.fullSizeImageModal.show()})},u.closeModal=function(){u.fullSizeImageModal.hide(),u.fullSizeImageModal.remove()},u.picOption=function(e,t){return ionic.Platform.isWebView()?(u.picFieldType=t,void u.popoverPic.show(e)):void document.getElementById("file_"+t).click()},u.license_filled=!1,u.permit_filled=!1,u.vehicle_filled=!1,u.personal_filled=!1,u.licensedata=function(e){return u.license_filled?u.license_upload+", "+u.permit_city:""},u.vehicledata=function(e){return u.vehicle_filled?u.insurance+", "+u.inspection_expiry_date:""},u.permitdata=function(e){return u.permit_filled?u.permit_upload:""},u.personaldata=function(e){return u.personal_filled?u.personal_upload:""},u.licenseFileLoaded=function(e,t,o,i,n){u.license_upload=o.name,p(function(){u.driverData.license_upload="data:image/jpeg;base64,"+n[0].base64,u.driverFormImages.license_upload=u.driverData.license_upload})},u.permitFileLoaded=function(e,t,o,i,n){u.permit_upload=o.name,p(function(){u.driverData.permit_upload="data:image/jpeg;base64,"+n[0].base64,u.permitFormImages.permit_upload=u.driverData.permit_upload})},u.permitCityFileLoaded=function(e,t,o,i,n){u.permit_city=o.name,p(function(){u.driverData.permit_city="data:image/jpeg;base64,"+n[0].base64,u.driverFormImages.permit_city=u.driverData.permit_city})},u.insuranceFileLoaded=function(e,t,o,i,n){u.insurance=o.name,p(function(){u.vehicleData.insurance="data:image/jpeg;base64,"+n[0].base64,u.vehicleFormImages.insurance=u.vehicleData.insurance})},u.inspectionFileLoaded=function(e,t,o,i,n){u.inspection_expiry_date=o.name,p(function(){u.vehicleData.inspection_expiry_date="data:image/jpeg;base64,"+n[0].base64,u.vehicleFormImages.inspection_expiry=u.vehicleData.inspection_expiry_date})},u.takePic=function(e){u.popoverPic.isShown()&&u.popoverPic.hide();var t=u.picFieldType,o={quality:40,destinationType:Camera.DestinationType.DATA_URL,encodingType:Camera.EncodingType.JPEG,targetWidth:320,targetHeight:320,saveToPhotoAlbum:!1};o.sourceType="camera"==e?Camera.PictureSourceType.CAMERA:Camera.PictureSourceType.PHOTOLIBRARY,r.getPicture(o).then(function(e){"personal_upload"!=t?"permit_city"==t||"license_upload"==t||"permit_upload"==t?u.driverData[t]="data:image/jpeg;base64,"+e:u.vehicleData[t]="data:image/jpeg;base64,"+e:u.picData=u.personal_pic="data:image/jpeg;base64,"+e,u[t]=t+"_image.jpeg",window.resolveLocalFileSystemURL(e,function(o){alert(e),alert(o),o.file(function(e){alert(e.name),u[t]=e.name},function(){alert("error")})})},function(e){})},u.saveDriverInfo=function(e){return e.$submitted=!0,e.$valid?(u.license_filled=!0,u.driving.hide(),!0):!1},u.savePermitInfo=function(e){e.$submitted=!0,e.$valid&&(u.permit_filled=!0,u.permit.hide())},u.savePersonalPic=function(e){return e.$submitted=!0,e.$valid?(u.personal_filled=!0,u.personalpic.hide(),!0):!1},u.saveDateTime=function(e,t){var o=this.$parent.hasOwnProperty("vehicleForm")?"vehicleData":"driverData";u[o][t]=moment(new Date(e)).format("MM/DD/YY"),"year"==t&&(u.vehicleData[t]=moment(new Date(e)).format("YYYY"))},u.validvin=!0,u.vinFieldsFilled=!1,u.saveVin=function(e){e.$valid&&(u.vinFieldsFilled=!0,u.vin.hide())},u.removeVinModal=function(){u.vin.hide()},u.done=function(e){g.$broadcast("loading:hide"),e&&!e.hasOwnProperty("status")?(u.validvin=!0,u.vehicleData.make=e.make.name,u.vehicleData.model=e.model.name,u.vehicleData.year=e.years[0].year,u.vehicleData.type=e.categories.vehicleType):u.validvin=!1},u.save=function(e){e.$submitted=!0;var t=[],i=u.showVehicle&&u.vehicle_filled?u.saveVehicle($("form[name='$parent.vehicleForm']").scope().$parent.vehicleForm):!1,n=u.showPermit&&u.license_filled&&u.permit_filled?u.saveDriverInfo($("form[name='$parent.driverForm']").scope().$parent.driverForm):!1,a=null==g.picData&&u.personal_filled?u.savePersonalPic($("form[name='$parent.personalForm']").scope().$parent.personalForm):!1;u.numberOfForms==(i?1:0)+(n?2:0)+(0==a?0:1)&&(i&&t.push(E()),n&&t.push(S()),a&&t.push(D()),u.allFormsFilled=!0,g.$broadcast("loading:show"),o.all(t).then(function(e){m.getVehiclesPermits(!0).then(function(){f.transitionTo("app.employee-index"),g.$broadcast("loading:hide")})}))};var E=function(){var e=o.defer();return m.saveVehicle(u.vehicleData).then(function(t){e.resolve()},function(t){e.reject()}),e.promise},S=function(){var e=o.defer();return u.driverData.permit_cities=u.driverData.city.join('&driver["permit_cities"]='),m.saveDriverInfo(u.driverData).then(function(t){e.resolve()},function(t){e.reject()}),e.promise},D=function(){var e=o.defer();return m.saveDriverPic(u.picData,"personal").then(function(){e.resolve()},function(t){e.reject()}),e.promise};u.saveVehicle=function(e){return e.$submitted=!0,e.vin.$pending&&e.vin.$pending.vin?void 0:e.$valid?(u.vehicle_filled=!0,u.vehicle.hide(),!0):!1},u.slide=function(e){var t=$('.slidingTabs li:contains("'+e+'")').index()+1;p(function(){$(".slidingTabs li:nth-child("+t+")").click()})},u.isMobile=ionic.Platform.isWebView(),u.loaded=function(e,t,o,i,n){u.personal_upload=o.name,p(function(){u.picData=u.personal_pic="data:image/jpeg;base64,"+angular.element(document.getElementById("file_personal_upload")).scope().myimage.base64})},u.takePicture=function(){var e={quality:80,destinationType:Camera.DestinationType.DATA_URL,sourceType:Camera.PictureSourceType.CAMERA,encodingType:Camera.EncodingType.JPEG,targetWidth:320,saveToPhotoAlbum:!1};r.getPicture(e).then(function(e){u.picData="data:image/jpeg;base64,"+e,u.ftLoad=!0,u.nopic=!0},function(e){})},u.selectPicture=function(){var e={quality:80,destinationType:Camera.DestinationType.DATA_URL,sourceType:Camera.PictureSourceType.PHOTOLIBRARY,encodingType:Camera.EncodingType.JPEG};r.getPicture(e).then(function(e){"content://com.android"==e.substring(0,21)&&(e="content://media/external/images/media/"+e.split("%3A")[1]),u.picData="data:image/jpeg;base64,"+e,u.ftLoad=!0},function(e){})},u.uploadPicture=function(){return u.ftLoad?!0:(u.nopic=!0,u.slide("Picture"),!1)},u.$on("$destroy",function(){u.vin&&(u.vin.remove(),u.vin=null),u.driving&&(u.driving.remove(),u.driving=null),u.permit&&(u.permit.remove(),u.permit=null),u.vehicle&&(u.vehicle.remove(),u.vehicle=null),u.personalpic&&(u.personalpic.remove(),u.personalpic=null),l.clearStates()})}]).controller("EmployeeDrivingCtrl",["$q","$ionicPopup","$ionicPopover","$cordovaCamera","CityState","$stateParams","$localStorage","$translate","$ionicPopup","$ionicModal","$timeout","$scope","EmployeeService","$rootScope","$state",function(e,t,o,i,n,a,r,l,t,s,c,d,p,u,m){d.$on("$destroy",function(){n.clearStates()}),d.defaultDob=moment().subtract(18,"years").format("MM-DD-YYYY");var g=new google.maps.places.AutocompleteService,f=void 0;d.getTestItems=function(t){var o=e.defer();return f=c(function(){d.nottyped=!1;var e={};e.input=t,e.types=["(cities)"],e.componentRestrictions={country:u.countryCode},g.getPlacePredictions(e,function(e,t){if(t==google.maps.places.PlacesServiceStatus.OK){for(var i=[],n=0;n<e.length;n++)i.push(e[n]);o.resolve(i)}})},350),o.promise},d.driverData={},d.saveDateTime=function(e,t){d.driverData[t]=moment(new Date(e)).format("MM/DD/YY")};var v=function(){d.items=d.cities,d.driverData.cities=[],d.driverData.city="",d.driverData.permit_cities=""},f=void 0;d.getStates=function(t){var o=e.defer();return f=c(function(){n.findStates(t).then(function(e){o.resolve(e)})},350),o.promise},0==n.getCities().length?n.setCities().then(function(e){d.cities=n.getCities(),v()}):(d.cities=n.getCities(),v()),d.state_text_single="",d.stateval={single:null,multiple:null},d.city_text_single="",d.cityval={single:null,multiple:null},d.citySelected=function(e){if(d.driverData.cities.indexOf(e)>-1){if(1==d.driverData.cities.length)return d.setCityCheckMark(!1),void d.driverData.cities.splice(d.driverData.cities.indexOf(e),1);d.driverData.cities.splice(d.driverData.cities.indexOf(e),1)}else d.driverData.cities.push(e);1==d.driverData.cities.length?d.driverData.permit_cities=d.driverData.city=d.driverData.cities[0]:(d.driverData.city=d.driverData.cities.join(", "),d.driverData.permit_cities=d.driverData.cities.join('&driver["permit_cities"]=')),d.setCityCheckMark(!0)},d.setCityCheckMark=function(e){d.items.forEach(function(t){d.driverData.cities.indexOf(t.id)>-1?t.checked=e?!0:!t.checked:t.checked=!1})},d.showCity=function(e){u.showFancy(e)},o.fromTemplateUrl("popovers/pic-options.html",{scope:d}).then(function(e){d.popoverPic=e}),d.driverFormImages={},d.permitFormImages={},d.showLargeImage=function(e,t){d.allImages=[],d.activeSlide=t;for(var o in d[e])d.allImages.push({src:d[e][o]});d.showModal("popovers/image-popover.html")},d.showModal=function(e){s.fromTemplateUrl(e,{scope:d,animation:"slide-in-up"}).then(function(e){d.fullSizeImageModal=e,d.fullSizeImageModal.show()})},d.closeModal=function(){d.fullSizeImageModal.hide(),d.fullSizeImageModal.remove()},d.licenseFileLoaded=function(e,t,o,i,n){d.license_upload=o.name,c(function(){d.driverData.license_upload="data:image/jpeg;base64,"+n[0].base64,d.driverFormImages.license_upload=d.driverData.license_upload})},d.permitCityFileLoaded=function(e,t,o,i,n){d.permit_city=o.name,c(function(){d.driverData.permit_city="data:image/jpeg;base64,"+n[0].base64,d.driverFormImages.permit_city=d.driverData.permit_city})},d.permitFileLoaded=function(e,t,o,i,n){d.permit_upload=o.name,c(function(){d.driverData.permit_upload="data:image/jpeg;base64,"+n[0].base64,d.permitFormImages.permit_upload=d.driverData.permit_upload})},d.picOption=function(e,t){return ionic.Platform.isWebView()?(d.picFieldType=t,void d.popoverPic.show(e)):void document.getElementById("file_"+t).click()},d.takePic=function(e){d.popoverPic.isShown()&&d.popoverPic.hide();var t=d.picFieldType,o={quality:40,destinationType:Camera.DestinationType.DATA_URL,encodingType:Camera.EncodingType.JPEG,targetWidth:320,targetHeight:320,saveToPhotoAlbum:!1};o.sourceType="camera"==e?Camera.PictureSourceType.CAMERA:Camera.PictureSourceType.PHOTOLIBRARY,i.getPicture(o).then(function(e){d.driverData[t]="data:image/jpeg;base64,"+e,$("#"+t).hasClass("button-positive")||$("#"+t).addClass("button-positive"),d[t]=t+"_image.jpeg"},function(e){})},d.saveDriverInfo=function(e){e.$submitted=!0,e.$valid&&(d.driverData.city&&(d.driverData.permit_cities=d.driverData.city.join('&driver["permit_cities"]=')),u.$broadcast("loading:show"),p.saveDriverInfo(d.driverData).then(function(e){p.getVehiclesPermits(!0).then(function(){u.$broadcast("loading:hide"),l(["SUCCESS","FORM_SUBMITTED"]).then(function(e){t.alert({title:e.SUCCESS,template:e.FORM_SUBMITTED})}),m.transitionTo("app.employee-index")})},function(e){l(["SOMETHING_WRONG","FAILED"]).then(function(e){u.$broadcast("loading:hide"),t.alert({title:e.FAILED,template:e.SOMETHING_WRONG})})}))}}]).controller("EmployeePOICtrl",["toastr","$q","$stateParams","$localStorage","$translate","$ionicPopup","$ionicModal","$timeout","$scope","EmployeeService","$rootScope","$state",function(e,t,o,i,n,a,r,l,s,c,d,p){var u=new google.maps.places.AutocompleteService,m=void 0;s.pois=null,s.locations=[],s.search={value:""},s.loading=!1,s.searchPoi=!1,s.showSearch=function(){s.searchPoi=!0},s.getPOIs=function(){d.$broadcast("loading:show"),c.getPOIs().then(function(e){s.pois=e.hasOwnProperty("pois")?e.pois:[],d.$broadcast("loading:hide"),s.locations=[],s.search={value:""}},function(){})},s.getPOIs(),s.findPOI=function(e){m=l(function(){if(!(s.search.value.length<2)){s.loading=!0,s.locations=[];var t={};t.input=e,t.componentRestrictions={country:d.countryCode},u.getPlacePredictions(t,function(e,t){if(t==google.maps.places.PlacesServiceStatus.OK)for(var o=[],i=0;i<e.length;i++)googlePlacesService=new google.maps.places.PlacesService($("#ionsearch")[0]),googlePlacesService.getDetails({reference:e[i].reference},function(e,t){e&&(o.push(e),s.locations.push(e),s.loading&&l(function(){s.loading=!1}),s.search.value.length<2&&(s.locations=[]))});else s.loading=!1})}},350)};var g=s.$watch("search.value",function(e,t){e.length>1?s.findPOI(e):(s.loading=!1,s.locations=[])});s.clearSearch=function(){s.search.value=""},s.saveLocation=function(e){s.data={},s.types=[],s.data.showtype=!1,n(["AIRPORTS","APARTMENTS","BARS","BUS_STATIONS","COFFEE_SHOPS","CHURCHES","COLLEGES","CONVENTION","HOSPITALS","HOTELS","INTERSECTIONS","MALLS","OFFICE","PARKS","POI","RETAIL","TRAIN","UNIVERSITIES"]).then(function(e){for(var t in e)s.types.push(e[t])}),s.selectType=function(e){s.data.showtype=!s.data.showtype,s.data.type=e};var t=['<input placeholder="{{\'PLEASE_ENTER_NAME\' | translate}}" type="text" ng-model="data.name">','<div class="list list-inset cont-list">','<div ng-click="data.showtype=!data.showtype" class="modal-list-items bar item-input-inset search-bar">','<label class="item-input-wrapper">','<input class="google-place-search pickup" readonly placeholder="{{\'LOCATION_TYPE\' | translate}}" type="text" ng-model="data.type">',"</label>","<span ng-class=\"{'ion-android-arrow-dropup': data.showtype, 'ion-android-arrow-dropdown' : !data.showtype}\" class=\"button button-clear icon dropdown-icon typedropdown\"></span>","</div>",'<ion-list ng-show="data.showtype">','<ion-item ng-repeat="type in types" class="item-text-wrap" ng-click="selectType(type)">',"{{type}}","</ion-item>","</ion-list>","</div>"].join("");n(["CANCEL","SAVE","ENTER_POI_NAME"]).then(function(o){var i=a.show({cssClass:"poiAlert",template:t,title:o.ENTER_POI_NAME,subTitle:e.name+", "+e.vicinity,scope:s,buttons:[{text:o.CANCEL},{text:"<b>"+o.SAVE+"</b>",type:"button-positive",onTap:function(e){return s.data.name&&s.data.type?!0:void e.preventDefault()}}]});i.then(function(t){t&&(s.data.address=e.name+", "+e.vicinity,s.data.lat=e.geometry.location.lat(),s.data.lng=e.geometry.location.lng(),s.savePOI())})})},s.savePOI=function(){d.$broadcast("loading:show"),c.savePOI(s.data).then(function(t){d.$broadcast("loading:hide"),n(["SUCCESS","POI_SAVED"]).then(function(t){e.success(t.POI_SAVED,t.SUCCESS,{timeOut:3e3,positionClass:"toast-bottom-center"})}),s.getPOIs()},function(e){n(["SOMETHING_WRONG","FAILED"]).then(function(e){d.$broadcast("loading:hide"),
a.alert({title:e.FAILED,template:e.SOMETHING_WRONG})})})},s.deletePOI=function(e){d.$broadcast("loading:show"),c.savePOI(e,!0).then(function(e){d.$broadcast("loading:hide"),s.getPOIs()},function(e){n(["SOMETHING_WRONG","FAILED"]).then(function(e){d.$broadcast("loading:hide"),a.alert({title:e.FAILED,template:e.SOMETHING_WRONG})})})},s.$on("$ionicView.beforeLeave",function(){g()})}]).controller("EmployeePasswordCtrl",["$stateParams","$localStorage","$translate","$ionicPopup","$ionicPopover","$ionicModal","$timeout","$scope","EmployeeService","$rootScope","$state",function(e,t,o,i,n,a,r,l,s,c,d){l.changepwdData={},l.changePassword=function(e){e.$submitted=!0,e.$valid&&(c.$broadcast("loading:show"),s.changePassword(l.changepwdData).then(function(e){c.$broadcast("loading:hide"),"Success"==e.status?o(["SUCCESS"]).then(function(t){i.alert({title:t.SUCCESS,template:e.description})}):o(["FAILED"]).then(function(t){i.alert({title:t.FAILED,template:e.description})})},function(e){o(["SOMETHING_WRONG","FAILED"]).then(function(e){c.$broadcast("loading:hide"),i.alert({title:e.FAILED,template:e.SOMETHING_WRONG})})}))}}]).controller("EmployeeVehicleCtrl",["$cordovaCamera","$stateParams","$localStorage","$translate","$ionicPopup","$ionicPopover","$ionicModal","$timeout","$scope","EmployeeService","$rootScope","$state",function(e,t,o,i,n,a,r,l,s,c,d,p){a.fromTemplateUrl("popovers/pic-options.html",{scope:s}).then(function(e){s.popoverPic=e}),r.fromTemplateUrl("modals/vin.html",{scope:s,animation:"slide-in-up"}).then(function(e){s.vin=e}),s.saveDateTime=function(e,t){s.vehicleData[t]=moment(new Date(e)).format("MM/DD/YY"),"year"==t&&(s.vehicleData[t]=moment(new Date(e)).format("YYYY"))},s.picOption=function(e,t){return ionic.Platform.isWebView()?(s.picFieldType=t,void s.popoverPic.show(e)):void document.getElementById("file_"+t).click()},s.takePic=function(t){s.popoverPic.isShown()&&s.popoverPic.hide();var o=s.picFieldType,i={quality:40,destinationType:Camera.DestinationType.DATA_URL,encodingType:Camera.EncodingType.JPEG,targetWidth:320,targetHeight:320,saveToPhotoAlbum:!1};i.sourceType="camera"==t?Camera.PictureSourceType.CAMERA:Camera.PictureSourceType.PHOTOLIBRARY,e.getPicture(i).then(function(e){s[o]=o+"_image.jpeg",s.vehicleData[o]="data:image/jpeg;base64,"+e},function(e){})},s.vehicleData={},s.validvin=!0,s.vinFieldsFilled=!1,s.saveVin=function(e){e.$valid&&(s.vinFieldsFilled=!0,s.vin.hide())},s.removeVinModal=function(){s.vin.hide()},s.done=function(e){d.$broadcast("loading:hide"),e&&!e.hasOwnProperty("status")?(s.validvin=!0,s.vehicleData.make=e.make.name,s.vehicleData.model=e.model.name,s.vehicleData.year=e.years[0].year,s.vehicleData.type=e.categories.vehicleType):s.validvin=!1},s.vehicleFormImages={},s.showLargeImage=function(e,t){s.allImages=[],s.activeSlide=t;for(var o in s[e])s.allImages.push({src:s[e][o]});s.showModal("popovers/image-popover.html")},s.showModal=function(e){r.fromTemplateUrl(e,{scope:s,animation:"slide-in-up"}).then(function(e){s.fullSizeImageModal=e,s.fullSizeImageModal.show()})},s.closeModal=function(){s.fullSizeImageModal.hide(),s.fullSizeImageModal.remove()},s.insuranceFileLoaded=function(e,t,o,i,n){s.insurance=o.name,l(function(){s.vehicleData.insurance="data:image/jpeg;base64,"+n[0].base64,s.vehicleFormImages.insurance=s.vehicleData.insurance})},s.inspectionFileLoaded=function(e,t,o,i,n){s.inspection_expiry_date=o.name,l(function(){s.vehicleData.inspection_expiry_date="data:image/jpeg;base64,"+n[0].base64,s.vehicleFormImages.inspection_expiry=s.vehicleData.inspection_expiry_date})},s.saveVehicle=function(e){e.$submitted=!0,e.vin.$pending&&e.vin.$pending.vin||e.$valid&&(d.$broadcast("loading:show"),c.saveVehicle(s.vehicleData).then(function(e){c.getVehiclesPermits(!0).then(function(){d.$broadcast("loading:hide"),i(["SUCCESS"]).then(function(t){n.alert({title:t.SUCCESS,template:e.description})}),p.transitionTo("app.employee-index")})},function(e){i(["SOMETHING_WRONG","FAILED"]).then(function(e){d.$broadcast("loading:hide"),n.alert({title:e.FAILED,template:e.SOMETHING_WRONG})})}))},s.$on("$destroy",function(){s.vin&&(s.vin.remove(),s.vin=null),s.popoverPic&&(s.popoverPic.remove(),s.popoverPic=null)})}]).controller("EmployeePicCtrl",["$state","$ionicModal","$timeout","$ionicPopover","$ionicPopup","EmployeeService","$translate","$rootScope","$scope","$cordovaCamera","baseUrl",function(e,t,o,i,n,a,r,l,s,c,d){s.showLargeImage=function(){"img/camera.png"!=s.picData&&(s.allImages=[{src:s.picData}],s.activeSlide=0,s.showModal("popovers/image-popover.html"))},s.showModal=function(e){t.fromTemplateUrl(e,{scope:s,animation:"slide-in-up"}).then(function(e){s.fullSizeImageModal=e,s.fullSizeImageModal.show()})},s.closeModal=function(){s.fullSizeImageModal.hide(),s.fullSizeImageModal.remove()},i.fromTemplateUrl("popovers/pic-options.html",{scope:s}).then(function(e){s.popoverPic=e}),s.picData="img/camera.png",s.picOption=function(e,t){return ionic.Platform.isWebView()?void s.popoverPic.show(e):void document.getElementById("file_"+t).click()},s.loaded=function(e,t,i,n,a){s.personal_upload=i.name,o(function(){s.picData=s.personal_pic="data:image/jpeg;base64,"+angular.element(document.getElementById("file_personal_upload")).scope().myimage.base64})},s.ftLoad=!1,s.isMobile=ionic.Platform.isWebView(),s.takePic=function(e){s.popoverPic.isShown()&&s.popoverPic.hide();var t={quality:80,destinationType:Camera.DestinationType.DATA_URL,sourceType:Camera.PictureSourceType.CAMERA,encodingType:Camera.EncodingType.JPEG,targetWidth:320,saveToPhotoAlbum:!1};t.sourceType="camera"==e?Camera.PictureSourceType.CAMERA:Camera.PictureSourceType.PHOTOLIBRARY,c.getPicture(t).then(function(e){s.personal_upload="personal_upload_image.jpeg",s.picData=s.personal_pic="data:image/jpeg;base64,"+e,s.ftLoad=!0},function(e){})},s.selectPicture=function(){var e={quality:80,destinationType:Camera.DestinationType.DATA_URL,sourceType:Camera.PictureSourceType.PHOTOLIBRARY,encodingType:Camera.EncodingType.JPEG};c.getPicture(e).then(function(e){"content://com.android"==e.substring(0,21)&&(e="content://media/external/images/media/"+e.split("%3A")[1]),s.picData="data:image/jpeg;base64,"+e,s.ftLoad=!0},function(e){})},s.savePersonalPic=function(t){t.$submitted=!0,t.$valid&&(l.$broadcast("loading:show"),a.saveDriverPic(s.picData,"personal").then(function(){r(["PIC_UPLOADED","SUCCESS"]).then(function(t){l.$broadcast("loading:hide"),n.alert({title:t.SUCCESS,template:t.PIC_UPLOADED}),e.transitionTo("app.employee-index")})},function(e){r(["SOMETHING_WRONG","FAILED"]).then(function(e){l.$broadcast("loading:hide"),n.alert({title:e.FAILED,template:e.SOMETHING_WRONG})})}))},s.$on("$destroy",function(){s.popoverPic&&(s.popoverPic.remove(),s.popoverPic=null)})}]).controller("AddGroupCtrl",["toastr","fireRef","$filter","$ionicScrollDelegate","$ionicPopover","$cordovaCamera","$stateParams","$localStorage","$translate","$ionicPopup","$ionicPopover","$ionicModal","$timeout","$scope","EmployeeService","$rootScope","$state",function(e,t,o,i,n,a,r,l,s,c,n,d,p,u,m,g,f){var v=this;v.planForm=null,u.$on("$ionicView.afterEnter",function(t,h){n.fromTemplateUrl("popovers/pic-options.html",{scope:u}).then(function(e){u.popoverPic=e}),s(["BIDDABLE","REQ_DOC_UPLD","ZONE_BASED","RADIUS_BASED"]).then(function(e){u.settings=[{enabled:g.biddable,val:"biddable",text:e.BIDDABLE},{enabled:g.rquire_uppload,val:"rquire_uppload",text:e.REQ_DOC_UPLD}]}),u.picOption=function(e){return ionic.Platform.isWebView()?void u.popoverPic.show(e):void document.getElementById("group_pic_upload").click()},u.picLoaded=function(e,t,o,i,n){p(function(){u.groupData.pic="data:image/jpeg;base64,"+n[0].base64})},u.takePic=function(e){u.popoverPic.isShown()&&u.popoverPic.hide();var t={quality:40,destinationType:Camera.DestinationType.DATA_URL,encodingType:Camera.EncodingType.JPEG,targetWidth:320,targetHeight:320,saveToPhotoAlbum:!1};t.sourceType="camera"==e?Camera.PictureSourceType.CAMERA:Camera.PictureSourceType.PHOTOLIBRARY,a.getPicture(t).then(function(e){u.groupData.pic="data:image/jpeg;base64,"+e},function(e){})},u.alreadyExists=function(e){return"My A2Bers"!=e},d.fromTemplateUrl("modals/market.html",{scope:u,animation:"slide-in-up"}).then(function(e){u.vin=e}),u.showMarket=function(){u.filteredCenters.length>0?u.showMarketList=!u.showMarketList:u.viewMarket()},u.viewMarket=function(e){if(u.centerSelected=!0,e?(e.location?(u.groupData.center=e.location,u.groupData.formatted_address=e.location):m.getLocation(e.lat,e.lon).then(function(e){u.groupData.formatted_address=e,u.groupData.center=e}),u.groupData.center_name=e.name,u.groupData.center_id=e.id,u.groupData.lat=e.lat,u.groupData.lon=e.lon,u.groupData.radius=Number(e.radius),u.groupData.zone_radius=Number(e.zone_radius)):(u.groupData.center_id=null,u.groupData.center=null,u.groupData.formatted_address=null,u.groupData.center_name=null,u.groupData.lat=null,u.groupData.lon=null,u.groupData.radius=null,u.groupData.zone_radius=null),null!=u.marketModal)return void u.marketModal.show();d.fromTemplateUrl("modals/market.html",{scope:u,animation:"slide-in-up",backdropClickToClose:!1}).then(function(e){u.marketModal=e,e.show()})},u.removeMarketModal=function(){u.marketModal.hide()},u.verifyDuplicate=function(e){var t=!1;u.centers.some(function(e){return e.id!=u.groupData.center_id&&(t=e.name==u.groupData.center_name)}),u.oldcenters.some(function(e){return e.id!=u.groupData.center_id&&(t=e.name==u.groupData.center_name)}),e.name.$setValidity("duplicate",!t)},u.saveMarket=function(e){if(e.$submitted=!0,e.$valid){var t={location:u.groupData.center,name:u.groupData.center_name,id:u.groupData.center_id,lat:u.groupData.lat,lon:u.groupData.lon,radius:u.groupData.radius,zone_radius:u.groupData.zone_radius};if(u.groupData.center_id){var o;u.centers.some(function(e,t){return e.id==u.groupData.center_id?o=t:void 0});var i=-1;u.groupData.zones.some(function(e,t){return e.id==u.groupData.center_id?i=t:void 0}),-1==i?u.groupData.zones.push(t):u.groupData.zones[i]=t,u.centers[o]=t}else t.id=Math.abs(Math.random().toString().split("").reduce(function(e,t){return(e<<5)-e+t})).toString(36).substr(0,11)+(new Date).getTime(),u.centers.push(t),u.groupData.zones.push(t);u.removeMarketModal()}},u.deleteMarket=function(){var e;u.centers.some(function(t,o){return t.id==u.groupData.center_id?e=o:void 0}),u.centers.splice(e,1),u.oldcenters.some(function(e){return e.id==u.groupData.center_id?u.groupData.zonesDelete.push(e):void 0}),u.removeMarketModal()},u.filterFunc=function(e){return"string"==typeof e.lat},u.showPlan=function(){u.rateplans&&u.rateplans.length>0?u.showPlanList=!u.showPlanList:u.viewPlan()},u.viewPlan=function(e,t){return u.rateplan={},u.rateplan.settings=[],u.newplan=!0,e&&(u.newplan=!1,u.rateplan=angular.copy(e)),null!=u.planModal?void u.planModal.show():void u.createPlanModal(!0)},u.createPlanModal=function(e){u.planModal||d.fromTemplateUrl("modals/rateplan.html",{scope:u,animation:"slide-in-up",backdropClickToClose:!1}).then(function(t){u.planModal=t,e&&u.planModal.show()})},p(function(){u.createPlanModal()},2e3),u.removePlanModal=function(e){e&&u.oldplans&&u.oldplans.forEach(function(e){if(u.rateplan.id&&u.rateplan.id==e.id){var t={};t.id=e.id,t.name=e.name,t.rateplan=[],e.settings.forEach(function(e,o){t.rateplan.push("rateplan["+o+"]="+e)}),u.rateplan=t}}),u.planModal.hide(),p(function(){u.planModal&&(u.planModal.remove(),u.planModal=null,u.createPlanModal())},2e3)},u.savePlan=function(){u.rateplan.settings[0]=u.days[0],u.rateplan.settings[1]=u.times[0],u.rateplan.settings[2]=u.days[0],u.rateplan.settings[3]=u.times[0],u.rateplan.settings[7]=u.times[0],u.rateplan.settings[11]=u.pickups[0],u.rateplan.settings[12]=u.pickups[0],u.rateplan.settings[13]=0,u.rateplan.settings[14]="Any";var e=!0;if(v.planForm.$submitted=!0,u.oldplans&&u.oldplans.forEach(function(t){u.rateplan.id&&u.rateplan.id==t.id&&angular.equals(u.rateplan,t)&&(e=!1)}),u.rateplans.forEach(function(e){(u.newplan||u.rateplan.id&&u.rateplan.id!=e.id)&&angular.equals(u.rateplan,e)?(v.planForm.$valid=!1,v.planForm.planexists.$valid=!1):!u.newplan&&u.rateplan.id&&u.rateplan.id==e.id&&(e.name=u.rateplan.name,u.rateplan.settings.forEach(function(t,o){e.settings[o]=t}))}),v.planForm.$valid){if(e){var t={};t.id=u.rateplan.id,t.name=u.rateplan.name,t.rateplan=[],u.rateplan.settings.forEach(function(e,o){t.rateplan.push("rateplan["+o+"]="+e)}),u.newplan&&u.rateplans.push(u.rateplan),u.groupData.toSaveRateplans.push(t)}u.removePlanModal()}},u.isSelectedService=function(e){return u.planModal&&u.planModal.isShown()&&u.rateplan?u.rateplan.settings[9]?u.rateplan.settings[9]==e:!1:(u.rateplan={},u.rateplan.settings=[],!1)},u.hasRatePlan=function(e){var t=!1;return u.rateplans.some(function(o){return o.settings[9]==e?t=!0:void 0}),t},u.setRateService=function(e){u.rateplan.settings[9]=e.text,u.showDayTime("RateServ")},u.noService=function(t){t.enabled&&!u.hasRatePlan(t.text)&&s("NO_RATE_PLAN").then(function(o){e.info(o+t.text)}),t.enabled?u.selectedServ++:u.selectedServ--},u.isSelectedTime=function(e,t){return u.planModal&&u.planModal.isShown()&&u.rateplan?u.rateplan.settings[e]?u.rateplan.settings[e]==t:!1:(u.rateplan={},u.rateplan.settings=[],!1)},u.setTime=function(e,t,o){u.rateplan.settings[t]=o,u.showDayTime(e)},u.showDayTime=function(e){u["show"+e+"List"]=!u["show"+e+"List"],i.resize()};var _=u.$watchCollection("centers",function(e){u.filteredCenters=o("filter")(e,function(e,t,o){return"string"==typeof e.lat})});u.selectLocation=function(e){void 0!=e.geometry&&(u.groupData.lat=e.geometry.location.lat().toString(),u.groupData.lon=e.geometry.location.lng().toString(),u.groupData.formatted_address=e.formatted_address,u.groupData.center=e.formatted_address,u.resizeScroll(),u.resetAutoComplete())},u.clearSearch=function(){u.groupData.center="",u.centerSelected=!0};var E=u.$watch("locations",function(e){e&&e&&e.length>0&&u.resizeScroll()}),S=u.$watch("groupData.center",function(e){if(e){if(e==u.groupData.formatted_address)return;u.centerSelected=!1,m.findplaces(e,"",u,angular.element(document.querySelector(".centerautocomplete")))}else u.resetAutoComplete()}),D=u.$watch("groupData.zone_based_queuing",function(e){e&&(u.groupData.lat=null,u.groupData.lon=null,u.groupData.formatted_address=null,u.groupData.center=null)});u.resizeScroll=function(){i.resize()},u.resetAutoComplete=function(){u.locations&&(u.locations.length=0),u.typed=!1,u.centerSelected=!0},u.removeGroupModal=function(){u.groupModal.remove(),u.groupModal=null};var y=1;m.getEmployees().forEach(function(e){e.hasOwnProperty("can_bookin")&&e.user_id==l.user_id&&y++}),u.groupHeader="ADD_GROUP",u.groupFooter="ADD",u.groupData={},u.rateplan={},u.rateplan.settings=[],u.groupData.toSaveRateplans=[],u.groupData.active=0,u.groupData.name=l.name,u.groupData.tags=[],u.groupData.services=[],u.groupData.allow_queue=g.allow_queue,u.groupData.zone_based_queuing=!0,u.services=[],u.rateservices=[],u.centers=[],u.oldcenters=[],u.rateplans=[],u.groupData.zones=[],u.groupData.zonesDelete=[],u.selectedServ=0;var T=m.getzoneMap();for(var M in m.getTagsDriverDefault())"all"!=M&&(u.services.push({enabled:!1,text:M,icon:"pics/taxi.png"}),u.rateservices.push({enabled:!1,text:M,icon:"pics/taxi.png"}));u.days=["Always","Weekdays","Weekends"],u.times=["All Day","Mornings","Afternoons","Nights","Late Nights"],u.pickups=["Any"],moment.range(moment(),moment().add(1,"months")).by("days",function(e){u.days.push(e.format("MM/DD/YYYY"))}),moment.range(moment().startOf("day"),moment().endOf("day")).by("hours",function(e){u.times.push(e.format("HH:mm")),u.times.push(e.add(30,"minutes").format("HH:mm"))}),""!=r.id&&(m.getEmployees().forEach(function(e){e.id==r.id&&e.user_id==l.user_id&&(u.groupData.name=e.name,u.groupData.active=parseInt(e.active),e.settings&&Object.keys(e.settings).length>0&&(u.groupData.allow_advance_reservation=parseInt(e.settings.allow_advance_reservation),u.groupData.allow_remote_reservation=parseInt(e.settings.allow_remote_reservation),u.groupData.jail=parseInt(e.settings.jail),u.groupData.offer=parseInt(e.settings.offer),u.groupData.zone_based_queuing="yes"==e.settings.zone_based_queuing,u.groupData.allow_queue=g.allow_queue,u.services.forEach(function(t){t.enabled=e.settings.services.indexOf(t.text)>-1,t.enabled&&u.selectedServ++})),u.groupHeader=e.firstName,u.groupImg=e.pic,u.groupFooter="UPDATE",u.groupData.id=e.category_id,T.hasOwnProperty(e.category_id)&&T[e.category_id].length>0&&(u.centers=T[e.category_id].slice(0),u.oldcenters=T[e.category_id].slice(0),T[e.category_id].forEach(function(e){u.pickups.push(e.name)})))}),m.fetchPlans(u.groupData.id).then(function(e){u.rateplans=[],e.rateplans.forEach(function(e){e.settings&&(u.rateplans.push(e),e.name=e.name.replace("Rate Plan ",""),e.settings[4]=parseFloat(e.settings[4]),e.settings[5]=parseFloat(e.settings[5]),e.settings[6]=parseFloat(e.settings[6]),e.settings[7]=parseFloat(e.settings[7]),e.settings[8]=parseFloat(e.settings[8]),e.settings[10]=parseFloat(e.settings[10]),e.settings[13]=parseFloat(e.settings[13]))}),u.oldplans=angular.copy(u.rateplans)})),u.addGroup=function(e){if(e.$submitted=!0,e.$valid){g.$broadcast("loading:show");var t=!1;m.findAllEmployees().then(function(e){return!g.noGroups&&(e.items.every(function(e){return e.dispatcher<1&&e.apikeypublic==window.localStorage.getItem("apikeypublic")&&e.overdue?(e.overdue.user<0&&(t=e.overdue.user),!1):!0}),t)?(g.$broadcast("loading:hide"),void s(["SORRY","APP_OVERDUE1","APP_OVERDUE2"]).then(function(e){var o=c.alert({title:e.SORRY,template:e.APP_OVERDUE1+Math.abs(t)+e.APP_OVERDUE2});o.then(function(e){f.transitionTo("app.employee-index")})})):(u.settings.forEach(function(e){e.enabled&&u.groupData.tags.push("tags[]="+e.val)}),u.services.forEach(function(e){e.enabled&&u.groupData.services.push("services[]="+e.text)}),u.groupData.centers=u.centers,void m.addGroup(u.groupData).then(function(e){var t=angular.fromJson(angular.toJson(u.rateplans)),o={};t.forEach(function(e){o[e.id]=e}),"Successful"==e.status&&m.findAllEmployees().then(function(t){g.$broadcast("loading:hide"),s(["SUCCESS"]).then(function(t){c.alert({title:t.SUCCESS,template:e.description})}),f.transitionTo("app.employee-index")})},function(e){g.$broadcast("loading:hide"),s(["SOMETHING_WRONG","FAILED"]).then(function(e){g.$broadcast("loading:hide"),c.alert({title:e.FAILED,template:e.SOMETHING_WRONG})})}))},function(e){g.$broadcast("loading:hide"),s(["SOMETHING_WRONG","FAILED"]).then(function(e){g.$broadcast("loading:hide"),c.alert({title:e.FAILED,template:e.SOMETHING_WRONG})})})}},u.$on("$ionicView.beforeLeave",function(){S&&S(),D&&D(),u.marketModal&&m.removeModalPopup(u,"marketModal"),u.planModal&&m.removeModalPopup(u,"planModal"),_(),E()})})}]).controller("EmployeeDetailCtrl",["$interval","$location","$localStorage","$ionicScrollDelegate","$ionicPopup","$ionicHistory","$state","baseUrl","$ionicModal","constants","$ionicPopover","fireRef","$translate","$rootScope","$timeout","$scope","$stateParams","EmployeeService","AnimateMarkerService",function(e,t,o,i,n,a,r,l,s,c,d,p,u,m,g,f,v,h,E){var S,D,y,T,M,I,k,b,C,R,w,O=null,$=null,P=!1;f.markers={};var S,A=new google.maps.DirectionsService,L=new google.maps.DirectionsRenderer({suppressMarkers:!0,preserveViewport:!0});f.map={};var F,N,x;f.isDriver=!0,m.showFooter=!1;var q,z,V,U,G,B,j,H,Y,W,K,Q,Z,J,X,ee,te,oe,ie,ne,U,ae=!0,re={},le=function(){S&&(f.markers[f.employee.apikeypublic]={booked:!0,lat:re.lat,lng:re.lon,zone_id:S},m.setMapMarkers(f.markers),m.map.panTo({lat:re.lat,lng:re.lon})),f.employee.intrip||(maploaded=!0,m.setCircles(h.getzoneMap()[x]))};if(v.employeeId){if(0==h.getCategEmployees().length)return void r.transitionTo("app.employee-dispatcher");x=a.backView().stateParams.employeeId,f.employee=h.findById(v.driverId),S=f.employee.zone_id,re.lat=f.employee.lat,re.lon=f.employee.lng,f.isDriver=!1}else f.employee=m.tappedGroup||m.driverHomeGroup,x=f.employee.category_id,S=h.getBookedZoneId(x),h.queueListenerFunc([f.employee.category_id],!0),re.lat=m.lat,re.lon=m.lon;f.goBack=function(){f.isDriver?r.transitionTo("app.employee-index"):a.goBack()};var se=f.$on("$ionicView.afterEnter",function(e,a){m.setMapClass("detailmap"),le(),f.view_loaded=!0,f.showLargImage=function(e){f.allImages=[{src:e}],f.activeSlide=0,f.showModal("popovers/image-popover.html")},f.showModal=function(e){s.fromTemplateUrl(e,{scope:f,animation:"slide-in-up"}).then(function(e){f.fullSizeImageModal=e,f.fullSizeImageModal.show()})},f.openDetail=function(e){"IMG"===e.target.nodeName||e.target.hasAttribute("contact_number")||(f.isToggled=!f.isToggled)},z=f.$on("accorditemtapped",function(e,o){t.path(o.currentTarget.getAttribute("link"))}),f.tapped=function(e){"A"!=e.target.tagName&&e.currentTarget.getAttribute("link")&&t.path(e.currentTarget.getAttribute("link"))},W=f.$on("location:updated",function(e){f.isDriver&&!h.isViewing("tripModal")&&h.getLocation(m.lat,m.lon).then(function(e){f.employee.location=e,f.markers[window.localStorage.getItem("apikeypublic")]={booked:!0,lat:m.lat,lng:m.lon,zone_id:f.employee.zone_id},m.setMapMarkers(f.markers),m.mapCentered&&m.centerMap()})});var r=!1;f.getOrders=function(){r=!1,f.last_order=null,f.total_today=0,f.total_weektrips=0,h.orders().then(function(e){e.data.forEach(function(e){f.last_order||(f.last_order=Number(e.price));var t=moment.utc(e.created_at,"YYYY-MM-DD HH:mm:ss");t.isSame(moment(),"day")&&(f.total_today+=Number(e.price)),moment(e.created_at).isAfter(moment().startOf("week"))&&f.total_weektrips++}),f.total_today&&(f.total_today=parseFloat(f.total_today).toFixed(1))},function(){r=!0})},V=f.$on("trip:ended",function(){f.$broadcast("location:updated"),f.getOrders(),m.map.panTo({lat:m.lat,lng:m.lon})});var E=function(){P||(P=!0,B=p.child(D.zone_id+"/inbox/"+D.id+"/route"),B.on("value",N))};N=function(e){return null!=e.val()?"rate"==e.val().reply_to_message[Object.keys(e.val().reply_to_message)[Object.keys(e.val().reply_to_message).length-1]].status?void K():void((e.val().status!=O||e.val().eta_distance!=$)&&g(function(){void 0==b&&f.showMap(),f.setDirectionsMap(e.val().status,e.val().eta_distance,e.val())},2e3)):void 0},f.closeModal=function(){f.fullSizeImageModal.hide(),f.fullSizeImageModal.remove()};var y=function(e){e.exists()&&e.val().route.quote_id==f.employee.quote_id&&(S=f.employee.category_id,D=e.val().route,g(function(){f.showMap()}),p.child(f.employee.category_id+"/inbox").off("child_added",y),E()),m.$broadcast("loading:hide")},re=!1;f.setDirectionsMap=function(e,t,o){if(m.map&&!re&&"offer"!=e){O=e,w=new google.maps.LatLng(o.sent_to_message[0].lat,o.sent_to_message[0].lon);var i,n;switch(e){case"offer":i=k,n=new google.maps.LatLng(o.pickup_lat,o.pickup_lon);break;case"accept":i=k,n=new google.maps.LatLng(o.pickup_lat,o.pickup_lon),f.arrivedloadunload="ARRIVED",f.disableArrive=!c.testMode&&h.getGPSDistance(f.employee.lat,f.employee.lon,o.pickup_lat,o.pickup_lon)>c.arriveBtnDisabledMiles;break;case"arrived":i=k,n=new google.maps.LatLng(o.pickup_lat,o.pickup_lon),f.arrivedloadunload="LOAD";break;case"load":i=new google.maps.LatLng(o.pickup_lat,o.pickup_lon),n=new google.maps.LatLng(o.dropoff_lat,o.dropoff_lon),f.arrivedloadunload="UNLOAD",f.disableArrive=!c.testMode&&h.getGPSDistance(f.employee.lat,f.employee.lon,o.dropoff_lat,o.dropoff_lon)>c.arriveBtnDisabledMiles;break;case"unload":i=new google.maps.LatLng(o.pickup_lat,o.pickup_lon),n=new google.maps.LatLng(o.dropoff_lat,o.dropoff_lon),f.unloaded=!0,"receipt"==o.sent_to_message[Object.keys(o.sent_to_message)[Object.keys(o.sent_to_message).length-1]].status?f.initRating():"rate"!=o.sent_to_message[Object.keys(o.sent_to_message)[Object.keys(o.sent_to_message).length-1]].status&&Ee();break;case"receipt":i=new google.maps.LatLng(o.pickup_lat,o.pickup_lon),n=new google.maps.LatLng(o.dropoff_lat,o.dropoff_lon),f.unloaded=!0,"receipt"==o.sent_to_message[Object.keys(o.sent_to_message)[Object.keys(o.sent_to_message).length-1]].status?f.initRating():"rate"!=o.sent_to_message[Object.keys(o.sent_to_message)[Object.keys(o.sent_to_message).length-1]].status&&Ee()}if(m.map.directionsDisplay&&m.map.directionsDisplay.setMap(null),"cancelled"!=e){var a=function(){var e={origin:i,destination:n,travelMode:google.maps.TravelMode.DRIVING};A.route(e,function(e,t){if(t==google.maps.DirectionsStatus.OK){m.setDirections(e),me([new google.maps.LatLng(o.dropoff_lat,o.dropoff_lon),new google.maps.LatLng(o.pickup_lat,o.pickup_lon),k]);for(var i=e.routes[0],n=0;n<i.legs.length;n++){var a=new google.maps.LatLng(o.pickup_lat,o.pickup_lon),r=new google.maps.LatLng(o.dropoff_lat,o.dropoff_lon);void 0!=b&&b.setPosition(a),void 0==C||"arrived"!=o.status&&"load"!=o.status||C.setPosition(r)}me([M,I,k])}})};g(function(){a()},1e3)}}};var se=function(e){try{k=new google.maps.LatLng(e.lat,e.lon),h.getLocation(e.lat,e.lon).then(function(e){f.employee.location=e}),f.employee.intrip||f.receiptModal&&f.ratingModal||m.hasCircles()||!ce||(m.resetMap(),L.setMap(null),m.setCircles(h.getzoneMap()[x])),f.markers[f.employee.apikeypublic]={booked:!0,lat:e.lat,lng:e.lon,zone_id:f.employee.zone_id},m.setMapMarkers(f.markers),m.mapCentered&&!f.employee.intrip&&m.centerMap(e.lat,e.lon),D&&f.setDirectionsMap(D.status,D.eta_distance,D)}catch(t){}},ce=!1,de=function(){var e=h.findById(v.driverId);if(f.employee.location||(F=g(function(){var t={};f.isDriver?(h.queueListenerFunc([f.employee.category_id],!0),t.lat=m.lat,t.lon=m.lon):(t.lat=e.lat,t.lon=e.lng),h.getLocation(t.lat,t.lon).then(function(e){if("app.driver-home"==m.history.currentStateName()||"app.employee-detail"==m.history.currentStateName()){f.employee.location=e;var o=new google.maps.LatLng(t.lat,t.lon);T&&T.setPosition(o),f.centerMap(t.lat,t.lon),g(function(){m.$broadcast("zonemap:updated")},50)}})},300)),f.isDriver){var t=f.employee&&f.employee.location;f.employee=m.tappedGroup||m.driverHomeGroup,f.title=o.name,f.name=f.employee.managerName,o.picData&&(f.employee.pic=o.picData),x=f.employee.category_id,f.last_order||r||f.getOrders(),f.employee.location=f.employee.location||t}else f.employee=e,f.title=e.firstName+" "+e.lastName,f.name=e.managerName;if((""==f.employee.pic||f.employee.pic==l.replace("/api/","/assets/")+"img/markers/transportation/town_car.png")&&(f.employee.pic="img/person.jpg"),f.isDispatcherAdmin=e.apikeypublic==window.localStorage.getItem("apikeypublic")&&e.category_id==e.category_id&&(e.tags.indexOf("Admin")>-1||e.tags.indexOf("Dispatcher")>-1),G||(G=p.child(x+"/queue/"+f.employee.apikeypublic).on("value",function(e){e.exists()?(f.employee.zone_id=e.val().zone_id,f.isDriver||se(e.val())):(f.markers[f.employee.apikeypublic]={booked:!1,lat:f.employee.lat,lng:f.employee.lon,zone_id:f.employee.category_id},m.setMapMarkers(f.markers))})),f.employee.intrip)if(f.employee.apikeypublic==window.localStorage.getItem("apikeypublic"))S=h.getZoneFromQuoteId(f.employee.quote_id),D=h.getInboxData(S,f.employee.quote_id),E();else{var i=p.child(f.employee.category_id+"/inbox");i.on("child_added",y)}else void 0!=b&&(b.setMap(null),b=void 0,C.setMap(null),R.setMap(null),L.setMap(null),P=!1,O=null,m.map.panTo(k))};de(),U=f.$on("firebase:updated",function(e,t){de()});var pe=["DETAIL","DISPATCHER","AVAIL_DRIVERS","OFFICE","CELL","SMS","EMAIL","STATUS","ACTIVE","INACTIVE","ORDERS","HELP","SHARE","REFER"];u(pe).then(function(e){f.accordion={},f.items=[{contact:f.employee.cellPhone,label:e.DISPATCHER,text:f.employee.managerName,icon:"icon ion-person",condition:f.employee.dispatcher<1,link:"#/app/employee-index"},{label:e.ORDERS,text:"",link:"/app/orders/"+f.employee.apikeypublic+"/"+f.employee.category_id,icon:"icon ion-ios-list",condition:!0},{label:e.SHARE,text:"",icon:"icon ion-share",condition:!0},{label:e.HELP,text:"",link:"/app/help",icon:"icon ion-help-circled",condition:!0}],ionic.Platform.isWebView()&&f.items.splice(2,0,{label:e.REFER,text:"",link:"/app/refer",icon:"icon ion-person-add",condition:!0}),f.accordion.heading=e.DETAIL}),f.isDriver||u("NEW_SUBSCRIPTION").then(function(e){Y=function(t){if(t.exists()){var o=t.val();if(o.message==e)return;var i=o.to;if(o.from==f.employee.apikeypublic||o.from==window.localStorage.getItem("apikeypublic")){if("string"==typeof i)(o.from==window.localStorage.getItem("apikeypublic")||i==window.localStorage.getItem("apikeypublic"))&&(f.messageTime=o.time);else for(var n in i)(o.from==window.localStorage.getItem("apikeypublic")||n==window.localStorage.getItem("apikeypublic"))&&(f.messageTime=o.time);j||(j=g(function(){u("MESSAGES").then(function(e){var t={label:e,text:'<span am-time-ago="'+f.messageTime+'"></span>',icon:"icon ion-chatboxes",condition:!0,link:"/app/messages/"+f.employee.apikeypublic+"/"+f.employee.firstName+" "+f.employee.lastName};j=null,f.items.splice(5,0,t)})},2e3))}}},h.getzoneIDs().forEach(function(e,t){H=p.child(e+"/messages"),H.on("child_added",Y)})}),f.centerMap=function(e,t){ae=!0;var o,i;if(f.isDriver)o=m.lat,i=m.lon;else if(o=f.employee.lat,i=f.employee.lng,f.employee.intrip)return void me([new google.maps.LatLng(D.dropoff_lat,D.dropoff_lon),new google.maps.LatLng(D.pickup_lat,D.pickup_lon),new google.maps.LatLng(o,i)]);new google.maps.LatLng(o,i);m.centerMap(o,i)},f.showMap=function(){f.employee.dispatcher>0||g(function(){if(k=new google.maps.LatLng(f.employee.lat,f.employee.lng),f.employee.intrip){new google.maps.LatLng(0,0)}else;({center:k,zoom:14,zoomControlOptions:{position:google.maps.ControlPosition.LEFT_CENTER},panControl:!1,mapTypeControl:!1,mapTypeId:google.maps.MapTypeId.ROADMAP});google.maps.event.addListener(m.map,"dragend",function(){ae=!1}),f.centerMap(f.employee.lat,f.employee.lng);var e={url:l.replace("/api/","/assets/")+"img/markers/transportation/town_car.png",scaledSize:new google.maps.Size(21,34)};if(T=new google.maps.Marker({position:k,icon:e}),f.employee.intrip){M=new google.maps.LatLng(D.pickup_lat,D.pickup_lon),I=new google.maps.LatLng(D.dropoff_lat,D.dropoff_lon),b=new google.maps.Marker({position:M,map:m.map,icon:"img/markerA.png"}),C=new google.maps.Marker({position:I,map:m.map,icon:"img/markerB.png"});var t={path:"M84 341c-21 0 -37 17 -37 38s16 37 37 37s37 -16 37 -37s-16 -38 -37 -38zM121 333c28 0 47 -24 47 -48v-114c0 -22 -32 -22 -32 0v105h-5v-286c0 -28 -41 -31 -43 0v165h-1h-7v-165c-1 -29 -43 -30 -43 0v286h-6v-105c0 -22 -31 -22 -31 0v114c0 24 19 48 47 48h37h37z",fillColor:"#000",fillOpacity:.9,anchor:new google.maps.Point(0,0),strokeWeight:0,scale:.08,rotation:180};R=new google.maps.Marker({position:w,icon:t}),f.setDirectionsMap(D.status,D.eta_distance,D)}m.$broadcast("loading:hide")})};q=f.$on("zonemap:updated",function(){}),f.setCircles=function(){return},K=function(){h.removeModalPopup(f,"messageModal"),h.removeModalPopup(f,"orderModal"),h.removeModalPopup(f,"cancelTripModal"),h.removeModalPopup(f,"popoverDetail"),h.removeModalPopup(f,"seatsModal"),h.removeModalPopup(f,"modalDatePicker"),f.map.map&&f.map.map.directionsDisplay&&f.map.map.directionsDisplay.setMap(null),m.map&&m.map.directionsDisplay&&m.map.directionsDisplay.setMap(null)};var ue=function(e,t){for(var o in t);},me=function(e){for(var t=new google.maps.LatLngBounds,o=0;o<e.length;o++){var i=e[o];t.extend(i)}m.map.fitBounds(t)};f.unloaded=!1,f.footerBtnTap=function(e){if(f.disableArrive)return void("accept"==tripState?u(["SORRY","NOT_AT_PICKUP"]).then(function(e){toastr.error(e.NOT_AT_PICKUP,e.SORRY)}):"load"==tripState&&u(["SORRY","NOT_AT_DROPOFF"]).then(function(e){toastr.error(e.NOT_AT_DROPOFF,e.SORRY)}));switch(e){case"ARRIVED":ge({zone_id:D.zone_id,quote_id:D.id,tripID:D.tripID,msg:"Arrived",status:5},"Arrived");break;case"LOAD":m.$broadcast("loading:show"),ge({zone_id:D.zone_id,quote_id:D.id,tripID:D.tripID,status:6},"Load Trip");break;case"UNLOAD":ge({zone_id:D.zone_id,quote_id:D.id,tripID:D.tripID,status:7},"UnLoad Trip")}};var ge=function(e,t){e.isDriver=D.reply_to!=f.employee.apikeypublic&&8!=e.status,h.trip(e,f.employee).then(function(e){"UnLoad Trip"!=t&&m.$broadcast("loading:hide",!0),"Arrived"==t?f.arrivedloadunload="LOAD":"Load Trip"==t?(f.disableCancelTrip=!0,f.arrivedloadunload="UNLOAD"):"UnLoad Trip"==t?(h.stopTrackingTrip(),
Ee()):"Payment Receipt"==t?f.initRating():"Cancel Trip"==t?(f.cancelTripModal.remove(),f.cancelTripModal=null):"Send Message"==t&&(f.messageModal.remove(),f.messageModal=null,f.cancel={},f.msgNotSelected=!0,f.otherMsgSelected=!0)},function(e){m.$broadcast("loading:hide"),u(["SOMETHING_WRONG","FAILED"]).then(function(e){n.alert({title:e.FAILED,template:e.SOMETHING_WRONG})})})};f.receipt=function(){var e=void 0==f.receiptmsg.other?f.receiptmsg["default"]:f.receiptmsg.other;ge({zone_id:D.zone_id,quote_id:D.id,tripID:D.tripID,msg:e,status:8},"Payment Receipt")},f.sendMessage=function(e){if(f.otherMsgSelected||(e.$submitted=!0),f.otherMsgSelected||e.$valid){var t=f.otherMsgSelected?f.tripmsg["default"]:f.tripmsg.other;ge({zone_id:D.zone_id,quote_id:D.id,tripID:D.tripID,msg:t,status:0},"Send Message")}};var fe=["MESSAGE_DRIVER1","MESSAGE_DRIVER2","MESSAGE_DRIVER3","MESSAGE_DRIVER4","MESSAGE_DRIVER5"];u(fe).then(function(e){f.tripmsgs=[],fe.forEach(function(t,o){f.tripmsgs.push({text:e[t],val:e[t]})})}),f.cancel={};var ve=["MESSAGE_CANCEL_DRIVER1","MESSAGE_CANCEL_DRIVER2","MESSAGE_CANCEL_DRIVER3","MESSAGE_CANCEL_DRIVER4","MESSAGE_CANCEL_DRIVER5","CANCEL_TRIP"];u(ve).then(function(e){f.cancelreasons=[],ve.forEach(function(t,o,i){o<i.length-1&&f.cancelreasons.push({text:e[t],val:e[t]})}),f.cancelTitle=e.CANCEL_TRIP}),s.fromTemplateUrl("modals/order-edit.html",{scope:f}).then(function(e){f.orderModal=e}),f.showOrderModal=function(){f.popoverDetail.hide(),f.editForm=!1,f.orderModal.show()},f.msgNotSelected=!0,f.otherMsgSelected=!0,f.sendMessageModal=function(){f.popoverDetail.hide(),s.fromTemplateUrl("modals/trip-message.html",{zone_id:D.zone_id,quote_id:D.id,tripID:D.tripID,scope:f}).then(function(e){f.messageModal=e,f.tripmsg={},f.msgNotSelected=!0,f.otherMsgSelected=!0,e.show()})},Z=f.$watch("tripmsg.default",function(e,t,o){f.tripmsgs&&e==f.tripmsgs[f.tripmsgs.length-1].text?(f.otherMsgSelected=!1,f.msgNotSelected=!0,i.resize()):void 0!=e&&(f.otherMsgSelected=!0,f.msgNotSelected=!1,i.resize())}),Q=f.$watch("tripmsg.other",function(e,t,o){void 0==e?f.msgNotSelected=!0:""!=e.trim()&&(f.msgNotSelected=!1)}),f.removeMessageModal=function(){f.messageModal.remove(),f.messageModal=null},f.removeCancelModal=function(){f.cancelTripModal.remove(),f.cancelTripModal=null},f.reasonNotSelected=!0,f.otherSelected=!0,f.showCancelTripModal=function(){f.popoverDetail.hide(),s.fromTemplateUrl("modals/trip-cancel.html",{zone_id:D.zone_id,quote_id:D.id,tripID:D.tripID,scope:f}).then(function(e){f.cancel={},f.reasonNotSelected=!0,f.otherSelected=!0,f.cancelTripModal=e,e.show()})},X=f.$watch("cancel.default",function(e,t,o){f.cancelreasons&&e==f.cancelreasons[f.cancelreasons.length-1].text?(f.otherSelected=!1,f.reasonNotSelected=!0,i.resize()):void 0!=e&&(f.otherSelected=!0,f.reasonNotSelected=!1,i.resize())}),J=f.$watch("cancel.other",function(e,t,o){void 0==e?f.reasonNotSelected=!0:""!=e.trim()&&(f.reasonNotSelected=!1)}),f.cancelTap=function(e){if(f.otherSelected||(e.$submitted=!0),f.otherSelected||e.$valid){var t=f.otherSelected?f.cancel["default"]:f.cancel.other;ge({zone_id:D.zone_id,quote_id:D.id,tripID:D.tripID,msg:t,status:-5,inbox:[D]},"Cancel Trip")}};var he=function(){f.receiptModal=!1,f.ratingModal=!0,f.isToggled=!1};f.setRating=function(){f.ratingModal=!0;for(var e=0,t=0;t<f.ratingChkboxes.length;t++)f.ratingChkboxes[t].isChecked&&e++;g(function(){f.rate=e,he()})},f.max=5;var _e=[];f.initRating=function(){if(!f.ratingModal){var e=h.getRating(D.zone_id,D.id);m.$broadcast("loading:hide");var t=["RATE_DRIVER1","RATE_DRIVER2","RATE_DRIVER3","RATE_DRIVER4","RATE_DRIVER5"];u(t).then(function(o){var i=[{"class":"ion-clock",text:o[t[0]],isChecked:e.time,calculated:!0},{"class":"ion-speedometer",text:o[t[1]],isChecked:e.speed,calculated:!0},{"class":"ion-arrow-graph-up-right",text:o[t[2]],isChecked:e.distance,calculated:!0},{"class":"icon-driver",text:o[t[3]],isChecked:!0,calculated:!1},{"class":"ion-waterdrop",text:o[t[4]],isChecked:!0,calculated:!1}];f.ratingChkboxes=i,f.setRating()});var o=["TRIP_INFO","PAYMENT_METHOD","PRICE","PICKUP","DROPOFF","SERVICE","SEATS","ROUTE","DATE_TIME","MILES"];u(o).then(function(e){f.accordion={},f.ratingitems=[{label:e.PAYMENT_METHOD,text:D.paymentMethod},{label:e.PICKUP,text:D.pickup},{label:e.DROPOFF,text:D.dropoff},{label:e.SERVICE,text:D.selectService},{label:e.SEATS,text:D.selectPeople},{label:e.ROUTE,text:D.route_distance+" "+e.MILES},{label:e.DATE_TIME,text:D.selectDate+" "+D.selectTime}],f.accordion.heading=e.TRIP_INFO})}},f.sendRating=function(){m.$broadcast("loading:show");for(var e=0;e<f.ratingChkboxes.length;e++)_e.push("message[]="+(f.ratingChkboxes[e].isChecked?1:0));h.trip({isDriver:!1,zone_id:D.zone_id,quote_id:D.id,tripID:D.tripID,msg:_e,status:9},f.employee).then(function(e){f.ratingModal=!1,m.mapid="quotemap",m.setMapClass("detailmap"),m.$broadcast("loading:hide"),f.isToggled=!1},function(e){m.$broadcast("loading:hide"),u(["SOMETHING_WRONG","FAILED"]).then(function(e){n.alert({title:e.FAILED,template:e.SOMETHING_WRONG})})})},f.receiptNotSelected=!1,f.otherReceiptSelected=!0,te=f.$watch("receiptmsg.default",function(e,t,o){f.receiptmsgs&&e==f.receiptmsgs[f.receiptmsgs.length-1].text?(f.otherReceiptSelected=!1,f.receiptNotSelected=!0,g(function(){var e=_.find(i._instances,function(e){return"scroll"===e.$$delegateHandle});e.scrollBottom()})):void 0!=e&&(f.otherReceiptSelected=!0,f.receiptNotSelected=!1)}),ee=f.$watch("receiptmsg.other",function(e,t,o){void 0==e||""!=e.trim()&&(f.receiptNotSelected=!1)}),f.showTripDetail=function(){if(void 0!=D){var e=["TRIP_INFO","PAYMENT_METHOD","PRICE","PICKUP","DROPOFF","SERVICE","SEATS","ROUTE","DATE_TIME","MILES"];u(e).then(function(e){f.receiptaccordion={},f.receiptitems=[{label:e.PAYMENT_METHOD,text:D.paymentMethod},{label:e.PICKUP,text:D.pickup},{label:e.DROPOFF,text:D.dropoff},{label:e.SERVICE,text:D.selectService},{label:e.SEATS,text:D.selectPeople},{label:e.ROUTE,text:D.route_distance+" "+e.MILES},{label:e.DATE_TIME,text:D.selectDate+" "+D.selectTime}],f.receiptaccordion.heading=e.TRIP_INFO})}},f.showBackBtn=!0;var Ee=function(){if(!f.receiptModal){var e=["RECEIPT_CUSTOMER1","RECEIPT_CUSTOMER2","RECEIPT_CUSTOMER3","RECEIPT_CUSTOMER4","RECEIPT_CUSTOMER5"];u(e).then(function(t){f.receiptmsgs=[],f.receiptmsg={},e.forEach(function(e,o){f.receiptmsgs.push({text:t[e],val:t[e]})}),f.receiptmsg["default"]=f.receiptmsgs[0].val}),null!=f.arrivedModal&&1!=f.arrivedModal&&(f.arrivedModal.remove(),f.arrivedModal=null,h.isRinging()&&h.ringTone()),f.showTripDetail(),f.receiptModal=!0,m.resetMap(),m.mapid="receiptmap",m.setMapClass("tripmapp receiptmap"),m.$broadcast("loading:hide")}};d.fromTemplateUrl("popovers/trip-menu.html",{scope:f}).then(function(e){f.popoverDetail=e}),f.showSendMsg=!1,f.sendTripMessage=function(){m.$broadcast("loading:show"),h.trip({zone_id:D.zone_id,quote_id:D.id,tripID:D.tripID,msg:trip.msg,status:4}).then(function(e){m.$broadcast("loading:hide")})},f.openSeatsModal=function(){if(null!=f.seatsModal)return void f.seatsModal.show();s.fromTemplateUrl("modals/order_seats.html",{scope:f,animation:"slide-in-up",backdropClickToClose:!1}).then(function(e){f.seatsModal=e,e.show()})},h.getTags().then(function(e){f.tags=e.tags,f.$broadcast("queue:updated",ue),m.$broadcast("loading:hide")});var Se={},ue=function(e,t,o){Se={};var i=h.getAllUniqueDrivers();for(var n in i)De(i,n);0==Object.keys(Se).length&&f.$broadcast("nodriver"),void 0!=f.tags&&void 0!=D&&(0==f.services.length&&f.services.push({id:D.selectService,text:D.selectService,"class":"taxicar",checked:!1,icon:"pics/taxi.png"}),Object.keys(Se).length>0&&(f.services=h.setServices(Se,f.tags,f.services)))},De=function(e,t){t!=window.localStorage.getItem("apikeypublic")&&h.getGPSDistance(m.lat,m.lon,e[t].lat,e[t].lon)<c.milesRadius&&""==e[t].quote_id&&(Se[t]=e[t])};oe=f.$on("queue:updated",ue),ie=f.$on("queue:added",ue),ne=f.$on("queue:removed",ue),f.services=[],u("SELECT_SERVICE").then(function(e){f.services_text_single=e}),f.val={single:null,multiple:null},f.setServiceCheckMark=function(){f.services.forEach(function(e){e.id==f.editorder.selectService?e.checked=!0:e.checked=!1})},f.serviceSelected=function(e){f.editorder.selectService=e,f.setServiceCheckMark()},f.saveDateTime=function(e){f.editorder.selectDate=moment(new Date(e)).format("MM/DD/YY"),f.editorder.selectTime=moment(new Date(e)).format("hh:mm a"),f.editorder.time=f.editorder.selectDate+" "+f.editorder.selectTime},f.setCarIcon=function(){f.services.forEach(function(e){f.editorder.selectService==e.id&&(f.serviceImg=e.icon)}),0==f.services.length&&(f.serviceImg="pics/taxi.png")},f.showService=function(e){f.setServiceCheckMark(),m.showFancy(e)};var ye,Te;g(function(){f.employee.intrip&&f.initOrder()},3e3),f.initOrder=function(){f.editorder=D,f.setCarIcon(),f.editorder.time=f.editorder.selectDate+" "+f.editorder.selectTime,ye=f.editorder.pickup,Te=f.editorder.dropoff,f.seatsModel={setFunc:function(e){return angular.isDefined(e)?f.editorder.selectPeople=e:f.editorder.selectPeople}}};var Me;f.edit=function(){Me=angular.copy(f.editorder),f.editForm=!0},f.cancelEdit=function(){f.editorder=Me,f.setCarIcon(),f.editForm=!1},f.orderChanged=function(e){e.hasOwnProperty("pickup")&&(f.editorder.pickup_lat=e.pickup.lat,f.editorder.pickup_lon=e.pickup.lon,f.editorder.pickup=e.pickup.formatted_address),e.hasOwnProperty("dropoff")&&(f.editorder.dropoff_lat=e.dropoff.lat,f.editorder.dropoff_lon=e.dropoff.lon,f.editorder.dropoff=e.dropoff.formatted_address),e.hasOwnProperty("range")&&(f.editorder.range=e.range),e.hasOwnProperty("price")&&(f.editorder.price=e.price),Ie()};var Ie=function(){if(f.editorder.pickup!=ye||f.editorder.dropoff!=Te){ye=f.editorder.pickup,Te=f.editorder.dropoff;var e=new google.maps.LatLng(f.editorder.pickup_lat,f.editorder.pickup_lon),t=new google.maps.LatLng(f.editorder.dropoff_lat,f.editorder.dropoff_lon),o={origin:e,destination:t,travelMode:google.maps.TravelMode.DRIVING};A.route(o,function(e,t){if(t==google.maps.DirectionsStatus.OK)for(var o=e.routes[0],i=0;i<o.legs.length;i++)f.editorder.eta_distance=o.legs[i].distance.value/1609,f.editorder.eta_time=o.legs[i].duration.value/60,f.editorder.route_distance=(o.legs[i].distance.value/1609).toFixed(1)})}};f.save=function(){m.$broadcast("loading:show");var e=p.child(detail.zone_id+"/inbox/"+detail.id+"/route");e.update({selectDate:f.editorder.selectDate,selectTime:f.editorder.selectTime,selectPeople:f.editorder.selectPeople,selectService:f.editorder.selectService,route_distance:f.editorder.route_distance,eta_distance:f.editorder.eta_distance,eta_time:f.editorder.eta_time,pickup:f.editorder.pickup,dropoff:f.editorder.dropoff,pickup_lat:f.editorder.pickup_lat,pickup_lon:f.editorder.pickup_lon,dropoff_lat:f.editorder.dropoff_lat,dropoff_lon:f.editorder.dropoff_lon,price:f.editorder.price,range:f.editorder.range},function(t){if(m.$broadcast("loading:hide"),t)u(["FAILED","ORDER_UPDATE_FAIL"]).then(function(e){n.alert({title:e.FAILED,template:e.ORDER_UPDATE_FAIL})});else{Me=D,f.cancelEdit();var o="reply_to_message",i=D[o],a=parseInt(Object.keys(i)[Object.keys(i).length-1])+1,r=i;r[a]={lat:f.employee.lat,lon:f.employee.lon,update_time:moment().format("MM/DD/YY HH:mm:ss"),status:"order_edited",message:"Order Edited"},e.child(o).set(r,function(e){})}})}});f.$on("$ionicView.beforeLeave",function(){leftView=!0,B&&B.off("value",N),G&&p.child(x+"/queue/"+f.employee.apikeypublic).off("value",G),g.cancel(j),H&&H.off("child_added",Y),W&&W(),q&&q(),z&&z(),V&&V(),Q&&(Q(),Z(),J(),X(),ee(),te()),oe&&(oe(),ie(),ne()),b&&b.setMap(null),C&&C.setMap(null),L&&L.setMap(null),m.resetMap(),oe&&U(),K&&K(),F&&g.cancel(F),se(),y=null})}]).controller("MessagesCtrl",["$timeout","$ionicFilterBar","$localStorage","$state","fireRef","$stateParams","$translate","$rootScope","$scope","EmployeeService",function(e,t,o,n,a,r,l,s,c,d){var p,u;c.$on("$ionicView.afterEnter",function(){var e;c.showFilterBar=function(){var o=$.map(c.messages,function(e,t){return e});e=t.show({items:o,update:function(e,t){for(c.messages={},i=0;i<e.length;i++)c.messages[e[i].to]=e[i]}})},c.messages=[],Array.prototype.inArray=function(e){for(var t=0;t<this.length;t++)if(e(this[t]))return!0;return!1},c.sizeOf=function(e){return Object.keys(e).length},Array.prototype.pushIfNotExist=function(e,t){this.inArray(t)||this.push(e)},c.messages={};var r=function(e,t){var o=e.from==window.localStorage.getItem("apikeypublic")?t:e.from;c.messages.hasOwnProperty(o)||(c.messages[o]={from:e.from_name,time:e.time,to:o}),c.messages[o].time=e.time,e.from!=window.localStorage.getItem("apikeypublic")&&(c.messages[o].from=e.from_name)};c.filtered=function(e){var t={};if(0==e.length)return t;var i=[];return angular.forEach(e,function(e,t){e.from!=o.name&&i.push(e)}),i.sort(function(e,t){return t.time-e.time}),t=i.reduce(function(e,t,o){return e[t.to]=t,e},{})},l("NEW_SUBSCRIPTION").then(function(e){u=function(t){if(t.exists()){var o=t.val();if(o.message==e)return;var i=o.to;if("string"==typeof i)(o.from==window.localStorage.getItem("apikeypublic")||i==window.localStorage.getItem("apikeypublic"))&&r(o,o.to);else for(var n in i)(o.from==window.localStorage.getItem("apikeypublic")||n==window.localStorage.getItem("apikeypublic"))&&r(o,n)}},d.getzoneIDs().forEach(function(e,t){p=a.child(e+"/messages"),p.on("child_added",u)})}),c.messageDetail=function(e,t){n.transitionTo("app.messages-detail",{apikey:e,name:t})},c.$on("$destroy",function(){e&&(e(),e=null),p&&p.off("child_added",u)})})}]).controller("MessagesDetailCtrl",["$ionicPopover","$localStorage","$state","fireRef","$stateParams","$translate","$rootScope","$scope","EmployeeService","$ionicScrollDelegate","$timeout",function(e,t,o,i,n,a,r,l,s,c,d){var p,u;l.messages=[],l.unsortedMessages=[];var m=[];$("#smiley").click(function(t){if(l.popoverEmoji)l.popoverEmoji.show(t);else{l.popoverEmoji=e.fromTemplate(['<ion-popover-view style="width:auto;height: 40px !important;">',"<ion-content>",'<div class="row convert-emoji">','<div class="col-100">',"</div>","</div>","</ion-content>","</ion-popover-view>"].join(""),{scope:l}),l.popoverEmoji.show(t);var o=[":grinning:",":joy:",":yum:",":heart_eyes_cat:",":scream_cat:",":ghost:",":heart:"];$(".convert-emoji").each(function(){var e=this;o.forEach(function(t){var o=$(' <a data-emoji="'+t+'">'+t+"</a>\n");$(e).append(o)});var t=$(this).html(),i=emojione.toImage(t);i=i.replace(/\/\/cdn.jsdelivr.net/g,"https://cdn.jsdelivr.net"),$(this).html(i)}),$(".convert-emoji a").click(function(e){m.push($(this).attr("data-emoji"));var t=m.join(" "),t=$(this).attr("data-emoji");return t=emojione.toImage(t).replace(/\/\/cdn.jsdelivr.net/g,"https://cdn.jsdelivr.net"),$("#msgtxtarea").append(t),l.popoverEmoji.hide(),!1})}});var g=function(){function e(){var e=0;s.getzoneIDs().forEach(function(t,o){i.child(t+"/messages").once("value",function(t){_+=t.numChildren(),e++,e==s.getzoneIDs().length&&l.startListening()})})}function o(){f.one("blur",function(){f[0].focus()})}l.toUser={_id:l.apikey,pic:"img/person.jpg",username:n.name},l.user={_id:window.localStorage.getItem("apikeypublic"),pic:r.picData||"img/person.jpg",username:t.name},l.input={message:""};var m,g,f,v=c.$getByHandle("userMessageScroll");$(".quotelogged").hide(),d(function(){e()}),d(function(){m=document.body.querySelector("#userMessagesView .bar-footer"),g=document.body.querySelector("#userMessagesView .scroll-content"),f=angular.element(m.querySelector("textarea"))},0),l.$on("$ionicView.beforeLeave",function(){$(".quotelogged").show()}),u=function(e){if(h=e.ref().parent().parent().key(),e.exists()){var t=e.val(),o=t.to;if(t.from==l.apikey||t.from==window.localStorage.getItem("apikeypublic")){if("string"==typeof o)l.checkMessage(t,o);else for(var i in o)l.checkMessage(t,i);d(function(){v.scrollBottom()},0)}E++,E==_&&l.sortMessages()}},l.startListening=function(){s.getzoneIDs().forEach(function(e,t){p=i.child(e+"/messages"),p.on("child_added",u)})};var h,_=0,E=0;l.sortMessages=function(){l.unsortedMessages.sort(function(e,t){return e.time-t.time}),l.messages=l.unsortedMessages,r.$broadcast("loading:hide")},l.checkMessage=function(e,t){e.from==l.apikey&&t==window.localStorage.getItem("apikeypublic")?(e.userId=l.apikey,E!=_?l.unsortedMessages.push(e):l.messages.push(e)):e.from==window.localStorage.getItem("apikeypublic")&&t==l.apikey&&(e.userId=window.localStorage.getItem("apikeypublic"),E!=_?l.unsortedMessages.push(e):l.messages.push(e))},l.pushMessage=function(e,t){e.date=new Date(e.time),e.userId=t,l.messages.pushIfNotExist(e,function(t){return t.key===e.key})},Array.prototype.inArray=function(e){for(var t=0;t<this.length;t++)if(e(this[t]))return!0;return!1},Array.prototype.pushIfNotExist=function(e,t){this.inArray(t)||this.push(e)},l.sendChatMessage=function(e){({toId:l.toUser._id,text:l.input.message});o();var n=i.child((l.zone_id||h)+"/messages"),r={};r[l.apikey]="",n.push({to:r,from:window.localStorage.getItem("apikeypublic"),from_name:t.name,message:l.input.message,time:Firebase.ServerValue.TIMESTAMP},function(e){e&&a(["MSG_SENT_FAILURE"]).then(function(e){$ionicPopup.alert({title:e.FAILED,template:e.MSG_SENT_FAILURE})})}),l.input.message="",d(function(){o(),v.scrollBottom(!0)},0)},d(function(){$('form[name="sendMessageForm"] textarea').keyup(function(e){13!=e.keyCode||e.shiftKey||(l.sendChatMessage(),e.stopPropagation())})});var S=l.$on("taResize",function(e,t){if(t){var o=t[0].offsetHeight;if(m){var i=o+10;i=i>44?i:44,m.style.height=i+"px",g.style.bottom=i+"px"}}});l.$on("$destroy",function(){p&&p.off("child_added",u),S&&S(),s.removeModalPopup(l,"popoverEmoji"),$('form[name="sendMessageForm"] textarea').off("keyup")})};l.$on("modal.shown",function(e,t){l.apikey=t.apikey,l.zone_id=t.zone_id,g()});l.$on("$ionicView.afterEnter",function(){l.apikey=n.apikey,r.$broadcast("loading:show"),g()})}]).controller("OrdersCtrl",["$window","$ionicPopover","$timeout","$ionicFilterBar","$localStorage","$state","fireRef","$stateParams","$translate","$rootScope","$scope","EmployeeService",function(e,t,o,i,n,a,r,l,s,c,d,p){d.completed_orders=[],d.orders=[],d.$on("$ionicView.afterEnter",function(){c.$broadcast("loading:show"),o(function(){d.scrollerHeight={height:$(".slider-slide").height()-55+"px"}});var s=d.$on("trip:ended",function(){d.getOrders()});d.apikey=l.apikey,d.group_id=l.groupid;var u=!1,m=d.$on("popover.hidden",function(e,t){u!=t.trip_id&&(u=t.trip_id,d.popoverMap.remove().then(function(){u=!1}))});d.getMap=function(e,o){d.popoverMap=t.fromTemplate(['<style ng-bind-html="popoverStyles"></style><ion-popover-view class="mappop customTrans map-popover">','<ion-content scroll="false">','<div class="smapDiv" id="smapDiv-'+e.trip_id+'"><ion-spinner /></div>',"</ion-content>","</ion-popover-view>"].join(""),{trip_id:e.trip_id,scope:d}),d.popoverMap.show(o),p.tripPath(e.trip_id).then(function(t){"Failed"==t.status?g(null,e):g(t,e)},function(){g(null,e)})};var g=function(t,i){var n=Math.min(+(.7*e.innerWidth).toFixed(0),640),a=Math.min((.7*e.innerHeight).toFixed(0),640);d.popoverStyles=".mappop{min-width: "+n+"px;width: "+n+"px !important;height: "+a+"px !important;min-height: "+a+"px;}.mappop .spinner{width: "+n+"px;height: "+a+"px;}.mappop .spinner svg{width: "+(.3*n).toFixed(0)+"px;height: "+(.3*a).toFixed(0)+"px;}";var r=new google.maps.LatLng(i.pickup_lat,i.pickup_lon),l=new google.maps.LatLng(i.dropoff_lat,i.dropoff_lon),s="",c=[r,l];t&&t.data.forEach(function(e){s+="|"+e.lat+","+e.lon,c.push(new google.maps.LatLng(e.lat,e.lon))});var u=p.getBounds(c),m=p.getBoundsZoomLevel(c,{width:n,height:a}),g="https://maps.googleapis.com/maps/api/staticmap?",f={zoom:m,center:u.getCenter(),size:n+"x"+a,maptype:"roadmap",sensor:!1},v=["markers=icon:http://ride.a2bapp.com/v2/img/markerA.png/|"+i.pickup_lat+","+i.pickup_lon,"markers=icon:http://ride.a2bapp.com/v2/img/markerB.png|"+ +i.dropoff_lat+","+i.dropoff_lon];s.length>0&&v.push("path=color:blue|weight:4"+s),$.each(f,function(e,t){v.push(e+"="+encodeURIComponent(t))}),g+=v.join("&"),o(function(){$("#smapDiv-"+i.trip_id).html('<img src="'+g+'" />')})},f=function(e){var t=e.data.slice(0);t.sort(function(e,t){return t.trip_id-e.trip_id}),t.forEach(function(e){var t=moment.utc(e.created_at).toDate();e.created_at=moment(t).format("MM/DD/YY hh:mm A"),d.group_id&&e.category_id==d.group_id?d.completed_orders.push(e):d.completed_orders.push(e)})};d.getOrders=function(){p.orders().then(function(e){c.$broadcast("loading:hide"),d.ordersfetched=!0,d.group_id&&(d.completed_orders.length=0),f(e)})}();var v;d.showFilterBar=function(){v=i.show({items:d.completedslide?d.completed_orders:d.orders,update:function(e,t){d.filteredItems=e,d.completedslide?d.completed_orders=e:d.orders=e}})},d.completedslide=!1,d.incompslide=!0,d.onSlideMove=function(e){d.completedslide=1==e.index,d.incompslide=0==e.index},d.isDriver=p.isDriver();var h=!0,_=!0;d.toggleOrder=function(e){d.isDriver&&("trip"==e?h=!h:_=!_)},d.isOrderShown=function(e){return"trip"==e?h:_},d.search={},d.search.value="",d.clearSearch=function(){d.search.value=""},d.startsWith=function(e,t){var o=(e+"").toLowerCase();return 0===o.indexOf(t.toLowerCase())},d.formatDate=function(e){return new Date(e)},d.sortType="date",d.reverseSort=!0,d.sortFunc=function(e){return"date"==d.sortType?e.created_at?e.created_at:moment(e.selectDate+" "+e.selectTime,"MM/DD/YYYY HH:mm a"):"pick_dist"==d.sortType?p.getGPSDistance(parseFloat(e.pickup_lat),parseFloat(e.picup_lon),c.lat,c.lon):p.getGPSDistance(parseFloat(e.pickup_lat),parseFloat(e.picup_lon),parseFloat(e.dropoff_lat),parseFloat(e.dropoff_lon))},d.sortBtnClick=function(e){d.sortType==e?d.reverseSort=!d.reverseSort:(d.sortType=e,d.reverseSort=!1)},d.sortBtnClss=function(e){return e==d.sortType&&(d.reverseSort?"button-positive icon-right ion-arrow-up-b":"button-positive icon-right ion-arrow-down-b")};var E="mine",S="customer",D="pending",y="cancelled",T="unchecked",M="unchecked",I="unchecked",k="unchecked";d.filterFunc=function(e){return"checked"==T?e.ordered_by==window.localStorage.getItem("apikeypublic"):"checked"==M?e.sent_to==window.localStorage.getItem("apikeypublic"):"checked"==I?"offer"==e.status:"checked"==k?"cancelled"==e.status:!0},d.filterBtnClick=function(e){switch(e){case E:T="checked"==T?"unchecked":"checked","checked"==M&&(M="unchecked");break;case S:M="checked"==M?"unchecked":"checked","checked"==T&&(T="unchecked");break;case D:I="checked"==I?"unchecked":"checked","checked"==k&&(k="unchecked");break;case y:k="checked"==k?"unchecked":"checked","checked"==I&&(I="unchecked")}},d.filterBtnClss=function(e){switch(e){case E:return"checked"==T?"button-positive icon-right ion-checkmark filterbtns":"filterbtns";case S:return"checked"==M?"button-positive icon-right ion-checkmark filterbtns":"filterbtns";case D:return"checked"==I?"button-positive icon-right ion-checkmark filterbtns":"filterbtns";case y:return"checked"==k?"button-positive icon-right ion-checkmark filterbtns":"filterbtns"}};var b=function(e){if(""!=e.offer_to)for(var t in e.offer_to)if(e.offer_to[t].offer_to==d.apikey)return!0;return!1},C=function(e){d.orders.forEach(function(t,o){t.quote_id==e.route.quote_id&&(d.orders[o]=R(e).route)})},R=function(e){var t=e.route.status,o=e.route,i=o.hasOwnProperty("reply_to_message")?o.reply_to_message[Object.keys(o.reply_to_message)[Object.keys(o.reply_to_message).length-1]].status:"quote",n=o.sent_to_message[Object.keys(o.sent_to_message)[Object.keys(o.sent_to_message).length-1]].status;if(o.reply_to==window.localStorage.getItem("apikeypublic"))var a=n;else if(o.sent_to==window.localStorage.getItem("apikeypublic"))var a=i;return"offer"==t?e.route.order_status="Upcoming":("accept"==t||"arrived"==t||"load"==t||"unload"==t||"receipt"==a)&&(e.route.order_status="In Progress"),e.route.time=moment(e.route.selectDate+" "+e.route.selectTime,"MM/DD/YYYY HH:mm:ss").format("MM/DD/YY HH:mm a"),e},w=[],O=[],P=function(e){if("object"==typeof d.orders&&C(e),w.indexOf(e.route.quote_id)<0&&"cancelled"!=e.route.status&&(p.isDispatcherAdmin(e.route.zone_id)||e.route.sent_to==window.localStorage.getItem("apikeypublic")||e.route.ordered_by==n.uuid||e.route.ordered_by==d.apikey||e.route.sent_to==d.apikey||b(e))){var e=R(e);O.push(e.route),w.push(e.route.quote_id)}c.$broadcast("loading:hide"),d.orders=O},A=function(){var e=p.getFBData();for(var t in e)for(var o in e[t])P(e[t][o])};d.choice={};var L,F,N,x=function(e){e.exists()&&e.forEach(function(e){P(e.val())}),c.$broadcast("loading:hide")};d.group_id?(N=r.child(d.group_id+"/inbox"),N.on("value",x)):(L=d.$on("inbox:updated",function(){A()}),F=d.$on("inbox:removed",function(e,t){var o=-1;d.orders.forEach(function(e,i){(e.id=t.id)&&(o=i)}),o>-1&&d.orders.splice(o,1)})),d.orderDetail=function(e){c.tripModal?(c.detail=e,c.detail.isCustomer=e.reply_to==window.localStorage.getItem("apikeypublic"),c.detail.isDriver=!c.detail.isCustomer,n.tripDetail=c.detail,a.transitionTo("app.trip-detail")):void 0==d.group_id?a.transitionTo("app.orders-detail",{orderId:e.quote_id}):a.transitionTo("app.employee-orderdetail",{orderId:e.quote_id,zone_id:e.zone_id,inbox_id:e.id})},A(),d.$on("$destroy",function(){L&&L(),F&&F(),N&&N.off("value",x),v&&(v(),v=null),s&&s(),m&&m(),p.removeModalPopup(d,"popoverMap")})})}]).controller("OrdersDetailCtrl",["$ionicScrollDelegate","$localStorage","baseUrl","$interval","constants","toastr","$ionicPopover","$timeout","$state","$translate","$ionicPopup","$ionicModal","fireRef","$stateParams","$translate","$rootScope","$scope","EmployeeService",function(e,t,o,i,n,a,r,l,s,c,d,p,u,m,c,g,f,v){f.map={},f.$on("$ionicView.afterEnter",function(){g.setMapClass("ordermap"),f.editForm=!1,f.order={};var n,h,E=function(t){f.editForm=t,f.popoverMenu.hide(),t?(f.contentCls="has-subheader",g.mapclass=null):(f.contentCls="",g.setMapClass("ordermap")),e.resize(),e.scrollTop()};f.edit=function(){n=angular.copy(f.order),E(!0)},f.cancelEdit=function(){f.services.length=0,k.length=0,f.order.selectService=A[0].selectService,M(),f.order=n,f.setCarIcon(),E(!1)},f.changed=function(e){e.hasOwnProperty("pickup")&&(f.order.pickup_lat=e.pickup.lat,f.order.pickup_lon=e.pickup.lon,f.order.pickup=e.pickup.formatted_address),e.hasOwnProperty("dropoff")&&(f.order.dropoff_lat=e.dropoff.lat,f.order.dropoff_lon=e.dropoff.lon,f.order.dropoff=e.dropoff.formatted_address),e.hasOwnProperty("range")&&e.range&&(f.order.range=e.range),e.hasOwnProperty("price")&&(f.order.price=e.price),v.getTimeZone(e.pickup.lat,e.pickup.lon).then(function(e){f.order.timezone=e.timeZoneId}),Q()},f.seatsModal=null,f.openSeatsModal=function(){if(null!=f.seatsModal)return void f.seatsModal.show();p.fromTemplateUrl("modals/order_seats.html",{scope:f,animation:"slide-in-up",backdropClickToClose:!1}).then(function(e){f.seatsModal=e,e.show()})},f.openSeats=function(){l(function(){$(".ordericons").siblings("div[is-icon]").children(".ion-person-add").click()})};var S=!1,D={},y={},T=f.$on("location:searched",function(e,t){y=t.pickup,S=!0,f.setTag()}),M=function(){v.getTags().then(function(e){g.$broadcast("loading:hide"),f.tags=e.tags;var t=v.getUniqueDrivers();originLoc="pickup"==h?y:g;var o={};o[f.order.sent_to]=f.order;for(var i in t)for(var n in t[i]){var a={};a[i]=t[i][n],v.setTagMap("updated",a,originLoc,f.services,k,f.order.selectService,function(e,t,o){f.setTagMap(e,t,o)},!1,void 0,o)}})},I={};I[f.order]=f.order,f.serviceSelected=function(e){v.getUniqueDrivers();originLoc="pickup"==h?y:g},f.setTag=function(){var e=v.setTag(y,f.order.selectService,m.employeeId,I);e>0?(D=y,g.$broadcast("search:location",D)):(C=!1,c(["SORRY","NO_DRIVERS_PICKUP"]).then(function(e){S&&(a.error(e.NO_DRIVERS_PICKUP,e.SORRY),g.$broadcast("search:location",null),S=!1)}),h=null)};var k=[];f.totalDrivers=0,f.setTagMap=function(e,t,o){return f.services=t,o.length>0&&0!=f.services.length&&o.indexOf(I)<0&&c(["SERVICE_REMOVED","SERVICES_NOT_AVAILABLE","SERVICE_NOT_AVAILABLE"]).then(function(e){var t=o+(o.length>1?e.SERVICES_NOT_AVAILABLE:e.SERVICE_NOT_AVAILABLE);a.info(t,e.SERVICE_REMOVED),l(function(){$("#serviceIcon ion-item").click()})}),f.totalDrivers=e,S&&(g.$broadcast("search:location",D),S=!1),!0};var b=function(e,t,o){originLoc="pickup"==h?y:g,null!=t&&v.setTagMap(o,t,originLoc,f.services,k,f.order.selectService,function(e,t,o){f.setTagMap(e,t,o)},!1)},C=!1;f.services=[],c("SELECT_SERVICE").then(function(e){f.services_text_single=e}),f.val={single:null,multiple:null},f.setServiceCheckMark=function(){f.services.forEach(function(e){e.id==f.order.selectService?e.checked=!0:e.checked=!1})},f.saveDateTime=function(e){f.order.selectDate=moment(new Date(e)).format("MM/DD/YY"),f.order.selectTime=moment(new Date(e)).format("hh:mm a"),f.order.time=f.order.selectDate+" "+f.order.selectTime},r.fromTemplateUrl("popovers/order-menu.html",{scope:f}).then(function(e){f.popoverMenu=e}),f.setCarIcon=function(){f.services.forEach(function(e){f.order.selectService==e.id&&(f.serviceImg=e.icon)}),0==f.services.length&&(f.serviceImg="pics/taxi.png")},g.$broadcast("loading:show");var R,w,O,P=function(){g.$broadcast("loading:hide"),f.order=A[0],f.isDispatcherAdmin=v.isDispatcherAdmin(f.order.zone_id)||!1,f.order.time=f.order.selectDate+" "+f.order.selectTime,f.order.splitFare=["splitFare[]="],f.setCarIcon(),f.setServiceCheckMark(),f.editable="receipt"!=A[0].status&&"unload"!=A[0].status&&"rate"!=A[0].status&&"cancelled"!=A[0].status&&"ordercancelled"!=A[0].status;var e=A[0].status;"offer"==e?f.order.order_status="Pending":"accept"==e||"arrived"==e||"load"==e||"unload"==e||"rate"==e||"receipt"==e?f.order.order_status="In Progress":"ordercancelled"==e?f.order.order_status="Order Cancelled":"cancelled"==e&&(f.order.order_status="Trip Cancelled"),f.contentCls=f.editable&&f.editForm?"has-subheader":"",void 0==z&&f.showMap(),pe(),w=f.$on("queue:updated",b),O=f.$on("queue:added",b),R=f.$on("queue:removed",b),M()};f.orderId=m.orderId,f.zone_id=m.zone_id,f.inbox_id=m.inbox_id;var A=[],L=f.order.pickup,F=f.order.dropoff;f.showService=function(e){l(function(){$("#servicespanel ion-item").click()})},f.removeCancelModal=function(){g.cancelTripModal.remove(),g.cancelTripModal=null},f.cancelTap=function(e){if(f.otherSelected||(e.$submitted=!0),f.otherSelected||e.$valid){var t=f.otherSelected?f.cancel["default"]:f.cancel.other,o=A[0],i={zone_id:o.zone_id,quote_id:o.id,tripID:o.tripID,msg:t,status:-5,inbox:[g.detail],isDriver:g.detail.isDriver};g.$broadcast("loading:show"),v.trip(i).then(function(e){g.$broadcast("loading:hide"),v.removeModalPopup(g,"cancelTripModal"),v.endTrip(),s.transitionTo("app.orders")},function(e){g.$broadcast("loading:hide"),c(["SOMETHING_WRONG","FAILED"]).then(function(e){d.alert({title:e.FAILED,template:e.SOMETHING_WRONG})})})}};var N=f.$watch("cancel.default",function(t,o,i){f.cancelreasons&&t==f.cancelreasons[f.cancelreasons.length-1].text?(f.otherSelected=!1,f.reasonNotSelected=!0,e.resize()):void 0!=t&&(f.otherSelected=!0,f.reasonNotSelected=!1,e.resize())});if(f.cancel={},g.detail&&!g.detail.isCustomer)var x=["MESSAGE_CANCEL_DRIVER1","MESSAGE_CANCEL_DRIVER2","MESSAGE_CANCEL_DRIVER3","MESSAGE_CANCEL_DRIVER4","MESSAGE_CANCEL_DRIVER5","CANCEL_TRIP"];else var x=["MESSAGE_CANCEL_CUSTOMER1","MESSAGE_CANCEL_CUSTOMER2","MESSAGE_CANCEL_CUSTOMER3","MESSAGE_CANCEL_CUSTOMER4","MESSAGE_CANCEL_CUSTOMER5","CANCEL_TRIP"];c(x).then(function(e){f.cancelreasons=[],x.forEach(function(t,o,i){o<i.length-1&&f.cancelreasons.push({text:e[t],val:e[t]})}),f.cancelTitle=e.CANCEL_TRIP}),f["delete"]=function(){f.popoverMenu.hide();var e=A[0];return g.detail&&g.detail.id==e.id?void p.fromTemplateUrl("modals/trip-cancel.html",{zone_id:g.detail.zone_id,quote_id:g.detail.id,tripID:g.detail.tripID,scope:f}).then(function(e){f.cancel={},f.reasonNotSelected=!0,f.otherSelected=!0,g.cancelTripModal=e,e.show()}):void c(["YES","NO","CANCEL_ORDER","CONFIRM_DELETE"]).then(function(e){d.confirm({title:e.CANCEL_ORDER,template:e.CONFIRM_DELETE,cssClass:"logoutAlert",buttons:[{text:e.NO},{text:e.YES,type:"button-positive",onTap:function(e){f.deleteOrder()}}]})})};var q=function(e){g.$broadcast("loading:hide"),
e&&c(["FAILED","ORDER_UPDATE_FAIL"]).then(function(e){d.alert({title:e.FAILED,template:e.ORDER_UPDATE_FAIL})})};f.deleteOrder=function(){g.$broadcast("loading:show"),A.forEach(function(e,o,i){var n=u.child(e.zone_id+"/inbox/"+e.id+"/route");"object"!=typeof e.sent_to&&e.reply_to!=window.localStorage.getItem("apikeypublic")?n.update({status:"ordercancelled_"+t.name},q):n.parent().remove(q)})},f.save=function(e){g.$broadcast("loading:show"),v.setQuoteDateTime(f.order),A.forEach(function(e,t,o){var i=u.child(e.zone_id+"/inbox/"+e.id+"/route");i.update({selectDate:f.order.selectDate,selectTime:f.order.selectTime,selectPeople:f.order.selectPeople,selectService:f.order.selectService,route_distance:f.order.route_distance,eta_distance:f.order.eta_distance,eta_time:f.order.eta_time,pickup:f.order.pickup,dropoff:f.order.dropoff,pickup_lat:f.order.pickup_lat,pickup_lon:f.order.pickup_lon,dropoff_lat:f.order.dropoff_lat,dropoff_lon:f.order.dropoff_lon,price:f.order.price,range:f.order.range},function(e){g.$broadcast("loading:hide"),e?c(["FAILED","ORDER_UPDATE_FAIL"]).then(function(e){d.alert({title:e.FAILED,template:e.ORDER_UPDATE_FAIL})}):(n=f.order,f.cancelEdit())})})};var z,V,U,G,B,j,H,Y,W,K=new google.maps.DirectionsService,Q=function(){if(f.order.pickup!=L||f.order.dropoff!=F){L=f.order.pickup,F=f.order.dropoff;var e=new google.maps.LatLng(f.order.pickup_lat,f.order.pickup_lon),t=new google.maps.LatLng(f.order.dropoff_lat,f.order.dropoff_lon),o={origin:e,destination:t,travelMode:google.maps.TravelMode.DRIVING};K.route(o,function(e,t){if(t==google.maps.DirectionsStatus.OK)for(var o=e.routes[0],i=0;i<o.legs.length;i++)f.order.eta_distance=o.legs[i].distance.value/1609,f.order.eta_time=o.legs[i].duration.value/60,f.order.route_distance=(o.legs[i].distance.value/1609).toFixed(1)})}},Z=null,J=null,X=!1,K=new google.maps.DirectionsService,ee=new google.maps.DirectionsRenderer({suppressMarkers:!0,preserveViewport:!0});f.showMap=function(){l(function(){if(Array.isArray(f.order.reply_to_message)&&f.order.reply_to_message.length>1){var e=f.order.reply_to_message;for(var t in e)"message"==e[t].status&&"Trip Cancelled"==e[t].message&&(B=new google.maps.LatLng(e[t].lat,e[t].lon))}void 0==B&&(B=void 0==f.order.reply_to_message?new google.maps.LatLng(g.lat,g.lon):new google.maps.LatLng(f.order.reply_to_message[0].lat,f.order.reply_to_message[0].lon));({center:B,zoom:14,zoomControlOptions:{position:google.maps.ControlPosition.LEFT_CENTER},panControl:!1,mapTypeControl:!1,mapTypeId:google.maps.MapTypeId.ROADMAP});z=!0;var i=o.replace("/api/","/assets/")+"img/markers/transportation/town_car.png",n={url:i,scaledSize:new google.maps.Size(21,34)};U=new google.maps.LatLng(f.order.pickup_lat,f.order.pickup_lon),G=new google.maps.LatLng(f.order.dropoff_lat,f.order.dropoff_lon),j=new google.maps.Marker({position:U,map:g.map,icon:"img/markerA.png"}),H=new google.maps.Marker({position:G,map:g.map,icon:"img/markerB.png"});var a={path:"M84 341c-21 0 -37 17 -37 38s16 37 37 37s37 -16 37 -37s-16 -38 -37 -38zM121 333c28 0 47 -24 47 -48v-114c0 -22 -32 -22 -32 0v105h-5v-286c0 -28 -41 -31 -43 0v165h-1h-7v-165c-1 -29 -43 -30 -43 0v286h-6v-105c0 -22 -31 -22 -31 0v114c0 24 19 48 47 48h37h37z",fillColor:"#000",fillOpacity:.9,anchor:new google.maps.Point(0,0),strokeWeight:0,scale:.08,rotation:180};Y=new google.maps.Marker({position:W,map:g.map,icon:a}),"quote"!=f.order.status?(V=new google.maps.Marker({position:B,map:g.map,icon:n}),f.setDirectionsMap(f.order.status,f.order.eta_distance)):ge([new google.maps.LatLng(f.order.dropoff_lat,f.order.dropoff_lon),new google.maps.LatLng(f.order.pickup_lat,f.order.pickup_lon)])})};var te=function(e){if(!g.receiptModal){if(g.receiptModal=!0,le)var t=["RECEIPT_DRIVER1","RECEIPT_DRIVER2","RECEIPT_DRIVER3","RECEIPT_DRIVER4","RECEIPT_DRIVER5"];else var t=["RECEIPT_CUSTOMER1","RECEIPT_CUSTOMER2","RECEIPT_CUSTOMER3","RECEIPT_CUSTOMER4","RECEIPT_CUSTOMER5"];c(t).then(function(e){f.receiptmsgs=[],f.receiptmsg={},t.forEach(function(t,o){f.receiptmsgs.push({text:e[t],val:e[t],checked:!1})}),f.receiptmsg["default"]=f.receiptmsgs[0].val}),p.fromTemplateUrl("modals/receipt.html",{zone_id:e.zone_id,quote_id:e.id,tripID:e.tripID,backdropClickToClose:!1,hardwareBackButtonClose:!1,scope:f}).then(function(t){g.$broadcast("loading:hide"),g.receiptModal=t,t.show(),f.showReceiptDetail(e)})}};f.showReceiptDetail=function(e){var t=["TRIP_INFO","PAYMENT_METHOD","PRICE","PICKUP","DROPOFF","SERVICE","SEATS","ROUTE","DATE_TIME","MILES"];c(t).then(function(t){f.accordion={},f.items=[{label:t.PAYMENT_METHOD,text:e.paymentMethod},{label:t.PICKUP,text:e.pickup},{label:t.DROPOFF,text:e.dropoff},{label:t.SERVICE,text:e.selectService},{label:t.SEATS,text:e.selectPeople},{label:t.ROUTE,text:e.route_distance+" "+t.MILES},{label:t.DATE_TIME,text:e.selectDate+" "+e.selectTime}],f.accordion.heading=t.TRIP_INFO})},f.showBackBtn=!0;var oe=function(e){p.fromTemplateUrl("modals/order-rating.html",{zone_id:e.zone_id,quote_id:e.id,tripID:e.tripID,isDriver:le,isCustomer:re,reply_to:e.reply_to,sent_to:e.sent_to,backdropClickToClose:!1,scope:f}).then(function(t){void 0!=g.ratingModal&&null!=g.ratingModal&&g.ratingModal.isShown()||(g.ratingModal=t,t.show(),se(),v.profile(e.sent_to).then(function(e){f.name=e.description}))})},ie=function(e,t){e.isDriver=!1,g.showLoader=!0,v.trip(e).then(function(e){g.$broadcast("loading:hide"),f.hideReceiptModal()},function(e){g.$broadcast("loading:hide"),c(["SOMETHING_WRONG","FAILED"]).then(function(e){d.alert({title:e.FAILED,template:e.SOMETHING_WRONG})})})};f.receiptNotSelected=!1,f.otherReceiptSelected=!0,f.receiptChecked=function(t,o){t==f.receiptmsgs.length-1&&(o?(f.otherReceiptSelected=!1,l(function(){var t=_.find(e._instances,function(e){return"scroll"===e.$$delegateHandle});t.scrollBottom()}),e.resize()):(f.otherReceiptSelected=!0,e.resize()))},f.receipt=function(){var e=f.order,t=[],o=0;f.receiptmsgs.forEach(function(e,i){e.checked&&(o++,i==f.receiptmsgs.length-1?!f.otherReceiptSelected&&f.receiptmsg.other&&t.push(o+". "+f.receiptmsg.other):t.push(o+". "+e.text))}),t=t.join(" "),0!=t.length&&ie({zone_id:e.zone_id,quote_id:e.id,tripID:e.tripID,msg:t,status:8},"Payment Receipt")},f.hideReceiptModal=function(){oe(f.order),v.removeModalPopup(g,"receiptModal")},f.setRating=function(){for(var e=0,t=0;t<f.ratingChkboxes.length;t++)f.ratingChkboxes[t].isChecked&&e++;l(function(){f.rate=e})},f.max=5;var ne=null,ae=[],re=!0,le=!1,se=function(){if(ne=v.getRating(f.order.zone_id,f.order.id),g.$broadcast("loading:hide"),le)var e=["RATE_CUSTOMER1","RATE_CUSTOMER2","RATE_CUSTOMER3","RATE_CUSTOMER4","RATE_CUSTOMER5"];else var e=["RATE_DRIVER1","RATE_DRIVER2","RATE_DRIVER3","RATE_DRIVER4","RATE_DRIVER5"];var e=["RATE_DRIVER1","RATE_DRIVER2","RATE_DRIVER3","RATE_DRIVER4","RATE_DRIVER5"];c(e).then(function(t){var o=[{"class":"ion-clock",text:t[e[0]],isChecked:re?ne.time:!0,calculated:re},{"class":re?"ion-speedometer":"icon-pick",text:t[e[1]],isChecked:re?!0:!0,calculated:re},{"class":re?"ion-arrow-graph-up-right":"icon-drop",text:t[e[2]],isChecked:re?!0:!0,calculated:re},{"class":re?"icon-driver":"ion-ios-locked",text:t[e[3]],isChecked:!0,calculated:!1},{"class":re?"ion-waterdrop":"ion-thumbsup",text:t[e[4]],isChecked:!0,calculated:!1}];f.ratingChkboxes=o,f.setRating()})};f.sendRating=function(){g.$broadcast("loading:show");for(var e=0;e<f.ratingChkboxes.length;e++)ae.push("message[]="+(f.ratingChkboxes[e].isChecked?1:0));v.trip({isDriver:le,zone_id:f.order.zone_id,quote_id:f.order.id,tripID:f.order.tripID,msg:ae,status:9}).then(function(e){v.removeModalPopup(g,"ratingModal"),a.clear(),g.$broadcast("loading:hide")},function(e){g.$broadcast("loading:hide"),c(["SOMETHING_WRONG","FAILED"]).then(function(e){d.alert({title:e.FAILED,template:e.SOMETHING_WRONG})})})};var ce,de,pe=function(){X||(X=!0,ce=u.child(A[0].zone_id+"/inbox/"+A[0].id+"/route").on("value",function(e){if(e.exists()){le=e.val().sent_to==window.localStorage.getItem("apikeypublic");var t=e.val().hasOwnProperty("reply_to_message")?e.val().reply_to_message[Object.keys(e.val().reply_to_message)[Object.keys(e.val().reply_to_message).length-1]].status:"quote",o=e.val().sent_to_message[Object.keys(e.val().sent_to_message)[Object.keys(e.val().sent_to_message).length-1]].status;if(le&&"unload"==t||v.isDispatcherAdmin(e.val().zone_id)&&("unload"==e.val().status||"receipt"==e.val().status||"rate"==e.val().status)&&"receipt"!=o&&"rate"!=o)return void te(e.val());if(le&&"receipt"==t||v.isDispatcherAdmin(e.val().zone_id)&&("unload"==e.val().status||"receipt"==e.val().status||"rate"==e.val().status)&&("receipt"==o||void 0==o))return void f.hideReceiptModal();if("rating"==o&&v.removeModalPopup(g,"ratingModal"),"receipt"==e.val().status||"rate"==e.val().status)return;(e.val().status!=Z||e.val().eta_distance!=J)&&l(function(){A[0]=e.val(),void 0==j&&f.showMap(),f.setDirectionsMap(A[0].status,A[0].eta_distance)},2e3)}else s.transitionTo("app.orders",{apikey:window.localStorage.getItem("apikeypublic")})}))};if(void 0==f.zone_id)var ue=i(function(){A=v.getInboxesByQuoteId(f.orderId),void 0!=A&&A.length>0&&(i.cancel(ue),P())},2e3);else de=u.child(f.zone_id+"/inbox/"+f.inbox_id+"/route").on("value",function(e){e.exists()&&(A.push(e.val()),P())});var me=f.$on("firebase:updated",function(e,t){P()}),ge=function(e){for(var t=new google.maps.LatLngBounds,o=0;o<e.length;o++){var i=e[o];t.extend(i)}g.map.fitBounds(t)};f.setDirectionsMap=function(e,t){if(!(void 0==z||e.indexOf("ordercancelled_")>-1||"quote"==e||Z==e&&J==t)){Z=e,J=t,W=new google.maps.LatLng(f.order.sent_to_message[0].lat,f.order.sent_to_message[0].lon);var o,i;switch(e){case"quote":o=B,i=new google.maps.LatLng(f.order.pickup_lat,f.order.pickup_lon);break;case"offer":o=B,i=new google.maps.LatLng(f.order.pickup_lat,f.order.pickup_lon);break;case"accept":o=B,i=new google.maps.LatLng(f.order.pickup_lat,f.order.pickup_lon);break;case"arrived":o=B,i=new google.maps.LatLng(f.order.pickup_lat,f.order.pickup_lon);break;case"load":o=new google.maps.LatLng(f.order.pickup_lat,f.order.pickup_lon),i=new google.maps.LatLng(f.order.dropoff_lat,f.order.dropoff_lon);break;case"unload":o=new google.maps.LatLng(f.order.pickup_lat,f.order.pickup_lon),i=new google.maps.LatLng(f.order.dropoff_lat,f.order.dropoff_lon);break;case"receipt":o=new google.maps.LatLng(f.order.pickup_lat,f.order.pickup_lon),i=new google.maps.LatLng(f.order.dropoff_lat,f.order.dropoff_lon);break;case"rate":o=new google.maps.LatLng(f.order.pickup_lat,f.order.pickup_lon),i=new google.maps.LatLng(f.order.dropoff_lat,f.order.dropoff_lon);break;case"cancelled":o=new google.maps.LatLng(f.order.pickup_lat,f.order.pickup_lon),i=new google.maps.LatLng(f.order.dropoff_lat,f.order.dropoff_lon);break;case"ordercancelled":o=new google.maps.LatLng(f.order.pickup_lat,f.order.pickup_lon),i=new google.maps.LatLng(f.order.dropoff_lat,f.order.dropoff_lon);break;case"tripcancelled":o=new google.maps.LatLng(f.order.pickup_lat,f.order.pickup_lon),i=new google.maps.LatLng(f.order.dropoff_lat,f.order.dropoff_lon)}g.map.directionsDisplay&&g.map.directionsDisplay.setMap(null);var n=function(){var e={origin:o,destination:i,travelMode:google.maps.TravelMode.DRIVING};K.route(e,function(e,t){if(t==google.maps.DirectionsStatus.OK){ee.setDirections(e),ge([new google.maps.LatLng(f.order.dropoff_lat,f.order.dropoff_lon),new google.maps.LatLng(f.order.pickup_lat,f.order.pickup_lon),B]);for(var o=e.routes[0],i=0;i<o.legs.length;i++){var n=new google.maps.LatLng(f.order.pickup_lat,f.order.pickup_lon),a=new google.maps.LatLng(f.order.dropoff_lat,f.order.dropoff_lon);void 0!=j&&j.setPosition(n),void 0==H||"arrived"!=f.order.status&&"load"!=f.order.status||H.setPosition(a)}ee.setMap(g.map)}})};n()}};f.$on("$ionicView.beforeLeave",function(){w&&w(),O&&O(),R&&R(),me&&me(),T&&T(),j.setMap(null),H.setMap(null),V&&V.setMap(null),ee&&ee.setMap(null),de&&u.child(f.zone_id+"/inbox/"+f.inbox_id+"/route").off("value",de),ce&&u.child(A[0].zone_id+"/inbox/"+A[0].id+"/route").off("value",ce),v.removeModalPopup(g,"receiptModal"),v.removeModalPopup(g,"ratingModal"),v.removeModalPopup(f,"seatsModal"),v.removeModalPopup(f,"popoverMenu"),N&&N(),g.resetMap()})})}]).controller("DispatcherFormCtrl",["$q","$ionicHistory","$stateParams","toastr","fireRef","$ionicPopup","$localStorage","$ionicModal","$translate","$timeout","$rootScope","$scope","EmployeeService",function(e,t,o,i,n,a,r,l,s,c,d,p,u){var m=this;m.dispatcherForm=null,p.$on("$ionicView.afterEnter",function(e,l){p.formType=o.type,p.empl=o.obj,p.empl.active=parseInt(p.empl.active),p.empl.oldItems=[],p.dispatcherformTitle=o.type.toUpperCase(),p.isOwner=!0;var g=[{id:"Admin",text:"Admin",checked:!1,disabled:!1},{id:"Customer",text:"Customer",checked:!1,disabled:!1},{id:"Dispatcher",text:"Dispatcher",checked:!1,disabled:!1},{id:"Driver",text:"Driver",checked:!1,disabled:!1}],f=function(){p.items=[];var e,t={Admin:0,Customer:0,Dispatcher:0,Driver:0};"edit"==p.formType&&p.empl.items.forEach(function(e){delete t[e]}),u.getEmployees().forEach(function(o){o.category_id==p.empl.category_id&&(o.hasOwnProperty("can_bookin")?(e=o.limits,""==o.tags?p.items=g:g.forEach(function(e){o.tags.indexOf(e.text)>-1&&p.items.push(e)})):o.tags.forEach(function(e){t.hasOwnProperty(e)&&t[e]++}))}),p.items.forEach(function(o){t.hasOwnProperty(o.text)&&(o.disabled=t[o.text]>=e[o.text.toLowerCase()])})},v=function(e){p.services=e.map(function(e){return{id:e,text:e,checked:!1}}),void 0!=p.empl.tags&&(p.empl.items=p.empl.tags.filter(function(t){return e.indexOf(t)<0}),p.empl.services=p.empl.tags.filter(function(t){return e.indexOf(t)>-1})),void 0==p.empl.items&&(p.empl.items=[]),void 0==p.empl.services&&(p.empl.services=[]),p.empl.item="",p.empl.itemType="",p.empl.service="",p.empl.serviceType="",p.empl.items.length>0&&(p.empl.item=p.empl.items.join(", "),p.empl.itemType=p.empl.items.join("&itemType[]="),p.empl.oldItems=p.empl.items.slice(0)),p.empl.services.length>0&&(p.empl.oldItems=p.empl.oldItems.concat(p.empl.services),p.empl.service=p.empl.services.join(", "),p.empl.serviceType=p.empl.services.join("&itemType[]=")),f()};u.getTags().then(function(e){v(e.tags)}),v(d.tags),u.getAllEmployees(),p.alreadyExists=function(e){if(0==u.getAllStoredEmployees().length||void 0==p.empl||"edit"==p.formType)return!0;for(var t=u.getAllStoredEmployees(),o=!1,i=0;i<t.length;i++)if(t[i].category_id==p.empl.category_id&&!t[i].hasOwnProperty("can_bookin")&&t[i].email==e){o=!0;break}return!o},p.emailExists=!1,p.validatingEmail=!1;var h;p.emailChanged=function(){p.isOwner=p.empl.email==r.email,m.dispatcherForm.email.$invalid?(p.emailExists=!1,p.validatingEmail=!1,h&&c.cancel(h)):(h&&c.cancel(h),h=c(function(){p.validatingEmail=!0,u.profile(null,p.empl.email).then(function(e){m.dispatcherForm.email.$invalid||(p.emailExists="Failed"!=e.status)},function(){})["finally"](function(){p.validatingEmail=!1})},500))},p.saveEmployee=function(){if(m.dispatcherForm.$submitted=!0,m.dispatcherForm.$valid){d.$broadcast("loading:show");var e=!1;u.findAllEmployees().then(function(t){return t.items.every(function(t){return t.dispatcher<1&&t.apikeypublic==window.localStorage.getItem("apikeypublic")&&t.overdue?(t.overdue.user<0&&(e=t.overdue.user),!1):!0}),e?(d.$broadcast("loading:hide"),void s(["SORRY","APP_OVERDUE1","APP_OVERDUE2"]).then(function(t){var o=a.alert({title:t.SORRY,template:t.APP_OVERDUE1+Math.abs(e)+t.APP_OVERDUE2});o.then(function(e){$state.transitionTo("app.employee-index")})})):void p.save()})}},p.save=function(){if(p.empl.item.indexOf("Driver")>-1&&(p.empl.itemType+="&itemType[]="+p.empl.serviceType),"edit"==p.formType){var e=[],l=[];p.empl.oldItems.forEach(function(e){p.empl.itemType.indexOf(e)<0&&e.split(",").forEach(function(e){l.push(e)})}),p.empl.itemType.split("&itemType[]=").forEach(function(t){p.empl.oldItems.indexOf(t)<0&&t.split(",").forEach(function(t){e.push(t)})}),e.length>0&&(p.empl.itemType=e.join("&itemType[]=")),l.length>0&&(p.empl.itemTypeOld=l.join("&itemTypeOld[]=")),u.editDispatcherItem(p.empl).then(function(e){t.goBack(),d.$broadcast("loading:hide"),d.$broadcast("empl:saved"),s(["SUCCESS","ITEM_EDITED"]).then(function(e){i.success(e.ITEM_EDITED,e.SUCCESS,{timeOut:3e3,positionClass:"toast-bottom-center"})})},function(){s(["SOMETHING_WRONG","FAILED"]).then(function(e){d.$broadcast("loading:hide"),a.alert({title:e.FAILED,template:e.SOMETHING_WRONG})})})}else void 0!=p.empl.lastName?p.empl.name=p.empl.firstName+" "+p.empl.lastName:p.empl.name=p.empl.firstName,u.addDispatcherItem(p.empl).then(function(e){u.findByCategoryId(o.employeeId,!0).then(function(e){d.$broadcast("empl:saved")}),t.goBack();var l,c=(u.getAllDrivers(),{}),m=[];u.getAllEmployees().then(function(e){d.$broadcast("loading:hide"),e.forEach(function(e){if(e.hasOwnProperty("email")&&e.email==p.empl.email){l=e.category_id;var t=e.email.split("@")[0];c[t]=""}e.category_id!=p.empl.category_id||e.hasOwnProperty("can_bookin")||e.apikeypublic==window.localStorage.getItem("apikeypublic")||""==e.apikeypublic||m.push(e.apikeypublic)}),d.$broadcast("loading:hide"),s(["SUCCESS","ITEM_ADDED"]).then(function(e){i.success(e.ITEM_ADDED,e.SUCCESS,{timeOut:3e3,positionClass:"toast-bottom-center"})}),s(["NEW_SUBSCRIPTION","FAILED"]).then(function(e){if(0!=Object.keys(c).length){var t=n.child(l+"/messages");t.push({to:c,from:window.localStorage.getItem("apikeypublic"),from_name:r.name,message:e.NEW_SUBSCRIPTION,time:Firebase.ServerValue.TIMESTAMP},function(e){e&&s(["MSG_SENT_FAILURE"]).then(function(e){a.alert({title:e.FAILED,template:e.MSG_SENT_FAILURE})})})}m.forEach(function(t){var o={};o[t]="";var i=n.child(p.empl.category_id+"/messages");i.push({to:o,from:window.localStorage.getItem("apikeypublic"),from_name:r.name,message:e.NEW_SUBSCRIPTION,time:Firebase.ServerValue.TIMESTAMP,toShow:!1},function(e){d.$broadcast("loading:hide"),e&&s(["MSG_SENT_FAILURE"]).then(function(e){a.alert({title:e.FAILED,template:e.MSG_SENT_FAILURE})})})})})})},function(){s(["SOMETHING_WRONG","FAILED"]).then(function(e){d.$broadcast("loading:hide"),a.alert({title:e.FAILED,template:e.SOMETHING_WRONG})})})},p.noService=function(e){if(e.checked){var t=u.getTagsRatePlan(p.empl.category_id,["Driver",e.text]);t.length>0&&s("NO_RATE_PLAN").then(function(e){i.info(e+t.join(", "),{timeOut:3e3,positionClass:"toast-bottom-center"})})}},p.showService=function(e){c(function(){angular.element(e.target).siblings("").find("ion-item").trigger("click")})},p.showServiceField=function(){return p.empl&&p.empl.item&&p.empl.item.indexOf("Driver")>-1}})}]).controller("EmployeeDispatcherCtrl",["$interval","$ionicSideMenuDelegate","baseUrl","$ionicScrollDelegate","$ionicHistory","$ionicFilterBar","$state","$filter","$localStorage","fireRef","$ionicLoading","$ionicPopup","$ionicPopover","$ionicModal","toastr","$translate","$timeout","$rootScope","constants","$scope","$stateParams","EmployeeService",function(e,t,o,i,n,a,r,l,s,c,d,p,u,m,g,f,v,h,_,E,S,D){E.centerMap={};h.showFooter=!1;var y;E.loading=!0,t.canDragContent(!1),E.$on("$ionicView.afterEnter",function(){E.showpost=D.getGlobalGroups().indexOf(S.employeeId)>-1,E.zonecircles=D.getzoneMap()[S.employeeId],E.zonecircles&&h.setCircles(E.zonecircles),E.quoteslide=!0,E.view_loaded=!0,E.onSlideMove=function(e){E.messaging=1==e.index,E.quoteslide=0==e.index,E.mapslide=2==e.index,E.setMenuText(E.messaging),E.mapslide?h.setMapClass("dispatchermap"):(h.mapclass=null,document.querySelector("ion-view.pane").style.position="absolute")};var e;E.showFilterBar=function(){e=a.show({items:E.employees,update:function(e,t){E.employees=e}})},E.showLargImage=function(e){e.pic=e.pic||E.defaultPic,E.largeImg=e,E.showModal("popovers/image-popover.html")},E.popoverDiscount=u.fromTemplate(['<ion-popover-view style="height: 50px;">',"<ion-content>",'<div id="discount" class="item-input-inset search-bar">','<label class="item-input-wrapper">','<i class="icon ion-ios7-search placeholder-icon"></i>','<input id="searchKey" type="search" placeholder="{{ \'DISCOUNT_CODE\' | translate }}" ng-model="coupon" autocorrect="off">',"</label>",'<span ng-click="setDiscountCode(coupon)" ng-class="(coupon.length > 0) ? \'ion-checkmark\' : \'\'" class="button button-clear ft25"></span>',"</div>","<div id=\"discount\" style=\"margin:10px\" ng-if=\"!validCoupon\" class=\"form-errors\" ng-messages=\"{'incorrect_code': invalid_reason == 'code', 'no_drivers': invalid_reason == 'driver', 'not_in_range': invalid_reason == 'range'}\">","<div class=\"form-error\" ng-message-exp=\"['incorrect_code']\">{{'INVALID_COUPON'|translate}}</div>","<div class=\"form-error\" ng-message-exp=\"['no_drivers']\">{{'COUPON_NO_DRIVERS'|translate}}</div>","<div class=\"form-error\" ng-message-exp=\"['not_in_range']\">{{'COUPON_NOT_IN_RANGE'|translate}}</div>","</div>","</ion-content>","</ion-popover-view>"].join(""),{scope:E});var t,o=!1;E.validCoupon=!0;var T=h.$on("search:location",function(e,i){o&&(o=!1,i&&i.coupon?(h.$broadcast("validcoupon",t),h.$broadcast("loading:hide"),E.popoverDiscount.hide(),E.validCoupon=!0):(E.invalid_reason="driver",E.validCoupon=!1,h.$broadcast("loading:hide")))});E.setDiscountCode=function(e){"NO_DRIVER"!=E.quoteBtnText&&(h.$broadcast("loading:show",{text:"VALIDATING_COUPON"}),D.coupon(e).then(function(e){"Success"==e.status?(t=JSON.parse(e.data.settings),t.group_name!=E.quoteForm.group_name?(E.invalid_reason="code",E.validCoupon=!1,h.$broadcast("loading:hide")):D.getGPSDistance(t.pickup_lat,t.pickup_lon,h.lat,h.lon)>1?(E.invalid_reason="range",E.validCoupon=!1,h.$broadcast("loading:hide")):(o=!0,h.$broadcast("location:searched",{pickup:{lat:t.pickup_lat,lon:t.pickup_lon,coupon:!0}}))):(E.invalid_reason="code",E.validCoupon=!1,h.$broadcast("loading:hide"))}),E.quoteForm.coupon=e)},E.showChatModal=function(e){m.fromTemplateUrl("modals/chat.html",{apikey:e.apikeypublic,zone_id:e.category_id,scope:E}).then(function(e){void 0!=h.chatModal&&null!=h.chatModal&&h.chatModal.isShown()||(h.chatModal=e,e.show())})},E.removeChatModal=function(){D.removeModalPopup(h,"chatModal")};var M=h.$watch("dispatcherQMode",function(e,t){e!=t&&(s.dispatcherQMode=h.dispatcherQMode)});D.getTags(window.localStorage.getItem("apikeypublic"),S.employeeId).then(function(e){E.tags=e.tags,E.serviceSelected(),0==E.totalDrivers&&E.allow_advance_reservation>0&&E.tags.forEach(function(e){V.push(e),E.services.push({id:e,text:e,"class":"taxicar",checked:!1,icon:"pics/taxi.png"})})});var I=E.$on("location:updated",function(e){});E.showModal=function(e){m.fromTemplateUrl(e,{scope:E,animation:"slide-in-up"}).then(function(e){E.fullSizeImageModal=e,E.fullSizeImageModal.show()})},E.closeModal=function(){E.fullSizeImageModal.hide(),E.fullSizeImageModal.remove()},E.filterPickupServ=function(e){var t=D.getTagsDriverMap();return B?E.quoteForm.service?t[E.quoteForm.service][e.apikeypublic]:t.all[e.apikeypublic]:!0},E.filterRange=function(e){if(E.quoteForm.range){var t=D.getGpsRanges();return t[E.quoteForm.range].indexOf(e.apikeypublic)>-1}return!0},E.filterMe=function(e){if(void 0!=E.quoteForm.pickup&&Object.keys(E.quoteForm.pickup).length>0){E.quoteForm.pickup}else;return e.apikeypublic!=window.localStorage.getItem("apikeypublic")},E.filterTags=function(e){return"number"!=typeof e.QP&&D.matchesTags(e,E.quoteForm.service.split(",").filter(function(e){return e}))},E.filterZone=function(e){return N?e.zone_id==N:!0},E.filterBookedDriver=function(e){return e.booked&&e.tags&&e.tags.indexOf("Driver")>-1},E.quoteFilter=function(e){return E.filterMe(e)&&E.filterBookedDriver(e)&&E.filterMode(e)&&(!E.quoteForm.pickup||E.filterTags(e)&&E.filterPickupServ(e)&&E.filterRange(e)&&E.filterZone(e))},E.isDispatcher=!1,E.isAdmin=!1,E.isOwner,E.filterAdmin=function(){var e=!1;return null!=D.getCategEmployees()&&D.getCategEmployees().forEach(function(t,o){t.category_id!=S.employeeId||t.apikeypublic!=window.localStorage.getItem("apikeypublic")||e&&void 0!=e||(e=t.hasOwnProperty("can_bookin")?t.hasOwnProperty("can_bookin"):t.tags&&t.tags.indexOf("Admin")>-1,E.isAdmin=e,h.isOwner=E.isOwner=s.user_id==t.user_id,e||v(function(){$(".dispatcherToggle .toggle").css("display","none")}))}),e},E.filterMode=function(e){return"offer"==h.dispatcherQMode||e.mode==h.dispatcherQMode},E.messageFilter=function(e){return E.messaging&&"1"==e.active&&""!=e.apikeypublic};var k=function(e,t){if(void 0==E.quoteForm.pickup)var o={lat:h.lat,lon:h.lon};else var o={lat:E.quoteForm.pickup.lat,lon:E.quoteForm.pickup.lon};var i=D.getGPSDistance(parseFloat(e.lat),parseFloat(e.lng),o.lat,o.lon),n=D.getGPSDistance(parseFloat(t.lat),parseFloat(t.lng),o.lat,o.lon);return Math.abs(i-n)>.5?i-n:Number(e.QP.split("/")[0])-Number(t.QP.split("/")[0])},b=function(e,t){return t.booked};E.defaultPic="img/person.jpg",h.mapmarkers={};var C=!1,R=function(){D.findByCategoryId(S.employeeId).then(function(e){E.employees||(E.loading=!1,v(function(){E.scrollerHeight={height:$(".slider-slide").height()-15+"px"}})),void 0==E.isOwner&&E.filterAdmin(),e.length>0&&(E.showquote=!0),null!=E.employees&&(E.oldemployees=angular.copy(E.employees)),E.employees=e;var t=[],o=[];E.employees.forEach(function(e,i){e.hasOwnProperty("rating")&&(e.driverRating=e.rating.driver.toFixed(2)),e.hasOwnProperty("booked")||(e.booked=!1),e.isChecked=1==e.active&&!e.intrip&&""==e.quote_id,null==E.oldemployees?e.isCheckedForMsg=!0:void 0!=E.oldemployees[i]&&(e.isCheckedForMsg=E.oldemployees[i].isCheckedForMsg),e.tags.indexOf("Driver")>-1&&e.apikeypublic!=window.localStorage.getItem("apikeypublic")&&(y=v(function(){h.mapmarkers&&(h.mapmarkers[e.apikeypublic]={booked:e.booked,lat:Number(e.lat),lng:Number(e.lng),zone_id:e.zone_id,clickable:!0},h.setMapMarkers(h.mapmarkers))})),E.quoteFilter(e)&&t.push(e),E.filterMe(e)&&o.push(e)});var i=D.getCategEmployees();E.hasDrivers=i[0].hasDriver,E.hasOtherItems=i[0].hasOtherItems,t.sort(k),o.sort(b),E.quotedrivers=t,E.messageitems=o})};D.getEmployees().forEach(function(e){e.category_id==S.employeeId&&(E.title=e.managerName,E.quoteForm={},E.quoteForm.group_name=e.managerName)});var w=E.$watch("employees",function(e,t){if(void 0!=e){var o=[];e.forEach(function(e,t){e.apikeypublic!=window.localStorage.getItem("apikeypublic")&&e.booked&&o.push(e)}),0==o.length&&(E.alertPopup&&E.alertPopup.hide(),E.messagePopup&&E.messagePopup.close())}});R();var O=E.$on("firebase:updated",function(e,t){R()}),P=E.$on("mapset",function(e,t){C=!0,R()}),A=E.$on("inbox:updated",function(e,t){t==S.employeeId&&c.child(S.employeeId+"/queue").orderByChild("timestamp").once("value",function(e){D.setEmpl(e,S.employeeId)})}),L=h.$on("empl:saved",function(e){R()});u.fromTemplateUrl("popovers/dispatcher-menu.html",{scope:E}).then(function(e){E.popoverDispatcher=e}),E.filterFunc=function(e){return e.apikeypublic===window.localStorage.getItem("apikeypublic")};var F=!0;E.reorder=function(){E.popoverDispatcher.hide(),F=!1,E.data.showReorder=!E.data.showReorder,E.data.showDelete=!1},E.bydist=function(){E.popoverDispatcher.hide(),F=!0,E.data.showReorder=!1,E.data.showDelete=!1},E["delete"]=function(){E.popoverDispatcher.hide(),E.data.showDelete=!E.data.showDelete,E.data.showReorder=!1},E.sortFunc=function(e){if(E.messaging)return e.booked?-1:1;if(F){if(void 0==E.quoteForm.pickup)var t={lat:h.lat,lon:h.lon};else var t={lat:E.quoteForm.pickup.lat,lon:E.quoteForm.pickup.lon};return D.getGPSDistance(parseFloat(e.lat),parseFloat(e.lng),t.lat,t.lon)}};E.edit=function(e){E.empl=e,r.transitionTo("app.dispatcher-form",{employeeId:S.employeeId,obj:E.empl,type:"edit"})},E.add=function(){E.empl={},E.empl.category_id=E.employees[0].category_id,E.empl.active=1,E.data.showReorder=!1,E.data.showDelete=!1,E.popoverDispatcher.hide(),r.transitionTo("app.dispatcher-form",{employeeId:S.employeeId,obj:E.empl,type:"add"})},E.onItemDelete=function(e){h.$broadcast("loading:show"),D.deleteDispatcherItem(e).then(function(){E.bookOutDriver(e.apikeypublic,e.category_id,"removed"),E.employees.splice(E.employees.indexOf(e),1),D.findAllEmployees().then(function(e){D.autologin().then(function(e){h.$broadcast("empl:saved"),f(["SUCCESS","ITEM_DELETED"]).then(function(e){g.success(e.ITEM_DELETED,e.SUCCESS,{timeOut:3e3,positionClass:"toast-bottom-center"})})})})},function(){f(["SOMETHING_WRONG","FAILED"]).then(function(e){p.alert({title:e.FAILED,template:e.SOMETHING_WRONG})})})["finally"](function(){h.$broadcast("loading:hide")})},E.showAlert=function(e,t){f(["OK","CANCEL","ACTIVATE","INACTIVATE","CONFIRM_ACTIVATE","CONFIRM_INACTIVATE"]).then(function(o){p.confirm({title:e.active?o.ACTIVATE:o.INACTIVATE,template:text=(e.active?o.CONFIRM_ACTIVATE:o.CONFIRM_INACTIVATE)+e.firstName+"?",buttons:[{text:o.CANCEL},{text:o.OK,type:"button-positive",onTap:function(o){h.$broadcast("loading:show"),D.editDispatcherItem(e).then(function(o){h.$broadcast("loading:hide"),E.bookOutDriver(e.apikeypublic,e.category_id,"deactivated"),D.getCategEmployees()[t].active=e.active,e.active||R()},function(){f(["SOMETHING_WRONG","FAILED"]).then(function(e){h.$broadcast("loading:hide"),p.alert({title:e.FAILED,template:e.SOMETHING_WRONG})})})}}]})})},E.reportEvent=function(e){var t=e.target.parentNode.attributes[6].value,o=e.target.parentNode.attributes[5].value,i=angular.copy(D.getCategEmployees()[t]);i.active="1"==o?0:1;var n=[];i.tags.forEach(function(e){e.indexOf("Driver")>-1&&n.push(e)}),i.itemType=n.join("&itemType[]="),E.showAlert(i,t)},E.bookOutDriver=function(e,t,o){f(["REMOVED_MESSAGE","DEACTIVATED_MESSAGE","FAILED"]).then(function(i){var n=("deactivated"==o?i.DEACTIVATED_MESSAGE:i.REMOVED_MESSAGE)+E.title,a=c.child(t+"/messages"),r={};r[e]="",a.push({to:r,from:window.localStorage.getItem("apikeypublic"),from_name:s.name,message:n,time:Firebase.ServerValue.TIMESTAMP,toShow:!1,type:o},function(e){})})},E.data={showDelete:!1},E.moveItem=function(e,t,o,i){var n=E.employees.indexOf(i[o]);E.employees.splice(E.employees.indexOf(e),1),E.employees.splice(n,0,e)},E.icons=[".icon-pickup",".icon-dropoff",".ion-clock",".ion-person-add",".services.ion-model-s"];E.locationTapped=function(e){if("pickup"==e){var t=E.icons.indexOf(".icon-pickup");t>-1&&E.icons.splice(t,1)}else{var t=E.icons.indexOf(".icon-dropoff");t>-1&&E.icons.splice(t,1)}};var N=null,x=!1,q=!1,z=function(){N=D.pickupCenterZone(E.quoteForm.pickup.lat,E.quoteForm.pickup.lon,S.employeeId),x=N},V=[],U={},G=D.getEmployees()[D.getGroupItems()[S.employeeId].groupPosition].settings;E.allow_advance_reservation=G&&void 0!=G.allow_advance_reservation?G.allow_advance_reservation:h.allow_advance_reservation,E.allow_remote_reservation=G&&void 0!=G.allow_remote_reservation?G.allow_remote_reservation:h.allow_remote_reservation,E.setTagMap=function(e,t,o,i,n,a,r,l){if(E.services=t,E.servicesDetail=D.getTagsDriverMap(),Object.keys(i).length>0&&(U=i,E.rangeAvailable=!0,E.nearestTime=i.nearestDriverTime,E.furthestTime=i.furthestDriverTime),o.length>0&&0!=E.services.length&&f(["SERVICE_REMOVED","SERVICES_NOT_AVAILABLE","SERVICE_NOT_AVAILABLE"]).then(function(e){var t=o+(o.length>1?e.SERVICES_NOT_AVAILABLE:e.SERVICE_NOT_AVAILABLE);g.info(t,e.SERVICE_REMOVED),E.alertPopup&&E.alertPopup.hide(),v(function(){$("#serviceIcon ion-item").click()})}),E.totalDrivers=e,0==E.totalDrivers){if(E.services.length>0&&(E.quoteBtnText="SET_A_B"),N&&l&&q&&(N=null,E.serviceSelected()),0==E.services.length&&0==E.allow_advance_reservation)return"pickup"!=B&&(D.driversAvailable(S.employeeId)?E.quoteBtnText="SET_A_B":E.quoteBtnText="NO_DRIVER",E.totalDrivers=0,j=void 0,B=null,E.pickupSelected=!1,E.nearestTime=null,E.alertPopup&&E.alertPopup.hide()),B=null,!1}else{if(!n)return!N&&x&&l&&(z(),E.serviceSelected()),oe&&(h.$broadcast("search:location",X),oe=!1),W?E.quoteForm.range?Y||(1==E.services.length?(E.quoteForm.service=E.services[0].text,E.quoteBtnText="REVIEW"):E.services.length>1&&(E.quoteBtnText="SELECT_SERVICE")):E.quoteBtnText="SET_RANGE":E.quoteBtnText="SET_A_B",!0;E.quoteBtnText="SET_RANGE",E.quoteForm.range=null,E.alertPopup&&E.alertPopup.hide(),B=null}},E.services=[],E.quoteForm.services=[],E.serviceSelected=function(e){D.resetETA(),e&&(Y=!0);var t=D.getUniqueDrivers();ee="pickup"==B||e?ie:h;
var o=Object.keys(t).length,i=0,n=0,a=0;q=!1;for(var r in t)if(n++,i=Object.keys(t[r]).length,a=0,t[r][S.employeeId]){a++;var l={},s=S.employeeId;l[r]=t[r][s],a==i&&(q=!0),D.setTagMap("updated",l,ee,E.services,V,E.quoteForm.service,function(e,t,r,l,s,c,d,p){n==o&&a==i&&E.setTagMap(e,t,r,l,s,c,d,p)},U,S.employeeId,null,null,E.quoteForm.range,N)}W&&(E.quoteForm.range?0==E.quoteForm.service.length?E.quoteBtnText="SELECT_SERVICE":E.quoteBtnText="REVIEW":E.quoteBtnText="SET_RANGE")};var B,j,H=!1,Y=!1;E.resetQuoteForm=function(){E.quoteForm.splitFare=["splitFare[]="],E.quoteForm.date=moment(new Date).format("MM/DD/YY"),E.quoteForm.time=moment(new Date).format("hh:mm a"),E.quoteForm.service="",v(function(){h.$broadcast("resetfancy")}),E.quoteForm.people=1,W=Q=H=E.pickupSelected=!1,B=j=oldDrop=void 0,E.driversInspected=!0,Y=!1,E.showBtn=!0,E.quoteForm.range=null,E.quoteForm.price=null,E.quoteForm.pickup_type=null,E.quoteForm.pickup_type_name=null,E.quoteForm.dropoff_type=null,E.quoteForm.dropoff_type_name=null,E.quoteForm.post_expire=null,E.quoteForm.mode=null,E.instructionsModal&&(E.instructionsModal.remove().then(function(){E.instructionsModal=null}),E.notes.forEach(function(e){e.checked=!1})),N=null,E.timezone=h.tz,v(function(){E.serviceSelected()}),E.$broadcast("resetDtPicker"),B=null,E.quoteBtnText=E.allow_advance_reservation?"SET_A_B":"NO_DRIVER"},E.resetQuoteForm();var W=!1;E.changed=function(e){e&&(e.hasOwnProperty("pickup")&&(E.quoteForm.pickup=e.pickup),e.hasOwnProperty("dropoff")&&(E.quoteForm.dropoff=e.dropoff),e.hasOwnProperty("range")&&(E.quoteForm.range=e.range),e.hasOwnProperty("price")&&(E.quoteForm.price=e.price),D.getTimeZone(e.pickup.lat,e.pickup.lon).then(function(e){E.timezone=e.timeZoneId}),e.hasOwnProperty("pickup_type")&&(E.quoteForm.pickup_type=e.pickup_type,E.quoteForm.pickup_type_name=e.pickup_type_name,E.quoteForm.dropoff_type=e.dropoff_type,E.quoteForm.dropoff_type_name=e.dropoff_type_name,E.quoteForm.post_expire=e.post_expire),z()),void 0!=E.quoteForm.pickup&&Object.keys(E.quoteForm.pickup).length>0&&(H=!0,E.bydist(),B="pickup",oe=!0,ie=E.quoteForm.pickup),Z(),E.quoteBtnText="SET_A_B",0==E.quoteForm.service.length&&(E.quoteBtnText="SELECT_SERVICE"),E.serviceSelected()};var K=new google.maps.DirectionsService,Q=!1,Z=function(){if(void 0!=E.quoteForm.pickup&&void 0!=E.quoteForm.dropoff&&(E.quoteForm.pickup!=j||E.quoteForm.dropoff!=oldDrop)){W=Q=!0,j=E.quoteForm.pickup,oldDrop=E.quoteForm.dropoff;var e=new google.maps.LatLng(E.quoteForm.pickup.lat,E.quoteForm.pickup.lon),t=new google.maps.LatLng(E.quoteForm.dropoff.lat,E.quoteForm.dropoff.lon),o={origin:e,destination:t,travelMode:google.maps.TravelMode.DRIVING};K.route(o,function(e,t){if(t==google.maps.DirectionsStatus.OK)for(var o=e.routes[0],i=0;i<o.legs.length;i++)E.estDist=(o.legs[i].distance.value/1609).toFixed(1),E.estTime=o.legs[i].duration.text,E.quoteForm.estDistVal=o.legs[i].distance.value/1609,E.quoteForm.estTimeVal=o.legs[i].duration.value/60,E.pickupSelected=!0,E.quoteForm.distance=E.estDist,0!=E.quoteForm.service.length&&Y&&(E.quoteBtnText="REVIEW")})}},J=function(e,t){var o=new google.maps.Geocoder;o.geocode({latLng:e},function(e,o){o==google.maps.GeocoderStatus.OK&&("pickup"==t?(E.quoteForm.pickup={},E.quoteForm.pickup.formatted_address=e[0].formatted_address,E.quoteForm.pickup.lat=e[0].geometry.location.lat(),E.quoteForm.pickup.lon=e[0].geometry.location.lng(),$(".ion-google-place-container.modal").is(":visible")&&h.$broadcast("posFetched")):(E.quoteForm.dropoff={},E.quoteForm.dropoff.formatted_address=e[0].formatted_address,E.quoteForm.dropoff.lat=e[0].geometry.location.lat(),E.quoteForm.dropoff.lon=e[0].geometry.location.lng()))})};J(new google.maps.LatLng(h.lat,parseFloat(h.lon)+.008),"dropoff");E.totalDrivers=0;var H=!1,X={},ee={},te=function(e,t,o){ee="pickup"==B||E.quoteForm.pickup&&E.quoteForm.pickup.lat?ie:h,null!=t&&D.setTagMap(o,t,ee,E.services,V,E.quoteForm.service,function(e,t,o,i,n,a,r,l){E.setTagMap(e,t,o,i,n,a,r,l)},U,S.employeeId,null,null,E.quoteForm.range,N)},oe=!1,ie={},ne=E.$on("location:searched",function(e,t){ie=t.pickup,oe=!0,E.setTag()}),ae=E.$on("queue:updated",te),re=E.$on("queue:added",te),le=E.$on("queue:removed",te);E.rangeAvailable=!1;var se=E.$on("queue:range",function(e,t,o){E.rangeAvailable=!0,E.nearestMiles=t,E.furthestMiles=o}),ce=E.$on("queue:rangeTime",function(e,t,o){E.nearestTime=t,E.furthestTime=o}),de=["NOTES_DRIVER1","NOTES_DRIVER2","NOTES_DRIVER3","NOTES_DRIVER4","NOTES_DRIVER5"];if(f(de).then(function(e){E.notess=[],E.translatedText={},de.forEach(function(t,o){E.notess.push({text:e[t],checked:!1}),E.translatedText[t]=e[t]})}),E.noteChecked=function(e){var t;E.notes.forEach(function(e){e.checked&&(t=e)}),void 0!=t?t==e?e.checked=!e.checked:(t.checked=!1,e.checked=!0):e.checked=!0,e.text==E.translatedText.NOTES_DRIVER5?(E.otherNoteSelected=!1,v(function(){$("textarea").focus()})):E.otherNoteSelected=!0,i.resize()},E.openInstructions=function(){if(E.notes=angular.copy(E.notess),null!=E.instructionsModal)return void E.instructionsModal.show();m.fromTemplateUrl("modals/quote-note.html",{scope:E,animation:"slide-in-up",backdropClickToClose:!1}).then(function(e){E.otherNoteSelected=!0,E.quotenote={},E.instructionsModal=e,e.show()})},E.quoteForm.note="",E.saveInstructions=function(){E.quoteForm.note="",E.notess=angular.copy(E.notes),E.notes.forEach(function(e){e.checked&&(e.text==E.translatedText.NOTES_DRIVER5?E.quoteForm.note=E.quotenote.other:E.quoteForm.note=e.text)}),E.instructionsModal.hide()},E.services=[],f("SELECT_SERVICE").then(function(e){E.services_text_single=e}),E.val={single:null,multiple:null},E.setServiceCheckMark=function(){E.services.forEach(function(e){e.id==E.quoteForm.service?e.checked=!0:e.checked=!1})},E.quoteForm.service="",E.setCarIcon=function(){E.services.forEach(function(e){E.quoteForm.service==e.id&&(E.serviceImg=e.icon)}),0==E.services.length&&(E.serviceImg="pics/taxi.png")},E.setCarIcon(),E.showService=function(){E.setServiceCheckMark()},E.reset=function(){E.alertPopup.hide(),E.resetQuoteForm()},E.editPickup=function(e){v(function(){$("#icon-pickup").trigger("click",[e])})},E.editService=function(){v(function(){$("#serviceIcon ion-item").click(),E.overlayModal()})},E.editSeats=function(){v(function(){$("div[people] .button-icon").click(),E.overlayModal()})},E.editDate=function(){v(function(){$("date-picker .button-icon").click(),E.overlayModal()})},E.editNotes=function(){E.openInstructions(),E.overlayModal()},E.overlayModal=function(){$('.modal:not(".confirmquoteModal")').parent().closest("div.modal-backdrop").css("zIndex",50)},E.setTag=function(){var e=D.setTag(ie,E.quoteForm.service,S.employeeId);X=ie,e>0?h.$broadcast("search:location",X):D.withinZone(S.employeeId,!1,X.lat,X.lon)?h.$broadcast("search:location",X):(H=!1,f(["SORRY","NO_DRIVERS_PICKUP"]).then(function(e){oe&&(g.error(e.NO_DRIVERS_PICKUP,e.SORRY),h.$broadcast("search:location",null),oe=!1)}),B=null)},void 0!=h.rates[0])if("offer"==h.rates[0].mode){var pe={rate_id:h.rates[0].value,price:h.rates[0].price,zone_id:h.rates[0].zone_id,id:h.rates[0].quoteId,summary:h.rates[0].summary};h.loggedIn&&D.showOrderForm(pe)}else if(null!=h.priceModal)for(var ue=0;ue<h.rates.length;ue++)if(h.rates[ue].value==h.selectedRate.rate_id){var pe={rate_id:h.selectedRate.rate_id,price:h.rates[ue].price,zone_id:h.rates[ue].zone_id,id:h.rates[ue].quoteId,summary:h.rates[ue].summary};D.showPriceModal(),h.loggedIn&&D.showOrderForm(pe);break}E.dropoffClicked=function(){v(function(){$("#icon-pickup").click()})},E.saveDateTime=function(e){E.quoteForm.date=moment(new Date(e)).format("MM/DD/YY"),E.quoteForm.time=moment(new Date(e)).format("hh:mm a")},E.quoteButtonTapped=function(e){if(E.messaging)E.enterMessage();else if("SELECT_SERVICE"==E.quoteBtnText)v(function(){$("#serviceIcon ion-item").click()});else if("SET_A_B"==E.quoteBtnText||"SET_RANGE"==E.quoteBtnText){v(function(){$("#icon-pickup").click()});var t=new google.maps.LatLng(h.lat,h.lon),o=new google.maps.LatLng(h.lat,h.lon+.008);J(t,"pickup"),J(o,"dropoff")}else"REVIEW"==E.quoteBtnText&&E.sendQuote()};var me=E.$on("validcoupon",function(e,t){E.quoteForm.dropoff.formatted_address=t.dropoff,E.quoteForm.dropoff.lat=t.dropoff_lat,E.quoteForm.dropoff.lon=t.dropoff_lon,E.quoteForm.people=t.selectPeople,E.quoteForm.service=t.selectService,E.quoteForm.coupon=t.coupon,E.quoteForm.price=t.price,E.quoteForm.range=_.defaultMilesRadius,E.quoteForm.mode="offer";var o={origin:new google.maps.LatLng(h.lat,h.lon),destination:new google.maps.LatLng(E.quoteForm.dropoff.lat,E.quoteForm.dropoff.lon),travelMode:google.maps.TravelMode.DRIVING};K.route(o,function(e,t){if(t==google.maps.DirectionsStatus.OK)for(var o=e.routes[0],i=0;i<o.legs.length;i++)E.estDist=(o.legs[i].distance.value/1609).toFixed(1),E.estTime=o.legs[i].duration.text,E.quoteForm.estDistVal=o.legs[i].distance.value/1609,E.quoteForm.estTimeVal=o.legs[i].duration.value/60,E.pickupSelected=!0,E.quoteForm.distance=E.estDist,he()})});E.send=function(){D.removeModalPopup(E,"alertPopup"),E.showBtn=!1,he()},E.confirm=function(){E.sendQuote(!0)},E.sendQuote=function(e){f(["CONFIRM","ERROR","CURRENTLY_NO_DRIVERS","SORRY","NO_DRIVERS_PICKUP","ENTER_PICKUP_LOC","ENTER_DROPOFF_LOC"]).then(function(t){if(e)he();else{if(null!=E.alertPopup)return void E.alertPopup.show();m.fromTemplateUrl("modals/confirmquote.html",{scope:E,animation:"slide-in-up",backdropClickToClose:!1}).then(function(e){E.alertPopup=e,e.show()})}})};var ge=E.$on("quoteaccepted",function(){E.quoteSentMsg=null,h.dontHideLoader=!1}),fe=E.$on("quotecancelled",function(e,t){h.dontHideLoader=!1,E.quoteSentMsg==t&&f(["SORRY","QUOTE_NOT_ACCEPTED"]).then(function(e){E.quoteSentMsg=null,g.error(e.QUOTE_NOT_ACCEPTED,e.SORRY),h.$broadcast("loading:hide")})}),ve=!1,he=function(){E.quoteForm.group_id=S.employeeId,E.quoteForm.items=[],E.employees.forEach(function(e,t){e.apikeypublic!=window.localStorage.getItem("apikeypublic")&&D.matchesTags(e,E.quoteForm.service.split(",").filter(function(e){return e}))&&e.isChecked&&e.booked&&e.category_id==S.employeeId&&E.quoteForm.items.push("items[]="+e.item_id)});var e=l("filter")(E.employees,function(e,t,o){return e.apikeypublic!=window.localStorage.getItem("apikeypublic")&&e.booked&&D.matchesTags(e,E.quoteForm.service.split(",").filter(function(e){return e}))&&(E.quoteForm.mode==e.mode||!E.quoteForm.mode&&e.mode==h.dispatcherQMode||"offer"==h.dispatcherQMode)});return e.length>0&&0==E.quoteForm.items.length?void f(["SORRY","SELECT_DRIVER"]).then(function(e){g.error(e.SELECT_DRIVER,e.SORRY)}):(ve=!0,h.showLoader=!0,h.$broadcast("loading:show",{text:"SEND_RIDE_REQ"}),E.quoteForm.timezone=E.timezone,h.dontHideLoader=!0,void D.quoteDispatcher(E.quoteForm).then(function(e){ve=!1,0==E.totalDrivers?(h.$broadcast("quoteaccepted"),f(["SUCCESS","QUOTE_SCHEDULED"]).then(function(e){g.success(e.QUOTE_SCHEDULED,e.SUCCESS)}),h.$broadcast("loading:hide")):("offer"!=e.mode&&f("AWAIT_CONFIRM").then(function(e){d.show({template:e})}),E.quoteSentMsg=e.quoteID),E.resetQuoteForm(),E.quoteForm.date=moment(new Date).format("MM/DD/YY"),E.quoteForm.time=moment(new Date).format("hh:mm a")},function(e){h.dontHideLoader=!1,h.$broadcast("loading:hide"),null!=E.modalDatePicker&&E.modalDatePicker.remove(),null!=E.seatsModal&&E.seatsModal.remove(),E.modalDatePicker=null,E.seatsModal=null,f(["SOMETHING_WRONG","FAILED"]).then(function(e){p.alert({title:e.FAILED,template:e.SOMETHING_WRONG})}),E.showBtn=!0}))};E.messaging=!1,E.setMessaging=function(){E.messaging=!E.messaging,E.setMenuText(E.messaging),E.popoverDispatcher.hide()},E.setMenuText=function(e){f(["SEND_MESSAGE","SEND_QUOTE","SELECT_NONE"]).then(function(t){E.sendmsgquote=e?t.SEND_QUOTE:t.SEND_MESSAGE,e?(E.isAdmin||v(function(){$(".dispatcherToggle .toggle").css("display","none")}),E.selectallnonetext=t.SELECT_NONE,E.setMsgCheckboxes()):E.isAdmin&&v(function(){$(".dispatcherToggle .toggle").css("display","block")})})},E.setMenuText(!1),f("SELECT_NONE").then(function(e){E.selectquoteallnonetext=e}),E.selectAllNone=function(e){f(["SELECT_ALL","SELECT_NONE"]).then(function(t){"msg"==e?(E.selectallnonetext=E.selectallnonetext==t.SELECT_ALL?t.SELECT_NONE:t.SELECT_ALL,E.setMsgCheckboxes()):(E.selectquoteallnonetext=E.selectquoteallnonetext==t.SELECT_ALL?t.SELECT_NONE:t.SELECT_ALL,E.setQuoteCheckboxes())}),E.popoverDispatcher.hide()},E.setMsgCheckboxes=function(){f(["SELECT_ALL"]).then(function(e){E.employees.forEach(function(t,o){E.selectallnonetext==e.SELECT_ALL?t.isCheckedForMsg=!1:t.isCheckedForMsg=!0})})},E.setQuoteCheckboxes=function(){f(["SELECT_ALL"]).then(function(e){E.employees.forEach(function(t,o){E.selectquoteallnonetext==e.SELECT_ALL?t.isChecked=!1:t.isChecked=!0})})},E.employeeDetailPage=function(e,t){"checkbox"!=e.target.type&&"IMG"!=e.target.tagName&&"ION-OPTION-BUTTON"!=e.target.tagName&&r.transitionTo("app.employee-detail",{employeeId:S.employeeId,driverId:t})},E.filteredData=[];var _e=E.$watchCollection("employees",function(e){E.filteredData=l("filter")(e,function(e,t,o){return e.apikeypublic!=window.localStorage.getItem("apikeypublic")&&e.booked&&D.matchesTags(e,E.quoteForm.service.split(",").filter(function(e){return e}))&&(e.mode==h.dispatcherQMode||"offer"==h.dispatcherQMode)})});E.enterMessage=function(){if(E.recipientApiKeys={},E.recipientFirstName=[],E.zones=[],E.employees.forEach(function(e,t){e.active&&e.apikeypublic!=window.localStorage.getItem("apikeypublic")&&""!=e.apikeypublic&&e.isCheckedForMsg&&(E.recipientApiKeys[e.apikeypublic]="",E.recipientFirstName.push(e.firstName),E.zones.indexOf(e.category_id)<0&&E.zones.push(e.category_id))}),0==E.recipientFirstName.length)return void f(["SORRY","SELECT_RECIPIENT"]).then(function(e){g.error(e.SELECT_RECIPIENT,e.SORRY)});var e=l("filter")(E.employees,function(e,t,o){return e.apikeypublic!=window.localStorage.getItem("apikeypublic")&&"1"==e.active&&""!=e.apikeypublic});E.recipients=e.length==E.recipientFirstName.length?"All":E.recipientFirstName.join(","),E.message={},f(["ENTER_MESSAGE","CANCEL","SEND"]).then(function(e){E.messagePopup=p.show({cssClass:"sendMsgAlert",template:'<textarea  ng-model="message.msg" rows="8" cols="10"></textarea>',title:e.ENTER_MESSAGE,subTitle:"Recipients: "+E.recipients,scope:E,buttons:[{text:e.CANCEL},{text:"<b>"+e.SEND+"</b>",type:"button-positive",onTap:function(e){return E.message.msg?E.message.msg:void e.preventDefault()}}]}),E.messagePopup.then(function(e){void 0!=e&&E.message.msg.trim().length>0&&E.sendMessage()})})},E.sendMessage=function(){h.$broadcast("loading:show"),E.zones.forEach(function(e){var t=c.child(e+"/messages");t.push({to:E.recipientApiKeys,from:window.localStorage.getItem("apikeypublic"),from_name:s.name,message:E.message.msg,time:Firebase.ServerValue.TIMESTAMP},function(e){h.$broadcast("loading:hide"),e&&f(["MSG_SENT_FAILURE"]).then(function(e){p.alert({title:e.FAILED,template:e.MSG_SENT_FAILURE})})})})},v(function(){var e=D.getzoneMap();e[S.employeeId]&&e[S.employeeId].forEach(function(e){D.getzoneIDStored().indexOf()<0&&c.child(e.id+"/queue").orderByChild("timestamp").on("value",D.zoneListener)})},2e3),E.$on("$ionicView.beforeLeave",function(){T&&T(),me&&me(),h.isOwner=void 0,M&&M(),_e&&_e(),E.instructionsModal&&E.instructionsModal.remove().then(function(){E.instructionsModal=null}),E.seatsModal&&E.seatsModal.remove().then(function(){E.seatsModal=null}),null!=E.modalDatePicker&&(E.modalDatePicker.remove(),E.modalDatePicker=null),ge&&ge(),fe&&fe(),L&&L(),O&&O(),A&&A(),le&&le(),re&&re(),ae&&ae(),se&&se(),ce&&ce(),ne&&ne(),w&&w(),e&&(e(),e=null),I&&I(),P&&P(),y&&v.cancel(y),E.popoverMenu&&(E.popoverMenu.remove(),E.popoverMenu=null),"app.dispatcher-form"!=n.currentStateName()&&"app.employee-detail"!=n.currentStateName()&&D.emptyEmployeesCateg(),h.mapmarkers=null,h.resetMap(),E.alertPopup&&D.removeModalPopup(E,"alertPopup"),D.removeModalPopup(E,"fullSizeImageModal"),D.removeModalPopup(E,"popoverDiscount");var t=D.getzoneMap();t[S.employeeId]&&t[S.employeeId].forEach(function(e){D.getzoneIDStored().indexOf()<0&&c.child(e.id+"/queue").orderByChild("timestamp").off("value",D.zoneListener)}),D.resetDispatcherTagMap()})})}]).controller("RatingCtrl",["baseUrl","$ionicPopup","toastr","$localStorage","$translate","$timeout","$scope","$rootScope","EmployeeService",function(e,t,o,i,n,a,r,l,s){var c;r.openDetail=function(e){"IMG"!==e.target.nodeName&&(r.isAccordToggled=!r.isAccordToggled)},r.setRating=function(){for(var e=0,t=0;t<r.ratingChkboxes.length;t++)r.ratingChkboxes[t].isChecked&&e++;a(function(){r.rate=e})},r.max=5;var d,p,u,m,g,f,v,h=null,_=[],E=function(){if(m&&(h=s.getRating(i.tripDetail.zone_id,i.tripDetail.id)),l.$broadcast("loading:hide"),m)var e=["RATE_DRIVER1","RATE_DRIVER2","RATE_DRIVER3","RATE_DRIVER4","RATE_DRIVER5"];else var e=["RATE_CUSTOMER1","RATE_CUSTOMER2","RATE_CUSTOMER3","RATE_CUSTOMER4","RATE_CUSTOMER5"];n(e).then(function(t){var o=[{"class":"ion-clock",text:t[e[0]],isChecked:m?h.time:!0,calculated:m},{"class":m?"ion-speedometer":"icon-pick",text:t[e[1]],isChecked:m?h.speed:!0,calculated:m},{"class":m?"ion-arrow-graph-up-right":"icon-drop",text:t[e[2]],isChecked:m?h.distance:!0,calculated:m},{"class":m?"icon-driver":"ion-ios-locked",text:t[e[3]],isChecked:!0,calculated:!1},{"class":m?"ion-waterdrop":"ion-thumbsup",text:t[e[4]],isChecked:!0,calculated:!1}];r.ratingChkboxes=o,r.setRating()})},S=l.$on("modal.shown",function(e,t){if(d=t.zone_id,p=t.quote_id,u=t.tripID,f=t.reply_to,v=t.sent_to,m=t.isCustomer,g=t.isDriver,r.isDriver=g,c=l.detail,E(),m)var o=v;else var o=f;s.profile(o).then(function(e){r.name=e.description}),a(function(){}),r.showTripDetail=function(){if(void 0!=c){var e=["TRIP_INFO","PAYMENT_METHOD","PRICE","PICKUP","DROPOFF","SERVICE","SEATS","ROUTE","DATE_TIME","MILES"];n(e).then(function(e){r.accordion={},r.ratingitems=[{label:e.PAYMENT_METHOD,text:c.paymentMethod},{label:e.PICKUP,text:c.pickup},{label:e.DROPOFF,text:c.dropoff},{label:e.SERVICE,text:c.selectService},{label:e.SEATS,text:c.selectPeople},{label:e.ROUTE,text:c.route_distance+" "+e.MILES},{label:e.DATE_TIME,text:c.selectDate+" "+c.selectTime}],r.accordion.heading=e.TRIP_INFO})}},r.showTripDetail()});r.$on("$destroy",function(){S&&S()}),r.sendRating=function(){l.$broadcast("loading:show");for(var e=0;e<r.ratingChkboxes.length;e++)_.push("message[]="+(r.ratingChkboxes[e].isChecked?1:0));var a=i.tripDetail.isDriver;s.trip({isDriver:i.tripDetail.isDriver,zone_id:d,quote_id:p,tripID:u,msg:_,status:9}).then(function(e){s.removeModalPopup(l,"ratingModal"),o.clear(),a||s.endTrip(),l.$broadcast("loading:hide")},function(e){l.$broadcast("loading:hide"),n(["SOMETHING_WRONG","FAILED"]).then(function(e){t.alert({title:e.FAILED,template:e.SOMETHING_WRONG})})})}}]).controller("TripDetailCtrl",["baseUrl","toastr","$interval","$ionicScrollDelegate","AnimateMarkerService","constants","$translate","$localStorage","$ionicPopup","$ionicSideMenuDelegate","$ionicPlatform","fireRef","$ionicModal","$ionicPopover","$timeout","$scope","$rootScope","EmployeeService",function(e,t,o,i,n,a,r,l,s,c,d,p,u,m,g,f,v,h){v.showMenuIcon=!1,f.map={},v.setMapClass("tripmapp customermap"),f.directionShowing=!0,f.$on("$ionicView.afterEnter",function(d,E){v.setMapClass("tripmapp customermap"),f.openDetail=function(e){"IMG"!==e.target.nodeName&&(f.isToggled=!f.isToggled)},f.openReceiptDetail=function(e){"IMG"!==e.target.nodeName&&(f.isReceiptToggled=!f.isReceiptToggled,f.isReceiptToggled&&g(function(){}))};var S,D,y,T,M,I,k,b,C,R=new google.maps.DirectionsService,w="accept",O=!0,P=new google.maps.DirectionsRenderer({suppressMarkers:!0,preserveViewport:!0});if(void 0!=v.detail)var A=v.detail;var L=!1;if(void 0!=v.detail){var F=A.isDriver?A.reply_to:A.sent_to;g(function(){v.$broadcast("trip:started",null)}),h.profile(F).then(function(e){f.name=e.description,v.$broadcast("trip:profile",e),h.processFirebase(),v.$broadcast("loading:hide")})}f.showTripDetail=function(){if(void 0!=A){var e=["DIRECTIONS","TRIP_INFO","PAYMENT_METHOD","PRICE","PICKUP","DROPOFF","SERVICE","SEATS","ROUTE","DATE_TIME","MILES"];r(e).then(function(e){f.accordion={},f.items=[{label:e.PAYMENT_METHOD,text:A.paymentMethod},{label:e.PICKUP,text:A.pickup},{label:e.DROPOFF,text:A.dropoff},{label:e.SERVICE,text:A.selectService},{label:e.SEATS,text:A.selectPeople},{label:e.ROUTE,text:A.route_distance+" "+e.MILES},{label:e.DATE_TIME,text:A.selectDate+" "+A.selectTime}],f.accordion.heading=e.DIRECTIONS,f.receiptaccordion=angular.copy(f.accordion),f.receiptaccordion.heading=e.TRIP_INFO,f.receiptitems=angular.copy(f.items)})}};var N=function(){return},x=f.$on("gpssuccess",function(){N()}),q=f.$on("gpserror",function(){N()});g(function(){({center:new google.maps.LatLng(v.lat,v.lon),panControl:!1,zoomControlOptions:{position:google.maps.ControlPosition.LEFT_CENTER},zoom:14,mapTypeControl:!1,mapTypeId:google.maps.MapTypeId.ROADMAP})}),f.tripStarted=!1;var z,V=f.$on("trip:started",function(e){if(f.tripStarted)return void v.$broadcast("loading:hide");if(f.tripStarted=!0,f.showMap(),A=v.detail,v.tripsInProgress.indexOf(A.id)<0&&v.tripsInProgress.push(A.id),A.isDriver){var t="accept"!=A.status||a.testMode?"tripmapp drivermap":"tripmapp beforearrived";v.setMapClass(t),c.canDragContent(!1)}else v.setMapClass("tripmapp customermap");if(f.tripmsg={},v.detail.isCustomer)if(r("TRIP_DETAIL").then(function(e){f.triptitle=e}),"accept"==A.status)var o=["MESSAGE_CUSTOMER_BEFORE_ARRIVE1","MESSAGE_CUSTOMER_BEFORE_ARRIVE2","MESSAGE_CUSTOMER_BEFORE_ARRIVE3","MESSAGE_CUSTOMER_BEFORE_ARRIVE4","MESSAGE_CUSTOMER5"];else var o=["MESSAGE_CUSTOMER1","MESSAGE_CUSTOMER2","MESSAGE_CUSTOMER3","MESSAGE_CUSTOMER4","MESSAGE_CUSTOMER5"];else var o=["MESSAGE_DRIVER1","MESSAGE_DRIVER2","MESSAGE_DRIVER3","MESSAGE_DRIVER4","MESSAGE_DRIVER5"];if(r(o).then(function(e){f.tripmsgs=[],o.forEach(function(t,o){f.tripmsgs.push({text:e[t],val:e[t]})})}),f.cancel={},v.detail.isCustomer)var i=["MESSAGE_CANCEL_CUSTOMER1","MESSAGE_CANCEL_CUSTOMER2","MESSAGE_CANCEL_CUSTOMER3","MESSAGE_CANCEL_CUSTOMER4","MESSAGE_CANCEL_CUSTOMER5","CANCEL_TRIP"];else var i=["MESSAGE_CANCEL_DRIVER1","MESSAGE_CANCEL_DRIVER2","MESSAGE_CANCEL_DRIVER3","MESSAGE_CANCEL_DRIVER4","MESSAGE_CANCEL_DRIVER5","CANCEL_TRIP"];r(i).then(function(e){f.cancelreasons=[],i.forEach(function(t,o,i){o<i.length-1&&f.cancelreasons.push({text:e[t],val:e[t]})}),f.cancelTitle=e.CANCEL_TRIP}),f.showTripDetail(),f.showDriveInfo=!1,f.showFooter=!0,p.child(A.zone_id+"/inbox/"+A.id+"/route").once("value",function(e){A=angular.extend(A,A,e.val());var t=p.child(A.zone_id+"/inbox/"+A.id+"/route/status");y=t,y.on("value",G)}),p.child(A.zone_id+"/inbox/"+A.id+"/route").on("value",z),f.initOrder()});z=function(e){A=angular.extend(A,A,e.val()),v.detail=A,be[v.detail.sent_to]=v.detail,f.detail=A,("accept"==A.status||"arrived"==A.status||"load"==A.status)&&Q(A.status);var t=A.isDriver,o=!t,i=A.status,n=A.hasOwnProperty("reply_to_message")?A.reply_to_message[Object.keys(A.reply_to_message)[Object.keys(A.reply_to_message).length-1]].status:"quote",a=A.sent_to_message[Object.keys(A.sent_to_message)[Object.keys(A.sent_to_message).length-1]].status;t&&"unload"==n||("unload"==i||"receipt"==i||"rate"==i)&&o&&"receipt"!=a&&"rate"!=a?ke():(t&&"receipt"==n||o&&("unload"==A.status||"receipt"==A.status||"rate"==A.status)&&("receipt"==a||void 0==a))&&Ee()};var U,G=function(e){var o=e.val();if(w=o,""!=A.sent_to&&(f.showDriveInfo=!0),U||(U=p.child(A.zone_id+"/queue/"+A.sent_to).on("value",oe)),f.prodMode=!0,"accept"==o){f.arrivedloadunload="ARRIVED",Q(o);var i=h.getGPSDistance(v.lat,v.lon,A.pickup_lat,A.pickup_lon)>a.arriveBtnDisabledMiles;f.prodMode=!a.testMode,A.isDriver&&f.prodMode&&!i&&!re&&le({zone_id:A.zone_id,quote_id:A.id,tripID:A.tripID,msg:"Arrived",status:5},"Arrived")}else"arrived"==o?(Q(o),f.arrivedloadunload="PICK_UP"):"load"==o?(f.arrivedloadunload="DROP_OFF",Q(o),f.disableArrive=!a.testMode&&h.getGPSDistance(v.lat,v.lon,A.dropoff_lat,A.dropoff_lon)>a.arriveBtnDisabledMiles,null!=v.arrivedModal&&1!=v.arrivedModal&&(v.arrivedModal.remove(),v.arrivedModal=null,h.isRinging()&&h.ringTone()),v.toastArrived&&(t.clear(v.toastArrived),v.toastArrived=null)):A.isDriver&&"unload"==o?ke():A.isDriver&&"receipt"==o&&(Ee(),h.removeModalPopup(v,"receiptModal"))};f.showMap=function(){g(function(){var t=new google.maps.LatLng(A.pickup_lat,A.pickup_lon),o=new google.maps.LatLng(A.dropoff_lat,A.dropoff_lon),i=new google.maps.LatLng(v.lat,v.lon),n=A.reply_to_message[Object.keys(A.reply_to_message)[Object.keys(A.reply_to_message).length-1]];v.detail&&!v.detail.driver_lat&&(v.detail.driver_lat=n.lat,v.detail.driver_lon=n.lon);var a=new google.maps.LatLng(n.lat,n.lon),r=new google.maps.LatLng(v.detail.sent_to_message[0].lat,v.detail.sent_to_message[0].lon),s={path:"M84 341c-21 0 -37 17 -37 38s16 37 37 37s37 -16 37 -37s-16 -38 -37 -38zM121 333c28 0 47 -24 47 -48v-114c0 -22 -32 -22 -32 0v105h-5v-286c0 -28 -41 -31 -43 0v165h-1h-7v-165c-1 -29 -43 -30 -43 0v286h-6v-105c0 -22 -31 -22 -31 0v114c0 24 19 48 47 48h37h37z",fillColor:"#000",fillOpacity:.9,anchor:new google.maps.Point(0,0),strokeWeight:0,scale:.08,rotation:180};l.isDriver||(k=new google.maps.Marker({position:r,map:v.map,visible:!1,icon:s})),p.child(A.zone_id+"/queue/"+A.sent_to).once("value",function(t){if(t.exists()){var o=t.val().pic;a=new google.maps.LatLng(t.val().lat,t.val().lon)}else var o=e.replace("/api/","/assets/")+"img/markers/transportation/town_car.png";var o=e.replace("/api/","/assets/")+"img/markers/transportation/town_car.png",n={url:o,scaledSize:new google.maps.Size(21,34)};"receipt"!=A.status&&"rate"!=A.status&&(A.isCustomer?T=new google.maps.Marker({position:a,map:v.map,icon:n}):k=new google.maps.Marker({position:i,map:v.map,icon:n}))}),A.isCustomer||(M=new google.maps.Marker({position:r,map:v.map,visible:!1,icon:s})),b=new google.maps.Marker({position:t,map:v.map,title:A.pickup,icon:"img/markerA.png",labelContent:"A"}),I=new google.maps.Marker({position:o,map:v.map,icon:"img/markerB.png",title:A.dropoff,labelContent:"B"});new google.maps.InfoWindow({content:A.pickup}),new google.maps.InfoWindow({content:A.dropoff}),new google.maps.InfoWindow({content:"Driver"});Q(A.status),g(function(){v.setMap()},2e3)})};var B=function(){return void f.setZoomLevel()};f.centerFitBound=function(){v.map&&B()};var j,H;f.setZoomLevel=function(){A&&A.status&&("unload"==A.status||"receipt"==A.status||"rating"==A.status?g(function(){W||n.fitBounds([new google.maps.LatLng(A.dropoff_lat,A.dropoff_lon),new google.maps.LatLng(A.pickup_lat,A.pickup_lon)],v.map)}):O&&(j=g(function(e){v.map&&e.other&&(!e.center||v.map.getCenter().lat()==e.center.lat()&&v.map.getCenter().lng()==e.center.lng()||(v.map.panTo(e.center),H=g(function(t){e.other.concat(K).forEach(function(e){t.extend(e)});var o=h.getBoundsZoomLevel(null,$(v.map.getDiv()),t);v.map.setZoom(o),h.marginZoom(v.map,e.other.concat(K)),google.maps.event.trigger(v.map,"resize")},200,null,h.getBoundsFromZoom(v.map,h.getBoundsZoomLevel(e.other.concat(K),$("#tripmap, #receiptmap, #ratingmap"))))))},0,!0,f.getLatLons())))},f.centerMap=function(){O=!0;var e=f.getLatLons();!e.center||v.map.getCenter().lat()==e.center.lat()&&v.map.getCenter().lng()==e.center.lng()||v.map.panTo(e.center),f.setZoomLevel()},f.getLatLons=function(){if(A&&A.status){var e,t;"accept"==A.status||"arrived"==A.status?(e=new google.maps.LatLng(A.pickup_lat,A.pickup_lon),t=[e]):"load"==A.status&&(e=new google.maps.LatLng(A.dropoff_lat,A.dropoff_lon),t=[e]);var o=A.driver_lat||v.detail.driver_lat,i=A.driver_lon||v.detail.driver_lon;return e&&o&&i&&t.push(new google.maps.LatLng(o,i)),{center:e,other:t}}};var Y=function(e){f.centerFitBound()},W=!1,K=[];v.showInstructions=!1;var Q=function(e){if(void 0!=v.map&&v.detail&&"receipt"!=e&&"rate"!=e&&"cancelled"!=e){var t,o;switch(e){case"accept":t=new google.maps.LatLng(v.detail.driver_lat,v.detail.driver_lon),o=new google.maps.LatLng(A.pickup_lat,A.pickup_lon);break;case"arrived":t=new google.maps.LatLng(v.detail.driver_lat,v.detail.driver_lon),o=new google.maps.LatLng(A.pickup_lat,A.pickup_lon);break;case"load":t=new google.maps.LatLng(A.pickup_lat,A.pickup_lon),o=new google.maps.LatLng(A.dropoff_lat,A.dropoff_lon);break;case"unload":t=new google.maps.LatLng(A.pickup_lat,A.pickup_lon),o=new google.maps.LatLng(A.dropoff_lat,A.dropoff_lon);break;case"receipt":t=new google.maps.LatLng(A.pickup_lat,A.pickup_lon),o=new google.maps.LatLng(A.dropoff_lat,A.dropoff_lon)}void 0==I&&ae(),v.map.directionsDisplay&&v.map.directionsDisplay.setMap(null);var i=function(){if(void 0!=t&&v.detail){var i={origin:t,destination:o,travelMode:google.maps.TravelMode.DRIVING,unitSystem:google.maps.UnitSystem.IMPERIAL};R.route(i,function(t,o){if(o==google.maps.DirectionsStatus.OK&&v.detail&&!W){v.setDirections(t);var i=t.routes[0];i.legs[0].steps.forEach(function(e,t){0==t&&K.push(new google.maps.LatLng(e.start_point.lat(),e.start_point.lng())),K.push(new google.maps.LatLng(e.end_point.lat(),e.end_point.lng()))}),Y();for(var n=0;n<i.legs.length;n++){"accept"==e||"arrived"==e?(v.$broadcast("trip:beforeArriveTime",i.legs[n].duration.text),v.$broadcast("trip:beforeArriveDist",i.legs[n].distance.text)):("load"==e||"arrived"==e)&&(v.$broadcast("trip:beforeDestTime",i.legs[n].duration.text),v.$broadcast("trip:beforeDestDist",i.legs[n].distance.text));var a=new google.maps.LatLng(A.pickup_lat,A.pickup_lon),r=new google.maps.LatLng(A.dropoff_lat,A.dropoff_lon);void 0!=b&&b.setPosition(a),void 0==I||"arrived"!=A.status&&"load"!=A.status||I.setPosition(r),f.mapInstructions=i.legs[n].steps,A.isDriver&&(f.triptitle=i.legs[n].steps[0].instructions)}}})}};i()}},Z=f.$on("trip:profile",function(e,t){v.profile=t,f.profile=t}),J=function(e){h.addNotification("arrived"),u.fromTemplateUrl("modals/arrived.html",{scope:f}).then(function(t){h.getAllDrivers()[e.zone_id]&&h.getAllDrivers()[e.zone_id][e.sent_to]?e.first_name=h.getAllDrivers()[e.zone_id][e.sent_to].first_name:p.child(e.zone_id+"/queue/"+e.sent_to).once("value",function(t){t.exists()&&(e.first_name=t.val().first_name)}),t.tripData=e,v.arrivedModal=t,f.msgArrivedNotSelected=!0,f.otherArrivedSelected=!0,t.show()})};f.arrivedmsg={};var X=["MESSAGE_ARRIVED1","MESSAGE_ARRIVED2","MESSAGE_ARRIVED3","MESSAGE_ARRIVED4","MESSAGE_ARRIVED5","CUSTOM_MESSAGE"];r(X).then(function(e){f.arrivedmsgs=[],X.forEach(function(t,o){f.arrivedmsgs.push({text:e[t],val:e[t]})})}),f.msgArrivedNotSelected=!0,f.otherArrivedSelected=!0;var ee=f.$watch("arrivedmsg.default",function(e,t,o){f.arrivedmsgs&&e==f.arrivedmsgs[f.arrivedmsgs.length-1].text?(h.isRinging()&&h.ringTone(),f.otherArrivedSelected=!1,f.msgArrivedNotSelected=!0):void 0!=e&&(h.isRinging()&&h.ringTone(),f.otherArrivedSelected=!0,f.msgArrivedNotSelected=!1)}),te=f.$watch("arrivedmsg.other",function(e,t,o){void 0==e?f.msgArrivedNotSelected=!0:""!=e.trim()&&(f.msgArrivedNotSelected=!1)});f.arrivedloadunload="ARRIVED",f.removeArrived=function(){if(null!=v.arrivedModal){h.isRinging()&&h.ringTone();var e=v.arrivedModal.tripData;v.$broadcast("loading:show");var t=void 0==f.arrivedmsg.other?f.arrivedmsg["default"]:f.arrivedmsg.other,o={zone_id:e.zone_id,quote_id:e.id,tripID:e.tripID,msg:t,status:5};h.trip(o).then(function(e){null!=v.arrivedModal&&(v.arrivedModal.remove(),v.arrivedModal=null,ye=!1,h.processFirebase()),v.$broadcast("loading:hide")})}},f.showLargImage=function(){f.allImages=[{src:f.driveInfo.pic}],f.activeSlide=0,f.showModal("popovers/image-popover.html")},f.showModal=function(e){u.fromTemplateUrl(e,{scope:f,animation:"slide-in-up"}).then(function(e){f.fullSizeImageModal=e,f.fullSizeImageModal.show()})},f.closeModal=function(){f.fullSizeImageModal.hide(),f.fullSizeImageModal.remove()},f.trip={};var oe=function(t){try{v.detail.driver_lat=t.val().lat,v.detail.driver_lon=t.val().lon;var o=(t.val().pic,new google.maps.LatLng(t.val().lat,t.val().lon));[t.val().lat,t.val().lon];if(f.driveInfo=t.val(),f.driveInfo.pic==e.replace("/api/","/assets/")+"img/markers/transportation/town_car.png"&&(f.driveInfo.pic="img/person.jpg"),A.isCustomer&&void 0!==T?T.setPosition(o):A.isCustomer||void 0===k||k.setPosition(o),
Q(w),"accept"==w){var i=h.getGPSDistance(t.val().lat,t.val().lon,A.pickup_lat,A.pickup_lon)<a.arriveBtnDisabledMiles;A.isDriver&&f.prodMode&&i&&!re&&le({zone_id:A.zone_id,quote_id:A.id,tripID:A.tripID,msg:"Arrived",status:5},"Arrived")}if("load"==w&&h.getGPSDistance(t.val().lat,t.val().lon,A.dropoff_lat,A.dropoff_lon)<a.arriveBtnDisabledMiles&&(f.disableArrive=!1),A.isDriver)if(l.tripPath||(l.tripPath={}),l.tripPath.hasOwnProperty(A.tripID)){var n=l.tripPath[A.tripID],r=+Object.keys(n)[Object.keys(n).length-1],s=n[r];(s.lat!=t.val().lat||s.lon!=t.val().lon)&&(n[r+1]={lat:t.val().lat,lon:t.val().lon})}else l.tripPath[A.tripID]={0:{lat:t.val().lat,lon:t.val().lon}}}catch(c){}};f.disableCancelTrip=!1;var ie,ne,ae=function(){},re=!1,le=function(e,o){re=!0,e.isDriver=l.tripDetail.isDriver,v.showLoader=!0,h.trip(e).then(function(e){v.$broadcast("loading:hide",!0),"Arrived"==o?(f.arrivedloadunload="PICK_UP",Q("arrived"),A.isDriver&&r("CUSTOMER_NOTIFIED").then(function(e){t.info(e)})):"Load Trip"==o?(Q("load"),f.disableCancelTrip=!0,f.arrivedloadunload="DROP_OFF",h.startTrackingTrip(),h.setTripInterval()):"UnLoad Trip"==o?h.stopTrackingTrip():"Payment Receipt"==o?f.hideReceiptModal():"Cancel Trip"==o?(h.removeModalPopup(v,"cancelTripModal"),h.endTrip(A.id)):"Send Message"==o&&(v.messageModal.remove(),v.messageModal=null,f.cancel={},f.msgNotSelected=!0,f.otherMsgSelected=!0)},function(e){v.$broadcast("loading:hide"),r(["SOMETHING_WRONG","FAILED"]).then(function(e){s.alert({title:e.FAILED,template:e.SOMETHING_WRONG})})})["finally"](function(){re=!1})},se=function(e,t,o,i,n){r([e,t,"YES","NO"]).then(function(a){var r=s.confirm({title:a[t],template:a[e],cssClass:"logoutAlert",buttons:[{text:a.NO,onTap:function(e){o.message=i}},{text:a.YES}]});r.then(function(e){r.close(),n&&n()})})};f.tripStatus=function(e){switch(e){case"ARRIVED":le({zone_id:A.zone_id,quote_id:A.id,tripID:A.tripID,msg:"Arrived",status:5},"Arrived");break;case"PICK_UP":ie={zone_id:A.zone_id,quote_id:A.id,tripID:A.tripID,status:6,message:""};var t=moment(A.selectTime,"MM/DD/YY hh:mm a");if(h.getGPSDistance(A.pickup_lat,A.pickup_lon,v.lat,v.lon)>.5){var o=function(){v.$broadcast("loading:show"),le(ie,"Load Trip")};t.diff(moment(),"minutes")>5&&(o=function(){var e="address"==ie.message?"address,time":"time";se("TIME_CORRECT","CONFIRM",ie,e,function(){v.$broadcast("loading:show"),le(ie,"Load Trip")})}),se("PICKUP_CORRECT","CONFIRM",ie,"address",o)}else t.diff(moment(),"minutes")>5?se("TIME_CORRECT","CONFIRM",ie,"time",function(){v.$broadcast("loading:show"),le(ie,"Load Trip")}):(v.$broadcast("loading:show"),le(ie,"Load Trip"));break;case"DROP_OFF":ne={zone_id:A.zone_id,quote_id:A.id,tripID:A.tripID,status:7,message:""},h.getGPSDistance(A.dropoff_lat,A.dropoff_lon,v.lat,v.lon)>.5?se("DROPOFF_CORRECT","CONFIRM",ne,"address",function(){v.$broadcast("loading:show"),le(ne,"UnLoad Trip")}):(v.$broadcast("loading:show"),le(ne,"UnLoad Trip"))}},f.receipt=function(){var e=[],t=0;f.receiptmsgs.forEach(function(o,i){o.checked&&(t++,i==f.receiptmsgs.length-1?!f.otherReceiptSelected&&f.receiptmsg.other&&e.push(t+". "+f.receiptmsg.other):e.push(t+". "+o.text))}),e=e.join(" "),0!=e.length&&le({zone_id:A.zone_id,quote_id:A.id,tripID:A.tripID,msg:e,status:8},"Payment Receipt")},f.sendMessage=function(e){if(f.otherMsgSelected||(e.$submitted=!0),f.otherMsgSelected||e.$valid){var t=f.otherMsgSelected?f.tripmsg["default"]:f.tripmsg.other;le({zone_id:A.zone_id,quote_id:A.id,tripID:A.tripID,msg:t,status:0},"Send Message")}},f.msgNotSelected=!0,f.otherMsgSelected=!0,f.sendMessageModal=function(){v.popoverMenu.hide(),u.fromTemplateUrl("modals/trip-message.html",{zone_id:A.zone_id,quote_id:A.id,tripID:A.tripID,scope:f}).then(function(e){v.messageModal=e,f.tripmsg={},f.msgNotSelected=!0,f.otherMsgSelected=!0,e.show()})};var ce=f.$watch("tripmsg.default",function(e,t,o){f.tripmsgs&&e==f.tripmsgs[f.tripmsgs.length-1].text?(f.otherMsgSelected=!1,f.msgNotSelected=!0,i.resize()):void 0!=e&&(f.otherMsgSelected=!0,f.msgNotSelected=!1,i.resize())}),de=f.$watch("tripmsg.other",function(e,t,o){void 0==e?f.msgNotSelected=!0:""!=e.trim()&&(f.msgNotSelected=!1)}),pe=f.$on("trip:beforeArriveTime",function(e,t){f.tripTime=t,f.triptext="FROM_PICKUP"}),ue=f.$on("trip:beforeArriveDist",function(e,t){f.tripDistance=t}),me=f.$on("trip:beforeDestTime",function(e,t){f.tripTime=t,f.triptext="FROM_DROPOFF"}),ge=f.$on("trip:beforeDestDist",function(e,t){f.tripDistance=t}),fe=f.$on("trip:distRem",function(e,t){f.tripDistance=t});f.removeMessageModal=function(){v.messageModal.remove(),v.messageModal=null},f.removeCancelModal=function(){v.cancelTripModal.remove(),v.cancelTripModal=null},f.reasonNotSelected=!0,f.otherSelected=!0,f.showCancelTripModal=function(){v.popoverMenu.hide(),u.fromTemplateUrl("modals/trip-cancel.html",{zone_id:A.zone_id,quote_id:A.id,tripID:A.tripID,scope:f}).then(function(e){f.cancel={},f.reasonNotSelected=!0,f.otherSelected=!0,v.cancelTripModal=e,e.show()})};var ve=f.$watch("cancel.default",function(e,t,o){f.cancelreasons&&e==f.cancelreasons[f.cancelreasons.length-1].text?(f.otherSelected=!1,f.reasonNotSelected=!0,i.resize()):void 0!=e&&(f.otherSelected=!0,f.reasonNotSelected=!1,i.resize())}),he=f.$watch("cancel.other",function(e,t,o){void 0==e?f.reasonNotSelected=!0:""!=e.trim()&&(f.reasonNotSelected=!1)});void 0!=v.cancelTripModal,f.cancelTap=function(e){if(f.otherSelected||(e.$submitted=!0),f.otherSelected||e.$valid){var t=f.otherSelected?f.cancel["default"]:f.cancel.other;le({zone_id:A.zone_id,quote_id:A.id,tripID:A.tripID,msg:t,status:-5,inbox:[A]},"Cancel Trip")}};var _e=function(){f.openDetail=function(e){"IMG"!==e.target.nodeName&&(f.isAccordToggled=!f.isAccordToggled)},f.max=5;var e=null,o=[];if(f.setRating=function(){for(var e=0,t=0;t<f.ratingChkboxes.length;t++)f.ratingChkboxes[t].isChecked&&e++;g(function(){f.rate=e})},f.name==l.name&&(f.name=""),A.isCustomer)var i=A.sent_to;else var i=A.reply_to;var n;h.profile(i).then(function(e){f.name=e.description,n=e});(function(){var t=A.isCustomer;if(e=h.getRating(A.zone_id,A.id),v.$broadcast("loading:hide"),t)var o=["RATE_DRIVER1","RATE_DRIVER2","RATE_DRIVER3","RATE_DRIVER4","RATE_DRIVER5"];else var o=["RATE_CUSTOMER1","RATE_CUSTOMER2","RATE_CUSTOMER3","RATE_CUSTOMER4","RATE_CUSTOMER5"];r(o).then(function(i){var n=[{"class":"ion-clock",text:i[o[0]],isChecked:t?e.time:e.ontime,calculated:!0},{"class":t?"ion-speedometer":"icon-pick",text:i[o[1]],isChecked:t?e.speed:e.pickup,calculated:!0},{"class":t?"ion-arrow-graph-up-right":"icon-drop",text:i[o[2]],isChecked:t?e.distance:e.dropoff,calculated:!0},{"class":t?"icon-driver":"ion-ios-locked",text:i[o[3]],isChecked:!0,calculated:!1},{"class":t?"ion-waterdrop":"ion-thumbsup",text:i[o[4]],isChecked:!0,calculated:!1}];f.ratingChkboxes=n,f.setRating()})})();if(A){var a=["TRIP_INFO","PAYMENT_METHOD","PRICE","PICKUP","DROPOFF","SERVICE","SEATS","ROUTE","DATE_TIME","MILES"];r(a).then(function(e){f.accordion={},f.ratingitems=[{label:e.PAYMENT_METHOD,text:A.paymentMethod},{label:e.PICKUP,text:A.pickup},{label:e.DROPOFF,text:A.dropoff},{label:e.SERVICE,text:A.selectService},{label:e.SEATS,text:A.selectPeople},{label:e.ROUTE,text:A.route_distance+" "+e.MILES},{label:e.DATE_TIME,text:A.selectDate+" "+A.selectTime}],f.accordion.heading=e.TRIP_INFO})}var c,d=function(){h.trip({isDriver:A.isDriver,zone_id:A.zone_id,quote_id:A.id,tripID:A.tripID,msg:o,status:9}).then(function(e){h.removeModalPopup(v,"ratingModal"),t.clear(),A.isDriver||h.endTrip(A.id),v.$broadcast("loading:hide")},function(e){_()})},p=function(){n?u(n):h.profile(A.sent_to).then(function(e){u(e)},function(){_()})},u=function(e){h.addDispatcherItem({category_id:S,name:e.description,email:e.email,cellPhone:e.phone,active:1,itemType:"Driver"}).then(function(){d()},function(){_()})},m=function(){h.deleteDispatcherItem({category_id:S,item_id:c}).then(function(){d()},function(){_()})},_=function(){v.$broadcast("loading:hide"),r(["SOMETHING_WRONG","FAILED"]).then(function(e){s.alert({title:e.FAILED,template:e.SOMETHING_WRONG})})},E=function(e){h.itemsApi("&category_id[]="+S).then(function(t){var o;t.items.some(function(e){return e.apikeypublic==A.sent_to&&(c=e.item_id,o=e.apikeypublic),o}),e&&!o?p():!e&&o?m():d()},function(){_()})},S=h.getFavGroupId(),D=!1,y=!1;f.sendRating=function(){v.$broadcast("loading:show");for(var e=0,t=0;t<f.ratingChkboxes.length;t++)f.ratingChkboxes[t].isChecked&&e++,o.push("message[]="+(f.ratingChkboxes[t].isChecked?1:0));if(A.isDriver)d();else{var i;for(var t in A.sent_to_message)if("receipt"==A.sent_to_message[t].status){i=A.sent_to_message[t].message;break}var n=["RECEIPT_CUSTOMER1","RECEIPT_CUSTOMER2","RECEIPT_CUSTOMER3","RECEIPT_CUSTOMER4","RECEIPT_CUSTOMER5"];r(n).then(function(t){n.some(function(e,o){return i.indexOf(t[e])>-1&&2==o?y=!0:i.indexOf(t[e])>-1&&3==o?D=!0:void 0}),S&&D?E(!1):5==e||y?S?E(!0):h.addGroup({name:"My A2Bers",active:1,offer:0,allow_remote_reservation:0,allow_advance_reservation:0,jail:0,services:[],tags:[]},!0).then(function(e){S=e.group_id,p()}):d()})}}},Ee=function(){"rating"!=f.showing&&(f.showing="rating",v.mapid="ratingmap",v.setMapClass("tripmapp ratingmap"),f.isDriver=A.isDriver,_e(),f.isAccordToggled=!0,g(function(){f.setZoomLevel(),google.maps.event.trigger(v.map,"resize")}))};f.showChatModal=function(){u.fromTemplateUrl("modals/chat.html",{apikey:A.isDriver?A.reply_to:A.sent_to,zone_id:A.group_id,scope:f}).then(function(e){void 0!=v.chatModal&&null!=v.chatModal&&v.chatModal.isShown()||(v.chatModal=e,e.show())})},f.removeChatModal=function(){h.removeModalPopup(v,"chatModal")},f.hideReceiptModal=function(){l.tripDetail&&Ee(),h.removeModalPopup(v,"receiptModal")};var Se=f.$on("trip:unloaded",function(e){ke()}),De=f.$on("trip:receiptsent",function(e){Ee()}),ye=!1,Te=f.$on("trip:arrived",function(e,t){ye||(ye=!0,J(t),h.stopTrackingBefore())});f.receiptNotSelected=!1,f.otherReceiptSelected=!0;var Me=f.$watch("receiptmsg.default",function(e,t,o){f.receiptmsgs&&e==f.receiptmsgs[f.receiptmsgs.length-1].text?(f.otherReceiptSelected=!1,f.receiptNotSelected=!0,g(function(){var e=_.find(i._instances,function(e){return"scroll"===e.$$delegateHandle});e.scrollBottom()})):void 0!=e&&(f.otherReceiptSelected=!0,f.receiptNotSelected=!1)}),Ie=f.$watch("receiptmsg.other",function(e,t,o){void 0==e?f.receiptNotSelected=f.receiptmsgs&&0==f.receiptmsgs.filter(function(e,t,o){return t!=o.length-1&&e.checked}).length:""!=e.trim()&&(f.receiptNotSelected=!1)});f.receiptChecked=function(e,t){e==f.receiptmsgs.length-1&&(t?(f.otherReceiptSelected=!1,g(function(){var e=_.find(i._instances,function(e){return"receiptListScroll"===e.$$delegateHandle});e.scrollBottom()}),i.resize()):(f.otherReceiptSelected=!0,i.resize())),!A.isDriver&&t&&(2==e&&f.receiptmsgs[3].checked?f.receiptmsgs[3].checked=!1:3==e&&f.receiptmsgs[2].checked&&(f.receiptmsgs[2].checked=!1)),f.receiptNotSelected=0==f.receiptmsgs.filter(function(e,t,o){var i;return i=t==o.length-1&&e.checked?f.receiptmsg.other&&""!=f.receiptmsg.other.trim():e.checked}).length},f.showTripDetail(),f.showing="trip",v.mapid="tripmap";var ke=function(){if("receipt"!=f.showing&&(f.showing="receipt",v.mapid="receiptmap",v.setMapClass("tripmapp receiptmap"),f.isDriver=A.isDriver,f.isReceiptToggled=!0,!v.receiptModal)){if(g(function(){f.setZoomLevel(),google.maps.event.trigger(v.map,"resize")}),v.receiptModal=!0,v.detail.isCustomer)var e=["RECEIPT_CUSTOMER1","RECEIPT_CUSTOMER2","RECEIPT_CUSTOMER3","RECEIPT_CUSTOMER4","RECEIPT_CUSTOMER5"];else var e=["RECEIPT_DRIVER1","RECEIPT_DRIVER2","RECEIPT_DRIVER3","RECEIPT_DRIVER4","RECEIPT_DRIVER5"];g(function(){var t=h.getRating(l.tripDetail.zone_id,l.tripDetail.id);r(e).then(function(o){f.receiptmsgs=[],f.receiptmsg={},e.forEach(function(e,i){f.receiptmsgs.push({text:o[e],val:o[e],checked:(0==i?t.time&&t.distance:!1)||(1==i?!t.time:!1)||(l.tripDetail.isDriver&&2==i?!t.distance:!1)})}),f.receiptmsg["default"]=f.receiptmsgs[0].val})},100),f.detail=v.detail,null!=v.arrivedModal&&1!=v.arrivedModal&&(v.arrivedModal.remove(),v.arrivedModal=null,h.isRinging()&&h.ringTone()),v.toastArrived&&(t.clear(v.toastArrived),v.toastArrived=null)}};m.fromTemplateUrl("popovers/trip-menu.html",{scope:f}).then(function(e){v.popoverMenu=e}),f.showSendMsg=!0,u.fromTemplateUrl("modals/order-edit.html",{scope:f}).then(function(e){f.orderModal=e,v.orderEditModal=f.orderModal}),f.openSeats=function(){g(function(){$(".ordericons").siblings("div[is-icon]").children(".ion-person-add").click()})},f.sendTripMessage=function(){v.$broadcast("loading:show"),h.trip({zone_id:A.zone_id,quote_id:A.id,tripID:A.tripID,msg:trip.msg,status:4}).then(function(e){v.$broadcast("loading:hide")})},f.showOrderModal=function(){v.popoverMenu.hide(),f.editForm=!1,f.orderModal.show()};var be={},Ce=function(){h.getTags().then(function(e){f.tags=e.tags;var t=h.getUniqueDrivers();originLoc="pickup"==Ae?Oe:v;for(var o in t)for(var i in t[o]){var n={};return void(n[o]=t[o][i])}})},Re=!1,we={},Oe={},$e=f.$on("location:searched",function(e,t){Oe=t.pickup,Re=!0,f.setTag()}),Pe=function(e,t,o){originLoc="pickup"==Ae?Oe:v,void 0==f.editorder||null==t};f.setTag=function(){var e=h.setTag(Oe,f.editorder.selectService);e>0?(we=Oe,v.$broadcast("search:location",we)):Ae=null},f.setTagMap=function(e,o,i,n){return f.services=o,f.editorder.selectedServices=f.editorder.selectService.split(","),i.length>0&&0!=f.services.length&&r(["SERVICE_REMOVED","SERVICES_NOT_AVAILABLE","SERVICE_NOT_AVAILABLE"]).then(function(e){var o=i+(i.length>1?e.SERVICES_NOT_AVAILABLE:e.SERVICE_NOT_AVAILABLE);t.info(o,e.SERVICE_REMOVED),g(function(){$("#serviceIcon ion-item").click()})}),f.totalDrivers=e,v.$broadcast("search:location",we),Re=!1,!0};var Ae,Le=f.$on("queue:updated",Pe),Fe=f.$on("queue:added",Pe),Ne=f.$on("queue:removed",Pe),xe=f.$on("order:edited",function(){f.initOrder()});f.services=[],r("SELECT_SERVICE").then(function(e){f.services_text_single=e}),f.val={single:null,multiple:null},f.setServiceCheckMark=function(){f.services.forEach(function(e){e.id==f.editorder.selectService?e.checked=!0:e.checked=!1})},f.serviceSelected=function(e){if(void 0!=e){f.editorder.selectService=e.replace(/;/g,",");var t=f.driveInfo.tags.filter(function(e){return f.tags.indexOf(e)>-1});L=f.editorder.selectService.split(",").some(function(e){return t.indexOf(e)<0})}},f.saveDateTime=function(e){f.editorder.selectDate=moment(new Date(e)).format("MM/DD/YY"),f.editorder.selectTime=moment(new Date(e)).format("hh:mm a"),f.editorder.time=f.editorder.selectDate+" "+f.editorder.selectTime;var t=moment(f.editorder.time,"MM/DD/YY hh:mm a"),o=moment();L=t.diff(o,"minutes")>20},f.setCarIcon=function(){f.services.forEach(function(e){f.editorder.selectService==e.id&&(f.serviceImg=e.icon)}),0==f.services.length&&(f.serviceImg="pics/taxi.png")},f.showService=function(e){g(function(){$("#servicespanel ion-item").click()})};var qe,ze;f.initOrder=function(){f.editorder=angular.copy(v.detail),f.setCarIcon(),f.editorder.time=f.editorder.selectDate+" "+f.editorder.selectTime,qe=f.editorder.pickup,ze=f.editorder.dropoff,f.seatsModel={setFunc:function(e){return angular.isDefined(e)?f.editorder.selectPeople=e:f.editorder.selectPeople}},Ce()};var Ve,Ue=function(){var e=i._instances,t=_(e).find(function(e){return"edit-page"===e.$element[0].id});t.scrollTop(!0)};f.edit=function(){Ve=angular.copy(f.editorder),f.editForm=!0,Ue()},f.cancelEdit=function(){f.editorder=Ve,f.setCarIcon(),f.editForm=!1,Ue()},f.orderChanged=function(e){e.hasOwnProperty("pickup")&&(f.editorder.pickup_lat=e.pickup.lat,f.editorder.pickup_lon=e.pickup.lon,f.editorder.pickup=e.pickup.formatted_address),e.hasOwnProperty("dropoff")&&(f.editorder.dropoff_lat=e.dropoff.lat,f.editorder.dropoff_lon=e.dropoff.lon,f.editorder.dropoff=e.dropoff.formatted_address),e.hasOwnProperty("range")&&(f.editorder.range=e.range),e.hasOwnProperty("price")&&(f.editorder.price=e.price),e.hasOwnProperty("timezone")&&(f.editorder.timezone=f.timezone=e.timezone),Ge()};var Ge=function(){if(f.editorder.pickup!=qe||f.editorder.dropoff!=ze){qe=f.editorder.pickup,ze=f.editorder.dropoff;var e=new google.maps.LatLng(f.editorder.pickup_lat,f.editorder.pickup_lon),t=new google.maps.LatLng(f.editorder.dropoff_lat,f.editorder.dropoff_lon),o={origin:e,destination:t,travelMode:google.maps.TravelMode.DRIVING};R.route(o,function(e,t){if(t==google.maps.DirectionsStatus.OK)for(var o=e.routes[0],i=0;i<o.legs.length;i++)f.editorder.eta_distance=o.legs[i].distance.value/1609,f.editorder.eta_time=o.legs[i].duration.value/60,f.editorder.route_distance=(o.legs[i].distance.value/1609).toFixed(1)})}};f.save=function(){v.$broadcast("loading:show"),h.setQuoteDateTime(f.editorder);var e=p.child(A.zone_id+"/inbox/"+A.id+"/route");e.update({selectDate:f.editorder.selectDate,selectTime:f.editorder.selectTime,selectPeople:f.editorder.selectPeople,selectService:f.editorder.selectService,route_distance:f.editorder.route_distance,eta_distance:f.editorder.eta_distance,eta_time:f.editorder.eta_time,pickup:f.editorder.pickup,dropoff:f.editorder.dropoff,pickup_lat:f.editorder.pickup_lat,pickup_lon:f.editorder.pickup_lon,dropoff_lat:f.editorder.dropoff_lat,dropoff_lon:f.editorder.dropoff_lon,price:f.editorder.price,range:f.editorder.range},function(t){if(v.$broadcast("loading:hide"),t)r(["FAILED","ORDER_UPDATE_FAIL"]).then(function(e){s.alert({title:e.FAILED,template:e.ORDER_UPDATE_FAIL})});else{Ve=v.detail,f.cancelEdit();var o=v.detail.isCustomer?"sent_to_message":"reply_to_message",i=v.detail[o],n=parseInt(Object.keys(i)[Object.keys(i).length-1])+1,a=i;L?le({zone_id:A.zone_id,quote_id:A.id,tripID:A.tripID,msg:"Cancelled",status:-5,inbox:[A]},"Cancel Trip"):(a[n]={lat:v.lat,lon:v.lon,update_time:moment().format("MM/DD/YY HH:mm:ss"),status:"order_edited",message:"Order Edited"},e.child(o).set(a,function(e){e||f.initOrder()}))}})};var Be=f.$on("location:updated",function(e){void 0!=v.map&&void 0!=k&&k.setPosition(new google.maps.LatLng(v.lat,v.lon))});f.$on("$ionicView.beforeLeave",function(){W=!0,v.showMenuIcon=!0,void 0!=C&&o.cancel(C),L&&v.$broadcast("resend_quote",A),A&&(p.child(A.zone_id+"/inbox/"+A.id+"/route").off("value",z),p.child(A.zone_id+"/queue/"+A.sent_to).off("value",oe),y&&y.off("value",G)),Ne&&Ne(),Fe&&Fe(),Le&&Le(),xe&&xe(),Te&&Te(),Se&&Se(),fe&&fe(),ge&&ge(),me&&me(),ue&&ue(),pe&&pe(),V&&V(),Z&&Z(),x&&x(),q&&q(),Be&&Be(),$e&&$e(),Ie&&Ie(),Me&&Ie(),he&&he(),ve&&ve(),de&&de(),ce&&ce(),te&&te(),ee&&te(),De&&De(),h.removeModalPopup(v,"popoverMenu"),h.removeModalPopup(v,"arrivedModal"),h.removeModalPopup(f,"seatsModal"),h.removeModalPopup(f,"orderModal"),h.removeModalPopup(f,"receiptModal"),h.removeModalPopup(f,"ratingModal"),h.removeModalPopup(f,"cancelTripModal"),h.removeModalPopup(f,"messageModal"),h.removeModalPopup(f,"instructionsModal"),h.removeModalPopup(f,"fullSizeImageModal"),S&&google.maps.event.removeListener(S),D&&google.maps.event.removeListener(D),b&&b.setMap(null),I&&I.setMap(null),T&&T.setMap(null),k&&k.setMap(null),M&&M.setMap(null),v.map.directionsDisplay&&v.map.directionsDisplay.setMap(null),P.setMap(null),v.resetMap(),v.receiptModal=null,j&&g.cancel(j),H&&g.cancel(H)})})}]).controller("JailCtrl",["$timeout","$scope","$rootScope",function(e,t,o){}]).controller("QuoteCtrl",["$ionicScrollDelegate","ApiParamService","$ionicSideMenuDelegate","baseUrl","Initializer","Internet","$ionicPopover","AnimateMarkerService","$ionicLoading","constants","toastr","$translate","$localStorage","$filter","$ionicModal","$ionicPopup","$ionicPlatform","$rootScope","$scope","$timeout","EmployeeService",function(e,t,o,i,n,a,r,l,s,c,d,p,u,m,g,f,v,h,_,E,S){_.map={},_.$on("$ionicView.afterEnter",function(t,a){h.setMapClass("quotemap"),_.view_loaded=!0;var m=h.$watch("quoteQMode",function(e,t){e!=t&&(u.quoteQMode=h.quoteQMode,_.serviceSelected())});o.canDragContent(!1);_.mypic=u.picData,_.myrating=5,_.popoverDiscount=r.fromTemplate(['<ion-popover-view style="height: 50px;">',"<ion-content>",'<div id="discount" class="item-input-inset search-bar">','<label class="item-input-wrapper">','<i class="icon ion-ios7-search placeholder-icon"></i>','<input id="searchKey" type="search" placeholder="{{ \'DISCOUNT_CODE\' | translate }}" ng-model="coupon" autocorrect="off">',"</label>",'<span ng-click="setDiscountCode(coupon)" ng-class="(coupon.length > 0) ? \'ion-checkmark\' : \'\'" class="button button-clear ft25"></span>',"</div>","<div id=\"discount\" style=\"margin:10px\" ng-if=\"!validCoupon\" class=\"form-errors\" ng-messages=\"{'incorrect_code': invalid_reason == 'code', 'no_drivers': invalid_reason == 'driver', 'not_in_range': invalid_reason == 'range'}\">","<div class=\"form-error\" ng-message-exp=\"['incorrect_code']\">{{'INVALID_COUPON'|translate}}</div>","<div class=\"form-error\" ng-message-exp=\"['no_drivers']\">{{'COUPON_NO_DRIVERS'|translate}}</div>","<div class=\"form-error\" ng-message-exp=\"['not_in_range']\">{{'COUPON_NOT_IN_RANGE'|translate}}</div>","</div>","</ion-content>","</ion-popover-view>"].join(""),{scope:_});var D,y=!1;_.validCoupon=!0;var T=h.$on("search:location",function(e,t){y&&(y=!1,t&&t.coupon?(h.$broadcast("validcoupon",D),h.$broadcast("loading:hide"),_.popoverDiscount.hide(),_.validCoupon=!0):(_.invalid_reason="driver",_.validCoupon=!1,h.$broadcast("loading:hide")))});_.setDiscountCode=function(e){"NO_DRIVER"!=_.quoteBtnText&&(h.$broadcast("loading:show",{text:"VALIDATING_COUPON"}),S.coupon(e).then(function(e){"Success"==e.status?(D=JSON.parse(e.data.settings),S.getGPSDistance(D.pickup_lat,D.pickup_lon,h.lat,h.lon)>1?(_.invalid_reason="range",_.validCoupon=!1,h.$broadcast("loading:hide")):(y=!0,h.$broadcast("location:searched",{pickup:{lat:D.pickup_lat,lon:D.pickup_lon,coupon:!0}}))):(_.invalid_reason="code",_.validCoupon=!1,h.$broadcast("loading:hide"))}),_.quoteForm.coupon=e)},_.rangeAvailable=!1,_.emptyQueue=!1,_.quoteForm={},_.quoteForm.pickup={},_.setEmptyQueue=function(e){_.emptyQueue!=e&&(_.emptyQueue=e,e?$("#quotemap").css({opacity:0,zoom:0}):$("#quotemap").css({opacity:1,zoom:1}))},_.quoteBtnText="NO_DRIVER";var M,I,k,b,C,R=!1;_.pickupSelected=!1;var w,O=!0,P=null,A=!1,L=!1,F=function(){P=S.pickupCenterZone(_.quoteForm.pickup.lat,_.quoteForm.pickup.lon),A=P};_.changed=function(e){e&&(e.hasOwnProperty("pickup")&&(B=!0,_.quoteForm.pickup=e.pickup,F()),e.hasOwnProperty("dropoff")&&(j=!0,_.quoteForm.dropoff=e.dropoff),e.hasOwnProperty("range")&&(_.quoteForm.range=e.range),e.hasOwnProperty("price")&&(_.quoteForm.price=e.price),S.getTimeZone(e.pickup.lat,e.pickup.lon).then(function(e){_.timezone=e.timeZoneId})),void 0!=_.quoteForm.pickup&&(R=!0,M="pickup",J=!0,X=_.quoteForm.pickup),W(),G?0==_.quoteForm.service.length&&(_.quoteBtnText="SELECT_SERVICE"):_.quoteBtnText="SET_A_B";var t=S.getTagsDriverMap();for(var o in t)t[o]={};_.services.length=0,ae.length=0,_.serviceSelected()},_.pickupChanged=function(){B=!0,_.changed()},_.dropoffChanged=function(){j=!0,_.changed()};var N,x,q,z,V,U=[],G=!1,B=!1,j=!1,H=!1,Y=!1,W=function(){if(null!=M&&(B||j)&&(_.quoteForm.pickup!=I||_.quoteForm.dropoff!=k)){G=!0,_.detailsNotFilled=!1,I=_.quoteForm.pickup,k=_.quoteForm.dropoff,N=new google.maps.LatLng(_.quoteForm.pickup.lat,_.quoteForm.pickup.lon),x=new google.maps.LatLng(_.quoteForm.dropoff.lat,_.quoteForm.dropoff.lon),_.centerMap(_.quoteForm.pickup.lat,_.quoteForm.pickup.lon),h.map.directionsDisplay&&h.map.directionsDisplay.setMap(null),b.setMap(null),void 0!=z&&z.setMap(null),void 0!=V&&V.setMap(null),z=new google.maps.Marker({position:N,draggable:!0,visible:!1,icon:pe}),V=new google.maps.Marker({position:x,draggable:!0,visible:!1,icon:ue});var e={origin:N,destination:x,travelMode:google.maps.TravelMode.DRIVING};C.route(e,function(e,t){if(t==google.maps.DirectionsStatus.OK){for(var o=e.routes[0],i=0;i<o.legs.length;i++)_.estDist=(o.legs[i].distance.value/1609).toFixed(1),_.estTime=o.legs[i].duration.text,_.quoteForm.estDistVal=o.legs[i].distance.value/1609,_.quoteForm.estTimeVal=o.legs[i].duration.value/60,_.pickupSelected=!0,_.quoteForm.distance=_.estDist,0!=_.quoteForm.service.length&&w&&(_.quoteBtnText="REVIEW");l.fitBounds([N,x],h.map),H=!1,Y=!1}})}};_.totalDrivers=0;var R=!1,K={},Q={},Z=function(e,t,o){null==t||S.getGlobalGroups().indexOf(t[Object.keys(t)[0]].group_id)<0||(Q="pickup"==M?X:h,S.setTagMap(o,t,Q,_.services,ae,_.quoteForm.service,function(e,t,o,i,n,a,r,l){_.setTagMap(e,t,o,i,n,a,r,l)},oe,null,null,!0,_.quoteForm.range,P))},J=!1,X={},ee=_.$on("location:searched",function(e,t){X=t.pickup,J=!0,_.setTag()}),te=_.$on("resend_quote",function(e,t){_.quoteForm.splitFare=["splitFare[]="],_.quoteForm.date=t.selectDate,_.quoteForm.time=t.selectTime,_.quoteForm.service=t.selectService,_.quoteForm.people=t.selectPeople,_.quoteForm.distance=t.route_distance,_.quoteForm.estDistVal=t.eta_distance,_.quoteForm.estTimeVal=t.eta_time,_.quoteForm.note=t.note.join(","),_.quoteForm.pickup={},_.quoteForm.pickup.formatted_address=t.pickup,_.quoteForm.pickup.lat=t.pickup_lat,_.quoteForm.pickup.lon=t.pickup_lon,_.quoteForm.dropoff={},_.quoteForm.dropoff.formatted_address=t.dropoff,_.quoteForm.dropoff.lat=t.dropoff_lat,_.quoteForm.dropoff.lon=t.dropoff_lon,_.totalDrivers>0?(_.sendQuote(!0),ke(),d.info("Resending Quote","QUOTE")):(h.$broadcast("loading:hide"),d.info("No Driver","NO DRIVER"))});_.quoteForm.services=[];var oe={nearestDriverDist:12e3,furthestDriverDist:0,nearestDriverTime:1e4,furthestDriverTime:0},oe={};_.detailsNotFilled=!0,_.openService=function(){E(function(){$("#serviceIcon ion-item").trigger("click")})};var ie=["NOTES_DRIVER1","NOTES_DRIVER2","NOTES_DRIVER3","NOTES_DRIVER4","NOTES_DRIVER5"];p(ie).then(function(e){_.notess=[],_.translatedText={},ie.forEach(function(t,o){_.notess.push({text:e[t],checked:!1}),_.translatedText[t]=e[t]})}),_.noteChecked=function(t){var o;_.notes.forEach(function(e){e.checked&&(o=e)}),void 0!=o?o==t?t.checked=!t.checked:(o.checked=!1,t.checked=!0):t.checked=!0,t.text==_.translatedText.NOTES_DRIVER5?(_.otherNoteSelected=!1,E(function(){$("textarea").focus()})):_.otherNoteSelected=!0,e.resize()},_.openInstructions=function(){if(_.notes=angular.copy(_.notess),null!=_.instructionsModal)return void _.instructionsModal.show();g.fromTemplateUrl("modals/quote-note.html",{scope:_,animation:"slide-in-up",backdropClickToClose:!1}).then(function(e){_.otherNoteSelected=!0,_.quotenote={},_.instructionsModal=e,e.show()})},_.quoteForm.note="",_.saveInstructions=function(){_.quoteForm.note="",_.notess=angular.copy(_.notes),_.notes.forEach(function(e){e.checked&&(e.text==_.translatedText.NOTES_DRIVER5?_.quoteForm.note=_.quotenote.other:_.quoteForm.note=e.text)}),_.instructionsModal.hide()},E(function(){h.lat&&S.getTags().then(function(e){_.tags=e.tags,_.serviceSelected(),S.isInitializingFB()||(_.driversInspected=!0)})},100);var ne=_.$on("trip:ended",function(){_.serviceSelected(),E(function(){_.serviceSelected()},2e3)});_.services=[];var ae=[];p("SELECT_SERVICE").then(function(e){_.services_text_single=e}),_.val={single:null,multiple:null},_.setServiceCheckMark=function(){_.services.forEach(function(e){e.id==_.quoteForm.service?e.checked=!0:e.checked=!1})},_.quoteForm.service=null,_.setCarIcon=function(){_.services.forEach(function(e){_.quoteForm.service==e.id&&(_.serviceImg=e.icon)}),null==_.quoteForm.service&&_.services.length>0&&(_.serviceImg=_.services[0].icon),0==_.services.length&&(_.serviceImg="pics/taxi.png")},_.setCarIcon(),_.showService=function(){_.setServiceCheckMark()},_.setTag=function(){var e=S.setTag(X,_.quoteForm.service);if(K=X,e>0)h.$broadcast("search:location",K);else{var t=!1,o=S.getDispatcherGroups().length>0,i=S.getGlobalGroups();i.some(function(e){return t=S.withinZone(e,!1,K.lat,K.lon)}),t&&o?h.$broadcast("search:location",K):(R=!1,p(["SORRY","NO_DRIVERS_PICKUP","NO_DRIVERS_AREA"]).then(function(e){var o=t?e.NO_DRIVERS_AREA:e.NO_DRIVERS_PICKUP;l.setStopMovingMarker(!1),J&&(d.error(o,e.SORRY),h.$broadcast("search:location",null),J=!1)}),M=null)}},_.centerMap=function(e,t){O=!0;var o=e||h.lat,i=t||h.lon;new google.maps.LatLng(o,i);h.centerMap(e,t)};var re=_.$on("fb:initialized",function(e,t){_.serviceSelected(),_.driversInspected=!0}),le=_.$on("groups_set",function(e,t){_.serviceSelected()});_.allow_advance_reservation=h.allow_advance_reservation,_.allow_remote_reservation=h.allow_remote_reservation,_.setTagMap=function(e,t,o,i,n,a,r,l){if(r&&(r.allow_advance_reservation&&(_.allow_advance_reservation=Math.max(_.allow_advance_reservation,r.allow_advance_reservation)),r.allow_remote_reservation&&(_.allow_remote_reservation=Math.max(_.allow_remote_reservation,r.allow_remote_reservation))),_.driversInspected=!0,_.services=t,_.servicesDetail=S.getTagsDriverMap(),Object.keys(i).length>0&&(oe=i,_.rangeAvailable=!0,_.nearestTime=i.nearestDriverTime,_.furthestTime=i.furthestDriverTime),o.length>0&&""!=_.quoteForm.service&&_.services.length>0&&p(["SERVICE_REMOVED","SERVICES_NOT_AVAILABLE","SERVICE_NOT_AVAILABLE"]).then(function(e){var t=o+(o.length>1?e.SERVICES_NOT_AVAILABLE:e.SERVICE_NOT_AVAILABLE);d.info(t,e.SERVICE_REMOVED),_.services.length>1&&(_.alertPopup&&_.alertPopup.hide(),E(function(){$("#serviceIcon ion-item").click()}))}),_.totalDrivers=e,void 0!=a&&(h.driversAvailable=a),0==_.totalDrivers){if(P&&l&&L&&(P=null,_.serviceSelected()),0==_.services.length){if("pickup"!=M){S.driversAvailable()?_.quoteBtnText="SET_A_B":(_.quoteBtnText="NO_DRIVER",h.$broadcast("hide:gplace"),h.$broadcast("hide:fancy"));new google.maps.LatLng(h.lat,h.lon);_.centerMap(h.lat,h.lon),h.map.setZoom(14),_.totalDrivers=0,G=!1,I=void 0,M=null,_.pickupSelected=!1,_.nearestTime=null,_.alertPopup&&_.alertPopup.hide()}return M=null,!1}}else{if(!n)return!P&&A&&l&&(F(),_.serviceSelected()),J?(h.$broadcast("search:location",K),J=!1):W(),G?_.quoteForm.range||(_.quoteBtnText="SET_RANGE"):_.quoteBtnText="SET_A_B",G&&_.quoteForm.range&&!w&&(1==_.services.length?(_.quoteForm.service=_.services[0].text,_.quoteBtnText="REVIEW",w=!0):_.services.length>1&&(_.quoteBtnText="SELECT_SERVICE")),void 0!=N&&(U[0]=N,U[1]=x),!0;_.quoteBtnText="SET_RANGE",_.quoteForm.range=null,_.alertPopup&&_.alertPopup.hide(),M=null}};var w=!1;_.serviceSelected=function(e){S.resetETA(),e&&(w=!0);var t=S.getUniqueDrivers();Q="pickup"==M?X:h;var o=Object.keys(t).length,i=0,n=0,a=0;L=!1;var r;for(var l in t){n++,i=Object.keys(t[l]).length,a=0;for(var s in t[l]){if(a++,a==i&&(L=!0),S.getGlobalGroups().indexOf(s)>-1){var c={};c[l]=t[l][s],S.setTagMap("updated",c,Q,_.services,ae,_.quoteForm.service,function(e,t,o,i,n,a,l,s){r=_.setTagMap.bind(null,e,t,o,i,n,a,l,s)},oe,null,null,!0,_.quoteForm.range,P)}n==o&&a==i&&r&&r()}}G&&(!_.quoteForm.range&&_.totalDrivers>0?_.quoteBtnText="SET_RANGE":0==_.quoteForm.service.length?_.quoteBtnText="SELECT_SERVICE":_.quoteBtnText="REVIEW")},Object.keys(S.getTagsDriverDefault()).length>0&&(_.driversInspected=!0),_.saveDateTime=function(e){_.quoteForm.date=moment(new Date(e)).format("MM/DD/YY"),_.quoteForm.time=moment(new Date(e)).format("hh:mm a")};var se,ce,de,pe,ue,me,ge=function(e,t,o,i){geocoder=new google.maps.Geocoder,geocoder.geocode({latLng:e},function(e,n){n==google.maps.GeocoderStatus.OK&&("pickup"==t?(_.quoteForm.pickup={},_.quoteForm.pickup.formatted_address=e[0].formatted_address,_.quoteForm.pickup.lat=e[0].geometry.location.lat(),_.quoteForm.pickup.lon=e[0].geometry.location.lng(),$(".ion-google-place-container.modal").is(":visible")&&h.$broadcast("posFetched")):(_.quoteForm.dropoff={},_.quoteForm.dropoff.formatted_address=e[0].formatted_address,_.quoteForm.dropoff.lat=e[0].geometry.location.lat(),_.quoteForm.dropoff.lon=e[0].geometry.location.lng()),void 0==o&&(B||j)&&_.changed(),_.$broadcast("markerPos",{type:t,address:e[0].formatted_address}),i&&$("#icon-pickup").click())})},fe=!1,ve=_.$on("gmaps:loaded",function(){_e()}),he=function(e,t,o,a){n.mapsInitialized().then(function(){if(!fe&&!h.isOffline&&h.map){fe=!0;var n=new google.maps.Geocoder;C=new google.maps.DirectionsService,b=new google.maps.DirectionsRenderer({suppressMarkers:!0,preserveViewport:!0}),se=_.$on("queue:updated",Z),ce=_.$on("queue:added",Z),de=_.$on("queue:removed",Z),
me={url:"img/needle.png"},pe={url:"img/markerA.png"},ue={url:"img/markerB.png"};var r=new google.maps.LatLng(e,t);({center:r,zoom:14,zoomControlOptions:{position:google.maps.ControlPosition.LEFT_CENTER},panControl:!1,mapTypeControl:!1,mapTypeId:google.maps.MapTypeId.ROADMAP,maxZoom:17});if(u.isDriver){({url:i.replace("/api/","/assets/")+"img/markers/transportation/town_car.png",scaledSize:new google.maps.Size(21,34)})}else{({path:"M84 341c-21 0 -37 17 -37 38s16 37 37 37s37 -16 37 -37s-16 -38 -37 -38zM121 333c28 0 47 -24 47 -48v-114c0 -22 -32 -22 -32 0v105h-5v-286c0 -28 -41 -31 -43 0v165h-1h-7v-165c-1 -29 -43 -30 -43 0v286h-6v-105c0 -22 -31 -22 -31 0v114c0 24 19 48 47 48h37h37z",fillColor:"#000",fillOpacity:.9,anchor:new google.maps.Point(0,0),strokeWeight:0,scale:.08,rotation:180})}_.centerMap();if(q=new google.maps.Marker({position:r,map:h.map,draggable:!1,visible:!1,icon:me}),z=new google.maps.Marker({position:r,map:h.map,draggable:!0,visible:!1,icon:pe}),V=new google.maps.Marker({position:new google.maps.LatLng(r.lat(),r.lng()+.008),map:h.map,draggable:!0,visible:!1,icon:ue}),ge(z.getPosition(),"pickup"),ge(V.getPosition(),"dropoff"),google.maps.event.addListener(h.map,"dragend",function(){O=!1}),n.geocode({latLng:r},function(e,t){t==google.maps.GeocoderStatus.OK&&e[0]?(_.quoteForm.pickup.lat=e[0].geometry.location.lat(),_.quoteForm.pickup.lon=e[0].geometry.location.lng(),_.$broadcast("markerPos",{type:"pickup",address:e[0].formatted_address}),h.$broadcast("loading:hide")):h.$broadcast("loading:hide")}),void 0!=o){var l=new google.maps.LatLng(o,a);n.geocode({latLng:l},function(e,t){t==google.maps.GeocoderStatus.OK&&e[0]?(_.quoteForm.dropoff=e[0],h.$broadcast("loading:hide"),E(function(){_.changed()},1e3)):h.$broadcast("loading:hide")})}}})};_.resetQuoteForm=function(){if(O=!0,_.quoteForm.splitFare=["splitFare[]="],_.quoteForm.date=moment(new Date).format("MM/DD/YY"),_.quoteForm.time=moment(new Date).format("hh:mm a"),_.quoteForm.service="",E(function(){h.$broadcast("resetfancy")}),_.quoteForm.people=1,_.quoteForm.range=null,_.quoteForm.price=null,_.quoteForm.mode=null,_.instructionsModal&&(_.instructionsModal.remove().then(function(){_.instructionsModal=null}),_.notes.forEach(function(e){e.checked=!1})),G=Y=H=R=_.pickupSelected=!1,M=I=k=void 0,P=null,h.map){if(_.serviceSelected(),z){var e=new google.maps.LatLng(h.lat,h.lon);z.setPosition(e),V.setPosition(new google.maps.LatLng(e.lat(),e.lng()+.008))}_.centerMap(h.lat,h.lon),h.map.setZoom(14),b&&b.setMap(null)}w=!1,_.timezone=h.tz,_.$broadcast("resetDtPicker"),M=null},S.isViewingRates()&&h.openOrderForm(),_.resetQuoteForm();var _e=function(){S.isInitializingFB()?h.$broadcast("loading:show",{text:"WAIT"}):null!=u.lastTrip&&S.getAllUniqueDrivers().length>0?v.ready(function(){he(h.lat,h.lon,u.lastTrip.pickup_lat,u.lastTrip.pickup_lon)}):null!=h.lat?v.ready(function(){he(h.lat,h.lon)}):v.ready(function(){S.setLatLon().then(function(){he(h.lat,h.lon)})})};_e();var Ee=_.$on("firebaseInitialized",function(e){_e()}),Se=_.$on("gps:connected",function(e){_e()});l.setStopMovingMarker(!1);var De=_.$on("location:updated",function(e){_.serviceSelected(),void 0==h.map?h.setMap():O&&!G&&q&&(_.centerMap(),q.setPosition(new google.maps.LatLng(h.lat,h.lon)))});_.quoteButtonTapped=function(e){if("SELECT_SERVICE"==_.quoteBtnText)E(function(){$("#serviceIcon ion-item").click()});else if("SET_A_B"==_.quoteBtnText||"SET_RANGE"==_.quoteBtnText){$("#icon-pickup").click();var t=h.map.getCenter(),o=new google.maps.LatLng(h.map.getCenter().lat(),h.map.getCenter().lng()+.008);ge(t,"pickup",!0),ge(o,"dropoff",!0)}else"REVIEW"==_.quoteBtnText&&_.sendQuote()},_.confirm=function(){ke()},_.reset=function(){_.alertPopup.hide(),_.resetQuoteForm()},_.editPickup=function(e){E(function(){$("#icon-pickup").trigger("click",[e])})},_.editService=function(){E(function(){$("#serviceIcon ion-item").click(),_.overlayModal()})},_.editSeats=function(){E(function(){$("div[people] .button-icon").click(),_.overlayModal()})},_.editDate=function(){E(function(){$("date-picker .button-icon").click(),_.overlayModal()})},_.editNotes=function(){_.openInstructions(),_.overlayModal()},_.overlayModal=function(){$('.modal:not(".confirmquoteModal")').parent().closest("div.modal-backdrop").css("zIndex",50)},_.$on("$ionicView.beforeLeave",function(){T&&T(),m&&m(),S.removeModalPopup(_,"seatsModal"),S.removeModalPopup(_,"instructionsModal"),S.removeModalPopup(_,"popoverDiscount"),ye&&ye(),Te&&Te(),ve&&ve(),Se&&Se(),Ee&&Ee(),de&&de(),ce&&ce(),se&&se(),De&&De(),ee&&ee(),re&&re(),le&&le(),te&&te(),_.popoverDiscount.remove(),_.popoverDiscount=null,h.map&&(google.maps.event.clearInstanceListeners(z),google.maps.event.clearInstanceListeners(V),z.setMap(null),V.setMap(null),q&&q.setMap(null),z=null,V=null),h.resetMap(),U=[],_.map.map&&_.map.map.setZoom(14),S.resetDispatcherTagMap(),S.removeModalPopup(_,"alertPopup"),ne&&ne(),Me&&Me()}),_.send=function(){S.removeModalPopup(_,"alertPopup"),_.driversInspected=!1,ke()},_.sendQuote=function(e){p(["CONFIRM","ERROR","CURRENTLY_NO_DRIVERS","SORRY","NO_DRIVERS_PICKUP","ENTER_PICKUP_LOC","ENTER_DROPOFF_LOC"]).then(function(t){if(void 0==_.quoteForm.pickup)return void d.error(t.ENTER_PICKUP_LOC,t.ERROR);if(void 0==_.quoteForm.dropoff)return void d.error(t.ENTER_DROPOFF_LOC,t.ERROR);if(void 0==e){if(null!=_.alertPopup)return void _.alertPopup.show();g.fromTemplateUrl("modals/confirmquote.html",{scope:_,animation:"slide-in-up",backdropClickToClose:!1}).then(function(e){_.alertPopup=e,e.show()})}})};var ye=_.$on("quoteaccepted",function(){_.quoteSentMsg=null,h.$broadcast("loading:hide")}),Te=_.$on("quotecancelled",function(e,t){_.quoteSentMsg==t&&p(["SORRY","QUOTE_NOT_ACCEPTED"]).then(function(e){_.quoteSentMsg=null,d.error(e.QUOTE_NOT_ACCEPTED,e.SORRY),h.$broadcast("loading:hide")})}),Me=_.$on("validcoupon",function(e,t){_.quoteForm.dropoff.formatted_address=t.dropoff,_.quoteForm.dropoff.lat=t.dropoff_lat,_.quoteForm.dropoff.lon=t.dropoff_lon,_.quoteForm.people=t.selectPeople,_.quoteForm.service=t.selectService,_.quoteForm.coupon=t.coupon,_.quoteForm.price=t.price,_.quoteForm.range=c.defaultMilesRadius,_.quoteForm.mode="offer";var o={origin:new google.maps.LatLng(h.lat,h.lon),destination:new google.maps.LatLng(_.quoteForm.dropoff.lat,_.quoteForm.dropoff.lon),travelMode:google.maps.TravelMode.DRIVING};C.route(o,function(e,t){if(t==google.maps.DirectionsStatus.OK)for(var o=e.routes[0],i=0;i<o.legs.length;i++)_.estDist=(o.legs[i].distance.value/1609).toFixed(1),_.estTime=o.legs[i].duration.text,_.quoteForm.estDistVal=o.legs[i].distance.value/1609,_.quoteForm.estTimeVal=o.legs[i].duration.value/60,_.pickupSelected=!0,_.quoteForm.distance=_.estDist,ke()})}),Ie=!1,ke=function(){Ie=!0,h.showLoader=!0,h.$broadcast("loading:show",{text:"SEND_RIDE_REQ"}),_.quoteForm.items=[],_.quoteForm.group_id=[],_.quoteForm.zone_id=[],_.quoteForm.pickup_zone=[];var e=S.getAllDrivers();u.isDriver||null==S.getEmployees()||S.getEmployees().forEach(function(e){e.apikeypublic==window.localStorage.getItem("apikeypublic")&&e.hasOwnProperty("tags")&&e.tags.indexOf("Customer")>-1&&_.quoteForm.group_id.indexOf("group_id[]="+e.category_id)<0&&_.quoteForm.group_id.push("group_id[]="+e.category_id)});var t=0==_.totalDrivers?S.getTagsDispatcherMap():S.getTagsDriverMap();for(var o in e){var i=e[o];for(var n in i)_.quoteForm.service.split(",").forEach(function(e,a){if(t[e].hasOwnProperty(n)&&t[e][n].indexOf(i[n].group_id)>-1){var r=i[n];_.totalDrivers>0&&_.quoteForm.items.indexOf("items[]="+r.item_id)<0&&_.quoteForm.items.push("items[]="+r.item_id),_.quoteForm.group_id.indexOf("group_id[]="+r.group_id)<0&&_.quoteForm.group_id.push("group_id[]="+r.group_id),_.quoteForm.zone_id.indexOf("zone_id[]="+o)<0&&_.quoteForm.zone_id.push("zone_id[]="+o)}})}_.quoteForm.group_id.forEach(function(e){var t=e.substring(11);(zoneId=S.withinZone(t,!1,_.quoteForm.pickup_lat,_.quoteForm.pickup_lon).id)&&_.quoteForm.pickup_zone.indexOf("pickup_zone["+t+"]="+zoneId)<0&&_.quoteForm.pickup_zone.push("pickup_zone["+t+"]="+zoneId)}),_.quoteForm.timezone=_.timezone,S.sendQuote(_.quoteForm).then(function(e){Ie=!1,R=!1,"Successful"==e.status?(_.totalDrivers>0?("quote"==e.mode&&p("AWAIT_CONFIRM").then(function(e){h.$broadcast("loading:hide"),s.show({template:e})}),_.quoteSentMsg=e.quoteID):(h.$broadcast("quoteaccepted"),p(["SUCCESS","QUOTE_SCHEDULED"]).then(function(e){d.success(e.QUOTE_SCHEDULED,e.SUCCESS)})),_.coupon=null,_.resetQuoteForm(),h.$broadcast("quotesent")):(h.$broadcast("loading:hide"),p(["FAILED"]).then(function(t){f.alert({title:t.FAILED,template:e.description})}),_.driversInspected=!0)},function(e){h.$broadcast("loading:hide"),null!=_.modalDatePicker&&_.modalDatePicker.remove(),null!=_.seatsModal&&_.seatsModal.remove(),_.modalDatePicker=null,_.seatsModal=null,p(["SOMETHING_WRONG","FAILED"]).then(function(e){f.alert({title:e.FAILED,template:e.SOMETHING_WRONG})}),_.driversInspected=!0})}})}]).controller("IntroCtrl",["$scope","$ionicSlideBoxDelegate",function(e,t){e.startApp=function(){$state.go("main")},e.next=function(){t.next()},e.previous=function(){t.previous()},e.slideChanged=function(t){e.slideIndex=t}}]).controller("MapListCtrl",["$localStorage","$state","$ionicPopover","$ionicFilterBar","fireRef","$translate","$ionicPopup","$timeout","$rootScope","EmployeeService","$scope","$ionicPopover",function(e,t,o,i,n,a,r,l,s,c,d,o){d.loading=!0,o.fromTemplateUrl("popovers/maps-menu.html",{scope:d}).then(function(e){d.popoverMenu=e}),d.showDelete=!1,d.deleteMap=function(){d.popoverMenu.hide(),d.showDelete=!d.showDelete},d.onMapDelete=function(e){var t={action:"delete",map_id:e.map_id};c.map(t).then(function(e){m()}),d.showDelete=!1},d.showMap=function(e){t.transitionTo("app.maps-detail",{obj:e,id:e&&e.map_id||""})};var p;d.showFilterBar=function(){p=i.show({items:d.maps,update:function(e,t){d.maps=e}})};var u={groups:[]};d.maps=[],c.getEmployees().forEach(function(t){t.user_id&&t.user_id==e.user_id&&u.groups.indexOf("group_id[]="+t.category_id)<0&&u.groups.push("group_id[]="+t.category_id)});var m=function(){c.map({action:"fetch"}).then(function(e){d.loading=!1,e.data&&(d.maps=e.data)})};m(),d.$on("$ionicView.beforeLeave",function(){p&&(p(),p=null),c.removeModalPopup(d,"popoverMenu")})}]).controller("MapsCtrl",["PendingRequestsService","$ionicFilterBar","$ionicSideMenuDelegate","$state","$injector","$localStorage","UUIDService","$stateParams","fireRef","$translate","$ionicPopup","$timeout","$rootScope","$compile","EmployeeService","$scope","$ionicPopover",function(e,t,o,i,n,a,r,l,s,c,d,p,u,m,g,f,v){u.$broadcast("loading:show");var h=this;f.$on("$ionicView.afterEnter",function(s,c){var d;u.showFilterBar=function(){d=t.show({items:u.maps,update:function(e,t){u.maps=e}})},u.onMapDelete=function(e){var t={action:"delete",map_id:e.map_id};g.map(t).then(function(t){delete e.map_id,E(null,!0)})};var _={groups:[]};g.getEmployees().forEach(function(e){e.user_id&&e.user_id==a.user_id&&_.groups.indexOf("group_id[]="+e.category_id)<0&&_.groups.push("group_id[]="+e.category_id)}),f.showMap=function(e,t){if(e){if(t||o.toggleRight(!1),O&&O==e.map_id)return;l.obj=e,O=e.map_id}else O=void 0;L(!0)},u.showMap=function(e){f.showMap(e)},f.maps;var E=function(e,t){g.map({action:"fetch"}).then(function(i){f.loading=!1,i.data&&(f.maps=i.data.filter(function(e){return e.map_id}),f.maps.sort(function(e,t){return Date.parse(t.updated_at)-Date.parse(e.updated_at)}),u.maps=f.maps,e||(f.maps[0]&&f.maps[0].map_id?f.showMap(f.maps[0],t):(k(),h.zones.length=0,h.zonegroups.length=0,U.length=0,f.mapCenter=u.lat+","+u.lon,$&&$.setZoom(13))),u.$broadcast("loading:hide"),0==f.maps.length&&o.toggleRight(!1),Y())})};E(),f.rightMenu.src="maps/right-menu.html";var S,D,y=[],T=function(e,t,o){e.map_id=O,e.center||(e.center=$.getCenter().lat()+","+$.getCenter().lng()),!e.title&&f.mapObj&&(e.title=f.mapObj.title),e.zoom||(e.zoom=$.getZoom()),g.map(e).then(function(i){"Success"==i.status&&("view"==e.action&&u.$broadcast("loading:hide"),i.data.constructor===Array||(f.mapObj.title=i.data.title,i.data.description&&(f.mapObj.description=i.data.description)),w(i.data,t),o&&E(!0),A=!1)})},M=function(){D&&D.type&&"marker"!=D.type.toLowerCase()&&D.setEditable(!1),D=null,p(),B&&B.close()},I=function(e){M(e),D=e,"marker"!=e.type.toLowerCase()&&e.setEditable(!0)};f.deleteSelectedShape=function(){if(B&&B.close(),D)for(var e=0;e<h.zones.length;e++)if(h.zones[e]===D){var t=y.indexOf(D);t>-1&&y.splice(t,1),h.saveZonesToGroups(D,"delete"),D.setMap(null),h.zones.splice(e,1),D.id;var o,i=U.some(function(e,t){return o=t,D.id==e.id});i&&U.splice(o,1)}},f.saveZoneInfo=function(){f.editingzoneinfo=!1,D.title=f.title,D.desc=f.description,D.saveable=!0,h.saveZonesToGroups(D),B.close()};var k=function(){for(var e=0;e<y.length;e++)y[e].setMap(null);y.length=0},b=function(e){if(e.constructor===Object&&e.group_id)var t=e.group_id;else if(e.constructor===Array&&e[0].group_id)var t=e[0].group_id;t&&h.groups.forEach(function(e){e.user_id&&t.indexOf(e.category_id)>-1?e.checked=!0:e.checked=!1})},C=!1,R=function(e){if(h.zonegroups.length=0,angular.copy(g.getEmployees()).forEach(function(e){e.user_id&&e.user_id==a.user_id&&(e.checked=!0,h.zonegroups.push(e))}),!e){var t=U.some(function(e){return D.id==e.id});h.zonegroups.forEach(function(e){D.group_id.indexOf(e.category_id)>-1?e.checked=!0:t&&(e.checked=!1)})}if(0==h.zonegroups.length&&!C){C=!0;var o={name:f.mapObj.title,active:1,tags:[],services:[],allow_queue:u.allow_queue,zone_based_queuing:!0,allow_advance_reservation:10,allow_remote_reservation:1440,jail:30,offer:30,centers:[],zones:[],zonesDelete:[],toSaveRateplans:[]};u.biddable&&o.tags.push("tags[]=biddable"),u.rquire_uppload&&o.tags.push("tags[]=rquire_uppload"),g.addGroup(o).then(function(){g.findAllEmployees().then(function(t){C=!1,R(e)})})}},w=function(e,t){if(e.constructor===Array)for(var o=0,i=e.length;i>o;o++){if("polygon"==e[o].type.toLowerCase()){var n=[];e[o].lats.forEach(function(e){n.push({lat:Number(e)})}),e[o].lons.forEach(function(e,t){n[t].lng=Number(e)});var a=new google.maps.Polygon({path:n,map:$})}else if("circle"==e[o].type.toLowerCase())var a=new google.maps.Circle({map:$,center:{lat:Number(e[o].lats[0]),lng:Number(e[o].lons[0])},radius:1609*Number(e[o].radius)});else if("marker"==e[o].type.toLowerCase())var a=new google.maps.Marker({map:$,draggable:!0,icon:{url:"img/needle.png"},position:{lat:Number(e[o].lats[0]),lng:Number(e[o].lons[0])}});e[o].color&&a.set("fillColor","#"+e[o].color),y.push(a),a.title=e[o].zone_title,a.desc=e[o].zone_description,a.id=e[o].zone_id,a.saveable=!0,a.type=e[o].type,a.group_id=e[o].group_id||[],h.zones.push(a),U.push(a),Q(a),Z(a),b(e[o])}else e.zone_id&&y.some(function(t){return t.id==e.zone_id?(t.title=e.zone_title,t.desc=e.zone_description,t.group_id=e.group_id||[],b(e),!0):void 0})};u.isSelectedMap=function(e){return O===e.map_id},h.isSelectedZone=function(e){return D===e},h.selectGroup=function(e){e.checked=!e.checked,h.saveGroups()},h.selectGroups=function(e){h.groups.forEach(function(t){t.checked=e}),h.saveGroups()},h.selectZoneGroup=function(e){e.checked=!e.checked},h.selectZoneGroups=function(e){h.zonegroups.forEach(function(t){t.checked=e})},h.showDropdownPopover=function(e){f.popoverDropdown?f.popoverDropdown.show(".zonegroups"):v.fromTemplateUrl("popovers/maps-dropdown.html",{scope:f}).then(function(e){f.popoverDropdown=e,e.show(".zonegroups")})},h.showMapPopover=function(e){f.mapTitleObj={},f.mapTitleObj.description=f.mapObj.description,f.mapTitleObj.title=f.mapObj.title,f.popoverTitle?f.popoverTitle.show(".maptitle"):v.fromTemplateUrl("popovers/maps-title.html",{scope:f}).then(function(e){f.popoverTitle=e,e.show(".maptitle")})},f.saveMapTitle=function(){f.popoverTitle.hide();var e={};e.action="add",e.title=f.mapTitleObj.title,e.description=f.mapTitleObj.description,T(e,null,!0)};var O,$,P,A=!1,L=function(e){if($&&f.maps)if(O&&l.obj){k(),h.zones.length=0,h.zonegroups.length=0,U.length=0,f.mapObj=l.obj,b(l.obj),A=!0;var t=l.obj.center.split(",");if(l.obj.zoom)var o=Number(l.obj.zoom);else var o=13;$.setOptions({center:{lat:Number(t[0]),lng:Number(t[1])},zoom:o}),T({action:"view",zone_id:"all",map_id:O})}else e&&(k(),h.zones.length=0,h.zonegroups.length=0,U.length=0,O=r.getRandomId(),f.mapObj={title:"Untitled",description:"",groups:[],zones:{}},A=!0,f.mapCenter=u.lat+","+u.lon,$.setZoom(13),T({map_id:O,title:"Untitled",action:"add",center:u.lat+","+u.lon},null,!0),A=!1)},F=["#1E90FF","#FF1493","#32CD32","#FF8C00","#4B0082","#000"],N={};f.$on("mapInitialized",function(e,t){$=t,L()});h.editMapTitleDesc=function(){};var x=function(e){(e||D&&D.saveable)&&h.saveZonesToGroups(e||D,"add")},q=function(e){D&&D.type.toLowerCase()!=google.maps.drawing.OverlayType.MARKER.toLowerCase()&&(D.set("fillColor",e),h.saveZonesToGroups(D))},z=function(e){var t=document.createElement("span");return t.className="color-button",t.style.backgroundColor=e,google.maps.event.addDomListener(t,"click",function(){V(e),q(e)}),t},V=function(e){P=e;for(var t=0;t<F.length;++t){var o=F[t];N[o].style.border=o==e?"2px solid #789":"2px solid #fff"}};f.editingstyle=!1,f.buildColorPalette=function(){f.editingstyle=!0;for(var e=document.getElementById("color-palette"),t=0;t<F.length;++t){var o=F[t],i=z(o);e.appendChild(i),N[o]=i}V(F[0])},h.saveGroups=function(){var e=[],t=[];h.groups.forEach(function(o){o.checked&&(e.push(o),t.push("group_id[]="+o.category_id))}),0==t.length&&(t=["group_id[]="]);var o={action:"add"};t.length>0&&(o.group_id=t,T(o))},h.saveZonesToGroups=function(e,t){f.mapObj||{title:"xyz",description:"desc",groups:[],zones:{}},g.getzoneMap();h.zones.forEach(function(o,i){if(!e||e.saveable&&e.id==o.id){var n={lat:[],lon:[]};if(n.zone_id=e.id||r.getRandomId(),"circle"==o.type.toLowerCase()){var a=(o.getRadius()/1609).toFixed(2);n.lat.push("lats[]="+o.getCenter().lat()),n.lon.push("lons[]="+o.getCenter().lng()),n.radius=a,n.zone_radius=1>a?a:"1",n.zone_description=o.desc,n.zone_title=o.title,n.type="Circle"}else if("polygon"==o.type.toLowerCase()){for(var l=o.getPath(),s=[],c=[],i=0;i<l.getLength();i++){var d={},p=l.getAt(i);d.lat=p.lat(),d.lng=p.lng(),s.push(p.lat()),c.push(p.lng()),n.lat.push("lats[]="+p.lat()),n.lon.push("lons[]="+p.lng()),n.zone_title=e.title,n.zone_description=e.desc}n.type="Polygon",n.zone_title=e.title,n.zone_description=e.desc}if("marker"==o.type.toLowerCase()&&(n.lat.push("lats[]="+o.getPosition().lat()),n.lon.push("lons[]="+o.getPosition().lng()),n.zone_description=o.desc,n.zone_title=o.title,n.type="Marker"),e.get("fillColor")&&(n.color=e.get("fillColor").substring(1)),"delete"!=t){var u=[];h.zonegroups.forEach(function(e){e.checked&&u.push("group_id[]="+e.category_id)}),0==u.length&&(u=["group_id[]="]),n.group_id=u}return n.action=t||"add",void T(n,!0)}})},h.viewingZones=!1,h.zones=[];var U=[];h.groups=[],h.zonegroups=[];g.getGroupItems(),g.getEmployees();angular.copy(g.getEmployees()).forEach(function(e){e.user_id&&e.user_id==a.user_id&&h.groups.push(e)}),h.viewGroups=function(){h.viewingZones=!1},h.viewZones=function(){h.viewingZones=!0},h.editMapTitle=function(){},h.placeChanged=function(){h.place=this.getPlace(),h.map.setCenter(h.place.geometry.location)};var G=function(e,t){var o=h.map.getBounds().toSpan(),i=({lat:e.lat()+o.lat()*-.15,lng:e.lng()+0*o.lng()},$.getProjection().fromLatLngToPoint(e)),n=(new google.maps.Point(i.x*Math.pow(2,$.getZoom()),i.y*Math.pow(2,$.getZoom())),Math.pow(2,$.getZoom())),a=$.getProjection().fromLatLngToPoint($.getCenter()),r=Math.floor((i.x-a.x)*n)-60,l=Math.floor((i.y-a.y)*n);t&&(r-=30,l-=170);$.getProjection().fromPointToLatLng(i);$.panBy(r,l)};h.showZonePopover=function(e){f.editingzoneinfo=!1,google.maps.event.trigger(e,"click",{})},f.groupchkboxes={};var B,j='<div><div ng-show="editingstyle" id="color-palette"></div><div ng-hide="editingstyle || editingzoneinfo"><h4>{{title}}</h4><p style="min-height:44px; min-width: 140px">{{description}}</p><ul id="map-infowindow-toolbar"><li><button ng-click="editZone()" class="button button-small button-positive">Edit</button></li><li><button ng-click="deleteSelectedShape()" class="button button-small button-assertive">Delete</button></li><li><button ng-if="hasstyle" ng-click="buildColorPalette()" class="zonestyle button button-small button-balanced">Style</button></li></ul></div><div ng-show="!editingstyle && editingzoneinfo"><button style="padding-bottom:3px;" ng-click="vm.showDropdownPopover()" class="zonegroups button icon-right ion-arrow-down-b">Groups</button><div style="padding-bottom:3px;">Title:&nbsp;&nbsp;<input ng-model="title" type="text" id="BlitzMapInfoWindow_title" value="" style="border:2px solid #dddddd;width:150px;padding:3px;"></div><div style="padding-bottom:3px;">Description:<br><textarea ng-model="description" id="BlitzMapInfoWindow_content" style="border:2px solid #dddddd;width:250px;height:115px;"></textarea></div><ul id="map-infowindow-toolbar"><li><button ng-click="saveZoneInfo()" class="button button-small button-positive">Save</button></li><li><button ng-click="editingzoneinfo = !editingzoneinfo" class="button button-small button-stable">Cancel</button></li></ul></div></div>',H=function(){f.maps.some(function(e){return e.map_id==O?(e.zoom=$.getZoom(),e.center=$.getCenter().lat()+","+$.getCenter().lng(),!0):void 0})},Y=function(){f.maps&&S&&(0==f.maps.length?S.setOptions({drawingControl:!1}):S.setOptions({drawingControl:!0}))};f.mapAvailable=!1;var W=[];n.has("NgMap")?(f.mapAvailable=!0,B=new google.maps.InfoWindow({disableAutoPan:!0}),n.get("NgMap").getMap().then(function(e){h.map=e,S=e.mapDrawingManager[0],Y(),W[0]=google.maps.event.addListener(S,"drawingmode_changed",M),W[1]=google.maps.event.addListener(e,"click",M),W[2]=google.maps.event.addListener(e,"zoom_changed",function(){O&&(A?A=!1:(T({action:"add"},!0),H()))}),W[3]=google.maps.event.addListener(e,"dragend",function(){O&&(A?A=!1:(T({action:"add"},!0),H()))}),new google.maps.Marker({position:{lat:u.lat,lng:u.lon},map:e})})):i.transitionTo("app.maps"),f.closeInfoWindow=function(){B&&B.close()},f.editZone=function(){f.editingzoneinfo=!f.editingzoneinfo,G(B.getPosition(),!0)};var K=function(e){var t;if("polygon"==e.type.toLowerCase()){for(var o=new google.maps.LatLngBounds,i=e.getPath(),n=0;n<i.getLength();n++){var a=i.getAt(n);o.extend(a)}t=o.getCenter()}else"circle"==e.type.toLowerCase()?t=e.getCenter():"marker"==e.type.toLowerCase()&&(t=e.getPosition());return t},Q=function(e){"circle"==e.type.toLowerCase()?(W[4]=google.maps.event.addListener(e,"radius_changed",function(e){x()}),W[5]=google.maps.event.addListener(e,"center_changed",function(e){x()})):"polygon"==e.type.toLowerCase()?(W[6]=google.maps.event.addListener(e.getPath(),"insert_at",function(e){x()}),W[7]=google.maps.event.addListener(e.getPath(),"remove_at",function(e){x()}),W[8]=google.maps.event.addListener(e.getPath(),"set_at",function(e){x()})):"marker"==e.type.toLowerCase()&&(W[9]=google.maps.event.addListener(e,"dragend",function(t){e.setPosition({lat:t.latLng.lat(),lng:t.latLng.lng()}),x(e)}))},Z=function(e,t){W[10]=google.maps.event.addListener(e,"click",function(o){f.editingstyle=!1,I(e);var i=angular.element(j),n=m(i)(f);B||(B=new google.maps.InfoWindow({disableAutoPan:!0})),B.setContent(n[0]),B.open(h.map,e);var a=(B.getPosition(),K(e));o.latLng?(B.setPosition(o.latLng),f.editingzoneinfo=!1):(B.setPosition(null),B.setPosition(a)),p(function(){G(B.getPosition()||a,t)},100),f.title=e.title,f.description=e.desc,f.hasstyle="circle"==e.type.toLowerCase()||"polygon"==e.type.toLowerCase(),R(),T({action:"add"},!0)})};h.onMapOverlayCompleted=function(e){S.setDrawingMode(null);var t=e.overlay;if(y.push(t),t.type=e.type,t.saveable=!1,t.id=r.getRandomId(),t.group_id=[],f.editingzoneinfo=!0,h.zones.push(t),R(t),"circle"==e.type)t.title="Circle "+h.zones.length,t.desc="",Q(t);else if("polygon"==e.type){for(var o=t.getPath(),i=0;i<o.getLength();i++){o.getAt(i)}t.title="Polygon "+h.zones.length,t.desc="",Q(t)}else"marker"==e.type&&(t.title="Marker "+h.zones.length,t.desc="",t.setDraggable=!0,Q(t));document.getElementById("MapInfoWindow");Z(t,!0),google.maps.event.trigger(t,"click",{})},f.$on("$ionicView.beforeLeave",function(){g.removeModalPopup(f,"popoverTitle"),g.removeModalPopup(f,"popoverDropdown"),k(),u.maps=null,u.onMapDelete=null,u.showMap=null;for(var t=0;t<W.length;t++)W[t]&&google.maps.event.removeListener(W[t]);o.toggleRight(!1),d&&(d(),d=null),u.showFilterBar=null,u.isSelectedMap=null,u.$broadcast("loading:hide"),e.cancelAll()})})}]).controller("ContactsCtrl",["$cordovaContacts","$ionicModal","$ionicFilterBar","$state","$injector","$localStorage","UUIDService","$stateParams","fireRef","$translate","$ionicPopup","$timeout","$rootScope","$compile","EmployeeService","$scope","$ionicPopover",function(e,t,o,i,n,a,r,l,s,c,d,p,u,m,g,f,v){f.$on("$ionicView.afterEnter",function(i,n){u.$broadcast("loading:show",{text:"FETCHING_CONTACTS"}),f.selectedContact={msg:""},f.defaultPic="img/person.jpg",f.contacts=[],f.showLargImage=function(e){f.allImages=[],e.photos?e.photos.forEach(function(e){f.allImages.push({src:e.value})}):f.allImages.push({src:f.defaultPic}),f.showModal("popovers/image-popover.html")},f.showModal=function(e){t.fromTemplateUrl(e,{scope:f,animation:"slide-in-up"}).then(function(e){f.fullSizeImageModal=e,f.fullSizeImageModal.show()})},f.closeModal=function(){f.fullSizeImageModal.hide(),f.fullSizeImageModal.remove()},f.contactsSelected=function(){return 0==f.contacts.filter(function(e){return e.selected}).length};var a;f.showFilterBar=function(){a=o.show({items:f.contacts,update:function(e,t){f.contacts=e}})};var r=function(e){f.selectedContact=e,f.selectedContact.itemType||(f.selectedContact.itemType=[{text:"Driver",checked:!1},{text:"Dispatcher",checked:!1},{text:"Admin",checked:!1},{text:"Customer",checked:!1}]),f.selectedContact.servType||(f.selectedContact.servType=u.tags.map(function(e){return{text:e,checked:!1}})),f.typeModal?f.typeModal.show():t.fromTemplateUrl("modals/contact_type.html",{scope:f,animation:"slide-in-up"}).then(function(e){f.typeModal=e,f.typeModal.show()})};f.saveType=function(){f.msgtypeSelected()||(f.typeModal.hide(),f.selectedContact.selected=!0)},f.msgtypeSelected=function(){return 0==f.selectedContact.itemType.filter(function(e){return e.checked}).length&&0==f.selectedContact.servType.filter(function(e){return e.checked}).length&&(!f.selectedContact.msg||f.selectedContact.msg&&""==f.selectedContact.msg.trim())},f.selectContact=function(e,t){(!t||t&&e.selected)&&(e.msg=f.selectedContact.msg,r(e))},f.loading=!0,f.contactClicked=function(e,t){"IMG"!==e.target.nodeName&&f.selectContact(t,"INPUT"==e.target.nodeName)},f.getAllContacts=function(){e.find({filter:"",multiple:!0}).then(function(e){f.contacts=e,f.loading=!1,p(function(){u.$broadcast("loading:hide")},5e3)})},g.getCountryCityState(),f.getAllContacts(),f.refer=function(){if(!f.contactsSelected()){u.$broadcast("loading:show");var e=[];f.contacts.forEach(function(t){if(t.selected){var o="user[]="+t.displayName+"|";o+=t.phoneNumbers?t.phoneNumbers[0].value+"|":"|",o+=t.emails?t.emails[0].value+"|":"|",o+=t.addresses?t.addresses[0].value+"|":"|",o+=t.msg?t.msg+"|":"|";var i=[];t.itemType&&t.itemType.forEach(function(e){e.checked&&i.push(e.text)}),o+=i.length>0?i.join(",")+"|":"|";var n=[];t.servType&&t.servType.forEach(function(e){e.checked&&n.push(e.text)}),o+=n.length>0?n.join(",")+"|":"|",o+=u.city+"|",o+=u.state+"|",o+=u.country,e.push(o)}}),g.addContacts(e).then(function(){c(["SUCCESS","CONTACT_REFERRED"]).then(function(e){d.alert({title:e.SUCCESS,template:e.CONTACT_REFERRED})}),f.contacts.forEach(function(e){e.selected=!1})},function(e){c(["SOMETHING_WRONG","FAILED"]).then(function(e){d.alert({title:e.FAILED,template:e.SOMETHING_WRONG})})})["finally"](function(){u.$broadcast("loading:hide")})}},f.$on("$ionicView.beforeLeave",function(){a&&(a(),a=null),u.$broadcast("loading:hide"),g.removeModalPopup(f,"typeModal")})})}]).controller("OpportunitiesListCtrl",["PendingRequestsService","$state","$injector","$localStorage","UUIDService","$stateParams","fireRef","$translate","$ionicPopup","$timeout","$rootScope","$compile","EmployeeService","$scope","$ionicPopover",function(e,t,o,i,n,a,r,l,s,c,d,p,u,m,g){m.$on("$ionicView.afterEnter",function(o,i){d.$broadcast("loading:show"),m.loading=!0,u.getCareers("fetch").then(function(e){"failed"==e.status?m.careers=[]:m.careers=e.data},function(e){m.careers=[]})["finally"](function(){m.loading=!1,d.$broadcast("loading:hide")}),m.showDetail=function(e){t.transitionTo("app.hrdetail",{obj:e})},m.$on("$ionicView.beforeLeave",function(){d.$broadcast("loading:hide"),e.cancelAll()})})}]).controller("OpportunitiesDetailCtrl",["$state","$injector","$localStorage","UUIDService","$stateParams","fireRef","$translate","$ionicPopup","$timeout","$rootScope","$compile","EmployeeService","$scope","$ionicPopover",function(e,t,o,i,n,a,r,l,s,c,d,p,u,m){u.detail=n.obj,u.apply=function(t){e.transitionTo("app.hrform",{obj:u.detail})}}]).controller("OpportunitiesFormCtrl",["toastr","$ionicHistory","$state","$injector","$localStorage","UUIDService","$stateParams","fireRef","$translate","$ionicPopup","$timeout","$rootScope","$compile","EmployeeService","$scope","$ionicPopover",function(e,t,o,i,n,a,r,l,s,c,d,p,u,m,g,f){g.$on("$ionicView.afterEnter",function(t,i){g.obj=r.obj,g.empl=g.obj,g.formType="add",g.empl.oldItems=[],g.hrformTitle=g.obj.name,g.isOwner=!0,g.skills=[{id:"Accounting and Consulting",text:"Accounting and Consulting",checked:!1,disabled:!1},{id:"Admin Support",text:"Admin Support",checked:!1,disabled:!1},{id:"Article and Blog Writing",text:"Article and Blog Writing",checked:!1,disabled:!1},{id:"Audio Production",text:"Audio Production",checked:!1,disabled:!1},{id:"Backend Development Expert",text:"Backend Development Expert",checked:!1,disabled:!1},{id:"Business Development",text:"Business Development",checked:!1,disabled:!1},{id:"Business Managment",text:"Business Managment",checked:!1,disabled:!1},{id:"Computer Graphics Animator",text:"Computer Graphics Animator",checked:!1,disabled:!1},{id:"Creative Writing",text:"Creative Writing",checked:!1,disabled:!1},{id:"Customer Service",text:"Customer Service",checked:!1,disabled:!1},{id:"Data Entry",text:"Data Entry",checked:!1,disabled:!1},{id:"Data Mining and Management",text:"Data Mining and Management",checked:!1,disabled:!1},{id:"Database Administration",text:"Database Administration",checked:!1,disabled:!1},{id:"Display Advertising",text:"Display Advertising",checked:!1,disabled:!1},{id:"Editing and Proofreading",text:"Editing and Proofreading",checked:!1,disabled:!1},{id:"Email and Marketing Automation",text:"Email and Marketing Automation",checked:!1,disabled:!1},{id:"Engineering and Architecture",text:"Engineering and Architecture",checked:!1,disabled:!1},{id:"ERP or CRM Software",text:"ERP or CRM Software",checked:!1,disabled:!1},{id:"Financial Planning",text:"Financial Planning",checked:!1,disabled:!1},{id:"Graphic Design and Animation",text:"Graphic Design and Animation",checked:!1,disabled:!1},{id:"Human Resources",text:"Human Resources",checked:!1,disabled:!1},{id:"Intellectual Property Law",text:"Intellectual Property Law",checked:!1,disabled:!1},{id:"IT and Networking",text:"IT and Networking",checked:!1,disabled:!1},{id:"Lead Generation",text:"Lead Generation",checked:!1,disabled:!1},{id:"Legal - Contract Law",text:"Legal - Contract Law",checked:!1,disabled:!1},{id:"Legal - Corporate Law",text:"Legal - Corporate Law",checked:!1,disabled:!1},{id:"Logo Design and Branding",text:"Logo Design and Branding",checked:!1,disabled:!1},{id:"Management Consulting",text:"Management Consulting",checked:!1,disabled:!1},{id:"Market Research",text:"Market Research",checked:!1,disabled:!1},{id:"Marketing",text:"Marketing",checked:!1,disabled:!1},{id:"Marketing Strategy",text:"Marketing Strategy",checked:!1,disabled:!1},{id:"Mobile App Development",text:"Mobile App Development",checked:!1,disabled:!1},{id:"Network and System Administration",text:"Network and System Administration",
checked:!1,disabled:!1},{id:"Office and Clerical Work",text:"Office and Clerical Work",checked:!1,disabled:!1},{id:"Office Management",text:"Office Management",checked:!1,disabled:!1},{id:"Operations Manager",text:"Operations Manager",checked:!1,disabled:!1},{id:"Photography",text:"Photography",checked:!1,disabled:!1},{id:"Presentations",text:"Presentations",checked:!1,disabled:!1},{id:"Product Management",text:"Product Management",checked:!1,disabled:!1},{id:"Project Management",text:"Project Management",checked:!1,disabled:!1},{id:"Public Relations",text:"Public Relations",checked:!1,disabled:!1},{id:"QA and Testing",text:"QA and Testing",checked:!1,disabled:!1},{id:"Quantitative Analysis",text:"Quantitative Analysis",checked:!1,disabled:!1},{id:"Sales",text:"Sales",checked:!1,disabled:!1},{id:"Sales Strategy",text:"Sales Strategy",checked:!1,disabled:!1},{id:"Search Engine Marketing",text:"Search Engine Marketing",checked:!1,disabled:!1},{id:"Search Engine Optimization",text:"Search Engine Optimization",checked:!1,disabled:!1},{id:"Social Media Marketing",text:"Social Media Marketing",checked:!1,disabled:!1},{id:"Technical Support",text:"Technical Support",checked:!1,disabled:!1},{id:"Telemarketing and Telesales",text:"Telemarketing and Telesales",checked:!1,disabled:!1},{id:"Translation",text:"Translation",checked:!1,disabled:!1},{id:"Application User Interface, Experience",text:"Application User Interface, Experience",checked:!1,disabled:!1},{id:"Video Production",text:"Video Production",checked:!1,disabled:!1},{id:"Voice Talent",text:"Voice Talent",checked:!1,disabled:!1},{id:"Web Content Writing",text:"Web Content Writing",checked:!1,disabled:!1},{id:"Web Development",text:"Web Development",checked:!1,disabled:!1},{id:"Web Content Writing",text:"Web Content Writing",checked:!1,disabled:!1},{id:"Web Research",text:"Web Research",checked:!1,disabled:!1},{id:"Other",text:"Other",checked:!1,disabled:!1}];var a=[{id:"Admin",text:"Admin",checked:!1,disabled:!1},{id:"Dispatcher",text:"Dispatcher",checked:!1,disabled:!1},{id:"Driver",text:"Driver",checked:!1,disabled:!1},{id:"Other",text:"Other",checked:!1,disabled:!1}],l=function(){g.items=[],m.getEmployees().forEach(function(e){e.hasOwnProperty("can_bookin")&&(""==e.tags?g.items=a:a.forEach(function(t){e.tags.indexOf(t.text)>-1&&g.items.push(t)}),e.apikeypublic==window.localStorage.getItem("apikeypublic")&&(g.empl.cellPhone=e.cellPhone))}),0==g.items.length&&(g.items=a)},u=function(e){g.services=e.map(function(e){return{id:e,text:e,checked:!1}}),g.services.push({id:"Other",text:"Other",checked:!1}),void 0!=g.empl.tags&&(g.empl.items=g.empl.tags.filter(function(t){return e.indexOf(t)<0}),g.empl.services=g.empl.tags.filter(function(t){return e.indexOf(t)>-1})),void 0==g.empl.items&&(g.empl.items=[]),void 0==g.empl.services&&(g.empl.services=[]),void 0==g.empl.skills&&(g.empl.skills=[]),g.empl.item="",g.empl.itemType="",g.empl.service="",g.empl.serviceType="",g.empl.skill="",g.empl.skilType="",g.empl.items.length>0&&(g.empl.item=g.empl.items.join(", "),g.empl.itemType=g.empl.items.join("&tags[]="),g.empl.oldItems=g.empl.items.slice(0)),g.empl.services.length>0&&(g.empl.oldItems=g.empl.oldItems.concat(g.empl.services),g.empl.service=g.empl.services.join(", "),g.empl.serviceType=g.empl.services.join("&tags[]=")),g.empl.skills.length>0&&(g.empl.skill=g.empl.skills.join(", "),g.empl.skillType=g.empl.skills.join("&skills[]=")),l()};null==p.tags?m.getTags().then(function(e){u(tags)}):u(p.tags),m.getAllEmployees(),g.emailChanged=function(){g.isOwner=g.empl.email==n.email},g.empl.email=n.email,g.empl.firstName=p.name,g.empl.lastName="",g.save=function(t){if(t.$submitted=!0,t.$valid){(g.empl.item.indexOf("Admin")>-1||g.empl.item.indexOf("Dispatcher")>-1||g.empl.item.indexOf("Driver")>-1)&&(g.empl.itemType+="&tags[]="+g.empl.serviceType);var i=[],n=[],a=[];g.empl.oldItems.forEach(function(e){g.empl.itemType.indexOf(e)<0&&e.split(",").forEach(function(e){n.push(e)})}),g.empl.itemType.split("&tags[]=").forEach(function(e){g.empl.oldItems.indexOf(e)<0&&e.split(",").forEach(function(e){i.push(e)})}),g.empl.skillType.split("&skills[]=").forEach(function(e){e.split(",").forEach(function(e){a.push(e)})}),i.length>0&&(g.empl.itemType=i.join("&tags[]=")),n.length>0&&(g.empl.itemTypeOld=n.join("&itemTypeOld[]=")),a.length>0&&(g.empl.skillType=a.join("&skills[]=")),p.$broadcast("loading:show"),m.getCareers("add",g.empl).then(function(t){o.transitionTo("app.hrlist"),p.$broadcast("loading:hide"),p.$broadcast("empl:saved"),s(["SUCCESS","APPLIED_SUCCESSFULLY"]).then(function(t){e.success(t.APPLIED_SUCCESSFULLY,t.SUCCESS,{timeOut:3e3,positionClass:"toast-bottom-center"})})},function(){s(["SOMETHING_WRONG","FAILED"]).then(function(e){p.$broadcast("loading:hide"),c.alert({title:e.FAILED,template:e.SOMETHING_WRONG})})})}},g.noSkills=function(e){},g.noService=function(e){},g.showService=function(e){d(function(){angular.element(e.target).siblings("").find("ion-item").trigger("click")})},g.showSkills=function(e){d(function(){angular.element(e.target).siblings("").find("ion-item").trigger("click")})},g.showServiceField=function(){return g.empl&&g.empl.item&&(g.empl.item.indexOf("Admin")>-1||g.empl.item.indexOf("Dispatcher")>-1||g.empl.item.indexOf("Driver")>-1)}})}]).controller("ComplaintCtrl",["$localStorage","UUIDService","$translate","$ionicPopup","$timeout","$rootScope","EmployeeService","$scope","$ionicPopover",function(e,t,o,i,n,a,r,l,s){l.compl={deptid:"",priority:""};var c=["SALES","BILLING","CUST_SERV","TECH_SUPP"],d=["HIGH","MEDIUM","LOW"],p={};o(c).then(function(e){l.departments=[{id:e[c[0]],text:e[c[0]],checked:!1},{id:e[c[1]],text:e[c[1]],checked:!1},{id:e[c[2]],text:e[c[2]],checked:!1},{id:e[c[3]],text:e[c[3]],checked:!1}],p[e[c[0]]]=1,p[e[c[1]]]=2,p[e[c[2]]]=3,p[e[c[3]]]=4}),o(d).then(function(e){l.priorities=[{id:e[d[0]],text:e[d[0]],checked:!1},{id:e[d[1]],text:e[d[1]],checked:!1},{id:e[d[2]],text:e[d[2]],checked:!1}]}),l.showModal=function(e){n(function(){angular.element(e.target).siblings("").find("ion-item").trigger("click")})},l.deptSelected=function(e){l.compl.deptid=p[e]},l.submit=function(e){e.$submitted=!0,e.$valid&&(a.$broadcast("loading:show"),r.complaint(l.compl).then(function(t){"failed"!=t.status?(o(["COMPLAINT_SUBMITTED","SUCCESS"]).then(function(e){i.alert({title:e.SUCCESS,template:e.COMPLAINT_SUBMITTED})}),e.$setPristine(),l.compl={},history.back()):o(["SOMETHING_WRONG","FAILED"]).then(function(e){i.alert({title:e.FAILED,template:e.SOMETHING_WRONG})})},function(){o(["SOMETHING_WRONG","FAILED"]).then(function(e){i.alert({title:e.FAILED,template:e.SOMETHING_WRONG})})})["finally"](function(){a.$broadcast("loading:hide")}))}}]);