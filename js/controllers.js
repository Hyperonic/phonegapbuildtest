angular.module("starter.controllers",[]).controller("AppCtrl",["toastr","$ionicHistory","$timeout","$ionicScrollDelegate","$translate","$localStorage","$ionicSideMenuDelegate","AuthService","$rootScope","$scope","$ionicModal","$ionicPopup","$interval","EmployeeService","$state",function(e,t,o,i,n,a,r,l,s,c,d,p,u,m,g){if(c.rightMenu||(c.rightMenu={}),s.showMenuIcon=!0,!s.name){null==t.backView()||"app.employee-dispatcher"!=t.backView().stateName&&"app.employee-index"!=t.backView().stateName||m.emptyEmployeesCateg(),null==s.itemBooked&&(s.itemBooked=0,s.itemNotBooked=0),c.ionic=ionic,s.setVehiclePermit=function(e,t){e&&(c.vehiclee=e),t&&(c.permitt=t)},c.openMaps=function(){"app.maps-detail"!=g.current.name&&g.transitionTo("app.maps-detail")},s.loggedIn=l.isAuthenticated()?!0:!1,s.name=a.name,s.onQuotePage=g.current.quotepage,s.updateRating=function(){m.myRatings()},s.profileItems=function(){n(["UPLOAD_PIC","CHANGE_PASSWORD","DRIVER_LICENSE","CITY_PERMITS","VEHICLE_INFO","POI"]).then(function(e){s.groups=[{icon:"ion-camera",title:e.UPLOAD_PIC,link:"app.uploadpic"},{icon:"ion-key",title:e.CHANGE_PASSWORD,link:"app.changepwd"},{icon:"ion-location",title:e.POI,link:"app.poi"}],s.isNotCustomer&&(s.myPermits&&s.myPermits.length>0&&(s.groups.push({icon:"ion-information-circled",title:e.DRIVER_LICENSE,link:"app.driving"}),s.groups.push({icon:"ion-card",title:e.CITY_PERMITS,link:"app.permit"})),s.myVehicles&&s.myVehicles.length>0&&s.groups.push({icon:"ion-model-s",title:e.VEHICLE_INFO,link:"app.vehicle"}))})},s.profileItems(),null==s.shownGroup&&(s.shownGroup=!1),s.toggleGroup=function(){s.shownGroup?(s.shownGroup=!1,o(function(){var e=$(".menucontent ion-item:last").offset().top+83-$("#menufooter").offset().top;0>e&&i.scrollBy(0,e,!0)},200)):(o(function(){var e=$(".menucontent .item-accordion:last").offset().top+90-$("#menufooter").offset().top;e>0&&i.scrollBy(0,e,!0)},100),s.shownGroup=!0)},s.isGroupShown=function(){return s.shownGroup};var f,v,h,_,E=c.$watch(function(){return r.getOpenRatio()},function(e){1===e?(i.resize(),g.current.mappage&&s.$broadcast("setmapclick",!1)):g.current.mappage&&s.$broadcast("setmapclick",!0)}),S=function(){_=c.$on("autologin",function(e,t){s.profileItems()}),f=c.$on("user:updated",function(e,t){s.showQuoteForm=t,s.isNotCustomer=t,s.profileItems()}),v=c.$on("canbookin:updated",function(e,t){s.canbookin=t}),h=c.$on("quotepagewithbookedin",function(e,t){n(["SORRY","BOOKOUT_FIRST"]).then(function(e){p.alert({cssClass:"bookoutFirst",title:e.SORRY,template:e.BOOKOUT_FIRST})})})};S(),s.canbookin=m.canBookin();var D=function(){s.$broadcast("loading:show",{text:"LOGGING_OUT"}),m.logOut().success(function(e){g.transitionTo("app.login"),s.$broadcast("loading:hide")})};s.orders=function(){g.transitionTo("app.orders",{apikey:window.localStorage.getItem("apikeypublic")})},s.login=function(){g.transitionTo("app.login")};var y=c.$on("fb:initialized",function(e,t){y()});s.isNotCustomer=a.isDriver,s.showLogOut=function(){setTimeout(function(){s.$broadcast("setmapclick",!1)},500),n(["OK","CANCEL","LOGOUT","CONFIRM_LOGOUT"]).then(function(e){var t=p.confirm({title:e.LOGOUT,template:e.CONFIRM_LOGOUT,cssClass:"logoutAlert",buttons:[{text:e.CANCEL},{text:e.OK,type:"button-positive",onTap:function(e){D()}}]});t.then(function(){s.$broadcast("setmapclick",!0)})})},s.book=function(e){m.toggleBook(e,"all").then(function(e){})},s.bookAll=function(t,o){var i="2"==t?!0:!1,a=0,r=0,l=0,c=0,d=0,p=0,u=!1,g=m.getGroupItems();i?m.getVehiclesPermits().then(function(){var t=[],f=[],v=[],h=[],_=[];for(var E in g)g[E].can_bookin&&!g[E].booked&&(m.getEmployees()[g[E].groupPosition].require_upload&&(u=!0),E==g[E].category_id&&(g[E].booked||a++,(services=m.getTagsRatePlan(E,g[E].tags))&&services.length>0&&t.push(services.join(", ")+" : <b>"+m.getEmployees()[g[E].groupPosition].name+"</b>"),1==m.withinZone(g[E].category_id)?(c++,t.join(",").indexOf(m.getEmployees()[g[E].groupPosition].name)<0&&f.push("<b>"+m.getEmployees()[g[E].groupPosition].name+"</b>")):m.hasServType(g[E].tags)?m.isDispatcherAdmin(g[E].category_id)||m.withinZone(g[E].category_id)?m.hasRatePlanServ(E,g[E].tags)?!m.haveDocuments()&&m.getEmployees()[g[E].groupPosition].require_upload&&(p++,_.join(",").indexOf(m.getEmployees()[g[E].groupPosition].name)<0&&_.push("<b>"+m.getEmployees()[g[E].groupPosition].name+"</b>")):l++:(r++,f.join(",").indexOf(m.getEmployees()[g[E].groupPosition].name)<0&&v.push("<b>"+m.getEmployees()[g[E].groupPosition].name+"</b>")):(d++,h.join(",").indexOf(m.getEmployees()[g[E].groupPosition].name)<0&&h.push("<b>"+m.getEmployees()[g[E].groupPosition].name+"</b>"))));return o||(f.length>0&&n("NO_ZONE").then(function(t){e.info(f.join("<br>"),t,{allowHtml:!0,timeOut:3e3,positionClass:"toast-bottom-center"})}),v.length>0&&n("NOT_IN_ZONE").then(function(t){e.info(v.join("<br>"),t,{allowHtml:!0,timeOut:3e3,positionClass:"toast-bottom-center"})}),h.length>0&&n("NO_SERVICE_TYPE").then(function(t){e.info(h.join("<br>"),t,{allowHtml:!0,timeOut:3e3,positionClass:"toast-bottom-center"})}),t.length>0&&n("NO_RATE_PLAN").then(function(o){e.info(t.join("<br>"),o,{allowHtml:!0,timeOut:3e3,positionClass:"toast-bottom-center"})}),_.length>0&&n("UPLOAD_DOCS").then(function(t){e.info(_.join("<br>"),t,{allowHtml:!0,timeOut:3e3,positionClass:"toast-bottom-center"})})),c+r+l+d+p>=a?void 0:(s.book(i),u&&!m.checkForms(void 0,[i,"all"])?void s.$broadcast("loading:hide"):void 0)}):s.book(i)},c.$on("$destroy",function(){f(),h(),v(),E()})}}]).controller("SignUpCtrl",["$cordovaInAppBrowser","$ionicScrollDelegate","$state","$rootScope","$translate","$scope","$ionicPopup","$ionicModal","$timeout","EmployeeService",function(e,t,o,i,n,a,r,l,s,c){var d,p,u,m,g=this;g.signupForm=null,a.$on("$ionicView.afterEnter",function(l,f){s(function(){var e=$("ion-view .scroll").offset();if(e){var t=e.top;0>t&&$("ion-view .scroll").css("top",44-t)}}),a.view_loaded=!0,a.termsClicked=function(t){if("SPAN"==t.target.tagName)if(ionic.Platform.isWebView()){var o={location:"no",clearcache:"yes",toolbar:"yes"};e.open(t.target.attributes.link.nodeValue,"_blank",o).then(function(e){})["catch"](function(e){}),d||(d=i.$on("$cordovaInAppBrowser:loadstart",function(e,t){i.$broadcast("loading:show",{text:"WAIT"})}),p=i.$on("$cordovaInAppBrowser:loadstop",function(e,t){i.$broadcast("loading:hide")}),u=i.$on("$cordovaInAppBrowser:exit",function(e,t){i.$broadcast("loading:hide")}),m=i.$on("$cordovaInAppBrowser:loaderror",function(e,t){i.$broadcast("loading:hide")}))}else{var n=window.open(t.target.attributes.link.nodeValue,"_blank");n.focus()}else a.signUpData.disclaimer=+!a.signUpData.disclaimer},a.signUpData={},a.doSignUp=function(){t.resize(),g.signupForm.$submitted=!0,g.signupForm.$valid&&(i.$broadcast("loading:show",{text:"SIGNING_UP"}),c.signUp(a.signUpData).success(function(e){i.$broadcast("loading:hide"),"Success"==e.status?n(["SUCCESS"]).then(function(t){a.alertPopup=r.alert({title:t.SUCCESS,template:e.description}),a.alertPopup.then(function(e){void 0!=e&&(a.alertPopup.close(),a.alertPopup=null,i.signupEmail=a.signUpData.email,o.transitionTo("app.login"))})}):n(["FAILED"]).then(function(t){r.alert({title:t.FAILED,template:e.description})})}).error(function(e){n(["SOMETHING_WRONG","FAILED"]).then(function(e){i.$broadcast("loading:hide"),r.alert({title:e.FAILED,template:e.SOMETHING_WRONG})})}))}}),a.$on("$destroy",function(){d&&(d(),p(),m(),u())})}]).controller("LoginCtrl",["Auth","$http","fireRef","$q","LanguagesService","$translate","$rootScope","$localStorage","$stateParams","$scope","$ionicPopup","$timeout","EmployeeService","$state",function(e,t,o,i,n,a,r,l,s,c,d,p,u,m){c.$on("$ionicView.afterEnter",function(t,s){c.view_loaded=!0,c.loginData={},r.signupEmail&&(c.loginData.email=r.signupEmail,r.signupEmail=null),null!=window.localStorage.getItem("apikeypublic")&&void 0!=window.localStorage.getItem("apikeypublic")&&m.transitionTo("app.employee-index"),c.getLanguages=function(e,t){var o=i.defer();return n.get().then(function(t){var i=t.data.filter(function(t){return 0==t.name.toLowerCase().indexOf(e.toLowerCase())});o.resolve(i)}),o.promise},c.setLanguage=function(e){c.language=e.item?e.item.code:e.code,c.loginData.language=e.name,c.showList=!1},c.languages=[{code:"en",name:"English"}],c.showList=!1,c.sclogin=function(t){e.authenticate(t).then(function(e){p(e)},function(e){r.$broadcast("loading:hide")})};var p=function(e){a.use(c.language),l.picData||""==e.user.pic?l.picData&&e.user.pic!=l.picData&&u.saveDriverPic(l.picData,"personal"):l.picData=e.user.pic,l.name=e.user.name,l.email=e.user.email,l.user_id=e.user.id,r.name=e.user.name,r.loggedIn=!0,l.stripe=e.user.stripe,u.checkPrice(),u.findAllEmployees().then(function(e){u.getVehiclesPermits(!0,!0),u.authenticateToken().then(function(){c.employees=u.getEmployees(),r.$broadcast("loading:hide");for(var e in u.getzoneIDs())o.child(e+"/queue").orderByChild("timestamp").once("value",function(t){u.setEmpl(t,e)});r.detail?m.transitionTo("app.trip-detail"):u.isDriver()&&!u.isViewingOrder()?m.transitionTo("app.employee-index"):m.transitionTo("app.quoteform"),r.$broadcast("loading:hide",!0),u.processFirebase(),u.checkMessages(),u.setGroups()})})},g=function(){a(["SOMETHING_WRONG","FAILED"]).then(function(e){r.$broadcast("loading:hide"),d.alert({title:e.FAILED,template:e.SOMETHING_WRONG})})};c.doLogin=function(e){e.$submitted=!0,e.$valid&&(r.$broadcast("loading:show",{text:"SIGNING_IN"}),u.login(c.loginData).success(function(e){"Success"==e.status?p(e):(r.$broadcast("loading:hide"),a(["FAILED","LOGIN_CHECK"]).then(function(t){var o="";"Please check your email address and or password."==e.description&&(o=t.LOGIN_CHECK),d.alert({title:t.FAILED,template:o})}))}).error(function(e){r.$broadcast("loading:hide"),g()}))}})}]).controller("ForgotPasswordCtrl",["$state","$rootScope","$translate","$scope","$ionicModal","$ionicPopup","$timeout","EmployeeService","$state",function(e,t,o,i,n,a,r,l,e){i.forgotData={},i.getPassword=function(n){n.$submitted=!0,n.$valid&&(t.$broadcast("loading:show"),l.forgotPassword(i.forgotData).success(function(i){t.$broadcast("loading:hide"),o(["SUCCESS","FAILED","PLEASE_CHECK_EMAIL"]).then(function(t){if("Success"==i.status){var o=t.SUCCESS;e.transitionTo("app.login")}else var o=t.FAILED;a.alert({title:o,template:t.PLEASE_CHECK_EMAIL})})}).error(function(e){o(["SOMETHING_WRONG","FAILED"]).then(function(e){t.$broadcast("loading:hide"),a.alert({title:e.FAILED,template:e.SOMETHING_WRONG})})}))}}]).controller("EmployeeIndexCtrl",["Initializer","MapServ","toastr","$ionicListDelegate","fireRef","$filter","$ionicFilterBar","$ionicScrollDelegate","$translate","$localStorage","$ionicPopup","$ionicPopover","$ionicModal","$timeout","GpsDetectService","$scope","EmployeeService","$rootScope","$state","$firebase","$ionicPlatform","$cordovaGeolocation",function(e,t,o,i,n,a,r,l,s,c,d,p,u,m,g,f,v,h,_,E,S,D){f.$on("$ionicView.afterEnter",function(n,l){e.mapsInitialized().then(function(){h.map||t.createMap(document.getElementById("googleMapWrapper"))});var p=f.$on("gmaps:loaded",function(){h.map||t.createMap(document.getElementById("googleMapWrapper"))});f.filteredArray=[];var g=f.$watchCollection("employees",function(e){f.filteredArray=a("filter")(e,function(e,t,o){return(e.dispatcher>0||e.apikeypublic==f.apikeypublic&&e.hasOwnProperty("can_bookin"))&&"My A2Bers"!=e.name&&!e.iscustomer})});f.user_id=c.user_id;var E=h.$watch("partnersQMode",function(e,t){e!=t&&(c.partnersQMode=h.partnersQMode,v.setGroupBidMode(e))});f.closeOption=function(){i.closeOptionButtons()},f.setBidMode=function(e){var t="quote"==e.mode?"offer":"quote";(e.biddable||"quote"!=t)&&(e.mode=t,v.setFbBidMode(e.category_id,t))};var S;f.showFilterBar=function(){S=r.show({items:f.employees,update:function(e,t){f.employees=e}})},f.initializing=v.isInitializingFB(),f.apikeypublic=window.localStorage.getItem("apikeypublic"),f.myrating=5,f.mypic=c.picData,f.searchKey="",v.setAllBookedStatus(),f.bookingChanged=function(e,t){v.toggleBook(t,e).then(function(e){})},f.clearSearch=function(){f.searchKey=""},f.startsWith=function(e,t){var o=(e+"").toLowerCase();return 0===o.indexOf(t.toLowerCase())},f.search=function(){v.findByName(f.searchKey).then(function(e){f.employees=e})};var D,y=function(){h.$broadcast("loading:show"),v.findAllEmployees().then(function(e){f.employees=v.getEmployees(),h.$broadcast("loading:hide")})},M=f.$on("internet:online",function(){null==v.getEmployees()&&y()}),T=f.$on("items:loaded",function(){f.employees=v.getEmployees(),h.$broadcast("loading:hide")});null!=v.getEmployees()?f.employees=v.getEmployees():h.$broadcast("loading:show");var k=f.$on("firebase:updated",function(e,t){f.employees=v.getEmployees()});f.showLargImage=function(e){f.allImages=[{src:e}],f.activeSlide=0,f.showModal("popovers/image-popover.html")},f.showModal=function(e){u.fromTemplateUrl(e,{scope:f,animation:"slide-in-up"}).then(function(e){f.fullSizeImageModal=e,f.fullSizeImageModal.show()})},f.closeModal=function(){f.fullSizeImageModal.hide(),f.fullSizeImageModal.remove()},f.isDriver=function(e){return e.my_tags&&e.my_tags.indexOf("Driver")>-1},f.getNoRatePlan=function(e){(services=v.getTagsRatePlan(e.category_id,e.my_tags))&&services.length>0&&s("NO_RATE_PLAN").then(function(t){o.info(services.join(", ")+" : <b>"+e.managerName+"</b>",t,{allowHtml:!0})})},f.isDisabled=!0,f.reportEvent=function(e){var t=$(this).find(".grouplist").data("id"),i=v.getEmployees()[t];if(e.target.className.indexOf("toggler")>-1){var n=i.booked,a=n?"-2":"2";return i.status=a,void(n?v.toggleBook(!n,i):i.allow_queue?v.hasServType(i.my_tags)?v.hasRatePlanServ(i.category_id,i.my_tags)?1==v.withinZone(i.category_id)?s(["SORRY","NO_ZONE"]).then(function(e){o.info(e.NO_ZONE,e.SORRY,{timeOut:3e3,positionClass:"toast-bottom-center"})}):v.isDispatcherAdmin(i.category_id)||v.withinZone(i.category_id)?f.isDriver(i)&&i.require_upload?v.getVehiclesPermits().then(function(){return v.checkForms(void 0,[!n,i])?(f.getNoRatePlan(i),void v.toggleBook(!n,i)):void h.$broadcast("loading:hide")}):(f.getNoRatePlan(i),v.toggleBook(!n,i)):s(["SORRY","NOT_IN_ZONE"]).then(function(e){o.info(e.NOT_IN_ZONE,e.SORRY,{timeOut:3e3,positionClass:"toast-bottom-center"})}):f.getNoRatePlan(i):s(["SORRY","NO_SERVICE_TYPE"]).then(function(e){o.info(e.NO_SERVICE_TYPE,e.SORRY,{timeOut:3e3,positionClass:"toast-bottom-center"})}):s(["SORRY","QUEUE_NOT_ALLOWED"]).then(function(e){o.info(e.QUEUE_NOT_ALLOWED,e.SORRY,{timeOut:3e3,positionClass:"toast-bottom-center"})}))}},f.dispatcherPage=function(e,t){var o=v.getEmployees()[t.id];if(e.offsetX<75&&$(e.target).find("img").length>0)f.showLargImage($(e.target).find("img")[0].src);else if("ION-OPTION-BUTTON"!=e.target.tagName&&(v.isDispatcherAdmin(t.category_id)||o&&o.my_tags.indexOf("Driver")>-1&&o.booked)&&null!=$(e.target).parent().data("link").match(/\d+/))if(!v.isDispatcherAdmin(t.category_id)&&t.booked){var i=v.getEmployees(),n=v.getGroupItems();h.tappedGroup=i[n[t.category_id].position],_.transitionTo("app.driver-home")}else _.transitionTo("app.employee-dispatcher",{employeeId:$(e.target).parent().data("link").match(/\d+/)[0]})},f.isOwner=function(e){return e==c.user_id},f.removeGroup=function(e){if(e.booked)return void s(["SORRY","BOOKOUT_FIRST"]).then(function(e){d.alert({cssClass:"bookoutFirst",title:e.SORRY,template:e.BOOKOUT_FIRST})});h.$broadcast("loading:show");var t={};v.getEmployees().forEach(function(o){o.category_id==e.category_id&&o.apikeypublic==window.localStorage.getItem("apikeypublic")&&(t=o)}),t.items=t.tags,void 0==t.items&&(t.items=[]),t.item="",t.itemType="",t.items.length>0&&(t.item=t.items.join(", "),t.itemType=t.items.join("&itemType[]=")),t.active=0,v.editDispatcherItem(t).then(function(e){v.findAllEmployees().then(function(e){v.autologin().then(function(e){h.$broadcast("items:loaded"),h.$broadcast("loading:hide")})})},function(){s(["SOMETHING_WRONG","FAILED"]).then(function(e){h.$broadcast("loading:hide"),d.alert({title:e.FAILED,template:e.SOMETHING_WRONG})})})},f.$on("$ionicView.beforeLeave",function(){S&&(S(),S=null),M(),k(),T(),D&&m.cancel(D),E&&E(),g&&g(),v.removeModalPopup(f,"fullSizeImageModal"),p()})})}]).controller("FormsCtrl",["$stateParams","Initializer","$q","$ionicSlideBoxDelegate","$q","$ionicPopup","$ionicPopover","$cordovaCamera","CityState","$stateParams","$localStorage","$translate","$ionicPopup","$ionicPopover","$ionicModal","$timeout","$scope","EmployeeService","$rootScope","$state",function(e,t,o,i,o,n,a,r,l,e,s,c,n,a,d,p,u,m,g,f){u.allFormsFilled=!1,u.validatingVin={valid:!1},u.openForm=function(e){u[e]?u[e].show():d.fromTemplateUrl("modals/"+e+".html",{scope:u,animation:"slide-in-up"}).then(function(t){u[e]=t,"vin"!=e&&u[e].show(),"vehicle"==e&&u.openForm("vin")})};var v=u.$on("modal.hidden",function(){g.setLocalNotif()}),h=u.$on("modal.shown",function(){g.clearNotifIntv()});u.defaultDob=moment().subtract(18,"years").format("MM-DD-YYYY"),u.allFilled=!1;var _;t.mapsInitialized().then(function(){_=new google.maps.places.AutocompleteService}),u.showVehicle=e.vehicle,u.showPermit=e.permit,u.numberOfForms=(0|u.showVehicle)+(u.showPermit?2:0)+(null==g.picData?1:0);var E=void 0;u.getTestItems=function(e){if(!e)return[];var t=o.defer();return E=p(function(){u.nottyped=!1;var o={};o.input=e,o.types=["(cities)"],o.componentRestrictions={country:g.countryCode},_.getPlacePredictions(o,function(e,o){if(o==google.maps.places.PlacesServiceStatus.OK){for(var i=[],n=0;n<e.length;n++)i.push(e[n]);t.resolve(i)}})},350),t.promise},u.driverData={},u.vehicleData={};var S=function(){u.items=u.cities,u.driverData.cities=[],u.driverData.city="",u.driverData.permit_cities=""},E=void 0;u.getStates=function(e){var t=o.defer();return E=p(function(){l.findStates(e).then(function(e){t.resolve(e)})},350),t.promise},0==l.getCities().length?l.setCities().then(function(e){u.cities=l.getCities(),S()}):(u.cities=l.getCities(),S()),u.state_text_single="",u.stateval={single:null,multiple:null},u.city_text_single="",u.cityval={single:null,multiple:null},u.citySelected=function(e){if(u.driverData.cities.indexOf(e)>-1){if(1==u.driverData.cities.length)return u.setCityCheckMark(!1),void u.driverData.cities.splice(u.driverData.cities.indexOf(e),1);u.driverData.cities.splice(u.driverData.cities.indexOf(e),1)}else u.driverData.cities.push(e);1==u.driverData.cities.length?u.driverData.permit_cities=u.driverData.city=u.driverData.cities[0]:(u.driverData.city=u.driverData.cities.join(", "),u.driverData.permit_cities=u.driverData.cities.join('&driver["permit_cities"]=')),u.setCityCheckMark(!0)},u.setCityCheckMark=function(e){u.items.forEach(function(t){u.driverData.cities.indexOf(t.id)>-1?t.checked=e?!0:!t.checked:t.checked=!1})},u.showCity=function(e){g.showFancy(e)},a.fromTemplateUrl("popovers/pic-options.html",{scope:u}).then(function(e){u.popoverPic=e}),u.driverFormImages={},u.permitFormImages={},u.vehicleFormImages={},u.showLargeImage=function(e,t){if(u.allImages=[],u.activeSlide=t,"picForm"==e)u.allImages.push({src:u.picData});else for(var o in u[e])u.allImages.push({src:u[e][o]});u.showModal("popovers/image-popover.html")},u.showModal=function(e){d.fromTemplateUrl(e,{scope:u,animation:"slide-in-up"}).then(function(e){u.fullSizeImageModal=e,u.fullSizeImageModal.show()})},u.closeModal=function(){u.fullSizeImageModal.hide(),u.fullSizeImageModal.remove()},u.picOption=function(e,t){return ionic.Platform.isWebView()?(u.picFieldType=t,void u.popoverPic.show(e)):void document.getElementById("file_"+t).click()},u.license_filled=!1,u.permit_filled=!1,u.vehicle_filled=!1,u.personal_filled=!1,u.licensedata=function(e){return u.license_filled?u.license_upload+", "+u.permit_city:""},u.vehicledata=function(e){return u.vehicle_filled?u.insurance+", "+u.inspection_expiry_date:""},u.permitdata=function(e){return u.permit_filled?u.permit_upload:""},u.personaldata=function(e){return u.personal_filled?u.personal_upload:""},u.licenseFileLoaded=function(e,t,o,i,n){u.license_upload=o.name,p(function(){u.driverData.license_upload="data:image/jpeg;base64,"+n[0].base64,u.driverFormImages.license_upload=u.driverData.license_upload})},u.permitFileLoaded=function(e,t,o,i,n){u.permit_upload=o.name,p(function(){u.driverData.permit_upload="data:image/jpeg;base64,"+n[0].base64,u.permitFormImages.permit_upload=u.driverData.permit_upload})},u.permitCityFileLoaded=function(e,t,o,i,n){u.permit_city=o.name,p(function(){u.driverData.permit_city="data:image/jpeg;base64,"+n[0].base64,u.driverFormImages.permit_city=u.driverData.permit_city})},u.insuranceFileLoaded=function(e,t,o,i,n){u.insurance=o.name,p(function(){u.vehicleData.insurance="data:image/jpeg;base64,"+n[0].base64,u.vehicleFormImages.insurance=u.vehicleData.insurance})},u.inspectionFileLoaded=function(e,t,o,i,n){u.inspection_expiry_date=o.name,p(function(){u.vehicleData.inspection_expiry_date="data:image/jpeg;base64,"+n[0].base64,u.vehicleFormImages.inspection_expiry=u.vehicleData.inspection_expiry_date})},u.takePic=function(e){u.popoverPic.isShown()&&u.popoverPic.hide();var t=u.picFieldType,o={quality:40,destinationType:Camera.DestinationType.DATA_URL,encodingType:Camera.EncodingType.JPEG,targetWidth:320,targetHeight:320,saveToPhotoAlbum:!1};o.sourceType="camera"==e?Camera.PictureSourceType.CAMERA:Camera.PictureSourceType.PHOTOLIBRARY,r.getPicture(o).then(function(e){"personal_upload"!=t?"permit_city"==t||"license_upload"==t||"permit_upload"==t?u.driverData[t]="data:image/jpeg;base64,"+e:u.vehicleData[t]="data:image/jpeg;base64,"+e:u.picData=u.personal_pic="data:image/jpeg;base64,"+e,u[t]=t+"_image.jpeg",window.resolveLocalFileSystemURL(e,function(o){alert(e),alert(o),o.file(function(e){alert(e.name),u[t]=e.name},function(){alert("error")})})},function(e){})},u.saveDriverInfo=function(e){return e.$submitted=!0,e.$valid?(u.license_filled=!0,u.driving.hide(),!0):!1},u.savePermitInfo=function(e){e.$submitted=!0,e.$valid&&(u.permit_filled=!0,u.permit.hide())},u.savePersonalPic=function(e){return e.$submitted=!0,e.$valid?(u.personal_filled=!0,u.personalpic.hide(),!0):!1},u.saveDateTime=function(e,t){var o=this.$parent.hasOwnProperty("vehicleForm")?"vehicleData":"driverData";u[o][t]=moment(new Date(e)).format("MM/DD/YY"),"year"==t&&(u.vehicleData[t]=moment(new Date(e)).format("YYYY"))},u.validvin=!0,u.vinFieldsFilled=!1,u.vinform={},u.saveVin=function(e){e.$submitted=!0,e.$valid&&(u.vinFieldsFilled=!0,u.vin.hide())},u.removeVinModal=function(){u.vin.hide()},u.done=function(e){g.$broadcast("loading:hide"),e&&!e.hasOwnProperty("status")?(u.validvin=!0,u.vehicleData.make=e.make.name,u.vehicleData.model=e.model.name,u.vehicleData.year=e.years[0].year,u.vehicleData.type=e.categories.vehicleType):u.validvin=!1},u.save=function(e){e.$submitted=!0;var t=[],i=u.showVehicle&&u.vehicle_filled?u.saveVehicle($("form[name='$parent.vehicleForm']").scope().$parent.vehicleForm):!1,n=u.showPermit&&u.license_filled&&u.permit_filled?u.saveDriverInfo($("form[name='$parent.driverForm']").scope().$parent.driverForm):!1,a=null==g.picData&&u.personal_filled?u.savePersonalPic($("form[name='$parent.personalForm']").scope().$parent.personalForm):!1;u.numberOfForms==(i?1:0)+(n?2:0)+(0==a?0:1)&&(i&&t.push(D()),n&&t.push(y()),a&&t.push(M()),u.allFormsFilled=!0,g.$broadcast("loading:show"),o.all(t).then(function(e){m.getVehiclesPermits(!0).then(function(){f.transitionTo("app.employee-index"),g.$broadcast("loading:hide")})}))};var D=function(){var e=o.defer();return m.saveVehicle(u.vehicleData).then(function(t){e.resolve()},function(t){e.reject()}),e.promise},y=function(){var e=o.defer();return u.driverData.permit_cities=u.driverData.city.join('&driver["permit_cities"]='),m.saveDriverInfo(u.driverData).then(function(t){e.resolve()},function(t){e.reject()}),e.promise},M=function(){var e=o.defer();return m.saveDriverPic(u.picData,"personal").then(function(){e.resolve()},function(t){e.reject()}),e.promise};u.saveVehicle=function(e){return e.$submitted=!0,e.vin.$pending&&e.vin.$pending.vin?void 0:e.$valid?(u.vehicle_filled=!0,u.vehicle.hide(),!0):!1},u.slide=function(e){var t=$('.slidingTabs li:contains("'+e+'")').index()+1;p(function(){$(".slidingTabs li:nth-child("+t+")").click()})},u.isMobile=ionic.Platform.isWebView(),u.loaded=function(e,t,o,i,n){u.personal_upload=o.name,p(function(){u.picData=u.personal_pic="data:image/jpeg;base64,"+angular.element(document.getElementById("file_personal_upload")).scope().myimage.base64})},u.takePicture=function(){var e={quality:80,destinationType:Camera.DestinationType.DATA_URL,sourceType:Camera.PictureSourceType.CAMERA,encodingType:Camera.EncodingType.JPEG,targetWidth:320,saveToPhotoAlbum:!1};r.getPicture(e).then(function(e){u.picData="data:image/jpeg;base64,"+e,u.ftLoad=!0,u.nopic=!0},function(e){})},u.selectPicture=function(){var e={quality:80,destinationType:Camera.DestinationType.DATA_URL,sourceType:Camera.PictureSourceType.PHOTOLIBRARY,encodingType:Camera.EncodingType.JPEG};r.getPicture(e).then(function(e){"content://com.android"==e.substring(0,21)&&(e="content://media/external/images/media/"+e.split("%3A")[1]),u.picData="data:image/jpeg;base64,"+e,u.ftLoad=!0},function(e){})},u.uploadPicture=function(){return u.ftLoad?!0:(u.nopic=!0,u.slide("Picture"),!1)},u.$on("$destroy",function(){u.vin&&(u.vin.remove(),u.vin=null),u.driving&&(u.driving.remove(),u.driving=null),u.permit&&(u.permit.remove(),u.permit=null),u.vehicle&&(u.vehicle.remove(),u.vehicle=null),u.personalpic&&(u.personalpic.remove(),u.personalpic=null),l.clearStates(),v(),h()})}]).controller("EmployeeDrivingCtrl",["$q","$ionicPopup","$ionicPopover","$cordovaCamera","CityState","$stateParams","$localStorage","$translate","$ionicPopup","$ionicModal","$timeout","$scope","EmployeeService","$rootScope","$state",function(e,t,o,i,n,a,r,l,t,s,c,d,p,u,m){d.$on("$destroy",function(){n.clearStates()}),d.defaultDob=moment().subtract(18,"years").format("MM-DD-YYYY");var g=new google.maps.places.AutocompleteService,f=void 0;d.getTestItems=function(t){if(!t)return[];var o=e.defer();return f=c(function(){d.nottyped=!1;var e={};e.input=t,e.types=["(cities)"],e.componentRestrictions={country:u.countryCode},g.getPlacePredictions(e,function(e,t){if(t==google.maps.places.PlacesServiceStatus.OK){for(var i=[],n=0;n<e.length;n++)i.push(e[n]);o.resolve(i)}})},350),o.promise},d.driverData={},d.saveDateTime=function(e,t){d.driverData[t]=moment(new Date(e)).format("MM/DD/YY")};var v=function(){d.items=d.cities,d.driverData.cities=[],d.driverData.city="",d.driverData.permit_cities=""},f=void 0;d.getStates=function(t){var o=e.defer();return f=c(function(){n.findStates(t).then(function(e){o.resolve(e)})},350),o.promise},0==n.getCities().length?n.setCities().then(function(e){d.cities=n.getCities(),v()}):(d.cities=n.getCities(),v()),d.state_text_single="",d.stateval={single:null,multiple:null},d.city_text_single="",d.cityval={single:null,multiple:null},d.citySelected=function(e){if(d.driverData.cities.indexOf(e)>-1){if(1==d.driverData.cities.length)return d.setCityCheckMark(!1),void d.driverData.cities.splice(d.driverData.cities.indexOf(e),1);d.driverData.cities.splice(d.driverData.cities.indexOf(e),1)}else d.driverData.cities.push(e);1==d.driverData.cities.length?d.driverData.permit_cities=d.driverData.city=d.driverData.cities[0]:(d.driverData.city=d.driverData.cities.join(", "),d.driverData.permit_cities=d.driverData.cities.join('&driver["permit_cities"]=')),d.setCityCheckMark(!0)},d.setCityCheckMark=function(e){d.items.forEach(function(t){d.driverData.cities.indexOf(t.id)>-1?t.checked=e?!0:!t.checked:t.checked=!1})},d.showCity=function(e){u.showFancy(e)},o.fromTemplateUrl("popovers/pic-options.html",{scope:d}).then(function(e){d.popoverPic=e}),d.driverFormImages={},d.permitFormImages={},d.showLargeImage=function(e,t){d.allImages=[],d.activeSlide=t;for(var o in d[e])d.allImages.push({src:d[e][o]});d.showModal("popovers/image-popover.html")},d.showModal=function(e){s.fromTemplateUrl(e,{scope:d,animation:"slide-in-up"}).then(function(e){d.fullSizeImageModal=e,d.fullSizeImageModal.show()})},d.closeModal=function(){d.fullSizeImageModal.hide(),d.fullSizeImageModal.remove()},d.licenseFileLoaded=function(e,t,o,i,n){d.license_upload=o.name,c(function(){d.driverData.license_upload="data:image/jpeg;base64,"+n[0].base64,d.driverFormImages.license_upload=d.driverData.license_upload})},d.permitCityFileLoaded=function(e,t,o,i,n){d.permit_city=o.name,c(function(){d.driverData.permit_city="data:image/jpeg;base64,"+n[0].base64,d.driverFormImages.permit_city=d.driverData.permit_city})},d.permitFileLoaded=function(e,t,o,i,n){d.permit_upload=o.name,c(function(){d.driverData.permit_upload="data:image/jpeg;base64,"+n[0].base64,d.permitFormImages.permit_upload=d.driverData.permit_upload})},d.picOption=function(e,t){return ionic.Platform.isWebView()?(d.picFieldType=t,void d.popoverPic.show(e)):void document.getElementById("file_"+t).click()},d.takePic=function(e){d.popoverPic.isShown()&&d.popoverPic.hide();var t=d.picFieldType,o={quality:40,destinationType:Camera.DestinationType.DATA_URL,encodingType:Camera.EncodingType.JPEG,targetWidth:320,targetHeight:320,saveToPhotoAlbum:!1};o.sourceType="camera"==e?Camera.PictureSourceType.CAMERA:Camera.PictureSourceType.PHOTOLIBRARY,i.getPicture(o).then(function(e){d.driverData[t]="data:image/jpeg;base64,"+e,$("#"+t).hasClass("button-positive")||$("#"+t).addClass("button-positive"),d[t]=t+"_image.jpeg"},function(e){})},d.saveDriverInfo=function(e){e.$submitted=!0,e.$valid&&(d.driverData.city&&(d.driverData.permit_cities=d.driverData.city.join('&driver["permit_cities"]=')),u.$broadcast("loading:show"),p.saveDriverInfo(d.driverData).then(function(e){p.getVehiclesPermits(!0).then(function(){u.$broadcast("loading:hide"),l(["SUCCESS","FORM_SUBMITTED"]).then(function(e){t.alert({title:e.SUCCESS,template:e.FORM_SUBMITTED})}),m.transitionTo("app.employee-index")})},function(e){l(["SOMETHING_WRONG","FAILED"]).then(function(e){u.$broadcast("loading:hide"),t.alert({title:e.FAILED,template:e.SOMETHING_WRONG})})}))}}]).controller("EmployeePOICtrl",["toastr","$q","$stateParams","$localStorage","$translate","$ionicPopup","$ionicModal","$timeout","$scope","EmployeeService","$rootScope","$state",function(e,t,o,i,n,a,r,l,s,c,d,p){var u=new google.maps.places.AutocompleteService,m=void 0;s.pois=null,s.locations=[],s.search={value:""},s.loading=!1,s.searchPoi=!1,s.showSearch=function(){s.searchPoi=!0},s.getPOIs=function(){d.$broadcast("loading:show"),c.getPOIs().then(function(e){s.pois=e.hasOwnProperty("pois")?e.pois:[],d.$broadcast("loading:hide"),s.locations=[],s.search={value:""}},function(){})},s.getPOIs(),s.findPOI=function(e){m=l(function(){if(!(s.search.value.length<2)){s.loading=!0,s.locations=[];var t={};t.input=e,t.componentRestrictions={country:d.countryCode},u.getPlacePredictions(t,function(e,t){if(t==google.maps.places.PlacesServiceStatus.OK)for(var o=[],i=0;i<e.length;i++)googlePlacesService=new google.maps.places.PlacesService($("#ionsearch")[0]),googlePlacesService.getDetails({reference:e[i].reference},function(e,t){e&&(o.push(e),s.locations.push(e),s.loading&&l(function(){s.loading=!1}),s.search.value.length<2&&(s.locations=[]))});else s.loading=!1})}},350)};var g=s.$watch("search.value",function(e,t){e.length>1?s.findPOI(e):(s.loading=!1,s.locations=[])});s.clearSearch=function(){s.search.value=""},s.saveLocation=function(e){s.data={},s.types=[],s.data.showtype=!1,n(["AIRPORTS","APARTMENTS","BARS","BUS_STATIONS","COFFEE_SHOPS","CHURCHES","COLLEGES","CONVENTION","HOSPITALS","HOTELS","INTERSECTIONS","MALLS","OFFICE","PARKS","POI","RETAIL","TRAIN","UNIVERSITIES"]).then(function(e){for(var t in e)s.types.push(e[t])}),s.selectType=function(e){s.data.showtype=!s.data.showtype,s.data.type=e};var t=['<input placeholder="{{\'PLEASE_ENTER_NAME\' | translate}}" type="text" ng-model="data.name">','<div class="list list-inset cont-list">','<div ng-click="data.showtype=!data.showtype" class="modal-list-items bar item-input-inset search-bar">','<label class="item-input-wrapper">','<input class="google-place-search pickup" readonly placeholder="{{\'LOCATION_TYPE\' | translate}}" type="text" ng-model="data.type">',"</label>","<span ng-class=\"{'ion-android-arrow-dropup': data.showtype, 'ion-android-arrow-dropdown' : !data.showtype}\" class=\"button button-clear icon dropdown-icon typedropdown\"></span>","</div>",'<ion-list ng-show="data.showtype">','<ion-item ng-repeat="type in types" class="item-text-wrap" ng-click="selectType(type)">',"{{type}}","</ion-item>","</ion-list>","</div>"].join("");
n(["CANCEL","SAVE","ENTER_POI_NAME"]).then(function(o){var i=a.show({cssClass:"poiAlert",template:t,title:o.ENTER_POI_NAME,subTitle:e.name+", "+e.vicinity,scope:s,buttons:[{text:o.CANCEL},{text:"<b>"+o.SAVE+"</b>",type:"button-positive",onTap:function(e){return s.data.name&&s.data.type?!0:void e.preventDefault()}}]});i.then(function(t){t&&(s.data.address=e.name+", "+e.vicinity,s.data.lat=e.geometry.location.lat(),s.data.lng=e.geometry.location.lng(),s.savePOI())})})},s.savePOI=function(){d.$broadcast("loading:show"),c.savePOI(s.data).then(function(t){d.$broadcast("loading:hide"),n(["SUCCESS","POI_SAVED"]).then(function(t){e.success(t.POI_SAVED,t.SUCCESS,{timeOut:3e3,positionClass:"toast-bottom-center"})}),s.getPOIs()},function(e){n(["SOMETHING_WRONG","FAILED"]).then(function(e){d.$broadcast("loading:hide"),a.alert({title:e.FAILED,template:e.SOMETHING_WRONG})})})},s.deletePOI=function(e){d.$broadcast("loading:show"),c.savePOI(e,!0).then(function(e){d.$broadcast("loading:hide"),s.getPOIs()},function(e){n(["SOMETHING_WRONG","FAILED"]).then(function(e){d.$broadcast("loading:hide"),a.alert({title:e.FAILED,template:e.SOMETHING_WRONG})})})},s.$on("$ionicView.beforeLeave",function(){g()})}]).controller("EmployeePasswordCtrl",["$stateParams","$localStorage","$translate","$ionicPopup","$ionicPopover","$ionicModal","$timeout","$scope","EmployeeService","$rootScope","$state",function(e,t,o,i,n,a,r,l,s,c,d){l.changepwdData={},l.changePassword=function(e){e.$submitted=!0,e.$valid&&(c.$broadcast("loading:show"),s.changePassword(l.changepwdData).then(function(e){c.$broadcast("loading:hide"),"Success"==e.status?o(["SUCCESS"]).then(function(t){i.alert({title:t.SUCCESS,template:e.description})}):o(["FAILED"]).then(function(t){i.alert({title:t.FAILED,template:e.description})})},function(e){o(["SOMETHING_WRONG","FAILED"]).then(function(e){c.$broadcast("loading:hide"),i.alert({title:e.FAILED,template:e.SOMETHING_WRONG})})}))}}]).controller("EmployeeVehicleCtrl",["$cordovaCamera","$stateParams","$localStorage","$translate","$ionicPopup","$ionicPopover","$ionicModal","$timeout","$scope","EmployeeService","$rootScope","$state",function(e,t,o,i,n,a,r,l,s,c,d,p){s.validatingVin={valid:!1},a.fromTemplateUrl("popovers/pic-options.html",{scope:s}).then(function(e){s.popoverPic=e}),r.fromTemplateUrl("modals/vin.html",{scope:s,animation:"slide-in-up"}).then(function(e){s.vin=e}),s.saveDateTime=function(e,t){s.vehicleData[t]=moment(new Date(e)).format("MM/DD/YY"),"year"==t&&(s.vehicleData[t]=moment(new Date(e)).format("YYYY"))},s.picOption=function(e,t){return ionic.Platform.isWebView()?(s.picFieldType=t,void s.popoverPic.show(e)):void document.getElementById("file_"+t).click()},s.takePic=function(t){s.popoverPic.isShown()&&s.popoverPic.hide();var o=s.picFieldType,i={quality:40,destinationType:Camera.DestinationType.DATA_URL,encodingType:Camera.EncodingType.JPEG,targetWidth:320,targetHeight:320,saveToPhotoAlbum:!1};i.sourceType="camera"==t?Camera.PictureSourceType.CAMERA:Camera.PictureSourceType.PHOTOLIBRARY,e.getPicture(i).then(function(e){s[o]=o+"_image.jpeg",s.vehicleData[o]="data:image/jpeg;base64,"+e},function(e){})},s.vehicleData={},s.validvin=!0,s.vinFieldsFilled=!1,s.vinform={},s.saveVin=function(e){e.$submitted=!0,e.$valid&&(s.vinFieldsFilled=!0,s.vin.hide())},s.removeVinModal=function(){s.vin.hide()},s.done=function(e){d.$broadcast("loading:hide"),e&&!e.hasOwnProperty("status")?(s.validvin=!0,s.vehicleData.make=e.make.name,s.vehicleData.model=e.model.name,s.vehicleData.year=e.years[0].year,s.vehicleData.type=e.categories.vehicleType):s.validvin=!1},s.vehicleFormImages={},s.showLargeImage=function(e,t){s.allImages=[],s.activeSlide=t;for(var o in s[e])s.allImages.push({src:s[e][o]});s.showModal("popovers/image-popover.html")},s.showModal=function(e){r.fromTemplateUrl(e,{scope:s,animation:"slide-in-up"}).then(function(e){s.fullSizeImageModal=e,s.fullSizeImageModal.show()})},s.closeModal=function(){s.fullSizeImageModal.hide(),s.fullSizeImageModal.remove()},s.insuranceFileLoaded=function(e,t,o,i,n){s.insurance=o.name,l(function(){s.vehicleData.insurance="data:image/jpeg;base64,"+n[0].base64,s.vehicleFormImages.insurance=s.vehicleData.insurance})},s.inspectionFileLoaded=function(e,t,o,i,n){s.inspection_expiry_date=o.name,l(function(){s.vehicleData.inspection_expiry_date="data:image/jpeg;base64,"+n[0].base64,s.vehicleFormImages.inspection_expiry=s.vehicleData.inspection_expiry_date})},s.saveVehicle=function(e){e.$submitted=!0,e.vin.$pending&&e.vin.$pending.vin||e.$valid&&(d.$broadcast("loading:show"),c.saveVehicle(s.vehicleData).then(function(e){c.getVehiclesPermits(!0).then(function(){d.$broadcast("loading:hide"),i(["SUCCESS"]).then(function(t){n.alert({title:t.SUCCESS,template:e.description})}),p.transitionTo("app.employee-index")})},function(e){i(["SOMETHING_WRONG","FAILED"]).then(function(e){d.$broadcast("loading:hide"),n.alert({title:e.FAILED,template:e.SOMETHING_WRONG})})}))},s.$on("$destroy",function(){s.vin&&(s.vin.remove(),s.vin=null),s.popoverPic&&(s.popoverPic.remove(),s.popoverPic=null)})}]).controller("EmployeePicCtrl",["$localStorage","$state","$ionicModal","$timeout","$ionicPopover","$ionicPopup","EmployeeService","$translate","$rootScope","$scope","$cordovaCamera","baseUrl",function(e,t,o,i,n,a,r,l,s,c,d,p){c.showLargeImage=function(){"img/camera.png"!=c.picData&&(c.allImages=[{src:c.picData}],c.activeSlide=0,c.showModal("popovers/image-popover.html"))},c.showModal=function(e){o.fromTemplateUrl(e,{scope:c,animation:"slide-in-up"}).then(function(e){c.fullSizeImageModal=e,c.fullSizeImageModal.show()})},c.closeModal=function(){c.fullSizeImageModal.hide(),c.fullSizeImageModal.remove()},n.fromTemplateUrl("popovers/pic-options.html",{scope:c}).then(function(e){c.popoverPic=e}),c.picData="img/camera.png",c.picOption=function(e,t){return ionic.Platform.isWebView()?void c.popoverPic.show(e):void document.getElementById("file_"+t).click()},c.loaded=function(e,t,o,n,a){c.personal_upload=o.name,i(function(){c.picData=c.personal_pic="data:image/jpeg;base64,"+angular.element(document.getElementById("file_personal_upload")).scope().myimage.base64})},c.ftLoad=!1,c.isMobile=ionic.Platform.isWebView(),c.takePic=function(e){c.popoverPic.isShown()&&c.popoverPic.hide();var t={quality:80,destinationType:Camera.DestinationType.DATA_URL,sourceType:Camera.PictureSourceType.CAMERA,encodingType:Camera.EncodingType.JPEG,targetWidth:320,saveToPhotoAlbum:!1};t.sourceType="camera"==e?Camera.PictureSourceType.CAMERA:Camera.PictureSourceType.PHOTOLIBRARY,d.getPicture(t).then(function(e){c.personal_upload="personal_upload_image.jpeg",c.picData=c.personal_pic="data:image/jpeg;base64,"+e,c.ftLoad=!0},function(e){})},c.selectPicture=function(){var e={quality:80,destinationType:Camera.DestinationType.DATA_URL,sourceType:Camera.PictureSourceType.PHOTOLIBRARY,encodingType:Camera.EncodingType.JPEG};d.getPicture(e).then(function(e){"content://com.android"==e.substring(0,21)&&(e="content://media/external/images/media/"+e.split("%3A")[1]),c.picData="data:image/jpeg;base64,"+e,c.ftLoad=!0},function(e){})},c.savePersonalPic=function(o){o.$submitted=!0,o.$valid&&(s.$broadcast("loading:show"),r.saveDriverPic(c.picData,"personal").then(function(){l(["PIC_UPLOADED","SUCCESS"]).then(function(o){s.$broadcast("loading:hide"),a.alert({title:o.SUCCESS,template:o.PIC_UPLOADED}),e.isDriver?t.transitionTo("app.employee-index"):t.transitionTo("app.quoteform")})},function(e){l(["SOMETHING_WRONG","FAILED"]).then(function(e){s.$broadcast("loading:hide"),a.alert({title:e.FAILED,template:e.SOMETHING_WRONG})})}))},c.$on("$destroy",function(){c.popoverPic&&(c.popoverPic.remove(),c.popoverPic=null)})}]).controller("AddGroupCtrl",["toastr","fireRef","$filter","$ionicScrollDelegate","$ionicPopover","$cordovaCamera","$stateParams","$localStorage","$translate","$ionicPopup","$ionicPopover","$ionicModal","$timeout","$scope","EmployeeService","$rootScope","$state",function(e,t,o,i,n,a,r,l,s,c,n,d,p,u,m,g,f){var v=this;v.planForm=null,u.$on("$ionicView.afterEnter",function(t,h){n.fromTemplateUrl("popovers/pic-options.html",{scope:u}).then(function(e){u.popoverPic=e}),s(["BIDDABLE","REQ_DOC_UPLD","ZONE_BASED","RADIUS_BASED"]).then(function(e){u.settings=[{enabled:g.biddable,val:"biddable",text:e.BIDDABLE},{enabled:m.isOwner()&&g.rquire_uppload,val:"rquire_uppload",text:e.REQ_DOC_UPLD}]}),u.picOption=function(e){return ionic.Platform.isWebView()?void u.popoverPic.show(e):void document.getElementById("group_pic_upload").click()},u.picLoaded=function(e,t,o,i,n){p(function(){u.groupData.pic="data:image/jpeg;base64,"+n[0].base64})},u.takePic=function(e){u.popoverPic.isShown()&&u.popoverPic.hide();var t={quality:40,destinationType:Camera.DestinationType.DATA_URL,encodingType:Camera.EncodingType.JPEG,targetWidth:320,targetHeight:320,saveToPhotoAlbum:!1};t.sourceType="camera"==e?Camera.PictureSourceType.CAMERA:Camera.PictureSourceType.PHOTOLIBRARY,a.getPicture(t).then(function(e){u.groupData.pic="data:image/jpeg;base64,"+e},function(e){})},u.alreadyExists=function(e){return"My A2Bers"!=e},d.fromTemplateUrl("modals/market.html",{scope:u,animation:"slide-in-up"}).then(function(e){u.vin=e}),u.showMarket=function(){u.filteredCenters.length>0?u.showMarketList=!u.showMarketList:u.viewMarket()},u.viewMarket=function(e){if(u.centerSelected=!0,e?(e.location?(u.groupData.center=e.location,u.groupData.formatted_address=e.location):m.getLocation(e.lat,e.lon).then(function(e){u.groupData.formatted_address=e,u.groupData.center=e}),u.groupData.center_name=e.name,u.groupData.center_id=e.id,u.groupData.lat=e.lat,u.groupData.lon=e.lon,u.groupData.radius=Number(e.radius),u.groupData.zone_radius=Number(e.zone_radius)):(u.groupData.center_id=null,u.groupData.center=null,u.groupData.formatted_address=null,u.groupData.center_name=null,u.groupData.lat=null,u.groupData.lon=null,u.groupData.radius=null,u.groupData.zone_radius=null),null!=u.marketModal)return void u.marketModal.show();d.fromTemplateUrl("modals/market.html",{scope:u,animation:"slide-in-up",backdropClickToClose:!1}).then(function(e){u.marketModal=e,e.show()})},u.removeMarketModal=function(){u.marketModal.hide()},u.verifyDuplicate=function(e){var t=!1;u.centers.some(function(e){return e.id!=u.groupData.center_id&&(t=e.name==u.groupData.center_name)}),u.oldcenters.some(function(e){return e.id!=u.groupData.center_id&&(t=e.name==u.groupData.center_name)}),e.name.$setValidity("duplicate",!t)},u.saveMarket=function(e){if(e.$submitted=!0,e.$valid){var t={location:u.groupData.center,name:u.groupData.center_name,id:u.groupData.center_id,lat:u.groupData.lat,lon:u.groupData.lon,radius:u.groupData.radius,zone_radius:u.groupData.zone_radius};if(u.groupData.center_id){var o;u.centers.some(function(e,t){return e.id==u.groupData.center_id?o=t:void 0});var i=-1;u.groupData.zones.some(function(e,t){return e.id==u.groupData.center_id?i=t:void 0}),-1==i?u.groupData.zones.push(t):u.groupData.zones[i]=t,u.centers[o]=t}else t.id=Math.abs(Math.random().toString().split("").reduce(function(e,t){return(e<<5)-e+t})).toString(36).substr(0,11)+(new Date).getTime(),u.centers.push(t),u.groupData.zones.push(t);u.removeMarketModal()}},u.deleteMarket=function(){var e;u.centers.some(function(t,o){return t.id==u.groupData.center_id?e=o:void 0}),u.centers.splice(e,1),u.oldcenters.some(function(e){return e.id==u.groupData.center_id?u.groupData.zonesDelete.push(e):void 0}),u.removeMarketModal()},u.filterFunc=function(e){return"string"==typeof e.lat},u.showPlan=function(){u.rateplans&&u.rateplans.length>0?u.showPlanList=!u.showPlanList:u.viewPlan()},u.viewPlan=function(e,t){return u.rateplan={},u.rateplan.settings=[],u.newplan=!0,e&&(u.newplan=!1,u.rateplan=angular.copy(e)),null!=u.planModal?void u.planModal.show():void u.createPlanModal(!0)},u.createPlanModal=function(e){u.planModal||d.fromTemplateUrl("modals/rateplan.html",{scope:u,animation:"slide-in-up",backdropClickToClose:!1}).then(function(t){u.planModal=t,e&&u.planModal.show()})},p(function(){u.createPlanModal()},2e3),u.removePlanModal=function(e){e&&u.oldplans&&u.oldplans.forEach(function(e){if(u.rateplan.id&&u.rateplan.id==e.id){var t={};t.id=e.id,t.name=e.name,t.rateplan=[],e.settings.forEach(function(e,o){t.rateplan.push("rateplan["+o+"]="+e)}),u.rateplan=t}}),u.planModal.hide(),p(function(){v.planForm.$setPristine()},2e3)},u.savePlan=function(){u.rateplan.settings[0]=u.days[0],u.rateplan.settings[1]=u.times[0],u.rateplan.settings[2]=u.days[0],u.rateplan.settings[3]=u.times[0],u.rateplan.settings[7]=u.times[0],u.rateplan.settings[11]=u.pickups[0],u.rateplan.settings[12]=u.pickups[0],u.rateplan.settings[13]=0,u.rateplan.settings[14]="Any";var e=!0;if(v.planForm.$submitted=!0,u.oldplans&&u.oldplans.forEach(function(t){u.rateplan.id&&u.rateplan.id==t.id&&angular.equals(u.rateplan,t)&&(e=!1)}),u.rateplans.forEach(function(e){(u.newplan||u.rateplan.id&&u.rateplan.id!=e.id)&&angular.equals(u.rateplan,e)?(v.planForm.$valid=!1,v.planForm.planexists.$valid=!1):!u.newplan&&u.rateplan.id&&u.rateplan.id==e.id&&(e.name=u.rateplan.name,u.rateplan.settings.forEach(function(t,o){e.settings[o]=t}))}),v.planForm.$valid){if(e){var t={};t.id=u.rateplan.id,t.name=u.rateplan.name,t.rateplan=[],u.rateplan.settings.forEach(function(e,o){t.rateplan.push("rateplan["+o+"]="+e)}),u.newplan&&u.rateplans.push(u.rateplan),u.groupData.toSaveRateplans.push(t)}u.removePlanModal()}},u.isSelectedService=function(e){return u.planModal&&u.planModal.isShown()&&u.rateplan?u.rateplan.settings[9]?u.rateplan.settings[9]==e:!1:(u.rateplan={},u.rateplan.settings=[],!1)},u.hasRatePlan=function(e){var t=!1;return u.rateplans.some(function(o){return o.settings[9]==e?t=!0:void 0}),t},u.setRateService=function(e){u.rateplan.settings[9]=e.text,u.showDayTime("RateServ")},u.noService=function(t){t.enabled&&!u.hasRatePlan(t.text)&&s("NO_RATE_PLAN").then(function(o){e.info(o+t.text)}),t.enabled?u.selectedServ++:u.selectedServ--,u.selectedServ>0&&v.groupForm.services.$setValidity("groupservice",!0)},u.isSelectedTime=function(e,t){return u.planModal&&u.planModal.isShown()&&u.rateplan?u.rateplan.settings[e]?u.rateplan.settings[e]==t:!1:(u.rateplan={},u.rateplan.settings=[],!1)},u.setTime=function(e,t,o){u.rateplan.settings[t]=o,u.showDayTime(e)},u.showDayTime=function(e){u["show"+e+"List"]=!u["show"+e+"List"],i.resize()};var _=u.$watchCollection("centers",function(e){u.filteredCenters=o("filter")(e,function(e,t,o){return"string"==typeof e.lat})});u.selectLocation=function(e){void 0!=e.geometry&&(u.groupData.lat=e.geometry.location.lat().toString(),u.groupData.lon=e.geometry.location.lng().toString(),u.groupData.formatted_address=e.formatted_address,u.groupData.center=e.formatted_address,u.resizeScroll(),u.resetAutoComplete())},u.clearSearch=function(){u.groupData.center="",u.centerSelected=!0};var E=u.$watch("locations",function(e){e&&e&&e.length>0&&u.resizeScroll()}),S=u.$watch("groupData.center",function(e){if(e){if(e==u.groupData.formatted_address)return;u.centerSelected=!1,m.findplaces(e,"",u,angular.element(document.querySelector(".centerautocomplete")))}else u.resetAutoComplete()}),D=u.$watch("groupData.zone_based_queuing",function(e){e&&(u.groupData.lat=null,u.groupData.lon=null,u.groupData.formatted_address=null,u.groupData.center=null)});u.resizeScroll=function(){i.resize()},u.resetAutoComplete=function(){u.locations&&(u.locations.length=0),u.typed=!1,u.centerSelected=!0},u.removeGroupModal=function(){u.groupModal.remove(),u.groupModal=null};var y=1;m.getEmployees().forEach(function(e){e.hasOwnProperty("can_bookin")&&e.user_id==l.user_id&&y++}),u.groupHeader="ADD_GROUP",u.groupFooter="ADD",u.groupData={},u.rateplan={},u.rateplan.settings=[],u.groupData.toSaveRateplans=[],u.groupData.active=0,u.groupData.name=l.name,u.groupData.tags=[],u.groupData.services=[],u.groupData.allow_queue=g.allow_queue,u.groupData.zone_based_queuing=!0,u.services=[],u.rateservices=[],u.centers=[],u.oldcenters=[],u.rateplans=[],u.groupData.zones=[],u.groupData.zonesDelete=[],u.selectedServ=0;var M=m.getzoneMap();for(var T in m.getTagsDriverDefault())"all"!=T&&(u.services.push({enabled:!1,text:T,icon:"pics/taxi.png"}),u.rateservices.push({enabled:!1,text:T,icon:"pics/taxi.png"}));u.days=["Always","Weekdays","Weekends"],u.times=["All Day","Mornings","Afternoons","Nights","Late Nights"],u.pickups=["Any"],moment.range(moment(),moment().add(1,"months")).by("days",function(e){u.days.push(e.format("MM/DD/YYYY"))}),moment.range(moment().startOf("day"),moment().endOf("day")).by("hours",function(e){u.times.push(e.format("HH:mm")),u.times.push(e.add(30,"minutes").format("HH:mm"))}),""!=r.id&&(m.getEmployees().forEach(function(e){e.id==r.id&&e.user_id==l.user_id&&(u.groupData.name=e.name,u.groupData.active=parseInt(e.active),e.settings&&Object.keys(e.settings).length>0&&(u.groupData.allow_advance_reservation=parseInt(e.settings.allow_advance_reservation),u.groupData.allow_remote_reservation=parseInt(e.settings.allow_remote_reservation),u.groupData.jail=parseInt(e.settings.jail),u.groupData.offer=parseInt(e.settings.offer),u.groupData.zone_based_queuing="yes"==e.settings.zone_based_queuing,u.groupData.allow_queue=g.allow_queue,u.services.forEach(function(t){t.enabled=e.settings.services.indexOf(t.text)>-1,t.enabled&&u.selectedServ++})),u.groupHeader=e.firstName,u.groupImg=e.pic,u.groupFooter="UPDATE",u.groupData.id=e.category_id,M.hasOwnProperty(e.category_id)&&M[e.category_id].length>0&&(u.centers=M[e.category_id].slice(0),u.oldcenters=M[e.category_id].slice(0),M[e.category_id].forEach(function(e){u.pickups.push(e.name)})))}),m.fetchPlans(u.groupData.id).then(function(e){u.rateplans=[],e.rateplans.forEach(function(e){e.settings&&(u.rateplans.push(e),e.name=e.name.replace("Rate Plan ",""),e.settings[4]=parseFloat(e.settings[4]),e.settings[5]=parseFloat(e.settings[5]),e.settings[6]=parseFloat(e.settings[6]),e.settings[7]=parseFloat(e.settings[7]),e.settings[8]=parseFloat(e.settings[8]),e.settings[10]=parseFloat(e.settings[10]),e.settings[13]=parseFloat(e.settings[13]))}),u.oldplans=angular.copy(u.rateplans)})),u.groupServiceSelected=function(){return u.selectedServ>0};var k=function(e){return e[0].toUpperCase()+e.substr(1).toLowerCase()};s(["AND","MUST_BE","GREATER_THEN","LESS_THEN","BETWEEN"]).then(function(e){u.err_greater=k(e.MUST_BE+" "+e.GREATER_THEN+" "),u.err_less=k(e.MUST_BE+" "+e.LESS_THEN+" ")}),u.watchAdvanceRemote=function(){v.groupForm.$submitted&&(m.isOwner()&&u.groupData.allow_advance_reservation<g.allow_advance_reservation?(u.err_advance=u.err_greater+g.allow_advance_reservation,v.groupForm.allow_advance_reservation.$setValidity("advance_reservation",!1)):u.groupData.allow_advance_reservation>u.groupData.allow_remote_reservation?(u.err_advance=u.err_less+u.groupData.allow_remote_reservation,v.groupForm.allow_advance_reservation.$setValidity("advance_reservation",!1)):v.groupForm.allow_advance_reservation.$setValidity("advance_reservation",!0),m.isOwner()&&u.groupData.allow_remote_reservation>g.allow_remote_reservation?(u.err_advance=u.err_greater+g.allow_remote_reservation,v.groupForm.allow_remote_reservation.$setValidity("remote_reservation",!1)):u.groupData.allow_remote_reservation<u.groupData.allow_remote_reservation?(u.err_advance=u.err_greater+u.groupData.allow_advance_reservation,v.groupForm.allow_remote_reservation.$setValidity("remote_reservation",!1)):v.groupForm.allow_remote_reservation.$setValidity("remote_reservation",!0))},u.addGroup=function(){if(v.groupForm.$submitted=!0,u.watchAdvanceRemote(),0==u.selectedServ&&v.groupForm.services.$setValidity("groupservice",!1),v.groupForm.$valid&&u.selectedServ>0){g.$broadcast("loading:show");var e=!1;m.findAllEmployees().then(function(t){return!g.noGroups&&(t.items.every(function(t){return t.dispatcher<1&&t.apikeypublic==window.localStorage.getItem("apikeypublic")&&t.overdue?(t.overdue.user<0&&(e=t.overdue.user),!1):!0}),e)?(g.$broadcast("loading:hide"),void s(["SORRY","APP_OVERDUE1","APP_OVERDUE2"]).then(function(t){var o=c.alert({title:t.SORRY,template:t.APP_OVERDUE1+Math.abs(e)+t.APP_OVERDUE2});o.then(function(e){f.transitionTo("app.employee-index")})})):(u.settings.forEach(function(e){e.enabled&&u.groupData.tags.push("tags[]="+e.val)}),u.services.forEach(function(e){e.enabled&&u.groupData.services.push("services[]="+e.text)}),u.groupData.centers=u.centers,void m.addGroup(u.groupData).then(function(e){var t=angular.fromJson(angular.toJson(u.rateplans)),o={};t.forEach(function(e){o[e.id]=e}),"Successful"==e.status&&m.findAllEmployees().then(function(t){g.$broadcast("loading:hide"),s(["SUCCESS"]).then(function(t){c.alert({title:t.SUCCESS,template:e.description})}),f.transitionTo("app.employee-index")})},function(e){g.$broadcast("loading:hide"),s(["SOMETHING_WRONG","FAILED"]).then(function(e){g.$broadcast("loading:hide"),c.alert({title:e.FAILED,template:e.SOMETHING_WRONG})})}))},function(e){g.$broadcast("loading:hide"),s(["SOMETHING_WRONG","FAILED"]).then(function(e){g.$broadcast("loading:hide"),c.alert({title:e.FAILED,template:e.SOMETHING_WRONG})})})}},u.$on("$ionicView.beforeLeave",function(){S&&S(),D&&D(),u.marketModal&&m.removeModalPopup(u,"marketModal"),u.planModal&&m.removeModalPopup(u,"planModal"),_(),E()})})}]).controller("EmployeeDetailCtrl",["MapServ","$interval","$location","$localStorage","$ionicScrollDelegate","$ionicPopup","$ionicHistory","$state","baseUrl","$ionicModal","constants","$ionicPopover","fireRef","$translate","$rootScope","$timeout","$scope","$stateParams","EmployeeService","AnimateMarkerService",function(e,t,o,i,n,a,r,l,s,c,d,p,u,m,g,f,h,E,S,D){var y,M,T,k,I,b,C,w,R,$,O,P=null,A=null,L=!1;h.markers={};var y,F=new google.maps.DirectionsService,N=new google.maps.DirectionsRenderer({suppressMarkers:!0,preserveViewport:!0});h.map={};var x,q,z;h.isDriver=!0,g.showFooter=!1;var V,G,U,B,j,H,Y,W,K,Q,Z,J,X,ee,te,oe,ie,ne,ae,re,B,le=!0,se={},ce={},de=!1,pe=function(){y&&(h.markers[h.employee.apikeypublic]={booked:!0,lat:se.lat,lng:se.lon,zone_id:y},g.setMapMarkers(h.markers),g.centerMap(se.lat,se.lon)),h.employee.intrip||(maploaded=!0,g.setCircles(S.getzoneMap()[z]))};if(E.employeeId){if(0==S.getCategEmployees().length)return void l.transitionTo("app.employee-dispatcher");z=r.backView().stateParams.employeeId,h.employee=S.findById(E.driverId),y=h.employee.zone_id,se.lat=h.employee.lat,se.lon=h.employee.lng,h.isDriver=!1}else h.employee=g.tappedGroup||g.driverHomeGroup,z=h.employee.category_id,y=S.getBookedZoneId(z),S.queueListenerFunc([h.employee.category_id],!0),se.lat=g.lat,se.lon=g.lon;h.goBack=function(){h.isDriver?l.transitionTo("app.employee-index"):r.goBack()};var ue=h.$on("$ionicView.afterEnter",function(t,r){g.setMapClass("detailmap"),e.createMap(document.getElementById("detailmap"),null,function(){pe(),g.setCircles(S.getzoneMap()[z])}),ce=e.mapClickableSetter(h),h.view_loaded=!0,h.showLargImage=function(e){h.allImages=[{src:e}],h.activeSlide=0,h.showModal("popovers/image-popover.html")},h.showModal=function(e){c.fromTemplateUrl(e,{scope:h,animation:"slide-in-up"}).then(function(e){h.fullSizeImageModal=e,h.fullSizeImageModal.show()})},h.openDetail=function(e){"IMG"===e.target.nodeName||e.target.hasAttribute("contact_number")||(h.isToggled=!h.isToggled,g.$broadcast("setmapclick",!h.isToggled))},G=h.$on("accorditemtapped",function(e,t){o.path(t.currentTarget.getAttribute("link"))}),h.tapped=function(e){"A"!=e.target.tagName&&e.currentTarget.getAttribute("link")&&o.path(e.currentTarget.getAttribute("link"))},Q=h.$on("location:updated",function(e){h.isDriver&&!S.isViewing("tripModal")&&S.getLocation(g.lat,g.lon).then(function(e){de||(h.employee.location=e,h.markers[window.localStorage.getItem("apikeypublic")]={booked:!0,lat:g.lat,lng:g.lon,zone_id:h.employee.zone_id},g.setMapMarkers(h.markers),g.mapCentered&&g.centerMap())})});var l=!1;h.last_order=null,h.total_today=0,h.total_week=0,h.total_weektrips=0,h.getOrders=function(){l=!1,S.orders().then(function(e){h.last_order=null,h.total_today=0,h.total_week=0,h.total_weektrips=0,e.data.forEach(function(e){if("trip"==e.type){(!h.last_orderTripId||+h.last_orderTripId<+e.trip_id)&&(h.last_orderTripId=e.trip_id,h.last_order=Number(e.price));var t=moment.utc(e.created_at).toDate(),o=moment(t);o.isSame(moment(),"day")&&(h.total_today+=Number(e.price)),o.isAfter(moment().startOf("isoweek"))&&(h.total_week+=Number(e.price),h.total_weektrips++)}}),h.total_week&&(h.total_week=parseFloat(h.total_week).toFixed()+"/"+h.total_weektrips),h.total_today&&(h.total_today==h.last_order?h.total_today=h.last_order:h.total_today=parseFloat(h.total_today).toFixed())},function(){l=!0})},U=h.$on("trip:ended",function(){h.$broadcast("location:updated"),h.getOrders(),g.map.panTo({lat:g.lat,lng:g.lon})});var v=function(){L||(L=!0,H=u.child(M.zone_id+"/inbox/"+M.id+"/route"),H.on("value",q))};q=function(e){return null!=e.val()?"rate"==e.val().reply_to_message[Object.keys(e.val().reply_to_message)[Object.keys(e.val().reply_to_message).length-1]].status?void Z():void((e.val().status!=P||e.val().eta_distance!=A)&&f(function(){void 0==w&&h.showMap(),h.setDirectionsMap(e.val().status,e.val().eta_distance,e.val())},2e3)):void 0},h.closeModal=function(){h.fullSizeImageModal.hide(),h.fullSizeImageModal.remove()};var D=function(e){e.exists()&&e.val().route.quote_id==h.employee.quote_id&&(y=h.employee.category_id,M=e.val().route,f(function(){h.showMap()}),u.child(h.employee.category_id+"/inbox").off("child_added",D),v()),g.$broadcast("loading:hide")};h.setDirectionsMap=function(e,t,o){if(g.map&&!de&&"offer"!=e){P=e,O=new google.maps.LatLng(o.sent_to_message[0].lat,o.sent_to_message[0].lon);var i,n;switch(e){case"offer":i=C,n=new google.maps.LatLng(o.pickup_lat,o.pickup_lon);break;case"accept":i=C,n=new google.maps.LatLng(o.pickup_lat,o.pickup_lon),h.arrivedloadunload="ARRIVED",h.disableArrive=!d.testMode&&S.getGPSDistance(h.employee.lat,h.employee.lon,o.pickup_lat,o.pickup_lon)>d.arriveBtnDisabledMiles;break;case"arrived":i=C,n=new google.maps.LatLng(o.pickup_lat,o.pickup_lon),h.arrivedloadunload="LOAD";break;case"load":i=new google.maps.LatLng(o.pickup_lat,o.pickup_lon),n=new google.maps.LatLng(o.dropoff_lat,o.dropoff_lon),h.arrivedloadunload="UNLOAD",h.disableArrive=!d.testMode&&S.getGPSDistance(h.employee.lat,h.employee.lon,o.dropoff_lat,o.dropoff_lon)>d.arriveBtnDisabledMiles;break;case"unload":i=new google.maps.LatLng(o.pickup_lat,o.pickup_lon),n=new google.maps.LatLng(o.dropoff_lat,o.dropoff_lon),h.unloaded=!0,"receipt"==o.sent_to_message[Object.keys(o.sent_to_message)[Object.keys(o.sent_to_message).length-1]].status?h.initRating():"rate"!=o.sent_to_message[Object.keys(o.sent_to_message)[Object.keys(o.sent_to_message).length-1]].status&&De();break;case"receipt":i=new google.maps.LatLng(o.pickup_lat,o.pickup_lon),n=new google.maps.LatLng(o.dropoff_lat,o.dropoff_lon),h.unloaded=!0,"receipt"==o.sent_to_message[Object.keys(o.sent_to_message)[Object.keys(o.sent_to_message).length-1]].status?h.initRating():"rate"!=o.sent_to_message[Object.keys(o.sent_to_message)[Object.keys(o.sent_to_message).length-1]].status&&De()}if(g.map.directionsDisplay&&g.map.directionsDisplay.setMap(null),"cancelled"!=e){var a=function(){var e={origin:i,destination:n,travelMode:google.maps.TravelMode.DRIVING};F.route(e,function(e,t){if(t==google.maps.DirectionsStatus.OK){g.setDirections(e),fe([new google.maps.LatLng(o.dropoff_lat,o.dropoff_lon),new google.maps.LatLng(o.pickup_lat,o.pickup_lon),C]);for(var i=e.routes[0],n=0;n<i.legs.length;n++){var a=new google.maps.LatLng(o.pickup_lat,o.pickup_lon),r=new google.maps.LatLng(o.dropoff_lat,o.dropoff_lon);void 0!=w&&w.setPosition(a),void 0==R||"arrived"!=o.status&&"load"!=o.status||R.setPosition(r)}fe([I,b,C])}})};f(function(){a()},1e3)}}};var T=function(e){try{C=new google.maps.LatLng(e.lat,e.lon),S.getLocation(e.lat,e.lon).then(function(e){h.employee.location=e}),h.employee.intrip||h.receiptModal&&h.ratingModal||g.hasCircles()||!se||(g.resetMap(),N.setMap(null),g.setCircles(S.getzoneMap()[z])),h.markers[h.employee.apikeypublic]={booked:!0,lat:e.lat,lng:e.lon,zone_id:h.employee.zone_id},g.setMapMarkers(h.markers),g.mapCentered&&!h.employee.intrip&&g.centerMap(e.lat,e.lon),M&&h.setDirectionsMap(M.status,M.eta_distance,M)}catch(t){}},se=!1,ue=function(){var e=S.findById(E.driverId);if(h.employee.location||(x=f(function(){var t={};h.isDriver?(S.queueListenerFunc([h.employee.category_id],!0),t.lat=g.lat,t.lon=g.lon):(t.lat=e.lat,t.lon=e.lng),S.getLocation(t.lat,t.lon).then(function(e){if("app.driver-home"==g.history.currentStateName()||"app.employee-detail"==g.history.currentStateName()){h.employee.location=e;var o=new google.maps.LatLng(t.lat,t.lon);k&&k.setPosition(o),h.centerMap(t.lat,t.lon),f(function(){g.$broadcast("zonemap:updated")},50)}})},300)),h.isDriver){var t=h.employee&&h.employee.location;h.employee=g.tappedGroup||g.driverHomeGroup,h.title=i.name,h.name=h.employee.managerName,i.picData&&(h.employee.pic=i.picData),z=h.employee.category_id,h.last_order||l||h.getOrders(),h.employee.location=h.employee.location||t}else h.employee=e,h.title=e.firstName+" "+e.lastName,h.name=e.managerName;if((""==h.employee.pic||h.employee.pic==s.replace("/api/","/assets/")+"img/markers/transportation/town_car.png")&&(h.employee.pic="img/person.jpg"),h.isDispatcherAdmin=e.apikeypublic==window.localStorage.getItem("apikeypublic")&&e.category_id==e.category_id&&(e.tags.indexOf("Admin")>-1||e.tags.indexOf("Dispatcher")>-1),j||(j=u.child(z+"/queue/"+h.employee.apikeypublic).on("value",function(e){e.exists()?(h.employee.zone_id=e.val().zone_id,h.isDriver||T(e.val())):(h.markers[h.employee.apikeypublic]={booked:!1,lat:h.employee.lat,lng:h.employee.lon,zone_id:h.employee.category_id},g.setMapMarkers(h.markers))})),!h.isDriver&&h.employee.intrip)if(h.employee.apikeypublic==window.localStorage.getItem("apikeypublic"))y=S.getZoneFromQuoteId(h.employee.quote_id),M=S.getInboxData(y,h.employee.quote_id),v();else{var o=u.child(h.employee.category_id+"/inbox");o.on("child_added",D)}else void 0!=w&&(w.setMap(null),w=void 0,R.setMap(null),$.setMap(null),N.setMap(null),L=!1,P=null,g.map.panTo(C))};ue(),B=h.$on("firebase:updated",function(e,t){ue()});var me=["DETAIL","DISPATCHER","AVAIL_DRIVERS","OFFICE","CELL","SMS","EMAIL","STATUS","ACTIVE","INACTIVE","ORDERS","HELP","SHARE","REFER"];m(me).then(function(e){h.accordion={},h.items=[{contact:h.employee.cellPhone,label:e.DISPATCHER,text:h.employee.managerName,icon:"icon ion-person",condition:h.employee.dispatcher<1,link:"#/app/employee-index"},{label:e.ORDERS,text:"",link:"/app/orders/"+h.employee.apikeypublic+"/"+h.employee.category_id,icon:"icon ion-ios-list",condition:!0},{label:e.SHARE,text:"",icon:"icon ion-share",condition:!0},{label:e.HELP,text:"",link:"/app/help",icon:"icon ion-help-circled",condition:!0}],ionic.Platform.isWebView()&&h.items.splice(2,0,{label:e.REFER,text:"",link:"/app/contacts",icon:"icon ion-person-add",condition:!0}),h.accordion.heading=e.DETAIL}),h.isDriver||m("NEW_SUBSCRIPTION").then(function(e){K=function(t){if(t.exists()){var o=t.val();if(o.message==e)return;var i=o.to;if(o.from==h.employee.apikeypublic||o.from==window.localStorage.getItem("apikeypublic")){if("string"==typeof i)(o.from==window.localStorage.getItem("apikeypublic")||i==window.localStorage.getItem("apikeypublic"))&&(h.messageTime=o.time);else for(var n in i)(o.from==window.localStorage.getItem("apikeypublic")||n==window.localStorage.getItem("apikeypublic"))&&(h.messageTime=o.time);Y||(Y=f(function(){m("MESSAGES").then(function(e){var t={label:e,text:'<span am-time-ago="'+h.messageTime+'"></span>',icon:"icon ion-chatboxes",condition:!0,link:"/app/messages/"+h.employee.apikeypublic+"/"+h.employee.firstName+" "+h.employee.lastName};Y=null,h.items.splice(5,0,t)})},2e3))}}},S.getzoneIDs().forEach(function(e,t){W=u.child(e+"/messages"),W.on("child_added",K)})}),h.centerMap=function(e,t){le=!0;var o,i;if(h.isDriver)o=g.lat,i=g.lon;else if(o=h.employee.lat,i=h.employee.lng,h.employee.intrip)return void fe([new google.maps.LatLng(M.dropoff_lat,M.dropoff_lon),new google.maps.LatLng(M.pickup_lat,M.pickup_lon),new google.maps.LatLng(o,i)]);
new google.maps.LatLng(o,i);g.centerMap(o,i)},h.showMap=function(){h.employee.dispatcher>0||f(function(){if(C=new google.maps.LatLng(h.employee.lat,h.employee.lng),h.employee.intrip){new google.maps.LatLng(0,0)}else;({center:C,zoom:14,zoomControlOptions:{position:google.maps.ControlPosition.LEFT_CENTER},panControl:!1,mapTypeControl:!1,mapTypeId:google.maps.MapTypeId.ROADMAP});google.maps.event.addListener(g.map,"dragend",function(){le=!1}),h.centerMap(h.employee.lat,h.employee.lng);var e={url:s.replace("/api/","/assets/")+"img/markers/transportation/town_car.png",scaledSize:new google.maps.Size(21,34)};if(k=new google.maps.Marker({position:C,icon:e}),h.employee.intrip){I=new google.maps.LatLng(M.pickup_lat,M.pickup_lon),b=new google.maps.LatLng(M.dropoff_lat,M.dropoff_lon),w=new google.maps.Marker({position:I,map:g.map,icon:"img/markerA.png"}),R=new google.maps.Marker({position:b,map:g.map,icon:"img/markerB.png"});var t={path:"M84 341c-21 0 -37 17 -37 38s16 37 37 37s37 -16 37 -37s-16 -38 -37 -38zM121 333c28 0 47 -24 47 -48v-114c0 -22 -32 -22 -32 0v105h-5v-286c0 -28 -41 -31 -43 0v165h-1h-7v-165c-1 -29 -43 -30 -43 0v286h-6v-105c0 -22 -31 -22 -31 0v114c0 24 19 48 47 48h37h37z",fillColor:"#000",fillOpacity:.9,anchor:new google.maps.Point(0,0),strokeWeight:0,scale:.08,rotation:180};$=new google.maps.Marker({position:O,icon:t}),h.setDirectionsMap(M.status,M.eta_distance,M)}g.$broadcast("loading:hide")})};V=h.$on("zonemap:updated",function(){}),h.setCircles=function(){return},Z=function(){S.removeModalPopup(h,"messageModal"),S.removeModalPopup(h,"orderModal"),S.removeModalPopup(h,"cancelTripModal"),S.removeModalPopup(h,"popoverDetail"),S.removeModalPopup(h,"seatsModal"),S.removeModalPopup(h,"modalDatePicker"),h.map.map&&h.map.map.directionsDisplay&&h.map.map.directionsDisplay.setMap(null),g.map&&g.map.directionsDisplay&&g.map.directionsDisplay.setMap(null)};var ge=function(e,t){for(var o in t);},fe=function(e){for(var t=new google.maps.LatLngBounds,o=0;o<e.length;o++){var i=e[o];t.extend(i)}g.map.fitBounds(t)};h.unloaded=!1,h.footerBtnTap=function(e){if(h.disableArrive)return void("accept"==tripState?m(["SORRY","NOT_AT_PICKUP"]).then(function(e){toastr.error(e.NOT_AT_PICKUP,e.SORRY)}):"load"==tripState&&m(["SORRY","NOT_AT_DROPOFF"]).then(function(e){toastr.error(e.NOT_AT_DROPOFF,e.SORRY)}));switch(e){case"ARRIVED":ve({zone_id:M.zone_id,quote_id:M.id,tripID:M.tripID,msg:"Arrived",status:5},"Arrived");break;case"LOAD":g.$broadcast("loading:show"),ve({zone_id:M.zone_id,quote_id:M.id,tripID:M.tripID,status:6},"Load Trip");break;case"UNLOAD":ve({zone_id:M.zone_id,quote_id:M.id,tripID:M.tripID,status:7},"UnLoad Trip")}};var ve=function(e,t){e.isDriver=M.reply_to!=h.employee.apikeypublic&&8!=e.status,S.trip(e,h.employee).then(function(e){"UnLoad Trip"!=t&&g.$broadcast("loading:hide",!0),"Arrived"==t?h.arrivedloadunload="LOAD":"Load Trip"==t?(h.disableCancelTrip=!0,h.arrivedloadunload="UNLOAD"):"UnLoad Trip"==t?(S.stopTrackingTrip(),De()):"Payment Receipt"==t?h.initRating():"Cancel Trip"==t?(h.cancelTripModal.remove(),h.cancelTripModal=null):"Send Message"==t&&(h.messageModal.remove(),h.messageModal=null,h.cancel={},h.msgNotSelected=!0,h.otherMsgSelected=!0)},function(e){g.$broadcast("loading:hide"),m(["SOMETHING_WRONG","FAILED"]).then(function(e){a.alert({title:e.FAILED,template:e.SOMETHING_WRONG})})})};h.receipt=function(){var e=void 0==h.receiptmsg.other?h.receiptmsg["default"]:h.receiptmsg.other;ve({zone_id:M.zone_id,quote_id:M.id,tripID:M.tripID,msg:e,status:8},"Payment Receipt")},h.sendMessage=function(e){if(h.otherMsgSelected||(e.$submitted=!0),h.otherMsgSelected||e.$valid){var t=h.otherMsgSelected?h.tripmsg["default"]:h.tripmsg.other;ve({zone_id:M.zone_id,quote_id:M.id,tripID:M.tripID,msg:t,status:0},"Send Message")}};var he=["MESSAGE_DRIVER1","MESSAGE_DRIVER2","MESSAGE_DRIVER3","MESSAGE_DRIVER4","MESSAGE_DRIVER5"];m(he).then(function(e){h.tripmsgs=[],he.forEach(function(t,o){h.tripmsgs.push({text:e[t],val:e[t]})})}),h.cancel={};var _e=["MESSAGE_CANCEL_DRIVER1","MESSAGE_CANCEL_DRIVER2","MESSAGE_CANCEL_DRIVER3","MESSAGE_CANCEL_DRIVER4","MESSAGE_CANCEL_DRIVER5","CANCEL_TRIP"];m(_e).then(function(e){h.cancelreasons=[],_e.forEach(function(t,o,i){o<i.length-1&&h.cancelreasons.push({text:e[t],val:e[t]})}),h.cancelTitle=e.CANCEL_TRIP}),c.fromTemplateUrl("modals/order-edit.html",{scope:h}).then(function(e){h.orderModal=e}),h.showOrderModal=function(){h.popoverDetail.hide(),h.editForm=!1,h.orderModal.show()},h.msgNotSelected=!0,h.otherMsgSelected=!0,h.sendMessageModal=function(){h.popoverDetail.hide(),c.fromTemplateUrl("modals/trip-message.html",{zone_id:M.zone_id,quote_id:M.id,tripID:M.tripID,scope:h}).then(function(e){h.messageModal=e,h.tripmsg={},h.msgNotSelected=!0,h.otherMsgSelected=!0,e.show()})},X=h.$watch("tripmsg.default",function(e,t,o){h.tripmsgs&&e==h.tripmsgs[h.tripmsgs.length-1].text?(h.otherMsgSelected=!1,h.msgNotSelected=!0,n.resize()):void 0!=e&&(h.otherMsgSelected=!0,h.msgNotSelected=!1,n.resize())}),J=h.$watch("tripmsg.other",function(e,t,o){void 0==e?h.msgNotSelected=!0:""!=e.trim()&&(h.msgNotSelected=!1)}),h.removeMessageModal=function(){h.messageModal.remove(),h.messageModal=null},h.removeCancelModal=function(){h.cancelTripModal.remove(),h.cancelTripModal=null},h.reasonNotSelected=!0,h.otherSelected=!0,h.showCancelTripModal=function(){h.popoverDetail.hide(),c.fromTemplateUrl("modals/trip-cancel.html",{zone_id:M.zone_id,quote_id:M.id,tripID:M.tripID,scope:h}).then(function(e){h.cancel={},h.reasonNotSelected=!0,h.otherSelected=!0,h.cancelTripModal=e,e.show()})},te=h.$watch("cancel.default",function(e,t,o){h.cancelreasons&&e==h.cancelreasons[h.cancelreasons.length-1].text?(h.otherSelected=!1,h.reasonNotSelected=!0,n.resize()):void 0!=e&&(h.otherSelected=!0,h.reasonNotSelected=!1,n.resize())}),ee=h.$watch("cancel.other",function(e,t,o){void 0==e?h.reasonNotSelected=!0:""!=e.trim()&&(h.reasonNotSelected=!1)}),h.cancelTap=function(e){if(h.otherSelected||(e.$submitted=!0),h.otherSelected||e.$valid){var t=h.otherSelected?h.cancel["default"]:h.cancel.other;ve({zone_id:M.zone_id,quote_id:M.id,tripID:M.tripID,msg:t,status:-5,inbox:[M]},"Cancel Trip")}};var Ee=function(){h.receiptModal=!1,h.ratingModal=!0,h.isToggled=!1};h.setRating=function(){h.ratingModal=!0;for(var e=0,t=0;t<h.ratingChkboxes.length;t++)h.ratingChkboxes[t].isChecked&&e++;f(function(){h.rate=e,Ee()})},h.max=5;var Se=[];h.initRating=function(){if(!h.ratingModal){var e=S.getRating(M.zone_id,M.id);g.$broadcast("loading:hide");var t=["RATE_DRIVER1","RATE_DRIVER2","RATE_DRIVER3","RATE_DRIVER4","RATE_DRIVER5"];m(t).then(function(o){var i=[{"class":"ion-clock",text:o[t[0]],isChecked:e.time,calculated:!0},{"class":"ion-speedometer",text:o[t[1]],isChecked:e.speed,calculated:!0},{"class":"ion-arrow-graph-up-right",text:o[t[2]],isChecked:e.distance,calculated:!0},{"class":"icon-driver",text:o[t[3]],isChecked:!0,calculated:!1},{"class":"ion-waterdrop",text:o[t[4]],isChecked:!0,calculated:!1}];h.ratingChkboxes=i,h.setRating()});var o=["TRIP_INFO","PAYMENT_METHOD","PRICE","PICKUP","DROPOFF","SERVICE","SEATS","ROUTE","DATE_TIME","MILES"];m(o).then(function(e){h.accordion={},h.ratingitems=[{label:e.PAYMENT_METHOD,text:M.paymentMethod},{label:e.PICKUP,text:M.pickup},{label:e.DROPOFF,text:M.dropoff},{label:e.SERVICE,text:M.selectService},{label:e.SEATS,text:M.selectPeople},{label:e.ROUTE,text:M.route_distance+" "+e.MILES},{label:e.DATE_TIME,text:M.selectDate+" "+M.selectTime}],h.accordion.heading=e.TRIP_INFO})}},h.sendRating=function(){g.$broadcast("loading:show");for(var e=0;e<h.ratingChkboxes.length;e++)Se.push("message[]="+(h.ratingChkboxes[e].isChecked?1:0));S.trip({isDriver:!1,zone_id:M.zone_id,quote_id:M.id,tripID:M.tripID,msg:Se,status:9},h.employee).then(function(e){h.ratingModal=!1,g.mapid="quotemap",g.setMapClass("detailmap"),g.$broadcast("loading:hide"),h.isToggled=!1},function(e){g.$broadcast("loading:hide"),m(["SOMETHING_WRONG","FAILED"]).then(function(e){a.alert({title:e.FAILED,template:e.SOMETHING_WRONG})})})},h.receiptNotSelected=!1,h.otherReceiptSelected=!0,ie=h.$watch("receiptmsg.default",function(e,t,o){h.receiptmsgs&&e==h.receiptmsgs[h.receiptmsgs.length-1].text?(h.otherReceiptSelected=!1,h.receiptNotSelected=!0,f(function(){var e=_.find(n._instances,function(e){return"scroll"===e.$$delegateHandle});e.scrollBottom()})):void 0!=e&&(h.otherReceiptSelected=!0,h.receiptNotSelected=!1)}),oe=h.$watch("receiptmsg.other",function(e,t,o){void 0==e||""!=e.trim()&&(h.receiptNotSelected=!1)}),h.showTripDetail=function(){if(void 0!=M){var e=["TRIP_INFO","PAYMENT_METHOD","PRICE","PICKUP","DROPOFF","SERVICE","SEATS","ROUTE","DATE_TIME","MILES"];m(e).then(function(e){h.receiptaccordion={},h.receiptitems=[{label:e.PAYMENT_METHOD,text:M.paymentMethod},{label:e.PICKUP,text:M.pickup},{label:e.DROPOFF,text:M.dropoff},{label:e.SERVICE,text:M.selectService},{label:e.SEATS,text:M.selectPeople},{label:e.ROUTE,text:M.route_distance+" "+e.MILES},{label:e.DATE_TIME,text:M.selectDate+" "+M.selectTime}],h.receiptaccordion.heading=e.TRIP_INFO})}},h.showBackBtn=!0;var De=function(){if(!h.receiptModal){var e=["RECEIPT_CUSTOMER1","RECEIPT_CUSTOMER2","RECEIPT_CUSTOMER3","RECEIPT_CUSTOMER4","RECEIPT_CUSTOMER5"];m(e).then(function(t){h.receiptmsgs=[],h.receiptmsg={},e.forEach(function(e,o){h.receiptmsgs.push({text:t[e],val:t[e]})}),h.receiptmsg["default"]=h.receiptmsgs[0].val}),null!=h.arrivedModal&&1!=h.arrivedModal&&(h.arrivedModal.remove(),h.arrivedModal=null,S.isRinging()&&S.ringTone()),h.showTripDetail(),h.receiptModal=!0,g.resetMap(),g.mapid="receiptmap",g.setMapClass("tripmapp receiptmap"),g.$broadcast("loading:hide")}};p.fromTemplateUrl("popovers/trip-menu.html",{scope:h}).then(function(e){h.popoverDetail=e}),h.showSendMsg=!1,h.sendTripMessage=function(){g.$broadcast("loading:show"),S.trip({zone_id:M.zone_id,quote_id:M.id,tripID:M.tripID,msg:trip.msg,status:4}).then(function(e){g.$broadcast("loading:hide")})},h.openSeatsModal=function(){if(null!=h.seatsModal)return void h.seatsModal.show();c.fromTemplateUrl("modals/order_seats.html",{scope:h,animation:"slide-in-up",backdropClickToClose:!1}).then(function(e){h.seatsModal=e,e.show()})},S.getTags().then(function(e){h.tags=e.tags,h.$broadcast("queue:updated",ge),g.$broadcast("loading:hide")});var ye={},ge=function(e,t,o){ye={};var i=S.getAllUniqueDrivers();for(var n in i)Me(i,n);0==Object.keys(ye).length&&h.$broadcast("nodriver"),void 0!=h.tags&&void 0!=M&&(0==h.services.length&&h.services.push({id:M.selectService,text:M.selectService,"class":"taxicar",checked:!1,icon:"pics/taxi.png"}),Object.keys(ye).length>0&&(h.services=S.setServices(ye,h.tags,h.services)))},Me=function(e,t){t!=window.localStorage.getItem("apikeypublic")&&S.getGPSDistance(g.lat,g.lon,e[t].lat,e[t].lon)<d.milesRadius&&""==e[t].quote_id&&(ye[t]=e[t])};ne=h.$on("queue:updated",ge),ae=h.$on("queue:added",ge),re=h.$on("queue:removed",ge),h.services=[],m("SELECT_SERVICE").then(function(e){h.services_text_single=e}),h.val={single:null,multiple:null},h.setServiceCheckMark=function(){h.services.forEach(function(e){e.id==h.editorder.selectService?e.checked=!0:e.checked=!1})},h.serviceSelected=function(e){h.editorder.selectService=e,h.setServiceCheckMark()},h.saveDateTime=function(e){h.editorder.selectDate=moment(new Date(e)).format("MM/DD/YY"),h.editorder.selectTime=moment(new Date(e)).format("hh:mm a"),h.editorder.time=h.editorder.selectDate+" "+h.editorder.selectTime},h.setCarIcon=function(){h.services.forEach(function(e){h.editorder.selectService==e.id&&(h.serviceImg=e.icon)}),0==h.services.length&&(h.serviceImg="pics/taxi.png")},h.showService=function(e){h.setServiceCheckMark(),g.showFancy(e)};var Te,ke;f(function(){h.employee.intrip&&h.initOrder()},3e3),h.initOrder=function(){h.editorder=M,h.setCarIcon(),h.editorder.time=h.editorder.selectDate+" "+h.editorder.selectTime,Te=h.editorder.pickup,ke=h.editorder.dropoff,h.seatsModel={setFunc:function(e){return angular.isDefined(e)?h.editorder.selectPeople=e:h.editorder.selectPeople}}};var Ie;h.edit=function(){Ie=angular.copy(h.editorder),h.editForm=!0},h.cancelEdit=function(){h.editorder=Ie,h.setCarIcon(),h.editForm=!1},h.orderChanged=function(e){e.hasOwnProperty("pickup")&&(h.editorder.pickup_lat=e.pickup.lat,h.editorder.pickup_lon=e.pickup.lon,h.editorder.pickup=e.pickup.formatted_address),e.hasOwnProperty("dropoff")&&(h.editorder.dropoff_lat=e.dropoff.lat,h.editorder.dropoff_lon=e.dropoff.lon,h.editorder.dropoff=e.dropoff.formatted_address),e.hasOwnProperty("range")&&(h.editorder.range=e.range),e.hasOwnProperty("price")&&(h.editorder.price=e.price),be()};var be=function(){if(h.editorder.pickup!=Te||h.editorder.dropoff!=ke){Te=h.editorder.pickup,ke=h.editorder.dropoff;var e=new google.maps.LatLng(h.editorder.pickup_lat,h.editorder.pickup_lon),t=new google.maps.LatLng(h.editorder.dropoff_lat,h.editorder.dropoff_lon),o={origin:e,destination:t,travelMode:google.maps.TravelMode.DRIVING};F.route(o,function(e,t){if(t==google.maps.DirectionsStatus.OK)for(var o=e.routes[0],i=0;i<o.legs.length;i++)h.editorder.eta_distance=o.legs[i].distance.value/1609,h.editorder.eta_time=o.legs[i].duration.value/60,h.editorder.route_distance=(o.legs[i].distance.value/1609).toFixed(1)})}};h.save=function(){g.$broadcast("loading:show");var e=u.child(detail.zone_id+"/inbox/"+detail.id+"/route");e.update({selectDate:h.editorder.selectDate,selectTime:h.editorder.selectTime,selectPeople:h.editorder.selectPeople,selectService:h.editorder.selectService,route_distance:h.editorder.route_distance,eta_distance:h.editorder.eta_distance,eta_time:h.editorder.eta_time,pickup:h.editorder.pickup,dropoff:h.editorder.dropoff,pickup_lat:h.editorder.pickup_lat,pickup_lon:h.editorder.pickup_lon,dropoff_lat:h.editorder.dropoff_lat,dropoff_lon:h.editorder.dropoff_lon,price:h.editorder.price,range:h.editorder.range},function(t){if(g.$broadcast("loading:hide"),t)m(["FAILED","ORDER_UPDATE_FAIL"]).then(function(e){a.alert({title:e.FAILED,template:e.ORDER_UPDATE_FAIL})});else{Ie=M,h.cancelEdit();var o="reply_to_message",i=M[o],n=parseInt(Object.keys(i)[Object.keys(i).length-1])+1,r=i;r[n]={lat:h.employee.lat,lon:h.employee.lon,update_time:moment().format("MM/DD/YY HH:mm:ss"),status:"order_edited",message:"Order Edited"},e.child(o).set(r,function(e){})}})}});h.$on("$ionicView.beforeLeave",function(){de=!0,H&&H.off("value",q),j&&u.child(z+"/queue/"+h.employee.apikeypublic).off("value",j),f.cancel(Y),W&&W.off("child_added",K),Q&&Q(),V&&V(),G&&G(),U&&U(),J&&(J(),X(),ee(),te(),oe(),ie()),ne&&(ne(),ae(),re()),w&&w.setMap(null),R&&R.setMap(null),N&&N.setMap(null),g.resetMap(),ne&&B(),Z&&Z(),x&&f.cancel(x),ue(),T=null;for(v in ce)ce[v]()})}]).controller("MessagesCtrl",["$timeout","$ionicFilterBar","$localStorage","$state","fireRef","$stateParams","$translate","$rootScope","$scope","EmployeeService",function(e,t,o,n,a,r,l,s,c,d){var p,u;c.$on("$ionicView.afterEnter",function(){var e;c.showFilterBar=function(){var o=$.map(c.messages,function(e,t){return e});e=t.show({items:o,update:function(e,t){for(c.messages={},i=0;i<e.length;i++)c.messages[e[i].to]=e[i]}})},c.messages=[],Array.prototype.inArray=function(e){for(var t=0;t<this.length;t++)if(e(this[t]))return!0;return!1},c.sizeOf=function(e){return Object.keys(e).length},Array.prototype.pushIfNotExist=function(e,t){this.inArray(t)||this.push(e)},c.messages={};var r=function(e,t){var o=e.from==window.localStorage.getItem("apikeypublic")?t:e.from;c.messages.hasOwnProperty(o)||(c.messages[o]={from:e.from_name,time:e.time,to:o}),c.messages[o].time=e.time,e.from!=window.localStorage.getItem("apikeypublic")&&(c.messages[o].from=e.from_name)};c.filtered=function(e){var t={};if(0==e.length)return t;var i=[];return angular.forEach(e,function(e,t){e.from!=o.name&&i.push(e)}),i.sort(function(e,t){return t.time-e.time}),t=i.reduce(function(e,t,o){return e[t.to]=t,e},{})},l("NEW_SUBSCRIPTION").then(function(e){u=function(t){if(t.exists()){var o=t.val();if(o.message==e)return;var i=o.to;if("string"==typeof i)(o.from==window.localStorage.getItem("apikeypublic")||i==window.localStorage.getItem("apikeypublic"))&&r(o,o.to);else for(var n in i)(o.from==window.localStorage.getItem("apikeypublic")||n==window.localStorage.getItem("apikeypublic"))&&r(o,n)}},d.getzoneIDs().forEach(function(e,t){p=a.child(e+"/messages"),p.on("child_added",u)})}),c.messageDetail=function(e,t){n.transitionTo("app.messages-detail",{apikey:e,name:t})},c.$on("$destroy",function(){e&&(e(),e=null),p&&p.off("child_added",u)})})}]).controller("MessagesDetailCtrl",["$ionicPopover","$localStorage","$state","fireRef","$stateParams","$translate","$rootScope","$scope","EmployeeService","$ionicScrollDelegate","$timeout",function(e,t,o,i,n,a,r,l,s,c,d){var p,u;l.messages=[],l.unsortedMessages=[];var m=[];$("#smiley").click(function(t){if(l.popoverEmoji)l.popoverEmoji.show(t);else{l.popoverEmoji=e.fromTemplate(['<ion-popover-view style="width:auto;height: 40px !important;">',"<ion-content>",'<div class="row convert-emoji">','<div class="col-100">',"</div>","</div>","</ion-content>","</ion-popover-view>"].join(""),{scope:l}),l.popoverEmoji.show(t);var o=[":grinning:",":joy:",":yum:",":heart_eyes_cat:",":scream_cat:",":ghost:",":heart:"];$(".convert-emoji").each(function(){var e=this;o.forEach(function(t){var o=$(' <a data-emoji="'+t+'">'+t+"</a>\n");$(e).append(o)});var t=$(this).html(),i=emojione.toImage(t);i=i.replace(/\/\/cdn.jsdelivr.net/g,"https://cdn.jsdelivr.net"),$(this).html(i)}),$(".convert-emoji a").click(function(e){m.push($(this).attr("data-emoji"));var t=m.join(" "),t=$(this).attr("data-emoji");return t=emojione.toImage(t).replace(/\/\/cdn.jsdelivr.net/g,"https://cdn.jsdelivr.net"),$("#msgtxtarea").append(t),l.popoverEmoji.hide(),!1})}});var g=function(){function e(){var e=0;s.getzoneIDs().forEach(function(t,o){i.child(t+"/messages").once("value",function(t){E+=t.numChildren(),e++,e==s.getzoneIDs().length&&l.startListening()})}),l.inbox_id&&l.tripMessages()}function o(){f.one("blur",function(){f[0].focus()})}l.toUser={_id:l.apikey,pic:"img/person.jpg",username:n.name},l.user={_id:window.localStorage.getItem("apikeypublic"),pic:r.picData||"img/person.jpg",username:t.name},l.input={message:""};var m,g,f,v=c.$getByHandle("userMessageScroll");$(".quotelogged").hide(),d(function(){e()}),d(function(){m=document.body.querySelector("#userMessagesView .bar-footer"),g=document.body.querySelector("#userMessagesView .scroll-content"),f=angular.element(m.querySelector("textarea"))},0),l.$on("$ionicView.beforeLeave",function(){$(".quotelogged").show()}),l.$on("$destroy",function(){$(".quotelogged").show(),h(),r.chatModal=null}),u=function(e){if(_=e.ref().parent().parent().key(),e.exists()){var t=e.val(),o=t.to;if(t.from==l.apikey||t.from==window.localStorage.getItem("apikeypublic")){if("string"==typeof o)l.checkMessage(t,o);else for(var i in o)l.checkMessage(t,i);d(function(){v.scrollBottom()},0)}S++,S==E&&l.sortMessages()}},l.startListening=function(){s.getzoneIDs().forEach(function(e,t){p=i.child(e+"/messages"),p.on("child_added",u)})};var h=l.$on("trip:msg",function(e,t){if(t.inbox_id==l.inbox_id){var o={userId:t.apikey,message:t.message,time:moment.utc(t.update_time,"MM/DD/YYYY HH:mm:ss").valueOf()};l.messages.push(o),d(function(){v.scrollBottom()},0)}});l.tripMessages=function(){var e=s.getInboxData(l.zone_id,l.inbox_id);for(var t in e.reply_to_message)if("message"==e.reply_to_message[t].status){var o={userId:e.sent_to,message:e.reply_to_message[t].message,time:moment.utc(e.reply_to_message[t].update_time,"MM/DD/YYYY HH:mm:ss").valueOf()};l.messages.push(o)}for(var t in e.sent_to_message)if("message"==e.sent_to_message[t].status){var o={userId:e.reply_to,message:e.sent_to_message[t].message,time:moment.utc(e.sent_to_message[t].update_time,"MM/DD/YYYY HH:mm:ss").valueOf()};l.messages.push(o)}l.sortMessages()};var _,E=0,S=0;l.sortMessages=function(){l.unsortedMessages.sort(function(e,t){return e.time-t.time}),l.messages=l.unsortedMessages,r.$broadcast("loading:hide")},l.checkMessage=function(e,t){e.from==l.apikey&&t==window.localStorage.getItem("apikeypublic")?(e.userId=l.apikey,S!=E?l.unsortedMessages.push(e):l.messages.push(e)):e.from==window.localStorage.getItem("apikeypublic")&&t==l.apikey&&(e.userId=window.localStorage.getItem("apikeypublic"),S!=E?l.unsortedMessages.push(e):l.messages.push(e))},l.pushMessage=function(e,t){e.date=new Date(e.time),e.userId=t,l.messages.pushIfNotExist(e,function(t){return t.key===e.key})},Array.prototype.inArray=function(e){for(var t=0;t<this.length;t++)if(e(this[t]))return!0;return!1},Array.prototype.pushIfNotExist=function(e,t){this.inArray(t)||this.push(e)},l.sendChatMessage=function(e){({toId:l.toUser._id,text:l.input.message});o();var n=i.child((l.zone_id||_)+"/messages"),r={};r[l.apikey]="",n.push({to:r,from:window.localStorage.getItem("apikeypublic"),from_name:t.name,message:l.input.message,time:Firebase.ServerValue.TIMESTAMP},function(e){e&&a(["MSG_SENT_FAILURE"]).then(function(e){$ionicPopup.alert({title:e.FAILED,template:e.MSG_SENT_FAILURE})})}),l.input.message="",d(function(){o(),v.scrollBottom(!0)},0)},d(function(){$('form[name="sendMessageForm"] textarea').keyup(function(e){13!=e.keyCode||e.shiftKey||(l.sendChatMessage(),e.stopPropagation())})});var D=l.$on("taResize",function(e,t){if(t){var o=t[0].offsetHeight;if(m){var i=o+10;i=i>44?i:44,m.style.height=i+"px",g.style.bottom=i+"px"}}});l.$on("$destroy",function(){p&&p.off("child_added",u),D&&D(),s.removeModalPopup(l,"popoverEmoji"),$('form[name="sendMessageForm"] textarea').off("keyup")})};l.$on("modal.shown",function(e,t){l.apikey=t.apikey,l.zone_id=t.zone_id,l.inbox_id=t.inbox_id,n.name=t.name,l.msgnode=t.msgnode,g()});l.$on("$ionicView.afterEnter",function(){l.apikey=n.apikey,r.$broadcast("loading:show"),g()})}]).controller("OrdersCtrl",["$window","$ionicPopover","$timeout","$ionicFilterBar","$localStorage","$state","fireRef","$stateParams","$translate","$rootScope","$scope","EmployeeService",function(e,t,o,i,n,a,r,l,s,c,d,p){d.completed_orders=[],d.orders=[],d.$on("$ionicView.afterEnter",function(){c.$broadcast("loading:show"),o(function(){d.scrollerHeight={height:$(".slider-slide").height()-55+"px"}});var s=d.$on("trip:ended",function(){d.getOrders()});d.apikey=l.apikey,d.group_id=l.groupid;var u=!1,m=d.$on("popover.hidden",function(e,t){u!=t.trip_id&&(u=t.trip_id,d.popoverMap.remove().then(function(){u=!1}))});d.getMap=function(e,o){d.popoverMap=t.fromTemplate(['<style ng-bind-html="popoverStyles"></style><ion-popover-view class="mappop customTrans map-popover">','<ion-content scroll="false">','<div class="smapDiv" id="smapDiv-'+e.trip_id+'"><ion-spinner /></div>',"</ion-content>","</ion-popover-view>"].join(""),{trip_id:e.trip_id,scope:d}),d.popoverMap.show(o),p.tripPath(e.trip_id).then(function(t){"Failed"==t.status?g(null,e):g(t,e)},function(){g(null,e)})};var g=function(t,i){var n=Math.min(+(.7*e.innerWidth).toFixed(0),640),a=Math.min((.7*e.innerHeight).toFixed(0),640);d.popoverStyles=".mappop{min-width: "+n+"px;width: "+n+"px !important;height: "+a+"px !important;min-height: "+a+"px;}.mappop .spinner{width: "+n+"px;height: "+a+"px;}.mappop .spinner svg{width: "+(.3*n).toFixed(0)+"px;height: "+(.3*a).toFixed(0)+"px;}";var r=new google.maps.LatLng(i.pickup_lat,i.pickup_lon),l=new google.maps.LatLng(i.dropoff_lat,i.dropoff_lon),s="",c=[r,l];t&&t.data.forEach(function(e){s+="|"+e.lat+","+e.lon,c.push(new google.maps.LatLng(e.lat,e.lon))});var u=p.getBounds(c),m=p.getBoundsZoomLevel(c,{width:n,height:a}),g="https://maps.googleapis.com/maps/api/staticmap?",f={zoom:m,center:u.getCenter(),size:n+"x"+a,maptype:"roadmap",sensor:!1},v=["markers=icon:http://ride.a2bapp.com/v2/img/markerA.png/|"+i.pickup_lat+","+i.pickup_lon,"markers=icon:http://ride.a2bapp.com/v2/img/markerB.png|"+ +i.dropoff_lat+","+i.dropoff_lon];s.length>0&&v.push("path=color:blue|weight:4"+s),$.each(f,function(e,t){v.push(e+"="+encodeURIComponent(t))}),g+=v.join("&"),o(function(){$("#smapDiv-"+i.trip_id).html('<img src="'+g+'" />')})},f=function(e){var t=e.data.slice(0);t.sort(function(e,t){return t.trip_id-e.trip_id}),t.forEach(function(e){var t=moment.utc(e.created_at).toDate();e.created_at=moment(t).format("MM/DD/YY hh:mm A"),d.group_id&&e.category_id==d.group_id?d.completed_orders.push(e):d.completed_orders.push(e)})};d.getOrders=function(){p.orders().then(function(e){c.$broadcast("loading:hide"),d.ordersfetched=!0,d.group_id&&(d.completed_orders.length=0),f(e)})}();var v;d.showFilterBar=function(){v=i.show({items:d.completedslide?d.completed_orders:d.orders,update:function(e,t){d.filteredItems=e,d.completedslide?d.completed_orders=e:d.orders=e}})},d.completedslide=!1,d.incompslide=!0,d.onSlideMove=function(e){d.completedslide=1==e.index,d.incompslide=0==e.index},d.isDriver=p.isDriver();var h=!0,_=!0;d.toggleOrder=function(e){d.isDriver&&("trip"==e?h=!h:_=!_)},d.isOrderShown=function(e){return"trip"==e?h:_},d.search={},d.search.value="",d.clearSearch=function(){d.search.value=""},d.startsWith=function(e,t){var o=(e+"").toLowerCase();return 0===o.indexOf(t.toLowerCase())},d.formatDate=function(e){return new Date(e)},d.sortType="date",d.reverseSort=!0,d.sortFunc=function(e){return"date"==d.sortType?e.created_at?e.created_at:moment(e.selectDate+" "+e.selectTime,"MM/DD/YYYY HH:mm a"):"pick_dist"==d.sortType?p.getGPSDistance(parseFloat(e.pickup_lat),parseFloat(e.picup_lon),c.lat,c.lon):p.getGPSDistance(parseFloat(e.pickup_lat),parseFloat(e.picup_lon),parseFloat(e.dropoff_lat),parseFloat(e.dropoff_lon))},d.sortBtnClick=function(e){d.sortType==e?d.reverseSort=!d.reverseSort:(d.sortType=e,d.reverseSort=!1)},d.sortBtnClss=function(e){return e==d.sortType&&(d.reverseSort?"button-positive icon-right ion-arrow-up-b":"button-positive icon-right ion-arrow-down-b")};var E="mine",S="customer",D="pending",y="cancelled",M="unchecked",T="unchecked",k="unchecked",I="unchecked";d.filterFunc=function(e){return"checked"==M?e.ordered_by==window.localStorage.getItem("apikeypublic"):"checked"==T?e.sent_to==window.localStorage.getItem("apikeypublic"):"checked"==k?"offer"==e.status:"checked"==I?"cancelled"==e.status:!0},d.filterBtnClick=function(e){switch(e){case E:M="checked"==M?"unchecked":"checked","checked"==T&&(T="unchecked");break;case S:T="checked"==T?"unchecked":"checked","checked"==M&&(M="unchecked");break;case D:k="checked"==k?"unchecked":"checked","checked"==I&&(I="unchecked");break;case y:I="checked"==I?"unchecked":"checked","checked"==k&&(k="unchecked")}},d.filterBtnClss=function(e){switch(e){case E:return"checked"==M?"button-positive icon-right ion-checkmark filterbtns":"filterbtns";case S:return"checked"==T?"button-positive icon-right ion-checkmark filterbtns":"filterbtns";case D:return"checked"==k?"button-positive icon-right ion-checkmark filterbtns":"filterbtns";case y:return"checked"==I?"button-positive icon-right ion-checkmark filterbtns":"filterbtns"}};var b=function(e){if(""!=e.offer_to)for(var t in e.offer_to)if(e.offer_to[t].offer_to==d.apikey)return!0;return!1},C=function(e){d.orders.forEach(function(t,o){t.quote_id==e.route.quote_id&&(d.orders[o]=w(e).route)})},w=function(e){var t=e.route.status,o=e.route,i=o.hasOwnProperty("reply_to_message")?o.reply_to_message[Object.keys(o.reply_to_message)[Object.keys(o.reply_to_message).length-1]].status:"quote",n=o.sent_to_message[Object.keys(o.sent_to_message)[Object.keys(o.sent_to_message).length-1]].status;if(o.reply_to==window.localStorage.getItem("apikeypublic"))var a=n;else if(o.sent_to==window.localStorage.getItem("apikeypublic"))var a=i;return"offer"==t?e.route.order_status="Upcoming":("accept"==t||"arrived"==t||"load"==t||"unload"==t||"receipt"==a)&&(e.route.order_status="In Progress"),e.route.time=moment(e.route.selectDate+" "+e.route.selectTime,"MM/DD/YYYY HH:mm:ss").format("MM/DD/YY HH:mm a"),e},R=[],O=[],P=function(e){if("object"==typeof d.orders&&C(e),R.indexOf(e.route.quote_id)<0&&"cancelled"!=e.route.status&&(p.isDispatcherAdmin(e.route.zone_id)||e.route.sent_to==window.localStorage.getItem("apikeypublic")||e.route.ordered_by==n.uuid||e.route.ordered_by==d.apikey||e.route.sent_to==d.apikey||b(e))){var e=w(e);O.push(e.route),R.push(e.route.quote_id)}c.$broadcast("loading:hide"),d.orders=O},A=function(){var e=p.getFBData();for(var t in e)for(var o in e[t])P(e[t][o])};d.choice={};var L,F,N,x=function(e){e.exists()&&e.forEach(function(e){P(e.val())}),c.$broadcast("loading:hide")};d.group_id?(N=r.child(d.group_id+"/inbox"),N.on("value",x)):(L=d.$on("inbox:updated",function(){A()}),F=d.$on("inbox:removed",function(e,t){var o=-1;d.orders.forEach(function(e,i){(e.id=t.id)&&(o=i)}),o>-1&&d.orders.splice(o,1)})),d.orderDetail=function(e){c.tripModal?(c.detail=e,c.detail.isCustomer=e.reply_to==window.localStorage.getItem("apikeypublic"),c.detail.isDriver=!c.detail.isCustomer,n.tripDetail=c.detail,a.transitionTo("app.trip-detail")):void 0==d.group_id?a.transitionTo("app.orders-detail",{orderId:e.quote_id}):a.transitionTo("app.employee-orderdetail",{orderId:e.quote_id,zone_id:e.zone_id,inbox_id:e.id})},A(),d.$on("$destroy",function(){L&&L(),F&&F(),N&&N.off("value",x),v&&(v(),v=null),s&&s(),m&&m(),p.removeModalPopup(d,"popoverMap")})})}]).controller("OrdersDetailCtrl",["MapServ","AnimateMarkerService","$ionicScrollDelegate","$localStorage","baseUrl","$interval","constants","toastr","$ionicPopover","$timeout","$state","$translate","$ionicPopup","$ionicModal","fireRef","$stateParams","$translate","$rootScope","$scope","EmployeeService",function(e,t,o,i,n,a,r,l,s,c,d,p,u,m,g,f,p,h,E,S){E.map={};var D={},y=!1;E.$on("$ionicView.afterEnter",function(){D=e.mapClickableSetter(E),h.setMapClass("ordermap"),E.editForm=!1,E.order={};var r,M,T=function(e){E.editForm=e,E.popoverMenu.hide(),e?(E.contentCls="has-subheader",h.mapclass=null):(E.contentCls="",h.setMapClass("ordermap")),o.resize(),o.scrollTop(),h.$broadcast("setmapclick",!e)};E.edit=function(){r=angular.copy(E.order),T(!0)},E.cancelEdit=function(){E.services.length=0,O.length=0,E.order.selectService=q[0].selectService,w(),E.order=r,E.setCarIcon(),T(!1)},E.changed=function(e){e.hasOwnProperty("pickup")&&(E.order.pickup_lat=e.pickup.lat,E.order.pickup_lon=e.pickup.lon,E.order.pickup=e.pickup.formatted_address),e.hasOwnProperty("dropoff")&&(E.order.dropoff_lat=e.dropoff.lat,E.order.dropoff_lon=e.dropoff.lon,E.order.dropoff=e.dropoff.formatted_address),e.hasOwnProperty("range")&&e.range&&(E.order.range=e.range),e.hasOwnProperty("price")&&(E.order.price=e.price),S.getTimeZone(e.pickup.lat,e.pickup.lon).then(function(e){E.order.timezone=e.timeZoneId}),J()},E.seatsModal=null,E.openSeatsModal=function(){if(null!=E.seatsModal)return void E.seatsModal.show();m.fromTemplateUrl("modals/order_seats.html",{scope:E,animation:"slide-in-up",backdropClickToClose:!1}).then(function(e){E.seatsModal=e,e.show()})},E.openSeats=function(){c(function(){$(".ordericons").siblings("div[is-icon]").children(".ion-person-add").click()})};var k=!1,I={},b={},C=E.$on("location:searched",function(e,t){b=t.pickup,k=!0,E.setTag()}),w=function(){S.getTags().then(function(e){h.$broadcast("loading:hide"),E.tags=e.tags;var t=S.getUniqueDrivers();originLoc="pickup"==M?b:h;var o={};o[E.order.sent_to]=E.order;for(var i in t)for(var n in t[i]){var a={};a[i]=t[i][n],S.setTagMap("updated",a,originLoc,E.services,O,E.order.selectService,function(e,t,o){E.setTagMap(e,t,o)},!1,void 0,o)}})},R={};R[E.order]=E.order,E.serviceSelected=function(e){S.getUniqueDrivers();originLoc="pickup"==M?b:h},E.setTag=function(){var e=S.setTag(b,E.order.selectService,f.employeeId,R);e>0?(I=b,h.$broadcast("search:location",I)):(A=!1,p(["SORRY","NO_DRIVERS_PICKUP"]).then(function(e){k&&(l.error(e.NO_DRIVERS_PICKUP,e.SORRY),h.$broadcast("search:location",null),k=!1)}),M=null)};var O=[];E.totalDrivers=0,E.setTagMap=function(e,t,o){return E.services=t,o.length>0&&0!=E.services.length&&o.indexOf(R)<0&&p(["SERVICE_REMOVED","SERVICES_NOT_AVAILABLE","SERVICE_NOT_AVAILABLE"]).then(function(e){var t=o+(o.length>1?e.SERVICES_NOT_AVAILABLE:e.SERVICE_NOT_AVAILABLE);l.info(t,e.SERVICE_REMOVED),
c(function(){$("#serviceIcon ion-item").click()})}),E.totalDrivers=e,k&&(h.$broadcast("search:location",I),k=!1),!0};var P=function(e,t,o){originLoc="pickup"==M?b:h,null!=t&&S.setTagMap(o,t,originLoc,E.services,O,E.order.selectService,function(e,t,o){E.setTagMap(e,t,o)},!1)},A=!1;E.services=[],p("SELECT_SERVICE").then(function(e){E.services_text_single=e}),E.val={single:null,multiple:null},E.setServiceCheckMark=function(){E.services.forEach(function(e){e.id==E.order.selectService?e.checked=!0:e.checked=!1})},E.saveDateTime=function(e){E.order.selectDate=moment(new Date(e)).format("MM/DD/YY"),E.order.selectTime=moment(new Date(e)).format("hh:mm a"),E.order.time=E.order.selectDate+" "+E.order.selectTime},s.fromTemplateUrl("popovers/order-menu.html",{scope:E}).then(function(e){E.popoverMenu=e}),E.setCarIcon=function(){E.services.forEach(function(e){E.order.selectService==e.id&&(E.serviceImg=e.icon)}),0==E.services.length&&(E.serviceImg="pics/taxi.png")},h.$broadcast("loading:show");var L,F,N,x=function(){h.$broadcast("loading:hide"),E.order=q[0],E.isDispatcherAdmin=S.isDispatcherAdmin(E.order.zone_id)||!1,E.order.time=E.order.selectDate+" "+E.order.selectTime,E.order.splitFare=["splitFare[]="],E.setCarIcon(),E.setServiceCheckMark(),E.editable="receipt"!=q[0].status&&"unload"!=q[0].status&&"rate"!=q[0].status&&"cancelled"!=q[0].status&&"ordercancelled"!=q[0].status;var e=q[0].status;"offer"==e?E.order.order_status="Pending":"accept"==e||"arrived"==e||"load"==e||"unload"==e||"rate"==e||"receipt"==e?E.order.order_status="In Progress":"ordercancelled"==e?E.order.order_status="Order Cancelled":"cancelled"==e&&(E.order.order_status="Trip Cancelled"),E.contentCls=E.editable&&E.editForm?"has-subheader":"",void 0==j&&E.showMap(),me(),F=E.$on("queue:updated",P),N=E.$on("queue:added",P),L=E.$on("queue:removed",P),w()};E.orderId=f.orderId,E.zone_id=f.zone_id,E.inbox_id=f.inbox_id;var q=[],z=E.order.pickup,V=E.order.dropoff;E.showService=function(e){c(function(){$("#servicespanel ion-item").click()})},E.removeCancelModal=function(){h.cancelTripModal.remove(),h.cancelTripModal=null},E.cancelTap=function(e){if(E.otherSelected||(e.$submitted=!0),E.otherSelected||e.$valid){var t=E.otherSelected?E.cancel["default"]:E.cancel.other,o=q[0],i={zone_id:o.zone_id,quote_id:o.id,tripID:o.tripID,msg:t,status:-5,inbox:[h.detail],isDriver:h.detail.isDriver};h.$broadcast("loading:show"),S.trip(i).then(function(e){h.$broadcast("loading:hide"),S.removeModalPopup(h,"cancelTripModal"),S.endTrip(),d.transitionTo("app.orders")},function(e){h.$broadcast("loading:hide"),p(["SOMETHING_WRONG","FAILED"]).then(function(e){u.alert({title:e.FAILED,template:e.SOMETHING_WRONG})})})}};var G=E.$watch("cancel.default",function(e,t,i){E.cancelreasons&&e==E.cancelreasons[E.cancelreasons.length-1].text?(E.otherSelected=!1,E.reasonNotSelected=!0,o.resize()):void 0!=e&&(E.otherSelected=!0,E.reasonNotSelected=!1,o.resize())});if(E.cancel={},h.detail&&!h.detail.isCustomer)var U=["MESSAGE_CANCEL_DRIVER1","MESSAGE_CANCEL_DRIVER2","MESSAGE_CANCEL_DRIVER3","MESSAGE_CANCEL_DRIVER4","MESSAGE_CANCEL_DRIVER5","CANCEL_TRIP"];else var U=["MESSAGE_CANCEL_CUSTOMER1","MESSAGE_CANCEL_CUSTOMER2","MESSAGE_CANCEL_CUSTOMER3","MESSAGE_CANCEL_CUSTOMER4","MESSAGE_CANCEL_CUSTOMER5","CANCEL_TRIP"];p(U).then(function(e){E.cancelreasons=[],U.forEach(function(t,o,i){o<i.length-1&&E.cancelreasons.push({text:e[t],val:e[t]})}),E.cancelTitle=e.CANCEL_TRIP}),E["delete"]=function(){E.popoverMenu.hide();var e=q[0];return h.detail&&h.detail.id==e.id?void m.fromTemplateUrl("modals/trip-cancel.html",{zone_id:h.detail.zone_id,quote_id:h.detail.id,tripID:h.detail.tripID,scope:E}).then(function(e){E.cancel={},E.reasonNotSelected=!0,E.otherSelected=!0,h.cancelTripModal=e,e.show()}):void p(["YES","NO","CANCEL_ORDER","CONFIRM_DELETE"]).then(function(e){h.$broadcast("setmapclick",!1);u.confirm({title:e.CANCEL_ORDER,template:e.CONFIRM_DELETE,cssClass:"logoutAlert",buttons:[{text:e.NO},{text:e.YES,type:"button-positive",onTap:function(e){E.deleteOrder()}}]}).then(function(e){h.$broadcast("setmapclick",!0)})})};var B=function(e){h.$broadcast("loading:hide"),e&&p(["FAILED","ORDER_UPDATE_FAIL"]).then(function(e){u.alert({title:e.FAILED,template:e.ORDER_UPDATE_FAIL})})};E.deleteOrder=function(){h.$broadcast("loading:show"),q.forEach(function(e,t,o){var n=g.child(e.zone_id+"/inbox/"+e.id+"/route");"object"!=typeof e.sent_to&&e.reply_to!=window.localStorage.getItem("apikeypublic")?n.update({status:"ordercancelled_"+i.name},B):n.parent().remove(B)})},E.save=function(e){h.$broadcast("loading:show"),S.setQuoteDateTime(E.order),q.forEach(function(e,t,o){var i=g.child(e.zone_id+"/inbox/"+e.id+"/route");i.update({selectDate:E.order.selectDate,selectTime:E.order.selectTime,selectPeople:E.order.selectPeople,selectService:E.order.selectService,route_distance:E.order.route_distance,eta_distance:E.order.eta_distance,eta_time:E.order.eta_time,pickup:E.order.pickup,dropoff:E.order.dropoff,pickup_lat:E.order.pickup_lat,pickup_lon:E.order.pickup_lon,dropoff_lat:E.order.dropoff_lat,dropoff_lon:E.order.dropoff_lon,price:E.order.price,range:E.order.range},function(e){h.$broadcast("loading:hide"),e?p(["FAILED","ORDER_UPDATE_FAIL"]).then(function(e){u.alert({title:e.FAILED,template:e.ORDER_UPDATE_FAIL})}):(r=E.order,E.cancelEdit())})})};var j,H,Y,W,K,Q,Z=new google.maps.DirectionsService,J=function(){if(E.order.pickup!=z||E.order.dropoff!=V){z=E.order.pickup,V=E.order.dropoff;var e=new google.maps.LatLng(E.order.pickup_lat,E.order.pickup_lon),t=new google.maps.LatLng(E.order.dropoff_lat,E.order.dropoff_lon),o={origin:e,destination:t,travelMode:google.maps.TravelMode.DRIVING};Z.route(o,function(e,t){if(t==google.maps.DirectionsStatus.OK)for(var o=e.routes[0],i=0;i<o.legs.length;i++)E.order.eta_distance=o.legs[i].distance.value/1609,E.order.eta_time=o.legs[i].duration.value/60,E.order.route_distance=(o.legs[i].distance.value/1609).toFixed(1)})}},X=null,ee=null,te=!1,Z=new google.maps.DirectionsService,oe=new google.maps.DirectionsRenderer({suppressMarkers:!0,preserveViewport:!0});E.showMap=function(){var t;c(function(){if(Array.isArray(E.order.reply_to_message)&&E.order.reply_to_message.length>1){var o=E.order.reply_to_message;for(var i in o)"message"==o[i].status&&"Trip Cancelled"==o[i].message&&(Y=new google.maps.LatLng(o[i].lat,o[i].lon)),t={lat:o[i].lat,lon:o[i].lon}}void 0==Y&&(void 0==E.order.reply_to_message?(Y=new google.maps.LatLng(h.lat,h.lon),t={lat:h.lat,lon:h.lon}):(Y=new google.maps.LatLng(E.order.reply_to_message[0].lat,E.order.reply_to_message[0].lon),t={lat:E.order.reply_to_message[0].lat,lon:E.order.reply_to_message[0].lon}));({center:Y,zoom:14,zoomControlOptions:{position:google.maps.ControlPosition.LEFT_CENTER},panControl:!1,mapTypeControl:!1,mapTypeId:google.maps.MapTypeId.ROADMAP});j=!0,e.createMap(document.getElementById("ordermap"),null,function(){y||e.centerMap(t.lat,t.lon)});var a=n.replace("/api/","/assets/")+"img/markers/transportation/town_car.png";({url:a,scaledSize:new google.maps.Size(21,34),size:{width:21,height:34}});e.addMarker({lat:E.order.pickup_lat,lon:E.order.pickup_lon,icon:"./img/markerA.png"},function(e){W=e}),e.addMarker({lat:E.order.dropoff_lat,lon:E.order.dropoff_lon,icon:"./img/markerB.png"},function(e){K=e}),"quote"!=E.order.status?E.setDirectionsMap(E.order.status,E.order.eta_distance):ve([new google.maps.LatLng(E.order.dropoff_lat,E.order.dropoff_lon),new google.maps.LatLng(E.order.pickup_lat,E.order.pickup_lon)])})};var ie=function(e){if(!h.receiptModal){if(h.receiptModal=!0,ce)var t=["RECEIPT_DRIVER1","RECEIPT_DRIVER2","RECEIPT_DRIVER3","RECEIPT_DRIVER4","RECEIPT_DRIVER5"];else var t=["RECEIPT_CUSTOMER1","RECEIPT_CUSTOMER2","RECEIPT_CUSTOMER3","RECEIPT_CUSTOMER4","RECEIPT_CUSTOMER5"];p(t).then(function(e){E.receiptmsgs=[],E.receiptmsg={},t.forEach(function(t,o){E.receiptmsgs.push({text:e[t],val:e[t],checked:!1})}),E.receiptmsg["default"]=E.receiptmsgs[0].val}),m.fromTemplateUrl("modals/receipt.html",{zone_id:e.zone_id,quote_id:e.id,tripID:e.tripID,backdropClickToClose:!1,hardwareBackButtonClose:!1,scope:E}).then(function(t){h.$broadcast("loading:hide"),h.receiptModal=t,t.show(),E.showReceiptDetail(e)})}};E.showReceiptDetail=function(e){var t=["TRIP_INFO","PAYMENT_METHOD","PRICE","PICKUP","DROPOFF","SERVICE","SEATS","ROUTE","DATE_TIME","MILES"];p(t).then(function(t){E.accordion={},E.items=[{label:t.PAYMENT_METHOD,text:e.paymentMethod},{label:t.PICKUP,text:e.pickup},{label:t.DROPOFF,text:e.dropoff},{label:t.SERVICE,text:e.selectService},{label:t.SEATS,text:e.selectPeople},{label:t.ROUTE,text:e.route_distance+" "+t.MILES},{label:t.DATE_TIME,text:e.selectDate+" "+e.selectTime}],E.accordion.heading=t.TRIP_INFO})},E.showBackBtn=!0;var ne=function(e){m.fromTemplateUrl("modals/order-rating.html",{zone_id:e.zone_id,quote_id:e.id,tripID:e.tripID,isDriver:ce,isCustomer:se,reply_to:e.reply_to,sent_to:e.sent_to,backdropClickToClose:!1,scope:E}).then(function(t){void 0!=h.ratingModal&&null!=h.ratingModal&&h.ratingModal.isShown()||(h.ratingModal=t,t.show(),de(),S.profile(e.sent_to).then(function(e){E.name=e.description}))})},ae=function(e,t){e.isDriver=!1,h.showLoader=!0,S.trip(e).then(function(e){h.$broadcast("loading:hide"),E.hideReceiptModal()},function(e){h.$broadcast("loading:hide"),p(["SOMETHING_WRONG","FAILED"]).then(function(e){u.alert({title:e.FAILED,template:e.SOMETHING_WRONG})})})};E.receiptNotSelected=!1,E.otherReceiptSelected=!0,E.receiptChecked=function(e,t){e==E.receiptmsgs.length-1&&(t?(E.otherReceiptSelected=!1,c(function(){var e=_.find(o._instances,function(e){return"scroll"===e.$$delegateHandle});e.scrollBottom()}),o.resize()):(E.otherReceiptSelected=!0,o.resize()))},E.receipt=function(){var e=E.order,t=[],o=0;E.receiptmsgs.forEach(function(e,i){e.checked&&(o++,i==E.receiptmsgs.length-1?!E.otherReceiptSelected&&E.receiptmsg.other&&t.push(o+". "+E.receiptmsg.other):t.push(o+". "+e.text))}),t=t.join(" "),0!=t.length&&ae({zone_id:e.zone_id,quote_id:e.id,tripID:e.tripID,msg:t,status:8},"Payment Receipt")},E.hideReceiptModal=function(){ne(E.order),S.removeModalPopup(h,"receiptModal")},E.setRating=function(){for(var e=0,t=0;t<E.ratingChkboxes.length;t++)E.ratingChkboxes[t].isChecked&&e++;c(function(){E.rate=e})},E.max=5;var re=null,le=[],se=!0,ce=!1,de=function(){if(re=S.getRating(E.order.zone_id,E.order.id),h.$broadcast("loading:hide"),ce)var e=["RATE_CUSTOMER1","RATE_CUSTOMER2","RATE_CUSTOMER3","RATE_CUSTOMER4","RATE_CUSTOMER5"];else var e=["RATE_DRIVER1","RATE_DRIVER2","RATE_DRIVER3","RATE_DRIVER4","RATE_DRIVER5"];var e=["RATE_DRIVER1","RATE_DRIVER2","RATE_DRIVER3","RATE_DRIVER4","RATE_DRIVER5"];p(e).then(function(t){var o=[{"class":"ion-clock",text:t[e[0]],isChecked:se?re.time:!0,calculated:se},{"class":se?"ion-speedometer":"icon-pick",text:t[e[1]],isChecked:se?!0:!0,calculated:se},{"class":se?"ion-arrow-graph-up-right":"icon-drop",text:t[e[2]],isChecked:se?!0:!0,calculated:se},{"class":se?"icon-driver":"ion-ios-locked",text:t[e[3]],isChecked:!0,calculated:!1},{"class":se?"ion-waterdrop":"ion-thumbsup",text:t[e[4]],isChecked:!0,calculated:!1}];E.ratingChkboxes=o,E.setRating()})};E.sendRating=function(){h.$broadcast("loading:show");for(var e=0;e<E.ratingChkboxes.length;e++)le.push("message[]="+(E.ratingChkboxes[e].isChecked?1:0));S.trip({isDriver:ce,zone_id:E.order.zone_id,quote_id:E.order.id,tripID:E.order.tripID,msg:le,status:9}).then(function(e){S.removeModalPopup(h,"ratingModal"),l.clear(),h.$broadcast("loading:hide")},function(e){h.$broadcast("loading:hide"),p(["SOMETHING_WRONG","FAILED"]).then(function(e){u.alert({title:e.FAILED,template:e.SOMETHING_WRONG})})})};var pe,ue,me=function(){te||(te=!0,pe=g.child(q[0].zone_id+"/inbox/"+q[0].id+"/route").on("value",function(e){if(e.exists()){ce=e.val().sent_to==window.localStorage.getItem("apikeypublic");var t=e.val().hasOwnProperty("reply_to_message")?e.val().reply_to_message[Object.keys(e.val().reply_to_message)[Object.keys(e.val().reply_to_message).length-1]].status:"quote",o=e.val().sent_to_message[Object.keys(e.val().sent_to_message)[Object.keys(e.val().sent_to_message).length-1]].status;if(ce&&"unload"==t||S.isDispatcherAdmin(e.val().zone_id)&&("unload"==e.val().status||"receipt"==e.val().status||"rate"==e.val().status)&&"receipt"!=o&&"rate"!=o)return void ie(e.val());if(ce&&"receipt"==t||S.isDispatcherAdmin(e.val().zone_id)&&("unload"==e.val().status||"receipt"==e.val().status||"rate"==e.val().status)&&("receipt"==o||void 0==o))return void E.hideReceiptModal();if("rating"==o&&S.removeModalPopup(h,"ratingModal"),"receipt"==e.val().status||"rate"==e.val().status)return;(e.val().status!=X||e.val().eta_distance!=ee)&&c(function(){q[0]=e.val(),void 0==W&&E.showMap(),E.setDirectionsMap(q[0].status,q[0].eta_distance)},2e3)}else d.transitionTo("app.orders",{apikey:window.localStorage.getItem("apikeypublic")})}))};if(void 0==E.zone_id)var ge=a(function(){q=S.getInboxesByQuoteId(E.orderId),void 0!=q&&q.length>0&&(a.cancel(ge),x())},2e3);else ue=g.child(E.zone_id+"/inbox/"+E.inbox_id+"/route").on("value",function(e){e.exists()&&(q.push(e.val()),x())});var fe=E.$on("firebase:updated",function(e,t){x()}),ve=function(e){if(ionic.Platform.isWebView())var o=e.map(function(e){return new plugin.google.maps.LatLng(e.lat(),e.lng())});y||t.fitBounds(e,h.map,null,o)};E.setDirectionsMap=function(e,t){if(!(void 0==j||e.indexOf("ordercancelled_")>-1||"quote"==e||X==e&&ee==t)){X=e,ee=t,Q=new google.maps.LatLng(E.order.sent_to_message[0].lat,E.order.sent_to_message[0].lon);var o,i;switch(e){case"quote":o=Y,i=new google.maps.LatLng(E.order.pickup_lat,E.order.pickup_lon);break;case"offer":o=Y,i=new google.maps.LatLng(E.order.pickup_lat,E.order.pickup_lon);break;case"accept":o=Y,i=new google.maps.LatLng(E.order.pickup_lat,E.order.pickup_lon);break;case"arrived":o=Y,i=new google.maps.LatLng(E.order.pickup_lat,E.order.pickup_lon);break;case"load":o=new google.maps.LatLng(E.order.pickup_lat,E.order.pickup_lon),i=new google.maps.LatLng(E.order.dropoff_lat,E.order.dropoff_lon);break;case"unload":o=new google.maps.LatLng(E.order.pickup_lat,E.order.pickup_lon),i=new google.maps.LatLng(E.order.dropoff_lat,E.order.dropoff_lon);break;case"receipt":o=new google.maps.LatLng(E.order.pickup_lat,E.order.pickup_lon),i=new google.maps.LatLng(E.order.dropoff_lat,E.order.dropoff_lon);break;case"rate":o=new google.maps.LatLng(E.order.pickup_lat,E.order.pickup_lon),i=new google.maps.LatLng(E.order.dropoff_lat,E.order.dropoff_lon);break;case"cancelled":o=new google.maps.LatLng(E.order.pickup_lat,E.order.pickup_lon),i=new google.maps.LatLng(E.order.dropoff_lat,E.order.dropoff_lon);break;case"ordercancelled":o=new google.maps.LatLng(E.order.pickup_lat,E.order.pickup_lon),i=new google.maps.LatLng(E.order.dropoff_lat,E.order.dropoff_lon);break;case"tripcancelled":o=new google.maps.LatLng(E.order.pickup_lat,E.order.pickup_lon),i=new google.maps.LatLng(E.order.dropoff_lat,E.order.dropoff_lon)}h.map.directionsDisplay&&h.map.directionsDisplay.setMap(null);var n=function(){var e={origin:o,destination:i,travelMode:google.maps.TravelMode.DRIVING};Z.route(e,function(e,t){if(t==google.maps.DirectionsStatus.OK){y||h.setDirections(e),ve([new google.maps.LatLng(E.order.dropoff_lat,E.order.dropoff_lon),new google.maps.LatLng(E.order.pickup_lat,E.order.pickup_lon),Y]);for(var o=e.routes[0],i=0;i<o.legs.length;i++){var n=new google.maps.LatLng(E.order.pickup_lat,E.order.pickup_lon),a=new google.maps.LatLng(E.order.dropoff_lat,E.order.dropoff_lon);void 0!=W&&W.setPosition(n),void 0==K||"arrived"!=E.order.status&&"load"!=E.order.status||K.setPosition(a)}}})};n()}};E.$on("$ionicView.beforeLeave",function(){F&&F(),N&&N(),L&&L(),fe&&fe(),C&&C(),ionic.Platform.isWebView()||(W.setMap(null),K.setMap(null),H&&H.setMap(null),oe&&oe.setMap(null)),ue&&g.child(E.zone_id+"/inbox/"+E.inbox_id+"/route").off("value",ue),pe&&g.child(q[0].zone_id+"/inbox/"+q[0].id+"/route").off("value",pe),S.removeModalPopup(h,"receiptModal"),S.removeModalPopup(h,"ratingModal"),S.removeModalPopup(E,"seatsModal"),S.removeModalPopup(E,"popoverMenu"),G&&G(),h.resetMap();for(v in D)D[v]();y=!0})})}]).controller("DispatcherFormCtrl",["$q","$ionicHistory","$stateParams","toastr","fireRef","$ionicPopup","$localStorage","$ionicModal","$translate","$timeout","$rootScope","$scope","EmployeeService",function(e,t,o,i,n,a,r,l,s,c,d,p,u){var m=this;m.dispatcherForm=null,p.$on("$ionicView.afterEnter",function(e,l){p.formType=o.type,p.empl=o.obj,p.empl.active=parseInt(p.empl.active),p.empl.oldItems=[],p.dispatcherformTitle=o.type.toUpperCase(),p.isOwner=!0,p.empl.firstName&&(p.empl.fname=p.empl.firstName,p.empl.firstName.split(" ").length>1&&(p.empl.fname=p.empl.firstName.substring(0,p.empl.firstName.lastIndexOf(" ")),p.empl.lname=p.empl.firstName.split(" ").splice(-1)[0]));var g=[{id:"Admin",text:"Admin",checked:!1,disabled:!1},{id:"Customer",text:"Customer",checked:!1,disabled:!1},{id:"Dispatcher",text:"Dispatcher",checked:!1,disabled:!1},{id:"Driver",text:"Driver",checked:!1,disabled:!1}],f=function(){p.items=[];var e,t={Admin:0,Customer:0,Dispatcher:0,Driver:0};"edit"==p.formType&&p.empl.items.forEach(function(e){delete t[e]}),u.getEmployees().forEach(function(o){o.category_id==p.empl.category_id&&(o.hasOwnProperty("can_bookin")?(e=o.limits,""==o.tags?p.items=g:g.forEach(function(e){o.tags.indexOf(e.text)>-1&&p.items.push(e)})):o.tags.forEach(function(e){t.hasOwnProperty(e)&&t[e]++}))}),p.items.forEach(function(o){t.hasOwnProperty(o.text)&&(o.disabled=t[o.text]>=e[o.text.toLowerCase()])})},v=function(e){p.services=e.map(function(e){return{id:e,text:e,checked:!1}}),void 0!=p.empl.tags&&(p.empl.items=p.empl.tags.filter(function(t){return e.indexOf(t)<0}),p.empl.services=p.empl.tags.filter(function(t){return e.indexOf(t)>-1})),void 0==p.empl.items&&(p.empl.items=[]),void 0==p.empl.services&&(p.empl.services=[]),p.empl.item="",p.empl.itemType="",p.empl.service="",p.empl.serviceType="",p.empl.items.length>0&&(p.empl.item=p.empl.items.join(", "),p.empl.itemType=p.empl.items.join("&itemType[]="),p.empl.oldItems=p.empl.items.slice(0)),p.empl.services.length>0&&(p.empl.oldItems=p.empl.oldItems.concat(p.empl.services),p.empl.service=p.empl.services.join(", "),p.empl.serviceType=p.empl.services.join("&itemType[]=")),f()};u.getTags().then(function(e){v(e.tags)}),v(d.tags),u.getAllEmployees(),p.alreadyExists=function(e){if(0==u.getAllStoredEmployees().length||void 0==p.empl||"edit"==p.formType)return!0;for(var t=u.getAllStoredEmployees(),o=!1,i=0;i<t.length;i++)if(t[i].category_id==p.empl.category_id&&!t[i].hasOwnProperty("can_bookin")&&t[i].email==e){o=!0;break}return!o},p.emailExists=!1,p.validatingEmail=!1;var h;p.emailChanged=function(){p.isOwner=p.empl.email==r.email,m.dispatcherForm.email.$invalid?(p.emailExists=!1,p.validatingEmail=!1,h&&c.cancel(h)):(h&&c.cancel(h),h=c(function(){p.validatingEmail=!0,u.profile(null,p.empl.email).then(function(e){m.dispatcherForm.email.$invalid||(p.emailExists="Failed"!=e.status)},function(){})["finally"](function(){p.validatingEmail=!1})},500))},p.saveEmployee=function(){if(m.dispatcherForm.$submitted=!0,m.dispatcherForm.$valid){d.$broadcast("loading:show");var e=!1;u.findAllEmployees().then(function(t){return t.items.every(function(t){return t.dispatcher<1&&t.apikeypublic==window.localStorage.getItem("apikeypublic")&&t.overdue?(t.overdue.user<0&&(e=t.overdue.user),!1):!0}),e?(d.$broadcast("loading:hide"),void s(["SORRY","APP_OVERDUE1","APP_OVERDUE2"]).then(function(t){var o=a.alert({title:t.SORRY,template:t.APP_OVERDUE1+Math.abs(e)+t.APP_OVERDUE2});o.then(function(e){$state.transitionTo("app.employee-index")})})):void p.save()})}},p.save=function(){if(p.empl.item.indexOf("Driver")>-1&&(p.empl.itemType+="&itemType[]="+p.empl.serviceType),"edit"==p.formType){var e=[],l=[];p.empl.oldItems.forEach(function(e){p.empl.itemType.indexOf(e)<0&&e.split(",").forEach(function(e){l.push(e)})}),p.empl.itemType.split("&itemType[]=").forEach(function(t){p.empl.oldItems.indexOf(t)<0&&t.split(",").forEach(function(t){e.push(t)})}),e.length>0&&(p.empl.itemType=e.join("&itemType[]=")),l.length>0&&(p.empl.itemTypeOld=l.join("&itemTypeOld[]=")),u.editDispatcherItem(p.empl).then(function(e){t.goBack(),d.$broadcast("loading:hide"),d.$broadcast("empl:saved"),s(["SUCCESS","ITEM_EDITED"]).then(function(e){i.success(e.ITEM_EDITED,e.SUCCESS,{timeOut:3e3,positionClass:"toast-bottom-center"})})},function(){s(["SOMETHING_WRONG","FAILED"]).then(function(e){d.$broadcast("loading:hide"),a.alert({title:e.FAILED,template:e.SOMETHING_WRONG})})})}else void 0!=p.empl.lname?p.empl.name=p.empl.fname+" "+p.empl.lname:p.empl.name=p.empl.fname,u.addDispatcherItem(p.empl).then(function(e){u.findByCategoryId(o.employeeId,!0).then(function(e){d.$broadcast("empl:saved")}),t.goBack();var l,c=(u.getAllDrivers(),{}),m=[];u.getAllEmployees().then(function(e){d.$broadcast("loading:hide"),e.forEach(function(e){if(e.hasOwnProperty("email")&&e.email==p.empl.email){l=e.category_id;var t=e.email.split("@")[0];c[t]=""}e.category_id!=p.empl.category_id||e.hasOwnProperty("can_bookin")||e.apikeypublic==window.localStorage.getItem("apikeypublic")||""==e.apikeypublic||m.push(e.apikeypublic)}),d.$broadcast("loading:hide"),s(["SUCCESS","ITEM_ADDED"]).then(function(e){i.success(e.ITEM_ADDED,e.SUCCESS,{timeOut:3e3,positionClass:"toast-bottom-center"})}),s(["NEW_SUBSCRIPTION","FAILED"]).then(function(e){if(0!=Object.keys(c).length){var t=n.child(l+"/messages");t.push({to:c,from:window.localStorage.getItem("apikeypublic"),from_name:r.name,message:e.NEW_SUBSCRIPTION,time:Firebase.ServerValue.TIMESTAMP},function(e){e&&s(["MSG_SENT_FAILURE"]).then(function(e){a.alert({title:e.FAILED,template:e.MSG_SENT_FAILURE})})})}m.forEach(function(t){var o={};o[t]="";var i=n.child(p.empl.category_id+"/messages");i.push({to:o,from:window.localStorage.getItem("apikeypublic"),from_name:r.name,message:e.NEW_SUBSCRIPTION,time:Firebase.ServerValue.TIMESTAMP,toShow:!1},function(e){d.$broadcast("loading:hide"),e&&s(["MSG_SENT_FAILURE"]).then(function(e){a.alert({title:e.FAILED,template:e.MSG_SENT_FAILURE})})})})})})},function(){s(["SOMETHING_WRONG","FAILED"]).then(function(e){d.$broadcast("loading:hide"),a.alert({title:e.FAILED,template:e.SOMETHING_WRONG})})})},p.noService=function(e){if(e.checked){var t=u.getTagsRatePlan(p.empl.category_id,["Driver",e.text]);t.length>0&&s("NO_RATE_PLAN").then(function(e){i.info(e+t.join(", "),{timeOut:3e3,positionClass:"toast-bottom-center"})})}},p.showService=function(e){c(function(){angular.element(e.target).siblings("").find("ion-item").trigger("click")})},p.showServiceField=function(){return p.empl&&p.empl.item&&p.empl.item.indexOf("Driver")>-1}})}]).controller("EmployeeDispatcherCtrl",["MapServ","$interval","$ionicSideMenuDelegate","baseUrl","$ionicScrollDelegate","$ionicHistory","$ionicFilterBar","$state","$filter","$localStorage","fireRef","$ionicLoading","$ionicPopup","$ionicPopover","$ionicModal","toastr","$translate","$timeout","$rootScope","constants","$scope","$stateParams","EmployeeService",function(e,t,o,i,n,a,r,l,s,c,d,p,u,m,g,f,v,h,_,E,S,D,y){S.centerMap={};_.showFooter=!1;var M;S.loading=!0,o.canDragContent(!1),S.$on("$ionicView.afterEnter",function(){S.showpost=y.getGlobalGroups().indexOf(D.employeeId)>-1,S.zonecircles=y.getzoneMap()[D.employeeId],S.zonecircles&&_.setCircles(S.zonecircles),S.quoteslide=!0,S.view_loaded=!0,S.onSlideMove=function(t){S.messaging=1==t.index,S.quoteslide=0==t.index,S.mapslide=2==t.index,S.setMenuText(S.messaging),S.mapslide?(_.setMapClass("dispatchermap"),e.createMap(document.getElementById("dispatchermap"))):(_.mapclass=null,document.querySelector("ion-view.pane").style.position="absolute",_.$broadcast("setmapclick",!1),e.setVisible(!1))};var t;S.showFilterBar=function(){t=r.show({items:S.employees,update:function(e,t){S.employees=e}})},S.showLargImage=function(e){e.pic=e.pic||S.defaultPic,S.largeImg=e,S.showModal("popovers/image-popover.html")},S.popoverDiscount=m.fromTemplate(['<ion-popover-view style="height: 50px;">',"<ion-content>",'<div id="discount" class="item-input-inset search-bar">','<label class="item-input-wrapper">','<i class="icon ion-ios7-search placeholder-icon"></i>','<input id="searchKey" type="search" placeholder="{{ \'DISCOUNT_CODE\' | translate }}" ng-model="coupon" autocorrect="off">',"</label>",'<span ng-click="setDiscountCode(coupon)" ng-class="(coupon.length > 0) ? \'ion-checkmark\' : \'\'" class="button button-clear ft25"></span>',"</div>","<div id=\"discount\" style=\"margin:10px\" ng-if=\"!validCoupon\" class=\"form-errors\" ng-messages=\"{'incorrect_code': invalid_reason == 'code', 'no_drivers': invalid_reason == 'driver', 'not_in_range': invalid_reason == 'range'}\">","<div class=\"form-error\" ng-message-exp=\"['incorrect_code']\">{{'INVALID_COUPON'|translate}}</div>","<div class=\"form-error\" ng-message-exp=\"['no_drivers']\">{{'COUPON_NO_DRIVERS'|translate}}</div>","<div class=\"form-error\" ng-message-exp=\"['not_in_range']\">{{'COUPON_NOT_IN_RANGE'|translate}}</div>","</div>","</ion-content>","</ion-popover-view>"].join(""),{scope:S});var o,i=!1;S.validCoupon=!0;var T=_.$on("search:location",function(e,t){i&&(i=!1,t&&t.coupon?(_.$broadcast("validcoupon",o),_.$broadcast("loading:hide"),S.popoverDiscount.hide(),S.validCoupon=!0):(S.invalid_reason="driver",S.validCoupon=!1,_.$broadcast("loading:hide")))});S.setDiscountCode=function(e){"NO_DRIVER"!=S.quoteBtnText&&(_.$broadcast("loading:show",{text:"VALIDATING_COUPON"}),y.coupon(e).then(function(e){"Success"==e.status?(o=JSON.parse(e.data.settings),o.group_name!=S.quoteForm.group_name?(S.invalid_reason="code",S.validCoupon=!1,_.$broadcast("loading:hide")):y.getGPSDistance(o.pickup_lat,o.pickup_lon,_.lat,_.lon)>1?(S.invalid_reason="range",S.validCoupon=!1,_.$broadcast("loading:hide")):(i=!0,_.$broadcast("location:searched",{pickup:{lat:o.pickup_lat,lon:o.pickup_lon,coupon:!0}}))):(S.invalid_reason="code",S.validCoupon=!1,_.$broadcast("loading:hide"))}),S.quoteForm.coupon=e)},S.showChatModal=function(e){g.fromTemplateUrl("modals/chat.html",{apikey:e.apikeypublic,zone_id:e.category_id,scope:S}).then(function(e){void 0!=_.chatModal&&null!=_.chatModal&&_.chatModal.isShown()||(_.chatModal=e,e.show())})},S.removeChatModal=function(){y.removeModalPopup(_,"chatModal")};var k=_.$watch("dispatcherQMode",function(e,t){e!=t&&(c.dispatcherQMode=_.dispatcherQMode)});y.getTags(window.localStorage.getItem("apikeypublic"),D.employeeId).then(function(e){S.tags=e.tags,S.serviceSelected(),0==S.totalDrivers&&S.allow_advance_reservation>0&&S.tags.forEach(function(e){G.push(e),S.services.push({id:e,text:e,"class":"taxicar",checked:!1,icon:"pics/taxi.png"})})});var I=S.$on("location:updated",function(e){});S.showModal=function(e){g.fromTemplateUrl(e,{scope:S,animation:"slide-in-up"}).then(function(e){S.fullSizeImageModal=e,S.fullSizeImageModal.show()})},S.closeModal=function(){S.fullSizeImageModal.hide(),S.fullSizeImageModal.remove()},S.filterPickupServ=function(e){var t=y.getTagsDriverMap();return j?S.quoteForm.service?t[S.quoteForm.service][e.apikeypublic]:t.all[e.apikeypublic]:!0},S.filterRange=function(e){if(S.quoteForm.range){var t=y.getGpsRanges();return t[S.quoteForm.range].indexOf(e.apikeypublic)>-1}return!0},S.filterMe=function(e){if(void 0!=S.quoteForm.pickup&&Object.keys(S.quoteForm.pickup).length>0){S.quoteForm.pickup}else;return e.apikeypublic!=window.localStorage.getItem("apikeypublic")},S.filterTags=function(e){return"number"!=typeof e.QP&&y.matchesTags(e,S.quoteForm.service.split(",").filter(function(e){return e}))},S.filterZone=function(e){return x?e.zone_id==x:!0},S.filterBookedDriver=function(e){return e.booked&&e.tags&&e.tags.indexOf("Driver")>-1},S.quoteFilter=function(e){return S.filterMe(e)&&S.filterBookedDriver(e)&&S.filterMode(e)&&(!S.quoteForm.pickup||S.filterTags(e)&&S.filterPickupServ(e)&&S.filterRange(e)&&S.filterZone(e))},S.isDispatcher=!1,S.isAdmin=!1,S.isOwner,S.filterAdmin=function(){var e=!1;return null!=y.getCategEmployees()&&y.getCategEmployees().forEach(function(t,o){t.category_id!=D.employeeId||t.apikeypublic!=window.localStorage.getItem("apikeypublic")||e&&void 0!=e||(e=t.hasOwnProperty("can_bookin")?t.hasOwnProperty("can_bookin"):t.tags&&t.tags.indexOf("Admin")>-1,S.isAdmin=e,_.isOwner=S.isOwner=c.user_id==t.user_id,e||h(function(){$(".dispatcherToggle .toggle").css("display","none")}))}),e},S.filterMode=function(e){return"offer"==_.dispatcherQMode||e.mode==_.dispatcherQMode},S.messageFilter=function(e){return S.messaging&&"1"==e.active&&""!=e.apikeypublic};var b=function(e,t){if(void 0==S.quoteForm.pickup)var o={lat:_.lat,lon:_.lon};else var o={lat:S.quoteForm.pickup.lat,lon:S.quoteForm.pickup.lon};var i=y.getGPSDistance(parseFloat(e.lat),parseFloat(e.lng),o.lat,o.lon),n=y.getGPSDistance(parseFloat(t.lat),parseFloat(t.lng),o.lat,o.lon);return Math.abs(i-n)>.5?i-n:Number(e.QP.split("/")[0])-Number(t.QP.split("/")[0])},C=function(e,t){return t.booked};S.defaultPic="img/person.jpg",_.mapmarkers={};var w=!1,R=function(){y.findByCategoryId(D.employeeId).then(function(e){S.employees||(S.loading=!1,h(function(){S.scrollerHeight={height:$(".slider-slide").height()-15+"px"}})),void 0==S.isOwner&&S.filterAdmin(),e.length>0&&(S.showquote=!0),null!=S.employees&&(S.oldemployees=angular.copy(S.employees)),S.employees=e;var t=[],o=[];S.employees.forEach(function(e,i){e.hasOwnProperty("rating")&&(e.driverRating=e.rating.driver.toFixed(2)),e.hasOwnProperty("booked")||(e.booked=!1),e.isChecked=1==e.active&&!e.intrip&&""==e.quote_id,null==S.oldemployees?e.isCheckedForMsg=!0:void 0!=S.oldemployees[i]&&(e.isCheckedForMsg=S.oldemployees[i].isCheckedForMsg),e.tags.indexOf("Driver")>-1&&e.apikeypublic!=window.localStorage.getItem("apikeypublic")&&(M=h(function(){_.mapmarkers&&(_.mapmarkers[e.apikeypublic]={booked:e.booked,lat:Number(e.lat),lng:Number(e.lng),zone_id:e.zone_id,clickable:!0},_.setMapMarkers(_.mapmarkers))})),S.quoteFilter(e)&&t.push(e),S.filterMe(e)&&o.push(e)});var i=y.getCategEmployees();S.hasDrivers=i[0].hasDriver,S.hasOtherItems=i[0].hasOtherItems,t.sort(b),o.sort(C),S.quotedrivers=t,S.messageitems=o})};y.getEmployees().forEach(function(e){e.category_id==D.employeeId&&(S.title=e.managerName,S.quoteForm={},S.quoteForm.group_name=e.managerName)});var O=S.$watch("employees",function(e,t){if(void 0!=e){var o=[];e.forEach(function(e,t){e.apikeypublic!=window.localStorage.getItem("apikeypublic")&&e.booked&&o.push(e)}),0==o.length&&(S.alertPopup&&S.alertPopup.hide(),S.messagePopup&&S.messagePopup.close())}});R();var P=S.$on("firebase:updated",function(e,t){R()}),A=S.$on("mapset",function(e,t){w=!0,R()}),L=S.$on("inbox:updated",function(e,t){t==D.employeeId&&d.child(D.employeeId+"/queue").orderByChild("timestamp").once("value",function(e){y.setEmpl(e,D.employeeId)})}),F=_.$on("empl:saved",function(e){R()});m.fromTemplateUrl("popovers/dispatcher-menu.html",{scope:S}).then(function(e){S.popoverDispatcher=e}),S.filterFunc=function(e){return e.apikeypublic===window.localStorage.getItem("apikeypublic")};var N=!0;S.reorder=function(){S.popoverDispatcher.hide(),N=!1,S.data.showReorder=!S.data.showReorder,S.data.showDelete=!1},S.bydist=function(){S.popoverDispatcher.hide(),N=!0,S.data.showReorder=!1,S.data.showDelete=!1},S["delete"]=function(){S.popoverDispatcher.hide(),S.data.showDelete=!S.data.showDelete,S.data.showReorder=!1},S.sortFunc=function(e){if(S.messaging)return e.booked?-1:1;if(N){if(void 0==S.quoteForm.pickup)var t={lat:_.lat,lon:_.lon};else var t={lat:S.quoteForm.pickup.lat,lon:S.quoteForm.pickup.lon};return y.getGPSDistance(parseFloat(e.lat),parseFloat(e.lng),t.lat,t.lon)}};S.edit=function(e){1==e&&y.getCategEmployees().some(function(t,o){return t.category_id==D.employeeId&&!t.can_bookin&&t.apikeypublic==window.localStorage.getItem("apikeypublic")&&t.tags.indexOf("Admin")>-1?(e=t,!0):void 0}),S.empl=e,l.transitionTo("app.dispatcher-form",{employeeId:D.employeeId,obj:S.empl,type:"edit"})},S.add=function(){S.empl={},S.empl.category_id=S.employees[0].category_id,S.empl.active=1,S.data.showReorder=!1,S.data.showDelete=!1,
S.popoverDispatcher.hide(),l.transitionTo("app.dispatcher-form",{employeeId:D.employeeId,obj:S.empl,type:"add"})},S.onItemDelete=function(e){_.$broadcast("loading:show"),y.deleteDispatcherItem(e).then(function(){S.bookOutDriver(e.apikeypublic,e.category_id,"removed"),S.employees.splice(S.employees.indexOf(e),1),y.findAllEmployees().then(function(e){y.autologin().then(function(e){_.$broadcast("empl:saved"),v(["SUCCESS","ITEM_DELETED"]).then(function(e){f.success(e.ITEM_DELETED,e.SUCCESS,{timeOut:3e3,positionClass:"toast-bottom-center"})})})})},function(){v(["SOMETHING_WRONG","FAILED"]).then(function(e){u.alert({title:e.FAILED,template:e.SOMETHING_WRONG})})})["finally"](function(){_.$broadcast("loading:hide")})},S.showAlert=function(e,t){v(["OK","CANCEL","ACTIVATE","INACTIVATE","CONFIRM_ACTIVATE","CONFIRM_INACTIVATE"]).then(function(o){u.confirm({title:e.active?o.ACTIVATE:o.INACTIVATE,template:text=(e.active?o.CONFIRM_ACTIVATE:o.CONFIRM_INACTIVATE)+e.firstName+"?",buttons:[{text:o.CANCEL},{text:o.OK,type:"button-positive",onTap:function(o){_.$broadcast("loading:show"),y.editDispatcherItem(e).then(function(o){_.$broadcast("loading:hide"),S.bookOutDriver(e.apikeypublic,e.category_id,"deactivated"),y.getCategEmployees()[t].active=e.active,e.active||R()},function(){v(["SOMETHING_WRONG","FAILED"]).then(function(e){_.$broadcast("loading:hide"),u.alert({title:e.FAILED,template:e.SOMETHING_WRONG})})})}}]})})},S.reportEvent=function(e){var t=e.target.parentNode.attributes[6].value,o=e.target.parentNode.attributes[5].value,i=angular.copy(y.getCategEmployees()[t]);i.active="1"==o?0:1;var n=[];i.tags.forEach(function(e){e.indexOf("Driver")>-1&&n.push(e)}),i.itemType=n.join("&itemType[]="),S.showAlert(i,t)},S.bookOutDriver=function(e,t,o){v(["REMOVED_MESSAGE","DEACTIVATED_MESSAGE","FAILED"]).then(function(i){var n=("deactivated"==o?i.DEACTIVATED_MESSAGE:i.REMOVED_MESSAGE)+S.title,a=d.child(t+"/messages"),r={};r[e]="",a.push({to:r,from:window.localStorage.getItem("apikeypublic"),from_name:c.name,message:n,time:Firebase.ServerValue.TIMESTAMP,toShow:!1,type:o},function(e){})})},S.data={showDelete:!1},S.moveItem=function(e,t,o,i){var n=S.employees.indexOf(i[o]);S.employees.splice(S.employees.indexOf(e),1),S.employees.splice(n,0,e)},S.icons=[".icon-pickup",".icon-dropoff",".ion-clock",".ion-person-add",".services.ion-model-s"];S.locationTapped=function(e){if("pickup"==e){var t=S.icons.indexOf(".icon-pickup");t>-1&&S.icons.splice(t,1)}else{var t=S.icons.indexOf(".icon-dropoff");t>-1&&S.icons.splice(t,1)}};var x=null,q=!1,z=!1,V=function(){x=y.pickupCenterZone(S.quoteForm.pickup.lat,S.quoteForm.pickup.lon,D.employeeId),q=x},G=[],U={},B=y.getEmployees()[y.getGroupItems()[D.employeeId].groupPosition].settings;S.allow_advance_reservation=B&&void 0!=B.allow_advance_reservation?B.allow_advance_reservation:_.allow_advance_reservation,S.allow_remote_reservation=B&&void 0!=B.allow_remote_reservation?B.allow_remote_reservation:_.allow_remote_reservation,S.setTagMap=function(e,t,o,i,n,a,r,l){if(S.services=t,S.servicesDetail=y.getTagsDriverMap(),Object.keys(i).length>0&&(U=i,S.rangeAvailable=!0,S.nearestTime=i.nearestDriverTime,S.furthestTime=i.furthestDriverTime),o.length>0&&0!=S.services.length&&v(["SERVICE_REMOVED","SERVICES_NOT_AVAILABLE","SERVICE_NOT_AVAILABLE"]).then(function(e){var t=o+(o.length>1?e.SERVICES_NOT_AVAILABLE:e.SERVICE_NOT_AVAILABLE);f.info(t,e.SERVICE_REMOVED),S.alertPopup&&S.alertPopup.hide(),h(function(){$("#serviceIcon ion-item").click()})}),S.totalDrivers=e,0==S.totalDrivers){if(S.services.length>0&&(S.quoteBtnText="SET_A_B"),x&&l&&z&&(x=null,S.serviceSelected()),0==S.services.length&&0==S.allow_advance_reservation)return"pickup"!=j&&(y.driversAvailable(D.employeeId)?S.quoteBtnText="SET_A_B":S.quoteBtnText="NO_DRIVER",S.totalDrivers=0,H=void 0,j=null,S.pickupSelected=!1,S.nearestTime=null,S.alertPopup&&S.alertPopup.hide()),j=null,!1}else{if(!n)return!x&&q&&l&&(V(),S.serviceSelected()),ie&&(_.$broadcast("search:location",ee),ie=!1),K?S.quoteForm.range?W||(1==S.services.length?(S.quoteForm.service=S.services[0].text,S.quoteBtnText="REVIEW"):S.services.length>1&&(S.quoteBtnText="SELECT_SERVICE")):S.quoteBtnText="SET_RANGE":S.quoteBtnText="SET_A_B",!0;S.quoteBtnText="SET_RANGE",S.quoteForm.range=null,S.alertPopup&&S.alertPopup.hide(),j=null}},S.services=[],S.quoteForm.services=[],S.serviceSelected=function(e){y.resetETA(),e&&(W=!0);var t=y.getUniqueDrivers();te="pickup"==j||e?ne:_;var o=Object.keys(t).length,i=0,n=0,a=0;z=!1;for(var r in t)if(n++,i=Object.keys(t[r]).length,a=0,t[r][D.employeeId]){a++;var l={},s=D.employeeId;l[r]=t[r][s],a==i&&(z=!0),y.setTagMap("updated",l,te,S.services,G,S.quoteForm.service,function(e,t,r,l,s,c,d,p){n==o&&a==i&&S.setTagMap(e,t,r,l,s,c,d,p)},U,D.employeeId,null,null,S.quoteForm.range,x)}K&&(S.quoteForm.range?0==S.quoteForm.service.length?S.quoteBtnText="SELECT_SERVICE":S.quoteBtnText="REVIEW":S.quoteBtnText="SET_RANGE")};var j,H,Y=!1,W=!1;S.resetQuoteForm=function(){S.quoteForm.splitFare=["splitFare[]="],S.quoteForm.date=moment(new Date).format("MM/DD/YY"),S.quoteForm.time=moment(new Date).format("hh:mm a"),S.quoteForm.service="",h(function(){_.$broadcast("resetfancy")}),S.quoteForm.people=1,K=Z=Y=S.pickupSelected=!1,j=H=oldDrop=void 0,S.driversInspected=!0,W=!1,S.showBtn=!0,S.quoteForm.range=null,S.quoteForm.price=null,S.quoteForm.pickup_type=null,S.quoteForm.pickup_type_name=null,S.quoteForm.dropoff_type=null,S.quoteForm.dropoff_type_name=null,S.quoteForm.post_expire=null,S.quoteForm.mode=null,S.instructionsModal&&(S.instructionsModal.remove().then(function(){S.instructionsModal=null}),S.notes.forEach(function(e){e.checked=!1})),x=null,S.timezone=_.tz,h(function(){S.serviceSelected()}),S.$broadcast("resetDtPicker"),j=null,S.quoteBtnText=S.allow_advance_reservation?"SET_A_B":"NO_DRIVER"},S.resetQuoteForm();var K=!1;S.changed=function(e){e&&(e.hasOwnProperty("pickup")&&(S.quoteForm.pickup=e.pickup),e.hasOwnProperty("dropoff")&&(S.quoteForm.dropoff=e.dropoff),e.hasOwnProperty("range")&&(S.quoteForm.range=e.range),e.hasOwnProperty("price")&&(S.quoteForm.price=e.price),y.getTimeZone(e.pickup.lat,e.pickup.lon).then(function(e){S.timezone=e.timeZoneId}),e.hasOwnProperty("pickup_type")&&(S.quoteForm.pickup_type=e.pickup_type,S.quoteForm.pickup_type_name=e.pickup_type_name,S.quoteForm.dropoff_type=e.dropoff_type,S.quoteForm.dropoff_type_name=e.dropoff_type_name,S.quoteForm.post_expire=e.post_expire),V()),void 0!=S.quoteForm.pickup&&Object.keys(S.quoteForm.pickup).length>0&&(Y=!0,S.bydist(),j="pickup",ie=!0,ne=S.quoteForm.pickup),J(),S.quoteBtnText="SET_A_B",0==S.quoteForm.service.length&&(S.quoteBtnText="SELECT_SERVICE"),S.serviceSelected()};var Q=new google.maps.DirectionsService,Z=!1,J=function(){if(void 0!=S.quoteForm.pickup&&void 0!=S.quoteForm.dropoff&&(S.quoteForm.pickup!=H||S.quoteForm.dropoff!=oldDrop)){K=Z=!0,H=S.quoteForm.pickup,oldDrop=S.quoteForm.dropoff;var e=new google.maps.LatLng(S.quoteForm.pickup.lat,S.quoteForm.pickup.lon),t=new google.maps.LatLng(S.quoteForm.dropoff.lat,S.quoteForm.dropoff.lon),o={origin:e,destination:t,travelMode:google.maps.TravelMode.DRIVING};Q.route(o,function(e,t){if(t==google.maps.DirectionsStatus.OK)for(var o=e.routes[0],i=0;i<o.legs.length;i++)S.estDist=(o.legs[i].distance.value/1609).toFixed(1),S.estTime=o.legs[i].duration.text,S.quoteForm.estDistVal=o.legs[i].distance.value/1609,S.quoteForm.estTimeVal=o.legs[i].duration.value/60,S.pickupSelected=!0,S.quoteForm.distance=S.estDist,0!=S.quoteForm.service.length&&W&&(S.quoteBtnText="REVIEW")})}},X=function(e,t){var o=new google.maps.Geocoder;o.geocode({latLng:e},function(e,o){o==google.maps.GeocoderStatus.OK&&("pickup"==t?(S.quoteForm.pickup={},S.quoteForm.pickup.formatted_address=e[0].formatted_address,S.quoteForm.pickup.lat=e[0].geometry.location.lat(),S.quoteForm.pickup.lon=e[0].geometry.location.lng(),$(".ion-google-place-container.modal").is(":visible")&&_.$broadcast("posFetched")):(S.quoteForm.dropoff={},S.quoteForm.dropoff.formatted_address=e[0].formatted_address,S.quoteForm.dropoff.lat=e[0].geometry.location.lat(),S.quoteForm.dropoff.lon=e[0].geometry.location.lng()))})};X(new google.maps.LatLng(_.lat,parseFloat(_.lon)+.008),"dropoff");S.totalDrivers=0;var Y=!1,ee={},te={},oe=function(e,t,o){te="pickup"==j||S.quoteForm.pickup&&S.quoteForm.pickup.lat?ne:_,null!=t&&y.setTagMap(o,t,te,S.services,G,S.quoteForm.service,function(e,t,o,i,n,a,r,l){S.setTagMap(e,t,o,i,n,a,r,l)},U,D.employeeId,null,null,S.quoteForm.range,x)},ie=!1,ne={},ae=S.$on("location:searched",function(e,t){ne=t.pickup,ie=!0,S.setTag()}),re=S.$on("queue:updated",oe),le=S.$on("queue:added",oe),se=S.$on("queue:removed",oe);S.rangeAvailable=!1;var ce=S.$on("queue:range",function(e,t,o){S.rangeAvailable=!0,S.nearestMiles=t,S.furthestMiles=o}),de=S.$on("queue:rangeTime",function(e,t,o){S.nearestTime=t,S.furthestTime=o}),pe=["NOTES_DRIVER1","NOTES_DRIVER2","NOTES_DRIVER3","NOTES_DRIVER4","NOTES_DRIVER5"];if(v(pe).then(function(e){S.notess=[],S.translatedText={},pe.forEach(function(t,o){S.notess.push({text:e[t],checked:!1}),S.translatedText[t]=e[t]})}),S.noteChecked=function(e){var t;S.notes.forEach(function(e){e.checked&&(t=e)}),void 0!=t?t==e?e.checked=!e.checked:(t.checked=!1,e.checked=!0):e.checked=!0,e.text==S.translatedText.NOTES_DRIVER5?(S.otherNoteSelected=!1,h(function(){$("textarea").focus()})):S.otherNoteSelected=!0,n.resize()},S.openInstructions=function(){if(S.notes=angular.copy(S.notess),null!=S.instructionsModal)return void S.instructionsModal.show();g.fromTemplateUrl("modals/quote-note.html",{scope:S,animation:"slide-in-up",backdropClickToClose:!1}).then(function(e){S.otherNoteSelected=!0,S.quotenote={},S.instructionsModal=e,e.show()})},S.quoteForm.note="",S.saveInstructions=function(){S.quoteForm.note="",S.notess=angular.copy(S.notes),S.notes.forEach(function(e){e.checked&&(e.text==S.translatedText.NOTES_DRIVER5?S.quoteForm.note=S.quotenote.other:S.quoteForm.note=e.text)}),S.instructionsModal.hide()},S.services=[],v("SELECT_SERVICE").then(function(e){S.services_text_single=e}),S.val={single:null,multiple:null},S.setServiceCheckMark=function(){S.services.forEach(function(e){e.id==S.quoteForm.service?e.checked=!0:e.checked=!1})},S.quoteForm.service="",S.setCarIcon=function(){S.services.forEach(function(e){S.quoteForm.service==e.id&&(S.serviceImg=e.icon)}),0==S.services.length&&(S.serviceImg="pics/taxi.png")},S.setCarIcon(),S.showService=function(){S.setServiceCheckMark()},S.reset=function(){S.alertPopup.hide(),S.resetQuoteForm()},S.editPickup=function(e){h(function(){$("#icon-pickup").trigger("click",[e])})},S.editService=function(){h(function(){$("#serviceIcon ion-item").click(),S.overlayModal()})},S.editSeats=function(){h(function(){$("div[people] .button-icon").click(),S.overlayModal()})},S.editDate=function(){h(function(){$("date-picker .button-icon").click(),S.overlayModal()})},S.editNotes=function(){S.openInstructions(),S.overlayModal()},S.overlayModal=function(){$('.modal:not(".confirmquoteModal")').parent().closest("div.modal-backdrop").css("zIndex",50)},S.setTag=function(){var e=y.setTag(ne,S.quoteForm.service,D.employeeId);ee=ne,e>0?_.$broadcast("search:location",ee):y.withinZone(D.employeeId,!1,ee.lat,ee.lon)?_.$broadcast("search:location",ee):(Y=!1,v(["SORRY","NO_DRIVERS_PICKUP"]).then(function(e){ie&&(f.error(e.NO_DRIVERS_PICKUP,e.SORRY),_.$broadcast("search:location",null),ie=!1)}),j=null)},void 0!=_.rates[0])if("offer"==_.rates[0].mode){var ue={rate_id:_.rates[0].value,price:_.rates[0].price,zone_id:_.rates[0].zone_id,id:_.rates[0].quoteId,summary:_.rates[0].summary};_.loggedIn&&y.showOrderForm(ue)}else if(null!=_.priceModal)for(var me=0;me<_.rates.length;me++)if(_.rates[me].value==_.selectedRate.rate_id){var ue={rate_id:_.selectedRate.rate_id,price:_.rates[me].price,zone_id:_.rates[me].zone_id,id:_.rates[me].quoteId,summary:_.rates[me].summary};y.showPriceModal(),_.loggedIn&&y.showOrderForm(ue);break}S.dropoffClicked=function(){h(function(){$("#icon-pickup").click()})},S.saveDateTime=function(e){S.quoteForm.date=moment(new Date(e)).format("MM/DD/YY"),S.quoteForm.time=moment(new Date(e)).format("hh:mm a")},S.quoteButtonTapped=function(e){if(S.messaging)S.enterMessage();else if("SELECT_SERVICE"==S.quoteBtnText)h(function(){$("#serviceIcon ion-item").click()});else if("SET_A_B"==S.quoteBtnText||"SET_RANGE"==S.quoteBtnText){h(function(){$("#icon-pickup").click()});var t=new google.maps.LatLng(_.lat,_.lon),o=new google.maps.LatLng(_.lat,_.lon+.008);X(t,"pickup"),X(o,"dropoff")}else"REVIEW"==S.quoteBtnText&&S.sendQuote()};var ge=S.$on("validcoupon",function(e,t){S.quoteForm.dropoff.formatted_address=t.dropoff,S.quoteForm.dropoff.lat=t.dropoff_lat,S.quoteForm.dropoff.lon=t.dropoff_lon,S.quoteForm.people=t.selectPeople,S.quoteForm.service=t.selectService,S.quoteForm.coupon=t.coupon,S.quoteForm.price=t.price,S.quoteForm.range=E.defaultMilesRadius,S.quoteForm.mode="offer";var o={origin:new google.maps.LatLng(_.lat,_.lon),destination:new google.maps.LatLng(S.quoteForm.dropoff.lat,S.quoteForm.dropoff.lon),travelMode:google.maps.TravelMode.DRIVING};Q.route(o,function(e,t){if(t==google.maps.DirectionsStatus.OK)for(var o=e.routes[0],i=0;i<o.legs.length;i++)S.estDist=(o.legs[i].distance.value/1609).toFixed(1),S.estTime=o.legs[i].duration.text,S.quoteForm.estDistVal=o.legs[i].distance.value/1609,S.quoteForm.estTimeVal=o.legs[i].duration.value/60,S.pickupSelected=!0,S.quoteForm.distance=S.estDist,_e()})});S.send=function(){y.removeModalPopup(S,"alertPopup"),S.showBtn=!1,_e()},S.confirm=function(){S.sendQuote(!0)},S.sendQuote=function(e){v(["CONFIRM","ERROR","CURRENTLY_NO_DRIVERS","SORRY","NO_DRIVERS_PICKUP","ENTER_PICKUP_LOC","ENTER_DROPOFF_LOC"]).then(function(t){if(e)_e();else{if(null!=S.alertPopup)return void S.alertPopup.show();g.fromTemplateUrl("modals/confirmquote.html",{scope:S,animation:"slide-in-up",backdropClickToClose:!1}).then(function(e){S.alertPopup=e,e.show()})}})};var fe=S.$on("quoteaccepted",function(){S.quoteSentMsg=null,_.dontHideLoader=!1}),ve=S.$on("quotecancelled",function(e,t){_.dontHideLoader=!1,S.quoteSentMsg==t&&v(["SORRY","QUOTE_NOT_ACCEPTED"]).then(function(e){S.quoteSentMsg=null,f.error(e.QUOTE_NOT_ACCEPTED,e.SORRY),_.$broadcast("loading:hide")})}),he=!1,_e=function(){S.quoteForm.group_id=D.employeeId,S.quoteForm.items=[],S.employees.forEach(function(e,t){e.apikeypublic!=window.localStorage.getItem("apikeypublic")&&y.matchesTags(e,S.quoteForm.service.split(",").filter(function(e){return e}))&&e.isChecked&&e.booked&&e.category_id==D.employeeId&&S.quoteForm.items.push("items[]="+e.item_id)});var e=s("filter")(S.employees,function(e,t,o){return e.apikeypublic!=window.localStorage.getItem("apikeypublic")&&e.booked&&y.matchesTags(e,S.quoteForm.service.split(",").filter(function(e){return e}))&&(S.quoteForm.mode==e.mode||!S.quoteForm.mode&&e.mode==_.dispatcherQMode||"offer"==_.dispatcherQMode)});return e.length>0&&0==S.quoteForm.items.length?void v(["SORRY","SELECT_DRIVER"]).then(function(e){f.error(e.SELECT_DRIVER,e.SORRY)}):(he=!0,_.showLoader=!0,_.$broadcast("loading:show",{text:"SEND_RIDE_REQ"}),S.quoteForm.timezone=S.timezone,_.dontHideLoader=!0,void y.quoteDispatcher(S.quoteForm).then(function(e){he=!1,0==S.totalDrivers?(_.$broadcast("quoteaccepted"),v(["SUCCESS","QUOTE_SCHEDULED"]).then(function(e){f.success(e.QUOTE_SCHEDULED,e.SUCCESS)}),_.$broadcast("loading:hide")):("offer"!=e.mode&&v("AWAIT_CONFIRM").then(function(e){p.show({template:e})}),S.quoteSentMsg=e.quoteID),S.resetQuoteForm(),S.quoteForm.date=moment(new Date).format("MM/DD/YY"),S.quoteForm.time=moment(new Date).format("hh:mm a")},function(e){_.dontHideLoader=!1,_.$broadcast("loading:hide"),null!=S.modalDatePicker&&S.modalDatePicker.remove(),null!=S.seatsModal&&S.seatsModal.remove(),S.modalDatePicker=null,S.seatsModal=null,v(["SOMETHING_WRONG","FAILED"]).then(function(e){u.alert({title:e.FAILED,template:e.SOMETHING_WRONG})}),S.showBtn=!0}))};S.messaging=!1,S.setMessaging=function(){S.messaging=!S.messaging,S.setMenuText(S.messaging),S.popoverDispatcher.hide()},S.setMenuText=function(e){v(["SEND_MESSAGE","SEND_QUOTE","SELECT_NONE"]).then(function(t){S.sendmsgquote=e?t.SEND_QUOTE:t.SEND_MESSAGE,e?(S.isAdmin||h(function(){$(".dispatcherToggle .toggle").css("display","none")}),S.selectallnonetext=t.SELECT_NONE,S.setMsgCheckboxes()):S.isAdmin&&h(function(){$(".dispatcherToggle .toggle").css("display","block")})})},S.setMenuText(!1),v("SELECT_NONE").then(function(e){S.selectquoteallnonetext=e}),S.selectAllNone=function(e){v(["SELECT_ALL","SELECT_NONE"]).then(function(t){"msg"==e?(S.selectallnonetext=S.selectallnonetext==t.SELECT_ALL?t.SELECT_NONE:t.SELECT_ALL,S.setMsgCheckboxes()):(S.selectquoteallnonetext=S.selectquoteallnonetext==t.SELECT_ALL?t.SELECT_NONE:t.SELECT_ALL,S.setQuoteCheckboxes())}),S.popoverDispatcher.hide()},S.setMsgCheckboxes=function(){v(["SELECT_ALL"]).then(function(e){S.employees.forEach(function(t,o){S.selectallnonetext==e.SELECT_ALL?t.isCheckedForMsg=!1:t.isCheckedForMsg=!0})})},S.setQuoteCheckboxes=function(){v(["SELECT_ALL"]).then(function(e){S.employees.forEach(function(t,o){S.selectquoteallnonetext==e.SELECT_ALL?t.isChecked=!1:t.isChecked=!0})})},S.employeeDetailPage=function(e,t){"checkbox"!=e.target.type&&"IMG"!=e.target.tagName&&"ION-OPTION-BUTTON"!=e.target.tagName&&l.transitionTo("app.employee-detail",{employeeId:D.employeeId,driverId:t})},S.filteredData=[];var Ee=S.$watchCollection("employees",function(e){S.filteredData=s("filter")(e,function(e,t,o){return e.apikeypublic!=window.localStorage.getItem("apikeypublic")&&e.booked&&y.matchesTags(e,S.quoteForm.service.split(",").filter(function(e){return e}))&&(e.mode==_.dispatcherQMode||"offer"==_.dispatcherQMode)})});S.enterMessage=function(){if(S.recipientApiKeys={},S.recipientFirstName=[],S.zones=[],S.employees.forEach(function(e,t){e.active&&e.apikeypublic!=window.localStorage.getItem("apikeypublic")&&""!=e.apikeypublic&&e.isCheckedForMsg&&(S.recipientApiKeys[e.apikeypublic]="",S.recipientFirstName.push(e.firstName),S.zones.indexOf(e.category_id)<0&&S.zones.push(e.category_id))}),0==S.recipientFirstName.length)return void v(["SORRY","SELECT_RECIPIENT"]).then(function(e){f.error(e.SELECT_RECIPIENT,e.SORRY)});var e=s("filter")(S.employees,function(e,t,o){return e.apikeypublic!=window.localStorage.getItem("apikeypublic")&&"1"==e.active&&""!=e.apikeypublic});S.recipients=e.length==S.recipientFirstName.length?"All":S.recipientFirstName.join(","),S.message={},v(["ENTER_MESSAGE","CANCEL","SEND"]).then(function(e){S.messagePopup=u.show({cssClass:"sendMsgAlert",template:'<textarea  ng-model="message.msg" rows="8" cols="10"></textarea>',title:e.ENTER_MESSAGE,subTitle:"Recipients: "+S.recipients,scope:S,buttons:[{text:e.CANCEL},{text:"<b>"+e.SEND+"</b>",type:"button-positive",onTap:function(e){return S.message.msg?S.message.msg:void e.preventDefault()}}]}),S.messagePopup.then(function(e){void 0!=e&&S.message.msg.trim().length>0&&S.sendMessage()})})},S.sendMessage=function(){_.$broadcast("loading:show"),S.zones.forEach(function(e){var t=d.child(e+"/messages");t.push({to:S.recipientApiKeys,from:window.localStorage.getItem("apikeypublic"),from_name:c.name,message:S.message.msg,time:Firebase.ServerValue.TIMESTAMP},function(e){_.$broadcast("loading:hide"),e&&v(["MSG_SENT_FAILURE"]).then(function(e){u.alert({title:e.FAILED,template:e.MSG_SENT_FAILURE})})})})},h(function(){var e=y.getzoneMap();e[D.employeeId]&&e[D.employeeId].forEach(function(e){y.getzoneIDStored().indexOf()<0&&d.child(e.id+"/queue").orderByChild("timestamp").on("value",y.zoneListener)})},2e3),S.$on("$ionicView.beforeLeave",function(){T&&T(),ge&&ge(),_.isOwner=void 0,k&&k(),Ee&&Ee(),S.instructionsModal&&S.instructionsModal.remove().then(function(){S.instructionsModal=null}),S.seatsModal&&S.seatsModal.remove().then(function(){S.seatsModal=null}),null!=S.modalDatePicker&&(S.modalDatePicker.remove(),S.modalDatePicker=null),fe&&fe(),ve&&ve(),F&&F(),P&&P(),L&&L(),se&&se(),le&&le(),re&&re(),ce&&ce(),de&&de(),ae&&ae(),O&&O(),t&&(t(),t=null),I&&I(),A&&A(),M&&h.cancel(M),S.popoverMenu&&(S.popoverMenu.remove(),S.popoverMenu=null),"app.dispatcher-form"!=a.currentStateName()&&"app.employee-detail"!=a.currentStateName()&&y.emptyEmployeesCateg(),_.$broadcast("loading:hide"),_.mapmarkers=null,_.resetMap(),S.alertPopup&&y.removeModalPopup(S,"alertPopup"),y.removeModalPopup(S,"fullSizeImageModal"),y.removeModalPopup(S,"popoverDiscount"),y.removeModalPopup(S,"popoverDispatcher");var e=y.getzoneMap();e[D.employeeId]&&e[D.employeeId].forEach(function(e){y.getzoneIDStored().indexOf()<0&&d.child(e.id+"/queue").orderByChild("timestamp").off("value",y.zoneListener)}),y.resetDispatcherTagMap()})})}]).controller("RatingCtrl",["baseUrl","$ionicPopup","toastr","$localStorage","$translate","$timeout","$scope","$rootScope","EmployeeService",function(e,t,o,i,n,a,r,l,s){var c;r.openDetail=function(e){"IMG"!==e.target.nodeName&&(r.isAccordToggled=!r.isAccordToggled)},r.setRating=function(){for(var e=0,t=0;t<r.ratingChkboxes.length;t++)r.ratingChkboxes[t].isChecked&&e++;a(function(){r.rate=e})},r.max=5;var d,p,u,m,g,f,v,h=null,_=[],E=function(){if(m&&(h=s.getRating(i.tripDetail.zone_id,i.tripDetail.id)),l.$broadcast("loading:hide"),m)var e=["RATE_DRIVER1","RATE_DRIVER2","RATE_DRIVER3","RATE_DRIVER4","RATE_DRIVER5"];else var e=["RATE_CUSTOMER1","RATE_CUSTOMER2","RATE_CUSTOMER3","RATE_CUSTOMER4","RATE_CUSTOMER5"];n(e).then(function(t){var o=[{"class":"ion-clock",text:t[e[0]],isChecked:m?h.time:!0,calculated:m},{"class":m?"ion-speedometer":"icon-pick",text:t[e[1]],isChecked:m?h.speed:!0,calculated:m},{"class":m?"ion-arrow-graph-up-right":"icon-drop",text:t[e[2]],isChecked:m?h.distance:!0,calculated:m},{"class":m?"icon-driver":"ion-ios-locked",text:t[e[3]],isChecked:!0,calculated:!1},{"class":m?"ion-waterdrop":"ion-thumbsup",text:t[e[4]],isChecked:!0,calculated:!1}];r.ratingChkboxes=o,r.setRating()})},S=l.$on("modal.shown",function(e,t){if(d=t.zone_id,p=t.quote_id,u=t.tripID,f=t.reply_to,v=t.sent_to,m=t.isCustomer,g=t.isDriver,r.isDriver=g,c=l.detail,E(),m)var o=v;else var o=f;s.profile(o).then(function(e){r.name=e.description}),a(function(){}),r.showTripDetail=function(){if(void 0!=c){var e=["TRIP_INFO","PAYMENT_METHOD","PRICE","PICKUP","DROPOFF","SERVICE","SEATS","ROUTE","DATE_TIME","MILES"];n(e).then(function(e){r.accordion={},r.ratingitems=[{label:e.PAYMENT_METHOD,text:c.paymentMethod},{label:e.PICKUP,text:c.pickup},{label:e.DROPOFF,text:c.dropoff},{label:e.SERVICE,text:c.selectService},{label:e.SEATS,text:c.selectPeople},{label:e.ROUTE,text:c.route_distance+" "+e.MILES},{label:e.DATE_TIME,text:c.selectDate+" "+c.selectTime}],r.accordion.heading=e.TRIP_INFO})}},r.showTripDetail()});r.$on("$destroy",function(){S&&S()}),r.sendRating=function(){l.$broadcast("loading:show");for(var e=0;e<r.ratingChkboxes.length;e++)_.push("message[]="+(r.ratingChkboxes[e].isChecked?1:0));var a=i.tripDetail.isDriver;s.trip({isDriver:i.tripDetail.isDriver,zone_id:d,quote_id:p,tripID:u,msg:_,status:9}).then(function(e){s.removeModalPopup(l,"ratingModal"),o.clear(),a||s.endTrip(),l.$broadcast("loading:hide")},function(e){l.$broadcast("loading:hide"),n(["SOMETHING_WRONG","FAILED"]).then(function(e){t.alert({title:e.FAILED,template:e.SOMETHING_WRONG})})})}}]).controller("TripDetailCtrl",["MapServ","baseUrl","toastr","$interval","$ionicScrollDelegate","AnimateMarkerService","constants","$translate","$localStorage","$ionicPopup","$ionicSideMenuDelegate","$ionicPlatform","fireRef","$ionicModal","$ionicPopover","$timeout","$scope","$rootScope","EmployeeService",function(e,t,o,i,n,a,r,l,s,c,d,p,u,m,g,f,h,E,S){E.showMenuIcon=!1,h.map={},E.setMapClass("tripmapp customermap"),h.directionShowing=!0;var D={};h.$on("$ionicView.afterEnter",function(p,y){E.setMapClass("tripmapp customermap"),D=e.mapClickableSetter(h),h.openDetail=function(e){"IMG"!==e.target.nodeName&&(h.isToggled=!h.isToggled,E.$broadcast("setmapclick",!h.isToggled))},h.openReceiptDetail=function(e){"IMG"!==e.target.nodeName&&(h.isReceiptToggled=!h.isReceiptToggled,E.$broadcast("setmapclick",!h.isReceiptToggled),h.isReceiptToggled&&f(function(){}))};var M,T,k,I,b,C,w,R,O,P=new google.maps.DirectionsService,A="accept",L=!0,F=new google.maps.DirectionsRenderer({suppressMarkers:!0,preserveViewport:!0});if(void 0!=E.detail)var N=E.detail;var x=!1;if(void 0!=E.detail){var q=N.isDriver?N.reply_to:N.sent_to;f(function(){E.$broadcast("trip:started",null)}),S.profile(q).then(function(e){h.name=e.description,ye=e,E.$broadcast("trip:profile",e),S.processFirebase(),E.$broadcast("loading:hide")})}h.showTripDetail=function(){if(void 0!=N){var e=["DIRECTIONS","TRIP_INFO","PAYMENT_METHOD","PRICE","PICKUP","DROPOFF","SERVICE","SEATS","ROUTE","DATE_TIME","MILES"];l(e).then(function(e){h.accordion={},h.items=[{label:e.PAYMENT_METHOD,text:N.paymentMethod},{label:e.PICKUP,text:N.pickup},{label:e.DROPOFF,text:N.dropoff},{label:e.SERVICE,text:N.selectService},{label:e.SEATS,text:N.selectPeople},{label:e.ROUTE,text:N.route_distance+" "+e.MILES},{label:e.DATE_TIME,text:N.selectDate+" "+N.selectTime}],h.accordion.heading=e.DIRECTIONS,h.receiptaccordion=angular.copy(h.accordion),h.receiptaccordion.heading=e.TRIP_INFO,h.receiptitems=angular.copy(h.items)})}};var z=function(){return},V=h.$on("gpssuccess",function(){z()}),G=h.$on("gpserror",function(){z()});f(function(){({center:new google.maps.LatLng(E.lat,E.lon),panControl:!1,zoomControlOptions:{position:google.maps.ControlPosition.LEFT_CENTER},zoom:14,mapTypeControl:!1,mapTypeId:google.maps.MapTypeId.ROADMAP})}),l("TRIP_DETAIL").then(function(e){document.title=e}),h.tripStarted=!1;var U,B=h.$on("trip:started",function(t){if(h.tripStarted)return void E.$broadcast("loading:hide");if(h.tripStarted=!0,N=E.detail,E.tripsInProgress.indexOf(N.id)<0&&E.tripsInProgress.push(N.id),N.isDriver){var o="accept"!=N.status||r.testMode?"tripmapp drivermap":"tripmapp beforearrived";E.setMapClass(o),d.canDragContent(!1)}else E.setMapClass("tripmapp customermap");if(e.createMap(document.getElementById("tripmap"),null,function(){J||h.showMap()}),h.tripmsg={},E.detail.isCustomer)if(l("TRIP_DETAIL").then(function(e){h.triptitle=e,document.title=e}),"accept"==N.status)var i=["MESSAGE_CUSTOMER_BEFORE_ARRIVE1","MESSAGE_CUSTOMER_BEFORE_ARRIVE2","MESSAGE_CUSTOMER_BEFORE_ARRIVE3","MESSAGE_CUSTOMER_BEFORE_ARRIVE4","MESSAGE_CUSTOMER5"];else var i=["MESSAGE_CUSTOMER1","MESSAGE_CUSTOMER2","MESSAGE_CUSTOMER3","MESSAGE_CUSTOMER4","MESSAGE_CUSTOMER5"];else var i=["MESSAGE_DRIVER1","MESSAGE_DRIVER2","MESSAGE_DRIVER3","MESSAGE_DRIVER4","MESSAGE_DRIVER5"];if(l(i).then(function(e){h.tripmsgs=[],i.forEach(function(t,o){h.tripmsgs.push({text:e[t],val:e[t]})})}),h.cancel={},E.detail.isCustomer)var n=["MESSAGE_CANCEL_CUSTOMER1","MESSAGE_CANCEL_CUSTOMER2","MESSAGE_CANCEL_CUSTOMER3","MESSAGE_CANCEL_CUSTOMER4","MESSAGE_CANCEL_CUSTOMER5","CANCEL_TRIP"];else var n=["MESSAGE_CANCEL_DRIVER1","MESSAGE_CANCEL_DRIVER2","MESSAGE_CANCEL_DRIVER3","MESSAGE_CANCEL_DRIVER4","MESSAGE_CANCEL_DRIVER5","CANCEL_TRIP"];l(n).then(function(e){h.cancelreasons=[],n.forEach(function(t,o,i){o<i.length-1&&h.cancelreasons.push({text:e[t],val:e[t]})}),h.cancelTitle=e.CANCEL_TRIP}),h.showTripDetail(),h.showDriveInfo=!1,h.showFooter=!0,u.child(N.zone_id+"/inbox/"+N.id+"/route").once("value",function(e){N=angular.extend(N,N,e.val());var t=u.child(N.zone_id+"/inbox/"+N.id+"/route/status");k=t,k.on("value",H)}),u.child(N.zone_id+"/inbox/"+N.id+"/route").on("value",U),h.initOrder()});U=function(e){N=angular.extend(N,N,e.val()),E.detail=N,Oe[E.detail.sent_to]=E.detail,h.detail=N,("accept"==N.status||"arrived"==N.status||"load"==N.status)&&ee(N.status);var t=N.isDriver,o=!t,i=N.status,n=N.hasOwnProperty("reply_to_message")?N.reply_to_message[Object.keys(N.reply_to_message)[Object.keys(N.reply_to_message).length-1]].status:"quote",a=N.sent_to_message[Object.keys(N.sent_to_message)[Object.keys(N.sent_to_message).length-1]].status;t&&"unload"==n||("unload"==i||"receipt"==i||"rate"==i)&&o&&"receipt"!=a&&"rate"!=a?$e():(t&&"receipt"==n||o&&("unload"==N.status||"receipt"==N.status||"rate"==N.status)&&("receipt"==a||void 0==a))&&Te()};var j,H=function(e){var t=e.val();if(A=t,""!=N.sent_to&&(h.showDriveInfo=!0),j||(j=u.child(N.zone_id+"/queue/"+N.sent_to).on("value",re)),h.prodMode=!0,"accept"==t){h.arrivedloadunload="ARRIVED",ee(t);var i=S.getGPSDistance(E.lat,E.lon,N.pickup_lat,N.pickup_lon)>r.arriveBtnDisabledMiles;h.prodMode=!r.testMode,N.isDriver&&h.prodMode&&!i&&!de&&pe({zone_id:N.zone_id,quote_id:N.id,tripID:N.tripID,msg:"Arrived",status:5},"Arrived")}else"arrived"==t?(ee(t),h.arrivedloadunload="PICK_UP"):"load"==t?(h.arrivedloadunload="DROP_OFF",ee(t),h.disableArrive=!r.testMode&&S.getGPSDistance(E.lat,E.lon,N.dropoff_lat,N.dropoff_lon)>r.arriveBtnDisabledMiles,null!=E.arrivedModal&&1!=E.arrivedModal&&(E.arrivedModal.remove(),E.arrivedModal=null,S.isRinging()&&S.ringTone()),E.toastArrived&&(o.clear(E.toastArrived),E.toastArrived=null)):N.isDriver&&"unload"==t?$e():N.isDriver&&"receipt"==t&&(Te(),S.removeModalPopup(E,"receiptModal"))};h.showMap=function(){f(function(){var o=(new google.maps.LatLng(N.pickup_lat,N.pickup_lon),new google.maps.LatLng(N.dropoff_lat,N.dropoff_lon),new google.maps.LatLng(E.lat,E.lon),N.reply_to_message[Object.keys(N.reply_to_message)[Object.keys(N.reply_to_message).length-1]]);E.detail&&!E.detail.driver_lat&&(E.detail.driver_lat=o.lat,E.detail.driver_lon=o.lon);var i=new google.maps.LatLng(o.lat,o.lon);new google.maps.LatLng(E.detail.sent_to_message[0].lat,E.detail.sent_to_message[0].lon),{path:"M84 341c-21 0 -37 17 -37 38s16 37 37 37s37 -16 37 -37s-16 -38 -37 -38zM121 333c28 0 47 -24 47 -48v-114c0 -22 -32 -22 -32 0v105h-5v-286c0 -28 -41 -31 -43 0v165h-1h-7v-165c-1 -29 -43 -30 -43 0v286h-6v-105c0 -22 -31 -22 -31 0v114c0 24 19 48 47 48h37h37z",fillColor:"#000",fillOpacity:.9,anchor:new google.maps.Point(0,0),strokeWeight:0,scale:.08,rotation:180};!s.isDriver,u.child(N.zone_id+"/queue/"+N.sent_to).once("value",function(o){if(o.exists()){var n=o.val().pic;i=new google.maps.LatLng(o.val().lat,o.val().lon)}else var n=t.replace("/api/","/assets/")+"img/markers/transportation/town_car.png";var n=t.replace("/api/","/assets/")+"img/markers/transportation/town_car.png",a={url:n,scaledSize:new google.maps.Size(21,34),size:{width:21,height:34}};"receipt"!=N.status&&"rate"!=N.status&&(N.isCustomer?e.addMarker({lat:o.val().lat,lon:o.val().lon,icon:a},function(e){I=e}):e.addMarker({lat:E.lat,lon:E.lon,icon:a},function(e){w=e}))}),e.addMarker({lat:N.pickup_lat,lon:N.pickup_lon,icon:"./img/markerA.png"},function(e){R=e}),e.addMarker({lat:N.dropoff_lat,lon:N.dropoff_lon,icon:"./img/markerB.png"},function(e){C=e});new google.maps.InfoWindow({content:N.pickup}),new google.maps.InfoWindow({content:N.dropoff}),new google.maps.InfoWindow({content:"Driver"});ee(N.status),f(function(){E.setMap()},2e3)})};var Y=function(){return void h.setZoomLevel()};h.centerFitBound=function(){E.map&&Y()};var W,K,Q=function(e,t,o,i){J||a.fitBounds(e,t,o,i)};h.setZoomLevel=function(){if(N&&N.status)if("unload"==N.status||"receipt"==N.status||"rating"==N.status)f(function(){if(ionic.Platform.isWebView())var e=[new plugin.google.maps.LatLng(N.pickup_lat,E.detail.pickup_lon),new plugin.google.maps.LatLng(N.dropoff_lat,E.detail.dropoff_lon)];Q([new google.maps.LatLng(N.dropoff_lat,N.dropoff_lon),new google.maps.LatLng(N.pickup_lat,N.pickup_lon)],E.map,null,e)});else if(ionic.Platform.isWebView()){if("accept"==N.status||"arrived"==N.status)var e=[new plugin.google.maps.LatLng(N.pickup_lat,E.detail.pickup_lon),new plugin.google.maps.LatLng(E.detail.driver_lat,E.detail.driver_lon)];else var e=[new plugin.google.maps.LatLng(E.detail.driver_lat,E.detail.driver_lon),new plugin.google.maps.LatLng(N.dropoff_lat,E.detail.dropoff_lon)];e=e.concat(X),Q(null,null,null,e)}else L&&(W=f(function(e){E.map&&e.other&&(!e.center||E.map.getCenter().lat()==e.center.lat()&&E.map.getCenter().lng()==e.center.lng()||(E.map.panTo(e.center),K=f(function(t){e.other.concat(X).forEach(function(e){
t.extend(e)});var o=S.getBoundsZoomLevel(null,$(E.map.getDiv()),t);E.map.setZoom(o),S.marginZoom(E.map,e.other.concat(X)),google.maps.event.trigger(E.map,"resize")},200,null,S.getBoundsFromZoom(E.map,S.getBoundsZoomLevel(e.other.concat(X),$("#tripmap, #receiptmap, #ratingmap"))))))},0,!0,h.getLatLons()))},h.centerMap=function(){L=!0;var e=h.getLatLons();!e.center||E.map.getCenter().lat()==e.center.lat()&&E.map.getCenter().lng()==e.center.lng()||E.map.panTo(e.center),h.setZoomLevel()},h.getLatLons=function(){if(N&&N.status){var e,t;"accept"==N.status||"arrived"==N.status?(e=new google.maps.LatLng(N.pickup_lat,N.pickup_lon),t=[e]):"load"==N.status&&(e=new google.maps.LatLng(N.dropoff_lat,N.dropoff_lon),t=[e]);var o=N.driver_lat||E.detail.driver_lat,i=N.driver_lon||E.detail.driver_lon;return e&&o&&i&&t.push(new google.maps.LatLng(o,i)),{center:e,other:t}}};var Z=function(e){h.centerFitBound()},J=!1,X=[];E.showInstructions=!1;var ee=function(t){if(void 0!=E.map&&E.detail&&"receipt"!=t&&"rate"!=t&&"cancelled"!=t){var o,i;switch(t){case"accept":o=new google.maps.LatLng(E.detail.driver_lat,E.detail.driver_lon),i=new google.maps.LatLng(N.pickup_lat,N.pickup_lon);break;case"arrived":o=new google.maps.LatLng(E.detail.driver_lat,E.detail.driver_lon),i=new google.maps.LatLng(N.pickup_lat,N.pickup_lon);break;case"load":o=new google.maps.LatLng(N.pickup_lat,N.pickup_lon),i=new google.maps.LatLng(N.dropoff_lat,N.dropoff_lon);break;case"unload":o=new google.maps.LatLng(N.pickup_lat,N.pickup_lon),i=new google.maps.LatLng(N.dropoff_lat,N.dropoff_lon);break;case"receipt":o=new google.maps.LatLng(N.pickup_lat,N.pickup_lon),i=new google.maps.LatLng(N.dropoff_lat,N.dropoff_lon)}void 0==C&&ce(),E.map.directionsDisplay&&E.map.directionsDisplay.setMap(null);var n=function(){if(void 0!=o&&E.detail){var n={origin:o,destination:i,travelMode:google.maps.TravelMode.DRIVING,unitSystem:google.maps.UnitSystem.IMPERIAL};P.route(n,function(o,i){if(i==google.maps.DirectionsStatus.OK&&E.detail&&!J){E.setDirections(o);var n=o.routes[0];X.length=0,n.legs[0].steps.forEach(function(t,o){0==o&&X.push(e.getLatLon(t.start_point.lat(),t.start_point.lng())),X.push(e.getLatLon(t.end_point.lat(),t.end_point.lng()))}),Z();for(var a=0;a<n.legs.length;a++){"accept"==t||"arrived"==t?(E.$broadcast("trip:beforeArriveTime",n.legs[a].duration.text),E.$broadcast("trip:beforeArriveDist",n.legs[a].distance.text)):("load"==t||"arrived"==t)&&(E.$broadcast("trip:beforeDestTime",n.legs[a].duration.text),E.$broadcast("trip:beforeDestDist",n.legs[a].distance.text));new google.maps.LatLng(N.pickup_lat,N.pickup_lon),new google.maps.LatLng(N.dropoff_lat,N.dropoff_lon);void 0!=R&&e.updateMarker(R,{lat:N.pickup_lat,lon:N.pickup_lon}),void 0==C||"arrived"!=N.status&&"load"!=N.status||e.updateMarker(C,{lat:N.dropoff_lat,lon:N.dropoff_lon}),h.mapInstructions=n.legs[a].steps,N.isDriver&&(h.triptitle=n.legs[a].steps[0].instructions)}}})}};n()}},te=h.$on("trip:profile",function(e,t){E.profile=t,h.profile=t}),oe=function(e){S.addNotification("arrived"),m.fromTemplateUrl("modals/arrived.html",{scope:h}).then(function(t){S.getAllDrivers()[e.zone_id]&&S.getAllDrivers()[e.zone_id][e.sent_to]?e.first_name=S.getAllDrivers()[e.zone_id][e.sent_to].first_name:u.child(e.zone_id+"/queue/"+e.sent_to).once("value",function(t){t.exists()&&(e.first_name=t.val().first_name)}),t.tripData=e,E.arrivedModal=t,h.msgArrivedNotSelected=!0,h.otherArrivedSelected=!0,t.show()})};h.arrivedmsg={};var ie=["MESSAGE_ARRIVED1","MESSAGE_ARRIVED2","MESSAGE_ARRIVED3","MESSAGE_ARRIVED4","MESSAGE_ARRIVED5","CUSTOM_MESSAGE"];l(ie).then(function(e){h.arrivedmsgs=[],ie.forEach(function(t,o){h.arrivedmsgs.push({text:e[t],val:e[t]})})}),h.msgArrivedNotSelected=!0,h.otherArrivedSelected=!0;var ne=h.$watch("arrivedmsg.default",function(e,t,o){h.arrivedmsgs&&e==h.arrivedmsgs[h.arrivedmsgs.length-1].text?(S.isRinging()&&S.ringTone(),h.otherArrivedSelected=!1,h.msgArrivedNotSelected=!0):void 0!=e&&(S.isRinging()&&S.ringTone(),h.otherArrivedSelected=!0,h.msgArrivedNotSelected=!1)}),ae=h.$watch("arrivedmsg.other",function(e,t,o){void 0==e?h.msgArrivedNotSelected=!0:""!=e.trim()&&(h.msgArrivedNotSelected=!1)});h.arrivedloadunload="ARRIVED",h.removeArrived=function(){if(null!=E.arrivedModal){S.isRinging()&&S.ringTone();var e=E.arrivedModal.tripData;E.$broadcast("loading:show");var t=void 0==h.arrivedmsg.other?h.arrivedmsg["default"]:h.arrivedmsg.other,o={zone_id:e.zone_id,quote_id:e.id,tripID:e.tripID,msg:t,status:5};S.trip(o).then(function(e){null!=E.arrivedModal&&(E.arrivedModal.remove(),E.arrivedModal=null,be=!1,S.processFirebase()),E.$broadcast("loading:hide")})}},h.showLargImage=function(){h.allImages=[{src:h.driveInfo.pic}],h.activeSlide=0,h.showModal("popovers/image-popover.html")},h.showModal=function(e){m.fromTemplateUrl(e,{scope:h,animation:"slide-in-up"}).then(function(e){h.fullSizeImageModal=e,h.fullSizeImageModal.show()})},h.closeModal=function(){h.fullSizeImageModal.hide(),h.fullSizeImageModal.remove()},h.trip={};var re=function(o){try{E.detail.driver_lat=o.val().lat,E.detail.driver_lon=o.val().lon;o.val().pic,new google.maps.LatLng(o.val().lat,o.val().lon),[o.val().lat,o.val().lon];if(h.driveInfo=o.val(),h.driveInfo.pic==t.replace("/api/","/assets/")+"img/markers/transportation/town_car.png"&&(h.driveInfo.pic="img/person.jpg"),N.isCustomer&&void 0!==I?e.updateMarker(I,{lat:o.val().lat,lon:o.val().lon}):N.isCustomer||void 0===w||e.updateMarker(w,{lat:o.val().lat,lon:o.val().lon}),ee(A),"accept"==A){var i=S.getGPSDistance(o.val().lat,o.val().lon,N.pickup_lat,N.pickup_lon)<r.arriveBtnDisabledMiles;N.isDriver&&h.prodMode&&i&&!de&&pe({zone_id:N.zone_id,quote_id:N.id,tripID:N.tripID,msg:"Arrived",status:5},"Arrived")}if("load"==A&&S.getGPSDistance(o.val().lat,o.val().lon,N.dropoff_lat,N.dropoff_lon)<r.arriveBtnDisabledMiles&&(h.disableArrive=!1),N.isDriver)if(s.tripPath||(s.tripPath={}),s.tripPath.hasOwnProperty(N.tripID)){var n=s.tripPath[N.tripID],a=+Object.keys(n)[Object.keys(n).length-1],l=n[a];(l.lat!=o.val().lat||l.lon!=o.val().lon)&&(n[a+1]={lat:o.val().lat,lon:o.val().lon})}else s.tripPath[N.tripID]={0:{lat:o.val().lat,lon:o.val().lon}}}catch(c){}};h.disableCancelTrip=!1;var le,se,ce=function(){},de=!1,pe=function(e,t){de=!0,e.isDriver=s.tripDetail.isDriver,E.showLoader=!0,S.trip(e).then(function(e){E.$broadcast("loading:hide",!0),"Arrived"==t?(h.arrivedloadunload="PICK_UP",ee("arrived"),N.isDriver&&l("CUSTOMER_NOTIFIED").then(function(e){o.info(e)})):"Load Trip"==t?(ee("load"),h.disableCancelTrip=!0,h.arrivedloadunload="DROP_OFF",S.startTrackingTrip(),S.setTripInterval()):"UnLoad Trip"==t?S.stopTrackingTrip():"Payment Receipt"==t?h.hideReceiptModal():"Cancel Trip"==t?(S.removeModalPopup(E,"cancelTripModal"),S.endTrip(N.id)):"Send Message"==t&&(E.messageModal.remove(),E.messageModal=null,h.cancel={},h.msgNotSelected=!0,h.otherMsgSelected=!0)},function(e){E.$broadcast("loading:hide"),l(["SOMETHING_WRONG","FAILED"]).then(function(e){c.alert({title:e.FAILED,template:e.SOMETHING_WRONG})})})["finally"](function(){de=!1})},ue=function(e,t,o,i,n){E.$broadcast("setmapclick",!1),l([e,t,"YES","NO"]).then(function(a){var r=c.confirm({title:a[t],template:a[e],cssClass:"logoutAlert",buttons:[{text:a.NO,onTap:function(e){o.message=i}},{text:a.YES}]});r.then(function(e){r.close(),E.$broadcast("setmapclick",!0),n&&n()})})};h.tripStatus=function(e){switch(e){case"ARRIVED":pe({zone_id:N.zone_id,quote_id:N.id,tripID:N.tripID,msg:"Arrived",status:5},"Arrived");break;case"PICK_UP":le={zone_id:N.zone_id,quote_id:N.id,tripID:N.tripID,status:6,message:""};var t=moment(N.selectTime,"MM/DD/YY hh:mm a");if(S.getGPSDistance(N.pickup_lat,N.pickup_lon,E.lat,E.lon)>.5){var o=function(){E.$broadcast("loading:show"),pe(le,"Load Trip")};t.diff(moment(),"minutes")>5&&(o=function(){var e="address"==le.message?"address,time":"time";ue("TIME_CORRECT","CONFIRM",le,e,function(){E.$broadcast("loading:show"),pe(le,"Load Trip")})}),ue("PICKUP_CORRECT","CONFIRM",le,"address",o)}else t.diff(moment(),"minutes")>5?ue("TIME_CORRECT","CONFIRM",le,"time",function(){E.$broadcast("loading:show"),pe(le,"Load Trip")}):(E.$broadcast("loading:show"),pe(le,"Load Trip"));break;case"DROP_OFF":se={zone_id:N.zone_id,quote_id:N.id,tripID:N.tripID,status:7,message:""},S.getGPSDistance(N.dropoff_lat,N.dropoff_lon,E.lat,E.lon)>.5?ue("DROPOFF_CORRECT","CONFIRM",se,"address",function(){E.$broadcast("loading:show"),pe(se,"UnLoad Trip")}):(E.$broadcast("loading:show"),pe(se,"UnLoad Trip"))}},h.receipt=function(){var e=[],t=0;h.receiptmsgs.forEach(function(o,i){o.checked&&(t++,i==h.receiptmsgs.length-1?!h.otherReceiptSelected&&h.receiptmsg.other&&e.push(t+". "+h.receiptmsg.other):e.push(t+". "+o.text))}),e=e.join(" "),0!=e.length&&pe({zone_id:N.zone_id,quote_id:N.id,tripID:N.tripID,msg:e,status:8},"Payment Receipt")},h.sendMessage=function(e){if(h.otherMsgSelected||(e.$submitted=!0),h.otherMsgSelected||e.$valid){var t=h.otherMsgSelected?h.tripmsg["default"]:h.tripmsg.other;pe({zone_id:N.zone_id,quote_id:N.id,tripID:N.tripID,msg:t,status:0},"Send Message")}},h.msgNotSelected=!0,h.otherMsgSelected=!0,h.sendMessageModal=function(){E.popoverMenu.hide(),m.fromTemplateUrl("modals/trip-message.html",{zone_id:N.zone_id,quote_id:N.id,tripID:N.tripID,scope:h}).then(function(e){E.messageModal=e,h.tripmsg={},h.msgNotSelected=!0,h.otherMsgSelected=!0,e.show()})};var me=h.$watch("tripmsg.default",function(e,t,o){h.tripmsgs&&e==h.tripmsgs[h.tripmsgs.length-1].text?(h.otherMsgSelected=!1,h.msgNotSelected=!0,n.resize()):void 0!=e&&(h.otherMsgSelected=!0,h.msgNotSelected=!1,n.resize())}),ge=h.$watch("tripmsg.other",function(e,t,o){void 0==e?h.msgNotSelected=!0:""!=e.trim()&&(h.msgNotSelected=!1)}),fe=h.$on("trip:beforeArriveTime",function(e,t){h.tripTime=t,h.triptext="FROM_PICKUP"}),ve=h.$on("trip:beforeArriveDist",function(e,t){h.tripDistance=t}),he=h.$on("trip:beforeDestTime",function(e,t){h.tripTime=t,h.triptext="FROM_DROPOFF"}),_e=h.$on("trip:beforeDestDist",function(e,t){h.tripDistance=t}),Ee=h.$on("trip:distRem",function(e,t){h.tripDistance=t});h.removeMessageModal=function(){E.messageModal.remove(),E.messageModal=null},h.removeCancelModal=function(){E.cancelTripModal.remove(),E.cancelTripModal=null},h.reasonNotSelected=!0,h.otherSelected=!0,h.showCancelTripModal=function(){E.popoverMenu.hide(),m.fromTemplateUrl("modals/trip-cancel.html",{zone_id:N.zone_id,quote_id:N.id,tripID:N.tripID,scope:h}).then(function(e){h.cancel={},h.reasonNotSelected=!0,h.otherSelected=!0,E.cancelTripModal=e,e.show()})};var Se=h.$watch("cancel.default",function(e,t,o){h.cancelreasons&&e==h.cancelreasons[h.cancelreasons.length-1].text?(h.otherSelected=!1,h.reasonNotSelected=!0,n.resize()):void 0!=e&&(h.otherSelected=!0,h.reasonNotSelected=!1,n.resize())}),De=h.$watch("cancel.other",function(e,t,o){void 0==e?h.reasonNotSelected=!0:""!=e.trim()&&(h.reasonNotSelected=!1)});void 0!=E.cancelTripModal,h.cancelTap=function(e){if(h.otherSelected||(e.$submitted=!0),h.otherSelected||e.$valid){var t=h.otherSelected?h.cancel["default"]:h.cancel.other;pe({zone_id:N.zone_id,quote_id:N.id,tripID:N.tripID,msg:t,status:-5,inbox:[N]},"Cancel Trip")}};var ye,Me=function(){h.openDetail=function(e){"IMG"!==e.target.nodeName&&(h.isAccordToggled=!h.isAccordToggled,E.$broadcast("setmapclick",!h.isAccordToggled))},h.max=5;var e=null,t=[];if(h.setRating=function(){for(var e=0,t=0;t<h.ratingChkboxes.length;t++)h.ratingChkboxes[t].isChecked&&e++;f(function(){h.rate=e})},h.name==s.name&&(h.name=""),N.isCustomer)var i=N.sent_to;else var i=N.reply_to;ye||S.profile(i).then(function(e){h.name=e.description,ye=e});(function(){var t=N.isCustomer;if(e=S.getRating(N.zone_id,N.id),E.$broadcast("loading:hide"),t)var o=["RATE_DRIVER1","RATE_DRIVER2","RATE_DRIVER3","RATE_DRIVER4","RATE_DRIVER5"];else var o=["RATE_CUSTOMER1","RATE_CUSTOMER2","RATE_CUSTOMER3","RATE_CUSTOMER4","RATE_CUSTOMER5"];l(o).then(function(i){var n=[{"class":"ion-clock",text:i[o[0]],isChecked:t?e.time:e.ontime,calculated:!0},{"class":t?"ion-speedometer":"icon-pick",text:i[o[1]],isChecked:t?e.speed:e.pickup,calculated:!0},{"class":t?"ion-arrow-graph-up-right":"icon-drop",text:i[o[2]],isChecked:t?e.distance:e.dropoff,calculated:!0},{"class":t?"icon-driver":"ion-ios-locked",text:i[o[3]],isChecked:!0,calculated:!1},{"class":t?"ion-waterdrop":"ion-thumbsup",text:i[o[4]],isChecked:!0,calculated:!1}];h.ratingChkboxes=n,h.setRating()})})();if(N){var n=["TRIP_INFO","PAYMENT_METHOD","PRICE","PICKUP","DROPOFF","SERVICE","SEATS","ROUTE","DATE_TIME","MILES"];l(n).then(function(e){h.accordion={},h.ratingitems=[{label:e.PAYMENT_METHOD,text:N.paymentMethod},{label:e.PICKUP,text:N.pickup},{label:e.DROPOFF,text:N.dropoff},{label:e.SERVICE,text:N.selectService},{label:e.SEATS,text:N.selectPeople},{label:e.ROUTE,text:N.route_distance+" "+e.MILES},{label:e.DATE_TIME,text:N.selectDate+" "+N.selectTime}],h.accordion.heading=e.TRIP_INFO})}var a,r=function(){S.trip({isDriver:N.isDriver,zone_id:N.zone_id,quote_id:N.id,tripID:N.tripID,msg:t,status:9}).then(function(e){S.removeModalPopup(E,"ratingModal"),o.clear(),N.isDriver||S.endTrip(N.id),E.$broadcast("loading:hide")},function(e){m()})},d=function(){ye?p(ye):S.profile(N.sent_to).then(function(e){p(e)},function(){m()})},p=function(e){S.addDispatcherItem({category_id:v,name:e.description,email:e.email,cellPhone:e.phone,active:1,itemType:"Driver"}).then(function(){r(),S.setMyA2BerDrivers()},function(){m()})},u=function(){S.deleteDispatcherItem({category_id:v,item_id:a}).then(function(){r()},function(){m()})},m=function(){E.$broadcast("loading:hide"),l(["SOMETHING_WRONG","FAILED"]).then(function(e){c.alert({title:e.FAILED,template:e.SOMETHING_WRONG})})},g=function(e){S.itemsApi("&category_id[]="+v).then(function(t){var o;t.items.some(function(e){return e.apikeypublic==N.sent_to&&(a=e.item_id,o=e.apikeypublic),o}),e&&!o?d():!e&&o?u():r()},function(){m()})},v=S.getFavGroupId(),_=!1,D=!1;h.sendRating=function(){E.$broadcast("loading:show");for(var e=0,o=0;o<h.ratingChkboxes.length;o++)h.ratingChkboxes[o].isChecked&&e++,t.push("message[]="+(h.ratingChkboxes[o].isChecked?1:0));if(N.isDriver)r();else{var i;for(var o in N.sent_to_message)if("receipt"==N.sent_to_message[o].status){i=N.sent_to_message[o].message;break}var n=["RECEIPT_CUSTOMER1","RECEIPT_CUSTOMER2","RECEIPT_CUSTOMER3","RECEIPT_CUSTOMER4","RECEIPT_CUSTOMER5"];l(n).then(function(t){n.some(function(e,o){return i.indexOf(t[e])>-1&&2==o?D=!0:i.indexOf(t[e])>-1&&3==o?_=!0:void 0}),v&&_?g(!1):5==e||D?v?g(!0):S.addGroup({name:"My A2Bers",active:1,offer:0,allow_remote_reservation:0,allow_advance_reservation:0,jail:0,services:[],tags:[]},!0).then(function(e){v=e.group_id,d()}):r()})}}},Te=function(){"rating"!=h.showing&&(h.showing="rating",E.mapid="ratingmap",E.setMapClass("tripmapp ratingmap"),h.isDriver=N.isDriver,Me(),h.isAccordToggled=!0,f(function(){h.setZoomLevel(),google.maps.event.trigger(E.map,"resize")}))};h.$on("trip:msg",function(e){h.showChatModal()});h.showChatModal=function(){m.fromTemplateUrl("modals/chat.html",{apikey:N.isDriver?N.reply_to:N.sent_to,zone_id:N.group_id,name:ye&&ye.description,inbox_id:N.id,scope:h}).then(function(e){void 0!=E.chatModal&&null!=E.chatModal&&E.chatModal.isShown()||(E.chatModal=e,e.show())})},h.removeChatModal=function(){S.removeModalPopup(E,"chatModal")},h.hideReceiptModal=function(){s.tripDetail&&Te(),S.removeModalPopup(E,"receiptModal")};var ke=h.$on("trip:unloaded",function(e){$e()}),Ie=h.$on("trip:receiptsent",function(e){Te()}),be=!1,Ce=h.$on("trip:arrived",function(e,t){be||(be=!0,oe(t),S.stopTrackingBefore())});h.receiptNotSelected=!1,h.otherReceiptSelected=!0;var we=h.$watch("receiptmsg.default",function(e,t,o){h.receiptmsgs&&e==h.receiptmsgs[h.receiptmsgs.length-1].text?(h.otherReceiptSelected=!1,h.receiptNotSelected=!0,f(function(){var e=_.find(n._instances,function(e){return"scroll"===e.$$delegateHandle});e.scrollBottom()})):void 0!=e&&(h.otherReceiptSelected=!0,h.receiptNotSelected=!1)}),Re=h.$watch("receiptmsg.other",function(e,t,o){void 0==e?h.receiptNotSelected=h.receiptmsgs&&0==h.receiptmsgs.filter(function(e,t,o){return t!=o.length-1&&e.checked}).length:""!=e.trim()&&(h.receiptNotSelected=!1)});h.receiptChecked=function(e,t){e==h.receiptmsgs.length-1&&(t?(h.otherReceiptSelected=!1,f(function(){var e=_.find(n._instances,function(e){return"receiptListScroll"===e.$$delegateHandle});e.scrollBottom()}),n.resize()):(h.otherReceiptSelected=!0,n.resize())),!N.isDriver&&t&&(2==e&&h.receiptmsgs[3].checked?h.receiptmsgs[3].checked=!1:3==e&&h.receiptmsgs[2].checked&&(h.receiptmsgs[2].checked=!1)),h.receiptNotSelected=0==h.receiptmsgs.filter(function(e,t,o){var i;return i=t==o.length-1&&e.checked?h.receiptmsg.other&&""!=h.receiptmsg.other.trim():e.checked}).length},h.showTripDetail(),h.showing="trip",E.mapid="tripmap";var $e=function(){if("receipt"!=h.showing&&(h.showing="receipt",E.mapid="receiptmap",E.setMapClass("tripmapp receiptmap"),h.isDriver=N.isDriver,h.isReceiptToggled=!0,E.$broadcast("setmapclick",!1),!E.receiptModal)){if(f(function(){h.setZoomLevel(),google.maps.event.trigger(E.map,"resize")}),E.receiptModal=!0,E.detail.isCustomer)var e=["RECEIPT_CUSTOMER1","RECEIPT_CUSTOMER2","RECEIPT_CUSTOMER3","RECEIPT_CUSTOMER4","RECEIPT_CUSTOMER5"];else var e=["RECEIPT_DRIVER1","RECEIPT_DRIVER2","RECEIPT_DRIVER3","RECEIPT_DRIVER4","RECEIPT_DRIVER5"];f(function(){var t=S.getRating(s.tripDetail.zone_id,s.tripDetail.id);l(e).then(function(o){h.receiptmsgs=[],h.receiptmsg={},e.forEach(function(e,i){h.receiptmsgs.push({text:o[e],val:o[e],checked:(0==i?t.time&&t.distance:!1)||(1==i?!t.time:!1)||(s.tripDetail.isDriver&&2==i?!t.distance:!1)})}),h.receiptmsg["default"]=h.receiptmsgs[0].val})},100),h.detail=E.detail,null!=E.arrivedModal&&1!=E.arrivedModal&&(E.arrivedModal.remove(),E.arrivedModal=null,S.isRinging()&&S.ringTone()),E.toastArrived&&(o.clear(E.toastArrived),E.toastArrived=null)}};g.fromTemplateUrl("popovers/trip-menu.html",{scope:h}).then(function(e){E.popoverMenu=e}),h.showSendMsg=!0,m.fromTemplateUrl("modals/order-edit.html",{scope:h}).then(function(e){h.orderModal=e,E.orderEditModal=h.orderModal}),h.openSeats=function(){f(function(){$(".ordericons").siblings("div[is-icon]").children(".ion-person-add").click()})},h.sendTripMessage=function(){E.$broadcast("loading:show"),S.trip({zone_id:N.zone_id,quote_id:N.id,tripID:N.tripID,msg:trip.msg,status:4}).then(function(e){E.$broadcast("loading:hide")})},h.showOrderModal=function(){E.popoverMenu.hide(),h.editForm=!1,h.orderModal.show()};var Oe={},Pe=function(){S.getTags().then(function(e){h.tags=e.tags;var t=S.getUniqueDrivers();originLoc="pickup"==qe?Fe:E;for(var o in t)for(var i in t[o]){var n={};return void(n[o]=t[o][i])}})},Ae=!1,Le={},Fe={},Ne=h.$on("location:searched",function(e,t){Fe=t.pickup,Ae=!0,h.setTag()}),xe=function(e,t,o){originLoc="pickup"==qe?Fe:E,void 0==h.editorder||null==t};h.setTag=function(){var e=S.setTag(Fe,h.editorder.selectService);e>0?(Le=Fe,E.$broadcast("search:location",Le)):qe=null},h.setTagMap=function(e,t,i,n){return h.services=t,h.editorder.selectedServices=h.editorder.selectService.split(","),i.length>0&&0!=h.services.length&&l(["SERVICE_REMOVED","SERVICES_NOT_AVAILABLE","SERVICE_NOT_AVAILABLE"]).then(function(e){var t=i+(i.length>1?e.SERVICES_NOT_AVAILABLE:e.SERVICE_NOT_AVAILABLE);o.info(t,e.SERVICE_REMOVED),f(function(){$("#serviceIcon ion-item").click()})}),h.totalDrivers=e,E.$broadcast("search:location",Le),Ae=!1,!0};var qe,ze=h.$on("queue:updated",xe),Ve=h.$on("queue:added",xe),Ge=h.$on("queue:removed",xe),Ue=h.$on("order:edited",function(){h.initOrder()});h.services=[],l("SELECT_SERVICE").then(function(e){h.services_text_single=e}),h.val={single:null,multiple:null},h.setServiceCheckMark=function(){h.services.forEach(function(e){e.id==h.editorder.selectService?e.checked=!0:e.checked=!1})},h.serviceSelected=function(e){if(void 0!=e){h.editorder.selectService=e.replace(/;/g,",");var t=h.driveInfo.tags.filter(function(e){return h.tags.indexOf(e)>-1});x=h.editorder.selectService.split(",").some(function(e){return t.indexOf(e)<0})}},h.saveDateTime=function(e){h.editorder.selectDate=moment(new Date(e)).format("MM/DD/YY"),h.editorder.selectTime=moment(new Date(e)).format("hh:mm a"),h.editorder.time=h.editorder.selectDate+" "+h.editorder.selectTime;var t=moment(h.editorder.time,"MM/DD/YY hh:mm a"),o=moment();x=t.diff(o,"minutes")>20},h.setCarIcon=function(){h.services.forEach(function(e){h.editorder.selectService==e.id&&(h.serviceImg=e.icon)}),0==h.services.length&&(h.serviceImg="pics/taxi.png")},h.showService=function(e){f(function(){$("#servicespanel ion-item").click()})};var Be,je;h.initOrder=function(){h.editorder=angular.copy(E.detail),h.setCarIcon(),h.editorder.time=h.editorder.selectDate+" "+h.editorder.selectTime,Be=h.editorder.pickup,je=h.editorder.dropoff,h.seatsModel={setFunc:function(e){return angular.isDefined(e)?h.editorder.selectPeople=e:h.editorder.selectPeople}},Pe()};var He,Ye=function(){var e=n._instances,t=_(e).find(function(e){return"edit-page"===e.$element[0].id});t.scrollTop(!0)};h.edit=function(){He=angular.copy(h.editorder),h.editForm=!0,Ye()},h.cancelEdit=function(){h.editorder=He,h.setCarIcon(),h.editForm=!1,Ye()},h.orderChanged=function(e){e.hasOwnProperty("pickup")&&(h.editorder.pickup_lat=e.pickup.lat,h.editorder.pickup_lon=e.pickup.lon,h.editorder.pickup=e.pickup.formatted_address),e.hasOwnProperty("dropoff")&&(h.editorder.dropoff_lat=e.dropoff.lat,h.editorder.dropoff_lon=e.dropoff.lon,h.editorder.dropoff=e.dropoff.formatted_address),e.hasOwnProperty("range")&&(h.editorder.range=e.range),e.hasOwnProperty("price")&&(h.editorder.price=e.price),e.hasOwnProperty("timezone")&&(h.editorder.timezone=h.timezone=e.timezone),We()};var We=function(){if(h.editorder.pickup!=Be||h.editorder.dropoff!=je){Be=h.editorder.pickup,je=h.editorder.dropoff;var e=new google.maps.LatLng(h.editorder.pickup_lat,h.editorder.pickup_lon),t=new google.maps.LatLng(h.editorder.dropoff_lat,h.editorder.dropoff_lon),o={origin:e,destination:t,travelMode:google.maps.TravelMode.DRIVING};P.route(o,function(e,t){if(t==google.maps.DirectionsStatus.OK)for(var o=e.routes[0],i=0;i<o.legs.length;i++)h.editorder.eta_distance=o.legs[i].distance.value/1609,h.editorder.eta_time=o.legs[i].duration.value/60,h.editorder.route_distance=(o.legs[i].distance.value/1609).toFixed(1)})}};h.save=function(){E.$broadcast("loading:show"),S.setQuoteDateTime(h.editorder);var e=u.child(N.zone_id+"/inbox/"+N.id+"/route");e.update({selectDate:h.editorder.selectDate,selectTime:h.editorder.selectTime,selectPeople:h.editorder.selectPeople,selectService:h.editorder.selectService,route_distance:h.editorder.route_distance,eta_distance:h.editorder.eta_distance,eta_time:h.editorder.eta_time,pickup:h.editorder.pickup,dropoff:h.editorder.dropoff,pickup_lat:h.editorder.pickup_lat,pickup_lon:h.editorder.pickup_lon,dropoff_lat:h.editorder.dropoff_lat,dropoff_lon:h.editorder.dropoff_lon,price:h.editorder.price,range:h.editorder.range},function(t){if(E.$broadcast("loading:hide"),t)l(["FAILED","ORDER_UPDATE_FAIL"]).then(function(e){c.alert({title:e.FAILED,template:e.ORDER_UPDATE_FAIL})});else{He=E.detail,h.cancelEdit();var o=E.detail.isCustomer?"sent_to_message":"reply_to_message",i=E.detail[o],n=parseInt(Object.keys(i)[Object.keys(i).length-1])+1,a=i;x?pe({zone_id:N.zone_id,quote_id:N.id,tripID:N.tripID,msg:"Cancelled",status:-5,inbox:[N]},"Cancel Trip"):(a[n]={lat:E.lat,lon:E.lon,update_time:moment().format("MM/DD/YY HH:mm:ss"),status:"order_edited",message:"Order Edited"},e.child(o).set(a,function(e){e||h.initOrder()}))}})};var Ke=h.$on("location:updated",function(t){void 0!=E.map&&void 0!=w&&e.updateMarker(w,{lat:E.lat,lon:E.lon})});h.$on("$ionicView.beforeLeave",function(){J=!0,E.showMenuIcon=!0,void 0!=O&&i.cancel(O),x&&E.$broadcast("resend_quote",N),N&&(u.child(N.zone_id+"/inbox/"+N.id+"/route").off("value",U),u.child(N.zone_id+"/queue/"+N.sent_to).off("value",re),k&&k.off("value",H)),Ge&&Ge(),Ve&&Ve(),ze&&ze(),Ue&&Ue(),Ce&&Ce(),ke&&ke(),Ee&&Ee(),_e&&_e(),he&&he(),ve&&ve(),fe&&fe(),B&&B(),te&&te(),V&&V(),G&&G(),Ke&&Ke(),Ne&&Ne(),Re&&Re(),we&&Re(),De&&De(),Se&&Se(),ge&&ge(),me&&me(),ae&&ae(),ne&&ae(),Ie&&Ie(),S.removeModalPopup(E,"popoverMenu"),S.removeModalPopup(E,"arrivedModal"),S.removeModalPopup(h,"seatsModal"),S.removeModalPopup(h,"orderModal"),S.removeModalPopup(h,"receiptModal"),S.removeModalPopup(h,"ratingModal"),S.removeModalPopup(h,"cancelTripModal"),S.removeModalPopup(h,"messageModal"),S.removeModalPopup(h,"instructionsModal"),S.removeModalPopup(h,"fullSizeImageModal"),ionic.Platform.isWebView()||(M&&google.maps.event.removeListener(M),T&&google.maps.event.removeListener(T),R&&R.setMap(null),C&&C.setMap(null),I&&I.setMap(null),w&&w.setMap(null),b&&b.setMap(null),E.map.directionsDisplay&&E.map.directionsDisplay.setMap(null),F.setMap(null)),E.resetMap(),E.receiptModal=null,W&&f.cancel(W),K&&f.cancel(K),h.removeChatModal();for(v in D)D[v]()})})}]).controller("JailCtrl",["$timeout","$scope","$rootScope",function(e,t,o){}]).controller("QuoteCtrl",["MapServ","$ionicScrollDelegate","ApiParamService","$ionicSideMenuDelegate","baseUrl","Initializer","Internet","$ionicPopover","AnimateMarkerService","$ionicLoading","constants","toastr","$translate","$localStorage","$filter","$ionicModal","$ionicPopup","$ionicPlatform","$rootScope","$scope","$timeout","EmployeeService",function(e,t,o,i,n,a,r,l,s,c,d,p,u,m,g,f,h,_,E,S,D,y){S.map={},S.$on("$ionicView.afterEnter",function(o,r){E.setMapClass("quotemap"),S.view_loaded=!0;var g=E.$watch("quoteQMode",function(e,t){e!=t&&(m.quoteQMode=E.quoteQMode,S.serviceSelected())});i.canDragContent(!1);S.mypic=m.picData,S.myrating=5,S.popoverDiscount=l.fromTemplate(['<ion-popover-view style="height: 50px;">',"<ion-content>",'<div id="discount" class="item-input-inset search-bar">','<label class="item-input-wrapper">','<i class="icon ion-ios7-search placeholder-icon"></i>','<input id="searchKey" type="search" placeholder="{{ \'DISCOUNT_CODE\' | translate }}" ng-model="coupon" autocorrect="off">',"</label>",'<span ng-click="setDiscountCode(coupon)" ng-class="(coupon.length > 0) ? \'ion-checkmark\' : \'\'" class="button button-clear ft25"></span>',"</div>","<div id=\"discount\" style=\"margin:10px\" ng-if=\"!validCoupon\" class=\"form-errors\" ng-messages=\"{'incorrect_code': invalid_reason == 'code', 'no_drivers': invalid_reason == 'driver', 'not_in_range': invalid_reason == 'range'}\">","<div class=\"form-error\" ng-message-exp=\"['incorrect_code']\">{{'INVALID_COUPON'|translate}}</div>","<div class=\"form-error\" ng-message-exp=\"['no_drivers']\">{{'COUPON_NO_DRIVERS'|translate}}</div>","<div class=\"form-error\" ng-message-exp=\"['not_in_range']\">{{'COUPON_NOT_IN_RANGE'|translate}}</div>","</div>","</ion-content>","</ion-popover-view>"].join(""),{scope:S});var M,T=!1;S.validCoupon=!0;var k=E.$on("search:location",function(e,t){T&&(T=!1,t&&t.coupon?(E.$broadcast("validcoupon",M),E.$broadcast("loading:hide"),S.popoverDiscount.hide(),S.validCoupon=!0):(S.invalid_reason="driver",S.validCoupon=!1,E.$broadcast("loading:hide")))});S.setDiscountCode=function(e){"NO_DRIVER"!=S.quoteBtnText&&(E.$broadcast("loading:show",{text:"VALIDATING_COUPON"}),y.coupon(e).then(function(e){"Success"==e.status?(M=JSON.parse(e.data.settings),y.getGPSDistance(M.pickup_lat,M.pickup_lon,E.lat,E.lon)>1?(S.invalid_reason="range",S.validCoupon=!1,E.$broadcast("loading:hide")):(T=!0,E.$broadcast("location:searched",{pickup:{lat:M.pickup_lat,lon:M.pickup_lon,coupon:!0}}))):(S.invalid_reason="code",S.validCoupon=!1,E.$broadcast("loading:hide"))}),S.quoteForm.coupon=e)},S.rangeAvailable=!1,S.emptyQueue=!1,S.quoteForm={},S.quoteForm.pickup={},S.setEmptyQueue=function(e){S.emptyQueue!=e&&(S.emptyQueue=e,e?$("#quotemap").css({opacity:0,zoom:0}):$("#quotemap").css({opacity:1,zoom:1}))},S.quoteBtnText="NO_DRIVER";var I,b,C,w,R,O=S.$watch("quoteBtnText",function(t,o,i){e.refresh()}),P=!1;S.pickupSelected=!1;var A,L=!0,F=null,N=!1,x=!1,q=function(){F=y.pickupCenterZone(S.quoteForm.pickup.lat,S.quoteForm.pickup.lon),N=F};S.changed=function(e){e&&(e.hasOwnProperty("pickup")&&(Y=!0,S.quoteForm.pickup=e.pickup,q()),e.hasOwnProperty("dropoff")&&(W=!0,S.quoteForm.dropoff=e.dropoff),e.hasOwnProperty("range")&&(S.quoteForm.range=e.range),e.hasOwnProperty("price")&&(S.quoteForm.price=e.price),y.getTimeZone(e.pickup.lat,e.pickup.lon).then(function(e){S.timezone=e.timeZoneId})),void 0!=S.quoteForm.pickup&&(P=!0,I="pickup",te=!0,oe=S.quoteForm.pickup),Z(),H?0==S.quoteForm.service.length&&(S.quoteBtnText="SELECT_SERVICE"):S.quoteBtnText="SET_A_B";var t=y.getTagsDriverMap();for(var o in t)t[o]={};S.services.length=0,ce.length=0,S.serviceSelected()},S.pickupChanged=function(){Y=!0,S.changed()},S.dropoffChanged=function(){W=!0,S.changed()};var z,V,G,U,B,j=[],H=!1,Y=!1,W=!1,K=!1,Q=!1,Z=function(){if(null!=I&&(Y||W)&&(S.quoteForm.pickup!=b||S.quoteForm.dropoff!=C)){H=!0,S.detailsNotFilled=!1,b=S.quoteForm.pickup,C=S.quoteForm.dropoff,z=e.getLatLon(S.quoteForm.pickup.lat,S.quoteForm.pickup.lon),V=e.getLatLon(S.quoteForm.dropoff.lat,S.quoteForm.dropoff.lon);var t={origin:z,destination:V,travelMode:google.maps.TravelMode.DRIVING};R.route(t,function(e,t){if(t==google.maps.DirectionsStatus.OK){for(var o=e.routes[0],i=0;i<o.legs.length;i++)S.estDist=(o.legs[i].distance.value/1609).toFixed(1),S.estTime=o.legs[i].duration.text,S.quoteForm.estDistVal=o.legs[i].distance.value/1609,S.quoteForm.estTimeVal=o.legs[i].duration.value/60,S.pickupSelected=!0,S.quoteForm.distance=S.estDist,0!=S.quoteForm.service.length&&A&&(S.quoteBtnText="REVIEW");s.fitBounds([z,V],E.map,null,[z,V]),K=!1,Q=!1}})}};S.totalDrivers=0;var P=!1,J={},X={},ee=function(e,t,o){null!=t&&(X="pickup"==I?oe:E,y.setTagMap(o,t,X,S.services,ce,S.quoteForm.service,function(e,t,o,i,n,a,r,l){S.setTagMap(e,t,o,i,n,a,r,l)},ae,null,null,!0,S.quoteForm.range,F))},te=!1,oe={},ie=S.$on("location:searched",function(e,t){oe=t.pickup,te=!0,S.setTag()}),ne=S.$on("resend_quote",function(e,t){S.quoteForm.splitFare=["splitFare[]="],S.quoteForm.date=t.selectDate,S.quoteForm.time=t.selectTime,S.quoteForm.service=t.selectService,S.quoteForm.people=t.selectPeople,S.quoteForm.distance=t.route_distance,S.quoteForm.estDistVal=t.eta_distance,S.quoteForm.estTimeVal=t.eta_time,S.quoteForm.note=t.note.join(","),S.quoteForm.pickup={},S.quoteForm.pickup.formatted_address=t.pickup,S.quoteForm.pickup.lat=t.pickup_lat,S.quoteForm.pickup.lon=t.pickup_lon,S.quoteForm.dropoff={},S.quoteForm.dropoff.formatted_address=t.dropoff,S.quoteForm.dropoff.lat=t.dropoff_lat,S.quoteForm.dropoff.lon=t.dropoff_lon,S.totalDrivers>0?(S.sendQuote(!0),$e(),p.info("Resending Quote","QUOTE")):(E.$broadcast("loading:hide"),p.info("No Driver","NO DRIVER"))});S.quoteForm.services=[];var ae={nearestDriverDist:12e3,furthestDriverDist:0,nearestDriverTime:1e4,furthestDriverTime:0},ae={};S.detailsNotFilled=!0,S.openService=function(){D(function(){$("#serviceIcon ion-item").trigger("click")})};var re=["NOTES_DRIVER1","NOTES_DRIVER2","NOTES_DRIVER3","NOTES_DRIVER4","NOTES_DRIVER5"];u(re).then(function(e){S.notess=[],S.translatedText={},re.forEach(function(t,o){S.notess.push({text:e[t],checked:!1}),S.translatedText[t]=e[t]})}),S.noteChecked=function(e){var o;S.notes.forEach(function(e){e.checked&&(o=e)}),void 0!=o?o==e?e.checked=!e.checked:(o.checked=!1,e.checked=!0):e.checked=!0,e.text==S.translatedText.NOTES_DRIVER5?(S.otherNoteSelected=!1,D(function(){$("textarea").focus()})):S.otherNoteSelected=!0,t.resize()};var le=e.mapClickableSetter(S);S.openInstructions=function(){if(S.notes=angular.copy(S.notess),null!=S.instructionsModal)return void S.instructionsModal.show();f.fromTemplateUrl("modals/quote-note.html",{scope:S,animation:"slide-in-up",backdropClickToClose:!1}).then(function(e){S.otherNoteSelected=!0,S.quotenote={},S.instructionsModal=e,e.show()})},S.quoteForm.note="",S.saveInstructions=function(){S.quoteForm.note="",S.notess=angular.copy(S.notes),S.notes.forEach(function(e){e.checked&&(e.text==S.translatedText.NOTES_DRIVER5?S.quoteForm.note=S.quotenote.other:S.quoteForm.note=e.text);
}),S.instructionsModal.hide()},D(function(){E.lat&&y.getTags().then(function(e){S.tags=e.tags,S.serviceSelected(),y.isInitializingFB()||(S.driversInspected=!0)})},100);var se=S.$on("trip:ended",function(){S.serviceSelected(),D(function(){S.serviceSelected()},2e3)});S.services=[];var ce=[];u("SELECT_SERVICE").then(function(e){S.services_text_single=e}),S.val={single:null,multiple:null},S.setServiceCheckMark=function(){S.services.forEach(function(e){e.id==S.quoteForm.service?e.checked=!0:e.checked=!1})},S.quoteForm.service=null,S.setCarIcon=function(){S.services.forEach(function(e){S.quoteForm.service==e.id&&(S.serviceImg=e.icon)}),null==S.quoteForm.service&&S.services.length>0&&(S.serviceImg=S.services[0].icon),0==S.services.length&&(S.serviceImg="pics/taxi.png")},S.setCarIcon(),S.showService=function(){S.setServiceCheckMark()},S.setTag=function(){var e=y.setTag(oe,S.quoteForm.service);if(J=oe,e>0)E.$broadcast("search:location",J);else{var t=!1,o=y.getDispatcherGroups().length>0,i=y.getGlobalGroups();i.some(function(e){return t=y.withinZone(e,!1,J.lat,J.lon)}),t&&o?E.$broadcast("search:location",J):(P=!1,u(["SORRY","NO_DRIVERS_PICKUP","NO_DRIVERS_AREA"]).then(function(e){var o=t?e.NO_DRIVERS_AREA:e.NO_DRIVERS_PICKUP;s.setStopMovingMarker(!1),te&&(p.error(o,e.SORRY),E.$broadcast("search:location",null),te=!1)}),I=null)}},S.centerMap=function(e,t){L=!0;var o=e||E.lat,i=t||E.lon;new google.maps.LatLng(o,i);E.centerMap(e,t)};var de=S.$on("fb:initialized",function(e,t){S.serviceSelected(),S.driversInspected=!0}),pe=S.$on("groups_set",function(e,t){S.serviceSelected()});S.allow_advance_reservation=E.allow_advance_reservation,S.allow_remote_reservation=E.allow_remote_reservation,S.setTagMap=function(e,t,o,i,n,a,r,l){if(r&&(r.allow_advance_reservation&&(S.allow_advance_reservation=Math.max(S.allow_advance_reservation,r.allow_advance_reservation)),r.allow_remote_reservation&&(S.allow_remote_reservation=Math.max(S.allow_remote_reservation,r.allow_remote_reservation))),S.driversInspected=!0,S.services=t,S.servicesDetail=y.getTagsDriverMap(),Object.keys(i).length>0&&(ae=i,S.rangeAvailable=!0,S.nearestTime=i.nearestDriverTime,S.furthestTime=i.furthestDriverTime),o.length>0&&""!=S.quoteForm.service&&S.services.length>0&&u(["SERVICE_REMOVED","SERVICES_NOT_AVAILABLE","SERVICE_NOT_AVAILABLE"]).then(function(e){var t=o+(o.length>1?e.SERVICES_NOT_AVAILABLE:e.SERVICE_NOT_AVAILABLE);p.info(t,e.SERVICE_REMOVED),S.services.length>1&&(S.alertPopup&&S.alertPopup.hide(),D(function(){$("#serviceIcon ion-item").click()}))}),S.totalDrivers=e,void 0!=a&&(E.driversAvailable=a),0!=S.totalDrivers||H){if(!n)return!F&&N&&l&&(q(),S.serviceSelected()),te?(E.$broadcast("search:location",J),te=!1):Z(),H?S.quoteForm.range||(S.quoteBtnText="SET_RANGE"):S.quoteBtnText="SET_A_B",H&&S.quoteForm.range&&!A&&(1==S.services.length?(S.quoteForm.service=S.services[0].text,S.quoteBtnText="REVIEW",A=!0):S.services.length>1&&(S.quoteBtnText="SELECT_SERVICE")),void 0!=z&&(j[0]=z,j[1]=V),!0;S.quoteBtnText="SET_RANGE",S.quoteForm.range=null,S.alertPopup&&S.alertPopup.hide(),I=null}else if(F&&l&&x&&(F=null,S.serviceSelected()),0==S.services.length){y.driversAvailable()?S.quoteBtnText="SET_A_B":(S.quoteBtnText="NO_DRIVER",E.$broadcast("hide:gplace"),E.$broadcast("hide:fancy"));new google.maps.LatLng(E.lat,E.lon);return E.centerMap(E.lat,E.lon),S.totalDrivers=0,H=!1,b=void 0,I=null,S.pickupSelected=!1,S.nearestTime=null,S.alertPopup&&S.alertPopup.hide(),I=null,!1}};var A=!1;S.serviceSelected=function(e){y.resetETA(),e&&(A=!0);var t=y.getUniqueDrivers();X="pickup"==I?oe:E;var o=Object.keys(t).length,i=0,n=0,a=0;x=!1;var r;for(var l in t){n++,i=Object.keys(t[l]).length,a=0;for(var s in t[l]){a++,a==i&&(x=!0);var c={};c[l]=t[l][s],y.setTagMap("updated",c,X,S.services,ce,S.quoteForm.service,function(e,t,o,i,n,a,l,s){r=S.setTagMap.bind(null,e,t,o,i,n,a,l,s)},ae,null,null,!0,S.quoteForm.range,F),n==o&&a==i&&r&&r()}}H&&(!S.quoteForm.range&&S.totalDrivers>0?S.quoteBtnText="SET_RANGE":0==S.quoteForm.service.length?S.quoteBtnText="SELECT_SERVICE":S.quoteBtnText="REVIEW")},Object.keys(y.getTagsDriverDefault()).length>0&&(S.driversInspected=!0),S.saveDateTime=function(e){S.quoteForm.date=moment(new Date(e)).format("MM/DD/YY"),S.quoteForm.time=moment(new Date(e)).format("hh:mm a")};var ue,me,ge,fe,ve,he,_e=function(e,t,o,i){geocoder=new google.maps.Geocoder,geocoder.geocode({latLng:e},function(e,n){n==google.maps.GeocoderStatus.OK&&("pickup"==t?(S.quoteForm.pickup={},S.quoteForm.pickup.formatted_address=e[0].formatted_address,S.quoteForm.pickup.lat=e[0].geometry.location.lat(),S.quoteForm.pickup.lon=e[0].geometry.location.lng(),$(".ion-google-place-container.modal").is(":visible")&&E.$broadcast("posFetched")):(S.quoteForm.dropoff={},S.quoteForm.dropoff.formatted_address=e[0].formatted_address,S.quoteForm.dropoff.lat=e[0].geometry.location.lat(),S.quoteForm.dropoff.lon=e[0].geometry.location.lng()),void 0==o&&(Y||W)&&S.changed(),S.$broadcast("markerPos",{type:t,address:e[0].formatted_address}),i&&$("#icon-pickup").click())})},Ee=!1,Se=S.$on("gmaps:loaded",function(){Me()}),De=function(t,o,i,a){if(!Ee&&!E.isOffline&&E.map){Ee=!0;var r=new google.maps.Geocoder;R=new google.maps.DirectionsService,w=new google.maps.DirectionsRenderer({suppressMarkers:!0,preserveViewport:!0}),ue=S.$on("queue:updated",ee),me=S.$on("queue:added",ee),ge=S.$on("queue:removed",ee),he={url:"./img/needle.png"},fe={url:"./img/markerA.png"},ve={url:"./img/markerB.png"};var l=new google.maps.LatLng(t,o);({center:l,zoom:14,zoomControlOptions:{position:google.maps.ControlPosition.LEFT_CENTER},panControl:!1,mapTypeControl:!1,mapTypeId:google.maps.MapTypeId.ROADMAP,maxZoom:17});if(m.isDriver){({url:n.replace("/api/","/assets/")+"img/markers/transportation/town_car.png",scaledSize:new google.maps.Size(21,34)})}else{({path:"M84 341c-21 0 -37 17 -37 38s16 37 37 37s37 -16 37 -37s-16 -38 -37 -38zM121 333c28 0 47 -24 47 -48v-114c0 -22 -32 -22 -32 0v105h-5v-286c0 -28 -41 -31 -43 0v165h-1h-7v-165c-1 -29 -43 -30 -43 0v286h-6v-105c0 -22 -31 -22 -31 0v114c0 24 19 48 47 48h37h37z",fillColor:"#000",fillOpacity:.9,anchor:new google.maps.Point(0,0),strokeWeight:0,scale:.08,rotation:180})}if(e.addMarker({lat:t,lon:o,icon:he,visible:!1},function(e){G=e}),e.addMarker({lat:t,lon:o,icon:fe,visible:!1},function(t){U=t,e.getMarker(U,{position:!0},function(e){_e(e,"pickup")})}),e.addMarker({lat:t,lon:o+.008,icon:ve,visible:!1},function(t){B=t,e.getMarker(B,{position:!0},function(e){_e(e,"dropoff")})}),google.maps.event.addListener(E.map,"dragend",function(){L=!1}),r.geocode({latLng:l},function(e,t){t==google.maps.GeocoderStatus.OK&&e[0]?(S.quoteForm.pickup.lat=e[0].geometry.location.lat(),S.quoteForm.pickup.lon=e[0].geometry.location.lng(),S.$broadcast("markerPos",{type:"pickup",address:e[0].formatted_address}),E.$broadcast("loading:hide")):E.$broadcast("loading:hide")}),void 0!=i){var s=new google.maps.LatLng(i,a);r.geocode({latLng:s},function(e,t){t==google.maps.GeocoderStatus.OK&&e[0]?(S.quoteForm.dropoff=e[0],E.$broadcast("loading:hide"),D(function(){S.changed()},1e3)):E.$broadcast("loading:hide")})}}},ye=function(t,o,i,n){a.mapsInitialized().then(function(){e.createMap(document.getElementById("quotemap"),null,function(){De(t,o,i,n)})})};S.resetQuoteForm=function(){L=!0,S.quoteForm.splitFare=["splitFare[]="],S.quoteForm.date=moment(new Date).format("MM/DD/YY"),S.quoteForm.time=moment(new Date).format("hh:mm a"),S.quoteForm.service="",D(function(){E.$broadcast("resetfancy")}),S.quoteForm.people=1,S.quoteForm.range=null,S.quoteForm.price=null,S.quoteForm.mode=null,S.instructionsModal&&(S.instructionsModal.remove().then(function(){S.instructionsModal=null}),S.notes.forEach(function(e){e.checked=!1})),H=Q=K=P=S.pickupSelected=!1,I=b=C=void 0,F=null,E.map&&(S.serviceSelected(),U&&(e.updateMarker(U,{lat:E.lat,lon:E.lon}),e.updateMarker(U,{lat:E.lat,lon:E.lon+.008})),S.centerMap(E.lat,E.lon),E.map.setZoom(14)),A=!1,S.timezone=E.tz,S.$broadcast("resetDtPicker"),I=null},y.isViewingRates()&&E.openOrderForm(),S.resetQuoteForm();var Me=function(){y.isInitializingFB()?E.$broadcast("loading:show",{text:"WAIT"}):null!=E.lat?_.ready(function(){ye(E.lat,E.lon)}):_.ready(function(){y.setLatLon().then(function(){ye(E.lat,E.lon)})})};Me();var Te=S.$on("firebaseInitialized",function(e){Me()}),ke=S.$on("gps:connected",function(e){Me()});s.setStopMovingMarker(!1);var Ie=S.$on("location:updated",function(t){S.serviceSelected(),void 0==E.map?e.createMap(document.getElementById("quotemap"),null,function(){ye(E.lat,E.lon)}):L&&!H&&G&&E.centerMap()});S.quoteButtonTapped=function(t){"SELECT_SERVICE"==S.quoteBtnText?D(function(){$("#serviceIcon ion-item").click()}):"SET_A_B"==S.quoteBtnText||"SET_RANGE"==S.quoteBtnText?($("#icon-pickup").click(),e.getMapCenter(function(e){var t=new google.maps.LatLng(e.lat(),e.lng()),o=new google.maps.LatLng(e.lat(),e.lng()+.008);_e(t,"pickup",!0),_e(o,"dropoff",!0)})):"REVIEW"==S.quoteBtnText&&S.sendQuote()},S.confirm=function(){$e()},S.reset=function(){S.alertPopup.hide(),S.resetQuoteForm()},S.editPickup=function(e){D(function(){$("#icon-pickup").trigger("click",[e])})},S.editService=function(){D(function(){$("#serviceIcon ion-item").click(),S.overlayModal()})},S.editSeats=function(){D(function(){$("div[people] .button-icon").click(),S.overlayModal()})},S.editDate=function(){D(function(){$("date-picker .button-icon").click(),S.overlayModal()})},S.editNotes=function(){S.openInstructions(),S.overlayModal()},S.overlayModal=function(){$('.modal:not(".confirmquoteModal")').parent().closest("div.modal-backdrop").css("zIndex",50)},S.$on("$ionicView.beforeLeave",function(){k&&k(),g&&g(),y.removeModalPopup(S,"seatsModal"),y.removeModalPopup(S,"instructionsModal"),y.removeModalPopup(S,"popoverDiscount"),O&&O(),be&&be(),Ce&&Ce(),Se&&Se(),ke&&ke(),Te&&Te(),ge&&ge(),me&&me(),ue&&ue(),Ie&&Ie(),ie&&ie(),de&&de(),pe&&pe(),ne&&ne(),S.popoverDiscount.remove(),S.popoverDiscount=null,E.map&&U&&!ionic.Platform.isWebView()&&(google.maps.event.clearInstanceListeners(U),google.maps.event.clearInstanceListeners(B),U.setMap(null),B.setMap(null),G&&G.setMap(null),U=null,B=null),E.resetMap(),j=[],S.map.map&&S.map.map.setZoom(14),y.resetDispatcherTagMap(),y.removeModalPopup(S,"alertPopup"),se&&se(),we&&we();for(v in le)le[v]()}),S.send=function(){y.removeModalPopup(S,"alertPopup"),S.driversInspected=!1,$e()},S.sendQuote=function(e){u(["CONFIRM","ERROR","CURRENTLY_NO_DRIVERS","SORRY","NO_DRIVERS_PICKUP","ENTER_PICKUP_LOC","ENTER_DROPOFF_LOC"]).then(function(t){if(void 0==S.quoteForm.pickup)return void p.error(t.ENTER_PICKUP_LOC,t.ERROR);if(void 0==S.quoteForm.dropoff)return void p.error(t.ENTER_DROPOFF_LOC,t.ERROR);if(void 0==e){if(null!=S.alertPopup)return void S.alertPopup.show();f.fromTemplateUrl("modals/confirmquote.html",{scope:S,animation:"slide-in-up",backdropClickToClose:!1}).then(function(e){S.alertPopup=e,e.show()})}})};var be=S.$on("quoteaccepted",function(){S.quoteSentMsg=null,E.$broadcast("loading:hide")}),Ce=S.$on("quotecancelled",function(e,t){S.quoteSentMsg==t&&u(["SORRY","QUOTE_NOT_ACCEPTED"]).then(function(e){S.quoteSentMsg=null,p.error(e.QUOTE_NOT_ACCEPTED,e.SORRY),E.$broadcast("loading:hide")})}),we=S.$on("validcoupon",function(e,t){S.quoteForm.dropoff.formatted_address=t.dropoff,S.quoteForm.dropoff.lat=t.dropoff_lat,S.quoteForm.dropoff.lon=t.dropoff_lon,S.quoteForm.people=t.selectPeople,S.quoteForm.service=t.selectService,S.quoteForm.coupon=t.coupon,S.quoteForm.price=t.price,S.quoteForm.range=d.defaultMilesRadius,S.quoteForm.mode="offer";var o={origin:new google.maps.LatLng(E.lat,E.lon),destination:new google.maps.LatLng(S.quoteForm.dropoff.lat,S.quoteForm.dropoff.lon),travelMode:google.maps.TravelMode.DRIVING};R.route(o,function(e,t){if(t==google.maps.DirectionsStatus.OK)for(var o=e.routes[0],i=0;i<o.legs.length;i++)S.estDist=(o.legs[i].distance.value/1609).toFixed(1),S.estTime=o.legs[i].duration.text,S.quoteForm.estDistVal=o.legs[i].distance.value/1609,S.quoteForm.estTimeVal=o.legs[i].duration.value/60,S.pickupSelected=!0,S.quoteForm.distance=S.estDist,$e()})}),Re=!1,$e=function(){Re=!0,E.showLoader=!0,E.$broadcast("loading:show",{text:"SEND_RIDE_REQ"}),S.quoteForm.items=[],S.quoteForm.group_id=[],S.quoteForm.zone_id=[],S.quoteForm.pickup_zone=[];var e=y.getAllDrivers(),t=0==S.totalDrivers?y.getTagsDispatcherMap():y.getTagsDriverMap(),o=[],i=y.getMyA2BerDrivers(),n=y.getGlobalGroups(),a={};for(var r in e){var l=e[r];for(var s in l)S.quoteForm.service.split(",").forEach(function(e,c){if(t[e].hasOwnProperty(s)&&t[e][s].indexOf(l[s].group_id)>-1){var d=l[s];S.totalDrivers>0&&S.quoteForm.items.indexOf("items[]="+d.item_id)<0&&S.quoteForm.items.push("items[]="+d.item_id),S.quoteForm.group_id.indexOf("group_id[]="+d.group_id)<0&&S.quoteForm.group_id.push("group_id[]="+d.group_id),S.quoteForm.zone_id.indexOf("zone_id[]="+r)<0&&S.quoteForm.zone_id.push("zone_id[]="+r),a[d.group_id]||(a[d.group_id]=[]),a[d.group_id].indexOf(s)<0&&(a[d.group_id].push(s),o.push({isA2Ber:i.indexOf(s)>-1,isGlobalGroup:n.indexOf(d.group_id)>-1,group:d.group_id,apikey:s}))}})}o.sort(function(e,t){return!e.isA2Ber&&t.isA2Ber?1:e.isA2Ber&&t.isA2Ber||!e.isA2Ber&&!t.isA2Ber?e.isGlobalGroup&&!t.isGlobalGroup?1:(e.isGlobalGroup&&t.isGlobalGroup||!e.isGlobalGroup&&!t.isGlobalGroup)&&parseInt(e.group)>parseInt(t.group)?1:-1:-1}),S.quoteForm.mya2bers=[];var d=[],m=second=third=!0;fourth=!0;var g=function(e,t){t&&!d[d.length]&&(d[d.length]=[]),d[d.length-1].push(e.apikey)};o.forEach(function(e,t){e.isA2Ber&&!e.isGlobalGroup?(o[t-1]&&o[t-1].isA2Ber&&!o[t-1].isGlobalGroup&&parseInt(o[t].group)>parseInt(o[t-1].group)&&(m=!0),g(e,m),m=!1):e.isA2Ber&&e.isGlobalGroup?(o[t-1]&&o[t-1].isA2Ber&&o[t-1].isGlobalGroup&&parseInt(o[t].group)>parseInt(o[t-1].group)&&(second=!0),g(e,second),second=!1):e.isA2Ber||e.isGlobalGroup?(o[t-1]&&parseInt(o[t].group)>parseInt(o[t-1].group)&&(fourth=!0),g(e,fourth),fourth=!1):(o[t-1]&&!o[t-1].isA2Ber&&!o[t-1].isGlobalGroup&&parseInt(o[t].group)>parseInt(o[t-1].group)&&(third=!0),g(e,third),third=!1)});var f={};d.reverse().forEach(function(e,t){e.forEach(function(e){f.hasOwnProperty(e)||(f[e]=t)})}),S.quoteForm.mya2bers=["mya2bers[]="+JSON.stringify(f)],S.quoteForm.group_id.forEach(function(e){var t=e.substring(11);(zoneId=y.withinZone(t,!1,S.quoteForm.pickup.lat,S.quoteForm.pickup.lon).id)&&S.quoteForm.pickup_zone.indexOf("pickup_zone["+t+"]="+zoneId)<0&&S.quoteForm.pickup_zone.push("pickup_zone["+t+"]="+zoneId)}),S.quoteForm.timezone=S.timezone,y.sendQuote(S.quoteForm).then(function(e){Re=!1,P=!1,"Successful"==e.status?(S.totalDrivers>0?("quote"==e.mode&&u("AWAIT_CONFIRM").then(function(e){E.$broadcast("loading:hide"),c.show({template:e})}),S.quoteSentMsg=e.quoteID):(E.$broadcast("quoteaccepted"),u(["SUCCESS","QUOTE_SCHEDULED"]).then(function(e){p.success(e.QUOTE_SCHEDULED,e.SUCCESS)})),S.coupon=null,S.resetQuoteForm(),E.$broadcast("quotesent")):(E.$broadcast("loading:hide"),u(["FAILED"]).then(function(t){E.$broadcast("setmapclick",!1),h.alert({title:t.FAILED,template:e.description}).then(function(e){E.$broadcast("setmapclick",!0)})}),S.driversInspected=!0)},function(e){E.$broadcast("loading:hide"),null!=S.modalDatePicker&&S.modalDatePicker.remove(),null!=S.seatsModal&&S.seatsModal.remove(),S.modalDatePicker=null,S.seatsModal=null,u(["SOMETHING_WRONG","FAILED"]).then(function(e){E.$broadcast("setmapclick",!1),h.alert({title:e.FAILED,template:e.SOMETHING_WRONG}).then(function(e){E.$broadcast("setmapclick",!0)})}),S.driversInspected=!0})}})}]).controller("IntroCtrl",["$scope","$ionicSlideBoxDelegate",function(e,t){e.startApp=function(){$state.go("main")},e.next=function(){t.next()},e.previous=function(){t.previous()},e.slideChanged=function(t){e.slideIndex=t}}]).controller("MapListCtrl",["$localStorage","$state","$ionicPopover","$ionicFilterBar","fireRef","$translate","$ionicPopup","$timeout","$rootScope","EmployeeService","$scope","$ionicPopover",function(e,t,o,i,n,a,r,l,s,c,d,o){d.loading=!0,o.fromTemplateUrl("popovers/maps-menu.html",{scope:d}).then(function(e){d.popoverMenu=e}),d.showDelete=!1,d.deleteMap=function(){d.popoverMenu.hide(),d.showDelete=!d.showDelete},d.onMapDelete=function(e){var t={action:"delete",map_id:e.map_id};c.map(t).then(function(e){m()}),d.showDelete=!1},d.showMap=function(e){t.transitionTo("app.maps-detail",{obj:e,id:e&&e.map_id||""})};var p;d.showFilterBar=function(){p=i.show({items:d.maps,update:function(e,t){d.maps=e}})};var u={groups:[]};d.maps=[],c.getEmployees().forEach(function(t){t.user_id&&t.user_id==e.user_id&&u.groups.indexOf("group_id[]="+t.category_id)<0&&u.groups.push("group_id[]="+t.category_id)});var m=function(){c.map({action:"fetch"}).then(function(e){d.loading=!1,e.data&&(d.maps=e.data)})};m(),d.$on("$ionicView.beforeLeave",function(){p&&(p(),p=null),c.removeModalPopup(d,"popoverMenu")})}]).controller("MapsCtrl",["PendingRequestsService","$ionicFilterBar","$ionicSideMenuDelegate","$state","$injector","$localStorage","UUIDService","$stateParams","fireRef","$translate","$ionicPopup","$timeout","$rootScope","$compile","EmployeeService","$scope","$ionicPopover",function(e,t,o,i,n,a,r,l,s,c,d,p,u,m,g,f,v){u.$broadcast("loading:show");var h=this;f.$on("$ionicView.afterEnter",function(s,c){var d;u.showFilterBar=function(){d=t.show({items:u.maps,update:function(e,t){u.maps=e}})},u.onMapDelete=function(e){var t={action:"delete",map_id:e.map_id};g.map(t).then(function(t){delete e.map_id,E(null,!0)})};var _={groups:[]};g.getEmployees().forEach(function(e){e.user_id&&e.user_id==a.user_id&&_.groups.indexOf("group_id[]="+e.category_id)<0&&_.groups.push("group_id[]="+e.category_id)}),f.showMap=function(e,t){if(e){if(t||o.toggleRight(!1),$&&$==e.map_id)return;l.obj=e,$=e.map_id}else $=void 0;L(!0)},u.showMap=function(e){f.showMap(e)},f.maps;var E=function(e,t){g.map({action:"fetch"}).then(function(i){f.loading=!1,i.data&&(f.maps=i.data.filter(function(e){return e.map_id}),f.maps.sort(function(e,t){return Date.parse(t.updated_at)-Date.parse(e.updated_at)}),u.maps=f.maps,e||(f.maps[0]&&f.maps[0].map_id?f.showMap(f.maps[0],t):(I(),h.zones.length=0,h.zonegroups.length=0,G.length=0,f.mapCenter=u.lat+","+u.lon,O&&O.setZoom(13))),u.$broadcast("loading:hide"),0==f.maps.length&&o.toggleRight(!1),Y())})};E(),f.rightMenu.src="maps/right-menu.html";var S,D,y=[],M=function(e,t,o){e.map_id=$,e.center||(e.center=O.getCenter().lat()+","+O.getCenter().lng()),!e.title&&f.mapObj&&(e.title=f.mapObj.title),e.zoom||(e.zoom=O.getZoom()),g.map(e).then(function(i){"Success"==i.status&&("view"==e.action&&u.$broadcast("loading:hide"),i.data.constructor===Array||(f.mapObj.title=i.data.title,i.data.description&&(f.mapObj.description=i.data.description)),R(i.data,t),o&&E(!0),A=!1)})},T=function(){D&&D.type&&"marker"!=D.type.toLowerCase()&&D.setEditable(!1),D=null,p(),B&&B.close()},k=function(e){T(e),D=e,"marker"!=e.type.toLowerCase()&&e.setEditable(!0)};f.deleteSelectedShape=function(){if(B&&B.close(),D)for(var e=0;e<h.zones.length;e++)if(h.zones[e]===D){var t=y.indexOf(D);t>-1&&y.splice(t,1),h.saveZonesToGroups(D,"delete"),D.setMap(null),h.zones.splice(e,1),D.id;var o,i=G.some(function(e,t){return o=t,D.id==e.id});i&&G.splice(o,1)}},f.saveZoneInfo=function(){f.editingzoneinfo=!1,D.title=f.title,D.desc=f.description,D.saveable=!0,h.saveZonesToGroups(D),B.close()};var I=function(){for(var e=0;e<y.length;e++)y[e].setMap(null);y.length=0},b=function(e){if(e.constructor===Object&&e.group_id)var t=e.group_id;else if(e.constructor===Array&&e[0].group_id)var t=e[0].group_id;t&&h.groups.forEach(function(e){e.user_id&&t.indexOf(e.category_id)>-1?e.checked=!0:e.checked=!1})},C=!1,w=function(e){if(h.zonegroups.length=0,angular.copy(g.getEmployees()).forEach(function(e){e.user_id&&e.user_id==a.user_id&&(e.checked=!0,h.zonegroups.push(e))}),!e){var t=G.some(function(e){return D.id==e.id});h.zonegroups.forEach(function(e){D.group_id.indexOf(e.category_id)>-1?e.checked=!0:t&&(e.checked=!1)})}if(0==h.zonegroups.length&&!C){C=!0;var o={name:f.mapObj.title,active:1,tags:[],services:[],allow_queue:u.allow_queue,zone_based_queuing:!0,allow_advance_reservation:10,allow_remote_reservation:1440,jail:30,offer:30,centers:[],zones:[],zonesDelete:[],toSaveRateplans:[]};u.biddable&&o.tags.push("tags[]=biddable"),u.rquire_uppload&&o.tags.push("tags[]=rquire_uppload"),g.addGroup(o).then(function(){g.findAllEmployees().then(function(t){C=!1,w(e)})})}},R=function(e,t){if(e.constructor===Array)for(var o=0,i=e.length;i>o;o++){if("polygon"==e[o].type.toLowerCase()){var n=[];e[o].lats.forEach(function(e){n.push({lat:Number(e)})}),e[o].lons.forEach(function(e,t){n[t].lng=Number(e)});var a=new google.maps.Polygon({path:n,map:O})}else if("circle"==e[o].type.toLowerCase())var a=new google.maps.Circle({map:O,center:{lat:Number(e[o].lats[0]),lng:Number(e[o].lons[0])},radius:1609*Number(e[o].radius)});else if("marker"==e[o].type.toLowerCase())var a=new google.maps.Marker({map:O,draggable:!0,icon:{url:"img/needle.png"},position:{lat:Number(e[o].lats[0]),lng:Number(e[o].lons[0])}});e[o].color&&a.set("fillColor","#"+e[o].color),y.push(a),a.title=e[o].zone_title,a.desc=e[o].zone_description,a.id=e[o].zone_id,a.saveable=!0,a.type=e[o].type,a.group_id=e[o].group_id||[],h.zones.push(a),G.push(a),Q(a),Z(a),b(e[o])}else e.zone_id&&y.some(function(t){return t.id==e.zone_id?(t.title=e.zone_title,t.desc=e.zone_description,t.group_id=e.group_id||[],b(e),!0):void 0})};u.isSelectedMap=function(e){return $===e.map_id},h.isSelectedZone=function(e){return D===e},h.selectGroup=function(e){e.checked=!e.checked,h.saveGroups()},h.selectGroups=function(e){h.groups.forEach(function(t){t.checked=e}),h.saveGroups()},h.selectZoneGroup=function(e){e.checked=!e.checked},h.selectZoneGroups=function(e){h.zonegroups.forEach(function(t){t.checked=e})},h.showDropdownPopover=function(e){f.popoverDropdown?f.popoverDropdown.show(".zonegroups"):v.fromTemplateUrl("popovers/maps-dropdown.html",{scope:f}).then(function(e){f.popoverDropdown=e,e.show(".zonegroups")})},h.showMapPopover=function(e){f.mapTitleObj={},f.mapTitleObj.description=f.mapObj.description,f.mapTitleObj.title=f.mapObj.title,f.popoverTitle?f.popoverTitle.show(".maptitle"):v.fromTemplateUrl("popovers/maps-title.html",{scope:f}).then(function(e){f.popoverTitle=e,e.show(".maptitle")})},f.saveMapTitle=function(){f.popoverTitle.hide();var e={};e.action="add",e.title=f.mapTitleObj.title,e.description=f.mapTitleObj.description,M(e,null,!0)};var $,O,P,A=!1,L=function(e){if(O&&f.maps)if($&&l.obj){I(),h.zones.length=0,h.zonegroups.length=0,G.length=0,f.mapObj=l.obj,b(l.obj),A=!0;var t=l.obj.center.split(",");if(l.obj.zoom)var o=Number(l.obj.zoom);else var o=13;O.setOptions({center:{lat:Number(t[0]),lng:Number(t[1])},zoom:o}),M({action:"view",zone_id:"all",map_id:$})}else e&&(I(),h.zones.length=0,h.zonegroups.length=0,G.length=0,$=r.getRandomId(),f.mapObj={title:"Untitled",description:"",groups:[],zones:{}},A=!0,f.mapCenter=u.lat+","+u.lon,O.setZoom(13),M({map_id:$,title:"Untitled",action:"add",center:u.lat+","+u.lon},null,!0),A=!1)},F=["#1E90FF","#FF1493","#32CD32","#FF8C00","#4B0082","#000"],N={};f.$on("mapInitialized",function(e,t){O=t,L()});h.editMapTitleDesc=function(){};var x=function(e){(e||D&&D.saveable)&&h.saveZonesToGroups(e||D,"add")},q=function(e){D&&D.type.toLowerCase()!=google.maps.drawing.OverlayType.MARKER.toLowerCase()&&(D.set("fillColor",e),h.saveZonesToGroups(D))},z=function(e){var t=document.createElement("span");return t.className="color-button",t.style.backgroundColor=e,google.maps.event.addDomListener(t,"click",function(){V(e),q(e)}),t},V=function(e){P=e;for(var t=0;t<F.length;++t){var o=F[t];N[o].style.border=o==e?"2px solid #789":"2px solid #fff"}};f.editingstyle=!1,f.buildColorPalette=function(){f.editingstyle=!0;for(var e=document.getElementById("color-palette"),t=0;t<F.length;++t){var o=F[t],i=z(o);e.appendChild(i),N[o]=i}V(F[0])},h.saveGroups=function(){var e=[],t=[];h.groups.forEach(function(o){o.checked&&(e.push(o),t.push("group_id[]="+o.category_id))}),0==t.length&&(t=["group_id[]="]);var o={action:"add"};t.length>0&&(o.group_id=t,M(o))},h.saveZonesToGroups=function(e,t){f.mapObj||{title:"xyz",description:"desc",groups:[],zones:{}},g.getzoneMap();h.zones.forEach(function(o,i){if(!e||e.saveable&&e.id==o.id){var n={lat:[],lon:[]};if(n.zone_id=e.id||r.getRandomId(),"circle"==o.type.toLowerCase()){var a=(o.getRadius()/1609).toFixed(2);n.lat.push("lats[]="+o.getCenter().lat()),n.lon.push("lons[]="+o.getCenter().lng()),n.radius=a,n.zone_radius=1>a?a:"1",n.zone_description=o.desc,n.zone_title=o.title,n.type="Circle"}else if("polygon"==o.type.toLowerCase()){for(var l=o.getPath(),s=[],c=[],i=0;i<l.getLength();i++){var d={},p=l.getAt(i);d.lat=p.lat(),d.lng=p.lng(),s.push(p.lat()),c.push(p.lng()),n.lat.push("lats[]="+p.lat()),n.lon.push("lons[]="+p.lng()),n.zone_title=e.title,n.zone_description=e.desc}n.type="Polygon",n.zone_title=e.title,n.zone_description=e.desc}if("marker"==o.type.toLowerCase()&&(n.lat.push("lats[]="+o.getPosition().lat()),n.lon.push("lons[]="+o.getPosition().lng()),n.zone_description=o.desc,n.zone_title=o.title,n.type="Marker"),e.get("fillColor")&&(n.color=e.get("fillColor").substring(1)),"delete"!=t){var u=[];h.zonegroups.forEach(function(e){e.checked&&u.push("group_id[]="+e.category_id)}),0==u.length&&(u=["group_id[]="]),n.group_id=u}return n.action=t||"add",void M(n,!0)}})},h.viewingZones=!1,h.zones=[];var G=[];h.groups=[],h.zonegroups=[];g.getGroupItems(),g.getEmployees();angular.copy(g.getEmployees()).forEach(function(e){e.user_id&&e.user_id==a.user_id&&h.groups.push(e)}),h.viewGroups=function(){h.viewingZones=!1},h.viewZones=function(){h.viewingZones=!0},h.editMapTitle=function(){},h.placeChanged=function(){h.place=this.getPlace(),h.map.setCenter(h.place.geometry.location)};var U=function(e,t){var o=h.map.getBounds().toSpan(),i=({lat:e.lat()+o.lat()*-.15,lng:e.lng()+0*o.lng()},O.getProjection().fromLatLngToPoint(e)),n=(new google.maps.Point(i.x*Math.pow(2,O.getZoom()),i.y*Math.pow(2,O.getZoom())),Math.pow(2,O.getZoom())),a=O.getProjection().fromLatLngToPoint(O.getCenter()),r=Math.floor((i.x-a.x)*n)-60,l=Math.floor((i.y-a.y)*n);t&&(r-=30,l-=170);O.getProjection().fromPointToLatLng(i);O.panBy(r,l)};h.showZonePopover=function(e){f.editingzoneinfo=!1,google.maps.event.trigger(e,"click",{})},f.groupchkboxes={};var B,j='<div><div ng-show="editingstyle" id="color-palette"></div><div ng-hide="editingstyle || editingzoneinfo"><h4>{{title}}</h4><p style="min-height:44px; min-width: 140px">{{description}}</p><ul id="map-infowindow-toolbar"><li><button ng-click="editZone()" class="button button-small button-positive">Edit</button></li><li><button ng-click="deleteSelectedShape()" class="button button-small button-assertive">Delete</button></li><li><button ng-if="hasstyle" ng-click="buildColorPalette()" class="zonestyle button button-small button-balanced">Style</button></li></ul></div><div ng-show="!editingstyle && editingzoneinfo"><button style="padding-bottom:3px;" ng-click="vm.showDropdownPopover()" class="zonegroups button icon-right ion-arrow-down-b">Groups</button><div style="padding-bottom:3px;">Title:&nbsp;&nbsp;<input ng-model="title" type="text" id="BlitzMapInfoWindow_title" value="" style="border:2px solid #dddddd;width:150px;padding:3px;"></div><div style="padding-bottom:3px;">Description:<br><textarea ng-model="description" id="BlitzMapInfoWindow_content" style="border:2px solid #dddddd;width:250px;height:115px;"></textarea></div><ul id="map-infowindow-toolbar"><li><button ng-click="saveZoneInfo()" class="button button-small button-positive">Save</button></li><li><button ng-click="editingzoneinfo = !editingzoneinfo" class="button button-small button-stable">Cancel</button></li></ul></div></div>',H=function(){f.maps.some(function(e){return e.map_id==$?(e.zoom=O.getZoom(),e.center=O.getCenter().lat()+","+O.getCenter().lng(),!0):void 0})},Y=function(){f.maps&&S&&(0==f.maps.length?S.setOptions({drawingControl:!1}):S.setOptions({drawingControl:!0}))};f.mapAvailable=!1;var W=[];n.has("NgMap")?(f.mapAvailable=!0,B=new google.maps.InfoWindow({disableAutoPan:!0}),n.get("NgMap").getMap().then(function(e){h.map=e,S=e.mapDrawingManager[0],Y(),W[0]=google.maps.event.addListener(S,"drawingmode_changed",T),W[1]=google.maps.event.addListener(e,"click",T),W[2]=google.maps.event.addListener(e,"zoom_changed",function(){$&&(A?A=!1:(M({action:"add"},!0),H()))}),W[3]=google.maps.event.addListener(e,"dragend",function(){$&&(A?A=!1:(M({action:"add"},!0),H()))}),new google.maps.Marker({position:{lat:u.lat,lng:u.lon},map:e})})):i.transitionTo("app.maps"),f.closeInfoWindow=function(){B&&B.close()},f.editZone=function(){f.editingzoneinfo=!f.editingzoneinfo,U(B.getPosition(),!0)};var K=function(e){var t;if("polygon"==e.type.toLowerCase()){for(var o=new google.maps.LatLngBounds,i=e.getPath(),n=0;n<i.getLength();n++){var a=i.getAt(n);o.extend(a)}t=o.getCenter()}else"circle"==e.type.toLowerCase()?t=e.getCenter():"marker"==e.type.toLowerCase()&&(t=e.getPosition());return t},Q=function(e){"circle"==e.type.toLowerCase()?(W[4]=google.maps.event.addListener(e,"radius_changed",function(e){x()}),W[5]=google.maps.event.addListener(e,"center_changed",function(e){x()})):"polygon"==e.type.toLowerCase()?(W[6]=google.maps.event.addListener(e.getPath(),"insert_at",function(e){x()}),W[7]=google.maps.event.addListener(e.getPath(),"remove_at",function(e){x()}),W[8]=google.maps.event.addListener(e.getPath(),"set_at",function(e){x()})):"marker"==e.type.toLowerCase()&&(W[9]=google.maps.event.addListener(e,"dragend",function(t){e.setPosition({lat:t.latLng.lat(),lng:t.latLng.lng()}),x(e)}))},Z=function(e,t){W[10]=google.maps.event.addListener(e,"click",function(o){f.editingstyle=!1,k(e);var i=angular.element(j),n=m(i)(f);B||(B=new google.maps.InfoWindow({disableAutoPan:!0})),B.setContent(n[0]),B.open(h.map,e);var a=(B.getPosition(),K(e));o.latLng?(B.setPosition(o.latLng),f.editingzoneinfo=!1):(B.setPosition(null),B.setPosition(a)),p(function(){U(B.getPosition()||a,t)},100),f.title=e.title,f.description=e.desc,f.hasstyle="circle"==e.type.toLowerCase()||"polygon"==e.type.toLowerCase(),w(),M({action:"add"},!0)})};h.onMapOverlayCompleted=function(e){S.setDrawingMode(null);var t=e.overlay;if(y.push(t),t.type=e.type,t.saveable=!1,t.id=r.getRandomId(),t.group_id=[],f.editingzoneinfo=!0,h.zones.push(t),w(t),"circle"==e.type)t.title="Circle "+h.zones.length,t.desc="",Q(t);else if("polygon"==e.type){for(var o=t.getPath(),i=0;i<o.getLength();i++){o.getAt(i)}t.title="Polygon "+h.zones.length,t.desc="",Q(t)}else"marker"==e.type&&(t.title="Marker "+h.zones.length,t.desc="",t.setDraggable=!0,Q(t));document.getElementById("MapInfoWindow");Z(t,!0),google.maps.event.trigger(t,"click",{})},f.$on("$ionicView.beforeLeave",function(){g.removeModalPopup(f,"popoverTitle"),g.removeModalPopup(f,"popoverDropdown"),I(),u.maps=null,u.onMapDelete=null,u.showMap=null;for(var t=0;t<W.length;t++)W[t]&&google.maps.event.removeListener(W[t]);o.toggleRight(!1),d&&(d(),d=null),u.showFilterBar=null,u.isSelectedMap=null,u.$broadcast("loading:hide"),e.cancelAll()})})}]).controller("ContactsCtrl",["$cordovaContacts","$ionicModal","$ionicFilterBar","$state","$injector","$localStorage","UUIDService","$stateParams","fireRef","$translate","$ionicPopup","$timeout","$rootScope","$compile","EmployeeService","$scope","$ionicPopover",function(e,t,o,i,n,a,r,l,s,c,d,p,u,m,g,f,v){f.$on("$ionicView.afterEnter",function(i,n){u.$broadcast("loading:show",{text:"FETCHING_CONTACTS"}),f.selectedContact={msg:""},f.defaultPic="img/person.jpg",f.contacts=[],f.showLargImage=function(e){f.allImages=[],e.photos?e.photos.forEach(function(e){f.allImages.push({src:e.value})}):f.allImages.push({src:f.defaultPic}),f.showModal("popovers/image-popover.html")},f.showModal=function(e){t.fromTemplateUrl(e,{scope:f,animation:"slide-in-up"}).then(function(e){f.fullSizeImageModal=e,f.fullSizeImageModal.show()})},f.closeModal=function(){f.fullSizeImageModal.hide(),f.fullSizeImageModal.remove()},f.contactsSelected=function(){return 0==f.contacts.filter(function(e){
return e.selected}).length};var a;f.showFilterBar=function(){a=o.show({items:f.contacts,update:function(e,t){f.contacts=e}})};var r=function(e){f.selectedContact=e,f.selectedContact.itemType||(f.selectedContact.itemType=[{text:"Driver",checked:!1},{text:"Dispatcher",checked:!1},{text:"Admin",checked:!1},{text:"Customer",checked:!1}]),f.selectedContact.servType||(f.selectedContact.servType=u.tags.map(function(e){return{text:e,checked:!1}})),f.typeModal?f.typeModal.show():t.fromTemplateUrl("modals/contact_type.html",{scope:f,animation:"slide-in-up"}).then(function(e){f.typeModal=e,f.typeModal.show()})};f.saveType=function(){f.msgtypeSelected()||(f.typeModal.hide(),f.selectedContact.selected=!0)},f.msgtypeSelected=function(){return 0==f.selectedContact.itemType.filter(function(e){return e.checked}).length&&0==f.selectedContact.servType.filter(function(e){return e.checked}).length&&(!f.selectedContact.msg||f.selectedContact.msg&&""==f.selectedContact.msg.trim())},f.selectContact=function(e,t){(!t||t&&e.selected)&&(e.msg=f.selectedContact.msg,r(e))},f.loading=!0,f.contactClicked=function(e,t){"IMG"!==e.target.nodeName&&f.selectContact(t,"INPUT"==e.target.nodeName)},f.getName=function(e){var t=e.displayName;return t&&""!==t?t:e.name.formatted?e.name.formatted:e.name.givenName&&e.name.familyName?e.name.givenName+" "+e.name.familyName:"Nameless"},f.getAllContacts=function(){e.find({filter:"",multiple:!0}).then(function(e){f.contacts=e,f.loading=!1,p(function(){u.$broadcast("loading:hide")},5e3)},function(e){f.loading=!1,u.$broadcast("loading:hide")})},g.getCountryCityState(),f.getAllContacts(),f.refer=function(){if(!f.contactsSelected()){u.$broadcast("loading:show");var e=[];f.contacts.forEach(function(t){if(t.selected){var o="user[]="+t.displayName+"|";o+=t.phoneNumbers?t.phoneNumbers[0].value+"|":"|",o+=t.emails?t.emails[0].value+"|":"|",o+=t.addresses?t.addresses[0].value+"|":"|",o+=t.msg?t.msg+"|":"|";var i=[];t.itemType&&t.itemType.forEach(function(e){e.checked&&i.push(e.text)}),o+=i.length>0?i.join(",")+"|":"|";var n=[];t.servType&&t.servType.forEach(function(e){e.checked&&n.push(e.text)}),o+=n.length>0?n.join(",")+"|":"|",o+=u.city+"|",o+=u.state+"|",o+=u.country,e.push(o)}}),g.addContacts(e).then(function(){c(["SUCCESS","CONTACT_REFERRED"]).then(function(e){d.alert({title:e.SUCCESS,template:e.CONTACT_REFERRED})}),f.contacts.forEach(function(e){e.selected=!1})},function(e){c(["SOMETHING_WRONG","FAILED"]).then(function(e){d.alert({title:e.FAILED,template:e.SOMETHING_WRONG})})})["finally"](function(){u.$broadcast("loading:hide")})}},f.$on("$ionicView.beforeLeave",function(){a&&(a(),a=null),u.$broadcast("loading:hide"),g.removeModalPopup(f,"typeModal")})})}]).controller("OpportunitiesListCtrl",["PendingRequestsService","$state","$injector","$localStorage","UUIDService","$stateParams","fireRef","$translate","$ionicPopup","$timeout","$rootScope","$compile","EmployeeService","$scope","$ionicPopover",function(e,t,o,i,n,a,r,l,s,c,d,p,u,m,g){m.$on("$ionicView.afterEnter",function(o,i){d.$broadcast("loading:show"),m.loading=!0,u.getCareers("fetch").then(function(e){"failed"==e.status?m.careers=[]:m.careers=e.data},function(e){m.careers=[]})["finally"](function(){m.loading=!1,d.$broadcast("loading:hide")}),m.showDetail=function(e){t.transitionTo("app.hrdetail",{obj:e})},m.$on("$ionicView.beforeLeave",function(){d.$broadcast("loading:hide"),e.cancelAll()})})}]).controller("OpportunitiesDetailCtrl",["$state","$injector","$localStorage","UUIDService","$stateParams","fireRef","$translate","$ionicPopup","$timeout","$rootScope","$compile","EmployeeService","$scope","$ionicPopover",function(e,t,o,i,n,a,r,l,s,c,d,p,u,m){u.detail=n.obj,u.apply=function(t){e.transitionTo("app.hrform",{obj:u.detail})}}]).controller("OpportunitiesFormCtrl",["toastr","$ionicHistory","$state","$injector","$localStorage","UUIDService","$stateParams","fireRef","$translate","$ionicPopup","$timeout","$rootScope","$compile","EmployeeService","$scope","$ionicPopover",function(e,t,o,i,n,a,r,l,s,c,d,p,u,m,g,f){g.$on("$ionicView.afterEnter",function(t,i){g.obj=r.obj,g.empl=g.obj,g.formType="add",g.empl.oldItems=[],g.hrformTitle=g.obj.name,g.isOwner=!0,g.skills=[{id:"Accounting and Consulting",text:"Accounting and Consulting",checked:!1,disabled:!1},{id:"Admin Support",text:"Admin Support",checked:!1,disabled:!1},{id:"Article and Blog Writing",text:"Article and Blog Writing",checked:!1,disabled:!1},{id:"Audio Production",text:"Audio Production",checked:!1,disabled:!1},{id:"Backend Development Expert",text:"Backend Development Expert",checked:!1,disabled:!1},{id:"Business Development",text:"Business Development",checked:!1,disabled:!1},{id:"Business Managment",text:"Business Managment",checked:!1,disabled:!1},{id:"Computer Graphics Animator",text:"Computer Graphics Animator",checked:!1,disabled:!1},{id:"Creative Writing",text:"Creative Writing",checked:!1,disabled:!1},{id:"Customer Service",text:"Customer Service",checked:!1,disabled:!1},{id:"Data Entry",text:"Data Entry",checked:!1,disabled:!1},{id:"Data Mining and Management",text:"Data Mining and Management",checked:!1,disabled:!1},{id:"Database Administration",text:"Database Administration",checked:!1,disabled:!1},{id:"Display Advertising",text:"Display Advertising",checked:!1,disabled:!1},{id:"Editing and Proofreading",text:"Editing and Proofreading",checked:!1,disabled:!1},{id:"Email and Marketing Automation",text:"Email and Marketing Automation",checked:!1,disabled:!1},{id:"Engineering and Architecture",text:"Engineering and Architecture",checked:!1,disabled:!1},{id:"ERP or CRM Software",text:"ERP or CRM Software",checked:!1,disabled:!1},{id:"Financial Planning",text:"Financial Planning",checked:!1,disabled:!1},{id:"Graphic Design and Animation",text:"Graphic Design and Animation",checked:!1,disabled:!1},{id:"Human Resources",text:"Human Resources",checked:!1,disabled:!1},{id:"Intellectual Property Law",text:"Intellectual Property Law",checked:!1,disabled:!1},{id:"IT and Networking",text:"IT and Networking",checked:!1,disabled:!1},{id:"Lead Generation",text:"Lead Generation",checked:!1,disabled:!1},{id:"Legal - Contract Law",text:"Legal - Contract Law",checked:!1,disabled:!1},{id:"Legal - Corporate Law",text:"Legal - Corporate Law",checked:!1,disabled:!1},{id:"Logo Design and Branding",text:"Logo Design and Branding",checked:!1,disabled:!1},{id:"Management Consulting",text:"Management Consulting",checked:!1,disabled:!1},{id:"Market Research",text:"Market Research",checked:!1,disabled:!1},{id:"Marketing",text:"Marketing",checked:!1,disabled:!1},{id:"Marketing Strategy",text:"Marketing Strategy",checked:!1,disabled:!1},{id:"Mobile App Development",text:"Mobile App Development",checked:!1,disabled:!1},{id:"Network and System Administration",text:"Network and System Administration",checked:!1,disabled:!1},{id:"Office and Clerical Work",text:"Office and Clerical Work",checked:!1,disabled:!1},{id:"Office Management",text:"Office Management",checked:!1,disabled:!1},{id:"Operations Manager",text:"Operations Manager",checked:!1,disabled:!1},{id:"Photography",text:"Photography",checked:!1,disabled:!1},{id:"Presentations",text:"Presentations",checked:!1,disabled:!1},{id:"Product Management",text:"Product Management",checked:!1,disabled:!1},{id:"Project Management",text:"Project Management",checked:!1,disabled:!1},{id:"Public Relations",text:"Public Relations",checked:!1,disabled:!1},{id:"QA and Testing",text:"QA and Testing",checked:!1,disabled:!1},{id:"Quantitative Analysis",text:"Quantitative Analysis",checked:!1,disabled:!1},{id:"Sales",text:"Sales",checked:!1,disabled:!1},{id:"Sales Strategy",text:"Sales Strategy",checked:!1,disabled:!1},{id:"Search Engine Marketing",text:"Search Engine Marketing",checked:!1,disabled:!1},{id:"Search Engine Optimization",text:"Search Engine Optimization",checked:!1,disabled:!1},{id:"Social Media Marketing",text:"Social Media Marketing",checked:!1,disabled:!1},{id:"Technical Support",text:"Technical Support",checked:!1,disabled:!1},{id:"Telemarketing and Telesales",text:"Telemarketing and Telesales",checked:!1,disabled:!1},{id:"Translation",text:"Translation",checked:!1,disabled:!1},{id:"Application User Interface, Experience",text:"Application User Interface, Experience",checked:!1,disabled:!1},{id:"Video Production",text:"Video Production",checked:!1,disabled:!1},{id:"Voice Talent",text:"Voice Talent",checked:!1,disabled:!1},{id:"Web Content Writing",text:"Web Content Writing",checked:!1,disabled:!1},{id:"Web Development",text:"Web Development",checked:!1,disabled:!1},{id:"Web Content Writing",text:"Web Content Writing",checked:!1,disabled:!1},{id:"Web Research",text:"Web Research",checked:!1,disabled:!1},{id:"Other",text:"Other",checked:!1,disabled:!1}];var a=[{id:"Admin",text:"Admin",checked:!1,disabled:!1},{id:"Dispatcher",text:"Dispatcher",checked:!1,disabled:!1},{id:"Driver",text:"Driver",checked:!1,disabled:!1},{id:"Other",text:"Other",checked:!1,disabled:!1}],l=function(){g.items=[],m.getEmployees().forEach(function(e){e.hasOwnProperty("can_bookin")&&(""==e.tags?g.items=a:a.forEach(function(t){e.tags.indexOf(t.text)>-1&&g.items.push(t)}),e.apikeypublic==window.localStorage.getItem("apikeypublic")&&(g.empl.cellPhone=e.cellPhone))}),0==g.items.length&&(g.items=a)},u=function(e){g.services=e.map(function(e){return{id:e,text:e,checked:!1}}),g.services.push({id:"Other",text:"Other",checked:!1}),void 0!=g.empl.tags&&(g.empl.items=g.empl.tags.filter(function(t){return e.indexOf(t)<0}),g.empl.services=g.empl.tags.filter(function(t){return e.indexOf(t)>-1})),void 0==g.empl.items&&(g.empl.items=[]),void 0==g.empl.services&&(g.empl.services=[]),void 0==g.empl.skills&&(g.empl.skills=[]),g.empl.item="",g.empl.itemType="",g.empl.service="",g.empl.serviceType="",g.empl.skill="",g.empl.skilType="",g.empl.items.length>0&&(g.empl.item=g.empl.items.join(", "),g.empl.itemType=g.empl.items.join("&tags[]="),g.empl.oldItems=g.empl.items.slice(0)),g.empl.services.length>0&&(g.empl.oldItems=g.empl.oldItems.concat(g.empl.services),g.empl.service=g.empl.services.join(", "),g.empl.serviceType=g.empl.services.join("&tags[]=")),g.empl.skills.length>0&&(g.empl.skill=g.empl.skills.join(", "),g.empl.skillType=g.empl.skills.join("&skills[]=")),l()};null==p.tags?m.getTags().then(function(e){u(tags)}):u(p.tags),m.getAllEmployees(),g.emailChanged=function(){g.isOwner=g.empl.email==n.email},g.empl.email=n.email,g.empl.firstName=p.name.substring(0,p.name.lastIndexOf(" ")),g.empl.lastName=p.name.split(" ").splice(-1)[0],g.save=function(t){if(t.$submitted=!0,t.$valid){(g.empl.item.indexOf("Admin")>-1||g.empl.item.indexOf("Dispatcher")>-1||g.empl.item.indexOf("Driver")>-1)&&(g.empl.itemType+="&tags[]="+g.empl.serviceType);var i=[],n=[],a=[];g.empl.oldItems.forEach(function(e){g.empl.itemType.indexOf(e)<0&&e.split(",").forEach(function(e){n.push(e)})}),g.empl.itemType.split("&tags[]=").forEach(function(e){g.empl.oldItems.indexOf(e)<0&&e.split(",").forEach(function(e){i.push(e)})}),g.empl.skillType.split("&skills[]=").forEach(function(e){e.split(",").forEach(function(e){a.push(e)})}),i.length>0&&(g.empl.itemType=i.join("&tags[]=")),n.length>0&&(g.empl.itemTypeOld=n.join("&itemTypeOld[]=")),a.length>0&&(g.empl.skillType=a.join("&skills[]=")),p.$broadcast("loading:show"),m.getCareers("add",g.empl).then(function(t){o.transitionTo("app.hrlist"),p.$broadcast("loading:hide"),p.$broadcast("empl:saved"),s(["SUCCESS","APPLIED_SUCCESSFULLY"]).then(function(t){e.success(t.APPLIED_SUCCESSFULLY,t.SUCCESS,{timeOut:3e3,positionClass:"toast-bottom-center"})})},function(){s(["SOMETHING_WRONG","FAILED"]).then(function(e){p.$broadcast("loading:hide"),c.alert({title:e.FAILED,template:e.SOMETHING_WRONG})})})}},g.noSkills=function(e){},g.noService=function(e){},g.showService=function(e){d(function(){angular.element(e.target).siblings("").find("ion-item").trigger("click")})},g.showSkills=function(e){d(function(){angular.element(e.target).siblings("").find("ion-item").trigger("click")})},g.showServiceField=function(){return g.empl&&g.empl.item&&(g.empl.item.indexOf("Admin")>-1||g.empl.item.indexOf("Dispatcher")>-1||g.empl.item.indexOf("Driver")>-1)}})}]).controller("ComplaintCtrl",["$localStorage","UUIDService","$translate","$ionicPopup","$timeout","$rootScope","EmployeeService","$scope","$ionicPopover",function(e,t,o,i,n,a,r,l,s){l.compl={deptid:"",priority:""};var c=["SALES","BILLING","CUST_SERV","TECH_SUPP"],d=["HIGH","MEDIUM","LOW"],p={};o(c).then(function(e){l.departments=[{id:e[c[0]],text:e[c[0]],checked:!1},{id:e[c[1]],text:e[c[1]],checked:!1},{id:e[c[2]],text:e[c[2]],checked:!1},{id:e[c[3]],text:e[c[3]],checked:!1}],p[e[c[0]]]=1,p[e[c[1]]]=2,p[e[c[2]]]=3,p[e[c[3]]]=4}),o(d).then(function(e){l.priorities=[{id:e[d[0]],text:e[d[0]],checked:!1},{id:e[d[1]],text:e[d[1]],checked:!1},{id:e[d[2]],text:e[d[2]],checked:!1}]}),l.showModal=function(e){n(function(){angular.element(e.target).siblings("").find("ion-item").trigger("click")})},l.deptSelected=function(e){l.compl.deptid=p[e]},l.submit=function(e){e.$submitted=!0,e.$valid&&(a.$broadcast("loading:show"),r.complaint(l.compl).then(function(t){"failed"!=t.status?(o(["COMPLAINT_SUBMITTED","SUCCESS"]).then(function(e){i.alert({title:e.SUCCESS,template:e.COMPLAINT_SUBMITTED})}),e.$setPristine(),l.compl={},history.back()):o(["SOMETHING_WRONG","FAILED"]).then(function(e){i.alert({title:e.FAILED,template:e.SOMETHING_WRONG})})},function(){o(["SOMETHING_WRONG","FAILED"]).then(function(e){i.alert({title:e.FAILED,template:e.SOMETHING_WRONG})})})["finally"](function(){a.$broadcast("loading:hide")}))}}]);