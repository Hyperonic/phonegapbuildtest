var _constants={testMode:!0,driverSpeedMPH:30,serverUTCOffset:5,significantMilesGuest:.1,significantMiles:.2,defaultPrice:0,defaultMilesRadius:1,milesRadius:25,offerTime:20,jailTime:60,quoteExpiry:4,driverQuoteExpiry:4,quotetoShowCustomerTime:20,offerWaitingMin:10,arriveBtnDisabledMiles:.2,offerNextDriverDelay:5e3,deleteTimeAfterDriverRate:1440,geoOptions:{timeout:25e3,enableHighAccuracy:!0,maximumAge:1e4},autoBookInterval:1e4};angular.module("directory.services",[]).constant("baseUrl","https://a2bapp.com/api/").constant("fireRef",new Firebase("https://yd.firebaseio.com/")).constant("constants",_constants).constant("networktimeout",60).constant("app_id","183dcce812d78798659eb538aa719a9c28c36c05df80c9b0aef24938049799a8").factory("EmployeeService",["MapServ","PendingRequestsService","$ionicHistory","$injector","$cordovaSpinnerDialog","Initializer","$filter","ApiParamService","constants","toastr","$translate","$ionicScrollDelegate","$localStorage","$ionicPlatform","GpsDetectService","$ionicLoading","$cordovaMedia","$cordovaLocalNotification","$cordovaVibration","$ionicModal","$ionicPopover","$ionicPopup","$cordovaDialogs","$cordovaGeolocation","$interval","$timeout","$rootScope","$http","$q","baseUrl","$state","$timeout","FireBase","fireRef","networktimeout",function(e,t,o,i,r,n,a,s,l,u,d,f,p,m,g,h,v,y,w,b,O,k,P,S,I,D,M,x,T,q,E,D,C,z,A){var N;null==p.dispatcherInboxes&&(p.acceptedOrders=[]),M.tripsInProgress=[];var L,R,F=[],G=!1,B=!1,Y=!1,Q=!1;M.bidOnDrivers=[];var U={};M.bookingIn=[];var V,H,W,Z=0,K=null,J=null,X={},ee={},te=[],oe=[],ie={},re=!1,ne=!1,ae=!0;M.listenedQueue=!1,M.startupLoading=!0,M.hasDriverQP=!1;var se=!0,le=!1,ue=!1,ce=[],de={},fe={},pe={};M.quotes=[],M.rates=[];var me,ge,_e,he,ve,ye=[],we={},be={},Oe={},ke=!1,Pe=!1,Se=!0,Ie=1.5,De=!1,Me=!1,xe=null,Te=!1,qe={},Ee=!1;null==p.dispatcherInboxes&&(p.dispatcherInboxes=[]);var Ce={},ze={},Ae={};M.appoverdue=!1,M.bookingOut=[];var je,Ne,Le,Re,$e,Fe,Ge=[],Be=!0,Ye={},Qe={},Ue=null,Ve=null,He=!1;M.creditCards=[],M.pois=[];var We,Ze={};M.rateNotSelected=!0;var Ke,Je,Xe,et,tt,ot,it={},rt={},nt={},at=[],st=[],lt=[],ut=[],ct=[],dt=[],ft={},pt={},mt={},gt={},_t={},ht=(new Date).getTimezoneOffset(),vt=[],yt=!1,wt=!1,bt={},Ot=[],kt=0,Pt=[],St=!1,It=!1,Dt=(new Array,new Array,new Array,new Array,new Array,moment());p.savedTimeStamps||(p.savedTimeStamps={});var Mt,xt,Tt,qt,Et,Ct={},zt=[],At=[],jt=!1;M.globalDriver=!1;var Nt=[],Lt=[];M.onTouchEvent=function(e){Pe&&Rt.ringTone()},e.mapClickableSetter(M);var Rt={setGlobalQMode:function(){M.quoteQMode=p.quoteQMode||M.default_customer_mode,M.partnersQMode=p.partnersQMode||M.default_driver_mode,M.dispatcherQMode=p.dispatcherQMode||M.default_dispatcher_mode},setServerOffset:function(){qt||this.getTimeZone(32.9355,-96.747).then(function(e){qt=-(e.rawOffset+e.dstOffset)/3600})},canBookin:function(){return Ee},isRinging:function(){return Pe},isInitializingFB:function(){return ae},isViewingRates:function(){return ne},isViewingOrder:function(){return wt},isOwner:function(){return window.localStorage.getItem("apikeypublic")==Tt},networkListener:function(){M.$on("internet:offline",function(){ot=moment()}),M.$on("internet:online",function(){Dt=moment()})},startTrackingTrip:function(){De=!0,_e=M.lat,he=M.lon,this.startTripDistCompInt()},stopTrackingTrip:function(){var e=this;unloadTripLat=M.lat,ve=M.lon,Ie=e.getGPSDistance(_e,he,unloadTripLat,ve),this.stopTripDistCompInt(),this.stopTripDistRemInt()},startTrackingBefore:function(e,t){this.startBeforeArriveInt(e,t)},stopTrackingBefore:function(){I.cancel(Ue),Ue=null},startTrackingAfter:function(e,t){this.startBeforeDestInt(e,t)},stopTrackingAfter:function(){I.cancel(je)},setTripInterval:function(){var e=0;ge=I(function(){me=e++,M.$broadcast("trip:time",me)},1e3)},startBeforeArriveInt:function(e,t){if(null==Ue){var o=new google.maps.LatLng(e,t);if(Se)var i=new google.maps.LatLng(M.lat,M.lon);else var i=new google.maps.LatLng(M.detail.driver_lat,M.detail.driver_lon);var r=new google.maps.DirectionsService,n={origin:i,destination:o,travelMode:google.maps.TravelMode.DRIVING};Ue=I(function(){r.route(n,function(e,t){if(t==google.maps.DirectionsStatus.OK)for(var o=e.routes[0],i=0;i<o.legs.length;i++)M.$broadcast("trip:beforeArriveTime",o.legs[i].duration.text),M.$broadcast("trip:beforeArriveDist",o.legs[i].distance.text)})},1e4)}},startBeforeDestInt:function(e,t){var o=new google.maps.LatLng(e,t),i=new google.maps.LatLng(M.lat,M.lon),r=new google.maps.DirectionsService,n={origin:i,destination:o,travelMode:google.maps.TravelMode.DRIVING};je=I(function(){r.route(n,function(e,t){if(t==google.maps.DirectionsStatus.OK)for(var o=e.routes[0],i=0;i<o.legs.length;i++)M.$broadcast("trip:beforeDestTime",o.legs[i].duration.text),M.$broadcast("trip:beforeDestDist",o.legs[i].distance.text)})},1e4)},getGoogleDistTime:function(e,t){var o=T.defer(),i=this,r=new google.maps.LatLng(e.lat,e.lon),n=new google.maps.LatLng(t.lat,t.lon),a=new google.maps.DirectionsService,s={origin:r,destination:n,travelMode:google.maps.TravelMode.DRIVING};return a.route(s,function(r,n){if(n==google.maps.DirectionsStatus.OK)for(var a=r.routes[0],s=0;s<a.legs.length;s++){var u={timeVal:a.legs[s].duration.value,timeText:a.legs[s].duration.text,timeHours:a.legs[s].duration.value/3600,dist:a.legs[s].distance.text,distVal:a.legs[s].distance.value,distMiles:a.legs[s].distance.value/1609};o.resolve(u)}else{var c=i.getGPSDistance(e.lat,e.lon,t.lat,t.lon),d=16093*c,f=Math.ceil(d)+" km",p=c/l.driverSpeedMPH,m=3600*p,g=Math.ceil(m/60)+" mins",u={timeVal:m,timeText:g,timeHours:p,dist:f,distVal:d,distMiles:c};o.resolve(u)}}),o.promise},getTripTime:function(){return me},startTripDistRemInt:function(e,t){var o=this;Le=I(function(){$e=o.getGPSDistance(e,t,_e,he),M.$broadcast("trip:distRem",$e)},1e4)},stopTripDistRemInt:function(){I.cancel(Le)},getTripRemDist:function(){return $e},startTripDistCompInt:function(){var e=this;Ne=I(function(){Re=e.getGPSDistance(_e,he,M.lat,M.lon),M.$broadcast("trip:distComp",Re)},1e4)},stopTripDistCompInt:function(){I.cancel(Ne)},getTripCompDist:function(){return Re},clearTripInterval:function(){I.cancel(ge)},isDriver:function(){return Se},removeTripModal:function(){It=!1,yt=!1,p.dispatcherInboxes.indexOf(M.detail.id)>-1&&p.dispatcherInboxes.splice(p.dispatcherInboxes.indexOf(M.detail.id),1),M.detail=null,this.removeModalPopup(M.tripModal),this.removeModalPopup(M.arrivedModal),this.processFirebase()},endTrip:function(e,t){Pe&&this.ringTone();var i=this;if(!M.detail||M.detail&&M.detail.id==e){me=0,window.localStorage.removeItem("replyMsgIndex"),window.localStorage.removeItem("sentMsgIndex"),delete p.tripDetail,this.removeModalPopup(M,"arrivedModal"),this.removeModalPopup(M,"ratingModal"),this.removeModalPopup(M,"receiptModal"),this.removeModalPopup(M,"messageModal"),this.removeModalPopup(M,"cancelTripModal"),this.removeModalPopup(M,"popoverMenu"),this.removeModalPopup(M,"orderEditModal"),this.removeModalPopup(M,"seatsModal"),this.removeModalPopup(M,"chatModal"),M.detail&&M.detail.id==e&&(p.lastTrip=M.detail,p.acceptedOrders&&p.acceptedOrders.indexOf(e)>-1&&p.acceptedOrders.splice(p.acceptedOrders.indexOf(e),1),we[M.detail.zone_id].hasOwnProperty(M.detail.id)&&delete we[M.detail.zone_id][M.detail.id],M.detail.isDriver&&z.child(M.detail.group_id+"/queue/"+window.localStorage.getItem("apikeypublic")).onDisconnect().update({quote_id:"disconnected",disconnectTime:Firebase.ServerValue.TIMESTAMP}),M.arrivedToast&&M.arrivedToast.indexOf(M.detail.id)>-1&&M.arrivedToast.splice(M.arrivedToast.indexOf(M.detail.id),1),M.toastArrived&&(u.clear(M.toastArrived),M.toastArrived=null)),M.dontHideLoader=!1,M.offerDetail=null,M.$broadcast("trip:ended");var r=M.tripsInProgress.indexOf(e);r>-1&&r>-1&&M.tripsInProgress.splice(r,1),W&&W(),H&&H(),0==M.tripsInProgress.length?(It=!1,M.tripModal=null,M.detail=null,i.autoBookFunc(),"app.trip-detail"==M.history.currentStateName()&&(o.goBack(),M.onQuotePage||t||i.toggleBook(!0,"all",void 0,!0))):Y&&(p.dispatcherInboxes.length=0,o.goBack(),M.detail=null)}},resetQuoteID:function(){It||dt.forEach(function(e){z.child(e+"/queue/"+window.localStorage.getItem("apikeypublic")).update({quote_id:""})})},setGroupBidMode:function(e){for(var t in bt)(Ot[bt[t].groupPosition].biddable||"quote"!=e)&&(Ot[bt[t].groupPosition].mode=e,this.setFbBidMode(t,e))},setFbBidMode:function(e,t){dt.indexOf(e)>-1&&z.child(e+"/queue/"+window.localStorage.getItem("apikeypublic")).update({mode:t})},loginApi:function(e){var t=T.defer(),o=q+"login/?email="+e.email+"&"+s.getParams();return o+=e.method?"&method="+e.method:"&password="+e.password,x.get(o).success(function(e){t.resolve(e)}).error(function(e){t.reject(e)}),t.promise},login:function(e){var t=this,o=T.defer(),i=o.promise,r=function(){t.loginApi(e).then(function(e){o.resolve(e),e.user&&(window.localStorage.setItem("apikeypublic",e.user.apikeypublic),p.token={},p.token.time=moment(),p.token.token=e.user.token,M.creditCards=e.user.stripe,M.haveCreditCard=e.user.stripe.length>0?!0:!1,t.getGlobalDrivers())},function(e){o.reject(e)})};return null==window.localStorage.getItem("lat")?this.setLatLon().then(function(){r()}):r(),i.success=function(e){return i.then(e),i},i.error=function(e){return i.then(null,e),i},i},checkMessages:function(){var e=this;lt.forEach(function(t){z.child(t+"/messages").once("value",function(t){t.forEach(function(t){e.messageListener(t)})})})},hideQuote:function(e){var t,o=this;M.quoteDetail&&e==M.quoteDetail.zone_id&&(M.quotes.some(function(o,i){return e==o.group_id&&(t=i),e==o.group_id}),t&&M.quotes.splice(M.quotes.indexOf(t),1),0==M.quotes.length&&(d("MOVED_OUT_ZONE").then(function(e){M.quoteDetail&&u.info(M.quoteDetail.group_name,e,{allowHtml:!0,timeOut:3e3,positionClass:"toast-bottom-center"})}),o.quoteModalCleanUp()))},zoneListener:function(e){i.get("EmployeeService").queueListener(e)},addZoneListeners:function(e,t){var o=this;if(!Ct.hasOwnProperty(e)||Ct.hasOwnProperty(e)&&Ct[e].indexOf(t)<0){Ct.hasOwnProperty(e)||(Ct[e]=[]),Ct[e].push(t);try{"value"==t&&z.child(e+"/queue").orderByChild("timestamp").on("value",o.zoneListener),"child_added"==t&&z.child(e+"/queue").orderByChild("timestamp").on("child_added",o.zoneAdded),"child_removed"==t&&z.child(e+"/queue").on("child_removed",o.zoneRemoved)}catch(i){}}},removeZoneListeners:function(e,t){var o=this;Ct.hasOwnProperty(e)&&(Ct[e].splice(Ct[e].indexOf(t),1),0==Ct[e].length&&delete Ct[e]),"value"==t&&z.child(e+"/queue").orderByChild("timestamp").off("value",o.zoneListener),"child_added"==t&&z.child(e+"/queue").orderByChild("timestamp").off("child_added",o.zoneAdded),"child_removed"==t&&z.child(e+"/queue").orderByChild("timestamp").off("child_removed",o.zoneRemoved)},zoneAdded:function(e){var t=i.get("EmployeeService");if(e.exists()){var o=e.ref().parent().parent().key(),r=e.key();window.localStorage.getItem("apikeypublic")==r&&-1==dt.indexOf(o)&&(dt.push(o),t.setFbBidMode(o,Ot[bt[o].groupPosition].mode));var n={};n[r]=e.val(),M.$broadcast("queue:added",n,"added"),ft.hasOwnProperty(o)||(ft[o]={}),ft[o].hasOwnProperty(r)||(ft[o][r]={})}},zoneRemoved:function(e){var t=i.get("EmployeeService");if(e.exists()){var o=e.ref().parent().parent().key(),r=e.key();if(pt.hasOwnProperty(o)&&pt[o].hasOwnProperty(r)&&(delete pt[o][r],0==Object.keys(pt[o]).length&&delete pt[o],mt.hasOwnProperty(r)&&(delete mt[r][o],0==Object.keys(mt[r]).length&&delete mt[r])),!pt[o]&&bt[o]&&(Ot[bt[o].groupPosition].limit=!1),window.localStorage.getItem("apikeypublic")==r){var n=dt.indexOf(o);n>-1&&Object.keys(bt).length>0&&bt.hasOwnProperty(o)&&bt[o].booked&&o==bt[o].category_id&&(M.bookingOut.indexOf(o)>-1?(e.ref().onDisconnect().cancel(),dt.splice(n,1),delete nt[o],at.splice(at.indexOf(o),1),z.child(o+"/queue").orderByChild("timestamp").off("child_added"),M.bookingOut.splice(M.bookingOut.indexOf(o),1),Ot[bt[o].groupPosition].booked=!1,Ot[bt[o].groupPosition].showQP=!1,bt[o].booked=!1,0==M.bookingOut.length&&M.$broadcast("loading:hide",!0)):Ot[bt[o].groupPosition].booked&&(Ot[bt[o].groupPosition].booked=!1,Ot[bt[o].groupPosition].showQP=!1,bt[o].booked=!1,t.withinZone(o)?!e.val().disconnectTime&&e.val().first_name?e.ref().update(e.val(),function(){z.child(o+"/queue").orderByChild("timestamp").once("value",function(e){t.queueListener(e)})}):(dt.splice(n,1),delete nt[o],at.splice(at.indexOf(o),1)):(e.ref().onDisconnect().cancel(),dt.splice(n,1),at.splice(at.indexOf(o),1),delete nt[o],z.child(o+"/queue").orderByChild("timestamp").off("child_added"))),t.setAllBookedStatus())}var a={};if(a[r]=e.val(),M.$broadcast("queue:removed",a,"removed"),null!=K&&U[r]&&K.indexOf(U[r][o])>-1){var s=K[U[r][o].id];s.apikeypublic==r&&s.dispatcher<1&&(s.zone_id==o||s.category_id==o)&&(s.booked=!1,s.QP=null),M.$broadcast("firebase:updated",null)}t.setGroups()}},storeInboxIds:function(e,t){pe.hasOwnProperty(t)||(pe[t]=[]),e&&pe[t].indexOf(e)<0&&pe[t].push(e)},inboxAdded:function(e){var t=i.get("EmployeeService");if(e.exists()){se=!1;e.ref().parent().key();e.val().route?(e.val().route.ordered_by==i.get("UUIDService").getRandomUUID()||e.val().route.ordered_by==window.localStorage.getItem("apikeypublic"))&&t.storeInboxIds(e.val().route.id,e.val().route.quote_id):e.ref().remove();var o=function(e){var o=e.ref().parent().parent().key(),r=e.val(),n=Lt.indexOf(o);if(n>-1&&Lt.splice(n,1),null!=r){if(!e.val().route)return void e.ref().remove(function(e,t){return function(o){o||we.hasOwnProperty(e)&&we[e].hasOwnProperty(t)&&delete we[e][t]}}(o,e.key()));if(dt.length>0&&("quote"==r.route.status||"offer"==r.route.status)||r.route.sent_to==window.localStorage.getItem("apikeypublic")||r.route.ordered_by==i.get("UUIDService").getRandomUUID()||r.route.ordered_by==window.localStorage.getItem("apikeypublic")||r.route.reply_to!=window.localStorage.getItem("apikeypublic")){var a=e.key();if(we.hasOwnProperty(o)||(we[o]={}),we[o][a]=r,r.hasOwnProperty("offer_to_not"))for(var s in r.offer_to_not){var l=r,a=l.route.id;""!=l.offer_to_not[s]&&(l.offer_to_not[s].group_id=o,l.offer_to_not[s].inbox_id=a,l.offer_to_not[s].offer_to_not==window.localStorage.getItem("apikeypublic")&&(be.hasOwnProperty(a)||(be[a]={}),be[a][l.route.status]=s,Ke=a,"offer"==l.route.status?(Je=s,M.offerNotInProcess=!1):"quote"==l.route.status&&(et=s)))}if(r.hasOwnProperty("offer_to"))for(var s in r.offer_to){var l=r,a=l.route.id;""!=l.offer_to[s]&&(l.offer_to[s].group_id=o,l.offer_to[s].inbox_id=a,l.offer_to[s].offer_to==window.localStorage.getItem("apikeypublic")&&(Oe[a]=s,"offer"==l.route.status?Xe=s:"quote"==l.route.status&&(tt=s)))}"quote"!=r.status&&pe.hasOwnProperty(M.sentQuoteId)&&pe[M.sentQuoteId].indexOf(r.route.id)>-1&&pe[M.sentQuoteId].splice(pe[M.sentQuoteId].indexOf(r.id),1),t.setOfferTimeout(),t.processFirebase(),M.$broadcast("inbox:updated",o)}else we.hasOwnProperty(o)&&we[o].hasOwnProperty(e.key())&&delete we[o][e.key()]}};e.ref().on("value",o)}},inboxRemoved:function(e){var t=i.get("EmployeeService");if(e.exists()){var r=e.key(),n=e.ref().parent().parent().key();if(we&&we[n])var a=angular.copy(we[n][r]);else var a=e.val();M.$broadcast("inbox:removed",e.val().route);var s=F.indexOf(r);if(s>-1&&F.splice(s,1),e.val().route&&pe.hasOwnProperty(e.val().route.quote_id)&&pe[e.val().route.quote_id].indexOf(e.val().route.id)>-1){var l=e.val().route.quote_id;pe[l].splice(pe[l].indexOf(e.val().route.id),1),0==pe[l].length&&(delete pe[l],X[l]&&(D.cancel(X[l]),delete X[l]),M.$broadcast("quotecancelled",l))}zt.indexOf(r)>-1&&zt.splice(zt.indexOf(r),1);var c;for(var f in we){for(var p in we[f])if(a&&we[f][p].route.quote_id==a.route.quote_id&&"offer"==a.route.status&&a.route.reply_to==window.localStorage.getItem("apikeypublic")){if(we[f][p].route.id!=a.route.id){c=!1;break}c=!0}if(c===!1)break}if((M.allow_reoffer&&c||!M.allow_reoffer&&a&&"offer"==a.route.status&&a.route.reply_to==window.localStorage.getItem("apikeypublic"))&&(d(["SORRY","OFFER_NOT_ACCEPTED"]).then(function(e){M.dontHideLoader=!1,M.$broadcast("loading:hide"),u.error(e.OFFER_NOT_ACCEPTED,e.SORRY)}),"app.trip-detail"!=M.history.currentStateName()||M.detail||(It=!1,M.tripModal=null,o.goBack())),we[n]&&we[n].hasOwnProperty(r)&&delete we[n][e.key()],Ze.hasOwnProperty(""+n+","+r)&&delete Ze[""+n+","+r],At.indexOf(r)>-1&&At.splice(At.indexOf(r),1),qe.hasOwnProperty(n)){var m=qe[n].indexOf(r);m>-1&&(qe[n].splice(m,1),yt=!1)}!It||It&&void 0!=M.detail&&M.detail.zone_id==n,a&&t.cleanModals(n,r,a),t.setEmptyQuoteId(e.val())}},setEmptyQuoteId:function(e){var t=e.route;if(!It&&t&&"object"!=typeof t.sent_to&&pt[t.zone_id]&&pt[t.zone_id][t.sent_to]){var o=z.child(e.route.zone_id+"/queue/"+e.route.sent_to);o.update({quote_id:""})}},isDispatcherAdmin:function(e){return 0==this.getEmployees().length?!1:Ot.some(function(t){return!t.hasOwnProperty("can_bookin")&&t.category_id==e&&new RegExp("^$|"+t.tags.join("|")).test("Admin,Dispatcher")||t.hasOwnProperty("can_bookin")&&t.category_id==e&&p.user_id==t.user_id})},queueListener:function(e,t,o){var i=this;if(e.exists()){var r=e.ref().parent().key();i.setEmpl(e,r,t),p.isDriver&&e.hasChild(window.localStorage.getItem("apikeypublic"))&&M.$broadcast("firebase:updated",null)}o&&ut.indexOf(o)>-1&&ut.splice(ut.indexOf(o),1)},listenFBConnected:function(){var e=this;z.child(".info/connected").on("value",function(t){!xt&&t.val()&&e.resetQP(),xt=t.val(),t.val()||(M.listenedQueue=!1)})},isFBConnected:function(){return xt},resetQP:function(){var e=this;e.resetLatLon(),e.autoBookFunc(!0);dt.slice(0);e.queueListenerFunc(lt,!1,!0)},getServerTime:function(){var e=0;return z.child(".info/serverTimeOffset").on("value",function(t){e=t.val()}),Date.now()+e},removeUserFromFb:function(e,t,o,r,n,a){var s=this;if((!t.quote_id||"disconnected"==t.quote_id||""==t.quote_id)&&n==window.localStorage.getItem("apikeypublic")&&bt[t.group_id]&&!Ot[bt[t.group_id].groupPosition].booked&&!s.isDispatcherAdmin(t.group_id)&&i.get("UUIDService").matchesMyUUID(t.uuid)&&!s.withinZone(t.group_id)||!t.first_name||t.disconnectTime&&(""==t.quote_id||"disconnected"==t.quote_id)&&(n!=window.localStorage.getItem("apikeypublic")||n==window.localStorage.getItem("apikeypublic")&&M.bookingIn.indexOf(e)<0)&&moment(s.getServerTime()).diff(moment(t.disconnectTime),"seconds")>A){if(n==window.localStorage.getItem("apikeypublic")&&(o.ref().child("/"+n).onDisconnect().cancel(),dt.indexOf(e)>-1&&dt.splice(dt.indexOf(e),1),st.indexOf(e)>-1&&st.splice(st.indexOf(e),1),bt&&bt[e]&&(Ot[bt[e].groupPosition].booked=!1)),n==window.localStorage.getItem("apikeypublic")){r.ref().onDisconnect().cancel();var l=dt.indexOf(e);l>-1&&dt.splice(l,1),at.splice(at.indexOf(e),1),delete nt[e],z.child(e+"/queue").orderByChild("timestamp").off("child_added"),s.setAllBookedStatus()}return!0}return!1},setEmpl:function(e,t,o){var r,n=this,a=-1,s=!1,l=0,u=e.numChildren(),c=u,d=0,f=0,m={};if(e.forEach(function(e){var t=e.val(),o=e.key();t.tags&&(t.tags.indexOf("Driver")<0||""!=t.quote_id||!n.withinZone(t.group_id,null,t.lat,t.lon))?(l--,c--):(m[t.zone_id]||(m[t.zone_id]=[]),m[t.zone_id].push(o))}),e.forEach(function(o){d++,l++;var i=o.key(),u=o.val();if(i==window.localStorage.getItem("apikeypublic")&&(f=d),(!n.removeUserFromFb(t,u,e,o,i)||(r={key:i,lat:u.lat,lon:u.lon,ref:o.ref()},i==window.localStorage.getItem("apikeypublic")||d==e.numChildren()))&&(!r||((i==window.localStorage.getItem("apikeypublic")||f==d-1&&d==e.numChildren())&&(r.lat&&n.logoutUser(r.key,r.lat,r.lon),function(e){r.ref.remove(function(){z.child(e+"/queue").orderByChild("timestamp").once("value",function(e){n.queueListener(e)})})}(t)),r=null,d!=e.numChildren()))&&u.email){ft.hasOwnProperty(t)||(ft[t]={}),ft[t].hasOwnProperty(i)||(ft[t][i]={},s=i==window.localStorage.getItem("apikeypublic")),ft[t][i].lat=u.lat,ft[t][i].lon=u.lon,ft[t][i].update_time=u.update_time,pt.hasOwnProperty(t)||(pt[t]={}),i==window.localStorage.getItem("apikeypublic")&&bt[t]&&!Ot[bt[t].groupPosition].limit&&(dt.indexOf(t)<0&&dt.push(t),Y="disconnected"!=u.quote_id&&""!=u.quote_id?u.quote_id:!1),pt[t].hasOwnProperty(i)||(pt[t][i]={}),pt[t][i].first_name=u.first_name,pt[t][i].item_id=u.item_id,pt[t][i].quote_id=u.quote_id,pt[t][i].group_id=u.group_id,pt[t][i].timestamp=u.timestamp,pt[t][i].zone_id=u.zone_id,pt[t][i].uuid=u.uuid,pt[t][i].position=d,n.processFirebase(),mt.hasOwnProperty(i)||(mt[i]={}),mt[i][u.group_id]={zone_id:u.zone_id,group_id:u.group_id,item_id:u.item_id,tags:u.tags,mode:u.mode,quote_id:u.quote_id,lat:u.lat,lon:u.lon,settings:u.settings},u.disconnectTime&&(mt[i][u.group_id].disconnectTime=u.disconnectTime,D(function(e){z.child(e+"/queue").orderByChild("timestamp").once("value",function(e){n.queueListener(e)})},1e3*(A+1),!0,t)),p.permit||i!=window.localStorage.getItem("apikeypublic")||n.setLicensePermit(u.vehicle,u.license);var g={};g[i]=mt[i][u.group_id],M.$broadcast("queue:updated",g,"updated");var _=(o.val(),pt[t][window.localStorage.getItem("apikeypublic")]);ft[t][window.localStorage.getItem("apikeypublic")]?ft[t][window.localStorage.getItem("apikeypublic")]:M;if(bt[t]&&d==e.numChildren()&&(M.zone_maximum_driver_limit<=c?a>M.zone_maximum_driver_limit&&!yt&&!It?(n.toggleBook(!1,Ot[bt[t].groupPosition].id),Ot[bt[t].groupPosition].limit=!0):(M.detail&&M.detail.zone_id==t&&M.zone_maximum_driver_limit<c||!_&&-1==a)&&(Ot[bt[t].groupPosition].limit=!0):Ot[bt[t].groupPosition].limit=!1),K&&void 0!=U[i]&&void 0!=U[i][t]&&void 0!=K[U[i][t].id]){var h=K[U[i][t].id];if(h.apikeypublic==i&&(t==h.zone_id||t==h.category_id)){h.booked=!0,h.first_name=u.first_name,h.lat=Number(u.lat),h.lng=Number(u.lon),h.pic=u.pic,h.license=u.license,h.vehicle=u.vehicle,h.quote_id=u.quote_id,h.zone_id=u.zone_id,h.mode=u.mode;var v=n.withinZone(u.group_id,null,h.lat,h.lng);if(u.tags.indexOf("Driver")<0||!v?h.QP=c:m[u.zone_id]&&(h.QP=m[u.zone_id].indexOf(i)+1+"/"+m[u.zone_id].length),0==h.QP.toString().search("0")&&(h.QP=""),h.pic==q.replace("/api/","/assets/")+"img/markers/transportation/town_car.png"&&(h.pic="img/person.jpg"),h.cellPhone=u.cellPhone,""!=u.quote_id&&"Offered"!=u.quote_id&&"disconnected"!=u.quote_id){if(we.hasOwnProperty(t))for(var y in we[t]){var w=we[t][y].route;w.sent_to==h.apikeypublic&&("rate"!=w.reply_to_message[Object.keys(w.reply_to_message)[Object.keys(w.reply_to_message).length-1]].status?(h.intrip=!0,h.quote_id=u.quote_id):h.intrip=!1)}}else h.intrip=!1}M.$broadcast("firebase:updated",null)}D(function(){n.setOfferTimeout()},1e3)}}),M.loggedIn&&e.hasChild(window.localStorage.getItem("apikeypublic"))&&pt[t]&&pt[t][window.localStorage.getItem("apikeypublic")]&&mt[window.localStorage.getItem("apikeypublic")]&&mt[window.localStorage.getItem("apikeypublic")][t]&&bt[t]&&pt[t][window.localStorage.getItem("apikeypublic")].hasOwnProperty("first_name")&&(o||!Ot[bt[t].groupPosition].limit)){if(bt[t])var g=t;else{var g=pt[t][window.localStorage.getItem("apikeypublic")].group_id;Ot[bt[g].groupPosition].zone_id=t}var _=n.withinZone(t),h=pt[t][window.localStorage.getItem("apikeypublic")].zone_id;mt[window.localStorage.getItem("apikeypublic")][g].tags.indexOf("Driver")<0||!_?Ot[bt[t].groupPosition].QP=c:m[h]&&(Ot[bt[t].groupPosition].QP=m[h].indexOf(window.localStorage.getItem("apikeypublic"))+1+"/"+m[h].length,Ot[bt[t].position].QP=Ot[bt[t].groupPosition].QP),""!=pt[t][window.localStorage.getItem("apikeypublic")].quote_id&&"disconnected"!=pt[t][window.localStorage.getItem("apikeypublic")].quote_id||(It||Ot[bt[t].groupPosition].booked)&&!o||e.ref().child("/"+window.localStorage.getItem("apikeypublic")).onDisconnect().update({quote_id:"disconnected",disconnectTime:Firebase.ServerValue.TIMESTAMP});var v=Ot[bt[g].groupPosition];if(v.booked=!0,v.showQP=!0,v.mode=pt[t][window.localStorage.getItem("apikeypublic")].mode,bt[g].booked=!0,n.setAllBookedStatus(),n.setGroups(),M.bookingIn.indexOf(t)>-1||"disconnected"==pt[t][window.localStorage.getItem("apikeypublic")].quote_id||s||!nt[t]||new RegExp("^$|"+mt[window.localStorage.getItem("apikeypublic")][g].tags.join("|")).test("Admin,Dispatcher")){var y;v.withinzone&&pt.hasOwnProperty(v.category_id)&&pt[v.category_id].hasOwnProperty(window.localStorage.getItem("apikeypublic"))&&(y=v.category_id);var g=y||t;if(M.bookingIn.indexOf(t)>-1&&(M.bookingIn.splice(M.bookingIn.indexOf(t),1),0==M.bookingIn.length&&D(function(){0==M.bookingIn.length&&(G=!1,n.setGroups())},5e3)),"disconnected"==pt[t][window.localStorage.getItem("apikeypublic")].quote_id&&(z.child(t+"/queue/"+window.localStorage.getItem("apikeypublic")+"/disconnectTime").remove(),z.child(t+"/queue/"+window.localStorage.getItem("apikeypublic")).update({quote_id:"",lat:M.lat,lon:M.lon})),pt[t]&&pt[t][window.localStorage.getItem("apikeypublic")]&&at.indexOf(Ot[bt[g].groupPosition].category_id)<0){var w=!1;if(!nt[Ot[bt[g].groupPosition].category_id]){var b=n.withinZone(Ot[bt[g].groupPosition].category_id,null,null,null,null,null,pt[t][window.localStorage.getItem("apikeypublic")].zone_id);b||(b=n.withinZone(Ot[bt[g].groupPosition].category_id,!0)),nt[Ot[bt[g].groupPosition].category_id]=b}at.indexOf(Ot[bt[g].groupPosition].category_id)<0&&(at.push(Ot[bt[g].groupPosition].category_id),z.child(g+"/queue").orderByChild("timestamp").once("value",function(e){w=e})),!M.listenedQueue&&pt[t]&&pt[t][window.localStorage.getItem("apikeypublic")]&&te.indexOf(t)<0&&n.updateFbUUID(pt[t][window.localStorage.getItem("apikeypublic")].uuid,t),at.indexOf(t)<0&&n.autoBookFunc(),w&&n.queueListener(w)}}0==M.bookingIn.length&&M.$broadcast("loading:hide"),n.processFirebase()}pt[t]&&pt[t][window.localStorage.getItem("apikeypublic")],pt[t]&&pt[t][window.localStorage.getItem("apikeypublic")]&&te.indexOf(t)<0&&mt[window.localStorage.getItem("apikeypublic")]&&mt[window.localStorage.getItem("apikeypublic")][t]&&M.listenedQueue&&!i.get("UUIDService").matchesMyUUID(pt[t][window.localStorage.getItem("apikeypublic")].uuid)&&(n.resetVariables(),E.transitionTo("app.quoteform"))},updateQP:function(e,t){var o=this;(pt[t]&&pt[t][window.localStorage.getItem("apikeypublic")]&&!pt[t][window.localStorage.getItem("apikeypublic")].hasOwnProperty("QP")||e!=pt[t][window.localStorage.getItem("apikeypublic")].QP)&&(oe.indexOf(t)<0&&oe.push(t),z.child(t+"/queue/"+window.localStorage.getItem("apikeypublic")+"/QP").set(e,function(e){e||z.child(t+"/queue").orderByChild("timestamp").once("value",function(e){o.queueListener(e)}),oe.splice(oe.indexOf(t),1)}))},updateFbUUID:function(e,t){var o=T.defer(),r=this;if(!i.get("UUIDService").matchesMyUUID(e)&&pt[t]&&pt[t][window.localStorage.getItem("apikeypublic")]){te.indexOf(t)<0&&te.push(t);var n=this.withinZone(t,null,null,null,null,null,pt[t][window.localStorage.getItem("apikeypublic")].zone_id),a={uuid:p.uuid,lat:M.lat,lon:M.lon};n||(n=this.withinZone(t,!0)),n&&(a.zone_id=n.id,ee[t]=n.id),z.child(t+"/queue/"+window.localStorage.getItem("apikeypublic")).update(a,function(e){e||z.child(t+"/queue").orderByChild("timestamp").once("value",function(e){r.queueListener(e)}),te.splice(te.indexOf(t),1),o.resolve()})}else o.resolve();return o.promise},updateQueue:function(e,t,o,i,r){var n=this;if(e){var a=z.child(e+"/queue/"+window.localStorage.getItem("apikeypublic"));if("inside"==t&&o){var s={lat:M.lat,lon:M.lon,zone_id:o};o!=pt[e][window.localStorage.getItem("apikeypublic")].zone_id&&(s.timestamp=Firebase.ServerValue.TIMESTAMP),a.update(s,function(t){!t&&Ot.length>0&&(Ot[bt[e].groupPosition].zone_id=o,n.setGroups(),z.child(e+"/queue").orderByChild("timestamp").once("value",function(e){n.queueListener(e)})),n.autoBookFunc()})}else"update"==t?0==Z&&(a.update({lat:M.lat,lon:M.lon},function(e){e||n.setGroups()}),r.indexOf(e)==r.length-1&&n.resetLatLon()):n.isDispatcherAdmin(e)||Y?(z.child(e+"/queue").orderByChild("timestamp").once("value",function(e){n.queueListener(e)}),a.update({lat:M.lat,lon:M.lon,zone_id:e},function(t){t||(n.setGroups(),ee[e]=e)})):(bt[e]&&n.toggleBook(!1,Ot[bt[e].groupPosition],null,null,!0),a.remove(function(t){t||(bt[e]&&(Ot[bt[e].groupPosition].zone_id=e),n.setGroups(),z.child(e+"/queue").orderByChild("timestamp").once("value",function(e){n.queueListener(e)})),n.autoBookFunc()}))}},setStoredZones:function(e,t,o){var i,r=this;if(e){if("inside"!=t)return ee[o]&&ee[o]==e.id||(ee[o]=e.id),i=st.indexOf(e.id),void(i>-1&&(st.splice(i,1),0==st.length&&r.updateQueue(o,"remove",e.id,e)));if(st.indexOf(e.id)<0&&st.push(e.id),ee[o]&&ee[o]==e.id)return;ee[o]=e.id,st.forEach(function(i){ee[o]==i&&r.updateQueue(o,t,i,e)})}},autologinApi:function(){var e=this;x.get(q+"autologin/?"+s.getAutoLoginParams()).success(function(t){if("failed"==t.status.toLowerCase())e.resetVariables(),E.transitionTo("app.quoteform");else{var o=t.user.zone_id;1==o.length&&"object"==typeof o[0]&&(ae=!1,M.$broadcast("firebaseInitialized"),M.noGroups=!0,M.startupLoading=!1,M.$broadcast("loading:hide"),M.loggedIn?E.transitionTo("app.employee-index"):E.transitionTo("app.login"))}})},autologin:function(){var e=this,t=T.defer(),o=function(o){x.get(q+"autologin/?"+s.getAutoLoginParams()).success(function(o){if("Success"==o.status){if(ut=o.user.zone_id,e.setGlobalGroups(),o.user.groups.ancestors.group_id.forEach(function(e){""!=e&&ut.indexOf(e)<0&&ut.push(e)}),null!=Ot)for(var i=0;i<Ot.length;i++)0==Ot[i].dispatcher&&Ot[i].apikeypublic==window.localStorage.getItem("apikeypublic")&&lt.indexOf(Ot[i].zone_id)<0;p.isDriver&&e.setGroups(),p.token={},p.token.time=moment(),p.token.token=o.user.token,t.resolve(p.token.token)}else t.reject(o.status);M.$broadcast("autologin")}).error(function(e){})};return o(0),t.promise},getVehiclesPermits:function(e,t){var o=T.defer();if(M.myVehicles&&!e)o.resolve();else{t||M.$broadcast("loading:show");var i=function(e){x.get(q+"vehicles/?"+s.getAutoLoginParams(),{data:{show:!1}}).success(function(e){M.myVehicles=e.vehicles.filter(function(e){return moment(e.permit_expiry_date).isValid()&&moment(e.title_expiry_date).isValid()}),M.myPermits=e.permits.filter(function(e){return moment(e.permit_expiry_date).isValid()}),M.profileItems(),o.resolve()}).error(function(e){o.reject(e)})};i(0)}return o.promise},logOut:function(){var e=T.defer(),t=this,o=e.promise;return x.get(q+"logout/?"+s.getParams()).success(function(o){t.resetVariables(),M.$broadcast("user:updated",!Se),e.resolve(o)}).error(function(t){e.reject(t)}),o.success=function(e){return o.then(e),o},o.error=function(e){return o.then(null,e),o},o},logoutUser:function(e,t,o){x.get(q+"logout/?apikeypublic="+e+"&lat="+t+"&lon="+o+"&uuid="+p.uuid+"&app_id="+Tt,{data:{show:!1}}).success(function(e){}).error(function(e){})},addGroup:function(e,t){var o=T.defer(),i=this,r=function(){var r=e.allow_queue?"yes":"no",l=e.zone_based_queuing?"yes":"no",u=q+"addGroup/?name="+e.name+"&description=''&status="+e.active+"&default_name=&offer="+e.offer+"&allow_remote_reservation="+e.allow_remote_reservation+"&allow_advance_reservation="+e.allow_advance_reservation+"&zone_based_queuing="+l+"&allow_queue="+r+"&jail="+e.jail+"&"+e.services.join("&")+"&"+e.tags.join("&")+"&"+s.getParams();void 0!=e.id&&(u+="&id="+e.id),void 0!=e.pic&&(u+="&pic=https://yd.firebaseio.com/images/"+window.localStorage.getItem("apikeypublic")+"/group"),e.lat&&(u+="&lat="+e.lat+"&lon="+e.lon+"&radius="+e.radius),x.get(u).success(function(r){e.id||t||i.addDispatcherItem({name:p.name,email:p.email,category_id:r.group_id,cellPhone:111111,active:1,itemType:"Admin"}),e.pic&&i.savePic(e.pic,"group",r.group_id).then(function(){},function(e){o.reject(e)}),e.id?o.resolve(r):(e.id=r.group_id,a(e),n.length>0?T.all(n)["finally"](function(e){o.resolve(r)}):o.resolve(r)),M.noGroups=!1}).error(function(e){o.reject(e)})},n=[],a=function(e){void 0!=e.pic&&n.push(this.savePic(e.pic,"group")),e.id&&(e.centers&&e.centers.length>0&&n.push(i.saveMarket(e.centers,e.id)),e.zones&&e.zones.length>0&&n.push(i.saveZones(e.zones,e.id)),e.zonesDelete&&e.zonesDelete.length>0&&n.push(i.deleteZones(e.zonesDelete,e.id)),e.toSaveRateplans&&e.toSaveRateplans.length>0&&n.push(i.savePlan(e.toSaveRateplans,e.id)))},l=function(e){a(e),0!=n.length&&e.id?T.all(n).then(function(e){r()}):r()};return l(e),o.promise},saveMarket:function(e,t){var o=T.defer(),i=z.child(t+"/zones/latlon"),r={};return r=$.extend({},e),r=angular.fromJson(angular.toJson(r)),
i.update(r,function(e){e?o.reject(e):o.resolve()}),o.promise},saveZones:function(e,t){var o=T.defer();return e.forEach(function(i,r){var n=q+"zones/?circles=true&group_id="+t+"&id="+i.id+"&name="+i.name+"&zlat="+i.lat+"&zlon="+i.lon+"&radius="+i.radius+"&zone_radius="+i.zone_radius+"&"+s.getParams();x.get(n).success(function(t){r==e.length-1&&o.resolve(t)}).error(function(e){o.reject(e)})}),o.promise},deleteZones:function(e,t){var o=T.defer();return e.forEach(function(i,r){var n=q+"zones/?circles=true&group_id="+t+"&delete="+i.id+"&"+s.getParams();x.get(n).success(function(t){r==e.length-1&&o.resolve(t)}).error(function(e){o.reject(e)})}),o.promise},savePlan:function(e,t){var o=T.defer();return e.forEach(function(i,r){var n=q+"rates/?group_id="+t+"&name="+i.name+"&"+i.rateplan.join("&")+"&"+s.getParams();void 0!=i.id&&(n+="&id="+i.id),x.get(n).success(function(t){r==e.length-1&&o.resolve(t)}).error(function(e){o.reject(e)})}),o.promise},fetchPlans:function(e){var t=T.defer(),o=q+"rates/?group_id="+e+"&"+s.getParams();return x.get(o).success(function(e){"Failed"!=e.status?t.resolve(e):t.reject(e)}).error(function(e){t.reject(e)}),t.promise},getTagsRatePlan:function(e,t){var o=[];return t&&(o=rt[e]?t.filter(function(t){return Ae.hasOwnProperty(t)&&rt[e].indexOf(t)<0}):t.filter(function(e){return Ae.hasOwnProperty(e)})),o},hasRatePlanServ:function(e,t){var o=!1;return t&&(t.indexOf("Driver")<0?o=!0:rt[e]&&(o=t.some(function(t){return Ae.hasOwnProperty(t)&&rt[e].indexOf(t)>-1}))),o},hasServType:function(e){var t=!0;return e.indexOf("Driver")>-1&&(t=e.some(function(e){return Ae.hasOwnProperty(e)})),t},resetVariables:function(){Se=!0,this.clearAutoBookInt(),ne=!1,wt=!1,It=!1,re=!1,ft={},dt.length=0,_t={},mt={},pt={},be={},nt={},st.length=0,p.savedTimeStamps={},firebaseInitialized=!1,M.itemBooked=0,M.itemNotBooked=0,M.isTripStarted=!1,M.showQuoteForm=!1,M.creditCards.length=0,M.vehiclePermitData=null,M.vehiclePermit=null,M.myVehicles=null,M.myPermits=null,delete p.stripe,delete p.name,delete p.isDriver,window.localStorage.removeItem("quote_Id"),delete p.token,delete p.quoteID,delete p.picData,delete p.permit,delete p.vehicle,delete p.myDriverRating,delete p.myCustomerRating,delete p.acceptedOrders,M.tripsInProgress.length=0,M.picData=null,M.myDriverRating=null,M.myCustomerRating=null,p.quoteQMode=p.partnersQMode=p.dispatcherQMode=null,this.setGlobalQMode(),bt={},Ot&&(Ot.length=0),M.bookingIn.length=M.bookingOut.length=0,F.length=0,Ee=!1,setTimeout(function(){ct.forEach(function(e,t){var o=this;z.child(e+"/queue").orderByChild("timestamp").once("value",function(e){o.queueListener(e)})},this)}.bind(this)),window.localStorage.removeItem("apikeypublic"),M.loggedIn=!1,M.listenedQueue=!1,M.offerDetail=null,M.hasDriverQP=!1,M.detail=null,M.tripModal=null,ee={},at.length=0,M.globalDriver=!1},forgotPassword:function(e){var t=T.defer(),o=t.promise;return this.setLatLon().then(function(){x.get(q+"reminder/?email="+e.email+"&"+s.getParams()).success(function(e){t.resolve(e)}).error(function(e){t.reject(e)})}),o.success=function(e){return o.then(e),o},o.error=function(e){return o.then(null,e),o},o},signUp:function(e){var t=T.defer(),o=t.promise,i=q+"signup/?name="+e.name+"&email="+encodeURIComponent(e.email)+"&phone="+e.phone+"&password="+e.password+"&confirm_password="+e.confirmPassword+"&disclaimer=1&"+s.getParams();return null!=e.referred&&(i+="&coupon="+e.referred),x.get(i).success(function(e){t.resolve(e)}).error(function(e){t.reject(e)}),o.success=function(e){return o.then(e),o},o.error=function(e){return o.then(null,e),o},o},changePassword:function(e){var t=T.defer(),o=q+"profile/?password[]="+e.oldpassword+"&password[]="+e.newpassword+"&"+s.getParams();return x.get(o).success(function(e){t.resolve(e)}).error(function(e){t.reject(e)}),t.promise},saveVehicle:function(e){var t=T.defer(),o=this,i=function(){var o=q+'profile/?vehicle["vin_number"]='+e.vin+'&vehicle["make"]='+e.make+'&vehicle["model"]='+e.model+'&vehicle["year"]='+e.year+'&vehicle["type"]='+e.type+'&vehicle["color_exterior"]='+e.exterior+'&vehicle["color_inside"]='+e.interior+'&vehicle["seats"]='+e.seats+'&vehicle["mileage"]='+e.mileage+'&vehicle["plate_number"]='+e.plate+'&vehicle["insurance"]=https://yd.firebaseio.com/images/'+window.localStorage.getItem("apikeypublic")+'/insurance&vehicle["permit_expiry_date"]='+moment(e.permit_expiry,"MM/DD/YY").format("YYYY-MM-DD")+'&vehicle["inspection_expiry_date"]=https://yd.firebaseio.com/images/'+window.localStorage.getItem("apikeypublic")+'/inspection_expiry_date&vehicle["title_expiry_date"]='+moment(e.title_expiry,"MM/DD/YY").format("YYYY-MM-DD")+"&"+s.getParams();$.get(o,function(e){t.resolve(e)}).fail(function(e){t.reject(e)})};return o.savePic(e.insurance,"insurance").then(function(){o.savePic(e.inspection_expiry_date,"inspection_expiry_date").then(function(){i()},function(e){t.reject(e)})},function(e){t.reject(e)}),t.promise},saveDriverInfo:function(e){var t=T.defer(),o=this,i=function(){var o=q+'profile/?driver["license_number"]='+e.license+'&driver["permit_expiry_date"]='+moment(e.expiry,"MM/DD/YY").format("YYYY-MM-DD")+'&driver["permit_cities"]='+e.permit_cities+'&driver["permit_city"]=https://yd.firebaseio.com/images/'+window.localStorage.getItem("apikeypublic")+'/permit_city&driver["permit_upload"]=https://yd.firebaseio.com/images/'+window.localStorage.getItem("apikeypublic")+'/permit&driver["license_upload"]=https://yd.firebaseio.com/images/'+window.localStorage.getItem("apikeypublic")+"/license&"+s.getParams();$.get(o,function(e){t.resolve(e)}).fail(function(e){t.reject(e)})};return void 0==e.permit_cities||""==e.permit_cities?(e.permit_upload=M.myPermits[0].permit_uploaded,e.permit_expiry_date=moment(M.myPermits[0].permit_expiry_date).format("MM-DD-YYYY"),e.permit_cities=M.myPermits[0].permit_cities):(void 0==e.license||""==e.license)&&(e.license_upload=M.myPermits[0].license_uploaded,e.license=M.myPermits[0].license_number,e.permit_city=M.myPermits[0].permit_city),o.savePic(e.permit_upload,"permit").then(function(){o.savePic(e.permit_city,"permit_city").then(function(){o.savePic(e.license_upload,"license").then(function(){i()},function(e){t.reject(e)})},function(e){t.reject(e)})},function(e){t.reject(e)}),t.promise},savePOI:function(e,t){var o=T.defer(),i=q+"poi/?name[]="+e.name+"&place_type="+e.type+"&address[]="+e.address+"&latitude[]="+e.lat+"&longitude[]="+e.lng+"&"+s.getParams();return t&&(i+="&delete=1"),x.get(i).success(function(e){o.resolve(e)}).error(function(e){o.reject(e)}),o.promise},getPOIs:function(e){var t=T.defer(),o=q+"pois/?"+s.getParams();return x.get(o).success(function(e){t.resolve(e),e.hasOwnProperty("pois")&&(M.pois=e.pois)}).error(function(e){t.reject(e)}),t.promise},getTags:function(e,t){void 0==e&&(e=Tt);var o=T.defer(),i=q+"tags/?app_id="+e+"&"+s.getParams();return t&&(i+="&group_id[]="+t),x.get(i).success(function(e){o.resolve(e),M.tags=e.tags,Ce={},e.tags.forEach(function(e){Ce.all={},ze.all={},Ce.hasOwnProperty(e)||(Ce[e]={}),ze.hasOwnProperty(e)||(ze[e]={})}),Ae=angular.copy(Ce),M.bidOnDrivers.length=0}).error(function(e){o.reject(e)}),o.promise},setServices:function(e,t,o,i,r,n,a,s,l,u){if(null!=e){if(0==Object.keys(e).length)return o.length=0,i="",void(r&&r(o));var c=(a?a.split(","):[],[]);e[Object.keys(e)[0]].tags.forEach(function(o){t.indexOf(o)>-1&&(void 0==n||e[Object.keys(e)[0]].group_id==n)&&("removed"==s?l[o]--:"added"==s&&l[o]++)});for(var d in l)l[d]>0&&u.indexOf(d)<0?(u.push(d),o.push({id:d,text:d,"class":"taxicar",checked:!1,icon:"pics/taxi.png"})):0==l[d]&&u.indexOf(d)>-1&&(u.splice(u.indexOf(d),1),o.splice(u.indexOf(d),1));if(""!=i&&void 0!=i){var f=i.split(",");i.split(",").forEach(function(e,t){var o=u.indexOf(e);0>o&&(c.push(e),f.splice(t,1))}),c.length>0&&(i=f.join(","),c=c.join(", "))}r&&r(o,i.length>0?i:null,c.length>0?c:null)}},matchesTags:function(e,t){var o=0==t.length;return!o&&e&&(o=e.tags.some(function(e){return t.indexOf(e)>-1})),o},setPic:function(){p.picData&&p.picData!=M.picData&&(M.picData=p.picData,$(".menuheadericon").hasClass("ion-mypic")||$(".menuheadericon").addClass("ion-mypic"),$(".menuheadericon").css("background","url("+M.picData+") no-repeat"))},saveDriverPic:function(e,t){var o=T.defer(),i=this,r=q+"profile/?"+s.getParams()+"&ownpic=https://yd.firebaseio.com/images/"+window.localStorage.getItem("apikeypublic")+"/"+t;return i.savePic(e,t).then(function(){dt.forEach(function(t){var o=z.child(t+"/queue/"+window.localStorage.getItem("apikeypublic"));o.update({pic:e},function(e){i.findAllEmployees()})}),x.get(r).success(function(t){o.resolve(t),p.picData=e,M.picData=e}).error(function(e){o.reject(e)})},function(e){o.reject(e)}),o.promise},resetLatLon:function(){M.oldlat=M.lat,M.oldlon=M.lon},resetOldLatLon:function(){M.lat=null,M.lon=null},reconnectTimer:function(){R&&D.cancel(R),R=D(function(){R=null,M.showingLoader&&"RECONNECTING"==M.loadingMsg&&window.location.reload(!0)},25e4)},internetGPSReconnected:function(){var e=this;if(e.setLatLon(),e.setServerOffset(),!M.app_suspended){M.$broadcast("loading:show",{text:"RECONNECTING"}),this.reconnectTimer(),xt&&e.autoBookIn(),e.autoBookFunc(!0),n.mapsInitialized().then(function(){M.$broadcast("gmaps:loaded")});var t=function(t){ae?(M.loggedIn&&e.getVehiclesPermits(null,!0),e.authenticateFirebase()):e.findAllEmployees().then(function(t){e.autologin().then(function(t){M.$broadcast("loading:hide"),!M.loggedIn||M.onQuotePage||It?(e.processFirebase(),M.$broadcast("loading:hide")):p.isDriver?e.getVehiclesPermits().then(function(){}):(e.processFirebase(),M.$broadcast("loading:hide"))},function(){})},function(){})};t(0)}},setLatLon:function(){var e=this,t=T.defer(),o=function(o){D(function(){if(L&&D.cancel(L),Me||e.setGPSWatch(),xe&&(M.$broadcast("gpssuccess",null),I.cancel(xe),xe=null),M.isGpsOff&&D(function(){M.isGpsOff=!1,M.isOffline||(M.hideLoader(),e.internetGPSReconnected())}),null!=M.lat){if(!(o.coords.accuracy<200||e.getGPSDistance(o.coords.latitude,o.coords.longitude,M.lat,M.lon)<.5))return;M.lat=Number(o.coords.latitude.toFixed(4)),M.lon=Number(o.coords.longitude.toFixed(4))}else M.lat=Number(o.coords.latitude.toFixed(4)),M.lon=Number(o.coords.longitude.toFixed(4));window.localStorage.setItem("lat",M.lat),window.localStorage.setItem("lon",M.lon),M.tz||e.getTimeZone(M.lat,M.lon).then(function(e){M.tz=e.timeZoneId,ht=-(e.rawOffset+e.dstOffset)/60}),M.$broadcast("location:updated",null),null==M.oldlat&&e.resetLatLon(),null==window.localStorage.getItem("countryCode")&&e.getCountryCityState(),t.resolve("success")})},i=function(o){M.$broadcast("gpserror",null),e.cancelOfferTimeout(),e.clearAutoBookInt(),null==xe&&e.startGpsCheck(),D(function(){M.isGpsOff||M.isOffline||(ionic.Platform.isWebView()&&w.vibrate(500),M.showMsg("GPS_OFF")),M.isGpsOff=!0}),t.reject(o)};return S.getCurrentPosition(l.geoOptions).then(function(e){o(e)},function(e){ionic.Platform.isWebView()&&i(e)}),L||(L=D(function(){M.isGpsOff=!0,i()},3e4)),t.promise},getCountryCityState:function(){$.ajax({url:"https://maps.googleapis.com/maps/api/geocode/json?latlng="+M.lat+","+M.lon+"&sensor=false",type:"GET",success:function(e){"OK"==e.status&&(e.results[0].address_components.forEach(function(e,t){"country"==e.types[0]&&(M.countryCode=e.short_name,M.country=e.long_name),"administrative_area_level_1"==e.types[0]&&(M.state=e.long_name),"administrative_area_level_2"==e.types[0]&&(M.city=e.long_name)}),window.localStorage.setItem("countryCode",M.countryCode))}})},startGpsCheck:function(){var e=this;xe=I(function(){e.setLatLon()},1e4)},setGPSWatch:function(){var e=this;Me=!0;var t=function(t){(ionic.Platform.isWebView()&&t.coords.accuracy<100||!ionic.Platform.isWebView()&&t.coords.accuracy<200||e.getGPSDistance(t.coords.latitude,t.coords.longitude,M.lat,M.lon)<.5)&&(M.lat=Number(t.coords.latitude.toFixed(4)),M.lon=Number(t.coords.longitude.toFixed(4)),(window.localStorage.getItem("lat")!=M.lat||window.localStorage.getItem("lon")!=M.lon)&&(window.localStorage.setItem("lat",M.lat),window.localStorage.setItem("lon",M.lon),e.autoBookFunc(),M.$broadcast("location:updated",null)),xe&&(M.$broadcast("gpssuccess",null),I.cancel(xe),xe=null))},o=function(t){M.$broadcast("gpserror",null),Me=!1,null==xe&&e.startGpsCheck()},i=S.watchPosition({enableHighAccuracy:!0});i.then(null,function(e){o(e)},function(e){t(e)})},toggleBook:function(e,t,o,i,r){var n=this,a=T.defer(),s=!1;It||M.$broadcast("loading:show",{show:r!==!1,text:e?"BOOKING_IN":"BOOKING_OUT"});var l=function(r){if(r.items.every(function(e){return e.dispatcher<1&&e.apikeypublic==window.localStorage.getItem("apikeypublic")&&e.overdue?(e.overdue.group<0&&(s=e.overdue.group),!1):!0}),s){if(M.$broadcast("loading:hide"),a.reject(),o)return;return void d(["SORRY","APP_OVERDUE1","APP_OVERDUE2"]).then(function(e){k.alert({title:e.SORRY,template:e.APP_OVERDUE1+Math.abs(s)+e.APP_OVERDUE2})})}if("all"==t){var l=e?"2":"-2",u=0;angular.forEach(Ot,function(e){e.dispatcher>0&&bt.hasOwnProperty(e.zone_id)&&1==Ot[bt[e.zone_id].position].active&&(Ot[u].status=l),u++})}else if(Object.getPrototypeOf(t)===Array.prototype){var l=e?"2":"-2";dt.forEach(function(e,t){bt.hasOwnProperty(e)&&(Ot[bt[e].groupPosition].status=l)})}1==e?n.bookIn(t,i).then(function(e){a.resolve(e)},function(){D(function(){M.$broadcast("loading:hide")},500)}):n.bookOut(t,i).then(function(e){a.resolve(e),M.$broadcast("loading:hide")})};return Ot&&(0==Ot.length?n.findAllEmployees().then(function(e){l(e)}):l({items:Ot})),a.promise},clearAutoBookInt:function(){I.cancel(Fe)},getWithinZoneObj:function(e){var t,o=this,i=5e4;return it[e].some(function(e){return"string"!=typeof e.lat&&o.is_in_zone(e.lat,e.lon,M.lat,M.lon)?(t=e,!0):void("string"==typeof e.lat&&o.arePointsNear({lat:M.lat,lon:M.lon},{lat:e.lat,lon:e.lon},e.radius)&&i>(dist=o.getGPSDistance(e.lat,e.lon,M.lat,M.lon))&&(i=dist,t=e))}),t},pickupCenterZone:function(e,t,o){var i=[];for(var r in it){if(i.length>0&&o)break;(!o||o&&r==o)&&it[r].forEach(function(o){Number(e).toFixed(4)==Number(o.lat).toFixed(4)&&Number(t).toFixed(4)==Number(o.lon).toFixed(4)&&i.push(o.id)})}return 0==i.length?!1:i},withinZone:function(e,t,o,i,r,n,a){if(!e||!it[e])return!0;var s,l=this,u=5e4,c=o||M.lat,d=i||M.lon;return it[e].some(function(e){if(!a||a==e.id){if("string"!=typeof e.lat&&l.is_in_zone(e.lat,e.lon,c,d)&&(!r||r&&l.is_in_zone(e.lat,e.lon,r,n)))return s=e;if("string"==typeof e.lat&&l.arePointsNear({lat:c,lon:d},{lat:e.lat,lon:e.lon},e.radius)&&(!r||r&&l.arePointsNear({lat:r,lon:n},{lat:e.lat,lon:e.lon},e.radius))){if(!t)return s=e;u>(dist=l.getGPSDistance(e.lat,e.lon,M.lat,M.lon))&&(u=dist,s=e)}}}),s},withinGreenZone:function(e,t,o,i,r){if(!e)return!0;var n=this,a=!1,s=o||M.lat,l=i||M.lon;return it[e].some(function(e){return!r&&e.id==t||r==e.id==t?"string"!=typeof e.lat?a=!0:n.arePointsNear({lat:s,lon:l},{lat:e.lat,lon:e.lon},e.zone_radius)?a=e:!0:void 0}),a},updateSettings:function(e){e.id&&z.child(e.id+"/queue").orderByChild("timestamp").once("value",function(t){var o=t.ref().parent().key();t.forEach(function(t){var i=z.child(o+"/queue/"+t.key()+"/settings");i.update({allow_advance_reservation:e.allow_advance_reservation,allow_queue:e.allow_queue?"yes":"no",allow_remote_reservation:e.allow_remote_reservation,zone_based_queuing:e.zone_based_queuing,offer:e.offer,jail:e.jail},function(e){})})})},autoBookFunc:function(e){if(!this.isInitializingFB()&&M.listenedQueue){var t,o=this,i=[];kt=o.getGPSDistance(M.oldlat,M.oldlon,M.lat,M.lon),dt.forEach(function(r){var n=nt[r],a=angular.copy(n);it.hasOwnProperty(r)&&(n&&!e||!pt[r]||(n=nt[r]=o.withinZone(r,null,null,null,null,null,pt[r][window.localStorage.getItem("apikeypublic")].zone_id)),n&&n.lat&&("string"!=typeof n.lat&&o.is_in_zone(n.lat,n.lon,M.lat,M.lon)||"string"==typeof n.lat&&o.arePointsNear({lat:M.lat,lon:M.lon},{lat:n.lat,lon:n.lon},n.radius))?(t=r,o.setStoredZones(n,"inside",r)):(!M.detail||M.detail&&M.detail.zone_id!=r)&&((nt[r]=o.withinZone(r,!0))?(t=r,o.setStoredZones(nt[r],"inside",r)):o.isDispatcherAdmin(r)||M.offerDetail&&M.offerDetail.zone_id==r||o.setStoredZones(a,"outside",r))),!nt[r]&&pt[r]&&pt[r][window.localStorage.getItem("apikeypublic")].zone_id!=r&&(nt[r]=n,o.updateQueue(r,"remove")),i.indexOf(t)<0&&i.push(t),i.indexOf(r)<0&&i.push(r)}),i.forEach(function(e,t,i){(It||kt>l.significantMiles)&&o.updateQueue(e,"update",null,null,i)}),!Se&&kt>l.significantMilesGuest&&o.resetLatLon()}},withinRadiusZone:function(e,t,o,i){if(!e)return!0;var r=this,n=!1,a=t||M.lat,s=o||M.lon,l=Ot[bt[e].groupPosition];return!l.settings||l.settings&&"yes"==l.settings.zone_based_queuing||Ot[bt[e].position].tags.indexOf("Driver")<0?!0:(n=r.arePointsNear({lat:a,lon:s},{lat:l.settings.lat,lon:l.settings.lon},l.settings.radius),n||i||it[e].some(function(e){return r.is_in_zone(e.lat,e.lon,a,s)?n=!0:void 0}),n)},isRadiusBased:function(e){var t=Ot[bt[e].groupPosition];return t.settings&&"no"==t.settings.zone_based_queuing},autoBookIn:function(){Fe=I(function(){},l.autoBookInterval)},getGPSDistance:function(e,t,o,i){var r=parseFloat(Math.PI*e/180),n=parseFloat(Math.PI*o/180),a=(parseFloat(Math.PI*t/180),parseFloat(Math.PI*i/180),t-i),s=Math.PI*a/180,l=Math.sin(r)*Math.sin(n)+Math.cos(r)*Math.cos(n)*Math.cos(s);return l=Math.acos(l),l=180*l/Math.PI,l=60*l*1.1515},arePointsNear:function(e,t,o){var i=4e4/360,r=Math.cos(Math.PI*t.lat/180)*i,n=Math.abs(t.lon-e.lon)*r,a=Math.abs(t.lat-e.lat)*i;return Math.sqrt(n*n+a*a)<=1.609344*o},getGroupZone:function(e,t,o,i){var r,n=[],a=[],s=[],l=[];if("string"==typeof e||Object.getPrototypeOf(e)===Object.prototype){"all"!=e&&n.indexOf("group_id[]="+e.category_id)<0&&n.push("group_id[]="+e.category_id);for(var u in bt)u==bt[u].category_id&&(r=this.withinZone(bt[u].category_id,!0),o&&(!o||Ot[bt[u].groupPosition].limit)||t&&!(t&&bt[u].can_bookin&&(!Ot[bt[u].groupPosition].require_upload||Ot[bt[u].groupPosition].require_upload&&M.vehiclePermit&&M.vehiclePermit.permit)&&(this.isDispatcherAdmin(u)||this.hasServType(bt[u].tags)&&this.hasRatePlanServ(bt[u].category_id,bt[u].tags)&&(i||r||!Ot[bt[u].groupPosition].my_tags||Ot[bt[u].groupPosition].my_tags.indexOf("Driver")<0)&&Ot[bt[u].groupPosition].allow_queue&&(Ot[bt[u].position].tags.indexOf("Driver")>-1||Ot[bt[u].position].tags.indexOf("Admin")>-1||Ot[bt[u].position].tags.indexOf("Dispatcher")>-1)))||(r=r||{id:bt[u].category_id}||it[bt[u].category_id]&&it[bt[u].category_id][0],r&&("all"==e?1!=r&&(o||t&&dt.indexOf(bt[u].category_id)<0||!t&&dt.indexOf(bt[u].category_id)>-1)&&(bt[u].can_bookin>0&&1==Ot[bt[u].position].active&&n.indexOf("group_id[]="+bt[u].category_id)<0&&n.push("group_id[]="+bt[u].category_id),s.push("item_id[]="+bt[u].item_id),a.push("zone_id["+bt[u].category_id+"]="+r.id),l.push(bt[u].zone)):e.category_id==bt[u].category_id&&(s.push("item_id[]="+bt[u].item_id),a.push("zone_id["+bt[u].category_id+"]="+r.id),l.push(bt[u].zone)))))}else dt.forEach(function(e,t){bt.hasOwnProperty(e)&&(n.push("group_id[]="+bt[e].category_id),s.push("item_id[]="+bt[e].item_id),a.push("zone_id[]="+bt[e].category_id))});return{group:n,zoneId:a,item:s,zone:l}},addContacts:function(e){var t=T.defer(),o=q+"refer/?"+e.join("&")+"&"+s.getParams();return x.get(o).success(function(e,o){t.resolve(e)}).error(function(e){t.reject(e)}),t.promise},complaint:function(e){var t=T.defer(),o=q+"help/?subject="+e.subject+"&deptid="+e.deptid+"&priority="+e.priority+"&message="+e.message+"&"+s.getParams();return x.get(o).success(function(e,o){t.resolve(e)}).error(function(e){t.reject(e)}),t.promise},dispatcherBook:function(e,t){var o=this,i=T.defer();ke=!0;var r=1==t?"bookin":"bookout",n=q+r+"/?apikeypublic="+e.apikeypublic+"&group_id[]="+e.category_id+"&zone_id[]="+e.zone_id+"&item_id[]="+e.item_id+"&uuid="+ionic.Platform.device().uuid+"&lat="+e.lat+"&lon="+e.lng;return x.get(n).success(function(e,t){o.processFirebase(),i.resolve(e)}).error(function(e){i.reject(e)}),i.promise},deleteDispatcherItem:function(e){var t=this,o=T.defer();return x.get(q+"deleteItem/?apikeypublic="+window.localStorage.getItem("apikeypublic")+"&item_id="+e.item_id+"&group_id="+e.category_id+s.getParams()).success(function(e,i){o.resolve(e),t.processFirebase()}).error(function(e){o.reject(e)}),o.promise},addDispatcherItem:function(e){var t=this,o=T.defer(),i=q+"addItem/?item_id=0&group_id="+e.category_id+"&name="+e.name+"&email="+e.email+"&cellPhone="+e.cellPhone+"&active="+e.active+"&itemType[]="+e.itemType+"&"+s.getAutoLoginParams();return void 0!=e.password&&(i+="&password="+e.password),x.get(i).success(function(e,i){o.resolve(e),t.processFirebase()}).error(function(e){o.reject(e)}),o.promise},editDispatcherItem:function(e){var t=this,o=T.defer(),i=q+"editItem/?item_id="+e.item_id+"&group_id="+e.category_id+"&name="+e.firstName+" "+e.lastName+"&email="+e.email+"&cellPhone="+e.cellPhone+"&active="+e.active+"&"+s.getAutoLoginParams();return e.itemType&&(i+="&itemType[]="+e.itemType),e.itemTypeOld&&(i+="&itemTypeOld[]="+e.itemTypeOld),x.get(i).success(function(e,i){o.resolve(e),t.processFirebase()}).error(function(e){o.reject(e)}),o.promise},quoteDispatcher:function(e){function t(e,t){t=t&&t.toLowerCase();for(var o="",i=0,r="a"==t?10:0,n="n"==t?10:62;i++<e;){var a=Math.random()*(n-r)+r<<0;o+=String.fromCharCode(a+=a>9?36>a?55:61:48)}return o}var o=this,i=T.defer();this.setQuoteDateTime(e);var r=q+"quote/?"+s.getParams()+"&"+e.items.join("&")+"&group_id[]="+e.group_id+"&_token="+t(40)+("&tripfrequency=oneway&"+e.splitFare.join("&")+'&sent_to_message=""&eta_distance[]='+e.estDistVal+"&eta_time[]="+e.estTimeVal+"&pickup[]="+e.pickup.formatted_address+"&pickup_lat[]="+e.pickup.lat+"&pickup_lon[]="+e.pickup.lon+"&dropoff[]="+e.dropoff.formatted_address+"&dropoff_lat[]="+e.dropoff.lat+"&dropoff_lon[]="+e.dropoff.lon+"&route_distance[]="+e.distance+"&selectDate[]="+e.date+"&selectTime[]="+e.time+"&selectPeople[]="+e.people+"&note[]="+e.note+"&selectPrice[]="+(e.price||l.defaultPrice)+"&selectService[]="+e.service+"&qmode="+(e.mode||M.dispatcherQMode)+"&mode=route&status=").replace(/ /g,"+").replace(/,/g,"%2C").replace(/[[]/g,"%5B0").replace(/[\]]/g,"%5D").replace(":","%3A").replace(/\//g,"%2F");return e.pickup_type&&(r+="&pickup_type_name="+e.pickup_type_name+"&dropoff_type_name="+e.dropoff_type_name+"&pickup_type="+e.pickup_type+"&dropoff_type="+e.dropoff_type+"&post_expire="+e.post_expire),x.get(r).success(function(e,t){i.resolve(e),o.processFirebase()}).error(function(e){i.reject(e)}),i.promise},bookIn:function(e,t){var o=this,i=this.getGroupZone(e,!0,t),r=i.group,n=i.zoneId,a=i.item,l=T.defer();if(0==r.length)return l.reject(),l.promise;ke=!0;var u=q+"bookin/?"+r.join("&")+"&"+n.join("&")+"&"+a.join("&")+"&vehicle="+p.vehicle+"&license="+p.permit+"&"+s.getParams();return M.bookingIn.length=0,0!=r.length&&r.forEach(function(e){var t=e.match(/=(.+)/)[1];Ot[bt[t].position];if(dt.indexOf(t)<0&&!Ot[bt[t].groupPosition].limit&&Ot[bt[t].position].category_id==t){M.bookingIn.indexOf(t)<0&&(M.bookingIn.push(t),G=!0),z.child(t+"/queue").orderByChild("timestamp").on("child_added",o.zoneAdded)}}),x.get(u).success(function(e,t){o.setAllBookedStatus(),ke=!1,l.resolve(e),e.items.forEach(function(e){e.hasOwnProperty("can_bookin")?o.setGroups():(Ot[bt[e.category_id].position].zone_id!=e.zone_id&&(Ot[bt[e.category_id].position].zone_id=e.zone_id,Ot[bt[e.category_id].groupPosition].zone_id=e.zone_id,o.setGroups()),o.setFbBidMode(e.category_id,Ot[bt[e.category_id].groupPosition].mode))}),0==M.bookingIn.length&&M.$broadcast("loading:hide"),o.processFirebase()}).error(function(e){l.reject(e),M.$broadcast("loading:hide"),d(["SOMETHING_WRONG","FAILED"]).then(function(e){k.alert({title:e.FAILED,template:e.SOMETHING_WRONG})})}),l.promise},bookOut:function(e,t){var o=this,i=this.getGroupZone(e,!1,t),r=i.group,n=i.zoneId,a=i.item,l=T.defer(),u=q+"bookout/?"+r.join("&")+"&"+n.join("&")+"&"+a.join("&")+"&"+s.getParams();dt.slice(0);return r.forEach(function(e,t){var o=e.match(/=(.+)/)[1];dt.indexOf(o)>-1&&M.bookingOut.push(o)}),x.get(u).success(function(t,i){o.changeGroupStatus(e,-2),l.resolve(t)}).error(function(e){l.reject(e),M.$broadcast("loading:hide"),d(["SOMETHING_WRONG","FAILED"]).then(function(e){k.alert({title:e.FAILED,template:e.SOMETHING_WRONG})})}),l.promise},quote:function(e,t,o){for(var i=this,r=[],n=[],a=[],l=[],u=0;u<e.length;u++){var c=bt[e[u].zone_id]||bt[e[u].group_id];if(-1==a.indexOf("group_id[]="+c.category_id)&&a.push("group_id[]="+c.category_id),-1==n.indexOf("zone_id[]="+e[u].group_id)&&n.push("zone_id[]="+e[u].group_id),r.push("quote_id[]="+e[u].id),3==t&&e[u].enabled&&be.hasOwnProperty([e[u].id])){if(be[e[u].id].quote)var c=be[e[u].id].quote;else var c=be[e[u].id].offer;l.push("offer_to_not[]="+c)}}var d=T.defer();if(-3==t)var f=q+"quote/?"+a.join("&")+"&"+n.join("&")+"&"+r.join("&")+'&reply_to_message=""&status='+t;else var f=q+"quote/?"+a.join("&")+"&"+n.join("&")+"&"+r.join("&")+'&reply_to_message=""&status='+t+"&"+l.join("&");if(f+="&"+s.getParams(),void 0!=o)f+="&"+o.join("&"),x.get(f).success(function(e){3==t&&r.forEach(function(e,t){e.replace("quote_id[]=","")}),d.resolve(e)}).error(function(e){d.reject(e),-3==t&&(i.removeModalPopup(M,"quote_modal"),i.quoteModalCleanUp())});else{var p=!0,m=[];e.forEach(function(e){var o=!1,r=e.group_id,n=e.id;m.push(n);var a=z.child(r+"/inbox/"+n),s={lat:M.lat,lon:M.lon,update_time:moment.utc().format("MM/DD/YYYY HH:mm:ss")};if(-3==t){i.getOfferNotId(r,n,!0)&&(o=!0,m.splice(m.indexOf(n),1));var l="offer_to_not";s[l]=window.localStorage.getItem("apikeypublic"),s.status="quoteshown"}else{i.getOfferId(r,n,!0)&&(o=!0,m.splice(m.indexOf(n),1));var l="offer_to";s[l]=window.localStorage.getItem("apikeypublic")}if(o)0==m.length&&d.resolve();else{var u=a.child(l).push(),c=u.key(),f={};f[l+"/"+c]=s,function(e,o){a.update(f,function(r){if(r)p=!1;else if(3==t){var n=i.getOfferNotId(e,o,!0);n&&a.transaction(function(e){return e&&e.offer_to_not?(1==Object.keys(e.offer_to_not).length?e.offer_to_not="":delete e.offer_to_not[n.key],e):void 0},function(e,t,i){e?p=!1:t&&(m.splice(m.indexOf(o),1),0==m.length&&p&&d.resolve())})}})}(r,n)}}),p?-3==t&&d.resolve():(d.reject(),-3==t&&(i.removeModalPopup(M,"quote_modal"),i.quoteModalCleanUp()))}return d.promise},deleteInbox:function(e){for(var t=this,o=[],i=[],r=[],n=[],a=0;a<e.length;a++){var l=we[e[a].zone_id]&&we[e[a].zone_id][e[a].quote_id]&&we[e[a].zone_id][e[a].quote_id].route;-1==i.indexOf("zone_id[]="+e[a].zone_id)&&i.push("zone_id[]="+e[a].zone_id),-1==o.indexOf("quote_id[]="+e[a].quote_id)&&o.push("quote_id[]="+e[a].quote_id),l&&(l.invoiceid&&-1==r.indexOf("invoiceid[]="+l.invoiceid)&&r.push("invoiceid[]="+l.invoiceid),-1==n.indexOf("quoteid[]="+l.whmcs)&&n.push("quoteid[]="+l.whmcs))}var u=T.defer(),c=function(){var e=q+"deleteInbox/?"+i.join("&")+"&"+o.join("&")+"&"+s.getParams();x.get(e,{data:{show:!1}}).success(function(e){u.resolve(e)}).error(function(e){u.reject(e)})};return r.length>0?t.cancelOrder(r,n).then(function(){c()},function(e){u.reject(e)}):t.cancelQuote(n).then(function(){c()},function(e){u.reject(e)}),u.promise},order:function(e){var t=T.defer();return x.get(q+"order/?quoteID="+window.localStorage.getItem("quote_Id")+"&paymentMethod="+e.paymentMethod+"&rate_id="+e.rate_id+"&price="+e.price+"&id="+e.id+"&tip="+e.tip+"&stripeToken="+e.token+"&"+e.opts.join("&")+"&"+e.optIn.join("&")+"&mode=order&app_id="+Tt+"&"+s.getParams()).success(function(e,o){t.resolve(e),window.localStorage.removeItem("quote_Id")}).error(function(e){t.reject(e)}),t.promise},orders:function(){var e=T.defer();return x.get(q+"orders/?"+s.getParams()).success(function(t,o){"Failed"!=t.status?e.resolve(t):e.reject(t)}).error(function(t){e.reject(t)}),e.promise},offer:function(e,t,o,i,r,n,a,l){var u=this,c=this.getGroupZone(e,!0,null,!0),d=c.group,f=(c.zoneId,c.item,T.defer()),p=[];dt.forEach(function(e){p.push("zone_id[]="+e)}),void 0!=l&&p.unshift(p.splice(p.indexOf("zone_id[]="+l),1)[0]);var m={};if(-4==i)var g=q+"offer/?"+d.join("&")+"&"+p.join("&")+"&quote_id[]="+t+"&offer_to="+o+'&reply_to_message=""&status='+i+"&reason="+r;else{var g=q+"offer/?"+d.join("&")+"&"+p.join("&")+"&eta_distance[]="+n+"&eta_time[]="+a+"&quote_id[]="+t+"&offer_to_not="+o+'&reply_to_message=""&status='+i,_=T.defer(),h=u.getOfferTime(M.offerDetail.zone_id,window.localStorage.getItem("apikeypublic")),v=h-moment(u.getServerTime()).diff(moment.utc(u.getOfferNotId(M.offerDetail.zone_id,M.offerDetail.id).update_time,"MM/DD/YYYY HH:mm:ss"),"seconds");D(function(){_.resolve()},1e3*v+1e4)}return g+="&"+s.getParams(),x.get(g,m).success(function(e){if(f.resolve(e),-4==i){var t=z.child(l+"/queue/"+window.localStorage.getItem("apikeypublic"));t.update({lat:M.lat,lon:M.lon,update_time:moment(new Date).add(ht,"minutes").subtract(qt,"hours").format("MM/DD/YYYY HH:mm:ss")},function(e){})}})["catch"](function(e,t,o,i){f.reject(e)}),f.promise},profile:function(e,t){var o=T.defer(),i=q+"user/?"+s.getParams(null,null,!0);return i+=e?"&apikeypublic="+e:"&email="+t,x.get(i).success(function(e){o.resolve(e)}).error(function(e){o.reject(e)}),o.promise},cancelQuote:function(e){var t=T.defer();return x.get(q+"cancelQuote/?"+e.join("&")+"&"+s.getParams()).success(function(e){t.resolve(e)}).error(function(e){t.reject(e)}),t.promise},cancelOrder:function(e,t){var o=T.defer();return x.get(q+"cancelOrder/?"+e+"&"+t.join("&")+"&"+s.getParams()).success(function(e){o.resolve(e)}).error(function(e){o.reject(e)}),o.promise},map:function(e){var o=T.defer(),i=T.defer();if("fetch"==e.action)var r=q+"geo/?action=fetch&"+s.getParams();else var r=q+"geo/?map_id="+e.map_id+"&action="+e.action+"&"+s.getParams();e.group_id&&(r+="&"+e.group_id.join("&")),e.description&&(r+="&description="+e.description),e.zone_id&&(r+="view"==e.action?"&zone_id=all":"&type="+e.type+"&zone_id="+e.zone_id+"&"+e.lat.join("&")+"&"+e.lon.join("&")+"&zone_title="+e.zone_title+"&zone_description="+e.zone_description),e.radius&&(r+="&radius="+e.radius+"&zone_radius="+e.zone_radius),e.title&&(r+="&title="+e.title),e.center&&(r+="&center="+e.center),e.zoom&&(r+="&zoom="+e.zoom),e.color&&(r+="&color="+e.color);x.get(r,{timeout:o.promise}).success(function(e){i.resolve(e)}).error(function(e){i.reject(e)})["finally"](function(){t.remove(r)});return t.add({url:r,abortpromise:o,deferred:i}),i.promise},trip:function(e,t){var o,i=this;-5==e.status?o=["CANCELLING","TRIP"]:0==e.status&&(o=["SENDING","MESSAGE"]),-5==e.status&&bt[e.zone_id]&&Ot[bt[e.zone_id].groupPosition].booked&&Ot[bt[e.zone_id].groupPosition].limit&&i.toggleBook(!1,Ot[bt[e.zone_id].groupPosition].id);void 0==t?window.localStorage.getItem("apikeypublic"):t.apikeypublic,void 0==t?M.lat:t.lat,void 0==t?M.lon:t.lng;M.$broadcast("loading:show",{text:o});var r=T.defer();if(void 0===e.msg)var n=q+"trip/?status="+e.status+"&quote_id[]="+e.quote_id+"&zone_id[]="+e.zone_id+'&reply_to_message=""&tripID='+e.tripID;else{if(e.isDriver)var n=q+"trip/?status="+e.status+"&quote_id[]="+e.quote_id+"&zone_id[]="+e.zone_id+"&tripID="+e.tripID+'&reply_to_message=""&message='+e.msg;else var n=q+"trip/?status="+e.status+"&quote_id[]="+e.quote_id+"&zone_id[]="+e.zone_id+"&tripID="+e.tripID+'&sent_to_message=""&message='+e.msg;if(9==e.status)if(e.isDriver)var n=q+"trip/?status="+e.status+"&quote_id[]="+e.quote_id+"&zone_id[]="+e.zone_id+"&tripID="+e.tripID+'&reply_to_message=""&'+e.msg.join("&");else var n=q+"trip/?status="+e.status+"&quote_id[]="+e.quote_id+"&zone_id[]="+e.zone_id+"&tripID="+e.tripID+'&sent_to_message=""&'+e.msg.join("&");if(""==e.tripID){for(var a=[],l=[],u=0;u<e.inbox.length;u++)-1==l.indexOf("zone_id[]="+e.inbox[u].zone_id)&&l.push("zone_id[]="+e.inbox[u].zone_id),-1==a.indexOf("quote_id[]="+e.inbox[u].quote_id)&&a.push("quote_id[]="+e.inbox[u].quote_id);var n=q+"trip/?status="+e.status+"&"+a.join("&")+"&"+l.join("&")+"&tripID="+e.tripID+'&sent_to_message=""&message='+e.msg}}n+="&"+s.getParams();var c,d;if(5==e.status?(c="arrived",d="Arrived"):6==e.status?(c="load",d=e.message):7==e.status&&(c="unload",d=e.message),c){var f=+Object.keys(we[e.zone_id][e.quote_id].route.reply_to_message)[Object.keys(we[e.zone_id][e.quote_id].route.reply_to_message).length-1],m=angular.copy(we[e.zone_id][e.quote_id].route.reply_to_message);
m[f+1]={lat:M.lat,lon:M.lon,message:d||"",status:c,update_time:moment.utc().format("MM/DD/YYYY HH:mm:ss")},z.child(e.zone_id+"/inbox/"+e.quote_id+"/route/reply_to_message").update(m,function(t){t||(z.child(e.zone_id+"/inbox/"+e.quote_id+"/route/status").set(c),r.resolve()),r.reject(t)}),"unload"==c&&p.tripPath[e.tripID]&&z.child(e.zone_id+"/inbox/"+e.quote_id+"/route/path").update(p.tripPath[e.tripID],function(e){})}else{var g=function(){x.get(n).success(function(t){-5==e.status?i.deleteInbox(e.inbox).then(function(){r.resolve(t)},function(e){}):r.resolve(t)}).error(function(e){r.reject(e)})};if(-5==e.status){var _=[],h=[];e.inbox.forEach(function(t){var o=e.tripID?t.id:t.quote_id,i=we[t.zone_id][o].route;i.hasOwnProperty("invoiceid")&&i.invoiceid?(_.push("invoiceid[]="+i.invoiceid),h.push("quoteid[]="+i.whmcs)):h.push("quoteid[]="+i.whmcs)}),_.length>0?i.cancelOrder(_,h).then(function(){g()},function(e){r.reject(err)}):i.cancelQuote(h).then(function(){g()},function(e){r.reject(err)})}else g()}return r.promise},setTripDist:function(e){tripDist=e},getRating:function(e,t){var o={},i={},r={},n={},a=pick_up=drop_off=!0,s=we[e][t].route,l=we[e][t].route.reply_to_message;l.forEach(function(e,t){"accept"==e.status?(o.time=moment(e.update_time,"MM/DD/YYYY HH:mm:ss"),o.lat=e.lat,o.lon=e.lon):"arrived"==e.status?(i.time=moment(e.update_time,"MM/DD/YYYY HH:mm:ss"),i.lat=e.lat,i.lon=e.lon):"load"==e.status?(r.time=moment(e.update_time,"MM/DD/YYYY HH:mm:ss"),r.lat=e.lat,r.lon=e.lon,e.message&&(a=!(e.message.indexOf("time")>-1),pick_up=!(e.message.indexOf("address")>-1))):"unload"==e.status&&(n.time=moment(e.update_time,"MM/DD/YYYY HH:mm:ss"),n.lat=e.lat,n.lon=e.lon,dropoff=!e.message)});var u=parseInt(s.eta_distance/s.eta_time),c=moment.duration(i.time.diff(o.time)).asHours(),d=0==Math.abs(moment.duration(n.time.diff(r.time))/1e3)?1:Math.abs(moment.duration(n.time.diff(r.time))/1e3),f=0,p=s.path;if(p)for(var m=0;m<Object.keys(p).length;m++)p[m]&&p[m+1]&&(f+=this.getGPSDistance(+p[m].lat,+p[m].lon,+p[m+1].lat,+p[m+1].lon));var g=c<parseFloat(l[1].eta_time)+5||c==parseFloat(l[1].eta_time)+5,_=f<parseFloat(s.eta_distance)+5||f==parseFloat(s.eta_distance)+5,h=3600*f/d,v=h<parseFloat(u)+5||h==parseFloat(u)+5;return{time:g,speed:v,distance:_,ontime:a,pickup:pick_up,dropoff:drop_off}},getBookedItemByZone:function(e){for(var t,o=0;o<Ot.length;o++)if(0==Ot[o].dispatcher&&Ot[o].zone_id==e&&Ot[o].apikeypublic==window.localStorage.getItem("apikeypublic")){t=Ot[o];break}if(void 0!==t)for(var o=0;o<Ot.length;o++)if(Ot[o].dispatcher>0&&Ot[o].category_id==t.category_id&&Ot[o].booked)return t},getGroupItem:function(e){for(var t=0;t<Ot.length;t++)if(Ot[t].dispatcher>0&&Ot[t].category_id==e)return Ot[t]},setOfferNotId:function(e,t){var o=we[t][e].offer_to_not;for(var i in o)""!=o[i]&&o[i].offer_to_not==window.localStorage.getItem("apikeypublic")&&(M.offerNotId=i)},setOfferId:function(e,t){var o=we[t][e].offer_to;for(var i in o)""!=o[i]&&o[i].offer_to==window.localStorage.getItem("apikeypublic")&&(M.offerId=i)},getAllQuoteIds:function(){var e=[];for(var t in we)for(var o in we[t])e.push("quote_id[]="+o);return e},getZoneFromQuoteId:function(e){for(var t in we)for(var o in we[t])if(o==e)return t},getInboxData:function(e,t){return we[e][t].route},getFBData:function(){return we},getFbBookedState:function(){return dt},addNotification:function(e){if(ionic.Platform.isWebView()){var t="Default Msg";"quote"==e?t="New Quote has arrived!":"offer"==e?t="Offer Accepted!":"rate"==e?t="Quote Accepted!":"message"==e?t="A New Message has Arrived!":"cancelled"==e?t="Trip Cancelled!":"arrived"==e&&(t="Driver has arrived!"),m.ready(function(){}),w.vibrate(500)}},ringTone:function(e){var t=e||0,o=0,i=function(){(t>o||-1==t)&&(this.currentTime=0,this.play(),o++)};if(Pe)Pe=!1,ionic.Platform.isAndroid()||(document.getElementById("ringtone").pause(),document.getElementById("ringtone").removeEventListener("ended",i));else if(Pe=!0,ionic.Platform.isAndroid())if(-1==e){P.beep();var r=I(function(){Pe?P.beep():I.cancel(r)},2e3)}else P.beep(t);else document.getElementById("ringtone").currentTime=0,document.getElementById("ringtone").play(),document.getElementById("ringtone").addEventListener("ended",i,!1)},showTripPage:function(){It||(M.detail=p.tripDetail,b.fromTemplateUrl("modals/trip-detail.html",{backdropClickToClose:!1,hardwareBackButtonClose:!1}).then(function(e){It||(It=!0,M.tripModal=e,e.show())}))},withinExpiryTime:function(e){var t=this,o=e.offer_to,i=moment(t.getServerTime()).diff(moment.utc(o[Object.keys(o)[0]].update_time,"MM/DD/YYYY HH:mm:ss")),r=moment.duration(i),n=r.asMinutes(),a=parseInt(moment().add(l.quoteExpiry,"minutes").subtract(r.as("milliseconds")).format("x")),a=parseInt(60*l.quoteExpiry-i/1e3);return n<l.quoteExpiry&&null!=p.quoteID&&p.quoteID.indexOf(e.route.quote_id)<0&&("quote"==e.route.mode?(M.showCountDown=!0,M.orderCountDown=a):(M.showInnerCountDown=!0,M.innerCountDown=a)),M.countDownEnded=function(){t.orderModalCleanUp()},M.quoteExpiry=60*l.quoteExpiry,n<l.quoteExpiry},getQuoteTimeOut:function(e){var t;for(var o in we)for(var i in we[o])if(e==we[o][i].route.quote_id){var r=we[o][i].offer_to_not;for(var n in r)(void 0==t||moment(t).isAfter(moment(new Date(r[n].update_time))))&&(t=moment(new Date(r[n].update_time)))}var a=moment().add(l.driverQuoteExpiry,"minutes").subtract(moment().add(ht,"minutes").diff(t.add(5,"hours")));return a},getQuoteUpdateTime:function(e){var t=e.offer_to_not;for(var o in t)if(""!=t[o]&&t[o].offer_to_not==window.localStorage.getItem("apikeypublic"))var i=t[o].update_time;return i},withinQuoteExpiryTime:function(e){var t=this,o=this.getQuoteUpdateTime(e);if(void 0==o)return!0;var i=moment.duration(moment(t.getServerTime()).diff(moment.utc(o,"MM/DD/YYYY HH:mm:ss"))),r=i.asMinutes();return r<l.driverQuoteExpiry},setQuoteCountDown:function(e){var t=this,o=this.getQuoteUpdateTime(e);if(void 0==o)var i=60*l.driverQuoteExpiry;else var r=moment().add(ht,"minutes"),n=moment(new Date(o)).add(qt,"hours"),i=parseInt(n.add(l.driverQuoteExpiry,"minutes").diff(r)/1e3),a=moment(t.getServerTime()).diff(moment.utc(o,"MM/DD/YYYY HH:mm:ss"),"seconds"),i=parseInt(60*l.driverQuoteExpiry-a);M.quoteCountDown=i,M.driverQuoteExpiry=60*l.driverQuoteExpiry,M.showQuoteCountDown=!0,M.quoteCountDownEnded=function(){He=!0,t.quoteModalCleanUp()}},withinOfferTime:function(e){var t=this;if(void 0==e.offer_to||""==e.offer_to||""==e.offer_to_not)return!0;if(""!=e.offer_to_not)var o=e.offer_to_not;else if(""!=e.offer_to)var o=e.offer_to;var i=(Object.keys(o).length,o),r=i[Object.keys(i)[Object.keys(i).length-1]],n=t.getOfferTime(e.route.zone_id,r.offer_to_not);return moment(t.getServerTime()).diff(moment.utc(r.update_time,"MM/DD/YYYY HH:mm:ss"),"seconds")<n+l.offerNextDriverDelay/1e3+20},hasShownOffer:function(e,t){var o,i,r;return(obj=this.getOfferNotId(e,t))&&(i=obj.key,o=we[e][t].offer_to_not[i],r=this.getOfferTime(e,window.localStorage.getItem("apikeypublic"))),o&&be[t]&&(!o.status||o.status&&"quoteshown"!=o.status&&"offerdeclined"!=o.status)&&moment(this.getServerTime()).diff(moment.utc(o.update_time,"MM/DD/YYYY HH:mm:ss"),"seconds")<r&&r-moment(this.getServerTime()).diff(moment.utc(o.update_time,"MM/DD/YYYY HH:mm:ss"),"seconds")},getOfferTime:function(e,t){return t?mt[t]&&mt[t][e]&&mt[t][e].settings&&mt[t][e].settings.offer||M.offerTime:M.offerTime},quoteModalCleanUp:function(){var e=this;He=!0,re=!1,M.quoteDetail=null,M.quotes.length=0,this.removeModalPopup(M,"quote_modal"),this.removeModalPopup(M,"popoverQuote"),this.removeModalPopup(M,"cancelTripModal"),Pe&&this.ringTone(),M.quoteCountDown=null,M.$broadcast("loading:hide"),D(function(){He=!1,e.processFirebase()},5e3),W&&W(),H&&H()},countDownTimer:function(){null==Ve&&(M.$on("timer-tick",function(e,t){t.millis>0&&void 0==M.innerCountDown&&void 0!=M.orderModal&&null!=M.orderModal&&(M.innerCountDown=t.millis/1e3,M.showInnerCountDown=!0)}),Ve=I(function(){},1e3))},clearCountDown:function(){null!=Ve&&(I.cancel(Ve),Ve=null)},offerTime:function(e){var t=this;e.selectDate+e.selectTime;var o=moment.duration(moment(t.getServerTime()).diff(moment.utc(sent_to_message[0].update_time,"MM/DD/YYYY HH:mm:ss"))),i=(o.asMinutes(),o.asMilliseconds());return M.orderCountDown=i,!0},setOrderExpiry:function(){M.orderCountDown=moment().countdown("1982-5-25",countdown.MONTHS|countdown.WEEKS,NaN,2).toString(),ne&&this.orderModalCleanUp()},countDownEnded:function(){this.orderModalCleanUp()},orderModalCleanUp:function(){var e=this;M.innerCountDown=void 0,M.showInnerCountDown=!1,M.showCountDown=!1,Pe&&this.ringTone(),this.clearCountDown(),M.rates.forEach(function(e){At.push(e.id)}),M.rates.length=0,this.removeModalPopup(M,"priceModal"),this.removeModalPopup(M,"orderModal"),this.removeModalPopup(M,"popoverPrice"),this.removeModalPopup(M,"cancelTripModal"),V&&(V(),V=null),M.selectedRate=null,wt=!1,ne=!1,M.rateNotSelected=!0,D(function(){e.processFirebase()},2e3)},removeModalPopup:function(e,t){e&&e[t]&&(1==e[t]?e[t]=null:e[t].remove().then(function(){e[t]&&(e[t]=null)}))},quoteCheck:function(e){var t=this,o=[],i=[],r=[],n=e.route;if(n.itemsArr&&n.zoneArr.forEach(function(e){if(pt[e]){var i=[];for(var a in pt[e]){var s=mt[a][e];s.tags.indexOf(n.selectService)>-1&&("offer"==n.mode||n.mode==s.mode)&&(""==s.quote_id||"Offered"==s.quote_id||"disconnected"==s.quote_id&&moment(t.getServerTime()).diff(moment(s.disconnectTime),"seconds")<A)&&i.push(a)}if(0==i.length){r.push(e);var l=t.inboxesWithQuoteId(null,n.quote_id,e);o=0==o.length?l:o.concat(l)}}else{r.push(e);var l=t.inboxesWithQuoteId(null,n.quote_id,e);o=0==o.length?l:o.concat(l)}}),o.length>0&&r.length==n.zoneArr.length)return o;if(""==e.offer_to_not||""!=e.offer_to){if(""==e.offer_to_not&&""==e.offer_to){var a=moment(t.getServerTime()),s=moment.utc(n.update_time,"MM/DD/YYYY HH:mm:ss");return a.diff(s,"minutes")+.2>l.driverQuoteExpiry&&n.zoneArr.forEach(function(e){if(pt[e]){r.push(e);var i=t.inboxesWithQuoteId(null,n.quote_id,e);o=0==o.length?i:o.concat(i)}else{r.push(e);var i=t.inboxesWithQuoteId(null,n.quote_id,e);o=0==o.length?i:o.concat(i)}}),o.length>0?o:!1}return!1}for(var u in e.offer_to_not){var c=e.offer_to_not[u].update_time,d=moment.duration(moment(t.getServerTime()).diff(moment.utc(c,"MM/DD/YYYY HH:mm:ss"))),f=d.asMinutes();if("quotecancelled"!=e.offer_to_not[u].status&&f<l.driverQuoteExpiry)return!1;i.indexOf(e.offer_to_not[u].inbox_id)<0&&(i.push(e.offer_to_not[u].inbox_id),o.push({quote_id:e.offer_to_not[u].inbox_id,zone_id:e.offer_to_not[u].group_id}))}return o},mergedInboxObj:function(e){var t;T.defer();for(var o in we)for(var i in we[o])if(we[o][i].route.quote_id==e.route.quote_id){t||(t=angular.copy(we[o][i])),t.route.zoneArr?t.route.zoneArr.indexOf(o)<0&&t.route.zoneArr.push(o):t.route.zoneArr=[o],t.route.inboxArr?t.route.inboxArr.indexOf(i)<0&&t.route.inboxArr.push(i):t.route.inboxArr=[i];var r=we[o][i];""!=r.offer_to&&(t.offer_to=$.extend(!0,t.offer_to,r.offer_to)),""!=r.offer_to_not&&(t.offer_to_not=$.extend(!0,t.offer_to_not,r.offer_to_not))}return t},areAllDriversQuoted:function(e){var t=this,o=T.defer();return o.resolve(t.quoteCheck(e)),o.promise},allDriversQuoted:function(e,t){if(void 0!=e){var o=this,i=o.mergedInboxObj(we[e][t]),r=i.route.quote_id;o.areAllDriversQuoted(i).then(function(e){e&&o.updateQuoteStatus(e).then(function(){ce.splice(ce.indexOf(r)),o.processFirebase(),I.cancel(de[r])},function(){ce.splice(ce.indexOf(r)),o.processFirebase(),I.cancel(de[r])})}),de.hasOwnProperty(r)||(de[r]=I(function(){we.hasOwnProperty(e)&&we[e].hasOwnProperty(t)&&"quote"==we[e][t].route.status?(o.quoteShownTimeout(we[e][t]),o.allDriversQuoted(e,t)):I.cancel(de[r])},1e4))}},updateQuoteStatus:function(e){var t=T.defer();return this.deleteInbox(e).then(function(){t.resolve()},function(e){t.reject(e)}),t.promise},quoteShownTimeout:function(e){var t=this,o=function(e){fe.hasOwnProperty(e.route.quote_id)&&D.cancel(fe[e.route.quote_id]),fe[e.route.quote_id]=D(function(){"quote"==e.route.status&&t.allDriversQuoted(e.zone_id,e.id)},15e3+t.lastQuoteDriverTime(e))};o(e)},lastQuoteDriverTime:function(e){var t=this,o=1e5,i=moment(t.getServerTime());if(""!=e.offer_to_not&&""==e.offer_to)for(var r in e.offer_to_not){var n=e.offer_to_not[r].update_time,a=moment.utc(n,"MM/DD/YYYY HH:mm:ss"),s=parseInt(a.add(l.driverQuoteExpiry,"minutes").diff(i));1e5==o?o=s:s>o&&(o=s)}return o},isViewing:function(e){return void 0==M[e]?!1:1==M[e]||M[e].isShown()?!0:void 0},getDriverDetail:function(e,t){var o=T.defer();return pt.hasOwnProperty(e)&&pt[e].hasOwnProperty(t)?o.resolve(pt[e][t]):z.child(e+"/queue/"+t).once("value",function(e){e.exists()&&o.resolve(e.val())}),o.promise},toastMsg:function(e,t,o,i){var r=this;r.ringTone(),D(function(){Pe&&r.ringTone()},3e3),r.addNotification("cancelled"),d(t).then(function(r){"TRIP_CANCEL"==t?u.error(e,r):i?M.chatModal&&M.chatModal.isShown()&&M.chatModal.inbox_id==o.routeItem.id?i():u.info(e,r,{onTap:i}):u.info(e,r)}),o&&r.setMsgRead(o)},setMsgRead:function(e){var t=e.routeItem;z.child(t.zone_id+"/inbox/"+t.id+"/route/"+e.node+"/"+e.index).update({read:1},function(o){o||window.localStorage.removeItem("replyMsgIndex",e.index);var i=F.indexOf(t.id);i>-1&&F.splice(i,1)})},reBookIn:function(e){var t=this,o=e.sent_to==window.localStorage.getItem("apikeypublic");if(o&&(!pt.hasOwnProperty(e.zone_id)||!pt[e.zone_id].hasOwnProperty(e.sent_to))){var i=Ot[bt[e.group_id].groupPosition];pt[e.zone_id]={},pt[e.zone_id][e.sent_to]={first_name:i.first_name,item_id:i.item_id,quote_id:e.quote_id,group_id:i.group_id,timestamp:2344444},t.toggleBook(!0,i).then(function(){z.child(e.group_id+"/queue/"+window.localStorage.getItem("apikeypublic")).update({quote_id:e.quote_id},function(o){o||(st.indexOf(e.zone_id)<0?t.setStoredZones({id:e.zone_id},"inside",e.group_id):z.child(e.zone_id+"/queue/"+window.localStorage.getItem("apikeypublic")).update({quote_id:e.quote_id},function(e){}))})})}},isDriverInTrip:function(){return Y},processFirebase:function(){var e=this;if(St=!0,!(Ge.length<lt.length)){for(var t in we)for(var o in we[t])if(void 0!==we[t][o].route){"offer"!=we[t][o].route.status&&zt.indexOf(o)>-1&&zt.splice(zt.indexOf(o),1);var i=we[t][o].route.status;if("offer"!=i||e.withinOfferTime(we[t][o])||D(function(t,o){!Te&&we[t]&&we[t][o]&&"offer"==we[t][o].route.status&&!e.withinOfferTime(we[t][o])&&(Te=!0,e.deleteInbox([{quote_id:o,zone_id:t}]).then(function(){Te=!1,e.processFirebase()}))},5e3,!0,t,o),"offer"==i&&"app.employee-dispatcher"==E.current.name&&we[t][o].route.reply_to==window.localStorage.getItem("apikeypublic")&&p.dispatcherInboxes.indexOf(o)<0&&p.dispatcherInboxes.push(Pt),"offer"==i&&(!p.isDriver||p.isDriver&&dt.indexOf(t)<0)&&we[t][o].route.reply_to==window.localStorage.getItem("apikeypublic")&&e.withinOfferTime(we[t][o])&&(!function(){var i=t,r=o;D(function(){if(we.hasOwnProperty(i)&&we[i].hasOwnProperty(r)){var t=we[i][r],o=0,n=t.offer_to,a=t.offer_to_not,s=!1,c=moment(e.getServerTime());if(""!=t.offer_to_not)for(m in a){var f=moment.utc(a[m].update_time,"MM/DD/YYYY HH:mm:ss"),p=e.getOfferTime(t.route.zone_id,a[m].offer_to_not);if(s=!a[m].hasOwnProperty("status")&&c.diff(f,"seconds")<p||a[m].hasOwnProperty("status")&&"offerdeclined"!=a[m].status){o=1e3*p+l.offerNextDriverDelay+8e3;break}}if(""!=t.offer_to&&"object"==typeof t.offer_to&&!B){var m=Object.keys(n)[0],p=e.getOfferTime(t.route.zone_id,n[m].offer_to),f=moment.utc(n[m].update_time,"MM/DD/YYYY HH:mm"),g=Object.keys(n).length*(+p+15);if(c.diff(f,"seconds")>g)for(m in n){B=!0;var _=z.child(i+"/inbox/"+r),h={lat:n[m].lat,lon:n[m].lon,update_time:moment.utc().format("MM/DD/YYYY HH:mm:ss"),offer_to_not:n[m].offer_to},v=_.child("offer_to_not").push(),y=v.key(),w={};w["offer_to_not/"+y]=h,function(e){_.update(w,function(t){t||(1==Object.keys(e).length?_.child("offer_to").set(""):_.child("offer_to/"+m).remove()),B=!1})}(n);break}else c.diff(f)>0&&D(function(){e.processFirebase()},c.diff(f))}var b=""==we[i][r].offer_to&&""!=we[i][r].offer_to_not;!b&&Qe[r]&&(D.cancel(Qe[r]),delete Qe[r]),b&&!function(t){Qe[r]||(Qe[r]=D(function(){if(M.allow_reoffer){var o=!0;for(var n in we){for(var a in we[n])if(we[n][r]&&we[n][a].route.quote_id==t&&"offer"==we[n][r].route.status&&""!=we[n][r].offer_to){o=!1;break}if(!o)break}}(M.allow_reoffer&&o||!M.allow_reoffer)&&we.hasOwnProperty(i)&&void 0!=we[i][r]&&"offer"==we[i][r].route.status&&""==we[i][r].offer_to&&""!=we[i][r].offer_to_not&&(d(["SORRY","OFFER_NOT_ACCEPTED"]).then(function(e){M.dontHideLoader=!1,M.$broadcast("loading:hide"),u.error(e.OFFER_NOT_ACCEPTED,e.SORRY)}),e.endTrip(r,!0))},o))}(we[i][r].route.quote_id)}},2e3)}(),function(){var i=t,r=o;D(function(){p.dispatcherInboxes.indexOf(r)<0&&""!=typeof we[i][r]&&we[i][r]&&"offer"==we[i][r].route.status&&e.withinOfferTime(we[i][r])&&(vt.indexOf(we[i][r].route.quote_id)<0&&vt.push(we[i][r].route.quote_id),e.areOfferDriversAvailable(i,r,we[i][r].route.pickup_zone,we[i][r].route.group_id).then(function(t){if(t){bt.hasOwnProperty(i)?i:we[i][r].route.group_id;M.detail||(M.tripModal=!0,M.$broadcast("loading:show",{text:"AWAIT_CONFIRM"},!0),E.transitionTo("app.trip-detail"))}else if(!Te&&""!=we[i][r].offer_to){Te=!0;var o=[],n=i,a=r;o.push({quote_id:a,zone_id:n}),we[n][a].route.pickup_zone!=n&&o.push({quote_id:a,zone_id:we[n][a].route.pickup_zone}),we[n][a].route.zone_id!=we[n][a].route.group_id&&o.push({quote_id:a,zone_id:we[n][a].route.group_id}),function(t){var o=e.inboxesWithQuoteId(null,we[n][a].route.quote_id);e.deleteInbox(o).then(function(){Te=!1,d(["OFFER_NOT_ACCEPTED","SORRY"]).then(function(e){M.$broadcast("loading:hide"),u.error(e.OFFER_NOT_ACCEPTED,e.SORRY)}),e.endTrip(a,!0)},function(e){})}(a)}}))},e.timeToShowOffer(we[t][o]))}()),we[t][o].route.reply_to==window.localStorage.getItem("apikeypublic")||we[t][o].route.sent_to==window.localStorage.getItem("apikeypublic")&&"quote"!=we[t][o].route.status&&"offer"!=we[t][o].route.status){var r=we[t][o].route;if(r.isCustomer=we[t][o].route.reply_to==window.localStorage.getItem("apikeypublic"),r.isDriver=!r.isCustomer,p.dispatcherInboxes.indexOf(o)<0){var n=r.reply_to==window.localStorage.getItem("apikeypublic"),a=r.sent_to==window.localStorage.getItem("apikeypublic"),s=r.hasOwnProperty("reply_to_message")?r.reply_to_message[+Object.keys(r.reply_to_message)[Object.keys(r.reply_to_message).length-1]].status:"quote",c=r.sent_to_message[+Object.keys(r.sent_to_message)[Object.keys(r.sent_to_message).length-1]].status;if("accept"==i||"arrived"==i||"load"==i){p.acceptedOrders||(p.acceptedOrders=[]);var f=M.detail&&M.detail.id!=r.id&&Y==r.quote_id;if(!M.detail||f){It=!0,r.isCustomer=we[t][o].route.reply_to==window.localStorage.getItem("apikeypublic"),r.isDriver=!r.isCustomer,r.zone_id=t,e.reBookIn(r),It=!0,yt=!1;var m=r;if(M.detail=m,p.tripDetail=m,p.tripDetail.isDriver){for(var g in bt)if(bt[g].booked&&g==bt[g].category_id)if(g!=r.group_id)e.toggleBook(!1,Ot[bt[g].groupPosition]);else{var _=z.child(t+"/queue/"+window.localStorage.getItem("apikeypublic"));_.child("disconnectTime").remove(),_.update({quote_id:r.quote_id})}z.child(r.group_id+"/queue/"+window.localStorage.getItem("apikeypublic")+"/quote_id").set(r.quote_id),z.child(r.group_id+"/queue/"+window.localStorage.getItem("apikeypublic")).onDisconnect().cancel(),z.child(r.group_id+"/queue/"+window.localStorage.getItem("apikeypublic")).onDisconnect().update({disconnectTime:Firebase.ServerValue.TIMESTAMP})}(p.tripDetail.isDriver||"app.trip-detail"!=M.history.currentStateName())&&(It=!0,D(function(){},1e3),M.tripModal=!0),"app.trip-detail"!=M.history.currentStateName()&&(E.transitionTo("app.trip-detail"),e.removeModalPopup(M,"offerModal")),M.dontHideLoader=!1,M.$broadcast("trip:started",null),e.isViewing("offerModal")||M.$broadcast("loading:hide")}else n&&p.acceptedOrders.indexOf(r.id)<0&&(p.acceptedOrders.push(r.id),d(["SUCCESS","ORDER_ACCEPTED"]).then(function(e){M.$broadcast("loading:hide"),u.success(e.ORDER_ACCEPTED,e.SUCCESS,{timeOut:3e3})}))}else if((a&&"unload"==s||("unload"==i||"receipt"==i||"rate"==i)&&n&&"receipt"!=c&&"rate"!=c)&&!M.detail&&Object.keys(ft).length>0){It=!0;var r=we[t][o].route;if(r.isCustomer=we[t][o].route.reply_to==window.localStorage.getItem("apikeypublic"),r.isDriver=!r.isCustomer,r.zone_id=t,ft.hasOwnProperty(t)&&ft[t].hasOwnProperty(r.sent_to)&&(r.driver_lat=ft[t][r.sent_to].lat,r.driver_lon=ft[t][r.sent_to].lon),e.reBookIn(r),M.detail=r,p.tripDetail=r,p.tripDetail.isDriver){for(var g in bt)if(bt[g].booked&&g==bt[g].category_id)if(g!=r.group_id)e.toggleBook(!1,Ot[bt[g].groupPosition]);else{var _=z.child(t+"/queue/"+window.localStorage.getItem("apikeypublic"));_.child("disconnectTime").remove(),_.update({quote_id:r.quote_id})}z.child(r.group_id+"/queue/"+window.localStorage.getItem("apikeypublic")+"/quote_id").set(r.quote_id),z.child(r.group_id+"/queue/"+window.localStorage.getItem("apikeypublic")).onDisconnect().cancel(),z.child(r.group_id+"/queue/"+window.localStorage.getItem("apikeypublic")).onDisconnect().update({disconnectTime:Firebase.ServerValue.TIMESTAMP})}M.tripModal=!0,E.transitionTo("app.trip-detail")}if(!It&&a&&"receipt"==s||n&&("unload"==r.status||"receipt"==r.status||"rate"==r.status)&&("receipt"==c||void 0==c)){if(It=!0,!M.detail&&null==M.ratingModal){M.ratingModal=!0;var h=we[t][o].route;null==p.tripDetail&&(p.tripDetail={zone_id:t,id:h.id,isDriver:h.reply_to!=window.localStorage.getItem("apikeypublic")});var r=we[t][o].route;r.isCustomer=r.reply_to==window.localStorage.getItem("apikeypublic"),r.isDriver=!r.isCustomer,M.detail=r,E.transitionTo("app.trip-detail")}}else if(It&&null!=p.tripDetail&&p.tripDetail.id==o&&a&&"rate"==s){e.endTrip(o),e.ringTone(),D(function(){Pe&&e.ringTone()},3e3);continue}}}if("offer"==we[t][o].route.status&&!function(){var i=t,r=o,n=we[i][r],a=0,s=n.offer_to_not,u=!1,c=moment(e.getServerTime());if(""!=n.offer_to_not)for(x in s){var d=moment.utc(s[x].update_time,"MM/DD/YYYY HH:mm:ss"),f=e.getOfferTime(n.route.zone_id,s[x].offer_to_not);if(u=!s[x].hasOwnProperty("status")&&c.diff(d,"seconds")<f||s[x].hasOwnProperty("status")&&"offerdeclined"!=s[x].status){a=1e3*f+l.offerNextDriverDelay+5e3;break}}var p=""==we[i][r].offer_to&&""!=we[i][r].offer_to_not;p&&!function(){Ye[r]&&D.cancel(Ye[r]),Ye[r]=D(function(){we.hasOwnProperty(i)&&void 0!=we[i][r]&&"offer"==we[i][r].route.status&&""==we[i][r].offer_to&&""!=we[i][r].offer_to_not&&e.deleteInbox([{quote_id:r,zone_id:i}]).then(function(){e.processFirebase()},function(e){})},a)}()}(),"rate"==we[t][o].route.status&&we[t][o].route.hasOwnProperty("reply_to_message")){var v=we[t][o].route.reply_to_message[+Object.keys(we[t][o].route.reply_to_message)[Object.keys(we[t][o].route.reply_to_message).length-1]];if("rate"==v.status){var y=moment.duration(moment(e.getServerTime()).diff(moment.utc(v.update_time,"MM/DD/YYYY HH:mm:ss"))).asMinutes(),c=we[t][o].route.sent_to_message[+Object.keys(we[t][o].route.sent_to_message)[Object.keys(we[t][o].route.sent_to_message).length-1]];(y>l.deleteTimeAfterDriverRate||"rate"==c.status)&&e.deleteInbox([{quote_id:o,zone_id:t}]).then(function(){e.processFirebase()},function(e){})}}if(we[t][o].route.reply_to==window.localStorage.getItem("apikeypublic")&&we[t][o].route.hasOwnProperty("reply_to_message")&&Array.isArray(we[t][o].route.reply_to_message)&&we[t][o].route.reply_to_message.length>1){var w=we[t][o].route,b=w.reply_to_message.length-1;if(F.indexOf(o)<0&&!w.reply_to_message[b].hasOwnProperty("read")&&""!=w.reply_to_message[b].message&&("message"==w.reply_to_message[b].status||"order_edited"==w.reply_to_message[b].status||"cancelled"==w.reply_to_message[b].status)){window.localStorage.setItem("replyMsgIndex",b);var O;"cancelled"==w.reply_to_message[b].status?(F.push(o),e.getDriverDetail(t,w.sent_to).then(function(t){var o=t.first_name+": "+w.reply_to_message[b].message;e.toastMsg(o,"TRIP_CANCEL",{routeItem:w,node:"reply_to_message",index:b}),e.deleteInbox([{quote_id:w.id,zone_id:w.group_id}])})):"message"==w.reply_to_message[b].status?(F.push(o),e.getDriverDetail(t,w.sent_to).then(function(t){var o=t.first_name+": "+w.reply_to_message[b].message;e.toastMsg(o,"MESSAGE",{routeItem:w,node:"reply_to_message",index:b},function(){M.$broadcast("trip:msg",{inbox_id:w.id,apikey:w.sent_to,message:w.reply_to_message[b].message,update_time:w.reply_to_message[b].update_time})})})):(F.push(o),e.getDriverDetail(t,w.sent_to).then(function(t){var o=t.first_name+": "+w.reply_to_message[b].message;e.toastMsg(o,"ORDER_EDITED",{routeItem:w,node:"reply_to_message",index:b})}),M.detail=angular.extend(M.detail,M.detail,we[t][o].route),M.$broadcast("order:edited"))}}if(we[t][o])if("quote"==we[t][o].route.status&&ce.indexOf(we[t][o].route.quote_id)<0&&(ce.push(we[t][o].route.quote_id),e.allDriversQuoted(t,o)),"quote"==we[t][o].route.status&&""!=we[t][o].offer_to&&At.indexOf(o)<0)if(e.withinExpiryTime(we[t][o])){if((ne||wt)&&M.rates.length>0&&we[t][o].route.quote_id!=M.rates[0].quote_id)continue;if(window.localStorage.getItem("apikeypublic")==we[t][o].route.ordered_by||p.uuid==we[t][o].route.ordered_by){window.localStorage.setItem("quote_Id",we[t][o].route.quote_id);var P={};P.text=we[t][o].route.selectService+" $"+we[t][o].route.price,P.value=we[t][o].route.rate_id,P.price=we[t][o].route.price,P.quoteId=we[t][o].route.id,P.id=we[t][o].route.id,P.quote_id=we[t][o].route.quote_id,P.summary=we[t][o].route,P.mode=we[t][o].route.mode,P.zone_id=[we[t][o].route.zone_id],P.pickup_zone=we[t][o].route.pickup_zone,P.group_id=we[t][o].route.group_id,P.whmcs=we[t][o].route.whmcs;var S=-1,I=M.rates.some(function(e,i){return e.value===we[t][o].route.rate_id&&(S=i),e.value===we[t][o].route.rate_id});null==p.quoteID&&(p.quoteID=[]),!I&&p.quoteID.indexOf(P.quote_id)<0?(M.rates.push(P),M.rates.sort(function(e,t){return e.price-t.price}),ne&&(M.$broadcast("loading:hide"),M.showCountDown=!0)):M.rates[S].zone_id.indexOf(we[t][o].route.zone_id)<0&&M.rates[S].zone_id.push(we[t][o].route.zone_id)}}else window.localStorage.getItem("apikeypublic")&&!function(t,o){D(function(){if(we.hasOwnProperty(t)&&we[t].hasOwnProperty(o)&&"quote"==we[t][o].route.status){It=!0;var i=[];i.push({quote_id:o,zone_id:t}),we[t][o].route.pickup_zone!=t&&i.push({quote_id:o,zone_id:we[t][o].route.pickup_zone}),we[t][o].route.zone_id!=we[t][o].route.group_id&&i.push({quote_id:o,zone_id:we[t][o].route.group_id}),e.deleteInbox(i).then(function(){It=!1,e.processFirebase()},function(e){})}},5e3)}(t,o);else if(It&&"unload"==we[t][o].route.status&&p.tripDetail&&p.tripDetail.id==o&&we[t][o].route.reply_to==window.localStorage.getItem("apikeypublic")){var r=we[t][o].route,c=r.sent_to_message[+Object.keys(r.sent_to_message)[Object.keys(r.sent_to_message).length-1]].status;"receipt"!=c&&"rate"!=c&&(e.stopTrackingTrip(),e.stopTrackingAfter(),null==M.receiptModal&&M.$broadcast("trip:unloaded",null))}else if("arrived"==we[t][o].route.status&&we[t][o].route.reply_to==window.localStorage.getItem("apikeypublic")&&F.indexOf(o)<0&&"arrived"!=r.sent_to_message[+Object.keys(r.sent_to_message)[Object.keys(r.sent_to_message).length-1]].status){var w=we[t][o].route,b=w.reply_to_message.length-1;if(!w.reply_to_message[b].hasOwnProperty("read")&&!M.arrivedToast||M.arrivedToast&&M.arrivedToast.indexOf(o)<0){F.push(o),M.arrivedToast||(M.arrivedToast=[]),M.arrivedToast.push(o),e.ringTone(),D(function(){e.isRinging()&&e.ringTone()},3e3);var w=we[t][o].route,b=w.reply_to_message.length-1;e.setMsgRead({routeItem:w,node:"reply_to_message",index:b}),e.addNotification("message"),function(t,o){d(["ARRIVAL","HAS_ARRIVED"]).then(function(i){O=e.getAllDrivers()[t][we[t][o].route.sent_to].first_name+i.HAS_ARRIVED,M.toastArrived=u.info(O,i.ARRIVAL,{onTap:function(){we[t]&&we[t][o]&&M.detail&&o==M.detail.id&&"arrived"==we[t][o].route.status&&we[t][o].route.reply_to==window.localStorage.getItem("apikeypublic")&&"arrived"!=r.sent_to_message[+Object.keys(r.sent_to_message)[Object.keys(r.sent_to_message).length-1]].status&&M.$broadcast("trip:arrived",we[t][o].route)}})})}(t,o)}}else"receipt"==we[t][o].route.status&&we[t][o].route.reply_to==window.localStorage.getItem("apikeypublic")?void 0==M.receiptModal||null==M.receiptModal:"load"==we[t][o].route.status&&we[t][o].route.reply_to==window.localStorage.getItem("apikeypublic")?De||(e.startTrackingTrip(),e.startTrackingAfter(we[t][o].route.dropoff_lat,we[t][o].route.dropoff_lon)):!Te&&(we[t][o].route.reply_to==window.localStorage.getItem("apikeypublic")||we[t][o].route.sent_to==window.localStorage.getItem("apikeypublic"))&&we[t][o].route.status.indexOf("ordercancelled_")>-1&&(Te=!0,e.deleteInbox([{quote_id:o,zone_id:t}]).then(function(){Te=!1,e.processFirebase()}),O="Trip cancelled by "+we[t][o].route.status.split("_")[1],message="TRIP_CANCEL",(!M.detail||M.detail&&M.detail.id==o)&&e.endTrip(o),e.ringTone(),D(function(){e.ringTone()},3e3),e.addNotification("cancelled"),d(message).then(function(e){u.error(O,e)}))}if(M.rates.length>0&&(D.cancel(X[M.rates[0].quote_id]),ne||wt||"quote"!=M.rates[0].mode?"offer"!=M.rates[0].mode||wt||(void 0==window.localStorage.getItem("apikeypublic")&&(M.dontHideLoader=!1,M.$broadcast("loading:hide"),wt=!0,E.transitionTo("app.login")),D(function(){if(M.dontHideLoader=!1,void 0!=M.rates[0]){M.rates.sort(function(e,t){return t.price-e.price});var t={rate_id:M.rates[0].value,zone_id:M.rates[0].zone_id,group_id:M.rates[0].group_id,pickup_zone:M.rates[0].pickup_zone,price:M.rates[0].price,id:M.rates[0].quoteId,summary:M.rates[0].summary};wt||(M.showInnerCountDown=!0,e.showOrderForm(t),e.ringTone(-1))}},5e3)):(e.showPriceModal(),e.ringTone(-1))),0!=dt.length&&Se&&0==M.bookingIn.length&&null!=Ot)for(var x in bt){var t=x;if(Ot[bt[x].position].tags.indexOf("Driver")>-1&&(bt[x].booked||null!=p.tripDetail))for(var o in we[t])if(null!=we[t][o]&&we[t][o].hasOwnProperty("route")){var w=we[t][o].route;if(we[t][o].route.sent_to==window.localStorage.getItem("apikeypublic")&&we[t][o].route.hasOwnProperty("sent_to_message")&&Array.isArray(we[t][o].route.sent_to_message)&&we[t][o].route.sent_to_message.length>1){var b=w.sent_to_message.length-1;F.indexOf(o)<0&&!w.sent_to_message[b].hasOwnProperty("read")&&""!=w.sent_to_message[b].message&&("message"==w.sent_to_message[b].status||"order_edited"==w.sent_to_message[b].status||"cancelled"==w.sent_to_message[b].status||"arrived"==w.sent_to_message[b].status)&&(window.localStorage.setItem("sentMsgIndex",b),F.push(o),e.profile(w.reply_to).then(function(i){M.profile=i,"cancelled"==w.sent_to_message[b].status?!function(t,o){M.bookingOut.push(t),Ot[bt[t].groupPosition].limit&&z.child(t+"/queue/"+window.localStorage.getItem("apikeypublic")).remove(function(){}),O=M.profile.description+": "+o.sent_to_message[b].message,message="TRIP_CANCEL",e.endTrip(o.id),e.ringTone(),D(function(){e.ringTone()},3e3),e.addNotification("cancelled"),d(message).then(function(e){u.error(O,e)}),e.deleteInbox([{quote_id:o.id,zone_id:o.group_id}])}(t,w):"order_edited"==w.sent_to_message[b].status?(O=M.profile.description+": "+w.sent_to_message[b].message,message="ORDER_EDITED",e.ringTone(),D(function(){e.ringTone()},3e3),e.addNotification("message"),d(message).then(function(e){u.info(O,e)}),M.detail=angular.extend(M.detail,M.detail,we[t][o].route),M.$broadcast("order:edited")):(O=M.profile.description+": "+w.sent_to_message[b].message,e.toastMsg(O,"MESSAGE",{routeItem:w,node:"sent_to_message",index:b},function(){M.$broadcast("trip:msg",{inbox_id:w.id,apikey:w.reply_to,message:w.sent_to_message[b].message,update_time:w.sent_to_message[b].update_time})}))}))}if(void 0!==w&&we[t][o]&&!(bt[t]&&Ot[bt[t].groupPosition].QP&&Ot[bt[t].groupPosition].QP.toString().indexOf("/")<0)){if(""!=w.tripID){w.tripID}var T=e.getGPSDistance(parseFloat(w.pickup_lat),parseFloat(w.pickup_lon),M.lat,M.lon);if(!He&&"offer"==we[t][o].route.status&&be.hasOwnProperty(o)&&re&&M.quoteDetail&&M.quoteDetail.quote_id==we[t][o].route.quote_id&&(e.quoteModalCleanUp(),d(["SORRY","DRIVER_LATE_QUOTE"]).then(function(e){u.error(e.DRIVER_LATE_QUOTE,e.SORRY)})),hasShown=null,"offer"==we[t][o].route.status&&(0==zt.length||zt.indexOf(o)>-1)&&(void 0!=e.getOfferId(t,o)&&o==e.getOfferId(t,o).routeId||(hasShown=e.hasShownOffer(t,o)))&&!Y&&!e.isViewing("offerModal")){
M.milesAway=T.toFixed(2);M.declineOffer=function(){var t=e.getOfferNotId(M.offerDetail.zone_id,M.offerDetail.id),o=z.child(t.zoneId+"/inbox/"+t.routeId+"/offer_to_not/"+t.key);o.update({status:"offerdeclined"},function(e){}),e.removeModalPopup(M,"offerModal"),e.sendToJail(t.zoneId)},M.acceptOffer=function(){M.showLoader=!0,M.showOfferCounter=!1,le=!0,M.dontHideLoader=!0,M.$broadcast("loading:show"),D.cancel(M.jailTimer);var t=e.getOfferNotId(M.offerDetail.zone_id,M.offerDetail.id);M.offerNotInProcess=!0,e.ringTone();var o=function(){e.getGoogleDistTime({lat:M.lat,lon:M.lon},{lat:t.routeObj.pickup_lat,lon:t.routeObj.pickup_lon}).then(function(o){var i=function(){var t=we[M.offerDetail.zone_id][M.offerDetail.id],i={eta_distance:o.distMiles,eta_time:o.timeHours,lat:M.lat,lon:M.lon,message:"",status:"accept",update_time:moment.utc().format("MM/DD/YYYY HH:mm:ss")},n=z.child(t.route.group_id+"/inbox/"+t.route.id);n.update({offer_to:"",offer_to_not:"","route/status":"accept","route/sent_to":window.localStorage.getItem("apikeypublic"),"route/reply_to_message/1":i},function(o){if(o)M.offerNotInProcess=!1,ue?r():d(["SOMETHING_WRONG","FAILED"]).then(function(e){M.$broadcast("loading:hide"),k.alert({title:e.FAILED,template:e.SOMETHING_WRONG})}),M.showOfferCounter=!0;else{M.isTripStarted=!0,ue=!1,le=!1,zt.splice(zt.indexOf(M.offerDetail.id),1),M.offerDetail=null;var i=e.getInboxesByQuoteId(t.route.quote_id);i.length>0&&i.forEach(function(e,t){t>0&&z.child(e.route.group_id+"/inbox/"+e.route.id).remove()})}})};e.deleteOtherInboxes(t.routeObj).then(function(){ue?r():i()},function(){ue&&r()});var r=function(){M.dontHideLoader=!1,e.removeModalPopup(M,"offerModal"),e.sendToJail(t.zoneId),ue=!1,le=!1}},function(){ue?onTimeOut():o()})};o()};if("undefined"!=typeof hasShown&&hasShown)return void e.offerFunc(we[t][o],t,o,hasShown);M.offerNotInProcess=!0,yt=!0,e.offerFunc(we[t][o],t,o)}else if("quote"==we[t][o].route.status&&(Ot[bt[t].position].zone_id==t||Ot[bt[t].position].category_id==t)&&e.quoteMyItemId(t,o)&&e.matchesTags(mt[window.localStorage.getItem("apikeypublic")][t],w.selectService.split(",").filter(function(e){return e}))&&e.withinQuoteExpiryTime(we[t][o])&&dt.indexOf(t)>-1&&we[t][o].route.ordered_by!=window.localStorage.getItem("apikeypublic")&&e.withinZone(we[t][o].route.group_id,null,null,null,we[t][o].route.pickup_lat,we[t][o].route.pickup_lon)){var q=e.hasInboxes(we[t][o].route.groups,!0),C=q&&e.hasGlobalPriceLessEqual(we[t][o].route);if(null==p.quoteID&&(p.quoteID=[]),!q||!C||Y||e.isViewing("offerModal")||He||p.quoteID.indexOf(w.quote_id)>-1)continue;if(null==M.quoteDetail){M.quoteDetail={},M.quoteDetail.quote_id=w.quote_id,M.quoteDetail.pickup=w.pickup,M.quoteDetail.pickup_lat=w.pickup_lat,M.quoteDetail.pickup_lon=w.pickup_lon,M.quoteDetail.dropoff=w.dropoff,M.quoteDetail.selectService=w.selectService,M.quoteDetail.selectPeople=w.selectPeople,M.quoteDetail.selectDate=w.selectDate,M.quoteDetail.selectTime=w.selectTime,M.quoteDetail.route_distance=parseFloat(w.route_distance).toFixed(2),M.quoteDetail.distance_pickup=parseFloat(T).toFixed(2),M.quoteDetail.note=w.note,M.quoteDetail.range=w.range,M.quoteDetail.group_name=w.group_name,M.quoteDetail.zone_id=w.zone_id;var A=["DETAIL","PICKUP","DROPOFF","SERVICE","SEATS","ROUTE","DATE_TIME","MILES","PICKUP_DISTANCE","NOTES"];d(A).then(function(t){null!=M.quoteDetail&&(M.accordion={},M.items=[],e.getGoogleDistTime({lat:M.quoteDetail.pickup_lat,lon:M.quoteDetail.pickup_lon},{lat:M.lat,lon:M.lon}).then(function(e){M.quoteDetail&&(M.items.push({label:t.PICKUP_DISTANCE,text:e.dist}),M.items.push({label:t.DATE_TIME,text:e.timeText}),"quote"==M.quoteDetail.mode&&M.items.push({label:t.PRICE,text:M.quoteDetail.price}))}),M.accordion.heading=t.DETAIL)})}var j={};j.text=w.selectService+" $"+w.price,j.enabled=!0,j.id=w.id,j.price=w.price,j.quote_id=w.quote_id,j.zone_id=w.pickup_zone,j.group_id=w.group_id,j.whmcs=w.whmcs;var I=M.quotes.some(function(e){return e.id===w.id});if(!I&&w.quote_id==M.quoteDetail.quote_id)if(M.quotes.push(j),M.quotes.sort(function(e,t){return e.price-t.price}),"quote"!=we[t][o].route.status&&"offer"!=we[t][o].route.status||"quote"!=we[t][o].route.mode||"quote"!=Ot[bt[t].groupPosition].mode){if("quote"==we[t][o].route.status){M.quotes.slice(0);D(function(t,o,i){if(!re&&we[t][o]&&i.length>0){re=!0,p.quoteID.push(i[0].quote_id),He=!0;var r=function(n){e.quote(i,-3).then(function(){var r=function(n){e.quote(i,3).then(function(){e.quoteModalCleanUp()},function(){we[t]&&we[t][o]&&("quote"==we[t][o].route.status||"offer"==we[t][o].route.status)&&3>n&&r(n+1)})};r(0)},function(){we[t]&&we[t][o]&&("quote"==we[t][o].route.status||"offer"==we[t][o].route.status)&&3>n&&r(n+1)})};r(0)}},5e3,!0,t,o,M.quotes)}}else re||(re=!0,e.setQuoteCountDown(we[t][o]),e.showQuoteModal(w,we[t][o]))}}}}}},hasInboxes:function(e,t){var o=this;return e.forEach(function(e){lt.indexOf(e)<0&&Lt.indexOf(e)<0&&Lt.push(e)}),t&&Lt.forEach(function(e,t){o.initFirebase(e)}),0==Lt.length},hasGlobalPriceLessEqual:function(e){var t=[],o=e.groups,i=e.quote_id;o.forEach(function(e){for(var o in we[e])(we[e][o].route.quote_id=i)&&t.push(we[e][o].route.price)});var r=Math.min.apply(null,t);return e.price<=r},deleteOtherInboxes:function(e){var t=T.defer(),o=this.inboxesWithQuoteId(e.id,e.quote_id);return o.length>0?this.deleteInbox(o).then(function(){t.resolve()},function(){t.reject()}):t.resolve(),t.promise},isLastQuote:function(){var e=this;if(M.allow_reoffer){var t=!0,o=we[M.offerDetail.zone_id][M.offerDetail.id],i=e.mergedInboxObj(o),r=i.offer_to;for(var n in r)if(r[n].offer_to==window.localStorage.getItem("apikeypublic")){t=!1;break}return t}return!0},sendToJail:function(e){var t=this;M.$broadcast("loading:hide",!0),It=!0,Pe&&t.ringTone();var o=mt[window.localStorage.getItem("apikeypublic")][e].settings,i=o&&o.jail;M.jailCountdown=i||M.jailTime,b.fromTemplateUrl("jail-page.html",{backdropClickToClose:!1,hardwareBackButtonClose:!1,scope:M}).then(function(e){M.jailModal=e,e.show(),t.toggleBook(!1,"all"),D(function(e){t.endTrip(e),t.toggleBook(!0,"all"),t.removeModalPopup(M,"jailModal"),zt.indexOf(e)>-1&&zt.splice(zt.indexOf(e),1),M.offerDetail=null,E.transitionTo("app.employee-index")},1e3*i,!0,M.offerDetail.id)})},offerFunc:function(e,t,o,i){var r,n=this;if(M.allow_reoffer&&(r=n.mergedInboxObj(e)),r&&r.route.zoneArr.length>0){0==zt.length&&(zt=r.route.inboxArr);var a=n.getOfferPosition(o,t,r)+1,s=n.getOfferTime(t,n.getApiKeyDriverOffered(r)),u=a*s*1e3+a*l.offerNextDriverDelay+0;0==a&&n.getLastOfferedDeclined(o,t)&&(u=0),function(e,t,o,a){var s=n.getDriverInOfferDelay(r);n.showOfferModal(e,t,o,s,a,r,i)}(a,o,t,u)}else n.driversInZoneOffered(e).then(function(e){if(-1==e)var r=n.getOfferPosition(o,t)+1;else var r=e;var a=n.getOfferTime(t,n.getApiKeyDriverOffered(we[t][o])),s=r*a*1e3+r*l.offerNextDriverDelay+0;0==r&&n.getLastOfferedDeclined(o,t)&&(s=0),function(e,t,o,r){var a=n.getDriverInOfferDelay(we[o][t]);we.hasOwnProperty(o)&&we[o].hasOwnProperty(t)&&n.showOfferModal(e,t,o,a,r,we[o][t],i)}(r,o,t,s)},function(){n.isViewing("offerModal")||(yt=!1)})},driversInZoneOffered:function(e){var t=T.defer(),o=this;return D(function(){if(!e||e&&"offer"!=e.route.status)t.reject();else if(o.withinGreenZone(e.route.group_id,e.route.pickup_zone,e.route.pickup_lat,e.route.pickup_lon)){var i=!1;if(""!=e.offer_to&&pt[e.route.zone_id]&&pt[e.route.zone_id][window.localStorage.getItem("apikeypublic")]&&!o.withinGreenZone(e.route.group_id,e.route.pickup_zone,e.route.pickup_lat,e.route.pickup_lon,pt[e.route.zone_id][window.localStorage.getItem("apikeypublic")].zone_id))for(var r in e.offer_to)if(pt[e.route.zone_id][e.offer_to[r].offer_to]&&o.withinGreenZone(e.route.group_id,e.route.pickup_zone,pt[e.route.zone_id][e.offer_to[r].offer_to].lat,pt[e.route.zone_id][e.offer_to[r].offer_to].lon,pt[e.route.zone_id][e.offer_to[r].offer_to].zone_id)){t.resolve(10),i=!0;break}i||t.resolve(-1)}else t.resolve(-1)},2e3),t.promise},getDriverInOfferDelay:function(e){var t=this,o=e.offer_to_not,i=moment(t.getServerTime());if(""!=o)for(var r in o){var n=t.getOfferTime(o[r].group_id,o[r].offer_to_not);if(!(o[r].offer_to_not==window.localStorage.getItem("apikeypublic")||pt.hasOwnProperty(o[r].group_id)&&!pt[o[r].group_id].hasOwnProperty(o[r].offer_to_not)||o[r].hasOwnProperty("status")&&"quotecancelled"!=o[r].status)){var a=moment.utc(o[r].update_time,"MM/DD/YYYY HH:mm:ss"),s=i.diff(a,"seconds");if(s<n+l.offerNextDriverDelay/1e3)return 1e3*(n-s+10)}}return 0},getofferedDriversToCompare:function(e){var t=[];if(""!=e)for(key in e)t.push(e[key].offer_to);return t},quoteMyItemId:function(e,t){var o=we[e][t].route.items;if(!o||""==o||o==Ot[bt[e].position].item_id)return!0;var i=!1;if("object"==typeof o)for(key in o)if(Ot[bt[e].position].item_id==o[key]){i=!0;break}return i},areOfferDriversAvailable:function(e,t,o,i){var r=this,n=T.defer(),a=!1,s=we[e][t].offer_to;for(key in s)if(pt.hasOwnProperty(e)&&pt[e].hasOwnProperty(s[key].offer_to)&&(""==pt[e][s[key].offer_to].quote_id||"Offered"==pt[e][s[key].offer_to].quote_id)){a=!0;break}if(!a&&we.hasOwnProperty(i)&&we[i].hasOwnProperty(t)){var s=we[i][t].offer_to;for(key in s)if(pt.hasOwnProperty(i)&&pt[i].hasOwnProperty(s[key].offer_to)&&(""==pt[i][s[key].offer_to].quote_id||"Offered"==pt[e][s[key].offer_to].quote_id)){a=!0;break}}if(a)n.resolve(a);else{var l=we[e][t].route;if(pt[e]){for(var u in pt[e])if(u!=window.localStorage.getItem("apikeypublic")&&(""==pt[e][u].quote_id||"Offered"==pt[e][u].quote_id)&&mt[u][e]&&r.matchesTags(mt[u][e],l.selectService.split(",").filter(function(e){return e}))&&r.getGPSDistance(l.pickup_lat,l.pickup_lon,mt[u][e].lat,mt[u][e].lon)<l.range){a=!0;break}n.resolve(a)}else n.resolve(a)}return n.promise},getDriversOfferedOtherQuote:function(e,t){var o=this.getofferedDriversToCompare(e),i=[];for(var r in we)for(var n in we[r])if(we[r][n].route.quote_id!=t&&""!=we[r][n].offer_to_not){var a=we[r][n].offer_to_not;for(key in a)pt.hasOwnProperty(r)&&pt[r].hasOwnProperty(a[key].offer_to_not)&&"Offered"==pt[r][a[key].offer_to_not].quote_id&&o.indexOf(a[key].offer_to_not)>-1&&i.push(a[key].offer_to_not)}return i},setOfferTimeout:function(){var e=this;for(var t in Ze){D.cancel(Ze[t]);var o=t.split(",")[0],i=t.split(",")[1],r=we[o][i];delete Ze[""+o+","+i],r&&"offer"==r.route.status&&(yt=!0,e.offerFunc(r,o,i))}},getApiKeyDriverOffered:function(e){var t=e.offer_to_not||e.offer_to;if(t){var o=t[Object.keys(t)[Object.keys(t).length-1]];return o.offer_to_not||o.offer_to}},getLastOfferedDeclined:function(e,t){var o=we[t][e].offer_to_not;if(""==o)return!0;var i;for(key in o)void 0==i&&(i=key),moment(new Date(o[i].update_time)).isBefore(moment(new Date(o[key].update_time)))&&(i=key);return!o[i].hasOwnProperty("status")||"offerdeclined"!=o[i].status&&"quotecancelled"!=o[i].status?!1:!0},cancelOfferTimeout:function(){for(var e in Ze)D.cancel(Ze[e])},timeToShowOffer:function(e){if(!e)return 0;var t=null,o=e.offer_to,i=e.route;for(var r in o){var n=this.getGPSDistance(e.route.pickup_lat,e.route.pickup_lon,o[r].lat,o[r].lon),a=n/l.driverSpeedMPH*60;null==t?t=a:t>a&&(t=a)}var s=moment(i.selectDate+" "+i.selectTime,"MM/DD/YY hh:mm a"),u=moment(moment().tz(i.timeZone).format("MM/DD/YY hh:mm a"),"MM/DD/YY hh:mm a");if(s.diff(u,"minutes")<l.offerWaitingMin+t)var c=0;else var c=s.diff(u.add({minutes:l.offerWaitingMin+t}));return c},showOfferModal:function(e,t,i,r,n,a,s){var l=this,u=we[i][t].route;if(!Ze.hasOwnProperty(""+i+","+t)){var c=l.timeToShowOffer(a);if(mt[window.localStorage.getItem("apikeypublic")]&&mt[window.localStorage.getItem("apikeypublic")][i])var f=mt[window.localStorage.getItem("apikeypublic")][i].settings;M.offerCountDown=s||f&&f.offer||M.offerTime,M.offerMaxTime=f&&f.offer||M.offerTime,Ze[""+i+","+t]=D(function(){if(delete Ze[""+i+","+t],we.hasOwnProperty(i)&&we[i].hasOwnProperty(t)){if(M.isOffline||"offer"!=we[i][t].route.status||Y||l.isViewing("offerModal"))return void(yt=!1);var e=l.getGPSDistance(parseFloat(we[i][t].route.pickup_lat),parseFloat(u.pickup_lon),M.lat,M.lon),r=M.allow_reoffer?l.mergedInboxObj(we[i][t]):we[i][t],n=l.getIdOffered(r);!function(r){r&&(qe.hasOwnProperty(r.zoneId)||(qe[r.zoneId]=[]),qe[r.zoneId].push(r.routeId));var n=we[i][t].route;M.offerDetail={},M.offerDetail.id=n.id,M.offerDetail.zone_id=n.zone_id,M.offerDetail.pickup=n.pickup,M.offerDetail.pickup_lat=n.pickup_lat,M.offerDetail.pickup_lon=n.pickup_lon,M.offerDetail.dropoff=n.dropoff,M.offerDetail.selectService=n.selectService,M.offerDetail.selectPeople=n.selectPeople,M.offerDetail.selectDate=n.selectDate,M.offerDetail.selectTime=n.selectTime,M.offerDetail.route_distance=parseFloat(n.route_distance).toFixed(2),M.offerDetail.distance_pickup=parseFloat(e).toFixed(2),M.offerDetail.price=n.price,M.offerDetail.group_pic=Ot[bt[n.group_id].groupPosition].pic,n.hasOwnProperty("tip")&&(M.offerDetail.price=(n.price*(1+n.tip/100)).toFixed(1)),M.offerDetail.note=n.note,M.offerDetail.group_name=n.group_name,function(e){M.offerModal=!0,M.offeraccordion={},M.items=[];var t=["DETAIL","PICKUP","DROPOFF","SERVICE","SEATS","ROUTE","DATE_TIME","MILES","PICKUP_DISTANCE","NOTES"];d(t).then(function(e){l.getGoogleDistTime({lat:M.offerDetail.pickup_lat,lon:M.offerDetail.pickup_lon},{lat:M.lat,lon:M.lon}).then(function(t){M.items.push({label:e.PICKUP_DISTANCE,text:t.dist}),M.items.push({label:e.DATE_TIME,text:t.timeText}),"quote"==M.offerDetail.mode&&M.items.push({label:e.PRICE,text:M.offerDetail.price})}),M.offeraccordion.heading=e.DETAIL}),M.openDetail=function(e){"IMG"!==e.target.nodeName&&(M.isToggled=!M.isToggled)},b.fromTemplateUrl("modals/offer.html",{backdropClickToClose:!1,hardwareBackButtonClose:!1,scope:M}).then(function(t){if(M.offerModal=t,t.show(),M.showOfferCounter=!0,e){var i=z.child(e.zoneId+"/inbox/"+e.routeId),r={lat:M.lat,lon:M.lon,update_time:moment.utc().format("MM/DD/YYYY HH:mm:ss"),offer_to_not:window.localStorage.getItem("apikeypublic")},n=i.child("offer_to_not").push(),a=n.key(),s={};s["offer_to_not/"+a]=r,i.update(s,function(t){if(t)l.removeModalPopup(M,"offerModal"),ue=!1,l.processFirebase();else{if(i.transaction(function(t){return t&&t.offer_to?(1==Object.keys(t.offer_to).length?t.offer_to="":delete t.offer_to[e.key],t):void 0},function(e,t,o){}),dt.forEach(function(t){z.child(t+"/queue/"+window.localStorage.getItem("apikeypublic")+"/quote_id").set(e.routeObj.quote_id)}),!M.offerModal||M.bookingOut.indexOf(e.zoneId)>-1||!nt[e.zoneId])return;M.offerModal.show(),"app.trip-detail"==M.history.currentStateName()&&o.goBack();var r=l.getInboxesByQuoteId(e.routeObj.quote_id);r.forEach(function(e){var t=l.getIdOffered(we[e.group_id][e.id]);t&&l.offer(Ot[bt[t.zoneId].position],t.routeId,t.key,-4,"default","","",e.group_id)})}})}}),l.changeGroupStatus(Ot[bt[i].position],-4)}(r);var a=mt[window.localStorage.getItem("apikeypublic")]&&mt[window.localStorage.getItem("apikeypublic")][i]&&mt[window.localStorage.getItem("apikeypublic")][i].settings,u=s||a&&a.offer||M.offerTime;M.jailTimer=D(function(){ue=!0,null==M.offerModal||le||(l.removeModalPopup(M,"offerModal"),l.sendToJail(i),ue=!1)},1e3*u),M.showLoader=!1,l.ringTone(-1),l.addNotification("offer")}(n)}},c+n+r)}},getOfferNotId:function(e,t,o){if(we[e]&&we[e][t]&&""!=we[e][t].offer_to_not&&("offer"==we[e][t].route.status||o))for(var i in we[e][t].offer_to_not)if(we[e][t].offer_to_not[i].offer_to_not==window.localStorage.getItem("apikeypublic"))return{routeObj:we[e][t].route,zoneId:e,routeId:t,key:i,update_time:we[e][t].offer_to_not[i].update_time}},getOfferNotKeys:function(){var e=[];for(var t in we)for(var o in we[t])if(""!=we[t][o].offer_to_not&&"quote"==we[t][o].route.status)for(var i in we[t][o].offer_to_not)we[t][o].offer_to_not[i].offer_to_not==window.localStorage.getItem("apikeypublic")&&"quoteshown"==we[t][o].offer_to_not[i].status&&e.indexOf("offer_to_not[]="+i)<0&&e.push("offer_to_not["+t+"][]="+i);return e},getOfferId:function(e,t,o){if(we[e]&&we[e].hasOwnProperty(t)&&""!=we[e][t].offer_to&&we[e][t].hasOwnProperty("route")&&("offer"==we[e][t].route.status||o))for(var i in we[e][t].offer_to)if(we[e].hasOwnProperty(t)&&we[e][t].hasOwnProperty("offer_to")&&we[e][t].offer_to[i].offer_to==window.localStorage.getItem("apikeypublic"))return{routeObj:we[e][t].route,zoneId:e,routeId:t,key:i}},getIdOffered:function(e){if(""!=e.offer_to&&e.hasOwnProperty("route")&&"offer"==e.route.status)for(var t in e.offer_to)if(e.hasOwnProperty("offer_to")&&e.offer_to[t].offer_to==window.localStorage.getItem("apikeypublic"))return{routeObj:e.route,zoneId:e.offer_to[t].group_id,routeId:e.offer_to[t].inbox_id,key:t}},getOfferPosition:function(e,t,o){var i=this,r=o&&o.route||we[t][e].route,n=o&&o.offer_to||we[t][e].offer_to,a=o&&o.offer_to_not||we[t][e].offer_to_not,s=(r&&r.pickupZonesArr||[],this.getDriversOfferedOtherQuote(n,r.quote_id)),l=JSON.parse(r.mya2bers[0]),u=-1,c={},d=function(e){if("average"==e){for(var t in n)if(pt[n[t].group_id]&&pt[n[t].group_id][n[t].offer_to]){c[n[t].offer_to]||(c[n[t].offer_to]={},c[n[t].offer_to].pos=0,c[n[t].offer_to].avg=0,c[n[t].offer_to].length=0);var o=c[n[t].offer_to].avg*c[n[t].offer_to].length+pt[n[t].group_id][n[t].offer_to].timestamp,i=c[n[t].offer_to].pos*c[n[t].offer_to].length+pt[n[t].group_id][n[t].offer_to].position;c[n[t].offer_to].length++,c[n[t].offer_to].avg=o/c[n[t].offer_to].length,c[n[t].offer_to].pos=i/c[n[t].offer_to].length}for(var t in a)if(!c[a[t].offer_to_not]&&pt[a[t].group_id]&&pt[a[t].group_id][a[t].offer_to_not]){c[a[t].offer_to_not]||(c[a[t].offer_to_not]={},c[n[t].offer_to].pos=0,c[a[t].offer_to_not].avg=0,c[a[t].offer_to_not].length=0);var o=c[a[t].offer_to_not].avg*c[a[t].offer_to_not].length+pt[a[t].group_id][a[t].offer_to_not].timestamp,i=c[n[t].offer_to].pos*c[n[t].offer_to].length+pt[n[t].group_id][n[t].offer_to].position;c[a[t].offer_to_not].length++,c[a[t].offer_to_not].avg=o/c[a[t].offer_to_not].length,c[n[t].offer_to].pos=i/c[n[t].offer_to].length}}else{for(var t in n)pt[n[t].group_id]&&pt[n[t].group_id][n[t].offer_to]&&(c[n[t].offer_to]?pt[n[t].group_id][n[t].offer_to].timestamp<c[n[t].offer_to].avg&&(c[n[t].offer_to].avg=pt[n[t].group_id][n[t].offer_to].timestamp):(c[n[t].offer_to]={},c[n[t].offer_to].avg=pt[n[t].group_id][n[t].offer_to].timestamp));for(var t in a)!c[a[t].offer_to_not]&&pt[a[t].group_id]&&pt[a[t].group_id][a[t].offer_to_not]&&(c[a[t].offer_to_not]?pt[a[t].group_id][a[t].offer_to_not].timestamp<c[a[t].offer_to_not].avg&&(c[a[t].offer_to_not].avg=pt[a[t].group_id][a[t].offer_to_not].timestamp):(c[a[t].offer_to_not]={},c[a[t].offer_to_not].avg=pt[a[t].group_id][a[t].offer_to_not].timestamp))}};if(o.route.inboxArr.length>1){var f,p,m,g,_=i.getGPSDistance(r.pickup_lat,r.pickup_lon,ft[t][window.localStorage.getItem("apikeypublic")].lat,ft[t][window.localStorage.getItem("apikeypublic")].lon),h=_>r.range;if(d("average"),!c[window.localStorage.getItem("apikeypublic")])return 10;var v=c[window.localStorage.getItem("apikeypublic")].avg,y=c[window.localStorage.getItem("apikeypublic")].pos,w=l[window.localStorage.getItem("apikeypublic")];for(var b in n){var t=n[b].group_id;n[b].offer_to!=window.localStorage.getItem("apikeypublic")&&pt[n[b].group_id]&&pt[n[b].group_id].hasOwnProperty(n[b].offer_to)&&(""==pt[n[b].group_id][n[b].offer_to].quote_id||"Offered"==pt[n[b].group_id][n[b].offer_to].quote_id)&&s.indexOf(n[b].offer_to)<0&&(f=i.getGPSDistance(r.pickup_lat,r.pickup_lon,ft[t][n[b].offer_to].lat,ft[t][n[b].offer_to].lon),p=c[n[b].offer_to].avg,m=c[n[b].offer_to].pos,g=l[n[b].offer_to],h?(f<=Number(r.range)||_>f||g>w)&&u++:f<=Number(r.range)&&(g>=w&&v>p||p==v&&y>m||g>w)&&u++)}return u}var O=function(){var e,o,a,c,d=pt[t][window.localStorage.getItem("apikeypublic")].timestamp,f=pt[t][window.localStorage.getItem("apikeypublic")].position,p=i.getGPSDistance(r.pickup_lat,r.pickup_lon,ft[t][window.localStorage.getItem("apikeypublic")].lat,ft[t][window.localStorage.getItem("apikeypublic")].lon),m=l[window.localStorage.getItem("apikeypublic")],g=p>r.range;for(var _ in n)pt[t].hasOwnProperty(n[_].offer_to)&&"offerdeclined"!=n[_].status&&pt[t][n[_].offer_to]&&(e=pt[t][n[_].offer_to].timestamp,o=pt[t][n[_].offer_to].position,a=l[n[_].offer_to],n[_].offer_to!=window.localStorage.getItem("apikeypublic")&&(""==pt[t][n[_].offer_to].quote_id||"Offered"==pt[t][n[_].offer_to].quote_id)&&s.indexOf(n[_].offer_to)<0&&(c=i.getGPSDistance(r.pickup_lat,r.pickup_lon,ft[t][n[_].offer_to].lat,ft[t][n[_].offer_to].lon),g?(c<=Number(r.range)||p>c&&a>=m||a>m)&&u++:c<=Number(r.range)&&(a>=m&&d>e||e==d&&f>o||a>m)&&u++));return u};return""!=n&&1==Object.keys(n).length&&""!=we[t][e].offer_to_not&&0==Object.keys(we[t][e].offer_to_not).length?-1:O()},getOfferClosestTime:function(e,t){var o=this,i=T.defer(),r=we[t][e].route,n=we[t][e].offer_to,a=null,s=0;for(var l in n)!function(e){s++,ft[t].hasOwnProperty(n[l].offer_to)?o.getGoogleDistTime({lat:r.pickup_lat,lon:r.pickup_lon},{lat:ft[t][n[e].offer_to].lat,lon:ft[t][n[e].offer_to].lon}).then(function(e){null==a?a=e.timeVal:e.timeVal<a&&(a=e.timeVal),s==Object.keys(n).length&&i.resolve(a)},function(e){i.reject(e)}):s==Object.keys(n).length&&i.resolve(a)}(l);return i.promise},showQuoteModal:function(e,t){var o=this;re=!0,b.fromTemplateUrl("modals/quote.html",{scope:M,animation:"slide-in-up",backdropClickToClose:!1,hardwareBackButtonClose:!1}).then(function(t){M.quote_modal=t,D(function(){be.hasOwnProperty(e.id)?(M.bookingOut.indexOf(e.group_id)>-1||!nt[e.group_id]?o.quoteModalCleanUp():t.show(),o.ringTone(-1)):o.quote(M.quotes,-3).then(function(){M.bookingOut.indexOf(e.group_id)>-1||!nt[e.group_id]?o.quoteModalCleanUp():t.isShown()||(t.show(),o.ringTone(-1),o.addNotification())})},3e3)});var i='<ion-popover-view style="height: 60px;"><ion-content><ion-list><ion-item ng-click="showCancelTripModal(false)">Cancel</ion-item></ion-list></ion-content></ion-popover-view>';M.popoverQuote=O.fromTemplate(i,{scope:M}),M.showPopoverQuote=function(e){M.popoverQuote.show(e),M.showCancelTripModal()},M.confirmQuote=function(e,t){He=!0,M.showLoader=!0,Pe&&o.ringTone();var i=e?3:-3,r=[],n=[];for(var a in M.quotes){var s=M.quotes[a];-3==i?r.push(M.quotes[a]):s.enabled&&r.push(M.quotes[a]),p.quoteID.indexOf(s.quote_id)<0&&p.quoteID.push(s.quote_id);var l=M.quotes[a].zone_id,c=M.quotes[a].id;if(n.push("quoteid[]="+M.quotes[a].whmcs),"undefined"!=typeof we[l]&&!we[l].hasOwnProperty(c)||"undefined"!=typeof we[l]&&"quote"!=we[l][c].route.status)return o.quoteModalCleanUp(),void d(["SORRY","DRIVER_LATE_QUOTE"]).then(function(e){u.error(e.DRIVER_LATE_QUOTE,e.SORRY)})}var f=function(){o.quote(r,i,t).then(function(){o.quoteModalCleanUp(),W&&W(),H&&H()},function(){M.$broadcast("loading:hide"),d(["SOMETHING_WRONG","FAILED"]).then(function(e){k.alert({title:e.FAILED,template:e.SOMETHING_WRONG})})})};M.$broadcast("loading:show"),-3==i?o.cancelQuote(n).then(function(){f()},function(){M.$broadcast("loading:hide"),d(["SOMETHING_WRONG","FAILED"]).then(function(e){k.alert({title:e.FAILED,template:e.SOMETHING_WRONG})})}):f()},M.checkAllQuote=function(e){for(var t=0;t<M.quotes.length;t++)M.quotes[t].enabled=e},M.isChecked=function(){for(var e in M.quotes){var t=M.quotes[e];if(t.enabled)return!0}return!1},M.cancel={},d(["REASON1","REASON2","CUSTOM_MESSAGE","CANCEL_QUOTE"]).then(function(e){M.cancelreasons=[{text:e.REASON1,val:e.REASON1},{text:e.REASON2,val:e.REASON2},{text:e.CUSTOM_MESSAGE,val:e.CUSTOM_MESSAGE}],M.cancelTitle=e.CANCEL_QUOTE,M.customMessage=e.CUSTOM_MESSAGE}),M.reasonNotSelected=!0,M.otherSelected=!0,M.showCancelTripModal=function(){Pe&&o.ringTone(),M.cancelTripModal?(M.popoverQuote.hide(),M.cancelTripModal.show()):b.fromTemplateUrl("modals/trip-cancel.html",{scope:M}).then(function(e){M.cancel={},M.reasonNotSelected=!0,M.otherSelected=!0,M.cancelTripModal=e,r()})},M.removeCancelModal=function(){o.removeModalPopup(M,"cancelTripModal"),W&&W(),H&&H()};var r=function(){H=M.$watch("cancel.default",function(e,t,o){M.customMessage&&e==M.customMessage?(M.otherSelected=!1,M.reasonNotSelected=!0):void 0!=e&&(M.otherSelected=!0,M.reasonNotSelected=!1)}),W=M.$watch("cancel.other",function(e,t,o){void 0==e?M.reasonNotSelected=!0:""!=e.trim()&&(M.reasonNotSelected=!1)})};M.cancelTap=function(e){if(M.otherSelected||(e.$submitted=!0),M.otherSelected||e.$valid){var t=o.getOfferNotKeys();M.confirmQuote(!1,t)}}},checkPrice:function(){if(void 0!=M.rates[0]&&this.withinExpiryTime(this.getFBData()[M.rates[0].zone_id[0]][M.rates[0].quoteId]))if("offer"==M.rates[0].mode){var e={rate_id:M.rates[0].value,price:M.rates[0].price,zone_id:M.rates[0].zone_id,id:M.rates[0].quoteId,summary:M.rates[0].summary};M.loggedIn&&this.showOrderForm(e)}else if(null!=M.priceModal)for(var t=0;t<M.rates.length;t++)if(M.rates[t].value==M.selectedRate.rate_id){var e={rate_id:M.selectedRate.rate_id,price:M.rates[t].price,zone_id:M.rates[t].zone_id,id:M.rates[t].quoteId,summary:M.rates[t].summary};this.showPriceModal(),M.loggedIn&&this.showOrderForm(e);break}},showPriceModal:function(){ne=!0,delete pe[M.rates[0].quote_id];var e=this;M.selectedRate={},b.fromTemplateUrl("modals/rate.html",{scope:M,animation:"slide-in-up",backdropClickToClose:!1,hardwareBackButtonClose:!1}).then(function(t){M.priceModal=t,M.$broadcast("quoteaccepted"),M.$broadcast("loading:hide"),t.show(),0==M.rates.length&&M.$broadcast("loading:show"),e.addNotification("rate")});var t=["DETAIL","PRICE","PICKUP","DROPOFF","SERVICE","SEATS","ROUTE","DATE_TIME","MILES","NOTES"];d(t).then(function(e){M.accordion={};var t=we[M.rates[0].zone_id[0]][M.rates[0].quoteId].route;M.items=[{label:e.PICKUP,text:t.pickup},{label:e.DROPOFF,text:t.dropoff},{label:e.SERVICE,text:t.selectService},{label:e.SEATS,text:t.selectPeople},{label:e.ROUTE,text:t.route_distance+" "+e.MILES},{label:e.DATE_TIME,text:t.selectDate+" "+t.selectTime}],t.note.length>0&&""!=t.note[Object.keys(t.note)[0]]&&M.items.push({label:e.NOTES,text:t.note[Object.keys(t.note)[0]]}),M.accordion.heading=e.DETAIL});var o=function(){for(var e=0;e<M.rates.length;e++)if(M.rates[e].value==M.selectedRate.rate_id){var t={rate_id:M.selectedRate.rate_id,zone_id:M.rates[e].zone_id,group_id:M.rates[e].group_id,pickup_zone:M.rates[e].pickup_zone,price:M.rates[e].price,id:M.rates[e].quoteId,summary:M.rates[e].summary};break}return t};M.confirmRate=function(){return M.popoverPrice.hide(),V&&(V(),V=null),Pe&&e.ringTone(),void 0==window.localStorage.getItem("apikeypublic")?(M.priceModal.hide(),wt=!0,ne=!1,void E.transitionTo("app.login")):void e.showOrderForm(o())},M.openOrderForm=function(){M.loggedIn&&e.showOrderForm(o())},this.cancelQuoteCustomer()},cancelQuoteCustomer:function(){var e=this,t='<ion-popover-view style="height: 60px;"><ion-content><ion-list><ion-item ng-click="showCancelTripModal()">Cancel</ion-item></ion-list></ion-content></ion-popover-view>';M.popoverPrice=O.fromTemplate(t,{scope:M}),M.showPopoverPirce=function(e){M.popoverPrice.show(e)},V||(V=M.$watch("selectedRate.rate_id",function(e,t,o){void 0!=e?M.rateNotSelected=!1:M.rateNotSelected=!0})),M.cancelRate=function(){Pe&&e.ringTone(),e.removeModalPopup(M,"popoverPrice"),e.removeModalPopup(M,"priceModal"),V&&(V(),V=null),ne=!1},M.cancel={},d(["MESSAGE_CANCEL_CUSTOMER1","MESSAGE_CANCEL_CUSTOMER3","MESSAGE_CANCEL_CUSTOMER4","CUSTOM_MESSAGE","CANCEL_QUOTE"]).then(function(e){M.cancelreasons=[{text:e.MESSAGE_CANCEL_CUSTOMER1,val:e.MESSAGE_CANCEL_CUSTOMER1},{text:e.MESSAGE_CANCEL_CUSTOMER3,val:e.MESSAGE_CANCEL_CUSTOMER3},{text:e.MESSAGE_CANCEL_CUSTOMER4,val:e.MESSAGE_CANCEL_CUSTOMER4},{text:e.CUSTOM_MESSAGE,val:e.CUSTOM_MESSAGE}],M.cancelTitle=e.CANCEL_QUOTE,M.customMessage=e.CUSTOM_MESSAGE}),M.reasonNotSelected=!0,M.otherSelected=!0,M.showCancelTripModal=function(){Pe&&e.ringTone(),V&&(V(),V=null),M.cancelTripModal?(M.popoverPrice.hide(),M.cancelTripModal.show()):b.fromTemplateUrl("modals/trip-cancel.html",{scope:M}).then(function(e){M.cancel={},M.reasonNotSelected=!0,M.otherSelected=!0,M.cancelTripModal=e,M.popoverPrice.hide(),e.show(),o()})},M.removeCancelModal=function(){e.removeModalPopup(M,"cancelTripModal"),H&&H(),W&&W()};var o=function(){H=M.$watch("cancel.default",function(e,t,o){M.customMessage&&e==M.customMessage?(M.otherSelected=!1,M.reasonNotSelected=!0):void 0!=e&&(M.otherSelected=!0,M.reasonNotSelected=!1)}),W=M.$watch("cancel.other",function(e,t,o){void 0==e?M.reasonNotSelected=!0:""!=e.trim()&&(M.reasonNotSelected=!1)})};M.cancelTap=function(t){if(M.otherSelected||(t.$submitted=!0),M.otherSelected||t.$valid){for(var o=M.otherSelected?M.cancel["default"]:M.cancel.other,i=[],r=[],n=[],a=0;a<M.rates.length;a++){i.push("quote_id[]="+M.rates[a].quoteId),n.push("quote_id[]="+M.rates[a].whmcs),p.quoteID.push(M.rates[a].quoteId);for(var s=0;s<M.rates[a].zone_id.length;s++)r.indexOf(M.rates[a].zone_id[s])<0&&r.push("zone_id[]="+M.rates[a].zone_id[s])}var l=e.inboxesWithQuoteId(null,M.rates[0].quote_id,null),u={tripID:"",msg:o,status:-5,inbox:l};e.trip(u).then(function(t){M.$broadcast("loading:hide"),e.orderModalCleanUp(),e.removeModalPopup(M,"cancelTripModal"),H&&H(),W&&W()},function(){M.$broadcast("loading:hide"),d(["SOMETHING_WRONG","FAILED"]).then(function(e){k.alert({title:e.FAILED,template:e.SOMETHING_WRONG})})})}}},showLoginModal:function(){b.fromTemplateUrl("modals/login.html",{backdropClickToClose:!1,hardwareBackButtonClose:!1}).then(function(e){M.loginModal=e,e.show()})},showOrderForm:function(e){var t=this,o=function(e){d(["PAYMENT","PAY_DRIVER"]).then(function(t){M.paytext="card"==e?t.PAYMENT:t.PAY_DRIVER})};M.isAccordToggled=!0,M.openDetail=function(e){"IMG"!==e.target.nodeName&&D(function(){M.isAccordToggled=!M.isAccordToggled})},t.cancelQuoteCustomer(),wt=!0,ne=!1,M.tripSummary=e.summary,M.paymentChoice={};var i=[];null!=p.stripe?(p.stripe.forEach(function(e,t){null!=e.token&&i.push(e)}),i.reverse()):p.stripe=[],M.creditCards=i,M.haveCreditCard=M.creditCards.length>0,M.paymentChoice.choice=M.haveCreditCard?"card":"cash",M.newCard=!1,M.orderBackBtn=!1,M.showNext=!0,M.cardForm=!1,M.showCardForm=function(e){M.newCardForm=!1,M.orderBackBtn=e,M.cardForm=e,!M.haveCreditCard&&e?M.showNewCardForm():(M.newCard&&M.haveCreditCard&&(M.cardForm=!0,M.orderBackBtn=!0),M.newCard=!1),M.creditCards.length>0?("new card"!=M.paymentMethod&&(M.paymentMethod="card"),M.paymentNotSelected=!1):M.paymentNotSelected=!0,o("card")},M.showNewCardForm=function(){var e=f._instances,t=_(e).find(function(e){return"payment-page"===e.$element[0].id});t.scrollTop(!0),M.newCard=!0,M.paymentNotSelected=!0,M.newCardForm=!0},M.selectedCard={};var r=function(){if(M.creditCards.length>0){var e=a("filter")(M.creditCards,{token:"!null"})[0];M.selectedCard.token=e.token,M.selectedCard.brand=e.brand,M.selectedCard.last4=e.last4,e.hasOwnProperty("newcard")&&(M.selectedCard.newcard=e.newcard)}};r(),M.orderModal?M.orderModal.show():b.fromTemplateUrl("modals/stripeform.html",{scope:M,animation:"slide-in-up",backdropClickToClose:!1,hardwareBackButtonClose:!1}).then(function(e){M.orderModal=e,setTimeout(function(){M.$broadcast("loading:hide"),M.$broadcast("quoteaccepted")},1e3),t.countDownTimer(),e.show()}),M.range={},e.tip=0,M.range.tip=e.tip,M.priceWithTip=e.price,M.tipCalculate=function(t){e.tip=t,M.priceWithTip=(e.price*(1+t/100)).toFixed(1)};var n=["DETAIL","PRICE","PICKUP","DROPOFF","SERVICE","SEATS","ROUTE","DATE_TIME","MILES","NOTES"];d(n).then(function(e){M.accordion={},M.items=[{label:e.PRICE,text:M.tripSummary.price},{label:e.PICKUP,text:M.tripSummary.pickup},{label:e.DROPOFF,text:M.tripSummary.dropoff},{label:e.SERVICE,text:M.tripSummary.selectService},{label:e.SEATS,text:M.tripSummary.selectPeople},{label:e.ROUTE,text:M.tripSummary.route_distance+" "+e.MILES},{label:e.DATE_TIME,text:M.tripSummary.selectDate+" "+M.tripSummary.selectTime}],M.tripSummary.note.length>0&&""!=M.tripSummary.note[Object.keys(M.tripSummary.note)[0]]&&M.items.push({label:e.NOTES,text:M.tripSummary.note[Object.keys(M.tripSummary.note)[0]]}),M.accordion.heading=e.DETAIL}),M.paymentNotSelected=!1,M.cashSelected=function(){M.paymentNotSelected=!1,M.paymentMethod="cash",o("cash")},M.saveDateTime=function(e){M.creditcard.expiry=moment(new Date(e)).format("MM/YYYY");
},M.cardSelected=function(e){M.showCardForm(!1),M.selectedCard=e,e.hasOwnProperty("newcard")&&(M.selectedCard.newcard=e.newcard)},M.haveCreditCard?M.cardSelected(M.creditCards[0]):M.cashSelected(),M.newCardForm=!1;var s;M.newCardDone=function(e){if(s=e,e.$submitted=!0,e.$valid){M.$broadcast("loading:show");var t=M.creditcard.expiry;M.creditcard.expmonth=moment(t,"MM/YYYY").format("MM"),M.creditcard.expyear=moment(t,"MM/YYYY").format("YYYY"),Stripe.createToken({name:M.creditcard.name,number:M.creditcard.number,cvc:M.creditcard.cvc,exp_month:parseInt(M.creditcard.expmonth),exp_year:parseInt(M.creditcard.expyear)},l)}};var l=function(t,o){if(o.error)M.$broadcast("loading:hide"),d("FAILED").then(function(e){k.alert({title:e,template:o.error.message})});else{var i=o.id;e.token=JSON.stringify(o),i&&(M.$broadcast("loading:hide"),ye.push(JSON.stringify(o)),M.creditCards.unshift({newcard:e.token,brand:o.card.brand,exp_month:o.card.exp_month,exp_year:o.card.exp_year,last4:o.card.last4,name:o.card.name,token:o.id}),M.haveCreditCard=!0,M.paymentNotSelected=!1,p.stripe=M.creditCards.slice(0).reverse(),r(),M.paymentMethod="new card",M.newCardForm=!1,M.showCardForm(!1),M.paymentNotSelected=!1,e.paymentMethod="Card",M.creditcard={},s.$setPristine())}},c=function(e){e.opts=[],e.optIn=[],M.allow_reoffer||e.optIn.push("optIn[]=/"+e.zone_id+"/inbox/"+e.id);for(var o in we)for(var i in we[o])we[o][i].route.quote_id==we[e.zone_id][e.id].route.quote_id&&(e.opts.push("opts[]=/"+o+"/inbox/"+i),M.allow_reoffer&&we[o][i].route.price==e.price&&e.optIn.indexOf("/"+o+"/")<0&&e.optIn.push("optIn[]=/"+o+"/inbox/"+i));t.order(e).then(function(){e.token.length>40&&p.stripe&&p.stripe.forEach(function(t,o){t.hasOwnProperty("newcard")&&t.newcard==e.token&&delete p.stripe[o].newcard}),D(function(){t.orderModalCleanUp()},2e3),D(function(){t.timeToShowOffer(we[e.zone_id[0]][e.id])>0&&d(["SUCCESS","OFFER_SCHEDULED"]).then(function(e){M.$broadcast("loading:hide"),u.success(e.OFFER_SCHEDULED,e.SUCCESS)})},1e3)},function(){M.$broadcast("loading:hide"),d(["SOMETHING_WRONG","FAILED"]).then(function(e){k.alert({title:e.FAILED,template:e.SOMETHING_WRONG})})})};M.cancel_order=function(){t.removeModalPopup(M,"orderModal"),wt=!1,ne=!0,M.showInnerCountDown=!1,M.innerCountDown=void 0},M.creditcard={},M.charge=function(){return M.paymentNotSelected?void M.showCardForm(!0):(M.$broadcast("loading:show"),void t.areOfferDriversAvailable(e.zone_id[0],e.id,e.pickup_zone,e.group_id).then(function(o){if(!o&&0==t.timeToShowOffer(we[e.zone_id[0]][e.id])){It=!0;for(var i=[],r=0;r<M.rates.length;r++){var n=M.rates[r].zone_id[0],a=M.rates[r].id;i.push({quote_id:a,zone_id:n}),we[n][a].route.pickup_zone!=n&&i.push({quote_id:a,zone_id:we[n][a].route.pickup_zone}),we[n][a].route.zone_id!=we[n][a].route.group_id&&i.push({quote_id:a,zone_id:we[n][a].route.group_id})}return t.deleteInbox(i).then(function(){It=!1},function(e){}),d(["CURRENTLY_NO_DRIVERS","SORRY"]).then(function(e){M.$broadcast("loading:hide"),u.error(e.CURRENTLY_NO_DRIVERS,e.SORRY)}),void t.orderModalCleanUp()}M.$broadcast("loading:show"),"cash"==M.paymentMethod?(e.token="cash",e.paymentMethod="Cash",c(e)):(e.paymentMethod="Card",M.selectedCard.hasOwnProperty("newcard")?e.token=JSON.stringify(M.selectedCard.newcard).replace(/\\/g,"").slice(1,-1):e.token=M.selectedCard.token,c(e))}))}},setCategoryGroups:function(){if(null!=K)for(var e,t,o,i,r=0,n=0;n<K.length;n++)K[n].dispatcher>0?(r=n,e=K[n].booked,t=K[n].can_bookin,o=K[n].status,i=K[n].zone_id,!t&&K[n].tags.indexOf("Driver")>-1&&(K[0].hasDriver=!0)):""!=K[n].apikeypublic&&(U.hasOwnProperty(K[n].apikeypublic)||(U[K[n].apikeypublic]={}),U[K[n].apikeypublic][K[n].zone_id]=K[n],U[K[n].apikeypublic][K[n].category_id]=K[n],K[n].tags.indexOf("Driver")>-1&&(K[0].hasDriver=!0)),K[0].hasDriver||(K[0].hasDriver=!1),""!=K[n].apikeypublic&&K[n].apikeypublic!=window.localStorage.getItem("apikeypublic")?K[0].hasOtherItems=!0:K[0].hasOtherItems||(K[0].hasOtherItems=!1)},setGroups:function(){var e=this,t=[];if(null!=Ot){for(var o,i,r,n,a,s=0,l=0;l<Ot.length;l++)"My A2Bers"!=Ot[l].name&&(Ot[l].hasOwnProperty("can_bookin")&&(s=l,o=Ot[l].booked,i=Ot[l].can_bookin,r=Ot[l].status,n=Ot[l].zone_id,a=Ot[l].category_id!=Ot[l].zone_id),Ot[l].apikeypublic==window.localStorage.getItem("apikeypublic")&&(Ot[l].hasOwnProperty("can_bookin")?(Ot[s].iscustomer=0,(Ot[l].dispatcher>0||Ot[l].user_id==p.user_id)&&(bt[Ot[l].zone_id]={id:Ot[l].id,category_id:Ot[l].category_id,item_id:Ot[l].item_id,status:r,booked:o,can_bookin:i,position:l,groupPosition:s,withinzone:a,zone_id:n,tags:Ot[l].tags},bt[n]={id:Ot[l].id,category_id:Ot[l].category_id,item_id:Ot[l].item_id,status:r,booked:o,can_bookin:i,position:l,groupPosition:s,withinzone:a,zone_id:n,tags:Ot[l].tags}),1==Ot[l].active&&(Ot[l].can_bookin>0||p.user_id==Ot[l].user_id)?(Ot[l].can_toggle=1,Ot[l].dispatcherlink="#/app/employee/"+Ot[l].category_id+"/dispatcher"):(Ot[l].can_toggle=0,Ot[l].dispatcherlink="#/app/employee"),Ot[l].isOwner=Ot[l].user_id==p.user_id):(Ot[l].dispatcher<1&&(bt[Ot[l].zone_id]={id:Ot[l].id,category_id:Ot[l].category_id,zone:Ot[l].zone,item_id:Ot[l].item_id,status:r,booked:o,can_bookin:i,position:l,groupPosition:s,withinzone:a,zone_id:n,tags:Ot[l].tags},bt[n]={id:Ot[l].id,category_id:Ot[l].category_id,zone:Ot[l].zone,item_id:Ot[l].item_id,status:r,booked:o,can_bookin:i,position:l,groupPosition:s,withinzone:a,zone_id:n,tags:Ot[l].tags},Ot[s].withinzone=!0,Ot[s].my_tags=Ot[l].tags,Ot[s].allow_queue=Ot[s].settings&&"yes"==Ot[s].settings.allow_queue||M.allow_queue,Ot[s].require_upload=Ot[s].settings&&Ot[s].settings.settings&&Ot[s].settings.settings.indexOf("rquire_uppload")>-1||ct.indexOf(Ot[s].category_id)>-1&&M.rquire_uppload,Ot[s].biddable=Ot[s].settings&&Ot[s].settings.settings&&Ot[s].settings.settings.indexOf("biddable")>-1||M.biddable),1==Ot[l].active&&1==Ot[s].active?(Ot[l].tags.indexOf("Driver")>-1||Ot[l].tags.indexOf("Admin")>-1||Ot[l].tags.indexOf("Dispatcher")>-1?(Ot[s].mode||(Ot[s].mode=M.partnersQMode),Ot[s].can_toggle=1,Ot[s].isDriver=Ot[l].tags.indexOf("Driver")>-1):Ot[s].can_toggle=0,Ot[s].dispatcherlink="#/app/employee/"+Ot[s].category_id+"/dispatcher"):(Ot[s].can_toggle=0,Ot[s].dispatcherlink="#/app/employee"),Ot[l].tags.indexOf("Customer")>-1&&Ot[l].tags.indexOf("Driver")<0&&Ot[l].tags.indexOf("Dispatcher")<0&&Ot[l].tags.indexOf("Admin")<0?Ot[s].iscustomer=1:Ot[s].iscustomer=0,Ot[l].isOwner=Ot[s].isOwner),lt.indexOf(Ot[l].category_id)<0&&t.push(Ot[l].category_id)));t.length>0&&t.forEach(function(t){e.initFirebase(t)});var u=!1,c=!1,d=1e4,f=!1;for(var n in bt)Ot[bt[n].groupPosition]&&n==Ot[bt[n].groupPosition].category_id&&bt[n].can_bookin>0&&((void 0==Ot[bt[n].groupPosition]||void 0==Ot[bt[n].position])&&(delete bt[n],M.$broadcast("firebase:updated")),bt.hasOwnProperty(n)&&lt.indexOf(bt[n].category_id)>-1&&bt[n].category_id!=n&&(bt[lt[lt.indexOf(bt[n].category_id)]]=bt[n]),bt[n].can_bookin>0&&bt[n].booked,bt[n].can_bookin>0&&bt[n].booked&&Ot[bt[n].groupPosition].QP&&Ot[bt[n].groupPosition].QP.toString().indexOf("/")>-1?(f||(u=!0),c=!0,d>bt[n].category_id&&(d=bt[n].category_id)):(u=!1,f=!0));if(M.listenedQueue&&!G&&!M.detail&&!It){var m=M.tappedGroup&&bt[M.tappedGroup.category_id];u?((!M.hasDriverQP&&"app.employee-index"==M.history.currentStateName()||"app.login"==M.history.currentStateName())&&E.transitionTo("app.driver-home"),M.hasDriverQP=u,M.driverHomeGroup=Ot[bt[d].position]):(!m||m&&(!m.booked||m.booked&&Ot[m.groupPosition].QP&&Ot[m.groupPosition].QP.toString().indexOf("/")<0))&&(M.hasDriverQP=u,M.tappedGroup=null,"app.driver-home"==M.history.currentStateName()&&E.transitionTo("app.employee-index")),M.hasOneDriverQP=c,c&&(M.driverHomeGroup=Ot[bt[d].position])}"app.employee-dispatcher"!=E.current.name||void 0===M.isOwner||0!=M.isOwner||bt[M.history.currentView().url.match(/\d+/)[0]].booked||E.transitionTo("app.employee-index")}},myRatings:function(){var e=T.defer();return x.get(q+"myrating/?"+s.getParams()).success(function(t,o){t.customer&&(M.myDriverRating=p.myDriverRating=t.customer.toFixed(2)),t.driver&&(M.myCustomerRating=p.myCustomerRating=t.driver.toFixed(2)),e.resolve()}).error(function(t){e.reject()}),e.promise},haveDocuments:function(){return!(0==M.myVehicles.length||0==M.myPermits.length||null==M.picData)},checkForms:function(e,t){if(!this.haveDocuments())return void 0==e&&E.transitionTo("app.forms",{vehicle:0==M.myVehicles.length,permit:0==M.myPermits.length}),!1;var o=!1,i=!1;return M.myVehicles.forEach(function(e){moment(e.title_expiry_date).isAfter()&&moment(e.permit_expiry_date).isAfter()&&(o=!0)}),M.myPermits.forEach(function(e){moment(e.permit_expiry_date).isAfter()&&(i=!0)}),o&&i?null!=M.vehiclePermit.vehicle&&null!=M.vehiclePermit.permit&&(moment(M.vehiclePermit.vehicle.permit_expiry_date).isAfter()||moment(M.vehiclePermit.vehicle.title_expiry_date).isAfter()||moment(M.vehiclePermit.permit.permit_expiry_date).isAfter())?(this.showVehiclePermit(t),!1):null==M.vehiclePermit.vehicle||null==M.vehiclePermit.permit?(this.showVehiclePermit(t),!1):!0:(void 0==e&&E.transitionTo("app.forms",{vehicle:!o,permit:!i}),!1)},setLicensePermit:function(e,t){null==M.vehiclePermit&&(M.vehiclePermit={}),e&&"undefined"!=e&&t&&"undefined"!=t&&(M.vehiclePermit.permit=t,M.vehiclePermit.vehicle=e,p.permit=t,p.vehicle=e,M.setVehiclePermit(p.vehicle,p.permit))},showVehiclePermit:function(e){var t=this;M.saveVehiclePermit=function(){null!=M.vehiclePermit.permit&&null!=M.vehiclePermit.vehicle&&(M.isExpired(M.vehiclePermit.permit)||M.isExpired(M.vehiclePermit.vehicle)||(null==p.permit&&(t.setLicensePermit(M.vehiclePermit.vehicle,M.vehiclePermit.permit),t.toggleBook(e[0],e[1]).then(function(e){})),p.permit=M.vehiclePermit.permit,p.vehicle=M.vehiclePermit.vehicle,t.removeModalPopup(M,"vehiclePermitModal")))},M.vehiclePermit.permit=p.permit,M.vehiclePermit.vehicle=p.vehicle,M.vehiclePermitData={vehicle:M.myVehicles,permit:M.myPermits},M.isExpired=function(e){return e.hasOwnProperty("title_expiry_date")?moment(e.permit_expiry_date).isBefore()||moment(e.title_expiry_date).isBefore():moment(e.permit_expiry_date).isBefore()},M.vehiclePermitModal?M.vehiclePermitModal.show():b.fromTemplateUrl("modals/vehicle_permit.html",{backdropClickToClose:!1,scope:M}).then(function(e){M.vehiclePermitModal=e,e.show(),M.$broadcast("loading:hide")})},getVehiclePermit:function(){return{vehicle:p.vehicle,permit:p.permit}},getFavGroupId:function(){return Et},itemsApi:function(e,t){var o=T.defer(),i=q+"items/?"+s.getParams(t);return e&&(i+=e),x.get(i).success(function(e,t){o.resolve(e)}).error(function(e){o.reject(e)}),o.promise},findAllEmployees:function(){var e=T.defer();if(M.appoverdue||!M.loggedIn)return e.resolve(),e.promise;var t=this,o=function(o){t.itemsApi("&myitem=true").then(function(o){if("failed"==o.status.toLowerCase())t.setEmployees(null),window.localStorage.getItem("apikeypublic")!=Tt?(Se=!1,"app.employee-index"==M.history.currentStateName()&&E.transitionTo("app.quoteform"),p.isDriver=!1):(Se=!0,p.isDriver=!0),M.$broadcast("user:updated",Se),M.$broadcast("canbookin:updated",Ee),e.resolve(o);else{Se=!1,p.isDriver=!1,M.itemNotBooked=null!=M.itemNotBooked&&0!=M.itemBooked?M.itemNotBooked:1;var i=o.items,r=[];if(i.every(function(e,o){if("My A2Bers"==e.name&&e.user_id==p.user_id)return Et=e.category_id,0==Nt.length&&t.setMyA2BerDrivers(),!0;if(e.apikeypublic==Tt&&ct.indexOf(e.category_id)<0&&ct.push(e.category_id),e.dispatcher<1&&e.apikeypublic==window.localStorage.getItem("apikeypublic")){if(e.overdue&&e.overdue.app<0)return M.appoverdue=e.overdue.app,!1;(""==e.tags||e.tags.indexOf("Driver")>-1||e.tags.indexOf("Admin")>-1||e.tags.indexOf("Dispatcher")>-1)&&(Se=p.isDriver=!0),(e.tags.indexOf("Driver")>-1||e.tags.indexOf("Admin")>-1||e.tags.indexOf("Dispatcher")>-1)&&(Ee=!0)}else e.dispatcher>0&&e.apikeypublic==window.localStorage.getItem("apikeypublic")&&(Se=p.isDriver=!0);return e.hasOwnProperty("can_bookin")?z.child("images/"+e.category_id).once("value",function(o){o.exists()?e.pic=o.val():e.user_id==p.user_id&&p.picData?t.savePic(p.picData,"group",e.category_id).then(function(){},function(e){}):e.pic="img/group_placeholder.jpg",z.child(e.category_id+"/queue/"+window.localStorage.getItem("apikeypublic")+"/pic").once("value",function(t){t.exists()&&e.user_id==p.user_id&&t.val().indexOf("town_car")<0&&(e.pic=t.val(),M.$broadcast("items:loaded"))})}):e.pic="img/person.jpg",!0}),M.appoverdue)return M.hideLoader(),void d(["SORRY","APP_OVERDUE1","APP_OVERDUE2"]).then(function(e){if(ionic.Platform.isWebView()){var t=k.alert({title:e.SORRY,template:e.APP_OVERDUE1+Math.abs(M.appoverdue)+e.APP_OVERDUE2});t.then(function(e){ionic.Platform.exitApp()})}else M.showMsg(e.APP_OVERDUE1+Math.abs(M.appoverdue)+e.APP_OVERDUE2,!0)});r.forEach(function(e){i.splice(i.indexOf(e),1)}),t.setEmployees(i),t.setGroups(),M.isAppOwner=t.isOwner(),M.$broadcast("user:updated",Se),M.$broadcast("canbookin:updated",Ee),e.resolve(o)}M.picData=p.picData,t.myRatings()["finally"](function(){t.getPOIs(!0)["finally"](function(){null==M.tags&&t.getTags()["finally"](function(){})})}),M.showVehiclePermit=t.showVehiclePermit,t.setLicensePermit(p.vehicle,p.permit),M.isNotCustomer||"app.employee-index"!=M.history.currentStateName()||E.transitionTo("app.quoteform")},function(e){})};return o(0),e.promise},findAll:function(){var e=T.defer();return e.resolve(Ot),e.promise},findById:function(e){if(e)var t=K[e-1];else var t=Ot[bt[Object.keys(bt)[0]].position];return t},findByName:function(e){var t=T.defer(),o=Ot.filter(function(t){var o=t.firstName+" "+t.lastName;return o.toLowerCase().indexOf(e.toLowerCase())>-1});return t.resolve(o),t.promise},findByManager:function(e){var t=T.defer();return findByManager=function(){results=Ot.filter(function(t){return parseInt(e)===t.managerId&&t.dispatcher<1}),t.resolve(results)},null==Ot?this.findAllEmployees().then(function(){findByManager()}):findByManager(),t.promise},findByCategoryId:function(e,t){var o,i=T.defer(),r=this,n=function(){K=r.getCategEmployees(),o=K.filter(function(t){return e===t.category_id&&t.dispatcher<1}),i.resolve(o)};return K&&!t?n():(this.emptyEmployeesCateg(),M.$broadcast("loading:show"),this.itemsApi("&category_id[]="+e).then(function(t){"failed"==t.status.toLowerCase()?(M.$broadcast("loading:hide"),i.reject(t)):(K=t.items,r.setCategoryGroups(),z.child(e+"/queue").orderByChild("timestamp").once("value",function(t){r.setEmpl(t,e)}),n(),M.$broadcast("loading:hide"))},function(e){i.reject(e)})),i.promise},getInboxesByQuoteId:function(e){var t=[];for(var o in we)for(var i in we[o])we[o][i].route.quote_id==e&&t.push(we[o][i].route);return t},is_in_zone:function(e,t,o,i){var r=e.length,n=j=c=0;for(n=0,j=r-1;r>n;j=n++)t[n]>i!=t[j]>i&&o<(e[j]-e[n])*(i-t[n])/(t[j]-t[n])+parseFloat(e[n])&&(c=!c);return c},setEmployees:function(e){if(null==Ot)angular.forEach(e,function(e){e.dispatcher>0&&(e.booked=!1,e.status=-2,e.QP="Q",e.showQP=!1)});else e:for(var t in e)if(0!=e[t].dispatcher)for(var o in Ot)if(e[t].dispatcher>0){if(e[t].id==Ot[o].id){e[t].booked=Ot[o].booked,e[t].status=Ot[o].status,e[t].QP=Ot[o].QP,e[t].showQP=Ot[o].showQP;continue e}e[t].booked=!1,e[t].status=-2,e[t].QP="Q",e[t].showQP=!1}Ot=e},updateEmployee:function(e){},changeGroupStatus:function(e,t){var o=0;"string"==typeof e||Object.getPrototypeOf(e)===Object.prototype?angular.forEach(Ot,function(i){(i.dispatcher>0&&"all"==e||i.dispatcher>0&&i.id==e.id)&&(Ot[o].status=t,2==t?(Ot[o].booked=!0,Ot[o].showQP=!0):-2==t&&(Ot[o].booked=!1,Ot[o].showQP=!1)),o++}):dt.forEach(function(e,o){if(bt.hasOwnProperty(e)){var i=bt[e].groupPosition;2==t?(Ot[i].booked=!0,Ot[i].showQP=!0):-2==t&&(Ot[i].booked=!1,Ot[i].showQP=!1)}}),this.setAllBookedStatus(),this.setGroups()},setAllBookedStatus:function(){M.itemBooked=0,M.itemNotBooked=0;var e=0,t=Object.keys(bt).length;for(var o in bt)Ot[bt[o].groupPosition].booked?M.itemBooked++:0==Ot[bt[o].groupPosition].booked&&M.itemNotBooked++,e==t-1&&0==M.itemBooked&&0==M.itemNotBooked&&(M.itemNotBooked=1),e++},getEmployees:function(){return null==Ot?new Array:Ot},getCategEmployees:function(){return null==K?new Array:K},emptyAllEmployees:function(){J&&(J.length=0,J=null)},emptyEmployeesCateg:function(){K&&(K.length=0,K=null)},getAllStoredEmployees:function(){return null==J?new Array:J},getDispEmplByApikey:function(e){var t;return K?(K.some(function(o){return t=o,o.apikeypublic==e}),t):!1},getAllEmployees:function(){var e=T.defer();return J?e.resolve(J):this.itemsApi().then(function(t){"failed"==t.status.toLowerCase()?e.reject(t):(J=t.items,e.resolve(J))},function(t){e.reject(t)}),e.promise},coupon:function(e){var t=T.defer();return x.get(q+"promocode/?selectCoupon[]="+e+"&"+s.getParams()).success(function(e){t.resolve(e)}).error(function(e){M.$broadcast("loading:hide"),d(["SOMETHING_WRONG","FAILED"]).then(function(e){k.alert({title:e.FAILED,template:e.SOMETHING_WRONG})}),t.reject(e)}),t.promise},sendQuote:function(e){function t(e,t){t=t&&t.toLowerCase();for(var o="",i=0,r="a"==t?10:0,n="n"==t?10:62;i++<e;){var a=Math.random()*(n-r)+r<<0;o+=String.fromCharCode(a+=a>9?36>a?55:61:48)}return o}var o=T.defer();this.setQuoteDateTime(e);var i=q+"quote/?"+s.getParams(null,!0)+"&"+e.items.join("&")+"&"+e.group_id.join("&")+"&"+e.zone_id.join("&")+"&"+e.mya2bers.join("&")+"&"+e.pickup_zone.join("&")+"&_token="+t(40)+("&tripfrequency=oneway&"+e.splitFare.join("&")+'&sent_to_message=""&eta_distance[]='+e.estDistVal+"&eta_time[]="+e.estTimeVal+"&pickup[]="+e.pickup.formatted_address+"&pickup_lat[]="+e.pickup.lat+"&pickup_lon[]="+e.pickup.lon+"&dropoff[]="+e.dropoff.formatted_address+"&dropoff_lat[]="+e.dropoff.lat+"&dropoff_lon[]="+e.dropoff.lon+"&route_distance[]="+e.distance+"&selectDate[]="+e.date+"&selectTime[]="+e.time+"&selectPeople[]="+e.people+"&note[]="+e.note+"&selectPrice[]="+(e.price||l.defaultPrice)+"&selectService[]="+e.service+"&range[]="+e.range+"&qmode="+(e.mode||M.quoteQMode)+"&mode=route&status=").replace(/ /g,"+").replace(/,/g,"%2C").replace(/[[]/g,"%5B0").replace(/[\]]/g,"%5D").replace(":","%3A").replace(/\//g,"%2F");return null!=e.coupon&&(i+="&coupon="+e.coupon),x.get(i).success(function(e){o.resolve(e),We=e.quoteID,window.localStorage.setItem("quote_Id",We)}).error(function(e){o.reject(e)}),o.promise},setQuoteDateTime:function(e){var t={};t=e;var o=e.hasOwnProperty("date")?"date":"selectDate",i=e.hasOwnProperty("time")?"time":"selectTime",r=moment(moment.tz(moment(e[o]+" "+e[i],"MM/DD/YY hh:mm a"),e.timezone).format("MM/DD/YY hh:mm a"),"MM/DD/YY hh:mm a");t[o]=r.format("MM/DD/YY"),t[i]=r.format("hh:mm a");var n=r.add(M.allow_advance_reservation,"minutes"),a=r.add(M.allow_remote_reservation,"minutes");r.isBefore(n)?(t[o]=n.format("MM/DD/YY"),t[i]=n.format("hh:mm a")):r.isAfter(a)&&(t[o]=a.format("MM/DD/YY"),t[i]=a.format("hh:mm a"))},getVehicleData:function(e){var t=T.defer();return x.get("https://api.edmunds.com/api/vehicle/v2/vins/"+e+"?fmt=json&api_key=9mjx9dzqsq8gzjcehjmcnyuq").success(function(e){t.resolve(e)}).error(function(e){t.reject(e)}),t.promise},getAllDrivers:function(){return pt},getUniqueDrivers:function(){return mt},getBookedZoneId:function(e){return nt[e]?nt[e].id:!1},driversAvailable:function(e){var t=!1;for(zone in pt)if(!e||e==zone)for(var o in pt[zone])if(""==pt[zone][o].quote_id){t=!0;break}return t},getAllUniqueDrivers:function(){var e={},t=[];for(var o in pt)for(var i in pt[o])t.indexOf(i)<0&&(t.push(i),e[i]=pt[o][i]);return e},setNearestFurthestDriver:function(e,t,o,i){var r=12e3,n=0,a=1e4,s=0;if(void 0!=i)for(var u in o){if(o[u].hasOwnProperty("lat"))var c={lat:o[u].lat,lon:o[u].lon};else var c={lat:o[u].getPosition().lat(),lon:o[u].getPosition().lng()};var d=this.getGPSDistance(i.lat,i.lon,c.lat,c.lon),f=d/l.driverSpeedMPH*60;r>d&&(r=parseFloat(d)),d>n&&(n=parseFloat(d)),a>f&&(a=Math.ceil(f),a=0==a?1:a),f>s&&(s=Math.ceil(f)),12e3==r&&(r=parseFloat(d)),0==n&&(n=parseFloat(d)),1e4==a&&(a=parseFloat(f)),0==s&&(s=parseFloat(f)),M.$broadcast("queue:rangeTime",a,s),M.$broadcast("queue:range",r.toFixed(1),n.toFixed(1))}},resetETA:function(){ie={}},setNearestFurthestDrivers:function(e,t,o,i,r){if(e){var n={lat:o,lon:i},a=this.getGPSDistance(r.lat,r.lon,n.lat,n.lon),s=a/l.driverSpeedMPH*60;"removed"==e&&ie[t]&&!Ce.all[t]?delete ie[t]:ie[t]=0==Math.ceil(s)?1:parseFloat(Math.ceil(s));var u=Object.keys(ie).sort(function(e,t){return ie[e]-ie[t]}),c=ie[u[0]],d=ie[u[u.length-1]];return{nearestDriverTime:c,furthestDriverTime:d}}var u=Object.keys(ie),c=ie[u[0]],d=ie[u[u.length-1]];return{nearestDriverTime:c,furthestDriverTime:d}},inboxesWithQuoteId:function(e,t,o){var i=[];for(var r in we)for(var n in we[r])(!o||o!=r)&&o||we[r][n].route.quote_id!=t||e&&we[r][n].route.id==e||i.push({quote_id:n,zone_id:r});return i},cleanModals:function(e,t,o){var i=this;It&&M.detail&&M.detail.id==t?i.endTrip(t):vt.indexOf(o.route.quote_id)>-1&&this.inboxesWithQuoteId(t,o.route.quote_id).length<1?(vt.splice(vt.indexOf(o.route.quote_id),1),M.dontHideLoader=!1,M.$broadcast("loading:hide"),i.removeModalPopup(M,"tripModal")):null!=M.quote_modal&&M.quotes.length>0&&void 0!=o&&o.route.quote_id==M.quotes[0].quote_id?i.quoteModalCleanUp():null!=M.offerModal&&M.offerDetail&&M.offerDetail.id==t?(i.removeModalPopup(M,"offerModal"),i.resetQuoteID(),M.offerNotInProcess=!0,M.$broadcast("loading:hide"),D.cancel(M.jailTimer),Pe&&i.ringTone()):(wt||ne)&&M.rates.forEach(function(e,o){e.quoteId==t&&(M.rates.splice(o,1),0==M.rates.length&&i.orderModalCleanUp())})},authenticateToken:function(){var e=this,t=T.defer();Be=!1;var o=function(){e.autologin().then(function(e){i(e)})},i=function(i){z.authWithCustomToken(i,function(i,r){i?o():(M.noGroups||ut.forEach(function(t,o){e.initFirebase(t,o),e.setGroups()}),t.resolve())})};return o(),t.promise},saveFbTimestamp:function(){p.savedTimeStamps={},dt.forEach(function(e){p.savedTimeStamps[e]=pt[e][window.localStorage.getItem("apikeypublic")].timestamp})},restoreFbTimestamp:function(){if(Dt.diff(ot,"seconds")<A){for(var e in p.savedTimeStamps)!function(e){z.child(e+"/queue/"+window.localStorage.getItem("apikeypublic")).update({timestamp:p.savedTimeStamps[e]},function(e){e||(p.savedTimeStamps={})})}(e);p.savedTimeStamps={}}},authenticateFirebase:function(){var e=this,t=function(){return M.app_suspended?(M.$broadcast("loading:hide"),void E.transitionTo("app.suspended")):(M.startupLoading&&e.autologinApi(),void e.findAllEmployees().then(function(t){M.$broadcast("items:loaded"),e.authenticateToken().then(function(){Be&&(Be=!1,e.autologin())})}))};null!=M.lat?t():N||(N=I(function(){null!=M.lat&&(I.cancel(N),t(),N=null)},2e3))},getzoneIDs:function(){return lt},getzoneMap:function(){return it},getrateMap:function(){return rt},getzoneIDStored:function(){return st},savePic:function(e,t,o){var i=T.defer(),r=z.child("images/"+window.localStorage.getItem("apikeypublic"));if(o)var r=z.child("images");var n={};return o?n[o]=e:n[t]=e,r.update(n,function(e){e?i.reject(e):i.resolve()}),i.promise},updateQueuePic:function(e){z.child("images/"+window.localStorage.getItem("apikeypublic")).once("value",function(t){if(t.exists()){var o="data:image/jpeg;base64,"+t.val(),i=z.child(e+"/queue/"+window.localStorage.getItem("apikeypublic"));i.update({pic:o},function(e){})}})},getTimeZone:function(e,t){var o=T.defer();return $.ajax({timeout:1e4,url:"https://maps.googleapis.com/maps/api/timezone/json?location="+e+","+t+"&timestamp="+Math.round((new Date).getTime()/1e3).toString()+"&sensor=false"}).done(function(e){null!=e.timeZoneId&&o.resolve(e)}).fail(function(e){o.reject(e)}),o.promise},setTag:function(e,t,o,i,r,n){var a,s=angular.copy(Ae),l=0,u=this.getUniqueDrivers();for(var c in u){var d=void 0!=o?u[c][o]:u[c][Object.keys(u[c])[0]];d&&void 0!=d.tags&&(a=this.someFunc("added",s,d,c,e,i,o,t,null,null,r,n,!0))}if(a)var f=a.skipTags?a.skipTags:a.tags;return a&&0!=Object.keys(f.all).length?(Ce=a.tags,l=Object.keys(f.all).length):l},setMilesRanges:function(){Mt={.5:[]};var e,t=1;do e=1==t?1:5*(t-1),Mt[e]=[],t++;while(e<=M.milesRadius)},setRanges:function(e,t,o,i){var r,n=this,a=n.getGPSDistance(o.lat,o.lon,i.lat,i.lon);r=e?a:30,n.addDeleteFromRange(t,r)},addDeleteFromRange:function(e,t){for(var o in Mt){var i=Mt[o].indexOf(e);o>=t?0>i&&Mt[o].push(e):i>-1&&Mt[o].splice(i,1)}},getGpsRanges:function(){return Mt},getGroupItems:function(){return bt},removeServ:function(e,t,o,i,r,n){for(var a=[],s=o.length-1;s>=0;)t.tags.indexOf(o[s])<0&&(i[s].checked&&a.push(o[s]),o.splice(s,1),i.splice(s,1)),s-=1;return a},addTag:function(e,t,o,i){("all"==t||_.intersection([t],rt[o.group_id]).length>0)&&(e[t][i]?e[t][i].indexOf(o.group_id)<0&&e[t][i].push(o.group_id):e[t][i]=[o.group_id])},deleteTag:function(e,t,o,i){if(e[t].hasOwnProperty(i)){var r=e[t][i].indexOf(o.group_id);r>-1&&e[t][i].splice(r,1),0==e[t][i].length&&delete e[t][i]}},someFunc:function(e,t,o,i,r,n,a,s,l,u,c,d,f,p){var m,g=this,h=[],v=d||M.milesRadius,y=!1,w=function(e,r){var a=r?t:b;e?g.deleteTag(a,"all",o,i):g.addTag(a,"all",o,i),o.tags.forEach(function(t){a.hasOwnProperty(t)&&(e?g.deleteTag(a,t,o,i):g.addTag(a,t,o,i),l&&((!n||n&&s!=t)&&0==Object.keys(a[t]).length&&0==Object.keys(ze[t]).length&&(new RegExp(t).test(s)&&h.indexOf(t)<0&&h.push(t),l.indexOf(t)>-1&&(u.splice(l.indexOf(t),1),l.splice(l.indexOf(t),1))),Object.keys(a[t]).length>0&&l.indexOf(t)<0&&(l.push(t),u.push({id:t,text:t,"class":"taxicar",checked:!1,icon:"pics/taxi.png"}))))})},b=angular.copy(t);if(n&&!c&&(m=Object.keys(n)[0],!t.all.hasOwnProperty(Object.keys(n)[0]))){var O=n[m];O.selectService.split(",").forEach(function(e){g.addTag(t,e,O,m),l.indexOf(e)<0&&(l.push(e),u.push({id:e,text:e,"class":"taxicar",checked:!0,icon:"pics/taxi.png"}))}),g.addTag(t,"all",O,m),w(!1)}if(void 0!=t&&void 0!=t.all){var g=this;if(void 0!=a&&o.group_id!=a)return{tags:t,removedServices:h,services:l,servicesObjArr:u};if(!n||n&&m!=i){g.setRanges("removed"!=e,i,o,r);var k="app.quoteform"==M.history.currentStateName()?M.quoteQMode:M.dispatcherQMode;"undefined"!=typeof Mt[M.milesRadius]&&Mt[M.milesRadius].length>0&&Mt[v].length<1&&!f&&(y=v,v=M.milesRadius);var P=i!=window.localStorage.getItem("apikeypublic")&&rt[o.group_id]&&_.intersection(o.tags,rt[o.group_id]).length>0&&Mt[v].indexOf(i)>-1&&!o.disconnectTime&&""==o.quote_id&&o.tags.indexOf("Driver")>-1,S="offer"==k||k==o.mode?t:b,I=!1;if(p){if(p.indexOf(o.zone_id)>-1){var D=P&&!0;I=!0}}else var D=P&&g.withinZone(o.group_id,null,r.lat,r.lon,o.lat,o.lon);D?"removed"!=e?(w(!1),"offer"==k||k==o.mode?w(!1,!0):w(!0,!0)):(w(!0),w(!0,!0)):S.all[i]&&S.all[i].length>0&&(w(!0),w(!0,!0))}var x=M.bidOnDrivers.indexOf(i);if("removed"!=e&&0>x&&"quote"==o.mode&&M.bidOnDrivers.push(i),x>-1&&("removed"==e||"updated"==e&&"quote"!=o.mode)&&M.bidOnDrivers.splice(x,1),0==M.bidOnDrivers.length&&(a?M.dispatcherQMode="offer":M.quoteQMode="offer"),c&&M.detail){var T=angular.copy(t),i=M.detail.sent_to,q=g.getUniqueDrivers();if(q.hasOwnProperty(M.detail.sent_to)&&q[M.detail.sent_to].hasOwnProperty(M.detail.zone_id)){var o=g.getUniqueDrivers()[M.detail.sent_to][M.detail.zone_id];g.deleteTag(T,"all",o,i),o&&o.tags.forEach(function(e){T.hasOwnProperty(e)&&(g.deleteTag(T,e,o,i),l&&l.indexOf(e)>-1&&0==Object.keys(t[e]).length&&(l.splice(l.indexOf(e),1),u.splice(l.indexOf(e),1)))})}}return{tags:t,removedServices:h,services:l,servicesObjArr:u,skipTags:T,removedRange:y,tagsNonMode:b,haveCenterDrivers:I}}},setTagMap:function(e,t,o,i,r,n,a,s,l,u,c,d,f){var p,m,g,h,v=[];if(void 0!=Ce&&void 0!=Ce.all&&t[Object.keys(t)[0]]&&void 0!=t[Object.keys(t)[0]].tags){var y=this,w=Object.keys(t)[0],b=t[Object.keys(t)[0]],O=this.someFunc(e,Ce,b,w,o,u,l,n,r,i,c,d,null,f);Ce=O.tags,p=O.skipTags,v=O.removedServices,m=O.removedRange,g=O.tagsNonMode,h=O.haveCenterDrivers;var k=p?p:Ce;s&&k.all[w]&&(s=y.setNearestFurthestDrivers(e,w,b.lat||b.driver_lat,b.lon||b.driver_lon,o));var P=Object.keys(k[u]||k[n]||k.all).length;if(P>0&&0==Object.keys(s).length&&(s=y.setNearestFurthestDrivers()),g)var S=Object.keys(g.all).length;P>0&&m&&M.$broadcast("range:out"),(0==P&&l||b.tags.indexOf("Driver")<0)&&(M.allow_advance_reservation>0||b.settings&&b.settings.allow_advance_reservation>0)&&(b.settings&&b.settings.services&&("removed"!=e?y.addTag(ze,"all",b,w):y.deleteTag(ze,"all",b,w),_.intersection(b.settings.services,rt[b.group_id]).forEach(function(t){if("removed"!=e?y.addTag(ze,t,b,w):y.deleteTag(ze,t,b,w),r.indexOf(t)<0){var o=!1;v.indexOf(t)>-1&&(v.splice(v.indexOf(t),1),o=!0),r.push(t),i.push({id:t,text:t,"class":"taxicar",checked:u&&u==t||o||!1,icon:"pics/taxi.png"})}(!u||u&&n!=t)&&0==Object.keys(Ce[t]).length&&0==Object.keys(ze[t]).length&&(new RegExp(t).test(n)&&v.indexOf(t)<0&&v.push(t),r.indexOf(t)>-1&&(i.splice(r.indexOf(t),1),r.splice(r.indexOf(t),1)))})),0==v.length&&1==r.length&&(i[0].checked=!0)),M.totalNonModeDrivers=S,a(P,O.servicesObjArr,v,s,m,S,b.settings,h)}},findplaces:function(e,t,o,i){var r=this,n=new google.maps.places.AutocompleteService,a=new google.maps.places.PlacesService(i[0]),s=function(e,t){for(var i=[],n=0;n<e.length;n++)!function(e,n){a.getDetails({placeId:e},function(e,a){e&&(e.formatted_address=n,i.push(e),i.sort(function(e,t){return distA=r.getGPSDistance(e.geometry.location.lat(),e.geometry.location.lng(),M.lat,M.lon),distB=r.getGPSDistance(t.geometry.location.lat(),t.geometry.location.lng(),M.lat,M.lon),distA-distB}),o.$apply(function(){o[t+"locations"]=i}))})}(e[n].place_id,e[n].description)};o[t+"LocationSelected"]=!1,searchEventTimeout=D(function(){o[t+"typed"]=!0;var i={};i.input=e,i.location=new google.maps.LatLng(M.lat,M.lon),i.radius=1e3*l.milesRadius*1.609,n&&n.getPlacePredictions(i,function(e,o){o==google.maps.places.PlacesServiceStatus.OK&&s(e,t)})},350)},getLocation:function(e,t){var o=(new google.maps.Geocoder,T.defer()),i={lat:parseFloat(e),lng:parseFloat(t)};return n.geocoder().geocode({location:i},function(e,t){t===google.maps.GeocoderStatus.OK&&e[1]&&o.resolve(e[1].formatted_address)}),o.promise},getTagsDriverMap:function(){return Ce},getTagsDispatcherMap:function(){return ze},setGlobalGroups:function(e){var t=this;Q||(Q=!0,x.get(q+"autologin/?apikeypublic=183dcce812d78798659eb538aa719a9c28c36c05df80c9b0aef24938049799a8&"+s.getParams(!0)).success(function(e){e.user.zone_id.forEach(function(e,t){ct.indexOf(e)<0&&ct.push(e)}),ct.forEach(function(e){t.initFirebase(e)}),M.$broadcast("groups_set")}).error(function(){Q=!1})),jt||(jt=!0,this.getGlobalDrivers())},getGlobalDrivers:function(){var e=this;e.itemsApi(null,!0).then(function(e){var t=!1;e.items&&e.items.some(function(e){return t="My A2Bers"!=e.name&&e.apikeypublic==window.localStorage.getItem("apikeypublic")}),M.globalDriver=t},function(){jt=!1})},setMyA2BerDrivers:function(){if(M.loggedIn){var e=this;e.itemsApi("&category_id[]="+Et).then(function(e){Nt.length=0,e.items&&e.items.forEach(function(e,t){0!=t&&Nt.push(e.apikeypublic)})},function(){})}},getMyA2BerDrivers:function(){return Nt},getCareers:function(e,o){var i=T.defer(),r=T.defer(),n=q+"hr/?action="+e+"&"+s.getParams(),a=function(e,o,n){e&&(o+="&id="+e.id+"&firstName="+e.firstName+"&lastName="+e.lastName+"&cellPhone="+e.cellPhone+"&email="+e.email+"&tags[]="+e.itemType+"&skills[]="+e.skills);x.get(o).success(function(t){"failed"==t.status&&2>n?a(e,o,n+1):r.resolve(t)}).error(function(e){r.reject(e)})["finally"](function(){t.remove(o)});t.add({url:o,abortpromise:i,deferred:r})};return a(o,n,0),r.promise},getGlobalGroups:function(){return ct},getDispatcherGroups:function(){var e=[];for(var t in ze)for(var o in ze[t])e=_.union(e,ze[t][o]);return e},getTagsDriverDefault:function(){return Ae},resetTagMap:function(){Ce=angular.copy(Ae)},resetDispatcherTagMap:function(){ze=angular.copy(Ae)},setQ:function(e,t){var o=this;if("updated"==t){var i=e.ref().parent().parent().parent().key(),r=e.ref().parent().key(),n=e.val();gt.hasOwnProperty(i)||(gt[i]=[]),""==n&&gt[i].indexOf(r)<0?gt[i].push(r):""!=n&&gt[i].indexOf(r)>-1&&gt[i].splice(gt[i].indexOf(r),1),bt[i]&&Ot[bt[i].groupPosition].booked&&(i!=bt[i].category_id?o.setStoredZones({id:i},"inside",bt[i].category_id):bt[i].zone_id==i?Ot[bt[i].groupPosition].QP=gt[i].indexOf(window.localStorage.getItem("apikeypublic"))+1+"/"+gt[i].length:pt.hasOwnProperty(i)&&pt[i].hasOwnProperty(r)&&bt[i].category_id==i&&(Ot[bt[i].groupPosition].QP=gt[i].indexOf(window.localStorage.getItem("apikeypublic"))+1+"/"+gt[i].length),
M.bookingIn&&(M.bookingIn=!1,M.$broadcast("loading:hide")))}else{var i=e.ref().parent().parent().key(),r=e.key();e.val();if(gt[i].splice(gt[i].indexOf(r),1),window.localStorage.getItem("apikeypublic")==r){var a=dt.indexOf(i);a>-1&&(dt.splice(a,1),Object.keys(bt).length>0&&bt.hasOwnProperty(i)&&bt[i].booked&&i==bt[i].category_id?(Ot[bt[i].groupPosition].booked=!1,Ot[bt[i].groupPosition].showQP=!1,bt[i].booked=!1,o.setAllBookedStatus()):o.setGroups())}}},messageListener:function(e){var t=i.get("EmployeeService");if(e.exists()){var r=e.ref().parent().parent().key(),n=e.val(),a=e.key(),s=n.to,l=!0;n.hasOwnProperty("toShow")&&(l=n.toShow),d(["MESSAGE","NEW_SUBSCRIPTION","REPLY"]).then(function(e){for(var i in s){if(""==s[i]&&p.email&&i==p.email.toString().split("@")[0]&&n.message==e.NEW_SUBSCRIPTION){t.authenticateFirebase(),Pe||t.ringTone(),u.info(n.from_name+": "+n.message,e.MESSAGE),D(function(){Pe&&t.ringTone()},3e3);var c={};c[i]=Firebase.ServerValue.TIMESTAMP,z.child(r+"/messages/"+a+"/to").update(c)}if(i==window.localStorage.getItem("apikeypublic")&&""==s[i]){n.message==e.NEW_SUBSCRIPTION?(t.authenticateFirebase(),t.getGlobalDrivers()):(n.hasOwnProperty("type")&&"deactivated"==n.type||"removed"==n.type)&&bt[r]&&(Ot[bt[r].groupPosition].active=0,"removed"==n.type&&t.findAllEmployees().then(function(e){}),t.setGroups(),t.toggleBook(!1,Ot[bt[r].groupPosition]),u.info(n.from_name+": "+n.message,e.MESSAGE),D(function(){Pe&&t.ringTone()},3e3)),l&&(Pe||t.ringTone(),M.detail&&M.chatModal&&M.chatModal.apikey==n.from||"app.messages-detail"==E.current.name&&("app.messages-detail"!=E.current.name||o.currentView().stateParams.apikey==n.from)||u.info(n.from_name+": "+n.message,e.MESSAGE,{allowHtml:!0,onTap:function(){E.transitionTo("app.messages-detail",{apikey:n.from,name:n.from_name})}}),D(function(){Pe&&t.ringTone()},3e3));var c={};c[i]=Firebase.ServerValue.TIMESTAMP,z.child(r+"/messages/"+a+"/to").update(c)}}})}},queueListenerFunc:function(e,t,o){if(!M.listenedQueue&&!M.startupLoading&&M.loggedIn){var i=this;e.forEach(function(e,r,n){z.child(e+"/queue").orderByChild("timestamp").once("value",function(e){i.queueListener(e,o),t||r!=n.length-1||(M.listenedQueue=!0,i.autoBookFunc())})})}},initFirebase:function(e,t){var o=this;D(function(){o.queueListenerFunc(lt)},5e3),!Be&&lt.indexOf(e)<0&&(lt.push(e),z.child(e+"/messages").on("child_added",o.messageListener),z.child(e+"/zones/latlon").on("value",function(e){var t=e.ref().parent().parent().key();if(Ge.indexOf(t)<0&&(Ge.push(t),z.child(t+"/inbox").on("child_added",o.inboxAdded),z.child(t+"/inbox").on("child_removed",o.inboxRemoved)),e.exists()){if(it.hasOwnProperty(t)||(it[t]={}),it[t].length>e.val().length){var i=it[t],r=e.val();i.filter(function(e){return 0==r.filter(function(t){return t.id==e.id}).length})}it[t]=e.val();var n;nt[t]&&(n=nt[t].id,it[t].some(function(e,i){return n==e.id?(nt[t]=e,!0):void(it[t].length-1==i&&o.setStoredZones(e,"outside",t))})),o.autoBookFunc()}else t&&it.hasOwnProperty(t)&&(it[t].forEach(function(e){o.setStoredZones(e,"outside",t)}),it[t].length=0);M.$broadcast("zonemap:updated")}),z.child(e+"/rates").on("value",function(e){var t=e.ref().parent().key();if(e.exists()){rt.hasOwnProperty(t)||(rt[t]=[]),rt[t].length=0;var o=$.map(e.val(),function(e){return e});o.forEach(function(e){rt[t].indexOf(e.settings[9])<0&&"1"==e.active&&rt[t].push(e.settings[9])})}}),z.child(e+"/queue").orderByChild("timestamp").on("value",function(t){ae&&(ae=!1,M.loggedIn&&o.getVehiclesPermits(null,!0),M.$broadcast("firebaseInitialized")),o.queueListener(t,null,e),M.startupLoading&&0==ut.length&&(M.startupLoading=!1,M.$broadcast("fb:initialized"),n.mapsInitialized().then(function(){M.setMap()}),M.setMap(),M.$broadcast("loading:hide",!0),M.loggedIn&&o.queueListenerFunc(lt))}),o.addZoneListeners(e,"child_removed"))},tripPath:function(e){var t=T.defer();return x.get(q+"tripPaths/?id="+e+s.getAutoLoginParams()).success(function(e){t.resolve(e)}).error(function(e){t.reject(e)}),t.promise},getBounds:function(e){for(var t=new google.maps.LatLngBounds,o=0;o<e.length;o++){var i=e[o];t.extend(i)}return t},getBoundsFromZoom:function(e,t,o){var i=e.getProjection();if(i){var r=$(e.getDiv()),n=2*Math.pow(2,t),a=r.width()/n,s=r.height()/n,l=i.fromLatLngToPoint(o||e.getCenter());return new google.maps.LatLngBounds(i.fromPointToLatLng(new google.maps.Point(l.x-a,l.y+s)),i.fromPointToLatLng(new google.maps.Point(l.x+a,l.y-s)))}},marginZoom:function(e,t){var o=$(e.getDiv()).height(),i=$(e.getDiv()).width(),r=!1,n=new google.maps.OverlayView;n.draw=function(){},n.setMap(e),r=t.some(function(e){if(!n.getProjection())return!1;var t=n.getProjection().fromLatLngToDivPixel(e);return t.x<10||t.x>i-10||t.y<10||t.y>o-10}),r&&e.setZoom(e.getZoom()-1)},getBoundsZoomLevel:function(e,t,o){function i(e){var t=Math.sin(e*Math.PI/180),o=Math.log((1+t)/(1-t))/2;return Math.max(Math.min(o,Math.PI),-Math.PI)/2}function r(e,t,o){return Math.floor(Math.log(e/t/o)/Math.LN2)}var n=o||this.getBounds(e),a={height:"function"==typeof t.height?t.height():t.height,width:"function"==typeof t.width?t.width():t.width},s={height:256,width:256},l=21,u=n.getNorthEast(),c=n.getSouthWest(),d=(i(u.lat())-i(c.lat()))/Math.PI,f=u.lng()-c.lng(),p=(0>f?f+360:f)/360,m=r(a.height,s.height,d),g=r(a.width,s.width,p);return Math.min(m,g,l)}};return Rt.setGlobalQMode(),Rt.setServerOffset(),Rt.listenFBConnected(),M.allow_reservation=!0,s.getSettings().then(function(e){Tt=e.app_id,M.app_name=e.app_name,M.allow_reoffer="yes"==e.allow_reoffer?!0:!1,M.app_suspended="yes"==e.app_suspended?!0:!1,M.default_customer_mode=e.default_customer_mode,M.default_dispatcher_mode=e.default_dispatcher_mode,M.default_driver_mode=e.default_driver_mode,Rt.setGlobalQMode(),M.milesRadius=e.limit_area_coverage,Rt.setMilesRanges(),M.zone_maximum_driver_limit=e.zone_maximum_driver_limit,M.allow_advance_reservation=e.allow_advance_reservation,M.allow_remote_reservation=e.allow_remote_reservation,M.allow_queue="yes"==e.allow_queue?!0:!1,M.allow_reservation="yes"==e.allow_reservation?!0:!1,M.allow_add_group="yes"==e.allow_add_group?!0:!1,M.show_vehicle="yes"==e.show_vehicle?!0:!1,M.show_permit="yes"==e.show_permit?!0:!1,M.show_rating="yes"==e.show_rating?!0:!1,M.show_QP="yes"==e.show_QP?!0:!1,M.allow_trip_cancel="yes"==e.allow_trip_cancel?!0:!1,M.allow_edit_trip_detail="yes"==e.allow_edit_trip_detail?!0:!1,M.allow_multiple_passengers="yes"==e.allow_multiple_passengers?!0:!1,M.allow_fare_split="yes"==e.allow_fare_split?!0:!1,M.allow_coupon="yes"==e.allow_coupon?!0:!1,M.offerTime=e.offer,M.jailTime=e.jail,M.biddable="yes"==e.biddable?!0:!1,M.rquire_uppload="yes"==e.rquire_uppload?!0:!1}),Rt}]).factory("FireBase",["$firebase",function(e){return function(){var t=new Firebase("https://yd.firebaseio.com/");return e(t).$asObject()}}]).factory("AuthService",["$injector","$localStorage","$interval","$http","$q","$rootScope","EmployeeService",function(e,t,o,i,r,n,a){return{isAuthenticated:function(){return null==window.localStorage.getItem("apikeypublic")?!1:!0},isDispatcherAdmin:function(e,t,i,n){var s,l=r.defer(),u=function(){void 0!=s&&(o.cancel(s),s=void 0);var r,u;a.getEmployees().forEach(function(o,i){o.category_id!=e.employeeId||o.apikeypublic!=window.localStorage.getItem("apikeypublic")||r&&void 0!=r||(r=o.hasOwnProperty("can_bookin")?o.hasOwnProperty("can_bookin"):o.tags.indexOf("Admin")>-1||!t&&o.tags.indexOf("Dispatcher")>-1,r&&(r=!n||n&&(o.isOwner||a.getGroupItems()[o.category_id].booked)),u=o.isOwner)}),i?l.resolve(u):l.resolve(r)};return null==a.getEmployees()?s=o(function(){null!=a.getEmployees()&&u()},2e3):u(),l.promise},isInTrip:function(){return n.detail||n.tripModal}}}]).factory("AnimateMarkerService",["MapServ","$q","$rootScope","EmployeeService","constants",function(e,t,o,r,n){var a=!1,s=100,l=10;return{setStopMovingMarker:function(e){a=e},moveMarker:function(e,t,o,r,n){e[0]+=t,e[1]+=o;var u=new google.maps.LatLng(e[0],e[1]);r.setPosition(u),i==s||a?i==s&&void 0!=n&&n.panTo(u):(i++,setTimeout(function(e,t,o,i){return me.moveMarker()}(e,t,o,r),l))},transition:function(e,t,o,i,r,n){return},fitBounds:function(t,o,i,r){if(ionic.Platform.isWebView())return void e.fitBounds(r);var n=new google.maps.LatLngBounds;if(t)for(var a=0;a<t.length;a++){var s=t[a];n.extend(s)}if(void 0!=i&&n.extend(i),n.getNorthEast().equals(n.getSouthWest())){var l=new google.maps.LatLng(n.getNorthEast().lat()+.01,n.getNorthEast().lng()+.01),u=new google.maps.LatLng(n.getNorthEast().lat()-.01,n.getNorthEast().lng()-.01);n.extend(l),n.extend(u)}var c=0,d=70,f=o.getProjection().fromLatLngToPoint(n.getSouthWest());o.fitBounds(n);var p=new google.maps.Point(("number"==typeof c?c:0)/Math.pow(2,o.getZoom())||0,("number"==typeof d?d:0)/Math.pow(2,o.getZoom())||0),m=o.getProjection().fromPointToLatLng(new google.maps.Point(f.x-p.x,f.y+p.y));n.extend(m),o.fitBounds(n)}}}]).factory("ApiParamService",["$http","$q","UUIDService","$rootScope","$injector","$localStorage",function(e,t,o,i,r,n){var a,s;return{getSettings:function(){var o=t.defer();return s?s:(e.get("./custom_settings.json").then(function(e){var t=e.data;a=t.app_id,o.resolve(t)},function(t){e.get("./settings.json").then(function(e){var t=e.data;a=t.app_id,o.resolve(t)})}),s=o.promise)},checkTokenExpiry:function(){n.token&&moment().diff(moment(n.token.time),"days")>=1&&r.get("EmployeeService").authenticateToken()},getAutoLoginParams:function(){var e="";if(null!=window.localStorage.getItem("apikeypublic")){var t=r.get("EmployeeService");e+=t.isDriver()?"apikeypublic="+window.localStorage.getItem("apikeypublic"):"apikeypublic="+a}else e+="apikeypublic="+a;return e+="&app_id="+a,null!=i.lat&&(e+="&lat="+i.lat+"&lon="+i.lon),e+="&uuid="+o.getRandomUUID()},getParams:function(e,t,r){var n=(this.checkTokenExpiry(),"");return r||(!e&&null!=window.localStorage.getItem("apikeypublic")||t?null!=window.localStorage.getItem("apikeypublic")&&(n+="&apikeypublic="+window.localStorage.getItem("apikeypublic")):n+="&apikeypublic="+a),n+="&app_id="+a,null!=i.lat&&(n+="&lat="+i.lat+"&lon="+i.lon),n+="&uuid="+o.getRandomUUID()}}}]).factory("UUIDService",["$localStorage",function(e){return{getRandomId:function(e){var t=Math.abs(Math.random().toString().split("").reduce(function(e,t){return(e<<5)-e+t})).toString(36).substr(0,e||11);return e||(t+=(new Date).getTime()),t},getRandomUUID:function(){return void 0==ionic.Platform.device().uuid?(null==e.uuid&&(e.uuid=this.getRandomId()),e.uuid):e.uuid=ionic.Platform.device().uuid},matchesMyUUID:function(e){return e==this.getRandomUUID()}}}]).factory("CityState",["$http","$rootScope","$q",function(e,t,o){var i=[],r=[];return{findStates:function(t){var i=o.defer(),n=function(e){var t=[];return r.forEach(function(o){o.name.toLowerCase().indexOf(e.toLowerCase())>-1&&t.push({id:o.name,text:o.name,checkecd:!1})}),t};return 0==r.length?e.get("https://api.theprintful.com/countries").success(function(e){r=e.result.filter(function(e){return"US"==e.code})[0].states,n(t),i.resolve(n(t))}).error(function(e){i.reject(e)}):i.resolve(n(t)),i.promise},clearStates:function(){r.length=0},setStates:function(){var i=o.defer();return e.get("https://api.geonames.org/searchJSON?country="+t.countryCode+"&featureCode=ADM1&username=hyperonic").success(function(e){e.geonames.forEach(function(e){r.push({id:e.name,text:e.name,checkecd:!1})}),i.resolve(e)}).error(function(e){i.reject(e)}),i.promise},setCities:function(){var e=o.defer();return e.resolve(),e.promise},getStates:function(){return r},getCities:function(){return i}}}]).factory("GpsDetectService",["$injector","$timeout","$q","$ionicLoading","$interval","$ionicPlatform","$translate","$rootScope",function(e,t,o,i,r,n,a,s){var l,u=!1;return{isNotConnected:function(){var e=o.defer();return n.ready(function(){gpsDetect.checkGPS(u,function(t){e.resolve(t),t?(s.$broadcast("gps:connected"),u=!1,s.isGpsOff=!1,s.isOffline?a("OFFLINE").then(function(e){i.show({template:e})}):i.hide()):(u=!0,s.isGpsOff=!0,a("GPS_OFF").then(function(e){i.show({template:e})}))},function(t){e.reject(t)})}),e.promise},startGpsInterval:function(){l=r(function(){gpsDetect.checkGPS(u,function(o){o?(u=!1,e.get("EmployeeService").setLatLon().then(function(){s.$broadcast("gps:connected")})):(u=!0,t(function(){s.isGpsOff=!0}),a("GPS_OFF").then(function(e){i.show({template:e})}))},function(e){})},5e3)},cancelGpsInterval:function(){r.cancel(l)}}}]).service("LanguagesService",["$http",function(e){this.get=function(){return e.get("/locales/languages.json")}}]).service("Internet",["baseUrl","$http","$injector","$q","ApiParamService",function(e,t,o,i,r){var n;this.IsConn=function(){if(n&&0==n.$$state.status)return n;var o=i.defer(),a="https://freegeoip.net/json/",a=e+"autologin/?"+r.getAutoLoginParams();return t.get(a).then(function(e){var t=e.status;o.resolve(t>=200&&300>t||304===t)},function(e){o.reject(e)}),n=o.promise}}]).service("PendingRequestsService",["$log","$http","$timeout",function(e,t,o){var i=this,r=[],n={},a=[];i.add=function(e){r.push(e),i.setTimer(e)},i.setTimer=function(e){e.timer&&(n[e.url]=o(function(e){i.replay(e)},1e3*e.timer,!1,e.url))},i.clearTimeouts=function(e){for(var t in n)e==t&&o.cancel(n.t)},i.remove=function(e){for(var t=r.length-1;t>=0;t--)r[t].url==e&&(a.indexOf(e)>-1&&a.splice(a.indexOf(e),1),n[e]&&o.cancel(n[e]),r.splice(t,1))},i.replay=function(e){angular.forEach(r,function(t){t.url==e&&(a.indexOf(e)<0&&a.push(e),t.abortpromise.resolve())})},i.cancelAll=function(){angular.forEach(r,function(e){e.abortpromise.resolve(),e.deferred.reject(),i.clearTimeouts(e)}),r.length=0,a.length=0}}]).factory("MapServ",["$ionicSideMenuDelegate","$rootScope","Initializer","$timeout",function(e,t,o,i){var r,n,a,s=!1,l=t.$on("location:updated",function(){l(),c()}),u=function(e,t){return ionic.Platform.isWebView()?new plugin.google.maps.LatLng(e,t):new google.maps.LatLng(e,t)},c=function(){return window.google&&google.maps?r={center:u(t.lat,t.lon),zoom:14,zoomControlOptions:{position:google.maps.ControlPosition.LEFT_CENTER},mapTypeControl:!1,panControl:!1,mapTypeId:google.maps.MapTypeId.ROADMAP,maxZoom:17,minZoom:6,backgroundColor:"transparent",controls:{compass:!0,myLocationButton:!0,indoorPicker:!0,zoom:!0,pan:!0},gestures:{scroll:!0,tilt:!0,rotate:!0,zoom:!0},camera:{latLng:u(t.lat,t.lon),zoom:14}}:void 0},d=function(e){var o={};return angular.forEach(["popover.shown","modal.shown","modal.hidden","popover.hidden"],function(i){o[i]=e.$on(i,function(e,o){a!=o.scope.$id&&(a=o.scope.$id,setTimeout(function(){a=null},100),t.$broadcast("setmapclick",e.name.indexOf("hidden")>-1))})}),o};"undefined"==typeof Number.prototype.toRad&&(Number.prototype.toRad=function(){return this*Math.PI/180}),"undefined"==typeof Number.prototype.toDeg&&(Number.prototype.toDeg=function(){return 180*this/Math.PI});var f=function(e,t,o,i){this._radius=6371,i="number"==typeof i?i:"string"==typeof i&&""!=i.trim()?+i:NaN,i/=this._radius,o=o.toRad();var r=e.toRad(),n=t.toRad(),a=Math.asin(Math.sin(r)*Math.cos(i)+Math.cos(r)*Math.sin(i)*Math.cos(o)),s=n+Math.atan2(Math.sin(o)*Math.sin(i)*Math.cos(r),Math.cos(i)-Math.sin(r)*Math.sin(a));return s=(s+3*Math.PI)%(2*Math.PI)-Math.PI,{lat:a.toDeg(),lng:s.toDeg()}};return{setVisible:function(e){ionic.Platform.isWebView()&&t.map&&t.map.setVisible(e)},colorwithShade:function(e){e.fillColor&&(e.fillColor=this.shadeColor(e.fillColor,e.fillOpacity&&1-e.fillOpacity||0)),e.strokeColor&&(e.strokeColor=this.shadeColor(e.strokeColor,e.strokeOpacity&&1-e.strokeOpacity||0))},shadeColor:function(e,t){var o=parseInt(e.slice(1),16),i=0>t?0:255,r=0>t?-1*t:t,n=o>>16,a=o>>8&255,s=255&o;return"#"+(16777216+65536*(Math.round((i-n)*r)+n)+256*(Math.round((i-a)*r)+a)+(Math.round((i-s)*r)+s)).toString(16).slice(1)},getLatLon:function(e,t){return u(e,t)},mapClickableSetter:function(e){return d(e)},createMap:function(e,o,i){var r=this;if(window.google&&google.maps){var a=o||c();setTimeout(function(){if(!a||s)return void(t.map&&(ionic.Platform.isWebView()&&(t.map.setDiv(e),r.setMapOptions(o),t.map.clear(),t.map.setClickable(!0),t.map.setVisible(!0),t.menuFunc()),i&&i()));if(s=!0,ionic.Platform.isWebView()){var l=function(e){t.map=e,t.$broadcast("mapcreated"),i&&i(),t.menuFunc(),r.setMapListeners(),t.$on("setmapclick",function(e,o){t.map.setClickable(o&&0==$("body").find('> *[class*="modal"]').filter(function(e){return"none"!=$(this).css("display")}).length)})};n=plugin.google.maps.Map.getMap(e,a),n.on(plugin.google.maps.event.MAP_READY,l)}else i&&i()},200)}},refresh:function(){t.map&&ionic.Platform.isWebView()&&i(function(){t.map.refreshLayout()},500)},resetMap:function(e){var o=e||c();ionic.Platform.isWebView()&&t.map.clear(),this.setMapOptions(o)},setMapListeners:function(){if(ionic.Platform.isWebView()){var o=plugin.google.maps.event.MAP_CLICK,i=plugin.google.maps.event.CAMERA_CHANGE,r=plugin.google.maps.event.MY_LOCATION_BUTTON_CLICK;t.map.on(o,function(o){t.$broadcast("mapclick"),e.isOpenLeft()&&e.toggleLeft()}),t.map.on(r,function(e){t.$broadcast("mylocationclick")}),t.map.on(i,function(e){t.$broadcast("mapcamera")})}else google.maps.event.addListener(t.map,"idle",function(){t.$broadcast("mapidle")}),google.maps.event.addListener(t.map,"dragend",function(){t.$broadcast("mapdrag")}),google.maps.event.addListener(t.map,"click",function(){t.$broadcast("mapclick")}),google.maps.event.addListener(t.map,"bounds_changed",function(){t.$broadcast("mapbounds")}),google.maps.event.addListener(t.map,"center_changed",function(){t.$broadcast("mapcenter")})},setMapOptions:function(e){t.map&&t.map.setOptions(e)},setZoom:function(e){t.map.setZoom(e)},getZoom:function(e){ionic.Platform.isWebView()?t.map.getCameraPosition(function(t){e(t.zoom)}):e(t.map.getZoom())},centerMap:function(e,o,i){if(t.map){var r=e&&u(e,o)||c().center,i=i||c().zoom;ionic.Platform.isWebView()&&t.map.moveCamera({target:r,zoom:i},function(){})}},getMapCenter:function(e){ionic.Platform.isWebView()?t.map.getCameraPosition(function(t){e({lat:function(){return t.target.lat},lng:function(){return t.target.lng}})}):e(t.map.getCenter())},getMarginBounds:function(e){var t=new plugin.google.maps.LatLngBounds(e),o=t.northeast,i=t.southwest,r=google.maps.geometry.spherical.computeDistanceBetween(new google.maps.LatLng(o.lat,o.lng),new google.maps.LatLng(i.lat,i.lng)),n=f(o.lat,o.lng,45,.001*r*.3),a=f(i.lat,i.lng,225,.001*r*.3),s=e.concat([u(n.lat,n.lng),u(a.lat,a.lng)]),l=new plugin.google.maps.LatLngBounds(s);return l},fitBounds:function(e){var o=this.getMarginBounds(e);t.map.animateCamera({target:o})},addMarker:function(e,o){var i=u(e.lat,e.lon);if(ionic.Platform.isWebView())t.map.addMarker({position:i,visible:e.hasOwnProperty("visible")?!1:!0,icon:e.icon},function(e){o&&o(e)});else{var r=new google.maps.Marker({position:i,map:t.map,draggable:e.hasOwnProperty("draggable")?!1:!0,visible:e.hasOwnProperty("visible")?!1:!0,icon:e.icon});o&&o(r)}},getMarker:function(e,t,o){ionic.Platform.isWebView()?t.position&&e.getPosition(function(e){o(e)}):t.position&&o(e.getPosition())},updateMarker:function(e,t,o){var i=u(t.lat,t.lon||t.lng);ionic.Platform.isWebView()?e.setPosition(i):e.setPosition(i)},addPolygon:function(e,o){if(ionic.Platform.isWebView()){var i=e,r=[];e.path.forEach(function(e){r.push(u(e.lat,e.lng))}),i.points=r,t.map.addPolygon(i,function(e){o&&o(e)})}else e.map=t.map,o(new google.maps.Polygon(e))},getPolygon:function(e,t){ionic.Platform.isWebView()&&(e.points&&polygon.getPoints(),e.strokeColor&&polygon.getStrokeColor(),e.fillColor&&polygon.getFillColor())},updatePolygon:function(e,t){if(ionic.Platform.isWebView()){if(t.path){var o=[];t.path.forEach(function(e){o.push(u(e.lat,e.lng))}),e.setPoints(o)}this.colorwithShade(t),t.strokeColor&&e.setStrokeColor(t.strokeColor),t.fillColor&&e.setFillColor(t.fillColor)}else e.setOptions(t)},addCircle:function(e,o){if(ionic.Platform.isWebView()){var i=u(e.center.lat,e.center.lng);e.center=i,t.map.addCircle(e,function(e){o&&o(e)})}else e.map=t.map,o(new google.maps.Circle(e))},getCircle:function(e,t){ionic.Platform.isWebView()&&(e.center&&circle.getCenter(),e.radius&&circle.getRadius(),e.strokeColor&&circle.getStrokeColor(),e.fillColor&&circle.getFillColor())},updateCircle:function(e,t){if(ionic.Platform.isWebView()){if(t.center){var o=u(t.center.lat,t.center.lng);t.center=o,e.setCenter(t.center)}this.colorwithShade(t),t.radius&&e.setRadius(t.radius),t.strokeColor&&e.setStrokeColor(t.strokeColor),t.fillColor&&e.setFillColor(t.fillColor)}else e.setOptions(t)},removeShape:function(e,t){ionic.Platform.isWebView()?e.remove():e.setMap(null)},addDirections:function(e,o){if(ionic.Platform.isWebView()&&t.map){var i=function(e){o(e)},r=[];e.routes[0].legs[0].steps.forEach(function(e,t){0==t&&r.push(u(e.start_point.lat(),e.start_point.lng())),r.push(u(e.end_point.lat(),e.end_point.lng()))}),t.map.addPolyline({points:r,color:"#0088FF",width:6},i)}},removeDirections:function(e){ionic.Platform.isWebView()&&e.remove()}}}]).factory("Initializer",["$ocLazyLoad","$window","$q","$timeout","$interval","$rootScope",function(e,t,o,i,r,n){var a,s,l,u,c=!1,d=!1,f=$.now(),p=function(e){var t=document.createElement("script");t.type="text/javascript",t.src=e;var o=document.getElementsByTagName("head")[0];o.appendChild(t)},m=function(t,d,m){function g(){if(!c){c=!0;var e="https://maps.google.com/maps/api/js?libraries=visualization,drawing,places,geometry";ionic.Platform.isWebView()||(e+="&key=AIzaSyAU9BJBGoRLtgn-LWeof7SVpxIY72zr-sI"),$.ajax({dataType:"script",data:y,url:e,error:function(){setTimeout(function(){n.isOffline?(c=!1,_.reject(),u=null):(c=!1,g())},2e3)}})}}if(window.google&&google.maps){var _=o.defer();return i(function(){_.resolve()}),_.promise}if(u)return u;var _=o.defer(),h=function(){window.google&&google.maps&&(a=new google.maps.Geocoder,s=new google.maps.DirectionsService,l=new google.maps.DirectionsRenderer({suppressMarkers:!0,preserveViewport:!0})),_.resolve(window.google&&google.maps?google.maps:!1),u=null,p("lib/sliding-marker/markerAnimate.js"),p("lib/sliding-marker/SlidingMarker.min.js"),e.load("lib/ng-map.min.js");var t=r(function(){"undefined"!=typeof SlidingMarker&&(r.cancel(t),SlidingMarker.initializeGlobally())},100);n.setMap&&n.setMap()},v="loadGoogleMaps_"+f++,y=$.extend({sensor:!0},{libraries:"visualization,drawing,places,geometry"},d?{key:d}:{},m?{language:m}:{});return window.google&&google.maps?h():window.google&&google.load?google.load("maps",t||3,{other_params:$.param(y),callback:h}):(y=$.extend(y,{v:t||3,callback:v}),window[v]=function(){h(),setTimeout(function(){try{delete window[v]}catch(e){}},20)},g()),u=_.promise};return{mapsInitialized:function(){if(this.getStripe(),this.getSupport(),this.addAudio(),navigator.onLine)return m();var e=o.defer();return e.reject(!1),e.promise},geocoder:function(){return a},directionsService:function(){return s},directionsDisplay:function(){return l},getStripe:function(){if("undefined"==typeof Stripe&&!d){d=!0;var e=function(){$.getScript("https://js.stripe.com/v2/").done(function(e,t){Stripe.setPublishableKey("pk_test_iW16uSc6O9edLEupfz6HeY6x")}).fail(function(e,t,o){}).always(function(){d=!1})};e()}},getSupport:function(){ionic.Platform.isWebView()||0!=$('script[src*="support"][async]').length||(LHCChatOptions.opt={widget_height:340,widget_width:300,popup_height:520,popup_width:500,domain:"m.a2bapp.com"},function(){var e=document.createElement("script");e.type="text/javascript",e.async=!0;var t=document.referrer?encodeURIComponent(document.referrer.substr(document.referrer.indexOf("://")+1)):"",o=document.location?encodeURIComponent(window.location.href.substring(window.location.protocol.length)):"";e.src="//support.a2bapp.com/index.php/chat/getstatus/(click)/internal/(position)/bottom_right/(ma)/br/(top)/350/(units)/pixels/(leaveamessage)/true?r="+t+"&l="+o;var i=document.getElementsByTagName("script")[0];e.addEventListener("load",function r(t){e.removeEventListener("load",r,!1)},!1),e.addEventListener("error",function n(t){$('script[src*="support"][async]').remove(),e.removeEventListener("load",n,!1)},!1),i.parentNode.insertBefore(e,i)}())},addAudio:function(){if(!ionic.Platform.isAndroid()&&0==$("audio").length){var e=$('<audio id="ringtone" no-controls><source src="sound/ring.mp3" type="audio/mp3"></audio>');document.body.appendChild(e[0])}}}}]).factory("Auth",["$auth","$localStorage","$http","$q","$ionicPopup","$translate","EmployeeService","$rootScope",function(e,t,o,i,r,n,a,s){var l,u,c,d,f,p=function(){var e=function(){a.login({method:c,email:f}).then(function(t){if("Failed"!=t.status)u.resolve(t);else{var o={};o.name=d,o.email=f,o.password="aaaaaa",o.confirmPassword=o.password,o.phone="111111",a.signUp(o).then(function(t){e()},function(e){u.reject(e)})}},function(e){})};e()},m=function(){o.get("https://graph.facebook.com/v2.5/me/?access_token="+l.access_token+"&fields=email,name,picture").success(function(e){l=e,d=l.name,f=l.email,t.picData="https://graph.facebook.com/"+l.id+"/picture?type=large",p()}).error(function(e){u.reject(e)})},g=function(){o.get("https://api.twitter.com/1.1/users/show.json?screen_name="+l.screen_name+"&auth=oauth").success(function(e){d=l.name,f=l.id,p()}).error(function(e){u.reject(e)})},_=function(){o.get("https://www.googleapis.com/plus/v1/people/me/openIdConnect",{headers:{Authorization:"Bearer "+l.access_token}}).success(function(e){l=e,d=l.name,f=l.email,l.picture&&(t.picData=l.picture.substr(0,l.picture.indexOf("?"))),p()}).error(function(e){u.reject(e)})},h=function(){o.get("https://api.linkedin.com/v1/people/~:(id,first-name,last-name,email-address)&format=json&oauth2_access_token="+l.access_token).success(function(e){l=e,d=profile.firstName+" "+profile.lastName,t.picData=profile.picture.replace("sz=50","sz=200"),p()}).error(function(e){u.reject(e)})},v=function(){o.jsonp("https://api.instagram.com/v1/users/self/?callback=JSON_CALLBACK&access_token="+l.access_token).success(function(e){l=e.data,l.profile_picture&&(t.picData=l.profile_picture.substr(0,l.profile_picture.indexOf("?"))),d=l.full_name,f=l.id+"@a2bapp.com",p()}).error(function(e){u.reject(e)})},y=function(){o.get("https://social.yahooapis.com/v1/user/"+l.xoauth_yahoo_guid+"/profile?format=json",{headers:{Authorization:"Bearer "+l.access_token}}).success(function(e){l=e,d=l.profile.nickname,f=l.profile.guid,p()}).error(function(e){u.reject(e)})},w=function(e){switch(s.$broadcast("loading:show",{text:"SIGNING_IN"}),l=e,c){case"facebook":m();break;case"twitter":g();break;case"google":_();break;case"linkedin":h();case"instagram":v();case"yahoo":y()}};return{authenticate:function(t){return u=i.defer(),c=t,e.authenticate(c).then(function(e){w(e)},function(e){})["catch"](function(e){u.reject(e),r.alert({title:"Error",content:e.data?e.data||e.data.message:e})}),u.promise}}}]);