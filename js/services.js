var _constants={testMode:!0,driverSpeedMPH:30,serverUTCOffset:5,significantMilesGuest:.1,significantMiles:.2,defaultPrice:0,defaultMilesRadius:1,milesRadius:25,offerTime:20,jailTime:60,quoteExpiry:4,driverQuoteExpiry:4,quotetoShowCustomerTime:20,offerWaitingMin:10,arriveBtnDisabledMiles:.2,offerNextDriverDelay:5e3,deleteTimeAfterDriverRate:1440,geoOptions:{timeout:25e3,enableHighAccuracy:!0,maximumAge:1e4},autoBookInterval:1e4};angular.module("directory.services",[]).constant("baseUrl","https://a2bapp.com/api/").constant("fireRef",new Firebase("https://yd.firebaseio.com/")).constant("constants",_constants).constant("networktimeout",60).constant("app_id","183dcce812d78798659eb538aa719a9c28c36c05df80c9b0aef24938049799a8").factory("EmployeeService",["PendingRequestsService","$ionicHistory","$injector","$cordovaSpinnerDialog","Initializer","$filter","ApiParamService","constants","toastr","$translate","$ionicScrollDelegate","$localStorage","$ionicPlatform","GpsDetectService","$ionicLoading","$cordovaMedia","$cordovaLocalNotification","$cordovaVibration","$ionicModal","$ionicPopover","$ionicPopup","$cordovaDialogs","$cordovaGeolocation","$interval","$timeout","$rootScope","$http","$q","baseUrl","$state","$timeout","FireBase","fireRef","networktimeout",function(e,t,o,i,r,n,a,s,u,l,d,f,p,m,g,h,v,y,w,b,O,k,S,I,P,D,x,T,M,q,P,E,C,z){var A;null==f.dispatcherInboxes&&(f.acceptedOrders=[]),D.tripsInProgress=[];var N,R,F=[],L=!1,G=!1,Y=!1,Q=!1;D.bidOnDrivers=[];var B={};D.bookingIn=[];var U,H,V,Z=0,W=null,K=null,J={},X={},ee=[],te=[],oe={},ie=!1,re=!1,ne=!0;D.listenedQueue=!1,D.startupLoading=!0,D.hasDriverQP=!1;var ae=!0,se=!1,ue=!1,le=[],de={},ce={},fe={};D.quotes=[],D.rates=[];var pe,me,ge,_e,he,ve=[],ye={},we={},be={},Oe=!1,ke=!1,Se=!0,Ie=1.5,Pe=!1,De=!1,xe=null,Te=!1,Me={},qe=!1;null==f.dispatcherInboxes&&(f.dispatcherInboxes=[]);var Ee={},Ce={},ze={};D.appoverdue=!1,D.bookingOut=[];var Ae,je,Ne,Re,Fe,$e,Le=[],Ge=!0,Ye={},Qe={},Be=null,Ue=null,He=!1;D.creditCards=[],D.pois=[];var Ve,Ze={};D.rateNotSelected=!0;var We,Ke,Je,Xe,et,tt,ot={},it={},rt={},nt=[],at=[],st=[],ut=[],lt=[],dt=[],ct={},ft={},pt={},mt={},gt={},_t=(new Date).getTimezoneOffset(),ht=[],vt=!1,yt=!1,wt={},bt=null,Ot=0,kt=[],St=!1,It=!1,Pt=(new Array,new Array,new Array,new Array,new Array,moment());f.savedTimeStamps||(f.savedTimeStamps={});var Dt,xt,Tt,Mt,qt,Et={},Ct=[],zt=[],At=!1;D.globalDriver=!1,D.reportEvent=function(e){ke&&jt.ringTone()};var jt={setGlobalQMode:function(){D.quoteQMode=f.quoteQMode||D.default_customer_mode,D.partnersQMode=f.partnersQMode||D.default_driver_mode,D.dispatcherQMode=f.dispatcherQMode||D.default_dispatcher_mode},setServerOffset:function(){this.getTimeZone(32.9355,-96.747).then(function(e){Mt=-(e.rawOffset+e.dstOffset)/3600})},canBookin:function(){return qe},isRinging:function(){return ke},isInitializingFB:function(){return ne},isViewingRates:function(){return re},isViewingOrder:function(){return yt},isOwner:function(){return window.localStorage.getItem("apikeypublic")==Tt},networkListener:function(){D.$on("internet:offline",function(){tt=moment()}),D.$on("internet:online",function(){Pt=moment()})},startTrackingTrip:function(){Pe=!0,ge=D.lat,_e=D.lon,this.startTripDistCompInt()},stopTrackingTrip:function(){var e=this;unloadTripLat=D.lat,he=D.lon,Ie=e.getGPSDistance(ge,_e,unloadTripLat,he),this.stopTripDistCompInt(),this.stopTripDistRemInt()},startTrackingBefore:function(e,t){this.startBeforeArriveInt(e,t)},stopTrackingBefore:function(){I.cancel(Be),Be=null},startTrackingAfter:function(e,t){this.startBeforeDestInt(e,t)},stopTrackingAfter:function(){I.cancel(Ae)},setTripInterval:function(){var e=0;me=I(function(){pe=e++,D.$broadcast("trip:time",pe)},1e3)},startBeforeArriveInt:function(e,t){if(null==Be){var o=new google.maps.LatLng(e,t);if(Se)var i=new google.maps.LatLng(D.lat,D.lon);else var i=new google.maps.LatLng(D.detail.driver_lat,D.detail.driver_lon);var r=new google.maps.DirectionsService,n={origin:i,destination:o,travelMode:google.maps.TravelMode.DRIVING};Be=I(function(){r.route(n,function(e,t){if(t==google.maps.DirectionsStatus.OK)for(var o=e.routes[0],i=0;i<o.legs.length;i++)D.$broadcast("trip:beforeArriveTime",o.legs[i].duration.text),D.$broadcast("trip:beforeArriveDist",o.legs[i].distance.text)})},1e4)}},startBeforeDestInt:function(e,t){var o=new google.maps.LatLng(e,t),i=new google.maps.LatLng(D.lat,D.lon),r=new google.maps.DirectionsService,n={origin:i,destination:o,travelMode:google.maps.TravelMode.DRIVING};Ae=I(function(){r.route(n,function(e,t){if(t==google.maps.DirectionsStatus.OK)for(var o=e.routes[0],i=0;i<o.legs.length;i++)D.$broadcast("trip:beforeDestTime",o.legs[i].duration.text),D.$broadcast("trip:beforeDestDist",o.legs[i].distance.text)})},1e4)},getGoogleDistTime:function(e,t){var o=T.defer(),i=this,r=new google.maps.LatLng(e.lat,e.lon),n=new google.maps.LatLng(t.lat,t.lon),a=new google.maps.DirectionsService,u={origin:r,destination:n,travelMode:google.maps.TravelMode.DRIVING};return a.route(u,function(r,n){if(n==google.maps.DirectionsStatus.OK)for(var a=r.routes[0],u=0;u<a.legs.length;u++){var l={timeVal:a.legs[u].duration.value,timeText:a.legs[u].duration.text,timeHours:a.legs[u].duration.value/3600,dist:a.legs[u].distance.text,distVal:a.legs[u].distance.value,distMiles:a.legs[u].distance.value/1609};o.resolve(l)}else{var d=i.getGPSDistance(e.lat,e.lon,t.lat,t.lon),c=16093*d,f=Math.ceil(c)+" km",p=d/s.driverSpeedMPH,m=3600*p,g=Math.ceil(m/60)+" mins",l={timeVal:m,timeText:g,timeHours:p,dist:f,distVal:c,distMiles:d};o.resolve(l)}}),o.promise},getTripTime:function(){return pe},startTripDistRemInt:function(e,t){var o=this;Ne=I(function(){Fe=o.getGPSDistance(e,t,ge,_e),D.$broadcast("trip:distRem",Fe)},1e4)},stopTripDistRemInt:function(){I.cancel(Ne)},getTripRemDist:function(){return Fe},startTripDistCompInt:function(){var e=this;je=I(function(){Re=e.getGPSDistance(ge,_e,D.lat,D.lon),D.$broadcast("trip:distComp",Re)},1e4)},stopTripDistCompInt:function(){I.cancel(je)},getTripCompDist:function(){return Re},clearTripInterval:function(){I.cancel(me)},isDriver:function(){return Se},removeTripModal:function(){It=!1,vt=!1,f.dispatcherInboxes.indexOf(D.detail.id)>-1&&f.dispatcherInboxes.splice(f.dispatcherInboxes.indexOf(D.detail.id),1),D.detail=null,this.removeModalPopup(D.tripModal),this.removeModalPopup(D.arrivedModal),this.processFirebase()},endTrip:function(e,o){ke&&this.ringTone();var i=this;if(!D.detail||D.detail&&D.detail.id==e){pe=0,window.localStorage.removeItem("replyMsgIndex"),window.localStorage.removeItem("sentMsgIndex"),delete f.tripDetail,this.removeModalPopup(D,"arrivedModal"),this.removeModalPopup(D,"ratingModal"),this.removeModalPopup(D,"receiptModal"),this.removeModalPopup(D,"messageModal"),this.removeModalPopup(D,"cancelTripModal"),this.removeModalPopup(D,"popoverMenu"),this.removeModalPopup(D,"orderEditModal"),this.removeModalPopup(D,"seatsModal"),this.removeModalPopup(D,"chatModal"),D.detail&&D.detail.id==e&&(f.lastTrip=D.detail,f.acceptedOrders&&f.acceptedOrders.indexOf(e)>-1&&f.acceptedOrders.splice(f.acceptedOrders.indexOf(e),1),ye[D.detail.zone_id].hasOwnProperty(D.detail.id)&&delete ye[D.detail.zone_id][D.detail.id],D.detail.isDriver&&C.child(D.detail.group_id+"/queue/"+window.localStorage.getItem("apikeypublic")).onDisconnect().update({quote_id:"disconnected",disconnectTime:Firebase.ServerValue.TIMESTAMP}),D.arrivedToast&&D.arrivedToast.indexOf(D.detail.id)>-1&&D.arrivedToast.splice(D.arrivedToast.indexOf(D.detail.id),1),D.toastArrived&&(u.clear(D.toastArrived),D.toastArrived=null)),D.dontHideLoader=!1,D.offerDetail=null,D.$broadcast("trip:ended");var r=D.tripsInProgress.indexOf(e);r>-1&&r>-1&&D.tripsInProgress.splice(r,1),V&&V(),H&&H(),0==D.tripsInProgress.length?(It=!1,D.tripModal=null,D.detail=null,i.autoBookFunc(),"app.trip-detail"==D.history.currentStateName()&&(t.goBack(),D.onQuotePage||o||i.toggleBook(!0,"all",void 0,!0))):Y&&(f.dispatcherInboxes.length=0,t.goBack(),D.detail=null)}},resetQuoteID:function(){It||dt.forEach(function(e){C.child(e+"/queue/"+window.localStorage.getItem("apikeypublic")).update({quote_id:""})})},setGroupBidMode:function(e){for(var t in wt)(bt[wt[t].groupPosition].biddable||"quote"!=e)&&(bt[wt[t].groupPosition].mode=e,this.setFbBidMode(t,e))},setFbBidMode:function(e,t){dt.indexOf(e)>-1&&C.child(e+"/queue/"+window.localStorage.getItem("apikeypublic")).update({mode:t})},loginApi:function(e){var t=T.defer(),o=M+"login/?email="+e.email+"&"+a.getParams();return o+=e.method?"&method="+e.method:"&password="+e.password,x.get(o).success(function(e){t.resolve(e)}).error(function(e){t.reject(e)}),t.promise},login:function(e){var t=this,o=T.defer(),i=o.promise,r=function(){t.loginApi(e).then(function(e){o.resolve(e),e.user&&(window.localStorage.setItem("apikeypublic",e.user.apikeypublic),f.token={},f.token.time=moment(),f.token.token=e.user.token,D.creditCards=e.user.stripe,D.haveCreditCard=e.user.stripe.length>0?!0:!1,t.getGlobalDrivers())},function(e){o.reject(e)})};return null==window.localStorage.getItem("lat")?this.setLatLon().then(function(){r()}):r(),i.success=function(e){return i.then(e),i},i.error=function(e){return i.then(null,e),i},i},checkMessages:function(){var e=this;st.forEach(function(t){C.child(t+"/messages").once("value",function(t){t.forEach(function(t){e.messageListener(t)})})})},hideQuote:function(e){var t,o=this;D.quoteDetail&&e==D.quoteDetail.zone_id&&(D.quotes.some(function(o,i){return e==o.group_id&&(t=i),e==o.group_id}),t&&D.quotes.splice(D.quotes.indexOf(t),1),0==D.quotes.length&&(l("MOVED_OUT_ZONE").then(function(e){D.quoteDetail&&u.info(D.quoteDetail.group_name,e,{allowHtml:!0,timeOut:3e3,positionClass:"toast-bottom-center"})}),o.quoteModalCleanUp()))},zoneListener:function(e){o.get("EmployeeService").queueListener(e)},addZoneListeners:function(e,t){var o=this;if(!Et.hasOwnProperty(e)||Et.hasOwnProperty(e)&&Et[e].indexOf(t)<0){Et.hasOwnProperty(e)||(Et[e]=[]),Et[e].push(t);try{"value"==t&&C.child(e+"/queue").orderByChild("timestamp").on("value",o.zoneListener),"child_added"==t&&C.child(e+"/queue").orderByChild("timestamp").on("child_added",o.zoneAdded),"child_removed"==t&&C.child(e+"/queue").on("child_removed",o.zoneRemoved)}catch(i){}}},removeZoneListeners:function(e,t){var o=this;Et.hasOwnProperty(e)&&(Et[e].splice(Et[e].indexOf(t),1),0==Et[e].length&&delete Et[e]),"value"==t&&C.child(e+"/queue").orderByChild("timestamp").off("value",o.zoneListener),"child_added"==t&&C.child(e+"/queue").orderByChild("timestamp").off("child_added",o.zoneAdded),"child_removed"==t&&C.child(e+"/queue").orderByChild("timestamp").off("child_removed",o.zoneRemoved)},zoneAdded:function(e){var t=o.get("EmployeeService");if(e.exists()){var i=e.ref().parent().parent().key(),r=e.key();window.localStorage.getItem("apikeypublic")==r&&-1==dt.indexOf(i)&&(dt.push(i),t.setFbBidMode(i,bt[wt[i].groupPosition].mode));var n={};n[r]=e.val(),D.$broadcast("queue:added",n,"added"),ct.hasOwnProperty(i)||(ct[i]={}),ct[i].hasOwnProperty(r)||(ct[i][r]={})}},zoneRemoved:function(e){var t=o.get("EmployeeService");if(e.exists()){var i=e.ref().parent().parent().key(),r=e.key();if(ft.hasOwnProperty(i)&&ft[i].hasOwnProperty(r)&&(delete ft[i][r],0==Object.keys(ft[i]).length&&delete ft[i],pt.hasOwnProperty(r)&&(delete pt[r][i],0==Object.keys(pt[r]).length&&delete pt[r])),!ft[i]&&wt[i]&&(bt[wt[i].groupPosition].limit=!1),window.localStorage.getItem("apikeypublic")==r){var n=dt.indexOf(i);n>-1&&Object.keys(wt).length>0&&wt.hasOwnProperty(i)&&wt[i].booked&&i==wt[i].category_id&&(D.bookingOut.indexOf(i)>-1?(e.ref().onDisconnect().cancel(),dt.splice(n,1),delete rt[i],nt.splice(nt.indexOf(i),1),C.child(i+"/queue").orderByChild("timestamp").off("child_added"),D.bookingOut.splice(D.bookingOut.indexOf(i),1),bt[wt[i].groupPosition].booked=!1,bt[wt[i].groupPosition].showQP=!1,wt[i].booked=!1,0==D.bookingOut.length&&D.$broadcast("loading:hide",!0)):bt[wt[i].groupPosition].booked&&(bt[wt[i].groupPosition].booked=!1,bt[wt[i].groupPosition].showQP=!1,wt[i].booked=!1,t.withinZone(i)?!e.val().disconnectTime&&e.val().first_name?e.ref().update(e.val(),function(){C.child(i+"/queue").orderByChild("timestamp").once("value",function(e){t.queueListener(e)})}):(dt.splice(n,1),delete rt[i],nt.splice(nt.indexOf(i),1)):(e.ref().onDisconnect().cancel(),dt.splice(n,1),nt.splice(nt.indexOf(i),1),delete rt[i],C.child(i+"/queue").orderByChild("timestamp").off("child_added"))),t.setAllBookedStatus())}var a={};if(a[r]=e.val(),D.$broadcast("queue:removed",a,"removed"),null!=W&&B[r]&&W.indexOf(B[r][i])>-1){var s=W[B[r][i].id];s.apikeypublic==r&&s.dispatcher<1&&(s.zone_id==i||s.category_id==i)&&(s.booked=!1,s.QP=null),D.$broadcast("firebase:updated",null)}t.setGroups()}},storeInboxIds:function(e,t){fe.hasOwnProperty(t)||(fe[t]=[]),e&&fe[t].indexOf(e)<0&&fe[t].push(e)},inboxAdded:function(e){var t=o.get("EmployeeService");if(e.exists()){ae=!1;e.ref().parent().key();e.val().route?(e.val().route.ordered_by==o.get("UUIDService").getRandomUUID()||e.val().route.ordered_by==window.localStorage.getItem("apikeypublic"))&&t.storeInboxIds(e.val().route.id,e.val().route.quote_id):e.ref().remove();var i=function(e){var i=e.ref().parent().parent().key(),r=e.val();if(null!=r){if(!e.val().route)return void e.ref().remove(function(e,t){return function(o){o||ye.hasOwnProperty(e)&&ye[e].hasOwnProperty(t)&&delete ye[e][t]}}(i,e.key()));if(dt.length>0&&("quote"==r.route.status||"offer"==r.route.status)||r.route.sent_to==window.localStorage.getItem("apikeypublic")||r.route.ordered_by==o.get("UUIDService").getRandomUUID()||r.route.ordered_by==window.localStorage.getItem("apikeypublic")||r.route.reply_to!=window.localStorage.getItem("apikeypublic")){var n=e.key();if(ye.hasOwnProperty(i)||(ye[i]={}),ye[i][n]=r,r.hasOwnProperty("offer_to_not"))for(var a in r.offer_to_not){var s=r,n=s.route.id;""!=s.offer_to_not[a]&&(s.offer_to_not[a].group_id=i,s.offer_to_not[a].inbox_id=n,s.offer_to_not[a].offer_to_not==window.localStorage.getItem("apikeypublic")&&(we.hasOwnProperty(n)||(we[n]={}),we[n][s.route.status]=a,We=n,"offer"==s.route.status?(Ke=a,D.offerNotInProcess=!1):"quote"==s.route.status&&(Xe=a)))}if(r.hasOwnProperty("offer_to"))for(var a in r.offer_to){var s=r,n=s.route.id;""!=s.offer_to[a]&&(s.offer_to[a].group_id=i,s.offer_to[a].inbox_id=n,s.offer_to[a].offer_to==window.localStorage.getItem("apikeypublic")&&(be[n]=a,"offer"==s.route.status?Je=a:"quote"==s.route.status&&(et=a)))}"quote"!=r.status&&fe.hasOwnProperty(D.sentQuoteId)&&fe[D.sentQuoteId].indexOf(r.route.id)>-1&&fe[D.sentQuoteId].splice(fe[D.sentQuoteId].indexOf(r.id),1),t.setOfferTimeout(),t.processFirebase(),D.$broadcast("inbox:updated",i)}else ye.hasOwnProperty(i)&&ye[i].hasOwnProperty(e.key())&&delete ye[i][e.key()]}};e.ref().on("value",i)}},inboxRemoved:function(e){var i=o.get("EmployeeService");if(e.exists()){var r=e.key(),n=e.ref().parent().parent().key();if(ye&&ye[n])var a=angular.copy(ye[n][r]);else var a=e.val();D.$broadcast("inbox:removed",e.val().route);var s=F.indexOf(r);if(s>-1&&F.splice(s,1),e.val().route&&fe.hasOwnProperty(e.val().route.quote_id)&&fe[e.val().route.quote_id].indexOf(e.val().route.id)>-1){var d=e.val().route.quote_id;fe[d].splice(fe[d].indexOf(e.val().route.id),1),0==fe[d].length&&(delete fe[d],J[d]&&(P.cancel(J[d]),delete J[d]),D.$broadcast("quotecancelled",d))}Ct.indexOf(r)>-1&&Ct.splice(Ct.indexOf(r),1);var c;for(var f in ye){for(var p in ye[f])if(a&&ye[f][p].route.quote_id==a.route.quote_id&&"offer"==a.route.status&&a.route.reply_to==window.localStorage.getItem("apikeypublic")){if(ye[f][p].route.id!=a.route.id){c=!1;break}c=!0}if(c===!1)break}if((D.allow_reoffer&&c||!D.allow_reoffer&&a&&"offer"==a.route.status&&a.route.reply_to==window.localStorage.getItem("apikeypublic"))&&(l(["SORRY","OFFER_NOT_ACCEPTED"]).then(function(e){D.dontHideLoader=!1,D.$broadcast("loading:hide"),u.error(e.OFFER_NOT_ACCEPTED,e.SORRY)}),"app.trip-detail"!=D.history.currentStateName()||D.detail||(It=!1,D.tripModal=null,t.goBack())),ye[n]&&ye[n].hasOwnProperty(r)&&delete ye[n][e.key()],Ze.hasOwnProperty(""+n+","+r)&&delete Ze[""+n+","+r],zt.indexOf(r)>-1&&zt.splice(zt.indexOf(r),1),Me.hasOwnProperty(n)){var m=Me[n].indexOf(r);m>-1&&(Me[n].splice(m,1),vt=!1)}!It||It&&void 0!=D.detail&&D.detail.zone_id==n,a&&i.cleanModals(n,r,a),i.setEmptyQuoteId(e.val())}},setEmptyQuoteId:function(e){var t=e.route;if(!It&&t&&"object"!=typeof t.sent_to&&ft[t.zone_id]&&ft[t.zone_id][t.sent_to]){var o=C.child(e.route.zone_id+"/queue/"+e.route.sent_to);o.update({quote_id:""})}},isDispatcherAdmin:function(e){return 0==this.getEmployees().length?!1:bt.some(function(t){return!t.hasOwnProperty("can_bookin")&&t.category_id==e&&new RegExp("^$|"+t.tags.join("|")).test("Admin,Dispatcher")||t.hasOwnProperty("can_bookin")&&t.category_id==e&&f.user_id==t.user_id})},queueListener:function(e,t,o){var i=this;if(e.exists()){var r=e.ref().parent().key();i.setEmpl(e,r,t),f.isDriver&&e.hasChild(window.localStorage.getItem("apikeypublic"))&&D.$broadcast("firebase:updated",null)}o&&ut.indexOf(o)>-1&&ut.splice(ut.indexOf(o),1)},listenFBConnected:function(){var e=this;C.child(".info/connected").on("value",function(t){!xt&&t.val()&&e.resetQP(),xt=t.val(),t.val()||(D.listenedQueue=!1)})},isFBConnected:function(){return xt},resetQP:function(){var e=this;e.resetLatLon(),e.autoBookFunc(!0);dt.slice(0);e.queueListenerFunc(st,!1,!0)},getServerTime:function(){var e=0;return C.child(".info/serverTimeOffset").on("value",function(t){e=t.val()}),Date.now()+e},removeUserFromFb:function(e,t,i,r,n,a){var s=this;if((!t.quote_id||"disconnected"==t.quote_id||""==t.quote_id)&&n==window.localStorage.getItem("apikeypublic")&&wt[t.group_id]&&!bt[wt[t.group_id].groupPosition].booked&&!s.isDispatcherAdmin(t.group_id)&&o.get("UUIDService").matchesMyUUID(t.uuid)&&!s.withinZone(t.group_id)||!t.first_name||t.disconnectTime&&(""==t.quote_id||"disconnected"==t.quote_id)&&(n!=window.localStorage.getItem("apikeypublic")||n==window.localStorage.getItem("apikeypublic")&&D.bookingIn.indexOf(e)<0)&&moment(s.getServerTime()).diff(moment(t.disconnectTime),"seconds")>z){if(n==window.localStorage.getItem("apikeypublic")&&(i.ref().child("/"+n).onDisconnect().cancel(),dt.indexOf(e)>-1&&dt.splice(dt.indexOf(e),1),at.indexOf(e)>-1&&at.splice(at.indexOf(e),1),wt&&wt[e]&&(bt[wt[e].groupPosition].booked=!1)),n==window.localStorage.getItem("apikeypublic")){r.ref().onDisconnect().cancel();var u=dt.indexOf(e);u>-1&&dt.splice(u,1),nt.splice(nt.indexOf(e),1),delete rt[e],C.child(e+"/queue").orderByChild("timestamp").off("child_added"),s.setAllBookedStatus()}return!0}return!1},setEmpl:function(e,t,i){var r,n=this,a=-1,s=!1,u=0,l=e.numChildren(),d=l,c=0,f=0,p={};if(e.forEach(function(e){var t=e.val(),o=e.key();t.tags&&(t.tags.indexOf("Driver")<0||""!=t.quote_id||!n.withinZone(t.group_id,null,t.lat,t.lon))?(u--,d--):(p[t.zone_id]||(p[t.zone_id]=[]),p[t.zone_id].push(o))}),e.forEach(function(o){c++,u++;var i=o.key(),l=o.val();if(i==window.localStorage.getItem("apikeypublic")&&(f=c),(!n.removeUserFromFb(t,l,e,o,i)||(r={key:i,lat:l.lat,lon:l.lon,ref:o.ref()},i==window.localStorage.getItem("apikeypublic")||c==e.numChildren()))&&(!r||((i==window.localStorage.getItem("apikeypublic")||f==c-1&&c==e.numChildren())&&(r.lat&&n.logoutUser(r.key,r.lat,r.lon),function(e){r.ref.remove(function(){C.child(e+"/queue").orderByChild("timestamp").once("value",function(e){n.queueListener(e)})})}(t)),r=null,c!=e.numChildren()))&&l.email){ct.hasOwnProperty(t)||(ct[t]={}),ct[t].hasOwnProperty(i)||(ct[t][i]={},s=i==window.localStorage.getItem("apikeypublic")),ct[t][i].lat=l.lat,ct[t][i].lon=l.lon,ct[t][i].update_time=l.update_time,ft.hasOwnProperty(t)||(ft[t]={}),i==window.localStorage.getItem("apikeypublic")&&wt[t]&&!bt[wt[t].groupPosition].limit&&(dt.indexOf(t)<0&&dt.push(t),Y="disconnected"!=l.quote_id&&""!=l.quote_id?l.quote_id:!1),ft[t].hasOwnProperty(i)||(ft[t][i]={}),ft[t][i].first_name=l.first_name,ft[t][i].item_id=l.item_id,ft[t][i].quote_id=l.quote_id,ft[t][i].group_id=l.group_id,ft[t][i].timestamp=l.timestamp,ft[t][i].zone_id=l.zone_id,ft[t][i].uuid=l.uuid,ft[t][i].position=c,n.processFirebase(),pt.hasOwnProperty(i)||(pt[i]={}),pt[i][l.group_id]={zone_id:l.zone_id,group_id:l.group_id,item_id:l.item_id,tags:l.tags,mode:l.mode,quote_id:l.quote_id,lat:l.lat,lon:l.lon,settings:l.settings},l.disconnectTime&&(pt[i][l.group_id].disconnectTime=l.disconnectTime,P(function(e){C.child(e+"/queue").orderByChild("timestamp").once("value",function(e){n.queueListener(e)})},1e3*(z+1),!0,t));var m={};m[i]=pt[i][l.group_id],D.$broadcast("queue:updated",m,"updated");var g=(o.val(),ft[t][window.localStorage.getItem("apikeypublic")]);ct[t][window.localStorage.getItem("apikeypublic")]?ct[t][window.localStorage.getItem("apikeypublic")]:D;if(wt[t]&&c==e.numChildren()&&(D.zone_maximum_driver_limit<=d?a>D.zone_maximum_driver_limit&&!vt&&!It?(n.toggleBook(!1,bt[wt[t].groupPosition].id),bt[wt[t].groupPosition].limit=!0):(D.detail&&D.detail.zone_id==t&&D.zone_maximum_driver_limit<d||!g&&-1==a)&&(bt[wt[t].groupPosition].limit=!0):bt[wt[t].groupPosition].limit=!1),W&&void 0!=B[i]&&void 0!=B[i][t]&&void 0!=W[B[i][t].id]){var _=W[B[i][t].id];if(_.apikeypublic==i&&(t==_.zone_id||t==_.category_id)){_.booked=!0,_.first_name=l.first_name,_.lat=Number(l.lat),_.lng=Number(l.lon),_.pic=l.pic,_.license=l.license,_.vehicle=l.vehicle,_.quote_id=l.quote_id,_.zone_id=l.zone_id,_.mode=l.mode;var h=n.withinZone(l.group_id,null,_.lat,_.lng);if(l.tags.indexOf("Driver")<0||!h?_.QP=d:p[l.zone_id]&&(_.QP=p[l.zone_id].indexOf(i)+1+"/"+p[l.zone_id].length),0==_.QP.toString().search("0")&&(_.QP=""),_.pic==M.replace("/api/","/assets/")+"img/markers/transportation/town_car.png"&&(_.pic="img/person.jpg"),_.cellPhone=l.cellPhone,""!=l.quote_id&&"Offered"!=l.quote_id&&"disconnected"!=l.quote_id){if(ye.hasOwnProperty(t))for(var v in ye[t]){var y=ye[t][v].route;y.sent_to==_.apikeypublic&&("rate"!=y.reply_to_message[Object.keys(y.reply_to_message)[Object.keys(y.reply_to_message).length-1]].status?(_.intrip=!0,_.quote_id=l.quote_id):_.intrip=!1)}}else _.intrip=!1}D.$broadcast("firebase:updated",null)}P(function(){n.setOfferTimeout()},1e3)}}),D.loggedIn&&e.hasChild(window.localStorage.getItem("apikeypublic"))&&ft[t]&&ft[t][window.localStorage.getItem("apikeypublic")]&&pt[window.localStorage.getItem("apikeypublic")]&&pt[window.localStorage.getItem("apikeypublic")][t]&&wt[t]&&ft[t][window.localStorage.getItem("apikeypublic")].hasOwnProperty("first_name")&&(i||!bt[wt[t].groupPosition].limit)){if(wt[t])var m=t;else{var m=ft[t][window.localStorage.getItem("apikeypublic")].group_id;bt[wt[m].groupPosition].zone_id=t}var g=n.withinZone(t),_=ft[t][window.localStorage.getItem("apikeypublic")].zone_id;pt[window.localStorage.getItem("apikeypublic")][m].tags.indexOf("Driver")<0||!g?bt[wt[t].groupPosition].QP=d:p[_]&&(bt[wt[t].groupPosition].QP=p[_].indexOf(window.localStorage.getItem("apikeypublic"))+1+"/"+p[_].length,bt[wt[t].position].QP=bt[wt[t].groupPosition].QP),""!=ft[t][window.localStorage.getItem("apikeypublic")].quote_id&&"disconnected"!=ft[t][window.localStorage.getItem("apikeypublic")].quote_id||(It||bt[wt[t].groupPosition].booked)&&!i||e.ref().child("/"+window.localStorage.getItem("apikeypublic")).onDisconnect().update({quote_id:"disconnected",disconnectTime:Firebase.ServerValue.TIMESTAMP});var h=bt[wt[m].groupPosition];if(h.booked=!0,h.showQP=!0,h.mode=ft[t][window.localStorage.getItem("apikeypublic")].mode,wt[m].booked=!0,n.setAllBookedStatus(),n.setGroups(),D.bookingIn.indexOf(t)>-1||"disconnected"==ft[t][window.localStorage.getItem("apikeypublic")].quote_id||s||!rt[t]||new RegExp("^$|"+pt[window.localStorage.getItem("apikeypublic")][m].tags.join("|")).test("Admin,Dispatcher")){var v;h.withinzone&&ft.hasOwnProperty(h.category_id)&&ft[h.category_id].hasOwnProperty(window.localStorage.getItem("apikeypublic"))&&(v=h.category_id);var m=v||t;if(D.bookingIn.indexOf(t)>-1&&(D.bookingIn.splice(D.bookingIn.indexOf(t),1),0==D.bookingIn.length&&P(function(){0==D.bookingIn.length&&(L=!1,n.setGroups())},5e3)),"disconnected"==ft[t][window.localStorage.getItem("apikeypublic")].quote_id&&(C.child(t+"/queue/"+window.localStorage.getItem("apikeypublic")+"/disconnectTime").remove(),C.child(t+"/queue/"+window.localStorage.getItem("apikeypublic")).update({quote_id:"",lat:D.lat,lon:D.lon})),ft[t]&&ft[t][window.localStorage.getItem("apikeypublic")]&&nt.indexOf(bt[wt[m].groupPosition].category_id)<0){var y=!1;if(!rt[bt[wt[m].groupPosition].category_id]){var w=n.withinZone(bt[wt[m].groupPosition].category_id,null,null,null,null,null,ft[t][window.localStorage.getItem("apikeypublic")].zone_id);w||(w=n.withinZone(bt[wt[m].groupPosition].category_id,!0)),rt[bt[wt[m].groupPosition].category_id]=w}nt.indexOf(bt[wt[m].groupPosition].category_id)<0&&(nt.push(bt[wt[m].groupPosition].category_id),C.child(m+"/queue").orderByChild("timestamp").once("value",function(e){y=e})),!D.listenedQueue&&ft[t]&&ft[t][window.localStorage.getItem("apikeypublic")]&&ee.indexOf(t)<0&&n.updateFbUUID(ft[t][window.localStorage.getItem("apikeypublic")].uuid,t),nt.indexOf(t)<0&&n.autoBookFunc(),y&&n.queueListener(y)}}0==D.bookingIn.length&&D.$broadcast("loading:hide"),n.processFirebase()}ft[t]&&ft[t][window.localStorage.getItem("apikeypublic")],ft[t]&&ft[t][window.localStorage.getItem("apikeypublic")]&&ee.indexOf(t)<0&&pt[window.localStorage.getItem("apikeypublic")]&&pt[window.localStorage.getItem("apikeypublic")][t]&&D.listenedQueue&&!o.get("UUIDService").matchesMyUUID(ft[t][window.localStorage.getItem("apikeypublic")].uuid)&&(n.resetVariables(),q.transitionTo("app.quoteform"))},updateQP:function(e,t){var o=this;(ft[t]&&ft[t][window.localStorage.getItem("apikeypublic")]&&!ft[t][window.localStorage.getItem("apikeypublic")].hasOwnProperty("QP")||e!=ft[t][window.localStorage.getItem("apikeypublic")].QP)&&(te.indexOf(t)<0&&te.push(t),C.child(t+"/queue/"+window.localStorage.getItem("apikeypublic")+"/QP").set(e,function(e){e||C.child(t+"/queue").orderByChild("timestamp").once("value",function(e){o.queueListener(e)}),te.splice(te.indexOf(t),1)}))},updateFbUUID:function(e,t){var i=T.defer(),r=this;if(!o.get("UUIDService").matchesMyUUID(e)&&ft[t]&&ft[t][window.localStorage.getItem("apikeypublic")]){ee.indexOf(t)<0&&ee.push(t);var n=this.withinZone(t,null,null,null,null,null,ft[t][window.localStorage.getItem("apikeypublic")].zone_id),a={uuid:f.uuid,lat:D.lat,lon:D.lon};n||(n=this.withinZone(t,!0)),n&&(a.zone_id=n.id,X[t]=n.id),C.child(t+"/queue/"+window.localStorage.getItem("apikeypublic")).update(a,function(e){e||C.child(t+"/queue").orderByChild("timestamp").once("value",function(e){r.queueListener(e)}),ee.splice(ee.indexOf(t),1),i.resolve()})}else i.resolve();return i.promise},updateQueue:function(e,t,o,i,r){var n=this;if(e){var a=C.child(e+"/queue/"+window.localStorage.getItem("apikeypublic"));if("inside"==t&&o){var s={lat:D.lat,lon:D.lon,zone_id:o};o!=ft[e][window.localStorage.getItem("apikeypublic")].zone_id&&(s.timestamp=Firebase.ServerValue.TIMESTAMP),a.update(s,function(t){!t&&bt.length>0&&(bt[wt[e].groupPosition].zone_id=o,n.setGroups(),C.child(e+"/queue").orderByChild("timestamp").once("value",function(e){n.queueListener(e)})),n.autoBookFunc()})}else"update"==t?0==Z&&(a.update({lat:D.lat,lon:D.lon},function(e){e||n.setGroups()}),r.indexOf(e)==r.length-1&&n.resetLatLon()):n.isDispatcherAdmin(e)||Y?(C.child(e+"/queue").orderByChild("timestamp").once("value",function(e){n.queueListener(e)}),a.update({lat:D.lat,lon:D.lon,zone_id:e},function(t){t||(n.setGroups(),X[e]=e)})):(wt[e]&&n.toggleBook(!1,bt[wt[e].groupPosition],null,null,!0),a.remove(function(t){t||(wt[e]&&(bt[wt[e].groupPosition].zone_id=e),n.setGroups(),C.child(e+"/queue").orderByChild("timestamp").once("value",function(e){n.queueListener(e)})),n.autoBookFunc()}))}},setStoredZones:function(e,t,o){var i,r=this;if(e){if("inside"!=t)return X[o]&&X[o]==e.id||(X[o]=e.id),i=at.indexOf(e.id),void(i>-1&&(at.splice(i,1),0==at.length&&r.updateQueue(o,"remove",e.id,e)));if(at.indexOf(e.id)<0&&at.push(e.id),X[o]&&X[o]==e.id)return;X[o]=e.id,at.forEach(function(i){X[o]==i&&r.updateQueue(o,t,i,e)})}},autologinApi:function(){var e=this;x.get(M+"autologin/?"+a.getAutoLoginParams()).success(function(t){if("failed"==t.status.toLowerCase())e.resetVariables(),q.transitionTo("app.quoteform");else{var o=t.user.zone_id;1==o.length&&"object"==typeof o[0]&&(ne=!1,D.$broadcast("firebaseInitialized"),D.noGroups=!0,D.startupLoading=!1,D.$broadcast("loading:hide"),D.loggedIn?q.transitionTo("app.employee-index"):q.transitionTo("app.login"))}})},autologin:function(){var e=this,t=T.defer(),o=function(i){x.get(M+"autologin/?"+a.getAutoLoginParams()).success(function(o){if("Success"==o.status){if(ut=o.user.zone_id,e.setGlobalGroups(),o.user.groups.ancestors.group_id.forEach(function(e){""!=e&&ut.indexOf(e)<0&&ut.push(e)}),null!=bt)for(var i=0;i<bt.length;i++)0==bt[i].dispatcher&&bt[i].apikeypublic==window.localStorage.getItem("apikeypublic")&&st.indexOf(bt[i].zone_id)<0;f.isDriver&&e.setGroups(),f.token={},f.token.time=moment(),f.token.token=o.user.token,t.resolve(f.token.token)}else t.reject(o.status);D.$broadcast("autologin")}).error(function(e){i>3?t.reject(e):o(i+1)})};return o(0),t.promise},getVehiclesPermits:function(e,t){var o=T.defer();if(D.myVehicles&&!e)o.resolve();else{t||D.$broadcast("loading:show");var i=function(e){x.get(M+"vehicles/?"+a.getAutoLoginParams(),{data:{show:!1}}).success(function(e){"Success"==e.status?(D.myVehicles=e.vehicles.filter(function(e){return moment(e.permit_expiry_date).isValid()&&moment(e.title_expiry_date).isValid()}),D.myPermits=e.permits.filter(function(e){return moment(e.permit_expiry_date).isValid()}),o.resolve()):o.reject(e.status)}).error(function(t){o.reject(t),!D.isOffline&&3>e&&i(e+1)})};i(0)}return o.promise},logOut:function(){var e=T.defer(),t=this,o=e.promise;return x.get(M+"logout/?"+a.getParams()).success(function(o){t.resetVariables(),D.$broadcast("user:updated",!Se),e.resolve(o)}).error(function(t){e.reject(t)}),o.success=function(e){return o.then(e),o},o.error=function(e){return o.then(null,e),o},o},logoutUser:function(e,t,o){x.get(M+"logout/?apikeypublic="+e+"&lat="+t+"&lon="+o+"&uuid="+f.uuid+"&app_id="+Tt,{data:{show:!1}}).success(function(e){}).error(function(e){})},addGroup:function(e,t){var o=T.defer(),i=this,r=function(){var r=e.allow_queue?"yes":"no",u=e.zone_based_queuing?"yes":"no",l=M+"addGroup/?name="+e.name+"&description=''&status="+e.active+"&default_name=&offer="+e.offer+"&allow_remote_reservation="+e.allow_remote_reservation+"&allow_advance_reservation="+e.allow_advance_reservation+"&zone_based_queuing="+u+"&allow_queue="+r+"&jail="+e.jail+"&"+e.services.join("&")+"&"+e.tags.join("&")+"&"+a.getParams();void 0!=e.id&&(l+="&id="+e.id),void 0!=e.pic&&(l+="&pic=https://yd.firebaseio.com/images/"+window.localStorage.getItem("apikeypublic")+"/group"),e.lat&&(l+="&lat="+e.lat+"&lon="+e.lon+"&radius="+e.radius),x.get(l).success(function(r){e.id||t||i.addDispatcherItem({name:f.name,email:f.email,category_id:r.group_id,cellPhone:111111,active:1,itemType:"Admin"}),e.pic&&i.savePic(e.pic,"group",r.group_id).then(function(){},function(e){o.reject(e)}),e.id?o.resolve(r):(e.id=r.group_id,s(e),n.length>0?T.all(n)["finally"](function(e){o.resolve(r)}):o.resolve(r)),D.noGroups=!1}).error(function(e){o.reject(e)})},n=[],s=function(e){void 0!=e.pic&&n.push(this.savePic(e.pic,"group")),e.id&&(e.centers&&e.centers.length>0&&n.push(i.saveMarket(e.centers,e.id)),e.zones&&e.zones.length>0&&n.push(i.saveZones(e.zones,e.id)),e.zonesDelete&&e.zonesDelete.length>0&&n.push(i.deleteZones(e.zonesDelete,e.id)),e.toSaveRateplans&&e.toSaveRateplans.length>0&&n.push(i.savePlan(e.toSaveRateplans,e.id)))},u=function(e){s(e),0!=n.length&&e.id?T.all(n).then(function(e){r()}):r()};return u(e),o.promise},saveMarket:function(e,t){var o=T.defer(),i=C.child(t+"/zones/latlon"),r={};return r=$.extend({},e),r=angular.fromJson(angular.toJson(r)),i.update(r,function(e){e?o.reject(e):o.resolve()}),o.promise},saveZones:function(e,t){var o=T.defer();
return e.forEach(function(i,r){var n=M+"zones/?circles=true&group_id="+t+"&id="+i.id+"&name="+i.name+"&zlat="+i.lat+"&zlon="+i.lon+"&radius="+i.radius+"&zone_radius="+i.zone_radius+"&"+a.getParams();x.get(n).success(function(t){r==e.length-1&&o.resolve(t)}).error(function(e){o.reject(e)})}),o.promise},deleteZones:function(e,t){var o=T.defer();return e.forEach(function(i,r){var n=M+"zones/?circles=true&group_id="+t+"&delete="+i.id+"&"+a.getParams();x.get(n).success(function(t){r==e.length-1&&o.resolve(t)}).error(function(e){o.reject(e)})}),o.promise},savePlan:function(e,t){var o=T.defer();return e.forEach(function(i,r){var n=M+"rates/?group_id="+t+"&name="+i.name+"&"+i.rateplan.join("&")+"&"+a.getParams();void 0!=i.id&&(n+="&id="+i.id),x.get(n).success(function(t){r==e.length-1&&o.resolve(t)}).error(function(e){o.reject(e)})}),o.promise},fetchPlans:function(e){var t=T.defer(),o=M+"rates/?group_id="+e+"&"+a.getParams();return x.get(o).success(function(e){"Failed"!=e.status?t.resolve(e):t.reject(e)}).error(function(e){t.reject(e)}),t.promise},getTagsRatePlan:function(e,t){var o=[];return t&&(o=it[e]?t.filter(function(t){return ze.hasOwnProperty(t)&&it[e].indexOf(t)<0}):t.filter(function(e){return ze.hasOwnProperty(e)})),o},hasRatePlanServ:function(e,t){var o=!1;return t&&(t.indexOf("Driver")<0?o=!0:it[e]&&(o=t.some(function(t){return ze.hasOwnProperty(t)&&it[e].indexOf(t)>-1}))),o},hasServType:function(e){var t=!0;return e.indexOf("Driver")>-1&&(t=e.some(function(e){return ze.hasOwnProperty(e)})),t},resetVariables:function(){Se=!0,this.clearAutoBookInt(),re=!1,yt=!1,It=!1,ie=!1,ct={},dt.length=0,gt={},pt={},ft={},we={},rt={},at.length=0,f.savedTimeStamps={},firebaseInitialized=!1,D.itemBooked=0,D.itemNotBooked=0,D.isTripStarted=!1,D.showQuoteForm=!1,D.creditCards.length=0,D.vehiclePermitData=null,D.vehiclePermit=null,D.myVehicles=null,D.myPermits=null,delete f.stripe,delete f.name,delete f.isDriver,window.localStorage.removeItem("quote_Id"),delete f.token,delete f.quoteID,delete f.picData,delete f.permit,delete f.vehicle,delete f.myDriverRating,delete f.myCustomerRating,delete f.acceptedOrders,D.tripsInProgress.length=0,D.picData=null,D.myDriverRating=null,D.myCustomerRating=null,f.quoteQMode=f.partnersQMode=f.dispatcherQMode=null,this.setGlobalQMode(),wt={},bt&&(bt.length=0),D.bookingIn.length=D.bookingOut.length=0,F.length=0,qe=!1,window.localStorage.removeItem("apikeypublic"),D.loggedIn=!1,D.listenedQueue=!1,D.offerDetail=null,D.hasDriverQP=!1,D.detail=null,D.tripModal=null,X={},nt.length=0,D.globalDriver=!1},forgotPassword:function(e){var t=T.defer(),o=t.promise;return this.setLatLon().then(function(){x.get(M+"reminder/?email="+e.email+"&"+a.getParams()).success(function(e){t.resolve(e)}).error(function(e){t.reject(e)})}),o.success=function(e){return o.then(e),o},o.error=function(e){return o.then(null,e),o},o},signUp:function(e){var t=T.defer(),o=t.promise,i=M+"signup/?name="+e.name+"&email="+encodeURIComponent(e.email)+"&phone="+e.phone+"&password="+e.password+"&confirm_password="+e.confirmPassword+"&disclaimer=1&"+a.getParams();return null!=e.referred&&(i+="&coupon="+e.referred),x.get(i).success(function(e){t.resolve(e)}).error(function(e){t.reject(e)}),o.success=function(e){return o.then(e),o},o.error=function(e){return o.then(null,e),o},o},changePassword:function(e){var t=T.defer(),o=M+"profile/?password[]="+e.oldpassword+"&password[]="+e.newpassword+"&"+a.getParams();return x.get(o).success(function(e){t.resolve(e)}).error(function(e){t.reject(e)}),t.promise},saveVehicle:function(e){var t=T.defer(),o=this,i=function(){var o=M+'profile/?vehicle["vin_number"]='+e.vin+'&vehicle["make"]='+e.make+'&vehicle["model"]='+e.model+'&vehicle["year"]='+e.year+'&vehicle["type"]='+e.type+'&vehicle["color_exterior"]='+e.exterior+'&vehicle["color_inside"]='+e.interior+'&vehicle["seats"]='+e.seats+'&vehicle["mileage"]='+e.mileage+'&vehicle["plate_number"]='+e.plate+'&vehicle["insurance"]=https://yd.firebaseio.com/images/'+window.localStorage.getItem("apikeypublic")+'/insurance&vehicle["permit_expiry_date"]='+moment(e.permit_expiry,"MM/DD/YY").format("YYYY-MM-DD")+'&vehicle["inspection_expiry_date"]=https://yd.firebaseio.com/images/'+window.localStorage.getItem("apikeypublic")+'/inspection_expiry_date&vehicle["title_expiry_date"]='+moment(e.title_expiry,"MM/DD/YY").format("YYYY-MM-DD")+"&"+a.getParams();$.get(o,function(e){t.resolve(e)}).fail(function(e){t.reject(e)})};return o.savePic(e.insurance,"insurance").then(function(){o.savePic(e.inspection_expiry_date,"inspection_expiry_date").then(function(){i()},function(e){t.reject(e)})},function(e){t.reject(e)}),t.promise},saveDriverInfo:function(e){var t=T.defer(),o=this,i=function(){var o=M+'profile/?driver["license_number"]='+e.license+'&driver["permit_expiry_date"]='+moment(e.expiry,"MM/DD/YY").format("YYYY-MM-DD")+'&driver["permit_cities"]='+e.permit_cities+'&driver["permit_city"]=https://yd.firebaseio.com/images/'+window.localStorage.getItem("apikeypublic")+'/permit_city&driver["permit_upload"]=https://yd.firebaseio.com/images/'+window.localStorage.getItem("apikeypublic")+'/permit&driver["license_upload"]=https://yd.firebaseio.com/images/'+window.localStorage.getItem("apikeypublic")+"/license&"+a.getParams();$.get(o,function(e){t.resolve(e)}).fail(function(e){t.reject(e)})};return void 0==e.permit_cities||""==e.permit_cities?(e.permit_upload=D.myPermits[0].permit_uploaded,e.permit_expiry_date=moment(D.myPermits[0].permit_expiry_date).format("MM-DD-YYYY"),e.permit_cities=D.myPermits[0].permit_cities):(void 0==e.license||""==e.license)&&(e.license_upload=D.myPermits[0].license_uploaded,e.license=D.myPermits[0].license_number,e.permit_city=D.myPermits[0].permit_city),o.savePic(e.permit_upload,"permit").then(function(){o.savePic(e.permit_city,"permit_city").then(function(){o.savePic(e.license_upload,"license").then(function(){i()},function(e){t.reject(e)})},function(e){t.reject(e)})},function(e){t.reject(e)}),t.promise},savePOI:function(e,t){var o=T.defer(),i=M+"poi/?name[]="+e.name+"&place_type="+e.type+"&address[]="+e.address+"&latitude[]="+e.lat+"&longitude[]="+e.lng+"&"+a.getParams();return t&&(i+="&delete=1"),x.get(i).success(function(e){o.resolve(e)}).error(function(e){o.reject(e)}),o.promise},getPOIs:function(e){var t=T.defer(),o=M+"pois/?"+a.getParams();return x.get(o).success(function(e){t.resolve(e),e.hasOwnProperty("pois")&&(D.pois=e.pois)}).error(function(e){t.reject(e)}),t.promise},getTags:function(e,t){void 0==e&&(e=Tt);var o=T.defer(),i=M+"tags/?app_id="+e+"&"+a.getParams();return t&&(i+="&group_id[]="+t),x.get(i).success(function(e){o.resolve(e),D.tags=e.tags,Ee={},e.tags.forEach(function(e){Ee.all={},Ce.all={},Ee.hasOwnProperty(e)||(Ee[e]={}),Ce.hasOwnProperty(e)||(Ce[e]={})}),ze=angular.copy(Ee),D.bidOnDrivers.length=0}).error(function(e){o.reject(e)}),o.promise},setServices:function(e,t,o,i,r,n,a,s,u,l){if(null!=e){if(0==Object.keys(e).length)return o.length=0,i="",void(r&&r(o));var d=(a?a.split(","):[],[]);e[Object.keys(e)[0]].tags.forEach(function(o){t.indexOf(o)>-1&&(void 0==n||e[Object.keys(e)[0]].group_id==n)&&("removed"==s?u[o]--:"added"==s&&u[o]++)});for(var c in u)u[c]>0&&l.indexOf(c)<0?(l.push(c),o.push({id:c,text:c,"class":"taxicar",checked:!1,icon:"pics/taxi.png"})):0==u[c]&&l.indexOf(c)>-1&&(l.splice(l.indexOf(c),1),o.splice(l.indexOf(c),1));if(""!=i&&void 0!=i){var f=i.split(",");i.split(",").forEach(function(e,t){var o=l.indexOf(e);0>o&&(d.push(e),f.splice(t,1))}),d.length>0&&(i=f.join(","),d=d.join(", "))}r&&r(o,i.length>0?i:null,d.length>0?d:null)}},matchesTags:function(e,t){var o=0==t.length;return!o&&e&&(o=e.tags.some(function(e){return t.indexOf(e)>-1})),o},setPic:function(){f.picData&&f.picData!=D.picData&&(D.picData=f.picData,$(".menuheadericon").hasClass("ion-mypic")||$(".menuheadericon").addClass("ion-mypic"),$(".menuheadericon").css("background","url("+D.picData+") no-repeat"))},saveDriverPic:function(e,t){var o=T.defer(),i=this,r=M+"profile/?"+a.getParams()+"&ownpic=https://yd.firebaseio.com/images/"+window.localStorage.getItem("apikeypublic")+"/"+t;return i.savePic(e,t).then(function(){dt.forEach(function(t){var o=C.child(t+"/queue/"+window.localStorage.getItem("apikeypublic"));o.update({pic:e},function(e){i.findAllEmployees()})}),x.get(r).success(function(t){o.resolve(t),f.picData=e,D.picData=e}).error(function(e){o.reject(e)})},function(e){o.reject(e)}),o.promise},resetLatLon:function(){D.oldlat=D.lat,D.oldlon=D.lon},resetOldLatLon:function(){D.lat=null,D.lon=null},reconnectTimer:function(){R&&P.cancel(R),R=P(function(){R=null,D.showingLoader&&"RECONNECTING"==D.loadingMsg&&window.location.reload(!0)},15e3)},internetGPSReconnected:function(){var e=this;if(e.setLatLon(),!D.app_suspended){D.$broadcast("loading:show",{text:"RECONNECTING"}),this.reconnectTimer(),xt&&e.autoBookIn(),e.autoBookFunc(!0),r.mapsInitialized().then(function(){D.$broadcast("gmaps:loaded")});var t=function(o){ne?(D.loggedIn&&e.getVehiclesPermits(null,!0),e.authenticateFirebase()):e.findAllEmployees().then(function(i){e.autologin().then(function(t){D.$broadcast("loading:hide"),!D.loggedIn||D.onQuotePage||It?(e.processFirebase(),D.$broadcast("loading:hide")):f.isDriver?e.getVehiclesPermits().then(function(){}):(e.processFirebase(),D.$broadcast("loading:hide"))},function(){!D.isGpsOff&&!D.isOffline&&3>o&&t(o+1)})},function(){!D.isGpsOff&&!D.isOffline&&3>o&&t(o+1)})};t(0)}},setLatLon:function(){var e=this,t=T.defer(),o=function(o){P(function(){if(N&&P.cancel(N),De||e.setGPSWatch(),xe&&(D.$broadcast("gpssuccess",null),I.cancel(xe),xe=null),D.isGpsOff&&P(function(){D.isGpsOff=!1,D.isOffline||(D.hideLoader(),e.internetGPSReconnected())}),null!=D.lat){if(!(o.coords.accuracy<200||e.getGPSDistance(o.coords.latitude,o.coords.longitude,D.lat,D.lon)<.5))return;D.lat=Number(o.coords.latitude.toFixed(4)),D.lon=Number(o.coords.longitude.toFixed(4))}else D.lat=Number(o.coords.latitude.toFixed(4)),D.lon=Number(o.coords.longitude.toFixed(4));window.localStorage.setItem("lat",D.lat),window.localStorage.setItem("lon",D.lon),D.tz||e.getTimeZone(D.lat,D.lon).then(function(e){D.tz=e.timeZoneId,_t=-(e.rawOffset+e.dstOffset)/60}),D.$broadcast("location:updated",null),null==D.oldlat&&e.resetLatLon(),null==window.localStorage.getItem("countryCode")&&e.getCountryCityState(),t.resolve("success")})},r=function(o){D.$broadcast("gpserror",null),e.cancelOfferTimeout(),e.clearAutoBookInt(),null==xe&&e.startGpsCheck(),P(function(){!D.isGpsOff&&ionic.Platform.isWebView()&&y.vibrate(500),D.isGpsOff=!0}),l("GPS_OFF").then(function(e){ionic.Platform.isWebView()&&i.hide(),g.show({template:e})}),t.reject(o)};return S.getCurrentPosition(s.geoOptions).then(function(e){o(e)},function(e){ionic.Platform.isWebView()&&r(e)}),N||(N=P(function(){D.isGpsOff=!0,r()},3e4)),t.promise},getCountryCityState:function(){$.ajax({url:"https://maps.googleapis.com/maps/api/geocode/json?latlng="+D.lat+","+D.lon+"&sensor=false",type:"GET",success:function(e){"OK"==e.status&&(e.results[0].address_components.forEach(function(e,t){"country"==e.types[0]&&(D.countryCode=e.short_name,D.country=e.long_name),"administrative_area_level_1"==e.types[0]&&(D.state=e.long_name),"administrative_area_level_2"==e.types[0]&&(D.city=e.long_name)}),window.localStorage.setItem("countryCode",D.countryCode))}})},startGpsCheck:function(){var e=this;xe=I(function(){e.setLatLon()},1e4)},setGPSWatch:function(){var e=this;De=!0;var t=function(t){(t.coords.accuracy<200||e.getGPSDistance(t.coords.latitude,t.coords.longitude,D.lat,D.lon)<.5)&&(D.lat=Number(t.coords.latitude.toFixed(4)),D.lon=Number(t.coords.longitude.toFixed(4)),window.localStorage.setItem("lat",D.lat),window.localStorage.setItem("lon",D.lon),e.autoBookFunc(),D.$broadcast("location:updated",null),xe&&(D.$broadcast("gpssuccess",null),I.cancel(xe),xe=null))},o=function(t){D.$broadcast("gpserror",null),De=!1,null==xe&&e.startGpsCheck()},i=S.watchPosition(s.geoOptions);i.then(null,function(e){o(e)},function(e){t(e)})},toggleBook:function(e,t,o,i,r){var n=this,a=T.defer(),s=!1;It||D.$broadcast("loading:show",{show:r!==!1,text:e?"BOOKING_IN":"BOOKING_OUT"});var u=function(r){if(r.items.every(function(e){return e.dispatcher<1&&e.apikeypublic==window.localStorage.getItem("apikeypublic")&&e.overdue?(e.overdue.group<0&&(s=e.overdue.group),!1):!0}),s){if(D.$broadcast("loading:hide"),a.reject(),o)return;return void l(["SORRY","APP_OVERDUE1","APP_OVERDUE2"]).then(function(e){O.alert({title:e.SORRY,template:e.APP_OVERDUE1+Math.abs(s)+e.APP_OVERDUE2})})}if("all"==t){var u=e?"2":"-2",d=0;angular.forEach(bt,function(e){e.dispatcher>0&&wt.hasOwnProperty(e.zone_id)&&1==bt[wt[e.zone_id].position].active&&(bt[d].status=u),d++})}else if(Object.getPrototypeOf(t)===Array.prototype){var u=e?"2":"-2";dt.forEach(function(e,t){wt.hasOwnProperty(e)&&(bt[wt[e].groupPosition].status=u)})}1==e?n.bookIn(t,i).then(function(e){a.resolve(e)},function(){P(function(){D.$broadcast("loading:hide")},500)}):n.bookOut(t,i).then(function(e){a.resolve(e),D.$broadcast("loading:hide")})};return bt&&(0==bt.length?n.findAllEmployees().then(function(e){u(e)}):u({items:bt})),a.promise},clearAutoBookInt:function(){I.cancel($e)},getWithinZoneObj:function(e){var t,o=this,i=5e4;return ot[e].some(function(e){return"string"!=typeof e.lat&&o.is_in_zone(e.lat,e.lon,D.lat,D.lon)?(t=e,!0):void("string"==typeof e.lat&&o.arePointsNear({lat:D.lat,lon:D.lon},{lat:e.lat,lon:e.lon},e.radius)&&i>(dist=o.getGPSDistance(e.lat,e.lon,D.lat,D.lon))&&(i=dist,t=e))}),t},pickupCenterZone:function(e,t,o){var i=[];for(var r in ot){if(i.length>0&&o)break;(!o||o&&r==o)&&ot[r].forEach(function(o){Number(e).toFixed(4)==Number(o.lat).toFixed(4)&&Number(t).toFixed(4)==Number(o.lon).toFixed(4)&&i.push(o.id)})}return 0==i.length?!1:i},withinZone:function(e,t,o,i,r,n,a){if(!e||!ot[e])return!0;var s,u=this,l=5e4,d=o||D.lat,c=i||D.lon;return ot[e].some(function(e){if(!a||a==e.id){if("string"!=typeof e.lat&&u.is_in_zone(e.lat,e.lon,d,c)&&(!r||r&&u.is_in_zone(e.lat,e.lon,r,n)))return s=e;if("string"==typeof e.lat&&u.arePointsNear({lat:d,lon:c},{lat:e.lat,lon:e.lon},e.radius)&&(!r||r&&u.arePointsNear({lat:r,lon:n},{lat:e.lat,lon:e.lon},e.radius))){if(!t)return s=e;l>(dist=u.getGPSDistance(e.lat,e.lon,D.lat,D.lon))&&(l=dist,s=e)}}}),s},withinGreenZone:function(e,t,o,i,r){if(!e)return!0;var n=this,a=!1,s=o||D.lat,u=i||D.lon;return ot[e].some(function(e){return!r&&e.id==t||r==e.id==t?"string"!=typeof e.lat?a=!0:n.arePointsNear({lat:s,lon:u},{lat:e.lat,lon:e.lon},e.zone_radius)?a=e:!0:void 0}),a},updateSettings:function(e){e.id&&C.child(e.id+"/queue").orderByChild("timestamp").once("value",function(t){var o=t.ref().parent().key();t.forEach(function(t){var i=C.child(o+"/queue/"+t.key()+"/settings");i.update({allow_advance_reservation:e.allow_advance_reservation,allow_queue:e.allow_queue?"yes":"no",allow_remote_reservation:e.allow_remote_reservation,zone_based_queuing:e.zone_based_queuing,offer:e.offer,jail:e.jail},function(e){})})})},autoBookFunc:function(e){if(!this.isInitializingFB()&&D.listenedQueue){var t,o=this,i=[];Ot=o.getGPSDistance(D.oldlat,D.oldlon,D.lat,D.lon),dt.forEach(function(r){var n=rt[r],a=angular.copy(n);ot.hasOwnProperty(r)&&(n&&!e||!ft[r]||(n=rt[r]=o.withinZone(r,null,null,null,null,null,ft[r][window.localStorage.getItem("apikeypublic")].zone_id)),n&&n.lat&&("string"!=typeof n.lat&&o.is_in_zone(n.lat,n.lon,D.lat,D.lon)||"string"==typeof n.lat&&o.arePointsNear({lat:D.lat,lon:D.lon},{lat:n.lat,lon:n.lon},n.radius))?(t=r,o.setStoredZones(n,"inside",r)):(!D.detail||D.detail&&D.detail.zone_id!=r)&&((rt[r]=o.withinZone(r,!0))?(t=r,o.setStoredZones(rt[r],"inside",r)):o.isDispatcherAdmin(r)||D.offerDetail&&D.offerDetail.zone_id==r||o.setStoredZones(a,"outside",r))),!rt[r]&&ft[r]&&ft[r][window.localStorage.getItem("apikeypublic")].zone_id!=r&&(rt[r]=n,o.updateQueue(r,"remove")),i.indexOf(t)<0&&i.push(t),i.indexOf(r)<0&&i.push(r)}),i.forEach(function(e,t,i){(It||Ot>s.significantMiles)&&o.updateQueue(e,"update",null,null,i)}),!Se&&Ot>s.significantMilesGuest&&o.resetLatLon()}},withinRadiusZone:function(e,t,o,i){if(!e)return!0;var r=this,n=!1,a=t||D.lat,s=o||D.lon,u=bt[wt[e].groupPosition];return!u.settings||u.settings&&"yes"==u.settings.zone_based_queuing||bt[wt[e].position].tags.indexOf("Driver")<0?!0:(n=r.arePointsNear({lat:a,lon:s},{lat:u.settings.lat,lon:u.settings.lon},u.settings.radius),n||i||ot[e].some(function(e){return r.is_in_zone(e.lat,e.lon,a,s)?n=!0:void 0}),n)},isRadiusBased:function(e){var t=bt[wt[e].groupPosition];return t.settings&&"no"==t.settings.zone_based_queuing},autoBookIn:function(){$e=I(function(){},s.autoBookInterval)},getGPSDistance:function(e,t,o,i){var r=parseFloat(Math.PI*e/180),n=parseFloat(Math.PI*o/180),a=(parseFloat(Math.PI*t/180),parseFloat(Math.PI*i/180),t-i),s=Math.PI*a/180,u=Math.sin(r)*Math.sin(n)+Math.cos(r)*Math.cos(n)*Math.cos(s);return u=Math.acos(u),u=180*u/Math.PI,u=60*u*1.1515},arePointsNear:function(e,t,o){var i=4e4/360,r=Math.cos(Math.PI*t.lat/180)*i,n=Math.abs(t.lon-e.lon)*r,a=Math.abs(t.lat-e.lat)*i;return Math.sqrt(n*n+a*a)<=1.609344*o},getGroupZone:function(e,t,o,i){var r,n=[],a=[],s=[],u=[];if("string"==typeof e||Object.getPrototypeOf(e)===Object.prototype){"all"!=e&&n.indexOf("group_id[]="+e.category_id)<0&&n.push("group_id[]="+e.category_id);for(var l in wt)l==wt[l].category_id&&(r=this.withinZone(wt[l].category_id,!0),o&&(!o||bt[wt[l].groupPosition].limit)||t&&!(t&&wt[l].can_bookin&&(this.isDispatcherAdmin(l)||this.hasServType(wt[l].tags)&&this.hasRatePlanServ(wt[l].category_id,wt[l].tags)&&(i||r||!bt[wt[l].groupPosition].my_tags||bt[wt[l].groupPosition].my_tags.indexOf("Driver")<0)&&(!bt[wt[l].groupPosition].require_upload||bt[wt[l].groupPosition].require_upload&&D.vehiclePermit)&&bt[wt[l].groupPosition].allow_queue&&(bt[wt[l].position].tags.indexOf("Driver")>-1||bt[wt[l].position].tags.indexOf("Admin")>-1||bt[wt[l].position].tags.indexOf("Dispatcher")>-1)))||(r=r||{id:wt[l].category_id}||ot[wt[l].category_id]&&ot[wt[l].category_id][0],r&&("all"==e?1!=r&&(o||t&&dt.indexOf(wt[l].category_id)<0||!t&&dt.indexOf(wt[l].category_id)>-1)&&(wt[l].can_bookin>0&&1==bt[wt[l].position].active&&n.indexOf("group_id[]="+wt[l].category_id)<0&&n.push("group_id[]="+wt[l].category_id),s.push("item_id[]="+wt[l].item_id),a.push("zone_id["+wt[l].category_id+"]="+r.id),u.push(wt[l].zone)):e.category_id==wt[l].category_id&&(s.push("item_id[]="+wt[l].item_id),a.push("zone_id["+wt[l].category_id+"]="+r.id),u.push(wt[l].zone)))))}else dt.forEach(function(e,t){wt.hasOwnProperty(e)&&(n.push("group_id[]="+wt[e].category_id),s.push("item_id[]="+wt[e].item_id),a.push("zone_id[]="+wt[e].category_id))});return{group:n,zoneId:a,item:s,zone:u}},addContacts:function(e){var t=T.defer(),o=M+"refer/?"+e.join("&")+"&"+a.getParams();return x.get(o).success(function(e,o){t.resolve(e)}).error(function(e){t.reject(e)}),t.promise},complaint:function(e){var t=T.defer(),o=M+"help/?subject="+e.subject+"&deptid="+e.deptid+"&priority="+e.priority+"&message="+e.message+"&"+a.getParams();return x.get(o).success(function(e,o){t.resolve(e)}).error(function(e){t.reject(e)}),t.promise},dispatcherBook:function(e,t){var o=this,i=T.defer();Oe=!0;var r=1==t?"bookin":"bookout",n=M+r+"/?apikeypublic="+e.apikeypublic+"&group_id[]="+e.category_id+"&zone_id[]="+e.zone_id+"&item_id[]="+e.item_id+"&uuid="+ionic.Platform.device().uuid+"&lat="+e.lat+"&lon="+e.lng;return x.get(n).success(function(e,t){o.processFirebase(),i.resolve(e)}).error(function(e){i.reject(e)}),i.promise},deleteDispatcherItem:function(e){var t=this,o=T.defer();return x.get(M+"deleteItem/?apikeypublic="+window.localStorage.getItem("apikeypublic")+"&item_id="+e.item_id+"&group_id="+e.category_id+a.getParams()).success(function(e,i){o.resolve(e),t.processFirebase()}).error(function(e){o.reject(e)}),o.promise},addDispatcherItem:function(e){var t=this,o=T.defer(),i=M+"addItem/?item_id=0&group_id="+e.category_id+"&name="+e.name+"&email="+e.email+"&cellPhone="+e.cellPhone+"&active="+e.active+"&itemType[]="+e.itemType+"&"+a.getAutoLoginParams();return void 0!=e.password&&(i+="&password="+e.password),x.get(i).success(function(e,i){o.resolve(e),t.processFirebase()}).error(function(e){o.reject(e)}),o.promise},editDispatcherItem:function(e){var t=this,o=T.defer(),i=M+"editItem/?item_id="+e.item_id+"&group_id="+e.category_id+"&name="+e.firstName+" "+e.lastName+"&email="+e.email+"&cellPhone="+e.cellPhone+"&active="+e.active+"&"+a.getAutoLoginParams();return e.itemType&&(i+="&itemType[]="+e.itemType),e.itemTypeOld&&(i+="&itemTypeOld[]="+e.itemTypeOld),x.get(i).success(function(e,i){o.resolve(e),t.processFirebase()}).error(function(e){o.reject(e)}),o.promise},quoteDispatcher:function(e){function t(e,t){t=t&&t.toLowerCase();for(var o="",i=0,r="a"==t?10:0,n="n"==t?10:62;i++<e;){var a=Math.random()*(n-r)+r<<0;o+=String.fromCharCode(a+=a>9?36>a?55:61:48)}return o}var o=this,i=T.defer();this.setQuoteDateTime(e);var r=M+"quote/?"+a.getParams()+"&"+e.items.join("&")+"&group_id[]="+e.group_id+"&_token="+t(40)+("&tripfrequency=oneway&"+e.splitFare.join("&")+'&sent_to_message=""&eta_distance[]='+e.estDistVal+"&eta_time[]="+e.estTimeVal+"&pickup[]="+e.pickup.formatted_address+"&pickup_lat[]="+e.pickup.lat+"&pickup_lon[]="+e.pickup.lon+"&dropoff[]="+e.dropoff.formatted_address+"&dropoff_lat[]="+e.dropoff.lat+"&dropoff_lon[]="+e.dropoff.lon+"&route_distance[]="+e.distance+"&selectDate[]="+e.date+"&selectTime[]="+e.time+"&selectPeople[]="+e.people+"&note[]="+e.note+"&selectPrice[]="+(e.price||s.defaultPrice)+"&selectService[]="+e.service+"&qmode="+(e.mode||D.dispatcherQMode)+"&mode=route&status=").replace(/ /g,"+").replace(/,/g,"%2C").replace(/[[]/g,"%5B0").replace(/[\]]/g,"%5D").replace(":","%3A").replace(/\//g,"%2F");return e.pickup_type&&(r+="&pickup_type_name="+e.pickup_type_name+"&dropoff_type_name="+e.dropoff_type_name+"&pickup_type="+e.pickup_type+"&dropoff_type="+e.dropoff_type+"&post_expire="+e.post_expire),x.get(r).success(function(e,t){i.resolve(e),o.processFirebase()}).error(function(e){i.reject(e)}),i.promise},bookIn:function(e,t){var o=this,i=this.getGroupZone(e,!0,t),r=i.group,n=i.zoneId,s=i.item,u=T.defer();if(0==r.length)return u.reject(),u.promise;Oe=!0;var d=M+"bookin/?"+r.join("&")+"&"+n.join("&")+"&"+s.join("&")+"&vehicle="+f.vehicle+"&license="+f.permit+"&"+a.getParams();return D.bookingIn.length=0,0!=r.length&&r.forEach(function(e){var t=e.match(/=(.+)/)[1];bt[wt[t].position];if(dt.indexOf(t)<0&&!bt[wt[t].groupPosition].limit&&bt[wt[t].position].category_id==t){D.bookingIn.indexOf(t)<0&&(D.bookingIn.push(t),L=!0),C.child(t+"/queue").orderByChild("timestamp").on("child_added",o.zoneAdded)}}),x.get(d).success(function(e,t){o.setAllBookedStatus(),Oe=!1,u.resolve(e),e.items.forEach(function(e){e.hasOwnProperty("can_bookin")?o.setGroups():(bt[wt[e.category_id].position].zone_id!=e.zone_id&&(bt[wt[e.category_id].position].zone_id=e.zone_id,bt[wt[e.category_id].groupPosition].zone_id=e.zone_id,o.setGroups()),o.setFbBidMode(e.category_id,bt[wt[e.category_id].groupPosition].mode))}),0==D.bookingIn.length&&D.$broadcast("loading:hide"),o.processFirebase()}).error(function(e){u.reject(e),D.$broadcast("loading:hide"),l(["SOMETHING_WRONG","FAILED"]).then(function(e){O.alert({title:e.FAILED,template:e.SOMETHING_WRONG})})}),u.promise},bookOut:function(e,t){var o=this,i=this.getGroupZone(e,!1,t),r=i.group,n=i.zoneId,s=i.item,u=T.defer(),d=M+"bookout/?"+r.join("&")+"&"+n.join("&")+"&"+s.join("&")+"&"+a.getParams();dt.slice(0);return r.forEach(function(e,t){var o=e.match(/=(.+)/)[1];dt.indexOf(o)>-1&&D.bookingOut.push(o)}),x.get(d).success(function(t,i){o.changeGroupStatus(e,-2),u.resolve(t)}).error(function(e){u.reject(e),D.$broadcast("loading:hide"),l(["SOMETHING_WRONG","FAILED"]).then(function(e){O.alert({title:e.FAILED,template:e.SOMETHING_WRONG})})}),u.promise},quote:function(e,t,o){for(var i=this,r=[],n=[],s=[],u=[],l=0;l<e.length;l++){var d=wt[e[l].zone_id]||wt[e[l].group_id];if(-1==s.indexOf("group_id[]="+d.category_id)&&s.push("group_id[]="+d.category_id),-1==n.indexOf("zone_id[]="+e[l].group_id)&&n.push("zone_id[]="+e[l].group_id),r.push("quote_id[]="+e[l].id),3==t&&e[l].enabled&&we.hasOwnProperty([e[l].id])){if(we[e[l].id].quote)var d=we[e[l].id].quote;else var d=we[e[l].id].offer;u.push("offer_to_not[]="+d)}}var c=T.defer();if(-3==t)var f=M+"quote/?"+s.join("&")+"&"+n.join("&")+"&"+r.join("&")+'&reply_to_message=""&status='+t;else var f=M+"quote/?"+s.join("&")+"&"+n.join("&")+"&"+r.join("&")+'&reply_to_message=""&status='+t+"&"+u.join("&");if(f+="&"+a.getParams(),void 0!=o)f+="&"+o.join("&"),x.get(f).success(function(e){3==t&&r.forEach(function(e,t){e.replace("quote_id[]=","")}),c.resolve(e)}).error(function(e){c.reject(e),-3==t&&(i.removeModalPopup(D,"quote_modal"),i.quoteModalCleanUp())});else{var p=!0,m=[];e.forEach(function(e){var o=!1,r=e.group_id,n=e.id;m.push(n);var a=C.child(r+"/inbox/"+n),s={lat:D.lat,lon:D.lon,update_time:moment.utc().format("MM/DD/YYYY HH:mm:ss")};if(-3==t){i.getOfferNotId(r,n,!0)&&(o=!0,m.splice(m.indexOf(n),1));var u="offer_to_not";s[u]=window.localStorage.getItem("apikeypublic"),s.status="quoteshown"}else{i.getOfferId(r,n,!0)&&(o=!0,m.splice(m.indexOf(n),1));var u="offer_to";s[u]=window.localStorage.getItem("apikeypublic")}if(o)0==m.length&&c.resolve();else{var l=a.child(u).push(),d=l.key(),f={};f[u+"/"+d]=s,function(e,o){a.update(f,function(r){if(r)p=!1;else if(3==t){var n=i.getOfferNotId(e,o,!0);n&&a.transaction(function(e){return e&&e.offer_to_not?(1==Object.keys(e.offer_to_not).length?e.offer_to_not="":delete e.offer_to_not[n.key],e):void 0},function(e,t,i){e?p=!1:t&&(m.splice(m.indexOf(o),1),0==m.length&&p&&c.resolve())})}})}(r,n)}}),p?-3==t&&c.resolve():(c.reject(),-3==t&&(i.removeModalPopup(D,"quote_modal"),i.quoteModalCleanUp()))}return c.promise},deleteInbox:function(e){for(var t=this,o=[],i=[],r=[],n=[],s=0;s<e.length;s++){var u=ye[e[s].zone_id]&&ye[e[s].zone_id][e[s].quote_id]&&ye[e[s].zone_id][e[s].quote_id].route;-1==i.indexOf("zone_id[]="+e[s].zone_id)&&i.push("zone_id[]="+e[s].zone_id),-1==o.indexOf("quote_id[]="+e[s].quote_id)&&o.push("quote_id[]="+e[s].quote_id),u&&(u.invoiceid&&-1==r.indexOf("invoiceid[]="+u.invoiceid)&&r.push("invoiceid[]="+u.invoiceid),-1==n.indexOf("quoteid[]="+u.whmcs)&&n.push("quoteid[]="+u.whmcs))}var l=T.defer(),d=function(){var e=M+"deleteInbox/?"+i.join("&")+"&"+o.join("&")+"&"+a.getParams();x.get(e,{data:{show:!1}}).success(function(e){l.resolve(e)}).error(function(e){l.reject(e)})};return r.length>0?t.cancelOrder(r,n).then(function(){d()},function(e){l.reject(e)}):t.cancelQuote(n).then(function(){d()},function(e){l.reject(e)}),l.promise},order:function(e){var t=T.defer();return x.get(M+"order/?quoteID="+window.localStorage.getItem("quote_Id")+"&paymentMethod="+e.paymentMethod+"&rate_id="+e.rate_id+"&price="+e.price+"&id="+e.id+"&tip="+e.tip+"&stripeToken="+e.token+"&"+e.opts.join("&")+"&"+e.optIn.join("&")+"&mode=order&app_id="+Tt+"&"+a.getParams()).success(function(e,o){t.resolve(e),window.localStorage.removeItem("quote_Id")}).error(function(e){t.reject(e)}),t.promise},orders:function(){var e=T.defer();return x.get(M+"orders/?"+a.getParams()).success(function(t,o){"Failed"!=t.status?e.resolve(t):e.reject(t)}).error(function(t){e.reject(t)}),e.promise},offer:function(e,t,o,i,r,n,s,u){var l=this,d=this.getGroupZone(e,!0,null,!0),c=d.group,f=(d.zoneId,d.item,T.defer()),p=[];dt.forEach(function(e){p.push("zone_id[]="+e)}),void 0!=u&&p.unshift(p.splice(p.indexOf("zone_id[]="+u),1)[0]);var m={};if(-4==i)var g=M+"offer/?"+c.join("&")+"&"+p.join("&")+"&quote_id[]="+t+"&offer_to="+o+'&reply_to_message=""&status='+i+"&reason="+r;else{var g=M+"offer/?"+c.join("&")+"&"+p.join("&")+"&eta_distance[]="+n+"&eta_time[]="+s+"&quote_id[]="+t+"&offer_to_not="+o+'&reply_to_message=""&status='+i,_=T.defer(),h=l.getOfferTime(D.offerDetail.zone_id,window.localStorage.getItem("apikeypublic")),v=h-moment(l.getServerTime()).diff(moment.utc(l.getOfferNotId(D.offerDetail.zone_id,D.offerDetail.id).update_time,"MM/DD/YYYY HH:mm:ss"),"seconds");P(function(){_.resolve()},1e3*v+1e4)}return g+="&"+a.getParams(),x.get(g,m).success(function(e){if(f.resolve(e),-4==i){var t=C.child(u+"/queue/"+window.localStorage.getItem("apikeypublic"));t.update({lat:D.lat,lon:D.lon,update_time:moment(new Date).add(_t,"minutes").subtract(Mt,"hours").format("MM/DD/YYYY HH:mm:ss")},function(e){})}})["catch"](function(e,t,o,i){f.reject(e)}),f.promise},profile:function(e,t){var o=T.defer(),i=M+"user/?"+a.getParams(null,null,!0);return i+=e?"&apikeypublic="+e:"&email="+t,x.get(i).success(function(e){o.resolve(e)}).error(function(e){o.reject(e)}),o.promise},cancelQuote:function(e){var t=T.defer();return x.get(M+"cancelQuote/?"+e.join("&")+"&"+a.getParams()).success(function(e){t.resolve(e)}).error(function(e){t.reject(e)}),t.promise},cancelOrder:function(e,t){var o=T.defer();return x.get(M+"cancelOrder/?"+e+"&"+t.join("&")+"&"+a.getParams()).success(function(e){o.resolve(e)}).error(function(e){o.reject(e)}),o.promise},map:function(t){var o=T.defer(),i=T.defer();if("fetch"==t.action)var r=M+"geo/?action=fetch&"+a.getParams();else var r=M+"geo/?map_id="+t.map_id+"&action="+t.action+"&"+a.getParams();t.group_id&&(r+="&"+t.group_id.join("&")),t.description&&(r+="&description="+t.description),t.zone_id&&(r+="view"==t.action?"&zone_id=all":"&type="+t.type+"&zone_id="+t.zone_id+"&"+t.lat.join("&")+"&"+t.lon.join("&")+"&zone_title="+t.zone_title+"&zone_description="+t.zone_description),t.radius&&(r+="&radius="+t.radius+"&zone_radius="+t.zone_radius),t.title&&(r+="&title="+t.title),t.center&&(r+="&center="+t.center),t.zoom&&(r+="&zoom="+t.zoom),t.color&&(r+="&color="+t.color);x.get(r,{timeout:o.promise}).success(function(e){i.resolve(e)}).error(function(e){i.reject(e)})["finally"](function(){e.remove(r)});return e.add({url:r,abortpromise:o,deferred:i}),i.promise},trip:function(e,t){var o,i=this;-5==e.status?o=["CANCELLING","TRIP"]:0==e.status&&(o=["SENDING","MESSAGE"]),-5==e.status&&wt[e.zone_id]&&bt[wt[e.zone_id].groupPosition].booked&&bt[wt[e.zone_id].groupPosition].limit&&i.toggleBook(!1,bt[wt[e.zone_id].groupPosition].id);void 0==t?window.localStorage.getItem("apikeypublic"):t.apikeypublic,void 0==t?D.lat:t.lat,void 0==t?D.lon:t.lng;D.$broadcast("loading:show",{text:o});var r=T.defer();if(void 0===e.msg)var n=M+"trip/?status="+e.status+"&quote_id[]="+e.quote_id+"&zone_id[]="+e.zone_id+'&reply_to_message=""&tripID='+e.tripID;else{if(e.isDriver)var n=M+"trip/?status="+e.status+"&quote_id[]="+e.quote_id+"&zone_id[]="+e.zone_id+"&tripID="+e.tripID+'&reply_to_message=""&message='+e.msg;else var n=M+"trip/?status="+e.status+"&quote_id[]="+e.quote_id+"&zone_id[]="+e.zone_id+"&tripID="+e.tripID+'&sent_to_message=""&message='+e.msg;if(9==e.status)if(e.isDriver)var n=M+"trip/?status="+e.status+"&quote_id[]="+e.quote_id+"&zone_id[]="+e.zone_id+"&tripID="+e.tripID+'&reply_to_message=""&'+e.msg.join("&");else var n=M+"trip/?status="+e.status+"&quote_id[]="+e.quote_id+"&zone_id[]="+e.zone_id+"&tripID="+e.tripID+'&sent_to_message=""&'+e.msg.join("&");if(""==e.tripID){for(var s=[],u=[],l=0;l<e.inbox.length;l++)-1==u.indexOf("zone_id[]="+e.inbox[l].zone_id)&&u.push("zone_id[]="+e.inbox[l].zone_id),-1==s.indexOf("quote_id[]="+e.inbox[l].quote_id)&&s.push("quote_id[]="+e.inbox[l].quote_id);var n=M+"trip/?status="+e.status+"&"+s.join("&")+"&"+u.join("&")+"&tripID="+e.tripID+'&sent_to_message=""&message='+e.msg}}n+="&"+a.getParams();var d,c;if(5==e.status?(d="arrived",c="Arrived"):6==e.status?(d="load",c=e.message):7==e.status&&(d="unload",c=e.message),d){var p=+Object.keys(ye[e.zone_id][e.quote_id].route.reply_to_message)[Object.keys(ye[e.zone_id][e.quote_id].route.reply_to_message).length-1],m=angular.copy(ye[e.zone_id][e.quote_id].route.reply_to_message);m[p+1]={lat:D.lat,lon:D.lon,message:c||"",status:d,update_time:moment.utc().format("MM/DD/YYYY HH:mm:ss")},C.child(e.zone_id+"/inbox/"+e.quote_id+"/route/reply_to_message").update(m,function(t){t||(C.child(e.zone_id+"/inbox/"+e.quote_id+"/route/status").set(d),
r.resolve()),r.reject(t)}),"unload"==d&&f.tripPath[e.tripID]&&C.child(e.zone_id+"/inbox/"+e.quote_id+"/route/path").update(f.tripPath[e.tripID],function(e){})}else{var g=function(){x.get(n).success(function(t){-5==e.status?i.deleteInbox(e.inbox).then(function(){r.resolve(t)},function(e){}):r.resolve(t)}).error(function(e){r.reject(e)})};if(-5==e.status){var _=[],h=[];e.inbox.forEach(function(t){var o=e.tripID?t.id:t.quote_id,i=ye[t.zone_id][o].route;i.hasOwnProperty("invoiceid")&&i.invoiceid?(_.push("invoiceid[]="+i.invoiceid),h.push("quoteid[]="+i.whmcs)):h.push("quoteid[]="+i.whmcs)}),_.length>0?i.cancelOrder(_,h).then(function(){g()},function(e){r.reject(err)}):i.cancelQuote(h).then(function(){g()},function(e){r.reject(err)})}else g()}return r.promise},setTripDist:function(e){tripDist=e},getRating:function(e,t){var o={},i={},r={},n={},a=pick_up=drop_off=!0,s=ye[e][t].route,u=ye[e][t].route.reply_to_message;u.forEach(function(e,t){"accept"==e.status?(o.time=moment(e.update_time,"MM/DD/YYYY HH:mm:ss"),o.lat=e.lat,o.lon=e.lon):"arrived"==e.status?(i.time=moment(e.update_time,"MM/DD/YYYY HH:mm:ss"),i.lat=e.lat,i.lon=e.lon):"load"==e.status?(r.time=moment(e.update_time,"MM/DD/YYYY HH:mm:ss"),r.lat=e.lat,r.lon=e.lon,e.message&&(a=!(e.message.indexOf("time")>-1),pick_up=!(e.message.indexOf("address")>-1))):"unload"==e.status&&(n.time=moment(e.update_time,"MM/DD/YYYY HH:mm:ss"),n.lat=e.lat,n.lon=e.lon,dropoff=!e.message)});var l=parseInt(s.eta_distance/s.eta_time),d=moment.duration(i.time.diff(o.time)).asHours(),c=0==Math.abs(moment.duration(n.time.diff(r.time))/1e3)?1:Math.abs(moment.duration(n.time.diff(r.time))/1e3),f=0,p=s.path;if(p)for(var m=0;m<Object.keys(p).length;m++)p[m+1]&&(f+=this.getGPSDistance(+p[m].lat,+p[m].lon,+p[m+1].lat,+p[m+1].lon));var g=d<parseFloat(u[1].eta_time)+5||d==parseFloat(u[1].eta_time)+5,_=f<parseFloat(s.eta_distance)+5||f==parseFloat(s.eta_distance)+5,h=3600*f/c,v=h<parseFloat(l)+5||h==parseFloat(l)+5;return{time:g,speed:v,distance:_,ontime:a,pickup:pick_up,dropoff:drop_off}},getBookedItemByZone:function(e){for(var t,o=0;o<bt.length;o++)if(0==bt[o].dispatcher&&bt[o].zone_id==e&&bt[o].apikeypublic==window.localStorage.getItem("apikeypublic")){t=bt[o];break}if(void 0!==t)for(var o=0;o<bt.length;o++)if(bt[o].dispatcher>0&&bt[o].category_id==t.category_id&&bt[o].booked)return t},getGroupItem:function(e){for(var t=0;t<bt.length;t++)if(bt[t].dispatcher>0&&bt[t].category_id==e)return bt[t]},setOfferNotId:function(e,t){var o=ye[t][e].offer_to_not;for(var i in o)""!=o[i]&&o[i].offer_to_not==window.localStorage.getItem("apikeypublic")&&(D.offerNotId=i)},setOfferId:function(e,t){var o=ye[t][e].offer_to;for(var i in o)""!=o[i]&&o[i].offer_to==window.localStorage.getItem("apikeypublic")&&(D.offerId=i)},getAllQuoteIds:function(){var e=[];for(var t in ye)for(var o in ye[t])e.push("quote_id[]="+o);return e},getZoneFromQuoteId:function(e){for(var t in ye)for(var o in ye[t])if(o==e)return t},getInboxData:function(e,t){return ye[e][t].route},getFBData:function(){return ye},getFbBookedState:function(){return dt},addNotification:function(e){if(ionic.Platform.isWebView()){var t="Default Msg";"quote"==e?t="New Quote has arrived!":"offer"==e?t="Offer Accepted!":"rate"==e?t="Quote Accepted!":"message"==e?t="A New Message has Arrived!":"cancelled"==e?t="Trip Cancelled!":"arrived"==e&&(t="Driver has arrived!"),p.ready(function(){}),y.vibrate(500)}},ringTone:function(e){var t=e||0,o=0,i=function(){(t>o||-1==t)&&(this.currentTime=0,this.play(),o++)};if(ke)ke=!1,ionic.Platform.isAndroid()||(document.getElementById("ringtone").pause(),document.getElementById("ringtone").removeEventListener("ended",i));else if(ke=!0,ionic.Platform.isAndroid())if(-1==e){k.beep();var r=I(function(){ke?k.beep():I.cancel(r)},2e3);r()}else k.beep(t);else document.getElementById("ringtone").currentTime=0,document.getElementById("ringtone").play(),document.getElementById("ringtone").addEventListener("ended",i,!1)},showTripPage:function(){It||(D.detail=f.tripDetail,w.fromTemplateUrl("modals/trip-detail.html",{backdropClickToClose:!1,hardwareBackButtonClose:!1}).then(function(e){It||(It=!0,D.tripModal=e,e.show())}))},withinExpiryTime:function(e){var t=this,o=e.offer_to,i=moment(t.getServerTime()).diff(moment.utc(o[Object.keys(o)[0]].update_time,"MM/DD/YYYY HH:mm:ss")),r=moment.duration(i),n=r.asMinutes(),a=parseInt(moment().add(s.quoteExpiry,"minutes").subtract(r.as("milliseconds")).format("x")),a=parseInt(60*s.quoteExpiry-i/1e3);return n<s.quoteExpiry&&null!=f.quoteID&&f.quoteID.indexOf(e.route.quote_id)<0&&("quote"==e.route.mode?(D.showCountDown=!0,D.orderCountDown=a):(D.showInnerCountDown=!0,D.innerCountDown=a)),D.countDownEnded=function(){t.orderModalCleanUp()},D.quoteExpiry=60*s.quoteExpiry,n<s.quoteExpiry},getQuoteTimeOut:function(e){var t;for(var o in ye)for(var i in ye[o])if(e==ye[o][i].route.quote_id){var r=ye[o][i].offer_to_not;for(var n in r)(void 0==t||moment(t).isAfter(moment(new Date(r[n].update_time))))&&(t=moment(new Date(r[n].update_time)))}var a=moment().add(s.driverQuoteExpiry,"minutes").subtract(moment().add(_t,"minutes").diff(t.add(5,"hours")));return a},getQuoteUpdateTime:function(e){var t=e.offer_to_not;for(var o in t)if(""!=t[o]&&t[o].offer_to_not==window.localStorage.getItem("apikeypublic"))var i=t[o].update_time;return i},withinQuoteExpiryTime:function(e){var t=this,o=this.getQuoteUpdateTime(e);if(void 0==o)return!0;var i=moment.duration(moment(t.getServerTime()).diff(moment.utc(o,"MM/DD/YYYY HH:mm:ss"))),r=i.asMinutes();return r<s.driverQuoteExpiry},setQuoteCountDown:function(e){var t=this,o=this.getQuoteUpdateTime(e);if(void 0==o)var i=60*s.driverQuoteExpiry;else var r=moment().add(_t,"minutes"),n=moment(new Date(o)).add(Mt,"hours"),i=parseInt(n.add(s.driverQuoteExpiry,"minutes").diff(r)/1e3),a=moment(t.getServerTime()).diff(moment.utc(o,"MM/DD/YYYY HH:mm:ss"),"seconds"),i=parseInt(60*s.driverQuoteExpiry-a);D.quoteCountDown=i,D.driverQuoteExpiry=60*s.driverQuoteExpiry,D.showQuoteCountDown=!0,D.quoteCountDownEnded=function(){He=!0,t.quoteModalCleanUp()}},withinOfferTime:function(e){var t=this;if(void 0==e.offer_to||""==e.offer_to||""==e.offer_to_not)return!0;if(""!=e.offer_to_not)var o=e.offer_to_not;else if(""!=e.offer_to)var o=e.offer_to;var i=(Object.keys(o).length,o),r=i[Object.keys(i)[Object.keys(i).length-1]],n=t.getOfferTime(e.route.zone_id,r.offer_to_not);return moment(t.getServerTime()).diff(moment.utc(r.update_time,"MM/DD/YYYY HH:mm:ss"),"seconds")<n+s.offerNextDriverDelay/1e3+20},hasShownOffer:function(e,t){var o,i,r;return(obj=this.getOfferNotId(e,t))&&(i=obj.key,o=ye[e][t].offer_to_not[i],r=this.getOfferTime(e,window.localStorage.getItem("apikeypublic"))),o&&we[t]&&(!o.status||o.status&&"quoteshown"!=o.status&&"offerdeclined"!=o.status)&&moment(this.getServerTime()).diff(moment.utc(o.update_time,"MM/DD/YYYY HH:mm:ss"),"seconds")<r&&r-moment(this.getServerTime()).diff(moment.utc(o.update_time,"MM/DD/YYYY HH:mm:ss"),"seconds")},getOfferTime:function(e,t){return t?pt[t]&&pt[t][e]&&pt[t][e].settings&&pt[t][e].settings.offer||D.offerTime:D.offerTime},quoteModalCleanUp:function(){var e=this;He=!0,ie=!1,D.quoteDetail=null,D.quotes.length=0,this.removeModalPopup(D,"quote_modal"),this.removeModalPopup(D,"popoverQuote"),this.removeModalPopup(D,"cancelTripModal"),ke&&this.ringTone(),D.quoteCountDown=null,D.$broadcast("loading:hide"),P(function(){He=!1,e.processFirebase()},5e3),V&&V(),H&&H()},countDownTimer:function(){null==Ue&&(D.$on("timer-tick",function(e,t){t.millis>0&&void 0==D.innerCountDown&&void 0!=D.orderModal&&null!=D.orderModal&&(D.innerCountDown=t.millis/1e3,D.showInnerCountDown=!0)}),Ue=I(function(){},1e3))},clearCountDown:function(){null!=Ue&&(I.cancel(Ue),Ue=null)},offerTime:function(e){var t=this;e.selectDate+e.selectTime;var o=moment.duration(moment(t.getServerTime()).diff(moment.utc(sent_to_message[0].update_time,"MM/DD/YYYY HH:mm:ss"))),i=(o.asMinutes(),o.asMilliseconds());return D.orderCountDown=i,!0},setOrderExpiry:function(){D.orderCountDown=moment().countdown("1982-5-25",countdown.MONTHS|countdown.WEEKS,NaN,2).toString(),re&&this.orderModalCleanUp()},countDownEnded:function(){this.orderModalCleanUp()},orderModalCleanUp:function(){var e=this;D.innerCountDown=void 0,D.showInnerCountDown=!1,D.showCountDown=!1,ke&&this.ringTone(),this.clearCountDown(),D.rates.forEach(function(e){zt.push(e.id)}),D.rates.length=0,this.removeModalPopup(D,"priceModal"),this.removeModalPopup(D,"orderModal"),this.removeModalPopup(D,"popoverPrice"),this.removeModalPopup(D,"cancelTripModal"),U&&(U(),U=null),D.selectedRate=null,yt=!1,re=!1,D.rateNotSelected=!0,P(function(){e.processFirebase()},2e3)},removeModalPopup:function(e,t){e&&1!=e[t]&&null!=e[t]&&e[t].remove().then(function(){e[t]&&(e[t]=null)})},quoteCheck:function(e){var t=this,o=[],i=[],r=[],n=e.route;if(n.itemsArr&&n.zoneArr.forEach(function(e){if(ft[e]){var i=[];for(var a in ft[e]){var s=pt[a][e];s.tags.indexOf(n.selectService)>-1&&("offer"==n.mode||n.mode==s.mode)&&(""==s.quote_id||"Offered"==s.quote_id||"disconnected"==s.quote_id&&moment(t.getServerTime()).diff(moment(s.disconnectTime),"seconds")<z)&&i.push(a)}if(0==i.length){r.push(e);var u=t.inboxesWithQuoteId(null,n.quote_id,e);o=0==o.length?u:o.concat(u)}}else{r.push(e);var u=t.inboxesWithQuoteId(null,n.quote_id,e);o=0==o.length?u:o.concat(u)}}),o.length>0&&r.length==n.zoneArr.length)return o;if(""==e.offer_to_not||""!=e.offer_to){if(""==e.offer_to_not&&""==e.offer_to){var a=moment(t.getServerTime()),u=moment.utc(n.update_time,"MM/DD/YYYY HH:mm:ss");return a.diff(u,"minutes")+.2>s.driverQuoteExpiry&&n.zoneArr.forEach(function(e){if(ft[e]){r.push(e);var i=t.inboxesWithQuoteId(null,n.quote_id,e);o=0==o.length?i:o.concat(i)}else{r.push(e);var i=t.inboxesWithQuoteId(null,n.quote_id,e);o=0==o.length?i:o.concat(i)}}),o.length>0?o:!1}return!1}for(var l in e.offer_to_not){var d=e.offer_to_not[l].update_time,c=moment.duration(moment(t.getServerTime()).diff(moment.utc(d,"MM/DD/YYYY HH:mm:ss"))),f=c.asMinutes();if("quotecancelled"!=e.offer_to_not[l].status&&f<s.driverQuoteExpiry)return!1;i.indexOf(e.offer_to_not[l].inbox_id)<0&&(i.push(e.offer_to_not[l].inbox_id),o.push({quote_id:e.offer_to_not[l].inbox_id,zone_id:e.offer_to_not[l].group_id}))}return o},mergedInboxObj:function(e){var t;T.defer();for(var o in ye)for(var i in ye[o])if(ye[o][i].route.quote_id==e.route.quote_id){t||(t=angular.copy(ye[o][i])),t.route.zoneArr?t.route.zoneArr.indexOf(o)<0&&t.route.zoneArr.push(o):t.route.zoneArr=[o],t.route.inboxArr?t.route.inboxArr.indexOf(i)<0&&t.route.inboxArr.push(i):t.route.inboxArr=[i];var r=ye[o][i];""!=r.offer_to&&(t.offer_to=$.extend(!0,t.offer_to,r.offer_to)),""!=r.offer_to_not&&(t.offer_to_not=$.extend(!0,t.offer_to_not,r.offer_to_not))}return t},areAllDriversQuoted:function(e){var t=this,o=T.defer();return o.resolve(t.quoteCheck(e)),o.promise},allDriversQuoted:function(e,t){if(void 0!=e){var o=this,i=o.mergedInboxObj(ye[e][t]),r=i.route.quote_id;o.areAllDriversQuoted(i).then(function(e){e&&o.updateQuoteStatus(e).then(function(){le.splice(le.indexOf(r)),o.processFirebase(),I.cancel(de[r])},function(){le.splice(le.indexOf(r)),o.processFirebase(),I.cancel(de[r])})}),de.hasOwnProperty(r)||(de[r]=I(function(){ye.hasOwnProperty(e)&&ye[e].hasOwnProperty(t)&&"quote"==ye[e][t].route.status?(o.quoteShownTimeout(ye[e][t]),o.allDriversQuoted(e,t)):I.cancel(de[r])},1e4))}},updateQuoteStatus:function(e){var t=T.defer();return this.deleteInbox(e).then(function(){t.resolve()},function(e){t.reject(e)}),t.promise},quoteShownTimeout:function(e){var t=this,o=function(e){ce.hasOwnProperty(e.route.quote_id)&&P.cancel(ce[e.route.quote_id]),ce[e.route.quote_id]=P(function(){"quote"==e.route.status&&t.allDriversQuoted(e.zone_id,e.id)},15e3+t.lastQuoteDriverTime(e))};o(e)},lastQuoteDriverTime:function(e){var t=this,o=1e5,i=moment(t.getServerTime());if(""!=e.offer_to_not&&""==e.offer_to)for(var r in e.offer_to_not){var n=e.offer_to_not[r].update_time,a=moment.utc(n,"MM/DD/YYYY HH:mm:ss"),u=parseInt(a.add(s.driverQuoteExpiry,"minutes").diff(i));1e5==o?o=u:u>o&&(o=u)}return o},isViewing:function(e){return void 0==D[e]?!1:1==D[e]||D[e].isShown()?!0:void 0},getDriverDetail:function(e,t){var o=T.defer();return ft.hasOwnProperty(e)&&ft[e].hasOwnProperty(t)?o.resolve(ft[e][t]):C.child(e+"/queue/"+t).once("value",function(e){e.exists()&&o.resolve(e.val())}),o.promise},toastMsg:function(e,t,o){var i=this;i.ringTone(),P(function(){ke&&i.ringTone()},3e3),i.addNotification("cancelled"),l(t).then(function(o){"TRIP_CANCEL"==t?u.error(e,o):u.info(e,o)}),o&&i.setMsgRead(o)},setMsgRead:function(e){var t=e.routeItem;C.child(t.zone_id+"/inbox/"+t.id+"/route/"+e.node+"/"+e.index).update({read:1},function(o){o||window.localStorage.removeItem("replyMsgIndex",e.index);var i=F.indexOf(t.id);i>-1&&F.splice(i,1)})},reBookIn:function(e){var t=this,o=e.sent_to==window.localStorage.getItem("apikeypublic");if(o&&(!ft.hasOwnProperty(e.zone_id)||!ft[e.zone_id].hasOwnProperty(e.sent_to))){var i=bt[wt[e.group_id].groupPosition];ft[e.zone_id]={},ft[e.zone_id][e.sent_to]={first_name:i.first_name,item_id:i.item_id,quote_id:e.quote_id,group_id:i.group_id,timestamp:2344444},t.toggleBook(!0,i).then(function(){C.child(e.group_id+"/queue/"+window.localStorage.getItem("apikeypublic")).update({quote_id:e.quote_id},function(o){o||(at.indexOf(e.zone_id)<0?t.setStoredZones({id:e.zone_id},"inside",e.group_id):C.child(e.zone_id+"/queue/"+window.localStorage.getItem("apikeypublic")).update({quote_id:e.quote_id},function(e){}))})})}},isDriverInTrip:function(){return Y},processFirebase:function(){var e=this;if(St=!0,!(Le.length<st.length)){for(var t in ye)for(var o in ye[t])if(void 0!==ye[t][o].route){"offer"!=ye[t][o].route.status&&Ct.indexOf(o)>-1&&Ct.splice(Ct.indexOf(o),1);var i=ye[t][o].route.status;if("offer"!=i||e.withinOfferTime(ye[t][o])||P(function(t,o){!Te&&ye[t]&&ye[t][o]&&"offer"==ye[t][o].route.status&&!e.withinOfferTime(ye[t][o])&&(Te=!0,e.deleteInbox([{quote_id:o,zone_id:t}]).then(function(){Te=!1,e.processFirebase()}))},5e3,!0,t,o),"offer"==i&&"app.employee-dispatcher"==q.current.name&&ye[t][o].route.reply_to==window.localStorage.getItem("apikeypublic")&&f.dispatcherInboxes.indexOf(o)<0&&f.dispatcherInboxes.push(kt),"offer"==i&&(!f.isDriver||f.isDriver&&dt.indexOf(t)<0)&&ye[t][o].route.reply_to==window.localStorage.getItem("apikeypublic")&&e.withinOfferTime(ye[t][o])&&(!function(){var i=t,r=o;P(function(){if(ye.hasOwnProperty(i)&&ye[i].hasOwnProperty(r)){var t=ye[i][r],o=0,n=t.offer_to,a=t.offer_to_not,d=!1,c=moment(e.getServerTime());if(""!=t.offer_to_not)for(m in a){var f=moment.utc(a[m].update_time,"MM/DD/YYYY HH:mm:ss"),p=e.getOfferTime(t.route.zone_id,a[m].offer_to_not);if(d=!a[m].hasOwnProperty("status")&&c.diff(f,"seconds")<p||a[m].hasOwnProperty("status")&&"offerdeclined"!=a[m].status){o=1e3*p+s.offerNextDriverDelay+8e3;break}}if(""!=t.offer_to&&"object"==typeof t.offer_to&&!G){var m=Object.keys(n)[0],p=e.getOfferTime(t.route.zone_id,n[m].offer_to),f=moment.utc(n[m].update_time,"MM/DD/YYYY HH:mm"),g=Object.keys(n).length*(+p+15);if(c.diff(f,"seconds")>g)for(m in n){G=!0;var _=C.child(i+"/inbox/"+r),h={lat:n[m].lat,lon:n[m].lon,update_time:moment.utc().format("MM/DD/YYYY HH:mm:ss"),offer_to_not:n[m].offer_to},v=_.child("offer_to_not").push(),y=v.key(),w={};w["offer_to_not/"+y]=h,function(e){_.update(w,function(t){t||(1==Object.keys(e).length?_.child("offer_to").set(""):_.child("offer_to/"+m).remove()),G=!1})}(n);break}else c.diff(f)>0&&P(function(){e.processFirebase()},c.diff(f))}var b=""==ye[i][r].offer_to&&""!=ye[i][r].offer_to_not;!b&&Qe[r]&&(P.cancel(Qe[r]),delete Qe[r]),b&&!function(t){Qe[r]||(Qe[r]=P(function(){if(D.allow_reoffer){var o=!0;for(var n in ye){for(var a in ye[n])if(ye[n][r]&&ye[n][a].route.quote_id==t&&"offer"==ye[n][r].route.status&&""!=ye[n][r].offer_to){o=!1;break}if(!o)break}}(D.allow_reoffer&&o||!D.allow_reoffer)&&ye.hasOwnProperty(i)&&void 0!=ye[i][r]&&"offer"==ye[i][r].route.status&&""==ye[i][r].offer_to&&""!=ye[i][r].offer_to_not&&(l(["SORRY","OFFER_NOT_ACCEPTED"]).then(function(e){D.dontHideLoader=!1,D.$broadcast("loading:hide"),u.error(e.OFFER_NOT_ACCEPTED,e.SORRY)}),e.endTrip(r,!0))},o))}(ye[i][r].route.quote_id)}},2e3)}(),function(){var i=t,r=o;P(function(){f.dispatcherInboxes.indexOf(r)<0&&""!=typeof ye[i][r]&&ye[i][r]&&"offer"==ye[i][r].route.status&&e.withinOfferTime(ye[i][r])&&(ht.indexOf(ye[i][r].route.quote_id)<0&&ht.push(ye[i][r].route.quote_id),D.detail||(D.$broadcast("loading:show"),D.dontHideLoader=!0),e.areOfferDriversAvailable(i,r,ye[i][r].route.pickup_zone,ye[i][r].route.group_id).then(function(t){if(t){wt.hasOwnProperty(i)?i:ye[i][r].route.group_id;D.detail||(D.tripModal=!0,D.$broadcast("loading:show",{text:"AWAIT_CONFIRM"},!0),q.transitionTo("app.trip-detail"))}else if(!Te&&""!=ye[i][r].offer_to){Te=!0;var o=[],n=i,a=r;o.push({quote_id:a,zone_id:n}),ye[n][a].route.pickup_zone!=n&&o.push({quote_id:a,zone_id:ye[n][a].route.pickup_zone}),ye[n][a].route.zone_id!=ye[n][a].route.group_id&&o.push({quote_id:a,zone_id:ye[n][a].route.group_id}),function(t){var o=e.inboxesWithQuoteId(null,ye[n][a].route.quote_id);e.deleteInbox(o).then(function(){Te=!1,l(["OFFER_NOT_ACCEPTED","SORRY"]).then(function(e){D.$broadcast("loading:hide"),u.error(e.OFFER_NOT_ACCEPTED,e.SORRY)}),e.endTrip(a,!0)},function(e){})}(a)}}))},e.timeToShowOffer(ye[t][o]))}()),ye[t][o].route.reply_to==window.localStorage.getItem("apikeypublic")||ye[t][o].route.sent_to==window.localStorage.getItem("apikeypublic")&&"quote"!=ye[t][o].route.status&&"offer"!=ye[t][o].route.status){var r=ye[t][o].route;if(r.isCustomer=ye[t][o].route.reply_to==window.localStorage.getItem("apikeypublic"),r.isDriver=!r.isCustomer,f.dispatcherInboxes.indexOf(o)<0){var n=r.reply_to==window.localStorage.getItem("apikeypublic"),a=r.sent_to==window.localStorage.getItem("apikeypublic"),d=r.hasOwnProperty("reply_to_message")?r.reply_to_message[Object.keys(r.reply_to_message)[Object.keys(r.reply_to_message).length-1]].status:"quote",c=r.sent_to_message[Object.keys(r.sent_to_message)[Object.keys(r.sent_to_message).length-1]].status;if("accept"==i||"arrived"==i||"load"==i){f.acceptedOrders||(f.acceptedOrders=[]);var p=D.detail&&D.detail.id!=r.id&&Y==r.quote_id;if(!D.detail||p){It=!0,r.isCustomer=ye[t][o].route.reply_to==window.localStorage.getItem("apikeypublic"),r.isDriver=!r.isCustomer,r.zone_id=t,e.reBookIn(r),It=!0,vt=!1;var m=r;if(D.detail=m,f.tripDetail=m,f.tripDetail.isDriver){for(var g in wt)if(wt[g].booked&&g==wt[g].category_id)if(g!=r.group_id)e.toggleBook(!1,bt[wt[g].groupPosition]);else{var _=C.child(t+"/queue/"+window.localStorage.getItem("apikeypublic"));_.child("disconnectTime").remove(),_.update({quote_id:r.quote_id})}C.child(r.group_id+"/queue/"+window.localStorage.getItem("apikeypublic")+"/quote_id").set(r.quote_id),C.child(r.group_id+"/queue/"+window.localStorage.getItem("apikeypublic")).onDisconnect().cancel(),C.child(r.group_id+"/queue/"+window.localStorage.getItem("apikeypublic")).onDisconnect().update({disconnectTime:Firebase.ServerValue.TIMESTAMP})}(f.tripDetail.isDriver||"app.trip-detail"!=D.history.currentStateName())&&(It=!0,P(function(){},1e3),D.tripModal=!0),"app.trip-detail"!=D.history.currentStateName()&&(q.transitionTo("app.trip-detail"),e.removeModalPopup(D,"offerModal")),D.dontHideLoader=!1,D.$broadcast("trip:started",null),e.isViewing("offerModal")||D.$broadcast("loading:hide")}else n&&f.acceptedOrders.indexOf(r.id)<0&&(f.acceptedOrders.push(r.id),l(["SUCCESS","ORDER_ACCEPTED"]).then(function(e){D.$broadcast("loading:hide"),u.success(e.ORDER_ACCEPTED,e.SUCCESS,{timeOut:3e3})}))}else if((a&&"unload"==d||("unload"==i||"receipt"==i||"rate"==i)&&n&&"receipt"!=c&&"rate"!=c)&&!D.detail&&Object.keys(ct).length>0){It=!0;var r=ye[t][o].route;if(r.isCustomer=ye[t][o].route.reply_to==window.localStorage.getItem("apikeypublic"),r.isDriver=!r.isCustomer,r.zone_id=t,ct.hasOwnProperty(t)&&ct[t].hasOwnProperty(r.sent_to)&&(r.driver_lat=ct[t][r.sent_to].lat,r.driver_lon=ct[t][r.sent_to].lon),e.reBookIn(r),D.detail=r,f.tripDetail=r,f.tripDetail.isDriver){for(var g in wt)if(wt[g].booked&&g==wt[g].category_id)if(g!=r.group_id)e.toggleBook(!1,bt[wt[g].groupPosition]);else{var _=C.child(t+"/queue/"+window.localStorage.getItem("apikeypublic"));_.child("disconnectTime").remove(),_.update({quote_id:r.quote_id})}C.child(r.group_id+"/queue/"+window.localStorage.getItem("apikeypublic")+"/quote_id").set(r.quote_id),C.child(r.group_id+"/queue/"+window.localStorage.getItem("apikeypublic")).onDisconnect().cancel(),C.child(r.group_id+"/queue/"+window.localStorage.getItem("apikeypublic")).onDisconnect().update({disconnectTime:Firebase.ServerValue.TIMESTAMP})}D.tripModal=!0,q.transitionTo("app.trip-detail")}if(!It&&a&&"receipt"==d||n&&("unload"==r.status||"receipt"==r.status||"rate"==r.status)&&("receipt"==c||void 0==c)){if(It=!0,!D.detail&&null==D.ratingModal){D.ratingModal=!0;var h=ye[t][o].route;null==f.tripDetail&&(f.tripDetail={zone_id:t,id:h.id,isDriver:h.reply_to!=window.localStorage.getItem("apikeypublic")});var r=ye[t][o].route;r.isCustomer=r.reply_to==window.localStorage.getItem("apikeypublic"),r.isDriver=!r.isCustomer,D.detail=r,q.transitionTo("app.trip-detail")}}else if(It&&null!=f.tripDetail&&f.tripDetail.id==o&&a&&"rate"==d){e.endTrip(o),e.ringTone(),P(function(){ke&&e.ringTone()},3e3);continue}}}if("offer"==ye[t][o].route.status&&!function(){var i=t,r=o,n=ye[i][r],a=0,u=n.offer_to_not,l=!1,d=moment(e.getServerTime());if(""!=n.offer_to_not)for(T in u){var c=moment.utc(u[T].update_time,"MM/DD/YYYY HH:mm:ss"),f=e.getOfferTime(n.route.zone_id,u[T].offer_to_not);if(l=!u[T].hasOwnProperty("status")&&d.diff(c,"seconds")<f||u[T].hasOwnProperty("status")&&"offerdeclined"!=u[T].status){a=1e3*f+s.offerNextDriverDelay+5e3;break}}var p=""==ye[i][r].offer_to&&""!=ye[i][r].offer_to_not;p&&!function(){Ye[r]&&P.cancel(Ye[r]),Ye[r]=P(function(){ye.hasOwnProperty(i)&&void 0!=ye[i][r]&&"offer"==ye[i][r].route.status&&""==ye[i][r].offer_to&&""!=ye[i][r].offer_to_not&&e.deleteInbox([{quote_id:r,zone_id:i}]).then(function(){e.processFirebase()},function(e){})},a)}()}(),"rate"==ye[t][o].route.status&&ye[t][o].route.hasOwnProperty("reply_to_message")){var v=ye[t][o].route.reply_to_message[Object.keys(ye[t][o].route.reply_to_message)[Object.keys(ye[t][o].route.reply_to_message).length-1]];if("rate"==v.status){var y=moment.duration(moment(e.getServerTime()).diff(moment.utc(v.update_time,"MM/DD/YYYY HH:mm:ss"))).asMinutes(),c=ye[t][o].route.sent_to_message[Object.keys(ye[t][o].route.sent_to_message)[Object.keys(ye[t][o].route.sent_to_message).length-1]];(y>s.deleteTimeAfterDriverRate||"rate"==c.status)&&e.deleteInbox([{quote_id:o,zone_id:t}]).then(function(){e.processFirebase()},function(e){})}}if(ye[t][o].route.reply_to==window.localStorage.getItem("apikeypublic")&&ye[t][o].route.hasOwnProperty("reply_to_message")&&Array.isArray(ye[t][o].route.reply_to_message)&&ye[t][o].route.reply_to_message.length>1){var w=ye[t][o].route,b=w.reply_to_message.length-1;if(F.indexOf(o)<0&&!w.reply_to_message[b].hasOwnProperty("read")&&""!=w.reply_to_message[b].message&&("message"==w.reply_to_message[b].status||"order_edited"==w.reply_to_message[b].status||"cancelled"==w.reply_to_message[b].status)){window.localStorage.setItem("replyMsgIndex",b);var k;"cancelled"==w.reply_to_message[b].status?(F.push(o),e.getDriverDetail(t,w.sent_to).then(function(t){var o=t.first_name+": "+w.reply_to_message[b].message;e.toastMsg(o,"TRIP_CANCEL",{routeItem:w,node:"reply_to_message",index:b}),e.deleteInbox([{quote_id:w.id,zone_id:w.group_id}])})):"message"==w.reply_to_message[b].status?(F.push(o),e.getDriverDetail(t,w.sent_to).then(function(t){var o=t.first_name+": "+w.reply_to_message[b].message;e.toastMsg(o,"MESSAGE",{routeItem:w,node:"reply_to_message",index:b})})):(F.push(o),e.getDriverDetail(t,w.sent_to).then(function(t){var o=t.first_name+": "+w.reply_to_message[b].message;e.toastMsg(o,"ORDER_EDITED",{routeItem:w,node:"reply_to_message",index:b})}),D.detail=angular.extend(D.detail,D.detail,ye[t][o].route),D.$broadcast("order:edited"))}}if(ye[t][o])if("quote"==ye[t][o].route.status&&le.indexOf(ye[t][o].route.quote_id)<0&&(le.push(ye[t][o].route.quote_id),e.allDriversQuoted(t,o)),"quote"==ye[t][o].route.status&&""!=ye[t][o].offer_to&&zt.indexOf(o)<0)if(e.withinExpiryTime(ye[t][o])){if((re||yt)&&D.rates.length>0&&ye[t][o].route.quote_id!=D.rates[0].quote_id)continue;if(window.localStorage.getItem("apikeypublic")==ye[t][o].route.ordered_by||f.uuid==ye[t][o].route.ordered_by){window.localStorage.setItem("quote_Id",ye[t][o].route.quote_id);var S={};S.text=ye[t][o].route.selectService+" $"+ye[t][o].route.price,S.value=ye[t][o].route.rate_id,S.price=ye[t][o].route.price,S.quoteId=ye[t][o].route.id,S.id=ye[t][o].route.id,S.quote_id=ye[t][o].route.quote_id,S.summary=ye[t][o].route,S.mode=ye[t][o].route.mode,S.zone_id=[ye[t][o].route.zone_id],S.pickup_zone=ye[t][o].route.pickup_zone,S.group_id=ye[t][o].route.group_id,S.whmcs=ye[t][o].route.whmcs;var I=-1,x=D.rates.some(function(e,i){return e.value===ye[t][o].route.rate_id&&(I=i),e.value===ye[t][o].route.rate_id});null==f.quoteID&&(f.quoteID=[]),!x&&f.quoteID.indexOf(S.quote_id)<0?(D.rates.push(S),D.rates.sort(function(e,t){return e.price-t.price}),re&&(D.$broadcast("loading:hide"),D.showCountDown=!0)):D.rates[I].zone_id.indexOf(ye[t][o].route.zone_id)<0&&D.rates[I].zone_id.push(ye[t][o].route.zone_id)}}else window.localStorage.getItem("apikeypublic")&&!function(t,o){P(function(){if(ye.hasOwnProperty(t)&&ye[t].hasOwnProperty(o)&&"quote"==ye[t][o].route.status){It=!0;var i=[];i.push({quote_id:o,zone_id:t}),ye[t][o].route.pickup_zone!=t&&i.push({quote_id:o,zone_id:ye[t][o].route.pickup_zone}),ye[t][o].route.zone_id!=ye[t][o].route.group_id&&i.push({quote_id:o,zone_id:ye[t][o].route.group_id}),e.deleteInbox(i).then(function(){It=!1,e.processFirebase()},function(e){})}},5e3)}(t,o);else if(It&&"unload"==ye[t][o].route.status&&f.tripDetail&&f.tripDetail.id==o&&ye[t][o].route.reply_to==window.localStorage.getItem("apikeypublic")){var r=ye[t][o].route,c=r.sent_to_message[Object.keys(r.sent_to_message)[Object.keys(r.sent_to_message).length-1]].status;"receipt"!=c&&"rate"!=c&&(e.stopTrackingTrip(),e.stopTrackingAfter(),null==D.receiptModal&&D.$broadcast("trip:unloaded",null))}else if("arrived"==ye[t][o].route.status&&ye[t][o].route.reply_to==window.localStorage.getItem("apikeypublic")&&F.indexOf(o)<0&&"arrived"!=r.sent_to_message[Object.keys(r.sent_to_message)[Object.keys(r.sent_to_message).length-1]].status){var w=ye[t][o].route,b=w.reply_to_message.length-1;if(!w.reply_to_message[b].hasOwnProperty("read")&&!D.arrivedToast||D.arrivedToast&&D.arrivedToast.indexOf(o)<0){F.push(o),D.arrivedToast||(D.arrivedToast=[]),D.arrivedToast.push(o),e.ringTone(),P(function(){e.isRinging()&&e.ringTone()},3e3);var w=ye[t][o].route,b=w.reply_to_message.length-1;e.setMsgRead({routeItem:w,node:"reply_to_message",index:b}),e.addNotification("message"),function(t,o){l(["ARRIVAL","HAS_ARRIVED"]).then(function(i){k=e.getAllDrivers()[t][ye[t][o].route.sent_to].first_name+i.HAS_ARRIVED,D.toastArrived=u.info(k,i.ARRIVAL,{onTap:function(){ye[t]&&ye[t][o]&&D.detail&&o==D.detail.id&&"arrived"==ye[t][o].route.status&&ye[t][o].route.reply_to==window.localStorage.getItem("apikeypublic")&&"arrived"!=r.sent_to_message[Object.keys(r.sent_to_message)[Object.keys(r.sent_to_message).length-1]].status&&D.$broadcast("trip:arrived",ye[t][o].route)}})})}(t,o)}}else"receipt"==ye[t][o].route.status&&ye[t][o].route.reply_to==window.localStorage.getItem("apikeypublic")?void 0==D.receiptModal||null==D.receiptModal:"load"==ye[t][o].route.status&&ye[t][o].route.reply_to==window.localStorage.getItem("apikeypublic")?Pe||(e.startTrackingTrip(),e.startTrackingAfter(ye[t][o].route.dropoff_lat,ye[t][o].route.dropoff_lon)):!Te&&(ye[t][o].route.reply_to==window.localStorage.getItem("apikeypublic")||ye[t][o].route.sent_to==window.localStorage.getItem("apikeypublic"))&&ye[t][o].route.status.indexOf("ordercancelled_")>-1&&(Te=!0,e.deleteInbox([{quote_id:o,zone_id:t}]).then(function(){Te=!1,e.processFirebase()}),k="Trip cancelled by "+ye[t][o].route.status.split("_")[1],message="TRIP_CANCEL",(!D.detail||D.detail&&D.detail.id==o)&&e.endTrip(o),e.ringTone(),P(function(){e.ringTone()},3e3),e.addNotification("cancelled"),l(message).then(function(e){u.error(k,e)}))}if(D.rates.length>0&&(P.cancel(J[D.rates[0].quote_id]),re||yt||"quote"!=D.rates[0].mode?"offer"!=D.rates[0].mode||yt||(void 0==window.localStorage.getItem("apikeypublic")&&(D.dontHideLoader=!1,D.$broadcast("loading:hide"),yt=!0,q.transitionTo("app.login")),P(function(){if(D.dontHideLoader=!1,D.$broadcast("loading:hide"),void 0!=D.rates[0]){D.rates.sort(function(e,t){return t.price-e.price});var t={rate_id:D.rates[0].value,zone_id:D.rates[0].zone_id,group_id:D.rates[0].group_id,pickup_zone:D.rates[0].pickup_zone,price:D.rates[0].price,id:D.rates[0].quoteId,summary:D.rates[0].summary};yt||(D.showInnerCountDown=!0,e.showOrderForm(t),e.ringTone(-1))}},5e3)):(e.showPriceModal(),e.ringTone(-1))),0!=dt.length&&Se&&0==D.bookingIn.length&&null!=bt)for(var T in wt){var t=T;if(bt[wt[T].position].tags.indexOf("Driver")>-1&&(wt[T].booked||null!=f.tripDetail))for(var o in ye[t])if(null!=ye[t][o]&&ye[t][o].hasOwnProperty("route")){var w=ye[t][o].route;if(ye[t][o].route.sent_to==window.localStorage.getItem("apikeypublic")&&ye[t][o].route.hasOwnProperty("sent_to_message")&&Array.isArray(ye[t][o].route.sent_to_message)&&ye[t][o].route.sent_to_message.length>1){var b=w.sent_to_message.length-1;F.indexOf(o)<0&&!w.sent_to_message[b].hasOwnProperty("read")&&""!=w.sent_to_message[b].message&&("message"==w.sent_to_message[b].status||"order_edited"==w.sent_to_message[b].status||"cancelled"==w.sent_to_message[b].status||"arrived"==w.sent_to_message[b].status)&&(window.localStorage.setItem("sentMsgIndex",b),F.push(o),e.profile(w.reply_to).then(function(i){D.profile=i,"cancelled"==w.sent_to_message[b].status?!function(t,o){D.bookingOut.push(t),bt[wt[t].groupPosition].limit&&C.child(t+"/queue/"+window.localStorage.getItem("apikeypublic")).remove(function(){}),k=D.profile.description+": "+o.sent_to_message[b].message,message="TRIP_CANCEL",e.endTrip(o.id),e.ringTone(),P(function(){e.ringTone()},3e3),e.addNotification("cancelled"),l(message).then(function(e){u.error(k,e)}),e.deleteInbox([{quote_id:o.id,zone_id:o.group_id}])}(t,w):"order_edited"==w.sent_to_message[b].status?(k=D.profile.description+": "+w.sent_to_message[b].message,message="ORDER_EDITED",e.ringTone(),P(function(){e.ringTone()},3e3),e.addNotification("message"),l(message).then(function(e){u.info(k,e)}),D.detail=angular.extend(D.detail,D.detail,ye[t][o].route),D.$broadcast("order:edited")):(k=D.profile.description+": "+w.sent_to_message[b].message,e.toastMsg(k,"MESSAGE",{routeItem:w,node:"sent_to_message",index:b}))}))}if(void 0!==w&&ye[t][o]&&!(wt[t]&&bt[wt[t].groupPosition].QP&&bt[wt[t].groupPosition].QP.toString().indexOf("/")<0)){if(""!=w.tripID){w.tripID}var M=e.getGPSDistance(parseFloat(w.pickup_lat),parseFloat(w.pickup_lon),D.lat,D.lon);if(!He&&"offer"==ye[t][o].route.status&&we.hasOwnProperty(o)&&ie&&D.quoteDetail&&D.quoteDetail.quote_id==ye[t][o].route.quote_id&&(e.quoteModalCleanUp(),l(["SORRY","DRIVER_LATE_QUOTE"]).then(function(e){u.error(e.DRIVER_LATE_QUOTE,e.SORRY)})),hasShown=null,"offer"==ye[t][o].route.status&&(0==Ct.length||Ct.indexOf(o)>-1)&&(void 0!=e.getOfferId(t,o)&&o==e.getOfferId(t,o).routeId||(hasShown=e.hasShownOffer(t,o)))&&!Y&&!e.isViewing("offerModal")){D.milesAway=M.toFixed(2);D.declineOffer=function(){var t=e.getOfferNotId(D.offerDetail.zone_id,D.offerDetail.id),o=C.child(t.zoneId+"/inbox/"+t.routeId+"/offer_to_not/"+t.key);o.update({status:"offerdeclined"},function(e){}),e.removeModalPopup(D,"offerModal"),e.sendToJail(t.zoneId)},D.acceptOffer=function(){D.showLoader=!0,D.showOfferCounter=!1,se=!0,D.dontHideLoader=!0,D.$broadcast("loading:show"),P.cancel(D.jailTimer);var t=e.getOfferNotId(D.offerDetail.zone_id,D.offerDetail.id);
D.offerNotInProcess=!0,e.ringTone();var o=function(){e.getGoogleDistTime({lat:D.lat,lon:D.lon},{lat:t.routeObj.pickup_lat,lon:t.routeObj.pickup_lon}).then(function(o){var i=function(){var t=ye[D.offerDetail.zone_id][D.offerDetail.id],i={eta_distance:o.distMiles,eta_time:o.timeHours,lat:D.lat,lon:D.lon,message:"",status:"accept",update_time:moment.utc().format("MM/DD/YYYY HH:mm:ss")},n=C.child(t.route.group_id+"/inbox/"+t.route.id);n.update({offer_to:"",offer_to_not:"","route/status":"accept","route/sent_to":window.localStorage.getItem("apikeypublic"),"route/reply_to_message/1":i},function(o){if(o)D.offerNotInProcess=!1,ue?r():l(["SOMETHING_WRONG","FAILED"]).then(function(e){D.$broadcast("loading:hide"),O.alert({title:e.FAILED,template:e.SOMETHING_WRONG})}),D.showOfferCounter=!0;else{D.isTripStarted=!0,ue=!1,se=!1,Ct.splice(Ct.indexOf(D.offerDetail.id),1),D.offerDetail=null;var i=e.getInboxesByQuoteId(t.route.quote_id);i.length>0&&i.forEach(function(e,t){t>0&&C.child(e.route.group_id+"/inbox/"+e.route.id).remove()})}})};e.deleteOtherInboxes(t.routeObj).then(function(){ue?r():i()},function(){ue&&r()});var r=function(){D.dontHideLoader=!1,e.removeModalPopup(D,"offerModal"),e.sendToJail(t.zoneId),ue=!1,se=!1}},function(){ue?onTimeOut():o()})};o()};if("undefined"!=typeof hasShown&&hasShown)return void e.offerFunc(ye[t][o],t,o,hasShown);D.offerNotInProcess=!0,vt=!0,e.offerFunc(ye[t][o],t,o)}else if("quote"==ye[t][o].route.status&&(bt[wt[t].position].zone_id==t||bt[wt[t].position].category_id==t)&&e.quoteMyItemId(t,o)&&e.matchesTags(pt[window.localStorage.getItem("apikeypublic")][t],w.selectService.split(",").filter(function(e){return e}))&&e.withinQuoteExpiryTime(ye[t][o])&&dt.indexOf(t)>-1&&ye[t][o].route.ordered_by!=window.localStorage.getItem("apikeypublic")&&e.withinZone(ye[t][o].route.group_id,null,null,null,ye[t][o].route.pickup_lat,ye[t][o].route.pickup_lon)){if(null==f.quoteID&&(f.quoteID=[]),Y||e.isViewing("offerModal")||He||f.quoteID.indexOf(w.quote_id)>-1)continue;if(null==D.quoteDetail){D.quoteDetail={},D.quoteDetail.quote_id=w.quote_id,D.quoteDetail.pickup=w.pickup,D.quoteDetail.pickup_lat=w.pickup_lat,D.quoteDetail.pickup_lon=w.pickup_lon,D.quoteDetail.dropoff=w.dropoff,D.quoteDetail.selectService=w.selectService,D.quoteDetail.selectPeople=w.selectPeople,D.quoteDetail.selectDate=w.selectDate,D.quoteDetail.selectTime=w.selectTime,D.quoteDetail.route_distance=parseFloat(w.route_distance).toFixed(2),D.quoteDetail.distance_pickup=parseFloat(M).toFixed(2),D.quoteDetail.note=w.note,D.quoteDetail.range=w.range,D.quoteDetail.group_name=w.group_name,D.quoteDetail.zone_id=w.zone_id;var E=["DETAIL","PICKUP","DROPOFF","SERVICE","SEATS","ROUTE","DATE_TIME","MILES","PICKUP_DISTANCE","NOTES"];l(E).then(function(t){null!=D.quoteDetail&&(D.accordion={},D.items=[],e.getGoogleDistTime({lat:D.quoteDetail.pickup_lat,lon:D.quoteDetail.pickup_lon},{lat:D.lat,lon:D.lon}).then(function(e){D.quoteDetail&&(D.items.push({label:t.PICKUP_DISTANCE,text:e.dist}),D.items.push({label:t.DATE_TIME,text:e.timeText}),"quote"==D.quoteDetail.mode&&D.items.push({label:t.PRICE,text:D.quoteDetail.price}))}),D.accordion.heading=t.DETAIL)})}var z={};z.text=w.selectService+" $"+w.price,z.enabled=!0,z.id=w.id,z.price=w.price,z.quote_id=w.quote_id,z.zone_id=w.pickup_zone,z.group_id=w.group_id,z.whmcs=w.whmcs;var x=D.quotes.some(function(e){return e.id===w.id});if(!x&&w.quote_id==D.quoteDetail.quote_id)if(D.quotes.push(z),D.quotes.sort(function(e,t){return e.price-t.price}),"quote"!=ye[t][o].route.status&&"offer"!=ye[t][o].route.status||"quote"!=ye[t][o].route.mode||"quote"!=bt[wt[t].groupPosition].mode){if("quote"==ye[t][o].route.status){D.quotes.slice(0);P(function(t,o,i){if(!ie&&ye[t][o]&&i.length>0){ie=!0,f.quoteID.push(i[0].quote_id),He=!0;var r=function(n){e.quote(i,-3).then(function(){var r=function(n){e.quote(i,3).then(function(){e.quoteModalCleanUp()},function(){ye[t]&&ye[t][o]&&("quote"==ye[t][o].route.status||"offer"==ye[t][o].route.status)&&3>n&&r(n+1)})};r(0)},function(){ye[t]&&ye[t][o]&&("quote"==ye[t][o].route.status||"offer"==ye[t][o].route.status)&&3>n&&r(n+1)})};r(0)}},5e3,!0,t,o,D.quotes)}}else ie||(ie=!0,e.setQuoteCountDown(ye[t][o]),e.showQuoteModal(w,ye[t][o]))}}}}}},deleteOtherInboxes:function(e){var t=T.defer(),o=this.inboxesWithQuoteId(e.id,e.quote_id);return o.length>0?this.deleteInbox(o).then(function(){t.resolve()},function(){t.reject()}):t.resolve(),t.promise},isLastQuote:function(){var e=this;if(D.allow_reoffer){var t=!0,o=ye[D.offerDetail.zone_id][D.offerDetail.id],i=e.mergedInboxObj(o),r=i.offer_to;for(var n in r)if(r[n].offer_to==window.localStorage.getItem("apikeypublic")){t=!1;break}return t}return!0},sendToJail:function(e){var t=this;D.$broadcast("loading:hide",!0),It=!0,ke&&t.ringTone();var o=pt[window.localStorage.getItem("apikeypublic")][e].settings,i=o&&o.jail;D.jailCountdown=i||D.jailTime,w.fromTemplateUrl("jail-page.html",{backdropClickToClose:!1,hardwareBackButtonClose:!1,scope:D}).then(function(e){D.jailModal=e,e.show(),t.toggleBook(!1,"all"),P(function(e){t.endTrip(e),t.toggleBook(!0,"all"),t.removeModalPopup(D,"jailModal"),Ct.indexOf(e)>-1&&Ct.splice(Ct.indexOf(e),1),D.offerDetail=null,q.transitionTo("app.employee-index")},1e3*i,!0,D.offerDetail.id)})},offerFunc:function(e,t,o,i){var r,n=this;if(D.allow_reoffer&&(r=n.mergedInboxObj(e)),r&&r.route.zoneArr.length>0){0==Ct.length&&(Ct=r.route.inboxArr);var a=n.getOfferPosition(o,t,r)+1,u=n.getOfferTime(t,n.getApiKeyDriverOffered(r)),l=a*u*1e3+a*s.offerNextDriverDelay+0;0==a&&n.getLastOfferedDeclined(o,t)&&(l=0),function(e,t,o,a){var s=n.getDriverInOfferDelay(r);n.showOfferModal(e,t,o,s,a,r,i)}(a,o,t,l)}else n.driversInZoneOffered(e).then(function(e){if(-1==e)var r=n.getOfferPosition(o,t)+1;else var r=e;var a=n.getOfferTime(t,n.getApiKeyDriverOffered(ye[t][o])),u=r*a*1e3+r*s.offerNextDriverDelay+0;0==r&&n.getLastOfferedDeclined(o,t)&&(u=0),function(e,t,o,r){var a=n.getDriverInOfferDelay(ye[o][t]);ye.hasOwnProperty(o)&&ye[o].hasOwnProperty(t)&&n.showOfferModal(e,t,o,a,r,ye[o][t],i)}(r,o,t,u)},function(){n.isViewing("offerModal")||(vt=!1)})},driversInZoneOffered:function(e){var t=T.defer(),o=this;return P(function(){if(!e||e&&"offer"!=e.route.status)t.reject();else if(o.withinGreenZone(e.route.group_id,e.route.pickup_zone,e.route.pickup_lat,e.route.pickup_lon)){var i=!1;if(""!=e.offer_to&&ft[e.route.zone_id]&&ft[e.route.zone_id][window.localStorage.getItem("apikeypublic")]&&!o.withinGreenZone(e.route.group_id,e.route.pickup_zone,e.route.pickup_lat,e.route.pickup_lon,ft[e.route.zone_id][window.localStorage.getItem("apikeypublic")].zone_id))for(var r in e.offer_to)if(ft[e.route.zone_id][e.offer_to[r].offer_to]&&o.withinGreenZone(e.route.group_id,e.route.pickup_zone,ft[e.route.zone_id][e.offer_to[r].offer_to].lat,ft[e.route.zone_id][e.offer_to[r].offer_to].lon,ft[e.route.zone_id][e.offer_to[r].offer_to].zone_id)){t.resolve(10),i=!0;break}i||t.resolve(-1)}else t.resolve(-1)},2e3),t.promise},getDriverInOfferDelay:function(e){var t=this,o=e.offer_to_not,i=moment(t.getServerTime());if(""!=o)for(var r in o){var n=t.getOfferTime(o[r].group_id,o[r].offer_to_not);if(!(o[r].offer_to_not==window.localStorage.getItem("apikeypublic")||ft.hasOwnProperty(o[r].group_id)&&!ft[o[r].group_id].hasOwnProperty(o[r].offer_to_not)||o[r].hasOwnProperty("status")&&"quotecancelled"!=o[r].status)){var a=moment.utc(o[r].update_time,"MM/DD/YYYY HH:mm:ss"),u=i.diff(a,"seconds");if(u<n+s.offerNextDriverDelay/1e3)return 1e3*(n-u+10)}}return 0},getofferedDriversToCompare:function(e){var t=[];if(""!=e)for(key in e)t.push(e[key].offer_to);return t},quoteMyItemId:function(e,t){var o=ye[e][t].route.items;if(!o||""==o||o==bt[wt[e].position].item_id)return!0;var i=!1;if("object"==typeof o)for(key in o)if(bt[wt[e].position].item_id==o[key]){i=!0;break}return i},areOfferDriversAvailable:function(e,t,o,i){var r=this,n=T.defer(),a=!1,s=ye[e][t].offer_to;for(key in s)if(ft.hasOwnProperty(e)&&ft[e].hasOwnProperty(s[key].offer_to)&&(""==ft[e][s[key].offer_to].quote_id||"Offered"==ft[e][s[key].offer_to].quote_id)){a=!0;break}if(!a&&ye.hasOwnProperty(i)&&ye[i].hasOwnProperty(t)){var s=ye[i][t].offer_to;for(key in s)if(ft.hasOwnProperty(i)&&ft[i].hasOwnProperty(s[key].offer_to)&&(""==ft[i][s[key].offer_to].quote_id||"Offered"==ft[e][s[key].offer_to].quote_id)){a=!0;break}}if(a)n.resolve(a);else{var u=ye[e][t].route;if(ft[e]){for(var l in ft[e])if(l!=window.localStorage.getItem("apikeypublic")&&(""==ft[e][l].quote_id||"Offered"==ft[e][l].quote_id)&&pt[l][e]&&r.matchesTags(pt[l][e],u.selectService.split(",").filter(function(e){return e}))&&r.getGPSDistance(u.pickup_lat,u.pickup_lon,pt[l][e].lat,pt[l][e].lon)<u.range){a=!0;break}n.resolve(a)}else n.resolve(a)}return n.promise},getDriversOfferedOtherQuote:function(e,t){var o=this.getofferedDriversToCompare(e),i=[];for(var r in ye)for(var n in ye[r])if(ye[r][n].route.quote_id!=t&&""!=ye[r][n].offer_to_not){var a=ye[r][n].offer_to_not;for(key in a)ft.hasOwnProperty(r)&&ft[r].hasOwnProperty(a[key].offer_to_not)&&"Offered"==ft[r][a[key].offer_to_not].quote_id&&o.indexOf(a[key].offer_to_not)>-1&&i.push(a[key].offer_to_not)}return i},setOfferTimeout:function(){var e=this;for(var t in Ze){P.cancel(Ze[t]);var o=t.split(",")[0],i=t.split(",")[1],r=ye[o][i];delete Ze[""+o+","+i],r&&"offer"==r.route.status&&(vt=!0,e.offerFunc(r,o,i))}},getApiKeyDriverOffered:function(e){var t=e.offer_to_not||e.offer_to;if(t){var o=t[Object.keys(t)[Object.keys(t).length-1]];return o.offer_to_not||o.offer_to}},getLastOfferedDeclined:function(e,t){var o=ye[t][e].offer_to_not;if(""==o)return!0;var i;for(key in o)void 0==i&&(i=key),moment(new Date(o[i].update_time)).isBefore(moment(new Date(o[key].update_time)))&&(i=key);return!o[i].hasOwnProperty("status")||"offerdeclined"!=o[i].status&&"quotecancelled"!=o[i].status?!1:!0},cancelOfferTimeout:function(){for(var e in Ze)P.cancel(Ze[e])},timeToShowOffer:function(e){if(!e)return 0;var t=null,o=e.offer_to,i=e.route;for(var r in o){var n=this.getGPSDistance(e.route.pickup_lat,e.route.pickup_lon,o[r].lat,o[r].lon),a=n/s.driverSpeedMPH*60;null==t?t=a:t>a&&(t=a)}var u=moment(i.selectDate+" "+i.selectTime,"MM/DD/YY hh:mm a"),l=moment(moment().tz(i.timeZone).format("MM/DD/YY hh:mm a"),"MM/DD/YY hh:mm a");if(u.diff(l,"minutes")<s.offerWaitingMin+t)var d=0;else var d=u.diff(l.add({minutes:s.offerWaitingMin+t}));return d},showOfferModal:function(e,o,i,r,n,a,s){var u=this,d=ye[i][o].route;if(!Ze.hasOwnProperty(""+i+","+o)){var c=u.timeToShowOffer(a);if(pt[window.localStorage.getItem("apikeypublic")]&&pt[window.localStorage.getItem("apikeypublic")][i])var f=pt[window.localStorage.getItem("apikeypublic")][i].settings;D.offerCountDown=s||f&&f.offer||D.offerTime,D.offerMaxTime=f&&f.offer||D.offerTime,Ze[""+i+","+o]=P(function(){if(delete Ze[""+i+","+o],ye.hasOwnProperty(i)&&ye[i].hasOwnProperty(o)){if(D.isOffline||"offer"!=ye[i][o].route.status||Y||u.isViewing("offerModal"))return void(vt=!1);var e=u.getGPSDistance(parseFloat(ye[i][o].route.pickup_lat),parseFloat(d.pickup_lon),D.lat,D.lon),r=D.allow_reoffer?u.mergedInboxObj(ye[i][o]):ye[i][o],n=u.getIdOffered(r);!function(r){r&&(Me.hasOwnProperty(r.zoneId)||(Me[r.zoneId]=[]),Me[r.zoneId].push(r.routeId));var n=ye[i][o].route;D.offerDetail={},D.offerDetail.id=n.id,D.offerDetail.zone_id=n.zone_id,D.offerDetail.pickup=n.pickup,D.offerDetail.pickup_lat=n.pickup_lat,D.offerDetail.pickup_lon=n.pickup_lon,D.offerDetail.dropoff=n.dropoff,D.offerDetail.selectService=n.selectService,D.offerDetail.selectPeople=n.selectPeople,D.offerDetail.selectDate=n.selectDate,D.offerDetail.selectTime=n.selectTime,D.offerDetail.route_distance=parseFloat(n.route_distance).toFixed(2),D.offerDetail.distance_pickup=parseFloat(e).toFixed(2),D.offerDetail.price=n.price,D.offerDetail.group_pic=bt[wt[n.group_id].groupPosition].pic,n.hasOwnProperty("tip")&&(D.offerDetail.price=(n.price*(1+n.tip/100)).toFixed(1)),D.offerDetail.note=n.note,D.offerDetail.group_name=n.group_name,function(e){D.offerModal=!0,D.offeraccordion={},D.items=[];var o=["DETAIL","PICKUP","DROPOFF","SERVICE","SEATS","ROUTE","DATE_TIME","MILES","PICKUP_DISTANCE","NOTES"];l(o).then(function(e){u.getGoogleDistTime({lat:D.offerDetail.pickup_lat,lon:D.offerDetail.pickup_lon},{lat:D.lat,lon:D.lon}).then(function(t){D.items.push({label:e.PICKUP_DISTANCE,text:t.dist}),D.items.push({label:e.DATE_TIME,text:t.timeText}),"quote"==D.offerDetail.mode&&D.items.push({label:e.PRICE,text:D.offerDetail.price})}),D.offeraccordion.heading=e.DETAIL}),D.openDetail=function(e){"IMG"!==e.target.nodeName&&(D.isToggled=!D.isToggled)},w.fromTemplateUrl("modals/offer.html",{backdropClickToClose:!1,hardwareBackButtonClose:!1,scope:D}).then(function(o){if(D.offerModal=o,o.show(),D.showOfferCounter=!0,e){var i=C.child(e.zoneId+"/inbox/"+e.routeId),r={lat:D.lat,lon:D.lon,update_time:moment.utc().format("MM/DD/YYYY HH:mm:ss"),offer_to_not:window.localStorage.getItem("apikeypublic")},n=i.child("offer_to_not").push(),a=n.key(),s={};s["offer_to_not/"+a]=r,i.update(s,function(o){if(o)u.removeModalPopup(D,"offerModal"),ue=!1,u.processFirebase();else{if(i.transaction(function(t){return t&&t.offer_to?(1==Object.keys(t.offer_to).length?t.offer_to="":delete t.offer_to[e.key],t):void 0},function(e,t,o){}),dt.forEach(function(t){C.child(t+"/queue/"+window.localStorage.getItem("apikeypublic")+"/quote_id").set(e.routeObj.quote_id)}),!D.offerModal||D.bookingOut.indexOf(e.zoneId)>-1||!rt[e.zoneId])return;D.offerModal.show(),"app.trip-detail"==D.history.currentStateName()&&t.goBack();var r=u.getInboxesByQuoteId(e.routeObj.quote_id);r.forEach(function(e){var t=u.getIdOffered(ye[e.group_id][e.id]);t&&u.offer(bt[wt[t.zoneId].position],t.routeId,t.key,-4,"default","","",e.group_id)})}})}}),u.changeGroupStatus(bt[wt[i].position],-4)}(r);var a=pt[window.localStorage.getItem("apikeypublic")]&&pt[window.localStorage.getItem("apikeypublic")][i]&&pt[window.localStorage.getItem("apikeypublic")][i].settings,d=s||a&&a.offer||D.offerTime;D.jailTimer=P(function(){ue=!0,null==D.offerModal||se||(u.removeModalPopup(D,"offerModal"),u.sendToJail(i),ue=!1)},1e3*d),D.showLoader=!1,u.ringTone(-1),u.addNotification("offer")}(n)}},c+n+r)}},getOfferNotId:function(e,t,o){if(""!=ye[e][t].offer_to_not&&("offer"==ye[e][t].route.status||o))for(var i in ye[e][t].offer_to_not)if(ye[e][t].offer_to_not[i].offer_to_not==window.localStorage.getItem("apikeypublic"))return{routeObj:ye[e][t].route,zoneId:e,routeId:t,key:i,update_time:ye[e][t].offer_to_not[i].update_time}},getOfferNotKeys:function(){var e=[];for(var t in ye)for(var o in ye[t])if(""!=ye[t][o].offer_to_not&&"quote"==ye[t][o].route.status)for(var i in ye[t][o].offer_to_not)ye[t][o].offer_to_not[i].offer_to_not==window.localStorage.getItem("apikeypublic")&&"quoteshown"==ye[t][o].offer_to_not[i].status&&e.indexOf("offer_to_not[]="+i)<0&&e.push("offer_to_not["+t+"][]="+i);return e},getOfferId:function(e,t,o){if(ye[e].hasOwnProperty(t)&&""!=ye[e][t].offer_to&&ye[e][t].hasOwnProperty("route")&&("offer"==ye[e][t].route.status||o))for(var i in ye[e][t].offer_to)if(ye[e].hasOwnProperty(t)&&ye[e][t].hasOwnProperty("offer_to")&&ye[e][t].offer_to[i].offer_to==window.localStorage.getItem("apikeypublic"))return{routeObj:ye[e][t].route,zoneId:e,routeId:t,key:i}},getIdOffered:function(e){if(""!=e.offer_to&&e.hasOwnProperty("route")&&"offer"==e.route.status)for(var t in e.offer_to)if(e.hasOwnProperty("offer_to")&&e.offer_to[t].offer_to==window.localStorage.getItem("apikeypublic"))return{routeObj:e.route,zoneId:e.offer_to[t].group_id,routeId:e.offer_to[t].inbox_id,key:t}},getOfferPosition:function(e,t,o){var i=this,r=o&&o.route||ye[t][e].route,n=o&&o.offer_to||ye[t][e].offer_to,a=o&&o.offer_to_not||ye[t][e].offer_to_not,s=(r&&r.pickupZonesArr||[],this.getDriversOfferedOtherQuote(n,r.quote_id)),u=-1,l={},d=function(e){if("average"==e){for(var t in n)if(ft[n[t].group_id]&&ft[n[t].group_id][n[t].offer_to]){l[n[t].offer_to]||(l[n[t].offer_to]={},l[n[t].offer_to].pos=0,l[n[t].offer_to].avg=0,l[n[t].offer_to].length=0);var o=l[n[t].offer_to].avg*l[n[t].offer_to].length+ft[n[t].group_id][n[t].offer_to].timestamp,i=l[n[t].offer_to].pos*l[n[t].offer_to].length+ft[n[t].group_id][n[t].offer_to].position;l[n[t].offer_to].length++,l[n[t].offer_to].avg=o/l[n[t].offer_to].length,l[n[t].offer_to].pos=i/l[n[t].offer_to].length}for(var t in a)if(!l[a[t].offer_to_not]&&ft[a[t].group_id]&&ft[a[t].group_id][a[t].offer_to_not]){l[a[t].offer_to_not]||(l[a[t].offer_to_not]={},l[n[t].offer_to].pos=0,l[a[t].offer_to_not].avg=0,l[a[t].offer_to_not].length=0);var o=l[a[t].offer_to_not].avg*l[a[t].offer_to_not].length+ft[a[t].group_id][a[t].offer_to_not].timestamp,i=l[n[t].offer_to].pos*l[n[t].offer_to].length+ft[n[t].group_id][n[t].offer_to].position;l[a[t].offer_to_not].length++,l[a[t].offer_to_not].avg=o/l[a[t].offer_to_not].length,l[n[t].offer_to].pos=i/l[n[t].offer_to].length}}else{for(var t in n)ft[n[t].group_id]&&ft[n[t].group_id][n[t].offer_to]&&(l[n[t].offer_to]?ft[n[t].group_id][n[t].offer_to].timestamp<l[n[t].offer_to].avg&&(l[n[t].offer_to].avg=ft[n[t].group_id][n[t].offer_to].timestamp):(l[n[t].offer_to]={},l[n[t].offer_to].avg=ft[n[t].group_id][n[t].offer_to].timestamp));for(var t in a)!l[a[t].offer_to_not]&&ft[a[t].group_id]&&ft[a[t].group_id][a[t].offer_to_not]&&(l[a[t].offer_to_not]?ft[a[t].group_id][a[t].offer_to_not].timestamp<l[a[t].offer_to_not].avg&&(l[a[t].offer_to_not].avg=ft[a[t].group_id][a[t].offer_to_not].timestamp):(l[a[t].offer_to_not]={},l[a[t].offer_to_not].avg=ft[a[t].group_id][a[t].offer_to_not].timestamp))}};if(o.route.inboxArr.length>1){var c,f,p,m=i.getGPSDistance(r.pickup_lat,r.pickup_lon,ct[t][window.localStorage.getItem("apikeypublic")].lat,ct[t][window.localStorage.getItem("apikeypublic")].lon),g=m>r.range;if(d("average"),!l[window.localStorage.getItem("apikeypublic")])return 10;var _=l[window.localStorage.getItem("apikeypublic")].avg,h=l[window.localStorage.getItem("apikeypublic")].pos;for(var v in n){var t=n[v].group_id;n[v].offer_to!=window.localStorage.getItem("apikeypublic")&&ft[n[v].group_id]&&ft[n[v].group_id].hasOwnProperty(n[v].offer_to)&&(""==ft[n[v].group_id][n[v].offer_to].quote_id||"Offered"==ft[n[v].group_id][n[v].offer_to].quote_id)&&s.indexOf(n[v].offer_to)<0&&(c=i.getGPSDistance(r.pickup_lat,r.pickup_lon,ct[t][n[v].offer_to].lat,ct[t][n[v].offer_to].lon),f=l[n[v].offer_to].avg,p=l[n[v].offer_to].pos,g?(c<=Number(r.range)||m>c)&&u++:c<=Number(r.range)&&(_>f||f==_&&h>p)&&u++)}return u}var y=function(){var e,o,a,l=ft[t][window.localStorage.getItem("apikeypublic")].timestamp,d=ft[t][window.localStorage.getItem("apikeypublic")].position,c=i.getGPSDistance(r.pickup_lat,r.pickup_lon,ct[t][window.localStorage.getItem("apikeypublic")].lat,ct[t][window.localStorage.getItem("apikeypublic")].lon),f=c>r.range;for(var p in n)ft[t].hasOwnProperty(n[p].offer_to)&&"offerdeclined"!=n[p].status&&ft[t][n[p].offer_to]&&(e=ft[t][n[p].offer_to].timestamp,o=ft[t][n[p].offer_to].position,n[p].offer_to!=window.localStorage.getItem("apikeypublic")&&(""==ft[t][n[p].offer_to].quote_id||"Offered"==ft[t][n[p].offer_to].quote_id)&&s.indexOf(n[p].offer_to)<0&&(a=i.getGPSDistance(r.pickup_lat,r.pickup_lon,ct[t][n[p].offer_to].lat,ct[t][n[p].offer_to].lon),f?(a<=Number(r.range)||c>a)&&u++:a<=Number(r.range)&&(l>e||e==l&&d>o)&&u++));return u};return""!=n&&1==Object.keys(n).length&&""!=ye[t][e].offer_to_not&&0==Object.keys(ye[t][e].offer_to_not).length?-1:y()},getOfferClosestTime:function(e,t){var o=this,i=T.defer(),r=ye[t][e].route,n=ye[t][e].offer_to,a=null,s=0;for(var u in n)!function(e){s++,ct[t].hasOwnProperty(n[u].offer_to)?o.getGoogleDistTime({lat:r.pickup_lat,lon:r.pickup_lon},{lat:ct[t][n[e].offer_to].lat,lon:ct[t][n[e].offer_to].lon}).then(function(e){null==a?a=e.timeVal:e.timeVal<a&&(a=e.timeVal),s==Object.keys(n).length&&i.resolve(a)},function(e){i.reject(e)}):s==Object.keys(n).length&&i.resolve(a)}(u);return i.promise},showQuoteModal:function(e,t){var o=this;ie=!0,w.fromTemplateUrl("modals/quote.html",{scope:D,animation:"slide-in-up",backdropClickToClose:!1,hardwareBackButtonClose:!1}).then(function(t){D.quote_modal=t,P(function(){we.hasOwnProperty(e.id)?(D.bookingOut.indexOf(e.group_id)>-1||!rt[e.group_id]?o.quoteModalCleanUp():t.show(),o.ringTone(-1)):o.quote(D.quotes,-3).then(function(){D.bookingOut.indexOf(e.group_id)>-1||!rt[e.group_id]?o.quoteModalCleanUp():t.isShown()||(t.show(),o.ringTone(-1),o.addNotification())})},3e3)});var i='<ion-popover-view style="height: 60px;"><ion-content><ion-list><ion-item ng-click="showCancelTripModal(false)">Cancel</ion-item></ion-list></ion-content></ion-popover-view>';D.popoverQuote=b.fromTemplate(i,{scope:D}),D.showPopoverQuote=function(e){D.popoverQuote.show(e),D.showCancelTripModal()},D.confirmQuote=function(e,t){He=!0,D.showLoader=!0,ke&&o.ringTone();var i=e?3:-3,r=[],n=[];for(var a in D.quotes){var s=D.quotes[a];-3==i?r.push(D.quotes[a]):s.enabled&&r.push(D.quotes[a]),f.quoteID.indexOf(s.quote_id)<0&&f.quoteID.push(s.quote_id);var d=D.quotes[a].zone_id,c=D.quotes[a].id;if(n.push("quoteid[]="+D.quotes[a].whmcs),"undefined"!=typeof ye[d]&&!ye[d].hasOwnProperty(c)||"undefined"!=typeof ye[d]&&"quote"!=ye[d][c].route.status)return o.quoteModalCleanUp(),void l(["SORRY","DRIVER_LATE_QUOTE"]).then(function(e){u.error(e.DRIVER_LATE_QUOTE,e.SORRY)})}var p=function(){o.quote(r,i,t).then(function(){o.quoteModalCleanUp(),V&&V(),H&&H()},function(){D.$broadcast("loading:hide"),l(["SOMETHING_WRONG","FAILED"]).then(function(e){O.alert({title:e.FAILED,template:e.SOMETHING_WRONG})})})};D.$broadcast("loading:show"),-3==i?o.cancelQuote(n).then(function(){p()},function(){D.$broadcast("loading:hide"),l(["SOMETHING_WRONG","FAILED"]).then(function(e){O.alert({title:e.FAILED,template:e.SOMETHING_WRONG})})}):p()},D.checkAllQuote=function(e){for(var t=0;t<D.quotes.length;t++)D.quotes[t].enabled=e},D.isChecked=function(){for(var e in D.quotes){var t=D.quotes[e];if(t.enabled)return!0}return!1},D.cancel={},l(["REASON1","REASON2","CUSTOM_MESSAGE","CANCEL_QUOTE"]).then(function(e){D.cancelreasons=[{text:e.REASON1,val:e.REASON1},{text:e.REASON2,val:e.REASON2},{text:e.CUSTOM_MESSAGE,val:e.CUSTOM_MESSAGE}],D.cancelTitle=e.CANCEL_QUOTE,D.customMessage=e.CUSTOM_MESSAGE}),D.reasonNotSelected=!0,D.otherSelected=!0,D.showCancelTripModal=function(){ke&&o.ringTone(),D.cancelTripModal?(D.popoverQuote.hide(),D.cancelTripModal.show()):w.fromTemplateUrl("modals/trip-cancel.html",{scope:D}).then(function(e){D.cancel={},D.reasonNotSelected=!0,D.otherSelected=!0,D.cancelTripModal=e,r()})},D.removeCancelModal=function(){o.removeModalPopup(D,"cancelTripModal"),V&&V(),H&&H()};var r=function(){H=D.$watch("cancel.default",function(e,t,o){D.customMessage&&e==D.customMessage?(D.otherSelected=!1,D.reasonNotSelected=!0):void 0!=e&&(D.otherSelected=!0,D.reasonNotSelected=!1)}),V=D.$watch("cancel.other",function(e,t,o){void 0==e?D.reasonNotSelected=!0:""!=e.trim()&&(D.reasonNotSelected=!1)})};D.cancelTap=function(e){if(D.otherSelected||(e.$submitted=!0),D.otherSelected||e.$valid){var t=o.getOfferNotKeys();D.confirmQuote(!1,t)}}},checkPrice:function(){if(void 0!=D.rates[0]&&this.withinExpiryTime(this.getFBData()[D.rates[0].zone_id[0]][D.rates[0].quoteId]))if("offer"==D.rates[0].mode){var e={rate_id:D.rates[0].value,price:D.rates[0].price,zone_id:D.rates[0].zone_id,id:D.rates[0].quoteId,summary:D.rates[0].summary};D.loggedIn&&this.showOrderForm(e)}else if(null!=D.priceModal)for(var t=0;t<D.rates.length;t++)if(D.rates[t].value==D.selectedRate.rate_id){var e={rate_id:D.selectedRate.rate_id,price:D.rates[t].price,zone_id:D.rates[t].zone_id,id:D.rates[t].quoteId,summary:D.rates[t].summary};this.showPriceModal(),D.loggedIn&&this.showOrderForm(e);break}},showPriceModal:function(){re=!0,delete fe[D.rates[0].quote_id];var e=this;D.selectedRate={},w.fromTemplateUrl("modals/rate.html",{scope:D,animation:"slide-in-up",backdropClickToClose:!1,hardwareBackButtonClose:!1}).then(function(t){D.priceModal=t,D.$broadcast("quoteaccepted"),D.$broadcast("loading:hide"),t.show(),0==D.rates.length&&D.$broadcast("loading:show"),e.addNotification("rate")});var t=["DETAIL","PRICE","PICKUP","DROPOFF","SERVICE","SEATS","ROUTE","DATE_TIME","MILES","NOTES"];l(t).then(function(e){D.accordion={};var t=ye[D.rates[0].zone_id[0]][D.rates[0].quoteId].route;D.items=[{label:e.PICKUP,text:t.pickup},{label:e.DROPOFF,text:t.dropoff},{label:e.SERVICE,text:t.selectService},{label:e.SEATS,text:t.selectPeople},{label:e.ROUTE,text:t.route_distance+" "+e.MILES},{label:e.DATE_TIME,text:t.selectDate+" "+t.selectTime}],t.note.length>0&&""!=t.note[Object.keys(t.note)[0]]&&D.items.push({label:e.NOTES,text:t.note[Object.keys(t.note)[0]]}),D.accordion.heading=e.DETAIL});var o=function(){for(var e=0;e<D.rates.length;e++)if(D.rates[e].value==D.selectedRate.rate_id){var t={rate_id:D.selectedRate.rate_id,zone_id:D.rates[e].zone_id,group_id:D.rates[e].group_id,pickup_zone:D.rates[e].pickup_zone,price:D.rates[e].price,id:D.rates[e].quoteId,summary:D.rates[e].summary};break}return t};D.confirmRate=function(){return D.popoverPrice.hide(),U&&(U(),U=null),ke&&e.ringTone(),void 0==window.localStorage.getItem("apikeypublic")?(D.priceModal.hide(),yt=!0,re=!1,void q.transitionTo("app.login")):void e.showOrderForm(o())},D.openOrderForm=function(){D.loggedIn&&e.showOrderForm(o())},this.cancelQuoteCustomer()},cancelQuoteCustomer:function(){var e=this,t='<ion-popover-view style="height: 60px;"><ion-content><ion-list><ion-item ng-click="showCancelTripModal()">Cancel</ion-item></ion-list></ion-content></ion-popover-view>';D.popoverPrice=b.fromTemplate(t,{scope:D}),D.showPopoverPirce=function(e){D.popoverPrice.show(e),D.showCancelTripModal()},U||(U=D.$watch("selectedRate.rate_id",function(e,t,o){void 0!=e?D.rateNotSelected=!1:D.rateNotSelected=!0})),D.cancelRate=function(){ke&&e.ringTone(),e.removeModalPopup(D,"popoverPrice"),e.removeModalPopup(D,"priceModal"),U&&(U(),U=null),re=!1},D.cancel={},l(["MESSAGE_CANCEL_CUSTOMER1","MESSAGE_CANCEL_CUSTOMER3","MESSAGE_CANCEL_CUSTOMER4","CUSTOM_MESSAGE","CANCEL_QUOTE"]).then(function(e){D.cancelreasons=[{text:e.MESSAGE_CANCEL_CUSTOMER1,val:e.MESSAGE_CANCEL_CUSTOMER1},{text:e.MESSAGE_CANCEL_CUSTOMER3,val:e.MESSAGE_CANCEL_CUSTOMER3},{text:e.MESSAGE_CANCEL_CUSTOMER4,val:e.MESSAGE_CANCEL_CUSTOMER4},{text:e.CUSTOM_MESSAGE,val:e.CUSTOM_MESSAGE}],D.cancelTitle=e.CANCEL_QUOTE,D.customMessage=e.CUSTOM_MESSAGE}),D.reasonNotSelected=!0,D.otherSelected=!0,D.showCancelTripModal=function(){ke&&e.ringTone(),U&&(U(),U=null),D.cancelTripModal?(D.popoverPrice.hide(),D.cancelTripModal.show()):w.fromTemplateUrl("modals/trip-cancel.html",{scope:D}).then(function(e){D.cancel={},D.reasonNotSelected=!0,D.otherSelected=!0,D.cancelTripModal=e,o()})},D.removeCancelModal=function(){e.removeModalPopup(D,"cancelTripModal"),H&&H(),V&&V()};var o=function(){H=D.$watch("cancel.default",function(e,t,o){D.customMessage&&e==D.customMessage?(D.otherSelected=!1,D.reasonNotSelected=!0):void 0!=e&&(D.otherSelected=!0,D.reasonNotSelected=!1)}),V=D.$watch("cancel.other",function(e,t,o){void 0==e?D.reasonNotSelected=!0:""!=e.trim()&&(D.reasonNotSelected=!1)})};D.cancelTap=function(t){if(D.otherSelected||(t.$submitted=!0),D.otherSelected||t.$valid){for(var o=D.otherSelected?D.cancel["default"]:D.cancel.other,i=[],r=[],n=[],a=0;a<D.rates.length;a++){i.push("quote_id[]="+D.rates[a].quoteId),n.push("quote_id[]="+D.rates[a].whmcs),f.quoteID.push(D.rates[a].quoteId);for(var s=0;s<D.rates[a].zone_id.length;s++)r.indexOf(D.rates[a].zone_id[s])<0&&r.push("zone_id[]="+D.rates[a].zone_id[s])}var u=e.inboxesWithQuoteId(null,D.rates[0].quote_id,null),d={tripID:"",msg:o,status:-5,inbox:u};e.trip(d).then(function(t){D.$broadcast("loading:hide"),e.orderModalCleanUp(),e.removeModalPopup(D,"cancelTripModal"),H&&H(),V&&V()},function(){D.$broadcast("loading:hide"),l(["SOMETHING_WRONG","FAILED"]).then(function(e){O.alert({title:e.FAILED,template:e.SOMETHING_WRONG})})})}}},showLoginModal:function(){w.fromTemplateUrl("modals/login.html",{backdropClickToClose:!1,hardwareBackButtonClose:!1}).then(function(e){D.loginModal=e,e.show()})},showOrderForm:function(e){var t=this;D.$broadcast("loading:hide"),D.$broadcast("quoteaccepted"),D.isAccordToggled=!0,D.openDetail=function(e){"IMG"!==e.target.nodeName&&P(function(){D.isAccordToggled=!D.isAccordToggled})},t.cancelQuoteCustomer(),yt=!0,re=!1,D.tripSummary=e.summary,D.paymentChoice={};var o=[];null!=f.stripe?(f.stripe.forEach(function(e,t){null!=e.token&&o.push(e)}),o.reverse()):f.stripe=[],D.creditCards=o,D.haveCreditCard=D.creditCards.length>0,D.paymentChoice.choice=D.haveCreditCard?"card":"cash",D.newCard=!1,D.orderBackBtn=!1,D.cardForm=!1,D.showCardForm=function(e){D.newCardForm=!1,D.orderBackBtn=e,D.cardForm=e,!D.haveCreditCard&&e?D.showNewCardForm():(D.newCard&&D.haveCreditCard&&(D.cardForm=!0,D.orderBackBtn=!0),D.newCard=!1),D.creditCards.length>0?("new card"!=D.paymentMethod&&(D.paymentMethod="card"),D.paymentNotSelected=!1):D.paymentNotSelected=!0},D.showNewCardForm=function(){var e=d._instances,t=_(e).find(function(e){return"payment-page"===e.$element[0].id});t.scrollTop(!0),D.newCard=!0,D.paymentNotSelected=!0,D.newCardForm=!0},D.selectedCard={};var i=function(){if(D.creditCards.length>0){var e=n("filter")(D.creditCards,{token:"!null"})[0];D.selectedCard.token=e.token,D.selectedCard.brand=e.brand,D.selectedCard.last4=e.last4,e.hasOwnProperty("newcard")&&(D.selectedCard.newcard=e.newcard)}};i(),D.orderModal?D.orderModal.show():w.fromTemplateUrl("modals/stripeform.html",{scope:D,animation:"slide-in-up",backdropClickToClose:!1,hardwareBackButtonClose:!1}).then(function(e){D.orderModal=e,t.countDownTimer(),e.show()}),D.range={},e.tip=0,D.range.tip=e.tip,D.priceWithTip=e.price,D.tipCalculate=function(t){e.tip=t,D.priceWithTip=(e.price*(1+t/100)).toFixed(1)};var r=["DETAIL","PRICE","PICKUP","DROPOFF","SERVICE","SEATS","ROUTE","DATE_TIME","MILES","NOTES"];l(r).then(function(e){D.accordion={},D.items=[{label:e.PRICE,text:D.tripSummary.price},{label:e.PICKUP,text:D.tripSummary.pickup},{label:e.DROPOFF,text:D.tripSummary.dropoff},{label:e.SERVICE,text:D.tripSummary.selectService},{label:e.SEATS,text:D.tripSummary.selectPeople},{label:e.ROUTE,text:D.tripSummary.route_distance+" "+e.MILES},{label:e.DATE_TIME,text:D.tripSummary.selectDate+" "+D.tripSummary.selectTime}],D.tripSummary.note.length>0&&""!=D.tripSummary.note[Object.keys(D.tripSummary.note)[0]]&&D.items.push({label:e.NOTES,text:D.tripSummary.note[Object.keys(D.tripSummary.note)[0]]}),D.accordion.heading=e.DETAIL}),D.paymentNotSelected=!1,D.cashSelected=function(){D.paymentNotSelected=!1,D.paymentMethod="cash"},D.saveDateTime=function(e){D.creditcard.expiry=moment(new Date(e)).format("MM/YYYY")},D.cardSelected=function(e){D.showCardForm(!1),D.selectedCard=e,e.hasOwnProperty("newcard")&&(D.selectedCard.newcard=e.newcard)},D.haveCreditCard?D.cardSelected(D.creditCards[0]):D.cashSelected(),D.newCardForm=!1;var a;D.newCardDone=function(e){if(a=e,e.$submitted=!0,e.$valid){D.$broadcast("loading:show");var t=D.creditcard.expiry;D.creditcard.expmonth=moment(t,"MM/YYYY").format("MM"),D.creditcard.expyear=moment(t,"MM/YYYY").format("YYYY"),Stripe.createToken({name:D.creditcard.name,number:D.creditcard.number,cvc:D.creditcard.cvc,exp_month:parseInt(D.creditcard.expmonth),exp_year:parseInt(D.creditcard.expyear)},s)}};var s=function(t,o){if(o.error)D.$broadcast("loading:hide"),l("FAILED").then(function(e){O.alert({title:e,template:o.error.message})});else{var r=o.id;e.token=JSON.stringify(o),r&&(D.$broadcast("loading:hide"),ve.push(JSON.stringify(o)),D.creditCards.unshift({newcard:e.token,brand:o.card.brand,exp_month:o.card.exp_month,exp_year:o.card.exp_year,last4:o.card.last4,name:o.card.name,token:o.id}),D.haveCreditCard=!0,D.paymentNotSelected=!1,f.stripe=D.creditCards.slice(0).reverse(),i(),D.paymentMethod="new card",D.newCardForm=!1,D.showCardForm(!1),D.paymentNotSelected=!1,e.paymentMethod="Card",D.creditcard={},a.$setPristine())}},c=function(e){e.opts=[],e.optIn=[],D.allow_reoffer||e.optIn.push("optIn[]=/"+e.zone_id+"/inbox/"+e.id);
for(var o in ye)for(var i in ye[o])ye[o][i].route.quote_id==ye[e.zone_id][e.id].route.quote_id&&(e.opts.push("opts[]=/"+o+"/inbox/"+i),D.allow_reoffer&&ye[o][i].route.price==e.price&&e.optIn.indexOf("/"+o+"/")<0&&e.optIn.push("optIn[]=/"+o+"/inbox/"+i));t.order(e).then(function(){e.token.length>40&&f.stripe&&f.stripe.forEach(function(t,o){t.hasOwnProperty("newcard")&&t.newcard==e.token&&delete f.stripe[o].newcard}),P(function(){t.orderModalCleanUp()},2e3),P(function(){t.timeToShowOffer(ye[e.zone_id[0]][e.id])>0&&l(["SUCCESS","OFFER_SCHEDULED"]).then(function(e){D.$broadcast("loading:hide"),u.success(e.OFFER_SCHEDULED,e.SUCCESS)})},1e3)},function(){D.$broadcast("loading:hide"),l(["SOMETHING_WRONG","FAILED"]).then(function(e){O.alert({title:e.FAILED,template:e.SOMETHING_WRONG})})})};D.cancel_order=function(){D.selectedRate,t.removeModalPopup(D,"orderModal"),yt=!1,D.showInnerCountDown=!1,D.innerCountDown=void 0},D.creditcard={},D.charge=function(){return D.paymentNotSelected?void l(["NO_CARD","SORRY"]).then(function(e){u.info(e.NO_CARD,e.SORRY)}):(D.$broadcast("loading:show"),void t.areOfferDriversAvailable(e.zone_id[0],e.id,e.pickup_zone,e.group_id).then(function(o){if(!o&&0==t.timeToShowOffer(ye[e.zone_id[0]][e.id])){It=!0;for(var i=[],r=0;r<D.rates.length;r++){var n=D.rates[r].zone_id[0],a=D.rates[r].id;i.push({quote_id:a,zone_id:n}),ye[n][a].route.pickup_zone!=n&&i.push({quote_id:a,zone_id:ye[n][a].route.pickup_zone}),ye[n][a].route.zone_id!=ye[n][a].route.group_id&&i.push({quote_id:a,zone_id:ye[n][a].route.group_id})}return t.deleteInbox(i).then(function(){It=!1},function(e){}),l(["CURRENTLY_NO_DRIVERS","SORRY"]).then(function(e){D.$broadcast("loading:hide"),u.error(e.CURRENTLY_NO_DRIVERS,e.SORRY)}),void t.orderModalCleanUp()}D.$broadcast("loading:show"),"cash"==D.paymentMethod?(e.token="cash",e.paymentMethod="Cash",c(e)):(e.paymentMethod="Card",D.selectedCard.hasOwnProperty("newcard")?e.token=JSON.stringify(D.selectedCard.newcard).replace(/\\/g,"").slice(1,-1):e.token=D.selectedCard.token,c(e))}))}},setCategoryGroups:function(){if(null!=W)for(var e,t,o,i,r=0,n=0;n<W.length;n++)W[n].dispatcher>0?(r=n,e=W[n].booked,t=W[n].can_bookin,o=W[n].status,i=W[n].zone_id,!t&&W[n].tags.indexOf("Driver")>-1&&(W[0].hasDriver=!0)):""!=W[n].apikeypublic&&(B.hasOwnProperty(W[n].apikeypublic)||(B[W[n].apikeypublic]={}),B[W[n].apikeypublic][W[n].zone_id]=W[n],B[W[n].apikeypublic][W[n].category_id]=W[n],W[n].tags.indexOf("Driver")>-1&&(W[0].hasDriver=!0)),W[0].hasDriver||(W[0].hasDriver=!1),""!=W[n].apikeypublic&&W[n].apikeypublic!=window.localStorage.getItem("apikeypublic")?W[0].hasOtherItems=!0:W[0].hasOtherItems||(W[0].hasOtherItems=!1)},setGroups:function(){var e=this,t=[];if(null!=bt){for(var o,i,r,n,a,s=0,u=0;u<bt.length;u++)"My A2Bers"!=bt[u].name&&(bt[u].hasOwnProperty("can_bookin")&&(s=u,o=bt[u].booked,i=bt[u].can_bookin,r=bt[u].status,n=bt[u].zone_id,a=bt[u].category_id!=bt[u].zone_id),bt[u].apikeypublic==window.localStorage.getItem("apikeypublic")&&(bt[u].hasOwnProperty("can_bookin")?(bt[s].iscustomer=0,(bt[u].dispatcher>0||bt[u].user_id==f.user_id)&&(wt[bt[u].zone_id]={id:bt[u].id,category_id:bt[u].category_id,item_id:bt[u].item_id,status:r,booked:o,can_bookin:i,position:u,groupPosition:s,withinzone:a,zone_id:n,tags:bt[u].tags},wt[n]={id:bt[u].id,category_id:bt[u].category_id,item_id:bt[u].item_id,status:r,booked:o,can_bookin:i,position:u,groupPosition:s,withinzone:a,zone_id:n,tags:bt[u].tags}),1==bt[u].active&&(bt[u].can_bookin>0||f.user_id==bt[u].user_id)?(bt[u].can_toggle=1,bt[u].dispatcherlink="#/app/employee/"+bt[u].category_id+"/dispatcher"):(bt[u].can_toggle=0,bt[u].dispatcherlink="#/app/employee"),bt[u].isOwner=bt[u].user_id==f.user_id):(bt[u].dispatcher<1&&(wt[bt[u].zone_id]={id:bt[u].id,category_id:bt[u].category_id,zone:bt[u].zone,item_id:bt[u].item_id,status:r,booked:o,can_bookin:i,position:u,groupPosition:s,withinzone:a,zone_id:n,tags:bt[u].tags},wt[n]={id:bt[u].id,category_id:bt[u].category_id,zone:bt[u].zone,item_id:bt[u].item_id,status:r,booked:o,can_bookin:i,position:u,groupPosition:s,withinzone:a,zone_id:n,tags:bt[u].tags},bt[s].withinzone=!0,bt[s].my_tags=bt[u].tags,bt[s].allow_queue=bt[s].settings&&"yes"==bt[s].settings.allow_queue||D.allow_queue,bt[s].require_upload=bt[s].settings&&bt[s].settings.settings&&bt[s].settings.settings.indexOf("rquire_uppload")>-1||D.rquire_uppload,bt[s].biddable=bt[s].settings&&bt[s].settings.settings&&bt[s].settings.settings.indexOf("biddable")>-1||D.biddable),1==bt[u].active&&1==bt[s].active?(bt[u].tags.indexOf("Driver")>-1||bt[u].tags.indexOf("Admin")>-1||bt[u].tags.indexOf("Dispatcher")>-1?(bt[s].mode||(bt[s].mode=D.partnersQMode),bt[s].can_toggle=1,bt[s].isDriver=bt[u].tags.indexOf("Driver")>-1):bt[s].can_toggle=0,bt[s].dispatcherlink="#/app/employee/"+bt[s].category_id+"/dispatcher"):(bt[s].can_toggle=0,bt[s].dispatcherlink="#/app/employee"),bt[u].tags.indexOf("Customer")>-1?bt[s].iscustomer=1:bt[s].iscustomer=0,bt[u].isOwner=bt[s].isOwner),st.indexOf(bt[u].category_id)<0&&t.push(bt[u].category_id)));t.length>0&&t.forEach(function(t){e.initFirebase(t)});var l=!1,d=!1,c=1e4,p=!1;for(var n in wt)n==bt[wt[n].groupPosition].category_id&&((void 0==bt[wt[n].groupPosition]||void 0==bt[wt[n].position])&&(delete wt[n],D.$broadcast("firebase:updated")),wt.hasOwnProperty(n)&&st.indexOf(wt[n].category_id)>-1&&wt[n].category_id!=n&&(wt[st[st.indexOf(wt[n].category_id)]]=wt[n]),wt[n].can_bookin>0&&wt[n].booked,wt[n].can_bookin>0&&wt[n].booked&&bt[wt[n].groupPosition].QP&&bt[wt[n].groupPosition].QP.toString().indexOf("/")>-1?(p||(l=!0),d=!0,c>wt[n].category_id&&(c=wt[n].category_id)):(l=!1,p=!0));if(D.listenedQueue&&!L&&!D.detail&&!It){var m=D.tappedGroup&&wt[D.tappedGroup.category_id];l?((!D.hasDriverQP&&"app.employee-index"==D.history.currentStateName()||"app.login"==D.history.currentStateName())&&q.transitionTo("app.driver-home"),D.hasDriverQP=l,D.driverHomeGroup=bt[wt[c].position]):(!m||m&&(!m.booked||m.booked&&bt[m.groupPosition].QP&&bt[m.groupPosition].QP.toString().indexOf("/")<0))&&(D.hasDriverQP=l,D.tappedGroup=null,"app.driver-home"==D.history.currentStateName()&&q.transitionTo("app.employee-index")),D.hasOneDriverQP=d,d&&(D.driverHomeGroup=bt[wt[c].position])}"app.employee-dispatcher"!=q.current.name||void 0===D.isOwner||0!=D.isOwner||wt[D.history.currentView().url.match(/\d+/)[0]].booked||q.transitionTo("app.employee-index")}},myRatings:function(){var e=T.defer();return x.get(M+"myrating/?"+a.getParams()).success(function(t,o){t.customer&&(D.myDriverRating=f.myDriverRating=t.customer.toFixed(2)),t.driver&&(D.myCustomerRating=f.myCustomerRating=t.driver.toFixed(2)),e.resolve()}).error(function(t){e.reject()}),e.promise},checkForms:function(e,t){if(0==D.myVehicles.length||0==D.myPermits.length||null==D.picData)return void 0==e&&q.transitionTo("app.forms",{vehicle:0==D.myVehicles.length,permit:0==D.myPermits.length}),!1;var o=!1,i=!1;return D.myVehicles.forEach(function(e){moment(e.title_expiry_date).isAfter()&&moment(e.permit_expiry_date).isAfter()&&(o=!0)}),D.myPermits.forEach(function(e){moment(e.permit_expiry_date).isAfter()&&(i=!0)}),o&&i?null!=D.vehiclePermit.vehicle&&null!=D.vehiclePermit.permit&&(moment(D.vehiclePermit.vehicle.permit_expiry_date).isAfter()||moment(D.vehiclePermit.vehicle.title_expiry_date).isAfter()||moment(D.vehiclePermit.permit.permit_expiry_date).isAfter())?(this.showVehiclePermit(t),!1):null==D.vehiclePermit.vehicle||null==D.vehiclePermit.permit?(this.showVehiclePermit(t),!1):!0:(void 0==e&&q.transitionTo("app.forms",{vehicle:!o,permit:!i}),!1)},showVehiclePermit:function(e){var t=this;D.saveVehiclePermit=function(){null!=D.vehiclePermit.permit&&null!=D.vehiclePermit.vehicle&&(D.isExpired(D.vehiclePermit.permit)||D.isExpired(D.vehiclePermit.vehicle)||(null==f.permit&&(f.permit=D.vehiclePermit.permit,f.vehicle=D.vehiclePermit.vehicle,t.toggleBook(e[0],e[1]).then(function(e){})),f.permit=D.vehiclePermit.permit,f.vehicle=D.vehiclePermit.vehicle,t.removeModalPopup(D,"vehiclePermitModal")))},D.vehiclePermit.permit=f.permit,D.vehiclePermit.vehicle=f.vehicle,D.vehiclePermitData={vehicle:D.myVehicles,permit:D.myPermits},D.isExpired=function(e){return e.hasOwnProperty("title_expiry_date")?moment(e.permit_expiry_date).isBefore()||moment(e.title_expiry_date).isBefore():moment(e.permit_expiry_date).isBefore()},D.vehiclePermitModal?D.vehiclePermitModal.show():w.fromTemplateUrl("modals/vehicle_permit.html",{backdropClickToClose:!1,scope:D}).then(function(e){D.vehiclePermitModal=e,e.show(),D.$broadcast("loading:hide")})},getFavGroupId:function(){return qt},itemsApi:function(e,t){var o=T.defer(),i=M+"items/?"+a.getParams(t);return e&&(i+=e),x.get(i).success(function(e,t){o.resolve(e)}).error(function(e){o.reject(e)}),o.promise},findAllEmployees:function(){if(!D.appoverdue){var e=this,t=T.defer(),o=function(i){e.itemsApi("&myitem=true").then(function(o){if("failed"==o.status.toLowerCase())e.setEmployees(null),window.localStorage.getItem("apikeypublic")!=Tt?(Se=!1,"app.employee-index"==D.history.currentStateName()&&q.transitionTo("app.quoteform"),f.isDriver=!1):(Se=!0,f.isDriver=!0),D.$broadcast("user:updated",Se),D.$broadcast("canbookin:updated",qe),t.resolve(o);else{Se=!1,f.isDriver=!1,D.itemNotBooked=null!=D.itemNotBooked&&0!=D.itemBooked?D.itemNotBooked:1;var i=o.items,r=[];if(i.every(function(t,o){if("My A2Bers"==t.name)return qt=t.category_id,!0;if(t.apikeypublic==Tt&&lt.indexOf(t.category_id)<0&&lt.push(t.category_id),t.dispatcher<1&&t.apikeypublic==window.localStorage.getItem("apikeypublic")){if(t.overdue&&t.overdue.app<0)return D.appoverdue=t.overdue.app,!1;(""==t.tags||t.tags.indexOf("Driver")>-1||t.tags.indexOf("Admin")>-1||t.tags.indexOf("Dispatcher")>-1)&&(Se=f.isDriver=!0),t.tags.indexOf("Customer")<0&&(qe=!0)}else t.dispatcher>0&&t.apikeypublic==window.localStorage.getItem("apikeypublic")&&(Se=f.isDriver=!0);return t.hasOwnProperty("can_bookin")?C.child("images/"+t.category_id).once("value",function(o){o.exists()?t.pic=o.val():t.user_id==f.user_id&&f.picData?e.savePic(f.picData,"group",t.category_id).then(function(){},function(e){}):t.pic="img/group_placeholder.jpg",C.child(t.category_id+"/queue/"+window.localStorage.getItem("apikeypublic")+"/pic").once("value",function(e){e.exists()&&t.user_id==f.user_id&&e.val().indexOf("town_car")<0&&(t.pic=e.val(),D.$broadcast("items:loaded"))})}):t.pic="img/person.jpg",!0}),D.appoverdue)return D.hideLoader(),void l(["SORRY","APP_OVERDUE1","APP_OVERDUE2"]).then(function(e){if(ionic.Platform.isWebView()){var t=O.alert({title:e.SORRY,template:e.APP_OVERDUE1+Math.abs(D.appoverdue)+e.APP_OVERDUE2});t.then(function(e){ionic.Platform.exitApp()})}else g.show({template:e.APP_OVERDUE1+Math.abs(D.appoverdue)+e.APP_OVERDUE2})});r.forEach(function(e){i.splice(i.indexOf(e),1)}),e.setEmployees(i),e.setGroups(),D.isAppOwner=e.isOwner(),D.$broadcast("user:updated",Se),D.$broadcast("canbookin:updated",qe),t.resolve(o)}D.picData=f.picData,e.myRatings()["finally"](function(){e.getPOIs(!0)["finally"](function(){null==D.tags&&e.getTags()["finally"](function(){})})}),D.showVehiclePermit=e.showVehiclePermit,null==D.vehiclePermit&&(D.vehiclePermit={}),D.vehiclePermit.permit=f.permit,D.vehiclePermit.vehicle=f.vehicle,D.isNotCustomer||"app.employee-index"!=D.history.currentStateName()||q.transitionTo("app.quoteform")},function(e){i>3?t.reject(e):o(i+1)})};return o(0),t.promise}},findAll:function(){var e=T.defer();return e.resolve(bt),e.promise},findById:function(e){if(e)var t=W[e-1];else var t=bt[wt[Object.keys(wt)[0]].position];return t},findByName:function(e){var t=T.defer(),o=bt.filter(function(t){var o=t.firstName+" "+t.lastName;return o.toLowerCase().indexOf(e.toLowerCase())>-1});return t.resolve(o),t.promise},findByManager:function(e){var t=T.defer();return findByManager=function(){results=bt.filter(function(t){return parseInt(e)===t.managerId&&t.dispatcher<1}),t.resolve(results)},null==bt?this.findAllEmployees().then(function(){findByManager()}):findByManager(),t.promise},findByCategoryId:function(e,t){var o,i=T.defer(),r=this,n=function(){W=r.getCategEmployees(),o=W.filter(function(t){return e===t.category_id&&t.dispatcher<1}),i.resolve(o)};return W&&!t?n():(this.emptyEmployeesCateg(),D.$broadcast("loading:show"),this.itemsApi("&category_id[]="+e).then(function(t){"failed"==t.status.toLowerCase()?(D.$broadcast("loading:hide"),i.reject(t)):(W=t.items,r.setCategoryGroups(),C.child(e+"/queue").orderByChild("timestamp").once("value",function(t){r.setEmpl(t,e)}),n(),D.$broadcast("loading:hide"))},function(e){i.reject(e)})),i.promise},getInboxesByQuoteId:function(e){var t=[];for(var o in ye)for(var i in ye[o])ye[o][i].route.quote_id==e&&t.push(ye[o][i].route);return t},is_in_zone:function(e,t,o,i){var r=e.length,n=j=c=0;for(n=0,j=r-1;r>n;j=n++)t[n]>i!=t[j]>i&&o<(e[j]-e[n])*(i-t[n])/(t[j]-t[n])+parseFloat(e[n])&&(c=!c);return c},setEmployees:function(e){if(null==bt)angular.forEach(e,function(e){e.dispatcher>0&&(e.booked=!1,e.status=-2,e.QP="Q",e.showQP=!1)});else e:for(var t in e)if(0!=e[t].dispatcher)for(var o in bt)if(e[t].dispatcher>0){if(e[t].id==bt[o].id){e[t].booked=bt[o].booked,e[t].status=bt[o].status,e[t].QP=bt[o].QP,e[t].showQP=bt[o].showQP;continue e}e[t].booked=!1,e[t].status=-2,e[t].QP="Q",e[t].showQP=!1}bt=e},updateEmployee:function(e){},changeGroupStatus:function(e,t){var o=0;"string"==typeof e||Object.getPrototypeOf(e)===Object.prototype?angular.forEach(bt,function(i){(i.dispatcher>0&&"all"==e||i.dispatcher>0&&i.id==e.id)&&(bt[o].status=t,2==t?(bt[o].booked=!0,bt[o].showQP=!0):-2==t&&(bt[o].booked=!1,bt[o].showQP=!1)),o++}):dt.forEach(function(e,o){if(wt.hasOwnProperty(e)){var i=wt[e].groupPosition;2==t?(bt[i].booked=!0,bt[i].showQP=!0):-2==t&&(bt[i].booked=!1,bt[i].showQP=!1)}}),this.setAllBookedStatus(),this.setGroups()},setAllBookedStatus:function(){D.itemBooked=0,D.itemNotBooked=0;var e=0,t=Object.keys(wt).length;for(var o in wt)bt[wt[o].groupPosition].iscustomer||(bt[wt[o].groupPosition].booked?D.itemBooked++:0==bt[wt[o].groupPosition].booked&&D.itemNotBooked++,e==t-1&&0==D.itemBooked&&0==D.itemNotBooked&&(D.itemNotBooked=1)),e++},getEmployees:function(){return null==bt?new Array:bt},getCategEmployees:function(){return null==W?new Array:W},emptyAllEmployees:function(){K&&(K.length=0,K=null)},emptyEmployeesCateg:function(){W&&(W.length=0,W=null)},getAllStoredEmployees:function(){return null==K?new Array:K},getDispEmplByApikey:function(e){var t;return W?(W.some(function(o){return t=o,o.apikeypublic==e}),t):!1},getAllEmployees:function(){var e=T.defer();return K?e.resolve(K):this.itemsApi().then(function(t){"failed"==t.status.toLowerCase()?e.reject(t):(K=t.items,e.resolve(K))},function(t){e.reject(t)}),e.promise},coupon:function(e){var t=T.defer();return x.get(M+"promocode/?selectCoupon[]="+e+"&"+a.getParams()).success(function(e){t.resolve(e)}).error(function(e){D.$broadcast("loading:hide"),l(["SOMETHING_WRONG","FAILED"]).then(function(e){O.alert({title:e.FAILED,template:e.SOMETHING_WRONG})}),t.reject(e)}),t.promise},sendQuote:function(e){function t(e,t){t=t&&t.toLowerCase();for(var o="",i=0,r="a"==t?10:0,n="n"==t?10:62;i++<e;){var a=Math.random()*(n-r)+r<<0;o+=String.fromCharCode(a+=a>9?36>a?55:61:48)}return o}var o=T.defer();this.setQuoteDateTime(e);var i=M+"quote/?"+a.getParams(null,!0)+"&"+e.items.join("&")+"&"+e.group_id.join("&")+"&"+e.zone_id.join("&")+"&"+e.pickup_zone.join("&")+"&_token="+t(40)+("&tripfrequency=oneway&"+e.splitFare.join("&")+'&sent_to_message=""&eta_distance[]='+e.estDistVal+"&eta_time[]="+e.estTimeVal+"&pickup[]="+e.pickup.formatted_address+"&pickup_lat[]="+e.pickup.lat+"&pickup_lon[]="+e.pickup.lon+"&dropoff[]="+e.dropoff.formatted_address+"&dropoff_lat[]="+e.dropoff.lat+"&dropoff_lon[]="+e.dropoff.lon+"&route_distance[]="+e.distance+"&selectDate[]="+e.date+"&selectTime[]="+e.time+"&selectPeople[]="+e.people+"&note[]="+e.note+"&selectPrice[]="+(e.price||s.defaultPrice)+"&selectService[]="+e.service+"&range[]="+e.range+"&qmode="+(e.mode||D.quoteQMode)+"&mode=route&status=").replace(/ /g,"+").replace(/,/g,"%2C").replace(/[[]/g,"%5B0").replace(/[\]]/g,"%5D").replace(":","%3A").replace(/\//g,"%2F");return null!=e.coupon&&(i+="&coupon="+e.coupon),x.get(i).success(function(e){o.resolve(e),Ve=e.quoteID,window.localStorage.setItem("quote_Id",Ve)}).error(function(e){o.reject(e)}),o.promise},setQuoteDateTime:function(e){var t={};t=e;var o=e.hasOwnProperty("date")?"date":"selectDate",i=e.hasOwnProperty("time")?"time":"selectTime",r=moment(moment.tz(moment(e[o]+" "+e[i],"MM/DD/YY hh:mm a"),e.timezone).format("MM/DD/YY hh:mm a"),"MM/DD/YY hh:mm a");t[o]=r.format("MM/DD/YY"),t[i]=r.format("hh:mm a");var n=r.add(D.allow_advance_reservation,"minutes"),a=r.add(D.allow_remote_reservation,"minutes");r.isBefore(n)?(t[o]=n.format("MM/DD/YY"),t[i]=n.format("hh:mm a")):r.isAfter(a)&&(t[o]=a.format("MM/DD/YY"),t[i]=a.format("hh:mm a"))},getVehicleData:function(e){var t=T.defer();return x.get("https://api.edmunds.com/api/vehicle/v2/vins/"+e+"?fmt=json&api_key=9mjx9dzqsq8gzjcehjmcnyuq").success(function(e){t.resolve(e)}).error(function(e){t.reject(e)}),t.promise},getAllDrivers:function(){return ft},getUniqueDrivers:function(){return pt},getBookedZoneId:function(e){return rt[e]?rt[e].id:!1},driversAvailable:function(e){var t=!1;for(zone in ft)if(!e||e==zone)for(var o in ft[zone])if(""==ft[zone][o].quote_id){t=!0;break}return t},getAllUniqueDrivers:function(){var e={},t=[];for(var o in ft)for(var i in ft[o])t.indexOf(i)<0&&(t.push(i),e[i]=ft[o][i]);return e},setNearestFurthestDriver:function(e,t,o,i){var r=12e3,n=0,a=1e4,u=0;if(void 0!=i)for(var l in o){if(o[l].hasOwnProperty("lat"))var d={lat:o[l].lat,lon:o[l].lon};else var d={lat:o[l].getPosition().lat(),lon:o[l].getPosition().lng()};var c=this.getGPSDistance(i.lat,i.lon,d.lat,d.lon),f=c/s.driverSpeedMPH*60;r>c&&(r=parseFloat(c)),c>n&&(n=parseFloat(c)),a>f&&(a=Math.ceil(f),a=0==a?1:a),f>u&&(u=Math.ceil(f)),12e3==r&&(r=parseFloat(c)),0==n&&(n=parseFloat(c)),1e4==a&&(a=parseFloat(f)),0==u&&(u=parseFloat(f)),D.$broadcast("queue:rangeTime",a,u),D.$broadcast("queue:range",r.toFixed(1),n.toFixed(1))}},resetETA:function(){oe={}},setNearestFurthestDrivers:function(e,t,o,i,r){if(e){var n={lat:o,lon:i},a=this.getGPSDistance(r.lat,r.lon,n.lat,n.lon),u=a/s.driverSpeedMPH*60;"removed"==e&&oe[t]&&!Ee.all[t]?delete oe[t]:oe[t]=0==Math.ceil(u)?1:parseFloat(Math.ceil(u));var l=Object.keys(oe).sort(function(e,t){return oe[e]-oe[t]}),d=oe[l[0]],c=oe[l[l.length-1]];return{nearestDriverTime:d,furthestDriverTime:c}}var l=Object.keys(oe),d=oe[l[0]],c=oe[l[l.length-1]];return{nearestDriverTime:d,furthestDriverTime:c}},inboxesWithQuoteId:function(e,t,o){var i=[];for(var r in ye)for(var n in ye[r])(!o||o!=r)&&o||ye[r][n].route.quote_id!=t||e&&ye[r][n].route.id==e||i.push({quote_id:n,zone_id:r});return i},cleanModals:function(e,t,o){var i=this;It&&D.detail&&D.detail.id==t?i.endTrip(t):ht.indexOf(o.route.quote_id)>-1&&this.inboxesWithQuoteId(t,o.route.quote_id).length<1?(ht.splice(ht.indexOf(o.route.quote_id),1),D.dontHideLoader=!1,D.$broadcast("loading:hide"),i.removeModalPopup(D,"tripModal")):null!=D.quote_modal&&D.quotes.length>0&&void 0!=o&&o.route.quote_id==D.quotes[0].quote_id?i.quoteModalCleanUp():null!=D.offerModal&&D.offerDetail&&D.offerDetail.id==t?(i.removeModalPopup(D,"offerModal"),i.resetQuoteID(),D.offerNotInProcess=!0,D.$broadcast("loading:hide"),P.cancel(D.jailTimer),ke&&i.ringTone()):(yt||re)&&D.rates.forEach(function(e,o){e.quoteId==t&&(D.rates.splice(o,1),0==D.rates.length&&i.orderModalCleanUp())})},authenticateToken:function(){var e=this,t=T.defer();Ge=!1;var o=function(){e.autologin().then(function(e){i(e)})},i=function(i){C.authWithCustomToken(i,function(i,r){i?o():(D.noGroups||ut.forEach(function(t,o){e.initFirebase(t,o)}),t.resolve())})};return o(),t.promise},saveFbTimestamp:function(){f.savedTimeStamps={},dt.forEach(function(e){f.savedTimeStamps[e]=ft[e][window.localStorage.getItem("apikeypublic")].timestamp})},restoreFbTimestamp:function(){if(Pt.diff(tt,"seconds")<z){for(var e in f.savedTimeStamps)!function(e){C.child(e+"/queue/"+window.localStorage.getItem("apikeypublic")).update({timestamp:f.savedTimeStamps[e]},function(e){e||(f.savedTimeStamps={})})}(e);f.savedTimeStamps={}}},authenticateFirebase:function(){var e=this,t=function(){return D.app_suspended?(D.$broadcast("loading:hide"),void q.transitionTo("app.suspended")):(D.startupLoading&&e.autologinApi(),void e.findAllEmployees().then(function(t){D.$broadcast("items:loaded"),e.authenticateToken().then(function(){Ge&&(Ge=!1,e.autologin())})}))};null!=D.lat?t():A||(A=I(function(){null!=D.lat&&(I.cancel(A),t(),A=null)},2e3))},getzoneIDs:function(){return st},getzoneMap:function(){return ot},getrateMap:function(){return it},getzoneIDStored:function(){return at},savePic:function(e,t,o){var i=T.defer(),r=C.child("images/"+window.localStorage.getItem("apikeypublic"));if(o)var r=C.child("images");var n={};return o?n[o]=e:n[t]=e,r.update(n,function(e){e?i.reject(e):i.resolve()}),i.promise},updateQueuePic:function(e){C.child("images/"+window.localStorage.getItem("apikeypublic")).once("value",function(t){if(t.exists()){var o="data:image/jpeg;base64,"+t.val(),i=C.child(e+"/queue/"+window.localStorage.getItem("apikeypublic"));i.update({pic:o},function(e){})}})},getTimeZone:function(e,t){var o=T.defer();return $.ajax({url:"https://maps.googleapis.com/maps/api/timezone/json?location="+e+","+t+"&timestamp="+Math.round((new Date).getTime()/1e3).toString()+"&sensor=false"}).done(function(e){null!=e.timeZoneId&&o.resolve(e)}),o.promise},setTag:function(e,t,o,i,r,n){var a,s=angular.copy(ze),u=0,l=this.getUniqueDrivers();for(var d in l){var c=void 0!=o?l[d][o]:l[d][Object.keys(l[d])[0]];c&&void 0!=c.tags&&(a=this.someFunc("added",s,c,d,e,i,o,t,null,null,r,n,!0))}if(a)var f=a.skipTags?a.skipTags:a.tags;return a&&0!=Object.keys(f.all).length?(Ee=a.tags,u=Object.keys(f.all).length):u},setMilesRanges:function(){Dt={.5:[]};var e,t=1;do e=1==t?1:5*(t-1),Dt[e]=[],t++;while(e<=D.milesRadius)},setRanges:function(e,t,o,i){var r,n=this,a=n.getGPSDistance(o.lat,o.lon,i.lat,i.lon);r=e?a:30,n.addDeleteFromRange(t,r)},addDeleteFromRange:function(e,t){for(var o in Dt){var i=Dt[o].indexOf(e);o>=t?0>i&&Dt[o].push(e):i>-1&&Dt[o].splice(i,1)}},getGpsRanges:function(){return Dt},getGroupItems:function(){return wt},removeServ:function(e,t,o,i,r,n){for(var a=[],s=o.length-1;s>=0;)t.tags.indexOf(o[s])<0&&(i[s].checked&&a.push(o[s]),o.splice(s,1),i.splice(s,1)),s-=1;return a},addTag:function(e,t,o,i){("all"==t||_.intersection([t],it[o.group_id]).length>0)&&(e[t][i]?e[t][i].indexOf(o.group_id)<0&&e[t][i].push(o.group_id):e[t][i]=[o.group_id])},deleteTag:function(e,t,o,i){if(e[t].hasOwnProperty(i)){var r=e[t][i].indexOf(o.group_id);r>-1&&e[t][i].splice(r,1),0==e[t][i].length&&delete e[t][i]}},someFunc:function(e,t,o,i,r,n,a,s,u,l,d,c,f,p){var m,g=this,h=[],v=c||D.milesRadius,y=!1,w=function(e,r){var a=r?t:b;e?g.deleteTag(a,"all",o,i):g.addTag(a,"all",o,i),o.tags.forEach(function(t){a.hasOwnProperty(t)&&(e?g.deleteTag(a,t,o,i):g.addTag(a,t,o,i),u&&((!n||n&&s!=t)&&0==Object.keys(a[t]).length&&0==Object.keys(Ce[t]).length&&(new RegExp(t).test(s)&&h.indexOf(t)<0&&h.push(t),u.indexOf(t)>-1&&(l.splice(u.indexOf(t),1),u.splice(u.indexOf(t),1))),Object.keys(a[t]).length>0&&u.indexOf(t)<0&&(u.push(t),l.push({id:t,text:t,"class":"taxicar",checked:!1,icon:"pics/taxi.png"}))))})},b=angular.copy(t);if(n&&!d&&(m=Object.keys(n)[0],!t.all.hasOwnProperty(Object.keys(n)[0]))){var O=n[m];O.selectService.split(",").forEach(function(e){g.addTag(t,e,O,m),u.indexOf(e)<0&&(u.push(e),l.push({id:e,text:e,"class":"taxicar",checked:!0,icon:"pics/taxi.png"}))}),g.addTag(t,"all",O,m),w(!1)}if(void 0!=t&&void 0!=t.all){var g=this;if(void 0!=a&&o.group_id!=a)return{tags:t,removedServices:h,services:u,servicesObjArr:l};if(!n||n&&m!=i){g.setRanges("removed"!=e,i,o,r);var k="app.quoteform"==D.history.currentStateName()?D.quoteQMode:D.dispatcherQMode;"undefined"!=typeof Dt[D.milesRadius]&&Dt[D.milesRadius].length>0&&Dt[v].length<1&&!f&&(y=v,v=D.milesRadius);var S=i!=window.localStorage.getItem("apikeypublic")&&it[o.group_id]&&_.intersection(o.tags,it[o.group_id]).length>0&&Dt[v].indexOf(i)>-1&&!o.disconnectTime&&""==o.quote_id&&o.tags.indexOf("Driver")>-1,I="offer"==k||k==o.mode?t:b,P=!1;if(p){if(p.indexOf(o.zone_id)>-1){var x=S&&!0;P=!0}}else var x=S&&g.withinZone(o.group_id,null,r.lat,r.lon,o.lat,o.lon);x?"removed"!=e?(w(!1),"offer"==k||k==o.mode?w(!1,!0):w(!0,!0)):(w(!0),w(!0,!0)):I.all[i]&&I.all[i].length>0&&(w(!0),w(!0,!0))}var T=D.bidOnDrivers.indexOf(i);if("removed"!=e&&0>T&&"quote"==o.mode&&D.bidOnDrivers.push(i),T>-1&&("removed"==e||"updated"==e&&"quote"!=o.mode)&&D.bidOnDrivers.splice(T,1),0==D.bidOnDrivers.length&&(a?D.dispatcherQMode="offer":D.quoteQMode="offer"),d&&D.detail){var M=angular.copy(t),i=D.detail.sent_to,q=g.getUniqueDrivers();if(q.hasOwnProperty(D.detail.sent_to)&&q[D.detail.sent_to].hasOwnProperty(D.detail.zone_id)){var o=g.getUniqueDrivers()[D.detail.sent_to][D.detail.zone_id];g.deleteTag(M,"all",o,i),o&&o.tags.forEach(function(e){M.hasOwnProperty(e)&&(g.deleteTag(M,e,o,i),u&&u.indexOf(e)>-1&&0==Object.keys(t[e]).length&&(u.splice(u.indexOf(e),1),l.splice(u.indexOf(e),1)))})}}return{tags:t,removedServices:h,services:u,servicesObjArr:l,skipTags:M,removedRange:y,tagsNonMode:b,haveCenterDrivers:P}}},setTagMap:function(e,t,o,i,r,n,a,s,u,l,d,c,f){var p,m,g,h,v=[];if(void 0!=Ee&&void 0!=Ee.all&&t[Object.keys(t)[0]]&&void 0!=t[Object.keys(t)[0]].tags){var y=this,w=Object.keys(t)[0],b=t[Object.keys(t)[0]],O=this.someFunc(e,Ee,b,w,o,l,u,n,r,i,d,c,null,f);Ee=O.tags,p=O.skipTags,v=O.removedServices,m=O.removedRange,g=O.tagsNonMode,h=O.haveCenterDrivers;var k=p?p:Ee;s&&k.all[w]&&(s=y.setNearestFurthestDrivers(e,w,b.lat||b.driver_lat,b.lon||b.driver_lon,o));var S=Object.keys(k[l]||k[n]||k.all).length;if(S>0&&0==Object.keys(s).length&&(s=y.setNearestFurthestDrivers()),g)var I=Object.keys(g.all).length;S>0&&m&&D.$broadcast("range:out"),(0==S&&u||b.tags.indexOf("Driver")<0)&&(D.allow_advance_reservation>0||b.settings&&b.settings.allow_advance_reservation>0)&&(b.settings&&b.settings.services&&("removed"!=e?y.addTag(Ce,"all",b,w):y.deleteTag(Ce,"all",b,w),_.intersection(b.settings.services,it[b.group_id]).forEach(function(t){if("removed"!=e?y.addTag(Ce,t,b,w):y.deleteTag(Ce,t,b,w),r.indexOf(t)<0){var o=!1;v.indexOf(t)>-1&&(v.splice(v.indexOf(t),1),o=!0),r.push(t),i.push({id:t,text:t,"class":"taxicar",checked:l&&l==t||o||!1,icon:"pics/taxi.png"})}(!l||l&&n!=t)&&0==Object.keys(Ee[t]).length&&0==Object.keys(Ce[t]).length&&(new RegExp(t).test(n)&&v.indexOf(t)<0&&v.push(t),r.indexOf(t)>-1&&(i.splice(r.indexOf(t),1),r.splice(r.indexOf(t),1)))})),0==v.length&&1==r.length&&(i[0].checked=!0)),D.totalNonModeDrivers=I,a(S,O.servicesObjArr,v,s,m,I,b.settings,h)}},findplaces:function(e,t,o,i){var r=this,n=new google.maps.places.AutocompleteService,a=new google.maps.places.PlacesService(i[0]),u=function(e,t){for(var i=[],n=0;n<e.length;n++)!function(e,n){a.getDetails({placeId:e},function(e,a){e&&(e.formatted_address=n,i.push(e),i.sort(function(e,t){return distA=r.getGPSDistance(e.geometry.location.lat(),e.geometry.location.lng(),D.lat,D.lon),distB=r.getGPSDistance(t.geometry.location.lat(),t.geometry.location.lng(),D.lat,D.lon),distA-distB}),o.$apply(function(){o[t+"locations"]=i}))})}(e[n].place_id,e[n].description)};o[t+"LocationSelected"]=!1,searchEventTimeout=P(function(){o[t+"typed"]=!0;var i={};i.input=e,i.location=new google.maps.LatLng(D.lat,D.lon),i.radius=1e3*s.milesRadius*1.609,n&&n.getPlacePredictions(i,function(e,o){o==google.maps.places.PlacesServiceStatus.OK&&u(e,t)})},350)},getLocation:function(e,t){var o=(new google.maps.Geocoder,T.defer()),i={lat:parseFloat(e),lng:parseFloat(t)};return r.geocoder().geocode({location:i},function(e,t){t===google.maps.GeocoderStatus.OK&&e[1]&&o.resolve(e[1].formatted_address)}),o.promise},getTagsDriverMap:function(){return Ee},getTagsDispatcherMap:function(){return Ce},setGlobalGroups:function(e){Q||(Q=!0,x.get(M+"autologin/?apikeypublic=183dcce812d78798659eb538aa719a9c28c36c05df80c9b0aef24938049799a8&"+a.getParams(!0)).success(function(e){e.user.zone_id.forEach(function(e,t){lt.indexOf(e)<0&&lt.push(e)}),D.$broadcast("groups_set")}).error(function(){Q=!1})),At||(At=!0,this.getGlobalDrivers())},getGlobalDrivers:function(){var e=this;e.itemsApi(null,!0).then(function(e){var t=!1;e.items&&e.items.some(function(e){return t="My A2Bers"!=e.name&&e.apikeypublic==window.localStorage.getItem("apikeypublic")}),D.globalDriver=t},function(){At=!1})},getCareers:function(t,o){var i=T.defer(),r=T.defer(),n=M+"hr/?action="+t+"&"+a.getParams(),s=function(t,o,n){t&&(o+="&id="+t.id+"&firstName="+t.firstName+"&lastName="+t.lastName+"&cellPhone="+t.cellPhone+"&email="+f.email+"&tags[]="+t.itemType+"&skills[]="+t.skills);x.get(o).success(function(e){"failed"==e.status&&2>n?s(t,o,n+1):r.resolve(e)}).error(function(e){r.reject(e)})["finally"](function(){e.remove(o)});e.add({url:o,abortpromise:i,deferred:r})};return s(o,n,0),r.promise},getGlobalGroups:function(){return lt},getDispatcherGroups:function(){var e=[];for(var t in Ce)for(var o in Ce[t])e=_.union(e,Ce[t][o]);return e},getTagsDriverDefault:function(){return ze},resetTagMap:function(){Ee=angular.copy(ze)},resetDispatcherTagMap:function(){Ce=angular.copy(ze)},setQ:function(e,t){var o=this;if("updated"==t){var i=e.ref().parent().parent().parent().key(),r=e.ref().parent().key(),n=e.val();mt.hasOwnProperty(i)||(mt[i]=[]),""==n&&mt[i].indexOf(r)<0?mt[i].push(r):""!=n&&mt[i].indexOf(r)>-1&&mt[i].splice(mt[i].indexOf(r),1),wt[i]&&bt[wt[i].groupPosition].booked&&(i!=wt[i].category_id?o.setStoredZones({id:i},"inside",wt[i].category_id):wt[i].zone_id==i?bt[wt[i].groupPosition].QP=mt[i].indexOf(window.localStorage.getItem("apikeypublic"))+1+"/"+mt[i].length:ft.hasOwnProperty(i)&&ft[i].hasOwnProperty(r)&&wt[i].category_id==i&&(bt[wt[i].groupPosition].QP=mt[i].indexOf(window.localStorage.getItem("apikeypublic"))+1+"/"+mt[i].length),D.bookingIn&&(D.bookingIn=!1,D.$broadcast("loading:hide")))}else{var i=e.ref().parent().parent().key(),r=e.key();e.val();if(mt[i].splice(mt[i].indexOf(r),1),window.localStorage.getItem("apikeypublic")==r){var a=dt.indexOf(i);a>-1&&(dt.splice(a,1),Object.keys(wt).length>0&&wt.hasOwnProperty(i)&&wt[i].booked&&i==wt[i].category_id?(bt[wt[i].groupPosition].booked=!1,bt[wt[i].groupPosition].showQP=!1,wt[i].booked=!1,o.setAllBookedStatus()):o.setGroups())}}},messageListener:function(e){var i=o.get("EmployeeService");if(e.exists()){var r=e.ref().parent().parent().key(),n=e.val(),a=e.key(),s=n.to,d=!0;n.hasOwnProperty("toShow")&&(d=n.toShow),l(["MESSAGE","NEW_SUBSCRIPTION","REPLY"]).then(function(e){for(var o in s){if(""==s[o]&&f.email&&o==f.email.toString().split("@")[0]&&n.message==e.NEW_SUBSCRIPTION){i.authenticateFirebase(),ke||i.ringTone(),u.info(n.from_name+": "+n.message,e.MESSAGE),P(function(){ke&&i.ringTone()},3e3);var l={};l[o]=Firebase.ServerValue.TIMESTAMP,C.child(r+"/messages/"+a+"/to").update(l)}if(o==window.localStorage.getItem("apikeypublic")&&""==s[o]){n.message==e.NEW_SUBSCRIPTION?(i.authenticateFirebase(),i.getGlobalDrivers()):(n.hasOwnProperty("type")&&"deactivated"==n.type||"removed"==n.type)&&wt[r]&&(bt[wt[r].groupPosition].active=0,"removed"==n.type&&i.findAllEmployees().then(function(e){}),i.setGroups(),i.toggleBook(!1,bt[wt[r].groupPosition]),u.info(n.from_name+": "+n.message,e.MESSAGE),P(function(){ke&&i.ringTone()},3e3)),d&&(ke||i.ringTone(),D.detail&&D.chatModal&&D.chatModal.apikey==n.from||"app.messages-detail"==q.current.name&&("app.messages-detail"!=q.current.name||t.currentView().stateParams.apikey==n.from)||u.info(n.from_name+": "+n.message,e.MESSAGE,{allowHtml:!0,onTap:function(){q.transitionTo("app.messages-detail",{apikey:n.from,name:n.from_name})}}),P(function(){ke&&i.ringTone()},3e3));var l={};l[o]=Firebase.ServerValue.TIMESTAMP,C.child(r+"/messages/"+a+"/to").update(l)}}})}},queueListenerFunc:function(e,t,o){if(!D.listenedQueue&&!D.startupLoading&&D.loggedIn){
var i=this;e.forEach(function(e,r,n){C.child(e+"/queue").orderByChild("timestamp").once("value",function(e){i.queueListener(e,o),t||r!=n.length-1||(D.listenedQueue=!0,i.autoBookFunc())})})}},initFirebase:function(e,t){var o=this;P(function(){o.queueListenerFunc(st)},5e3),!Ge&&st.indexOf(e)<0&&(st.push(e),C.child(e+"/messages").on("child_added",o.messageListener),C.child(e+"/zones/latlon").on("value",function(e){var t=e.ref().parent().parent().key();if(Le.indexOf(t)<0&&(Le.push(t),C.child(t+"/inbox").on("child_added",o.inboxAdded),C.child(t+"/inbox").on("child_removed",o.inboxRemoved)),e.exists()){if(ot.hasOwnProperty(t)||(ot[t]={}),ot[t].length>e.val().length){var i=ot[t],r=e.val();i.filter(function(e){return 0==r.filter(function(t){return t.id==e.id}).length})}ot[t]=e.val();var n;rt[t]&&(n=rt[t].id,ot[t].some(function(e,i){return n==e.id?(rt[t]=e,!0):void(ot[t].length-1==i&&o.setStoredZones(e,"outside",t))})),o.autoBookFunc()}else t&&ot.hasOwnProperty(t)&&(ot[t].forEach(function(e){o.setStoredZones(e,"outside",t)}),ot[t].length=0);D.$broadcast("zonemap:updated")}),C.child(e+"/rates").on("value",function(e){var t=e.ref().parent().key();if(e.exists()){it.hasOwnProperty(t)||(it[t]=[]),it[t].length=0;var o=$.map(e.val(),function(e){return e});o.forEach(function(e){it[t].indexOf(e.settings[9])<0&&"1"==e.active&&it[t].push(e.settings[9])})}}),C.child(e+"/queue").orderByChild("timestamp").on("value",function(t){ne&&(ne=!1,D.loggedIn&&o.getVehiclesPermits(null,!0),D.$broadcast("firebaseInitialized")),o.queueListener(t,null,e),D.startupLoading&&0==ut.length&&(D.startupLoading=!1,D.$broadcast("fb:initialized"),r.mapsInitialized().then(function(){D.setMap()}),D.setMap(),D.$broadcast("loading:hide",!0),D.loggedIn&&o.queueListenerFunc(st))}),o.addZoneListeners(e,"child_removed"))},tripPath:function(e){var t=T.defer();return x.get(M+"tripPaths/?id="+e+a.getAutoLoginParams()).success(function(e){t.resolve(e)}).error(function(e){t.reject(e)}),t.promise},getBounds:function(e){for(var t=new google.maps.LatLngBounds,o=0;o<e.length;o++){var i=e[o];t.extend(i)}return t},getBoundsFromZoom:function(e,t,o){var i=e.getProjection();if(i){var r=$(e.getDiv()),n=2*Math.pow(2,t),a=r.width()/n,s=r.height()/n,u=i.fromLatLngToPoint(o||e.getCenter());return new google.maps.LatLngBounds(i.fromPointToLatLng(new google.maps.Point(u.x-a,u.y+s)),i.fromPointToLatLng(new google.maps.Point(u.x+a,u.y-s)))}},marginZoom:function(e,t){var o=$(e.getDiv()).height(),i=$(e.getDiv()).width(),r=!1,n=new google.maps.OverlayView;n.draw=function(){},n.setMap(e),r=t.some(function(e){if(!n.getProjection())return!1;var t=n.getProjection().fromLatLngToDivPixel(e);return t.x<10||t.x>i-10||t.y<10||t.y>o-10}),r&&e.setZoom(e.getZoom()-1)},getBoundsZoomLevel:function(e,t,o){function i(e){var t=Math.sin(e*Math.PI/180),o=Math.log((1+t)/(1-t))/2;return Math.max(Math.min(o,Math.PI),-Math.PI)/2}function r(e,t,o){return Math.floor(Math.log(e/t/o)/Math.LN2)}var n=o||this.getBounds(e),a={height:"function"==typeof t.height?t.height():t.height,width:"function"==typeof t.width?t.width():t.width},s={height:256,width:256},u=21,l=n.getNorthEast(),d=n.getSouthWest(),c=(i(l.lat())-i(d.lat()))/Math.PI,f=l.lng()-d.lng(),p=(0>f?f+360:f)/360,m=r(a.height,s.height,c),g=r(a.width,s.width,p);return Math.min(m,g,u)}};return jt.setGlobalQMode(),jt.setServerOffset(),jt.listenFBConnected(),D.allow_reservation=!0,a.getSettings().then(function(e){Tt=e.app_id,D.app_name=e.app_name,D.allow_reoffer="yes"==e.allow_reoffer?!0:!1,D.app_suspended="yes"==e.app_suspended?!0:!1,D.default_customer_mode=e.default_customer_mode,D.default_dispatcher_mode=e.default_dispatcher_mode,D.default_driver_mode=e.default_driver_mode,jt.setGlobalQMode(),D.milesRadius=e.limit_area_coverage,jt.setMilesRanges(),D.zone_maximum_driver_limit=e.zone_maximum_driver_limit,D.allow_advance_reservation=e.allow_advance_reservation,D.allow_remote_reservation=e.allow_remote_reservation,D.allow_queue="yes"==e.allow_queue?!0:!1,D.allow_reservation="yes"==e.allow_reservation?!0:!1,D.allow_add_group="yes"==e.allow_add_group?!0:!1,D.show_vehicle="yes"==e.show_vehicle?!0:!1,D.show_permit="yes"==e.show_permit?!0:!1,D.show_rating="yes"==e.show_rating?!0:!1,D.show_QP="yes"==e.show_QP?!0:!1,D.allow_trip_cancel="yes"==e.allow_trip_cancel?!0:!1,D.allow_edit_trip_detail="yes"==e.allow_edit_trip_detail?!0:!1,D.allow_multiple_passengers="yes"==e.allow_multiple_passengers?!0:!1,D.allow_fare_split="yes"==e.allow_fare_split?!0:!1,D.allow_coupon="yes"==e.allow_coupon?!0:!1,D.offerTime=e.offer,D.jailTime=e.jail,D.biddable="yes"==e.biddable?!0:!1,D.rquire_uppload="yes"==e.rquire_uppload?!0:!1}),jt}]).factory("FireBase",["$firebase",function(e){return function(){var t=new Firebase("https://yd.firebaseio.com/");return e(t).$asObject()}}]).factory("AuthService",["$injector","$localStorage","$interval","$http","$q","$rootScope","EmployeeService",function(e,t,o,i,r,n,a){return{isAuthenticated:function(){return null==window.localStorage.getItem("apikeypublic")?!1:!0},isDispatcherAdmin:function(e,t,i,n){var s,u=r.defer(),l=function(){void 0!=s&&(o.cancel(s),s=void 0);var r,l;a.getEmployees().forEach(function(o,i){o.category_id!=e.employeeId||o.apikeypublic!=window.localStorage.getItem("apikeypublic")||r&&void 0!=r||(r=o.hasOwnProperty("can_bookin")?o.hasOwnProperty("can_bookin"):o.tags.indexOf("Admin")>-1||!t&&o.tags.indexOf("Dispatcher")>-1,r&&(r=!n||n&&(o.isOwner||a.getGroupItems()[o.category_id].booked)),l=o.isOwner)}),i?u.resolve(l):u.resolve(r)};return null==a.getEmployees()?s=o(function(){null!=a.getEmployees()&&l()},2e3):l(),u.promise},isInTrip:function(){return n.detail||n.tripModal}}}]).factory("AnimateMarkerService",["$q","$rootScope","EmployeeService","constants",function(e,t,o,r){var n=!1,a=100,s=10;return{setStopMovingMarker:function(e){n=e},moveMarker:function(e,t,o,r,u){e[0]+=t,e[1]+=o;var l=new google.maps.LatLng(e[0],e[1]);r.setPosition(l),i==a||n?i==a&&void 0!=u&&u.panTo(l):(i++,setTimeout(function(e,t,o,i){return me.moveMarker()}(e,t,o,r),s))},transition:function(e,t,o,i,r,n){var a=new google.maps.LatLng(t.getPosition().lat(),t.getPosition().lng());void 0!=o&&o.panTo(a)},fitBounds:function(e,t,o){for(var i=new google.maps.LatLngBounds,r=0;r<e.length;r++){var n=e[r];i.extend(n)}if(void 0!=o&&i.extend(o),i.getNorthEast().equals(i.getSouthWest())){var a=new google.maps.LatLng(i.getNorthEast().lat()+.01,i.getNorthEast().lng()+.01),s=new google.maps.LatLng(i.getNorthEast().lat()-.01,i.getNorthEast().lng()-.01);i.extend(a),i.extend(s)}var u=0,l=70,d=t.getProjection().fromLatLngToPoint(i.getSouthWest());t.fitBounds(i);var c=new google.maps.Point(("number"==typeof u?u:0)/Math.pow(2,t.getZoom())||0,("number"==typeof l?l:0)/Math.pow(2,t.getZoom())||0),f=t.getProjection().fromPointToLatLng(new google.maps.Point(d.x-c.x,d.y+c.y));i.extend(f),t.fitBounds(i)}}}]).factory("ApiParamService",["$http","$q","UUIDService","$rootScope","$injector","$localStorage",function(e,t,o,i,r,n){var a,s;return{getSettings:function(){var o=t.defer();return s?s:(e.get("./custom_settings.json").then(function(e){var t=e.data;a=t.app_id,o.resolve(t)},function(t){e.get("./settings.json").then(function(e){var t=e.data;a=t.app_id,o.resolve(t)})}),s=o.promise)},checkTokenExpiry:function(){n.token&&moment().diff(moment(n.token.time),"days")>=1&&r.get("EmployeeService").authenticateToken()},getAutoLoginParams:function(){var e="";if(null!=window.localStorage.getItem("apikeypublic")){var t=r.get("EmployeeService");e+=t.isDriver()?"apikeypublic="+window.localStorage.getItem("apikeypublic"):"apikeypublic="+a}else e+="apikeypublic="+a;return e+="&app_id="+a,null!=i.lat&&(e+="&lat="+i.lat+"&lon="+i.lon),e+="&uuid="+o.getRandomUUID()},getParams:function(e,t,r){var n=(this.checkTokenExpiry(),"");return r||(!e&&null!=window.localStorage.getItem("apikeypublic")||t?null!=window.localStorage.getItem("apikeypublic")&&(n+="&apikeypublic="+window.localStorage.getItem("apikeypublic")):n+="&apikeypublic="+a),n+="&app_id="+a,null!=i.lat&&(n+="&lat="+i.lat+"&lon="+i.lon),n+="&uuid="+o.getRandomUUID()}}}]).factory("UUIDService",["$localStorage",function(e){return{getRandomId:function(){return Math.abs(Math.random().toString().split("").reduce(function(e,t){return(e<<5)-e+t})).toString(36).substr(0,11)+(new Date).getTime()},getRandomUUID:function(){return void 0==ionic.Platform.device().uuid?(null==e.uuid&&(e.uuid=this.getRandomId()),e.uuid):e.uuid=ionic.Platform.device().uuid},matchesMyUUID:function(e){return e==this.getRandomUUID()}}}]).factory("CityState",["$http","$rootScope","$q",function(e,t,o){var i=[],r=[];return{findStates:function(t){var i=o.defer(),n=function(e){var t=[];return r.forEach(function(o){o.name.toLowerCase().indexOf(e.toLowerCase())>-1&&t.push({id:o.name,text:o.name,checkecd:!1})}),t};return 0==r.length?e.get("https://api.theprintful.com/countries").success(function(e){r=e.result.filter(function(e){return"US"==e.code})[0].states,n(t),i.resolve(n(t))}).error(function(e){i.reject(e)}):i.resolve(n(t)),i.promise},clearStates:function(){r.length=0},setStates:function(){var i=o.defer();return e.get("https://api.geonames.org/searchJSON?country="+t.countryCode+"&featureCode=ADM1&username=hyperonic").success(function(e){e.geonames.forEach(function(e){r.push({id:e.name,text:e.name,checkecd:!1})}),i.resolve(e)}).error(function(e){i.reject(e)}),i.promise},setCities:function(){var e=o.defer();return e.resolve(),e.promise},getStates:function(){return r},getCities:function(){return i}}}]).factory("GpsDetectService",["$injector","$timeout","$q","$ionicLoading","$interval","$ionicPlatform","$translate","$rootScope",function(e,t,o,i,r,n,a,s){var u,l=!1;return{isNotConnected:function(){var e=o.defer();return n.ready(function(){gpsDetect.checkGPS(l,function(t){e.resolve(t),t?(s.$broadcast("gps:connected"),l=!1,s.isGpsOff=!1,s.isOffline?a("OFFLINE").then(function(e){i.show({template:e})}):i.hide()):(l=!0,s.isGpsOff=!0,a("GPS_OFF").then(function(e){i.show({template:e})}))},function(t){e.reject(t)})}),e.promise},startGpsInterval:function(){u=r(function(){gpsDetect.checkGPS(l,function(o){o?(l=!1,e.get("EmployeeService").setLatLon().then(function(){s.$broadcast("gps:connected")})):(l=!0,t(function(){s.isGpsOff=!0}),a("GPS_OFF").then(function(e){i.show({template:e})}))},function(e){})},5e3)},cancelGpsInterval:function(){r.cancel(u)}}}]).service("LanguagesService",["$http",function(e){this.get=function(){return e.get("/locales/languages.json")}}]).service("Internet",["baseUrl","$http","$injector","$q","ApiParamService",function(e,t,o,i,r){var n;this.IsConn=function(){if(n&&0==n.$$state.status)return n;var o=i.defer(),a="https://freegeoip.net/json/",a=e+"autologin/?"+r.getAutoLoginParams();return t.get(a).then(function(e){var t=e.status;o.resolve(t>=200&&300>t||304===t)},function(e){o.reject(e)}),n=o.promise}}]).service("PendingRequestsService",["$log","$http","$timeout",function(e,t,o){var i=this,r=[],n={},a=[];i.add=function(e){r.push(e),i.setTimer(e)},i.setTimer=function(e){e.timer&&(n[e.url]=o(function(e){i.replay(e)},1e3*e.timer,!1,e.url))},i.clearTimeouts=function(e){for(var t in n)e==t&&o.cancel(n.t)},i.remove=function(e){for(var t=r.length-1;t>=0;t--)r[t].url==e&&(a.indexOf(e)>-1&&a.splice(a.indexOf(e),1),n[e]&&o.cancel(n[e]),r.splice(t,1))},i.replay=function(e){angular.forEach(r,function(t){t.url==e&&(a.indexOf(e)<0&&a.push(e),t.abortpromise.resolve())})},i.cancelAll=function(){angular.forEach(r,function(e){e.abortpromise.resolve(),e.deferred.reject(),i.clearTimeouts(e)}),r.length=0,a.length=0}}]).factory("Initializer",["$ocLazyLoad","$window","$q","$timeout","$interval","$rootScope",function(e,t,o,i,r,n){var a,s,u,l=$.now(),d=function(e){var t=document.createElement("script");t.type="text/javascript",t.src=e;var o=document.getElementsByTagName("head")[0];o.appendChild(t)},c=function(t,i,c){function f(){$.ajax({dataType:"script",data:_,url:"https://maps.google.com/maps/api/js?libraries=visualization,drawing,places,geometry",error:function(){setTimeout(function(){navigator.onLine&&f()},2e3)}})}if(u)return u;var p=o.defer(),m=function(){window.google&&google.maps&&(a=new google.maps.Geocoder,s=new google.maps.DirectionsService),p.resolve(window.google&&google.maps?google.maps:!1),d("lib/sliding-marker/markerAnimate.js"),d("lib/sliding-marker/SlidingMarker.min.js"),e.load("lib/ng-map.min.js");var t=r(function(){"undefined"!=typeof SlidingMarker&&(r.cancel(t),SlidingMarker.initializeGlobally())},100);n.setMap&&n.setMap()},g="loadGoogleMaps_"+l++,_=$.extend({sensor:!0},{libraries:"visualization,drawing,places,geometry"},i?{key:i}:{},c?{language:c}:{});window.google&&google.maps?m():window.google&&google.load?google.load("maps",t||3,{other_params:$.param(_),callback:m}):(_=$.extend(_,{v:t||3,callback:g}),window[g]=function(){m(),setTimeout(function(){try{delete window[g]}catch(e){}},20)},f()),u=p.promise};return{mapsInitialized:function(){if(navigator.onLine)return c(),u;var e=o.defer();return e.reject(!1),e.promise},geocoder:function(){return a},directionsService:function(){return s}}}]).factory("Auth",["$auth","$cordovaOauth","$localStorage","$http","$q","$ionicPopup","$translate","EmployeeService","$rootScope",function(e,t,o,i,r,n,a,s,u){var l,d,c,f,p,m=function(){var e=function(){s.login({method:c,email:p}).then(function(t){if("Failed"!=t.status)d.resolve(t);else{var o={};o.name=f,o.email=p,o.password="aaaaaa",o.confirmPassword=o.password,o.phone="111111",s.signUp(o).then(function(t){e()},function(e){d.reject(e)})}},function(e){})};e()},g=function(){i.get("https://graph.facebook.com/v2.5/me/?access_token="+l.access_token+"&fields=email,name,picture").success(function(e){l=e,f=l.name,p=l.email,o.picData="https://graph.facebook.com/"+l.id+"/picture?type=large",m()}).error(function(e){d.reject(e)})},_=function(){i.get("https://api.twitter.com/1.1/users/show.json?screen_name="+l.screen_name+"&auth=oauth").success(function(e){f=l.name,p=l.id,m()}).error(function(e){d.reject(e)})},h=function(){i.get("https://www.googleapis.com/plus/v1/people/me/openIdConnect",{headers:{Authorization:"Bearer "+l.access_token}}).success(function(e){l=e,f=l.name,p=l.email,l.picture&&(o.picData=l.picture.substr(0,l.picture.indexOf("?"))),m()}).error(function(e){d.reject(e)})},v=function(){i.get("https://api.linkedin.com/v1/people/~:(id,first-name,last-name,email-address)&format=json&oauth2_access_token="+l.access_token).success(function(e){l=e,f=profile.firstName+" "+profile.lastName,o.picData=profile.picture.replace("sz=50","sz=200"),m()}).error(function(e){d.reject(e)})},y=function(){i.jsonp("https://api.instagram.com/v1/users/self/?callback=JSON_CALLBACK&access_token="+l.access_token).success(function(e){l=e.data,l.profile_picture&&(o.picData=l.profile_picture.substr(0,l.profile_picture.indexOf("?"))),f=l.full_name,p=l.id+"@a2bapp.com",m()}).error(function(e){d.reject(e)})},w=function(){i.get("https://social.yahooapis.com/v1/user/"+l.xoauth_yahoo_guid+"/profile?format=json",{headers:{Authorization:"Bearer "+l.access_token}}).success(function(e){l=e,f=l.profile.nickname,p=l.profile.guid,m()}).error(function(e){d.reject(e)})},b=function(e){switch(u.$broadcast("loading:show",{text:"SIGNING_IN"}),l=e,c){case"facebook":g();break;case"twitter":_();break;case"google":h();break;case"linkedin":v();case"instagram":y();case"yahoo":w()}};return{authenticate:function(t){return d=r.defer(),c=t,e.authenticate(c).then(function(e){b(e)},function(e){})["catch"](function(e){d.reject(e),n.alert({title:"Error",content:e.data?e.data||e.data.message:e})}),d.promise}}}]);