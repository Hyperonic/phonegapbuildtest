angular.module("ion-google-place-single",[]).directive("ionGooglePlaceSingle",["$ionicTemplateLoader","$ionicBackdrop","$ionicPlatform","$q","$timeout","$rootScope","$document","EmployeeService","constants",function(e,o,t,n,i,a,l,c,r){return{require:"?ngModel",restrict:"E",template:'<input type="text" readonly="readonly" class="ion-google-place" autocomplete="off">',replace:!0,scope:{ngModel:"=?",promotions:"="},link:function(n,s,d,p){var u;n.nottyped=!0,n.locations=[];var g=(new google.maps.Geocoder,new google.maps.places.AutocompleteService),m=void 0,f=['<div class="ion-google-place-container">','<div class="bar bar-header item-input-inset search-bar">','<label class="item-input-wrapper">','<i class="icon ion-ios7-search placeholder-icon"></i>','<input class="google-place-search" type="search" ng-model="searchQuery" placeholder="'+(d.placeholder||"Enter an address, place or ZIP code")+'">',"</label>",'<button class="button button-clear">',d.labelCancel||"Cancel","</button>",'<span style="position:absolute;right:65px;" ng-click="clearSearch()" ng-class="(searchQuery.length > 0) ? \'ion-ios-close\' : \'ion-search\'" class="button button-clear ft25"></span>',"</div>",'<ion-content class="has-header has-header">',"<ion-list>",'<ion-item ng-repeat="location in locations" type="item-text-wrap" ng-click="selectLocation(location)">',"{{location.formatted_address}}","</ion-item>","</ion-list>",'<ion-list ng-show="nottyped">','<ion-item ng-class="promotion.heading? \'item-divider\':\'\'" ng-repeat="promotion in promotions" type="item-text-wrap" ng-click="selectLocation(promotion)">',"{{promotion.formatted_address}}","</ion-item>","</ion-list>","</ion-content>","</div>"].join(""),y=e.compile({template:f,scope:n,appendTo:l[0].body});y.then(function(e){var l=angular.element(e.element.find("input"));n.selectLocation=function(t){if(void 0!=t.geometry){var n={};n.lat=t.geometry.location.lat(),n.lon=t.geometry.location.lng(),n.formatted_address=t.formatted_address,p.$setViewValue(n),p.$render(),e.element.css("display","none"),o.release(),u&&(u(),u=null),ionic.Platform.isWebView()&&cordova.plugins.Keyboard.close()}};var f=function(e){for(var o=[],t=0;t<e.length;t++)googlePlacesService=new google.maps.places.PlacesService(l[0]),googlePlacesService.getDetails({reference:e[t].reference},function(e,t){e&&(o.push(e),o.sort(function(e,o){return distA=c.getGPSDistance(e.geometry.location.lat(),e.geometry.location.lng(),a.lat,a.lon),distB=c.getGPSDistance(o.geometry.location.lat(),o.geometry.location.lng(),a.lat,a.lon),distA-distB}),n.$apply(function(){n.locations=o}))})};n.$watch("searchQuery",function(e){m=i(function(){if(!e)return n.locations=[],void(n.nottyped=!0);n.nottyped=!1,e.length<3;var o=n.geocodeOptions||{};o.address=e,o.componentRestrictions={country:a.country};var t={};t.input=e,t.componentRestrictions={country:a.countryCode},t.location=new google.maps.LatLng(a.lat,a.lon),t.radius=1e3*r.milesRadius*1.609,g.getPlacePredictions(t,function(e,o){o==google.maps.places.PlacesServiceStatus.OK&&f(e)})},350)}),n.$on("markerPos",function(e,o){o.type==d.id.split("-")[1]&&(n.searchQuery=o.address,l[0].setSelectionRange(0,0),l[0].focus())});var y=function(n){n.preventDefault(),n.stopPropagation(),o.retain(),u=t.registerBackButtonAction(closeOnBackButton,250),e.element.css({display:"block","pointer-events":"auto"}),l[0].focus(),setTimeout(function(){l[0].setSelectionRange(0,0),l[0].focus()},0)};n.clearSearch=function(){n.searchQuery=""};var h=function(t){o.release(),e.element.css("display","none"),u&&(u(),u=null),ionic.Platform.isWebView()&&cordova.plugins.Keyboard.close()};closeOnBackButton=function(t){t.preventDefault(),e.element.css("display","none"),o.release(),u&&(u(),u=null)},s.bind("click",y),s.bind("touchend",y),e.element.find("button").bind("click",h)}),d.placeholder&&s.attr("placeholder",d.placeholder),p.$formatters.unshift(function(e){return e?e:""}),p.$parsers.unshift(function(e){return e}),p.$render=function(){p.$viewValue?s.val(p.$viewValue.formatted_address||""):s.val("")},n.$on("$destroy",function(){u&&(u(),u=null)})}}}]);